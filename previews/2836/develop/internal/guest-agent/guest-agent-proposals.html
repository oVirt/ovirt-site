<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Guest agent proposals | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Guest agent proposals" />
<meta name="author" content="Ayal Baron" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2836/develop/internal/guest-agent/guest-agent-proposals.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2836/develop/internal/guest-agent/guest-agent-proposals.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Guest agent proposals" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Ayal Baron" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Ayal Baron"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Guest agent proposals","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2836/images/logo.svg"},"name":"Ayal Baron"},"url":"https://ovirt.github.io/ovirt-site/previews/2836/develop/internal/guest-agent/guest-agent-proposals.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2836/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2836/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2836/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2836/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2836/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2836/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2836/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2836/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2836/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2836/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2836/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2836/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2836/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2836/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2836/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2836/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2836/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2836/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2836/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2836/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2836/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2836/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2836//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2836//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2836/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2836/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2836/develop/internal/">
              <span property="name">Internal</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2836/develop/internal/guest-agent/">
              <span property="name">Guest Agent</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ayal Baron</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/01e3f479444582fbfbf832c4a0c591b3?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/01e3f479444582fbfbf832c4a0c591b3?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Mike Roth</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>This developer documentation is <strong>outdated</strong>, but provides historical context.<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2836/documentation/'>Documentation is available here.</a></div>

<!-- TODO: Content review -->

<h1 id="guest-agent-proposals">Guest Agent Proposals</h1>

<p>Summary of discussions from the ovirt workshop, and the qemu-devel and vdsm-devel mailing lists (http://thread.gmane.org/gmane.comp.emulators.ovirt.vdsm.devel/93/focus=93) regarding guest agents for oVirt.</p>

<h2 id="considerations">Considerations</h2>

<p>VDSM/oVirt currently relies on the ovirt-guest-agent (/wiki/Ovirt_guest_agent) as the mechanism for servicing host-initiated commands and data collection within a guest. QEMU relies on qemu-ga (http://wiki.qemu.org/Features/QAPI/GuestAgent) for similar purposes.</p>

<p>Additionally, there are a number of domain-specific agents, such as vdagent for Spice, and Matahari for virtualization-aware systems management.</p>

<p>Currently, ovirt-guest-agent and qemu-ga are the primary candidates under consideration. The purpose of this wiki page is to gather the oVirt requirements for a guest agent, along with the guest agent requirements for related projects, and outline the pros/cons of the existing proposals.</p>

<h2 id="requirements">Requirements</h2>

<h3 id="ovirt">oVirt</h3>

<ol>
  <li>Assistance in VM life-cycle:
    <ol>
      <li>“desktopShutdown” - Shuts the VM down gracefully from within the guest.</li>
      <li>“quiesce” - does not exist today. This is definitely a requirement for us.</li>
    </ol>
  </li>
  <li>SSO support for spice sessions (automatically login into guest OS using provided credentials):
    <ol>
      <li>“desktopLock” - lock current session, used when spice session gets disconnected / before giving a new user access to spice session</li>
      <li>“desktopLogin”</li>
      <li>“desktopLogoff”</li>
      <li>reporting of relevant info (currently active user, session state)</li>
    </ol>
  </li>
  <li>Monitoring and inventory:
    <ol>
      <li>memory usage</li>
      <li>NICs info (name, hw, inet, inet6)</li>
      <li>appslist (list of installed apps / rpms)</li>
      <li>OS type</li>
      <li>guest hostname</li>
      <li>internal file systems info (path, fs type, total space, used space)</li>
      <li>potentially, user-defined statistics via WMI/collectd</li>
    </ol>
  </li>
</ol>

<h3 id="qemu">QEMU</h3>

<ol>
  <li>first-class agent (same repo, available via QMP management interface, distributable via ISO, upgradeable via hypervisor push)</li>
  <li>guest reboot/shutdown, filesystem freeze for live snapshots</li>
  <li>project-agnostic primitives (file open/read/write/exec) to build higher-level interfaces (hypervisor-deployable scripts/binaries/executables, arbitrary data collection, etc)</li>
</ol>

<h3 id="spice">Spice</h3>

<ol>
  <li>User/session-level and system-level guest agent (particularly for copy/paste)</li>
  <li>Paravirtual mouse (needed to get mouse coordinates right with multi monitor setups)</li>
  <li>Send client monitor configuration, so that the guest os can adjust its resolution (and number and place of monitors) to match the client</li>
  <li>Copy and paste in a platform neutral manner, if anyone wishes to add this to another agent contact Spice team (specifically, hdegoede at redhat.com) first. This is easy to get wrong (went through 2 revisions of the protocol for this)</li>
  <li>Allow the client to request the guest to tone down the bling (for low spec clients)</li>
  <li>client &lt;-&gt; guest communication vs. host &lt;-&gt; guest communication (i.e. per-session “channel” and state rather than multiplexing a single QMP-session)</li>
</ol>

<h2 id="proscons">Pros/Cons</h2>

<h3 id="ovirt-guest-agent">ovirt-guest-agent</h3>

<ul>
  <li>pros
    <ul>
      <li>Has been around for a long time (~5 years) - considered stable</li>
      <li>Started as rhevm specific but evolved a lot since then</li>
      <li>Currently the only fully functional guest agent available for ovirt</li>
      <li>Written in python</li>
      <li>Some VDI related sub components are written in C &amp; C++</li>
      <li>Supports a well defined list of message types / protocol [3]</li>
      <li>Supports the folowing guest OSs, Linux: RHEL5, RHEL6 F15, F16(soon), Windows: xp, 2k3 (32/64), w7 (32/64), 2k8 (32/64/R2)</li>
    </ul>
  </li>
  <li>cons
    <ul>
      <li>Not designed to be made consumable by QMP/QEMU directly</li>
      <li>No session-level agent</li>
      <li>Deployment complexity: The more complex the guest agent is, the more often it will need to be updated (bug/security fixes, distro compatibility, new features). Rolling out guest agent updates does not scale well in large environments (especially when the guest and host administrators are not the same person).</li>
    </ul>
  </li>
</ul>

<h3 id="qemu-ga">qemu-ga</h3>

<ul>
  <li>pros
    <ul>
      <li>Qemu specific - it was aimed for specific qemu needs (mainly quiesce guest I/O and reliable guest shutdown)</li>
      <li>project agnostic by design: supports file open/read/write/close, and when exec functionality is added will have the ability to deploy/exec abitrary code as well as upgrade itself</li>
      <li>So far linux only, windows port in the works</li>
      <li>written in C</li>
      <li>Re-uses QMP transport and command schema, will be made transparent to QMP users once replacement QMP server is merged upstream</li>
      <li>Patches for libvirt integration available on list, plans for default installation on Fedora 17 guests</li>
    </ul>
  </li>
  <li>cons
    <ul>
      <li>No plans for native high-level functionality: management tools extend functionality by deploying/executing scripts/binaries in guest, collect state by similar mechanisms, or reading files, etc.</li>
      <li>No session-level agent</li>
    </ul>
  </li>
</ul>

<h2 id="proposals">Proposals</h2>

<h3 id="leverage-ovirt-guest-agent-out-of-band-where-appropriate-use-qemu-ga-via-qmp-where-appropriate">Leverage ovirt-guest-agent out-of-band where appropriate, use qemu-ga via QMP where appropriate</h3>

<ul>
  <li>currently viable, but lots of wasted resources (duplication of efforts, extra packages, etc)</li>
</ul>

<h3 id="drop-qemu-ga-consolidate-around-ovirt-guest-agent">Drop qemu-ga, consolidate around ovirt-guest-agent</h3>

<ul>
  <li>
    <p>blocker: Requires that ovirt-guest-agent be proxied through QMP management interface, subsumes existing qemu-ga commands. Also requires qemu.git submobule to access ovirt-guest-agent command schema to generate marshalling code for proxied commands.</p>

    <p>The need to converge is obvious, and now that ovirt-guest-agent is opensourced 
  under the ovirt stack, and since it already produces value for enterprise 
  installations, and is cross platform, I offer to join hands around ovirt-
  guest-agent and formalize a single code base that will serve us all.</p>

    <p>git @ git://gerrit.ovirt.org/ovirt-guest-agent</p>

    <p>Thoughts ?</p>

    <p>Thanks
  Barak Azulay</p>
  </li>
</ul>

<h3 id="make-ovirt-guest-agent-functionality-available-via-an-executable-or-a-set-of-scripts-and-have-hypervisor-deployexec-the-functionality-via-qemu-ga-file-writeexec-interfaces">Make ovirt-guest-agent functionality available via an executable or a set of scripts, and have hypervisor deploy+exec the functionality via qemu-ga file write/exec interfaces.</h3>

<ul>
  <li>
    <p>blocker: Requires exec support to be added (planned). Requires careful evaluation of security model.</p>

    <p>Today qemu-ga supports the following verbs: sync ping info shutdown
  file-open file-close file-read file-write file-seek file-flush fsfreeze-status
  fsfreeze-freeze fsfreeze-thaw.  If we add a generic execute mechanism, then the
  agent can provide everything needed by oVirt to deploy SSO.</p>

    <p>Let’s assume that we have already agreed on some sort of security policy for the
  write-file and exec primitives.  Consensus is possible on this issue but I
  don’t want to get bogged down with that here.</p>

    <p>With the above primitives, SSO could be deployed automatically to a guest with
  the following sequence of commands:</p>

    <p>file-open “<exec-dir>/sso-package.bin" "w"
  file-write <fh> <buf>
  file-close <fh>
  file-open "<exec-dir>/sso-package.bin" "x"
  file-exec <fh> <args>
  file-close <fh></fh></args></fh></exec-dir></fh></buf></fh></exec-dir></p>

    <p>At this point, the package is installed.  It can contain whatever existing logic
  exists in the ovirt-guest-agent today.  To perform a user login, we’ll assume
  that sso-package.bin contains an executable ‘sso/do-user-sso’:</p>

    <p>file-open “<exec-dir>/sso/do-user-sso" "x"
  exec <fh> <args>
  file-close <fh></fh></args></fh></exec-dir></p>

    <p>At this point the user would be logged in as before.</p>

    <p>Obviously, this type of approach could be made easier by providing a well
  designed exec API that returns command exit codes and (optionally) command
  output.  We could also formalize the install of additional components into some
  sort of plugin interface.  These are all relatively easy problems to solve.</p>

    <p>If we go in this direction, we would have a simple, general-purpose agent with
  low-level primitives that everyone can use.  We would also be able to easily
  extend the agent based on the needs of individual deployments (not the least of
  which is an oVirt environment).  If certain plugins become popular enough, they
  can always be promoted to first-order API calls in future versions of the API.</p>

    <p>– 
  Adam Litke <a href="mailto:alitke@redhat.com">alitke@redhat.com</a></p>
  </li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2836/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2836/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2836/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2836/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/internal/guest-agent/guest-agent-proposals.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/internal/guest-agent/guest-agent-proposals.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
