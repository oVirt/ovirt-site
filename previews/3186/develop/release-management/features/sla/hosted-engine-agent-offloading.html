<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hosted Engine Agent Offloading | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Hosted Engine Agent Offloading" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3186/develop/release-management/features/sla/hosted-engine-agent-offloading.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3186/develop/release-management/features/sla/hosted-engine-agent-offloading.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hosted Engine Agent Offloading" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Hosted Engine Agent Offloading","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3186/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3186/develop/release-management/features/sla/hosted-engine-agent-offloading.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3186/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3186/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3186/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3186/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3186/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3186/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3186/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3186/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3186/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a47850263e36b9e8a35dcedf316a14ad?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a47850263e36b9e8a35dcedf316a14ad?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Denis Chaplygin">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Denis Chaplygin</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3186/documentation/'>Documentation is available here.</a></div>

<h1 id="hosted-engine-move-all-the-hard-work-from-the-agent-to-the-broker">Hosted Engine: Move all the hard work from the agent to the broker</h1>

<h2 id="summary">Summary</h2>

<p>Initially, when hosted engine tools were designed, they were intentionally split between the agent and the broker. It was planned for the agent to be a lightweight application responsible for cluster management decisions while the broker was intended to handle all of the hard work of storage operations, monitoring, locking, etc.
However, during hosted engine development, the agent was burdened with additional load, like OVF extraction, storage preparation, and other activities.</p>

<p>The goal of this feature is to make the agent lightweight again by moving all non-management code to the broker.. This will result in a more maintanable code and more reliable hosted engine behavior..</p>
<h2 id="owner">Owner</h2>

<ul>
  <li>Name: <a href="https://github.com/akashihi">Denis Chaplygin</a></li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Target Release: 4.2</li>
  <li>Status: Done</li>
  <li>Last updated: December 11, 2017</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>The specific goals associated with this feature are as follows:</p>

<ul>
  <li>Move storage mounting/unmounting from the agent to the broker.</li>
  <li>
    <p>The broker should start/stop the domain monitor on the agent’s command. The domain monitor could be implemented as a submonitor.</p>

    <p>Domain monitoring needs to be changed drastically. When the storage validation approach was changed (See <a href="#documentation--external-references">Documentation/External references</a>), active domain monitoring became vital for domain validation. If domain monitoring has not been started, the domain will be reported as invalid, regardless of its actual state.
Therefore, the old approach where domain monitoring was only active outside of local maintenance mode is no longer applicable. I propose the following change: domain monitoring should still be disabled in local maintenance mode. While domain monitoring is disabled, actual domain validation will be skipped and the domain will be reported as valid. The broker will still try to update the status and read statuses of the other cluster participants, even in maintenance mode, so it will have a chance to block on broken storage. Thus, all I/O should be moved to a separate thread, to prevent the broker from blocking on I/O issues.</p>
  </li>
  <li>Move sanlock acquire/release activities from the agent to the broker.</li>
  <li>As the steps above introduce a possible new ‘half-configured’ state, FSM should be extended with that state.</li>
  <li>
    <p>The agent should only post state to the broker, and the broker must publish it on storage, if possible.</p>

    <p>The broker will keep the current status in memory and reply to the agent, hosted-engine-setup, and VDSM using that in-memory state. The agent will call broker’s RPC to update that state. Upon an in-memory state update, a separate disk-writing thread will be notified.. That separate disk-writing thread will be started during the broker start-up sequence and its only purpose is to write the state to the storage and block in case of storage failures, while letting other broker code run. I plan to use deque with a size of one to pass the current state to the disk-writing thread and use Conditions to synchronize threads.</p>
  </li>
  <li><del>OVF extraction should be moved from the agent to the broker.
At the moment, OVF are extracted on every short monitoring loop run by calling <code class="language-plaintext highlighter-rouge">_initialize_storage_images</code>, which calls <code class="language-plaintext highlighter-rouge">refresh_vm_conf</code>, which actually updates <code class="language-plaintext highlighter-rouge">vm.conf</code> from the OVF. I plan to move the refresh_vm_conf function to the submonitor and specify the vm.conf update period as a submonitor parameter, so the agent will be able to control it. The submonitor will update the <code class="language-plaintext highlighter-rouge">vm.conf</code> periodically and report the time elapsed since the last update, which can then be used in score calculations in the future.</del>
OVF extraction alongside with other shared configs extraction and caching will be implemented as additional feature. (See <a href="#documentation--external-references">Documentation/External references</a>)</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<ul>
  <li>Less code - less bugs.</li>
  <li>Clean separation of concerns makes code cleaner and easier to maintain.</li>
  <li>Hosted engine state updates will happen faster and without delays, thus decreasing overall latency of the whole system. See <a href="#documentation--external-references">Documentation/External references</a></li>
</ul>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<ul>
  <li>In order to implement this feature, hosted-engine must be stateless, as desribed at <a href="/ovirt-site/previews/3186/develop/release-management/features/sla/stateless-broker.html">Stateless broker feature</a></li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li>Bugzilla ticket: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1399766">BZ#1399766</a></li>
  <li>Bugzilla ticket: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1337914">BZ#1337914</a></li>
  <li><a href="/ovirt-site/previews/3186/develop/release-management/features/sla/hosted-engine-ovf-extraction.html">Hosted engine shared configuration extraction and caching</a></li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3186/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3186/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3186/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3186/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/hosted-engine-agent-offloading.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/hosted-engine-agent-offloading.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
