<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>CrashCourse | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="CrashCourse" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3184/develop/developer-guide/ui-plugin-tutorial.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3184/develop/developer-guide/ui-plugin-tutorial.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CrashCourse" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"CrashCourse","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3184/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3184/develop/developer-guide/ui-plugin-tutorial.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3184/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3184/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3184/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3184/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3184/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3184/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3184/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3184/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3184/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d91aa78d451f5edbdde13d736518f310?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d91aa78d451f5edbdde13d736518f310?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Vojtech Szocs">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Vojtech Szocs</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="crash-course">Crash Course</h1>

<h2 id="ui-plugins-crash-course-ovirt-space-shooter">UI Plugins Crash Course: oVirt Space Shooter</h2>

<h3 id="introduction">Introduction</h3>

<p>Welcome, space traveler! This tutorial will walk you through the basics of creating your first UI plugin for oVirt web administration application (WebAdmin).</p>

<p>The <em>oVirt Space Shooter</em> plugin we will create is based on <a href="https://github.com/cykod/AlienInvasion">Alien Invasion</a>, sample HTML5 game developed by <a href="https://github.com/cykod">Pascal Rettig</a> and released under both GPL and MIT license. For those who are impatient, you can play the game <a href="http://cykod.github.io/AlienInvasion/">here</a>.</p>

<p>No prior <a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a> programming experience is required, just make sure you have oVirt Engine up and running on your system. Oh, and once we’re done creating our plugin, be prepared to blast some aliens!</p>

<p><em>Note: code presented here aims to demonstrate how to write a simple plugin, it’s not meant to be a showcase of best JavaScript coding practices. When writing a real-world plugin, you should follow good JavaScript coding practices such as scoping your application within a single global variable, using closure for proper information hiding, etc.</em></p>

<p>Plugin source code is available from sample UI plugin repository as <code class="language-plaintext highlighter-rouge">space-shooter-plugin</code> - see the README file for details on installation.</p>

<p>If you have any questions or find any issues, send your feedback to Vojtech Szocs (Vszocs) <a href="mailto:vszocs@redhat.com">vszocs@redhat.com</a></p>

<h3 id="level-1-hello-ui-plugins">Level 1: Hello UI Plugins</h3>

<p>Our journey starts in <code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins</code> directory, home of plugin meta-data and other plugin resources. Let’s go ahead and create descriptor for our plugin inside this directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter.json

{
    "name": "space-shooter",
    "url": "plugin/space-shooter/plugin.html",
    "resourcePath": "space-shooter-resources"
}
</code></pre></div></div>

<p>For those who are curious about the meaning of each attribute:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> is the unique name of our plugin, think of it as plugin ID</li>
  <li><code class="language-plaintext highlighter-rouge">url</code> points to plugin host page which is basically an HTML page that bootstraps plugin code</li>
  <li><code class="language-plaintext highlighter-rouge">resourcePath</code> tells Engine where to find plugin resource files, such as the plugin host page</li>
</ul>

<p>Note that the <code class="language-plaintext highlighter-rouge">url</code> in above snippet is relative and follows <code class="language-plaintext highlighter-rouge">plugin/&lt;pluginName&gt;/&lt;relativePath&gt;</code> pattern. You can use it to fetch plugin resource files that reside under <code class="language-plaintext highlighter-rouge">resourcePath</code> directory. In other words, <strong>you don’t have to run your own custom web server to serve plugin resource files</strong>, Engine does this for you out-of-the-box.</p>

<p>Having the plugin descriptor in place, all that remains is plugin host page. Let’s create <code class="language-plaintext highlighter-rouge">space-shooter-resources</code> sub-directory along with plugin host page inside it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script type='text/javascript'&gt;

    // Get API object for 'space-shooter' plugin
    // Note: using 'parent' due to plugin code being evaluated within an iframe context
    var api = parent.pluginApi('space-shooter');

    // Register event handler functions for later invocation by UI plugin infrastructure
    api.register({
        UiInit: function() {
            alert('Woohoo!');
        }
    });

    // Tell plugin infrastructure that we are good to go, expect UiInit callback
    api.ready();

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>And that’s about it! <strong>It takes only two files to create a minimal UI plugin.</strong></p>

<p>Without even restarting Engine, reload WebAdmin in your browser, log in and embrace the awesome <em>Woohoo!</em> alert window.</p>

<p>As you can see, plugin host page is your typical HTML web page with some JavaScript to interact with plugin API. As you may have guessed, with JavaScript around, the sky is the limit - <strong>design and implement your plugin your way</strong>. Want to use popular JavaScript libraries like <a href="http://angularjs.org/">AngularJS</a> or tools like <a href="http://coffeescript.org/">CoffeeScript</a>? You can. Want to write your plugin using vanilla JavaScript? You can. Plugin API is designed to be simple and not to get in your way, regardless of how you choose to write your plugin.</p>

<p>Note that there’s no HTML markup within the plugin host page and for a good reason - the purpose of this page is to bootstrap actual plugin code. WebAdmin evaluates plugin host page via hidden <code class="language-plaintext highlighter-rouge">iframe</code> element attached to HTML DOM, so <strong>WebAdmin vs. plugin integration happens through plugin API</strong>, discouraging direct HTML DOM manipulation of WebAdmin UI.</p>

<h3 id="level-2-must-blast-some-aliens">Level 2: Must Blast Some Aliens</h3>

<p>Let’s take the <em>Alien Invasion</em> game and integrate it into WebAdmin with our plugin. Sounds a bit more complicated than <em>Woohoo!</em> alert window, but is it really that complicated?</p>

<p>Download the game and put its files under <code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter-resources/game</code> directory. Since the game relies on specific HTML5 features that might not be available in older browsers, download and use <a href="http://modernizr.com/">Modernizr</a> for detecting these features.</p>

<p>Plugin file structure should now look like this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter.json</code> - plugin descriptor</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter-resources/game/*</code> - game files</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter-resources/modernizr.custom.js</code> - Modernizr library</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html</code> - plugin host page</li>
</ul>

<p>Let’s open plugin host page and add some more JavaScript:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;!-- Use Modernizr for detecting necessary HTML5 features like Canvas --&gt;
    &lt;script type='text/javascript' src='modernizr.custom.js'&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script type='text/javascript'&gt;

    var api = parent.pluginApi('space-shooter');

    var openDialog = function() {
        // Show modal dialog with actual game content
        api.showDialog(
                        'Aliens are attacking', // Title
            'space-shooter-dialog', // Dialog token
                        'plugin/space-shooter/game/index.html', // Content URL
                        '340px', // Width
                        '560px' // Height
                );
    };

    var browserRocks = function() {
        // Detect necessary HTML5 features via Modernizr
        return Modernizr.canvas &amp;&amp; Modernizr.canvastext;
    };

    api.register({
        UiInit: function() {
            if (browserRocks()) {
                openDialog();
            }
        }
    });

    api.ready();

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>The code is pretty much straight-forward. <code class="language-plaintext highlighter-rouge">UiInit</code> callback performs HTML5 feature detection and calls <code class="language-plaintext highlighter-rouge">openDialog</code> if successful. <code class="language-plaintext highlighter-rouge">api.showDialog</code> takes care of opening new modal dialog with content loaded from the given URL. Notice that the URL points to game’s <code class="language-plaintext highlighter-rouge">index.html</code> served from <code class="language-plaintext highlighter-rouge">/usr/share/ovirt-engine/ui-plugins/space-shooter-resources/game</code> directory.</p>

<p>Reload WebAdmin in your browser, log in and see what happens! Don’t spend too much time playing the game, though.</p>

<p><img src="/ovirt-site/previews/3184/images/wiki/OVirt_Space_Shooter_1.png" alt="" /></p>

<h3 id="level-3-data-center-under-attack">Level 3: Data Center Under Attack</h3>

<p>Opening new modal dialog on user login is just too easy. What if the aliens from outer space wanted to invade your precious Data Centers? Let’s make this happen and move the battle from generic dialog into Data Center main tab.</p>

<p>Here, we want to do following things:</p>

<ul>
  <li>Allow opening game dialog only if the user selects a specific Data Center</li>
  <li>Since a shooter game might distract admins from doing their work, allow opening game dialog only via secret context-menu item</li>
  <li>Once opened, the dialog cannot be closed unless you win at least once</li>
  <li>Those who cannot beat the game (it can happen!) can use Cheat button<code class="language-plaintext highlighter-rouge">*</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">*</code> Cheating works in video games. In real life, cheaters always lose.</p>

<p>Implementing these improvements seems like a lot of work, let’s see how much code it really takes.</p>

<p>First, we need to register some more event handler callbacks:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DataCenterSelectionChange</code> triggered when item selection changes in Data Center main tab</li>
  <li><code class="language-plaintext highlighter-rouge">MessageReceived</code> triggered when custom content (game) sends us a message<code class="language-plaintext highlighter-rouge">*</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">*</code> To facilitate game → plugin communication, we will use HTML5 <a href="http://en.wikipedia.org/wiki/Web_Messaging">postMessage</a> API.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

api.options({
    // Configure source origin(s), i.e. protocol://domain:port
    // from which HTML5 message events will be accepted
    allowedMessageOrigins: ['http://127.0.0.1:8080']
});

var victory = false; // Has player won at least one game in the current game dialog?
var dataCenter = null; // Data Center entity associated with the current game dialog
var gameContentWindow = null; // Reference to game Window object

api.register({

    // Called by the infrastructure as part of plugin initialization,
    // will be called just once during the lifetime of a plugin
    UiInit: function() {
        if (browserRocks()) {
            init(); // Defined later on
        }
    },

    // Called when item selection changes in Data Center main tab,
    // useful for keeping track of currently selected Data Center entity
    DataCenterSelectionChange: function() {
        if (arguments.length == 1) {
            // Single entity was selected, remember it
            dataCenter = arguments[0];
        } else {
            // Otherwise, forget the entity
            dataCenter = null;
        }
    },

    // Called when another Window (i.e. custom UI contributed by a plugin)
    // sends message to WebAdmin Window via HTML5 postMessage API,
    // ideal for cross-window communication that works across different origins
    MessageReceived: function(data, sourceWindow) {
        // If we get here, we already passed allowed source origin check
        switch (data) {
            // Game content just got loaded
            case 'GameInit':
                gameContentWindow = sourceWindow;
                break;
            // User just won the game
            case 'GameWin':
                victory = true;
                break;
        }
    }

});
</code></pre></div></div>

<p>Since we want the game to notify our plugin upon specific occasions, we use <code class="language-plaintext highlighter-rouge">api.options</code> to configure source origin from which <code class="language-plaintext highlighter-rouge">message</code> events will be accepted. Above snippet uses <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080</code> so we assume Engine runs locally and WebAdmin is available via HTTP at port 8080.</p>

<p>The <code class="language-plaintext highlighter-rouge">DataCenterSelectionChange</code> callback receives currently selected items as function <code class="language-plaintext highlighter-rouge">arguments</code>. Since we only care for single Data Center selected in the main tab, we check <code class="language-plaintext highlighter-rouge">arguments.length</code> and remember or forget current selection.</p>

<p>The <code class="language-plaintext highlighter-rouge">MessageReceived</code> callback is used to process two kinds of messages sent by the game <code class="language-plaintext highlighter-rouge">Window</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GameInit</code> fired right after game’s HTML document gets loaded, right before the game initializes its <a href="http://en.wikipedia.org/wiki/Canvas_element">Canvas</a></li>
  <li><code class="language-plaintext highlighter-rouge">GameWin</code> fired right after user wins the game, i.e. beats all levels</li>
</ul>

<p>We use <code class="language-plaintext highlighter-rouge">GameInit</code> to keep the reference to game <code class="language-plaintext highlighter-rouge">Window</code> object in order to call functions on this object later on. In other words, we establish <strong>two-way communication between game and plugin</strong>, with game being the initiator of this communication.</p>

<p>Let’s modify <code class="language-plaintext highlighter-rouge">game.js</code> under <code class="language-plaintext highlighter-rouge">game</code> directory to add the missing bits:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/game/game.js

...
var winGame = function() {
    Game.setBoard(3, new TitleScreen('You win!',  'Press fire to play again', playGame));
    parent.postMessage('GameWin', '*'); // Change here
};
...
window.addEventListener('load', function() {
    parent.postMessage('GameInit', '*'); // Change here
    Game.initialize('game', sprites, startGame);
});
...
</code></pre></div></div>

<p>Since the game is rendered via <code class="language-plaintext highlighter-rouge">iframe</code> element attached to HTML DOM, <code class="language-plaintext highlighter-rouge">parent</code> refers to WebAdmin <code class="language-plaintext highlighter-rouge">Window</code> object.</p>

<p>Remember the missing <code class="language-plaintext highlighter-rouge">init</code> function used inside our <code class="language-plaintext highlighter-rouge">UiInit</code> callback? Let’s add this function and complete our plugin:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

var dialogToken = 'space-shooter-dialog';
var dialogUrl = 'plugin/space-shooter/game/index.html';

var init = function() {
    // Add new action button to Data Center main tab
    api.addMainTabActionButton(
        'DataCenter', // To which main tab the button should be added to
        'Protect DataCenter from Alien Invasion', // Label
        // Extra options for addMainTabActionButton function
        {
            isEnabled: function() {
                // Enable button only when selecting single Data Center
                return arguments.length == 1;
            },
            onClick: function() {
                // Reset victory flag and open new game dialog
                victory = false;
                openDialog();
            },
            location: 'OnlyFromContext' // Button available only from context menu
        });
};

var openDialog = function() {
    // Show modal dialog with actual game content
    api.showDialog(dataCenter.name + ' under attack', dialogToken, dialogUrl, '340px', '560px',
        // Extra options for showDialog function
        {
            closeIconVisible: false, // Hide dialog's close icon
            closeOnEscKey: false, // Prevent user from closing dialog with Escape key
            resizeEnabled: true, // Allow dialog resizing
            buttons:
            [
                // Button for those who cannot beat the game (it can happen!)
                {
                    label: 'Cheat',
                    onClick: cheatGame
                },
                // Button to close the dialog
                {
                    label: 'Get me outta here',
                    onClick: closeDialog
                }
            ]
        });
};

var closeDialog = function() {
    if (victory) {
        api.closeDialog(dialogToken);
    } else {
        alert('Not so fast! Destroy the aliens at least once.');
    }
};

var cheatGame = function() {
    if (gameContentWindow != null) {
        // Invoke function on game Window object
        gameContentWindow.winGame();
    }
};
</code></pre></div></div>

<p>Instead of showing new modal dialog with game content right away, the <code class="language-plaintext highlighter-rouge">init</code> function adds new <em>action button</em> to Data Center main tab via <code class="language-plaintext highlighter-rouge">api.addMainTabActionButton</code>. Think of action button as a button located in corresponding main tab’s upper panel. For example, <em>New</em>, <em>Edit</em> and <em>Remove</em> are all action buttons living inside Data Center main tab. Each action button usually gets reflected into context menu for given main tab, but there can be exceptions.</p>

<p><img src="/ovirt-site/previews/3184/images/wiki/OVirt_Space_Shooter_2.png" alt="" /></p>

<p>In our case, we want the <em>Protect DataCenter from Alien Invasion</em> button to be visible only via context-menu item, so we customize <code class="language-plaintext highlighter-rouge">location</code> within <code class="language-plaintext highlighter-rouge">addMainTabActionButton</code> options. Each time item selection changes in Data Center main tab, <code class="language-plaintext highlighter-rouge">isEnabled</code> callback will be fired to determine whether the button should be enabled or disabled. In case the button is enabled, <code class="language-plaintext highlighter-rouge">onClick</code> callback will be fired when a user clicks the button. Note that both callbacks receive currently selected items (entities) as function <code class="language-plaintext highlighter-rouge">arguments</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">openDialog</code> function is pretty much straight-forward, we just pass some extra options to customize the dialog and add some buttons to it. On the other hand, <code class="language-plaintext highlighter-rouge">cheatGame</code> shows an interesting pattern - utilizing two-way communication between game and plugin by invoking function (i.e. <code class="language-plaintext highlighter-rouge">winGame</code>) on game’s <code class="language-plaintext highlighter-rouge">Window</code> object.</p>

<p><img src="/ovirt-site/previews/3184/images/wiki/OVirt_Space_Shooter_3.png" alt="" /></p>

<h3 id="secret-level-making-things-configurable">Secret Level: Making Things Configurable</h3>

<p>Blasting through waves of aliens is nice, but what if someone accessed WebAdmin from a remote machine? Assuming WebAdmin would be exposed at <code class="language-plaintext highlighter-rouge">https://engine-domain:8765</code>, someone would need to modify <code class="language-plaintext highlighter-rouge">allowedMessageOrigins</code> inside plugin host page to ensure that communication between game and plugin works properly. Of course, we could still use <code class="language-plaintext highlighter-rouge">*</code> as the value for <code class="language-plaintext highlighter-rouge">allowedMessageOrigins</code> to accept <code class="language-plaintext highlighter-rouge">message</code> events from any origin, however doing this would open back door for malicious JavaScript to exploit our plugin.</p>

<p>To make things a bit more configurable, let’s add new configuration option right into plugin descriptor:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter.json

"config": {
    "allowedOrigins": ["http://127.0.0.1:8080"]
}
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">config</code> attribute is completely optional and can be used to contain default (plugin-specific) configuration. <strong>Users shouldn’t modify plugin descriptor directly</strong> - if you need to override default configuration, create plugin user configuration inside <code class="language-plaintext highlighter-rouge">/etc/ovirt-engine/ui-plugins</code> directory, using <code class="language-plaintext highlighter-rouge">-config</code> suffix:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /etc/ovirt-engine/ui-plugins/space-shooter-config.json

"config": {
    "allowedOrigins": ["http://127.0.0.1:8080", "https://engine-domain:8765"]
}
</code></pre></div></div>

<p>Each time our plugin gets loaded in WebAdmin, UI plugin infrastructure takes care of merging user configuration (if any) on top of default configuration (if any). In our case, <code class="language-plaintext highlighter-rouge">allowedOrigins</code> from user configuration would override <code class="language-plaintext highlighter-rouge">allowedOrigins</code> from default configuration.</p>

<p>Accessing plugin configuration at runtime is as easy as calling <code class="language-plaintext highlighter-rouge">api.configObject</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

// Get runtime plugin configuration, i.e. custom configuration (if any)
// merged on top of default configuration (if any)
var config = api.configObject();

api.options({
    // Note: "config.allowedOrigins" is JSON array
    allowedMessageOrigins: config.allowedOrigins
});
</code></pre></div></div>

<h3 id="level-4-insert-coin-and-keep-the-score">Level 4: Insert Coin And Keep The Score</h3>

<p>Let’s add one more feature to our plugin: the ability to track score (games won) per each Data Center via custom sub tab under Data Center main tab. Heroic deeds of admins blasting through waves of aliens shouldn’t be forgotten, right?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/start.html

var subTabWindow = null; // Reference to 'Score' sub tab Window object

var subTabToken = 'space-shooter-dc-score';
var subTabUrl = 'plugin/space-shooter/dc-score.html';

var init = function() {
    // Add new action button to Data Center main tab
    api.addMainTabActionButton( ... );

    // Add new 'Score' sub tab under Data Center main tab
    api.addSubTab(
        'DataCenter', // To which main tab the sub tab should be added to
        'Space Shooter Score', // Label
        subTabToken, // Sub tab token
        subTabUrl // Content URL
    );
};

var getKey = function() {
    // Calculate unique key (string) for storing and retrieving game score for
    // given user + Data Center combination, i.e. admin@internal_dc123_DCScore
    return dataCenter != null ? api.loginUserName() + '_' + dataCenter.id + '_DCScore' : null;
};

var getScore = function() {
    // Return current score as string, or 0 if there is no score yet
    return localStorage.getItem(getKey()) || '0';
};

var incScore = function() {
    // Increment current score by 1, store the result as string
    localStorage.setItem(getKey(), (parseInt(getScore(), 10) + 1) + '');
};

var updateSubTab = function() {
    if (subTabWindow == null || dataCenter == null) {
        return;
    }

    // Get the current user score
    var score = getScore();
    var intScore = parseInt(score, 10);

    // Calculate rank based on user score
    var rank, rankColor;
    switch (true) {
        case (intScore &gt;= 10):
            rank = 'Laser Master';
            rankColor = 'green';
            break;
        case (intScore &gt;= 3):
            rank = 'Veteran';
            rankColor = 'orange';
            break;
        case (intScore &gt;= 1):
            rank = 'Survivor';
            rankColor = 'red';
            break;
        default:
            rank = 'Newbie';
            rankColor = 'gray';
            break;
    }

    // Update 'Score' sub tab
    subTabWindow.update(dataCenter.name, score, rank, rankColor);
};

api.register({
    ...
    MessageReceived: function(data, sourceWindow) {
        switch (data) {
            // Game content just got loaded
            case 'GameInit':
                gameContentWindow = sourceWindow;
                break;
            // User just won the game
            case 'GameWin':
                victory = true;
                incScore();
                updateSubTab();
                break;
            // 'Score' sub tab asks for current user score
            case 'GetDataCenterScore':
                subTabWindow = sourceWindow;
                updateSubTab();
                break;
        }
    }
    ...
});
</code></pre></div></div>

<p>Just like with game content, we use the same technique to establish two-way communication between custom sub tab and plugin.</p>

<p>To keep things simple, <code class="language-plaintext highlighter-rouge">getScore</code> and <code class="language-plaintext highlighter-rouge">incScore</code> functions utilize HTML5 <a href="http://en.wikipedia.org/wiki/Web_storage#Local_and_session_storage">Local Storage</a> to fetch and persist score locally in browser.</p>

<p>Finally, we need to add <code class="language-plaintext highlighter-rouge">dc-score.html</code> representing custom sub tab content:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/share/ovirt-engine/ui-plugins/space-shooter-resources/dc-score.html

&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;p&gt;
Score for Data Center &lt;span id='dataCenterName'&gt;?&lt;/span&gt;:
&lt;span id='score'&gt;?&lt;/span&gt; (&lt;span id='rank'&gt;?&lt;/span&gt;)
&lt;/p&gt;

&lt;script type='text/javascript'&gt;

    // Ask the plugin for current user score
    parent.postMessage('GetDataCenterScore', '*');

    // The plugin should call this function in response to GetDataCenterScore message
    var update = function(dataCenterName, score, rank, rankColor) {
        document.getElementById('dataCenterName').innerHTML = '&lt;em&gt;' + dataCenterName + '&lt;/em&gt;';
        document.getElementById('score').innerHTML = '&lt;b&gt;' + score + '&lt;/b&gt;';
        document.getElementById('rank').innerHTML = '&lt;b&gt;' + rank + '&lt;/b&gt;';
        document.getElementById('rank').style.color = rankColor;
    };

&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>And we’re done! Take a break from coding and play the game to see new score and ranking feature in action.</p>

<p><img src="/ovirt-site/previews/3184/images/wiki/OVirt_Space_Shooter_4.png" alt="" /></p>

<h3 id="mission-accomplished">Mission Accomplished</h3>

<p>Congratulations! You’ve made it past all the levels, you should have a pretty good understanding of UI plugins now.</p>





        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3184/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3184/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3184/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3184/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/ui-plugin-tutorial.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/ui-plugin-tutorial.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
