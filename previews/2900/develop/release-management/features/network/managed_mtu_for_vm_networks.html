<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Managed MTU for VM Networks | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Managed MTU for VM Networks" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2900/develop/release-management/features/network/managed_mtu_for_vm_networks.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2900/develop/release-management/features/network/managed_mtu_for_vm_networks.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Managed MTU for VM Networks" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Managed MTU for VM Networks","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2900/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2900/develop/release-management/features/network/managed_mtu_for_vm_networks.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2900/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2900/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2900/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2900/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2900/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2900/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2900/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2900/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2900/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2900/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2900/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2900/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2900/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2900/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2900/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2900/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2900/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2900/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2900/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2900/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2900/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2900/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2900//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2900//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2900/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2900/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2900/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2900/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2900/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dominik Holler</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2900/documentation/'>Documentation is available here.</a></div>

<h1 id="managed-mtu-for-vm-networks">Managed MTU for VM Networks</h1>

<h2 id="summary">Summary</h2>

<p>VM networks, especially external logical [OVN networks][1], transport the
Ethernet frames through a physical host network. The MTU of the VM network has
to be configured small enough to respect the MTU of the physical network.
The feature introduced here adds the ability to manage the MTU in a centralized
way to assist the configuration of the MTU of each VM network.</p>

<p>Feature progress is tracked on [Trello][14]. Related patches can be found on
[gerrit topic:managed_mtu][15].</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>
    <p>Name: <a href="https://github.com/almusil">Aleš Musil</a></p>
  </li>
  <li>
    <p>Email: <a href="mailto:amusil@redhat.com">amusil@redhat.com</a></p>
  </li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>The logical network traffic of the VMs has to be transported by physical
networks between the hosts. The Ethernet frames of the logical network are
transported either</p>
<ul>
  <li>as plain Ethernet frames,</li>
  <li>encapsulated in a VLAN or</li>
  <li>encapsulated in [GENEVE][3] tunnels.</li>
</ul>

<h3 id="plain-ethernet-frames">Plain Ethernet Frames</h3>
<p>If the Ethernet frames of the logical network are transported as a plain Ethernet
frames of the physical network, the MTU of the logical network must not be
grater than the MTU of the physical network.</p>

<h3 id="vlan">VLAN</h3>
<p>The same rule applies, if the Ethernet frames of the logical network is
transported encapsulated in a VLAN, because the added VLAN header belongs to
the Ethernet header.</p>

<h3 id="tunnels">Tunnels</h3>
<p>If the Ethernet frames of the logical network are encapsulated in GENEVE
tunnels, the calculation of the MTU of the logical network is not that simple
anymore. While the VLAN is on data link layer, the GENEVE tunnels are using the
transport layer. This means that the hosts might not be in the same broadcast
domain. Although [GENEVE][6] and [OVN][7] supports IP fragmentation, this is
not used in oVirt’s default configuration to avoid tunnels with hard to detect
performance issues.
Hence, a Path MTU (PMTU) Discovery in the mesh of all possible hosts, which
could serve VMs with access to the logical network, would be required to
determine the maximum size of the encapsulating packet.
There is a common maximal MTU for all OVN networks used in a cluster, because
all OVN networks are transported over the same tunnels.
This implies the requirement to manage MTU in a centralized way.</p>

<p>Subtracting the encapsulation overhead from the maximum size of the
encapsulating packet results in the MTU of the logical network.</p>

<p>OpenStack puts the [burden to the networking plugin][4] to calculate
the [largest possible MTU size that can safely be applied][5] to VMs,
but in oVirt there will be no automatic calculation of the MTU.</p>

<h3 id="mtu-individually-per-network">MTU individually per Network</h3>
<p>MTU has to be managed individually for each network, because:</p>
<ul>
  <li>The MTU of the logical network are transported either as plain Ethernet
frames or encapsulated in a VLAN is individual for each network.</li>
  <li>The MTU for the external logical networks depends on the MTU of the underlying
network and for localnets on the MTU of the connected logical network, too.
There might be no common underlying network for the tunnels and this way it
the common MTU is not obvious.
An individual MTU per network requires that oVirt engine supports the MTU
property of external networks:</li>
  <li>On Importing a network created outside engine on a provider.</li>
  <li>During automatic synchronization of external networks.
This requires enhancements in ovirt-engine, [OpenStack Java SDK][11] and
ovirt-provider-ovn.</li>
</ul>

<h3 id="propagating-the-mtu-into-the-vms">Propagating the MTU into the VMs</h3>

<h4 id="set-the-mtu-by-dhcp">Set the MTU by DHCP</h4>
<p>The MTU can be propagated via DHCP into the VMs. Since oVirt implements L3
functionality only for external logical networks, this approach works only for
external logical networks with a subnet defined and the VM configuring the
network interface via DHCP.</p>

<p>The only DHCP server managed by oVirt is the OVN internal DHCP server, which
is utilized to implement OpenStack API’s subnets. Currently the DHCP server is
able to propagate a common MTU for all networks, configured in the
configuration file of ovirt-provider-ovn.
If we would [support the property MTU][8] of external networks, we could
propagate the MTU from ovirt-engine via the ovirt-provider-ovn into OVN’s DHCP
server. This would require enhancements in ovirt-engine, [OpenStack Java
SDK][11] and ovirt-provider-ovn.
An alternative approach is to disable setting the MTU via DHCP in default
configuration.</p>

<p>DHCP can only be used to reduce the MTU inside the guest to values smaller than
1500 bytes, because DHCP does not configure the tap devices of the VM.</p>

<h4 id="set-the-mtu-by-libvirt">Set the MTU by libvirt</h4>
<p>Since Red Hat Enterprise Linux 7.4 it is possible to set the MTU in libvirt’s
XML, which will be propagated to libvirt’s tap devices, qemu and virtio drivers
inside the guest VM.</p>

<p>The MTU is respected by QEMU for rhel7.4.0 machine type and later.
It is ignored by QEMU with rhel7.3.0 machine type and earlier because the MTU
feature wasn’t supported, so migration from a RHEL 7.4 host to a RHEL 7.3 host
would fail.</p>

<p>Beside the possibility to specify the machine type individually for each VM,
a default machine type for clusters of a certain level is configured.
In cluster level 4.3 machine type rhel7.4.0 or later will be configured by
default.
Users can opt-in for this feature by configuring a default machine type of
rhel7.4.0 for for new clusters of cluster level 4.2 or clusters which will be
upgraded to cluster level 4.2:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-config --set "ClusterEmulatedMachines=pc-i440fx-rhel7.4.0,pc-i440fx-2.9,pseries-rhel7.5.0,s390-ccw-virtio-2.6" --cver=4.2
</code></pre></div></div>
<p>They can also opt-in per VM, by selecting rhel7.4.0 machine type of an
individual VM or template.</p>

<p>If an oVirt VM with rhel7.4.0 machine type is connected to ovirtmgmt with a MTU of
1234 and an OVN network with a MTU of 1100 is running, the configuration on the
host looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@host23 ~]# ip l
35: br-int: &lt;BROADCAST,MULTICAST&gt; mtu 1100 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether d6:fe:bc:ce:72:4c brd ff:ff:ff:ff:ff:ff
36: genev_sys_6081: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 65000 qdisc noqueue master ovs-system state UNKNOWN mode DEFAULT qlen 1000
    link/ether 5e:fa:6f:20:b3:52 brd ff:ff:ff:ff:ff:ff
37: ovirtmgmt: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1234 qdisc noqueue state UP mode DEFAULT qlen 1000
    link/ether 52:54:00:4d:a1:11 brd ff:ff:ff:ff:ff:ff
54: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1234 qdisc pfifo_fast master ovirtmgmt state UNKNOWN mode DEFAULT qlen 1000
    link/ether fe:1a:4a:16:01:02 brd ff:ff:ff:ff:ff:ff
55: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1100 qdisc pfifo_fast master ovs-system state UNKNOWN mode DEFAULT qlen 1000
    link/ether fe:1a:4a:16:01:04 brd ff:ff:ff:ff:ff:ff
[root@host23 ~]# ovs-vsctl show
6861a627-a6c9-41dd-ab88-b0e0f74525b1
    Bridge br-int
        fail_mode: secure
        Port "vnet1"
            Interface "vnet1"
        Port br-int
            Interface br-int
                type: internal
        Port "ovn-a8086d-0"
            Interface "ovn-a8086d-0"
                type: geneve
                options: {csum="true", key=flow, remote_ip="192.168.122.53"}
    ovs_version: "2.9.0"
[root@host23 ~]# ovs-vsctl get Interface br-int mtu
1100
</code></pre></div></div>

<h2 id="prerequisites">Prerequisites</h2>
<p>Setting the MTU via libvirt will work only on hosts with RHEL 7.4 or later.
For hosts with RHEL 7.4 or later libvirt’s XML is produced by engine, which will
contain the definition. On hosts running older software, vdsm will create
libvirt’s XML without the MTU definition.
Setting the MTU via libvirt works only on VMs with machine type rhel7.4.0 or
later, so setting the MTU via libvirt will work transparent to the user if the
default machine type in oVirt is rhel7.4.0 or later.</p>

<p>Setting the MTU by DHCP individally per network will require an updated
version of [OpenStack Java SDK][11] used by oVirt-engine.</p>

<h2 id="limitations">Limitations</h2>

<ul>
  <li>
    <p>MTU is applied during the start of the VM or when hot plugging the network
interface, but not during an update of the network.</p>
  </li>
  <li>
    <p>Setting the MTU by DHCP requires that the relevant interface is configured
via DHCP by the guest.</p>
  </li>
  <li>
    <p>Setting the MTU via libvirt requires that the machine type of the VM is
rhel7.4.0 or later, which requires that the hosts are running RHEL 7.4 or
later.</p>
  </li>
  <li>
    <p>Setting the MTU via libvirt requires that vNIC interface is of model type
‘virtio’ and the VirtIO driver of the guest supports MTU negation.
This is given for RHEL 7.4 or later and VirtIO-Win version 1.9.1-0 (netkvm
build 139) or later, which is already given for the already released
oVirt-toolsSetup 4.2-1.</p>
  </li>
  <li>
    <p>MTU cannot applied to pass-through vNICs.</p>
  </li>
  <li>
    <p>Currently the attributes link state, device type of the vNIC, port mirroring,
custom properties, QoS, and the network of the vNIC profile cannot be updated
for plugged vNICs. As a workaround, unplug the vNIC, change the attribute,
and replug the vNIC.</p>
  </li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>If oVirt assist to configure the MTU inside the guest VM helps to get the VM
working as intended by the user.</p>

<p>If the MTU inside the guest VM is set too large, too large Ethernet frames sent
by the VM are dropped without any hint to the user.
If the MTU inside the guest VM is set too small, the performance of the vNIC
might be below the users expectation.</p>

<h2 id="entity-description">Entity Description</h2>

<p>The MTU property has to be enabled for creating external networks in webadmin,
the related AddNetworkOnProviderCommand, and during import and synchronization.
Similar to network name, the MTU of an external network cannot be updated by
webadmin, but will be updated during synchronization</p>

<h3 id="default-value-for-mtu">Default Value for MTU</h3>
<p>If no MTU is defined for a network, <a href="#set-the-mtu-by-dhcp">DHCP</a> falls back on
a default value configured in [oVirt OVN Provider][1].</p>

<p>Inside oVirt Engine every logical network has a MTU. If the user does not
specify a MTU explicitly, the MTU has the value <code class="language-plaintext highlighter-rouge">default</code>.
During <a href="#set-the-mtu-by-libvirt">defining the vNIC by libvirt</a> the value
<code class="language-plaintext highlighter-rouge">default</code> is mapped to the default MTU for host networks, usually 1500 bytes,
or a new configuration value to configure the MTU of external networks, usually
1442 bytes.
If the value of MTU is <code class="language-plaintext highlighter-rouge">default</code>, the MTU is not send to the external provider,
because [OpenStack’s mtu property][16] is optional and may confuse the provider.</p>

<h2 id="user-experience">User Experience</h2>

<p>The already available MTU property of logical network is enabled for external
networks.
The value shown as default MTU value in UI is imprecise due to tunneling
overhead, but we did not find an easily understandable way to present the
default MTU value for tunneled networks in the UI.</p>

<h2 id="installationupgrade">Installation/Upgrade</h2>

<p>Setting the MTU via libvirt will work only on hosts with RHEL 7.4 or later.
For hosts with RHEL 7.4 or later libvirt’s XML is produced by engine, which will
contain the definition. On hosts running older software, vdsm will create
libvirt’s XML without the MTU definition.</p>

<p>The MTU offered by OVN’s internal DHCP server might be changed from a common
value for all networks to an individual value or might be disabled. The [current
documentation][13] already mention that offering the MTU might be disabled in
future version.</p>

<h3 id="example-flows-to-propagate-the-mtu-to-a-vm">Example Flows to propagate the MTU to a VM</h3>

<p>The first three flows present how to use jumbo frames for VMs, while the
<a href="#autosync-flow">AutoSync flow</a> is relevant for MTUs reduced by tunneling, too.</p>

<h4 id="linux-bridge-flow">Linux-bridge Flow</h4>

<p>This is an example flow to use Jumbo Frames in a cluster with linux-bridge
switch type, while the Ethernet frames of the logical network are transported
encapsulated in a VLAN or as plain Ethernet frames:</p>
<ol>
  <li>Create a new logical VM network with the optional VLAN and the desired MTU,
e.g. 8000 bytes.</li>
  <li>Assign this network, to a host NIC. Ensure that the switch port connected
to this NIC is configured to accept big frames and the VLAN, e.g. by using
[LLDP][17].</li>
  <li>Use the vNIC profile of this new logical network in a vNIC of the desired VM.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM,</a>, else the MTU has to be configured manually inside the guest.</li>
</ol>

<h4 id="ovn-physical-network-flow">OVN Physical Network Flow</h4>

<p>This is an example flow to use Jumbo Frames in a cluster with OVS
switch type, while the Ethernet frames of the logical network are transported
encapsulated in a VLAN or as plain Ethernet frames:</p>
<ol>
  <li>Create a new logical network with the optional VLAN and the desired MTU,
e.g. 8000 bytes.</li>
  <li>Assign this network, to a host NIC. Ensure that the switch port connected
to this NIC is configured to accept big frames and the VLAN, e.g. by using
[LLDP][17].</li>
  <li>Create a new logical VM network with the desired MTU, e.g. 8000 bytes.
This new logical network has to be created on the external provider and
reference the first network as its physical network according the
screenshot. If the DHCP server of the physical network should be used, no
subnet should be defined.
<img src="/ovirt-site/previews/2900/images/features/network/managed-mtu-for-vm-networks_new-network-dialog.png" alt="Create new logical VM network" /></li>
  <li>Use the vNIC profile of this new logical network in a vNIC of the desired VM.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM.</a>, else the MTU has to be configured manually inside the guest.</li>
</ol>

<h4 id="tunneled-ovn-flow">Tunneled OVN Flow</h4>

<p>This is an example flow which results in the Ethernet frames of the logical
network are encapsulated in tunnels by OVN.</p>
<ol>
  <li>Create a new logical host network with a MTU which is by at least the size of
the tunneling overhead greater than the desired MTU, e.g. 8058 bytes. In the
default configuration of ovirt-provider-ovn the tunneling overhead is 58 bytes.</li>
  <li>Assign this network, to a host NIC of every host in the cluster. Ensure that
the switch port connected to this NICs is configured to accept big frames, 
e.g. by using [LLDP][17].</li>
  <li>Configure OVN to use this new network to create the tunnels:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook -i /usr/share/ovirt-engine-metrics/bin/ovirt-engine-hosts-ansible-inventory --extra-vars " cluster_name=&lt;cluster name&gt; ovn_central=&lt;ovn central ip&gt; ovn_tunneling_interface=&lt;vdsm network name of the new logical host network&gt;" /usr/share/ovirt-engine/playbooks/ovirt-provider-ovn-driver.yml
</code></pre></div>    </div>
  </li>
  <li>Create a new logical VM network with the desired MTU, e.g. 8000 bytes.
This new logical network has to be created on the external provider and
must not reference any physical network according. It is useful to define a
subnet for this network to enable the internal DHCP server.</li>
  <li>Use the vNIC profile of this new logical network in a vNIC of the desired VM.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM,</a>. If a subnet is defined for the network, the <a href="#set-the-mtu-by-dhcp">MTU is offered via DHCP to the VM</a>.</li>
</ol>

<h4 id="autosync-flow">AutoSync Flow</h4>

<p>This a flow where the MTU is set by the external provider.</p>
<ol>
  <li>Create a new external logical network with <a href="#default-value-for-mtu">default MTU</a>
on a provider.</li>
  <li>If the provider supports the [MTU extension][16], it will expose the MTU
that is guaranteed to pass through the data path of the segments in the
network.
During the [automatic synchronization][18] the MTU in the provider’s network
representation is applied to the external network on oVirt Engine.</li>
  <li>Use the vNIC profile of this logical network in a vNIC of the desired VM.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM,</a>.</li>
</ol>

<h4 id="autodefine-flow">AutoDefine Flow</h4>

<p>This is an example flow about the MTU is deduced from a host network.</p>
<ol>
  <li>In webadmin, create a new logical network in a data center with a cluster
with OVS switch type and a default network provider. You may specify a
non-default MTU during creating the network.</li>
  <li>A new external network is [created automatically][19] with the original
network as its physical network. This external network is created with the
same MTU as its physical network. If the physical network was created
with default MTU, e.g. 1500, the MTU of the external network will be 1500,
too. Please note that this is not the default value for tunneled networks,
which is usually 1442 for GENEVE tunneled networks or 1450 for VXLAN tunneled
networks.</li>
  <li>Use the vNIC profile of this new external network in a vNIC of the desired VM.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM,</a>.</li>
</ol>

<h4 id="update-mtu-flow">Update MTU Flow</h4>

<p>The MTU is applied during the start of the VM or hot plugging the network
interface, but not during an update of the network.
Therefore, the vNICs of running VMs have to be hot unplugged and hot re-plugged to apply the MTU update.</p>
<ol>
  <li>In webadmin, modify the MTU of an already available network.</li>
  <li>Unplug and plug every vNIC which should apply the updated MTU.</li>
  <li><a href="#set-the-mtu-by-libvirt">If requirements are fulfilled, libvirt tries to propagate the MTU into the VM,</a>.</li>
</ol>

<h2 id="documentation--external-references">Documentation &amp; External references</h2>

<p><a href="/ovirt-site/previews/2900/develop/release-management/features/network/ovirt-ovn-provider.html">oVirt OVN Provider</a></p>

<p><a href="/ovirt-site/previews/2900/develop/release-management/features/network/provider-physical-network.html">Provider Physical Network</a></p>

<p><a href="https://www.redhat.com/en/blog/what-geneve">What is GENEVE?</a></p>

<p><a href="https://specs.openstack.org/openstack/neutron-specs/specs/kilo/mtu-selection-and-advertisement.html">openstack</a></p>

<p><a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/12/html/networking_guide/sec-mtu">openstack doc</a></p>

<p><a href="https://tools.ietf.org/html/draft-gross-geneve-00#section-4.1.1">GENEVE</a></p>

<p><a href="http://www.openvswitch.org//support/dist-docs/ovs-vswitchd.conf.db.5.html">option <code class="language-plaintext highlighter-rouge">df_default</code>  ovs-vswitchd.conf.db(5)</a></p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1538465">Bug 1538465 - Support MTU property with OVN networks</a></p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1451342">Bug 1451342 - configure guest MTU based on underlying network</a></p>

<p><a href="https://developer.openstack.org/api-ref/network/v2/?expanded=create-network-detail#show-network-details">Network Details in OpenStack API</a></p>

<p><a href="https://github.com/woorea/openstack-java-sdk">OpenStack Java SDK</a></p>

<p><a href="https://libvirt.org/formatnetwork.html#elementsConnect">MTU support in libvirt</a></p>

<p><a href="https://github.com/oVirt/ovirt-provider-ovn/#section-dhcp">Configuration of OVN’s internal DHCP server by ovirt-provider-ovn</a></p>

<p><a href="https://trello.com/c/wTtoBph7/131-add-mtu-to-interface-elements-in-vdsm-proper-and-in-ovn-driver">Trello</a></p>

<p><a href="https://gerrit.ovirt.org/#/q/topic:managed_mtu">Related patches</a></p>

<p><a href="https://developer.openstack.org/api-ref/network/v2/index.html#mtu-extensions">MTU extensions in OpenStack Networking API v2.0</a></p>

<p><a href="/ovirt-site/previews/2900/develop/release-management/features/network/lldp.html">LLDP</a></p>

<p><a href="http://ovirt.github.io/ovirt-engine-api-model/4.2/#types/open_stack_network_provider/attributes/auto_sync">AutoSync</a></p>

<p><a href="/ovirt-site/previews/2900/develop/release-management/features/network/autodefine-external-network.html">Autodefine External Network</a></p>

<h2 id="testing">Testing</h2>
<p>All test have to be checked using a VM with machine type rhel7.4.0 or later and
with virtio vNIC for VLAN network and an OVN network.</p>

<ul>
  <li>
    <p>Define MTU &lt; 1500 on logical network and check if it propagated to the guest.</p>
  </li>
  <li>
    <p>Define MTU &gt; 1500 on logical network and check if it propagated to the guest.</p>
  </li>
  <li>
    <p>Define MTU &gt; 1500 on logical network and the involved physical switch ports
and check if it works by pinging the guest via <code class="language-plaintext highlighter-rouge">ping -M do -s</code>.</p>
  </li>
</ul>

<h2 id="contingency-plan">Contingency Plan</h2>

<p>Without this feature, the configuration process of configuring a MTU bigger than
1442 bytes for OVN networks is complex and undocumented, so that most users are
expect to use OVN networks with degraded throughput.</p>

<h2 id="follow-up-features">Follow-Up Features</h2>
<p>This feature is about propagating the MTU from oVirt Engine down to the VMs.
The automatic calculation of the MTU would be a follow-up feature.</p>

<h2 id="release-notes">Release Notes</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  == Managed MTU for VM networks ==
  The MTU of logical networks, including external ones, is propageted the
  whole path down to the guest's network interface. This will enable the
  usage of MTU &gt; 1500 bytes for external networks.
</code></pre></div></div>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2900/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2900/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2900/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2900/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/managed_mtu_for_vm_networks.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/network/managed_mtu_for_vm_networks.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
