<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>LiveMigrationSupportForSRIOV | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="LiveMigrationSupportForSRIOV" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3045/develop/release-management/features/network/liveMigrationSupportForSRIOV.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3045/develop/release-management/features/network/liveMigrationSupportForSRIOV.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="LiveMigrationSupportForSRIOV" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"LiveMigrationSupportForSRIOV","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3045/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3045/develop/release-management/features/network/liveMigrationSupportForSRIOV.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3045/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3045/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3045/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3045/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3045/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3045/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3045/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3045/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3045/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3045/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3045/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3045/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3045/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3045/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3045/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3045/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3045/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3045/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3045/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3045/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3045/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3045/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3045//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3045//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3045/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3045/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3045/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3045/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3045/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f5cf134eaa80bea1e03db147a440fa2d?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f5cf134eaa80bea1e03db147a440fa2d?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Martin Mucha">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Martin Mucha</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3045/documentation/'>Documentation is available here.</a></div>

<h1 id="live-migration-support-for-sriov">Live Migration Support For SRIOV</h1>

<p>rfe: https://bugzilla.redhat.com/show_bug.cgi?id=868811</p>

<h3 id="owner">Owner</h3>

<ul>
  <li>Name: Martin Mucha</li>
</ul>

<h2 id="summary">Summary</h2>
<p>Current support of SR-IOV (single root I/O virtualization) in engine 
does not allow migration, which
limits its usability. However current support of SR-IOV does support 
hot-plugging and hot-unplugging. We can employ this to enable currently 
not supported migration. When VM is migrated to another host, its
passthrough nic will be hot-unplugged, and related VF (virtual function)
will be released.
Then we can perform VM migration, and after that we’ll perform hot-plug.
Therefore, after migrating VM, there will be slight delay before nic 
reappears in VM.</p>

<h2 id="detailed-description">Detailed Description</h2>

<p>Currently, VMs using SR-IOV nics cannot be migrated. To preserve this 
behavior user can specify, whether each passthrough nic is ‘migratable’ 
or not. A VM can only be migrated, when all its nics passthrough 
nics are marked as migratable.</p>

<p>Hot-plug can succeed only if there’s available VF on 
target host. To avoid possible race, migration will allocate VF first, 
proceeding only if there is available one. 
If there’s none, VM won’t be migrated.</p>

<p>Migration with SR-IOV vNICs is a tricky multi-state operation, and can 
fail. If the operation fails after the VM is already running on the 
destination, the VM would not be migrated back.</p>

<h3 id="rest">REST</h3>

<p>Model will be altered, so that vNicProfile can be set as migratable:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Type</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">VnicProfile</span> <span class="kd">extends</span> <span class="nc">Identified</span> <span class="o">{</span>
    
    <span class="c1">//...</span>
    
    <span class="nc">VnicPassThrough</span> <span class="nf">passThrough</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">migratable</span><span class="o">();</span>
    
    <span class="c1">//...</span>
<span class="o">}</span>    
</code></pre></div></div>

<h3 id="gui">GUI</h3>

<p>In UI, you need to flag passthrough nic as migratable to be able to do
migration when SR-IOV is used. Only passthrough nic can be marked as
migratable, or not marked as migratable. Other nics are always 
migratable, thus migratable checkbox will be selected and greyed out
when passthrough checkbox is not selected.</p>

<h4 id="setting-migratable-flag">Setting migratable flag</h4>
<p><img src="/ovirt-site/previews/3045/images/vnicProfileWithMigratableFlag.png" alt="Vnic profile with migratable flag png" title="Vnic profile with migratable flag png" /></p>

<h3 id="guest-side-support">Guest-side support</h3>

<p>While migrating, the guest can notice that one of its vNICs has been 
unplugged, and communication is lost. To avoid that, VM admin should 
add two vNICs: an SR-IOV one for performance, and a virtio one for 
backup during migration. The guest should create a bonding (or teaming) 
device on top of these, so that user-space guest application can ignore 
the temporary disappearance of the SR-IOV device.</p>

<p>When migration finishes and the SR-IOV device is restored, it should be 
reattached to that bond. In the context of this feature, we would supply
the el7 hooking mechanism to make it happen seamlessly in the future, while
currently migration is possible using the following procedure via NetworkManager:</p>

<ul>
  <li>
    <p>Create the bond (with ens3 being the passthrough interface in this example):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ~]$ nmcli con add type bond con-name bond0 ifname bond0 mode active-backup primary ens3
  Connection 'bond0' (9301ff97-abbc-4432-aad1-246d7faea7fb) successfully added.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the interfaces to the bond:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ~]$ nmcli con add type bond-slave ifname eth0 master bond0
  Connection 'bond-slave-eth0' (50c59350-1531-45f4-ba04-33431c16e386) successfully added.
  ~]$ nmcli con add type bond-slave ifname ens3 master bond0
  Connection 'bond-slave-ens3' (70c5f150-2643-82f3-fa61-48444d28b182) successfully added.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Bring up the interfaces:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ~]$ nmcli con up eth0
  (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/14)
  ~]$ nmcli con up ens3
  (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/15)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, bring up the bond:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ~]$ nmcli con up bond0
  (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/16)
</code></pre></div>    </div>
  </li>
</ul>

<p>The active slave should be the primary slave as configured:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$] cat /sys/class/net/bond0/bonding/active_slave
ens3
</code></pre></div></div>

<p>Hot unplugging the primary slave should activate the backup slave:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$] cat /sys/class/net/bond0/bonding/active_slave
eth0
</code></pre></div></div>

<p>Hot plugging the primary slave back should return it to active state:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$] cat /sys/class/net/bond0/bonding/active_slave
ens3
</code></pre></div></div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3045/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3045/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3045/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3045/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/liveMigrationSupportForSRIOV.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/network/liveMigrationSupportForSRIOV.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
