<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>DomainInfrastructure | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="DomainInfrastructure" />
<meta name="author" content="Oved Ourfali" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2757/develop/infra/domaininfrastructure.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2757/develop/infra/domaininfrastructure.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DomainInfrastructure" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Oved Ourfali" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Oved Ourfali"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2757/images/logo.svg"},"name":"Oved Ourfali"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"DomainInfrastructure","url":"https://ovirt.github.io/ovirt-site/previews/2757/develop/infra/domaininfrastructure.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2757/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2757/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2757/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2757/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2757/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2757/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2757/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2757/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2757/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2757/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2757/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2757/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2757/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2757/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2757/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2757/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2757/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2757/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2757/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2757/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2757/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2757/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2757/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2757/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2757/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2757/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2757/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2757/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2757/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2757/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2757/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2757/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2757/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2757/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2757/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2757//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2757//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2757/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2757/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2757/develop/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yair Zaslavsky</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>This developer documentation is <strong>outdated</strong>, but provides historical context.<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2757/documentation/'>Documentation is available here.</a></div>

<h1 id="domain-infrastructure-in-the-ovirt-engine">Domain Infrastructure in the oVirt Engine</h1>

<p>This document describes the different components in the oVirt engine domain infrastructure, for authenticating and querying to LDAP servers. The infrastructure supports:</p>

<ol>
  <li>Authenticating Active Directory, IPA and RHDS using GSSAPI authentication</li>
  <li>Querying the directory using the LDAP protocol</li>
  <li>Easily adding new LDAP provider types</li>
  <li>Easily adding new query types</li>
</ol>

<p>This infrastructure is in the package: org.ovirt.engine.core.bll.adbroker, and it consists of the following main components:</p>

<ol>
  <li>Domain - Entity that represents domain related properties:
    <ul>
      <li>name // domain name</li>
      <li>RootDSE rootDSE // rootDSE for domain</li>
      <li>ldapServers // LDAP servers that match the domain</li>
      <li>ldapProviderType // (Active-Directory/IPA/RHDS)</li>
      <li>ldapSecurityAuthentication // set the authentication mode. Currently only GSSAPI is allowed</li>
    </ul>
  </li>
  <li>LdapTemplateWrapper - This class is responsible for the basic actions we do with Ldap servers:
    <ul>
      <li>initializing context for searches</li>
      <li>searching the directory</li>
    </ul>
  </li>
  <li>org.springframework.ldap.core.support.DirContextAuthenticationStrategy - interface for authentication strategy (we implement it in GSSAPIDirContextAuthenticationStrategy for gssapi authentication, and use the basic from spring ldap - SimpleDirContextAuthenticationStrategy, for simple authentication (simple authentication isn’t supported anymore).</li>
  <li>LdapQueryMetadata - interface that contains metadata about a query. Such as:
    <ul>
      <li>filter - the filter we use for the query. For example: (objectGUID=%1$s)</li>
      <li>baseDN - we set this if we want to query using a specific base dn</li>
      <li>contextMapper - context mapper is an object that takes the context returned from the ldap server, and maps it into the object we wish to return. For example, we have context mappers for user object, ADUserContextMapper and IPAUserContextMapper, that support constructing the user object from active directory and IPA respectively.</li>
      <li>searchScope - SUBTREE_SCOPE, ONE_LEVEL_SCOPE or OBJECT_SCOPE</li>
      <li>ldapGuidEncoder - used for encoding the guid (useful in cases the guid is not just an ordinary string, like in active directory)</li>
      <li>formatter - used for formatting the filter (we have SimpleLdapQueryExecutionFormatter for simple formatting of the filter, or MultipleLdapQueryExecutionFormatter for more composed queries).</li>
      <li>queryData - the data of the query. it is set when running it</li>
      <li>returningAttributes - array of strings with attribute names we wish the ldap server to return</li>
    </ul>
  </li>
  <li>LdapQueryType - enum with query types</li>
  <li>LdapQueryData - contains the data for the query:
    <ul>
      <li>ldapQueryType - the query type (for example: getUserByGuid, getGroupByGuid, getGroupByDN…)</li>
      <li>filterParameters - parameters for the filter (for example, the guid of the user, the name of the user, etc.)</li>
      <li>baseDNParameters - parameters for the basedn, in case we wish to change it</li>
      <li>domain - the name of the domain we wish to query</li>
    </ul>
  </li>
  <li>UsersDomainsCacheManagerService - a Service that implements UsersDomainsCacheManager, which supports adding/getting/removing domain objects, and associating user with a domain. The caching in the DB is used for searches and showing updated information in the UI on an hourly basis. It is always updated at login time for authorization decisions</li>
  <li>KerberosManager - a Service that initializes the kerberos configuration</li>
  <li>DirectorySearcher - a class that is responsible for querying the ldap server. It uses an instance of LdapQueryData in order to preform the query
    <ul>
      <li>The directory searcher gets the domain object from the UsersDomainsCacheManagerService, and it preforms a root DSE query in order to deduce the ldap provider type (Active-Directory or IPA)</li>
      <li>According to the result it performs the query suitable for the specific ldap provider type</li>
    </ul>
  </li>
</ol>

<h1 id="some-samples">Some samples</h1>

<ul>
  <li>
    <p>Querying user properties by principal name:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Create query data object
LdapQueryData queryData = new LdapQueryDataImpl();

// We wish to get the user by its principal name
queryData.setLdapQueryType(LdapQueryType.getUserByPrincipalName);

// The input of the query
queryData.setFilterParameters(new Object[] { krbPrincipalName });

// The domain we wish to query
queryData.setDomain(domain);

// Setting the credentials for the query
LdapCredentials credentials = new LdapCredentials(username, password);

// Creating the directory searcher
DirectorySearcher searcher = new DirectorySearcher(credentials);

// Running the query
List&lt;AdUser&gt; resultByUpn = searcher.FindAll(queryData);
</code></pre></div>    </div>
  </li>
  <li>
    <p>Querying group properties by group name:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LdapQueryData queryData = new LdapQueryDataImpl();
queryData.setLdapQueryType(LdapQueryType.getGroupByName);
queryData.setFilterParameters(new Object[] { "dev" });
queryData.setDomain(domain);

LdapCredentials credentials = new LdapCredentials(username, password);

DirectorySearcher searcher = new DirectorySearcher(credentials);

List&lt;AdUser&gt; resultByname = searcher.FindAll(queryData);
</code></pre></div>    </div>
  </li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2757/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2757/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2757/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2757/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/infra/domaininfrastructure.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/infra/domaininfrastructure.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
