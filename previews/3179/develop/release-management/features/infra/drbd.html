<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DRBD | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="DRBD" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3179/develop/release-management/features/infra/drbd.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3179/develop/release-management/features/infra/drbd.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DRBD" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"DRBD","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3179/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3179/develop/release-management/features/infra/drbd.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3179/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3179/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3179/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3179/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3179/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3179/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3179/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3179/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3179/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/58cce929c9b5cd0c35fdc3ebda687666?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/58cce929c9b5cd0c35fdc3ebda687666?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Philipp Reisner">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Philipp Reisner</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3179/documentation/'>Documentation is available here.</a></div>

<h1 id="drbd">DRBD</h1>

<h2 id="summary">Summary</h2>

<p><a href="http://www.drbd.org">DRBD</a> is a solution for linux to mirror local block devices. DRBD should get integrated into the oVirt nodes, so that it can be used instead of a SAN, or in addition to a san for providing DR.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Philipp Reisner (philipp_reisner)</li>
  <li>Email: <a href="mailto:philipp.reisner@linbit.com">philipp.reisner@linbit.com</a></li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Right now this is in planing stage. We need to discuss two possible approaches with people that are interested in that.</li>
  <li>There is a perfectly working solution for 2 nodes.</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>There are two possible approaches to the challenge. <strong>Right now, the “DRBD on VG level for DR only” is the preferred approach.</strong></p>

<h3 id="drbd-on-vg-level-for-dr-only">DRBD on VG level for DR only</h3>

<p>The BlockStorageDomain class in VDSM could be adopted in a way that it accepts DRBD devices. (To my knowledge right now it only accepts devices that are visible to multipathd).</p>

<ul>
  <li>PRO: The integration into VDSM would be trivial. The BlockStorageDomain class needs to be modified (or a new class derived) that detects and accepts DRBD devices.</li>
  <li>PRO: DRBD will be used in primary/secondary mode. All DRBD resources will be used only on one side (the active data center). Non of them will be active in the DR site.
Only in case the primary data center fails, the resources might be active in the DR site.</li>
</ul>

<p>Provisioning of DRBD replicated LVs will be provided by an independend project called drbdmanage. drbdmanage by itself is currently in early implementation phase. We at LINBIT will put more attention to this project and will make an early release available as soon as possible.</p>

<h3 id="drbd-on-lv-level">DRBD on LV level</h3>

<ul>
  <li>PRO: DRBD will be used in single primary (= primary/secondary) mode.</li>
  <li>PRO: No DRBD changes needed. One can use any 8.3.x or 8.4.x release out there, readily available through many distribution channels.</li>
  <li>CON: We need to implement a new sub-class of StorageDomain (or BlockStorageDomain). When creating an LV for a virtual machine it needs to put a DRBD device directly on that LV. In addition to that VDSM needs to <a href="http://www.drbd.org/users-guide-8.4/s-switch-resource-roles.html">promote the DRBD device into primary mode</a> before starting a VM on it. After a VM was stopped (or migrated away) it needs to demote it into secondary mode. (During a online-migration both sides should be primary).
As we LINBIT-guys have little knowledge about VDSM, we would welcome a few pointers by VDSM guys how to tackle that task.
In order to get rid of the dual-primary mode during an online-migration, QEMU/KVM needs to be updated to open the backing block device late during an online-migration.</li>
  <li>CON: More work on the engine is needed in order to make oVirt aware of replicated LVs</li>
</ul>

<h3 id="drbd-on-vg-level">DRBD on VG level</h3>

<p>The BlockStorageDomain class in VDSM could be adopted in a way that it accepts DRBD devices. (To my knowledge right now it only accepts devices that are visible to multipathd).</p>

<ul>
  <li>PRO: The integration into VDSM would be trivial. The BlockStorageDomain class needs to be modified (or a new class derived) that detects and accepts DRBD devices.</li>
  <li>CON: DRBD has to be used in <a href="http://www.drbd.org/users-guide-8.4/s-dual-primary-mode.html">dual primary</a> mode.</li>
  <li>CON: If the network connection of such a DRBD instance is interrupted, the virtual machines running on the two oVirt nodes will continue to modify their backing storage devices. These backing storage devices are LVs. The LVs got allocated from a PV residing on the DRBD device. So we end up with modifications on the DRBD devices on both oVirt nodes.
As DRBD is as of today (drbd-8.4.3) it will detect that both DRBD devices where modified while the connection was down and refuse to re-establish the connection. While doing <a href="http://www.drbd.org/users-guide-8.4/s-configure-split-brain-behavior.html#s-automatic-split-brain-recovery-configuration">automatic</a> or <a href="http://www.drbd.org/users-guide-8.4/s-resolve-split-brain.html">manual</a> <a href="http://www.drbd.org/users-guide-8.4/s-split-brain-notification-and-recovery.html">split brain</a> recovery, one will notice that DRBD allows only to do a resync in <strong>one direction</strong>. I.e. only the modifications of VMs running on one of the two oVirt nodes will survive (= the modifications of VMs running on the other node would be reverted by DRBD).
This is of course not a reasonable option. Therefore we consider to implement a new split-brain recovery mechanism in DRBD.
DRBD will do a <em>bidirectional resync</em> If the changes done by the two nodes during the outage of the replication network <strong>does not overlap</strong>. It will move only the modified blocks over to the node that has not yet seen these changes. (If we choose that route, it will take us a few month to do that, but we know what we are doing :))</li>
  <li>CON: SANLock should not be used on top of DRBD. At this stage there is no proposal how to replace SANLock for such a setup.</li>
</ul>

<h3 id="open-questions">Open Questions</h3>

<p>I got the impression that for this it is necessary that the shared device presents some kind of UUID to VDSM. VDSM uses this UUID to identify the storage instance on multiple nodes. Is that correct?</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>A data replication technology built directly into the oVirt nodes. This for sure opens up new use cases for oVirt.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>When it is clear how to integrate DRBD on the nodes, managing DRBD replication links by the web-user interface will become of interest.</p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li><a href="http://www.drbd.org/users-guide-8.4/">DRBD documentation for 8.4.x</a></li>
  <li><a href="http://wiki.qemu.org/Features/PostCopyLiveMigration">post copy live migration</a></li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3179/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3179/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3179/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3179/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/drbd.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/drbd.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
