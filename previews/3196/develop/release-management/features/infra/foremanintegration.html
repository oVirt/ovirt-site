<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ForemanIntegration | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="ForemanIntegration" />
<meta name="author" content="Oved Ourfali" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/infra/foremanintegration.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/infra/foremanintegration.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ForemanIntegration" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Oved Ourfali" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Oved Ourfali"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"ForemanIntegration","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3196/images/logo.svg"},"name":"Oved Ourfali"},"url":"https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/infra/foremanintegration.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3196/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3196/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3196/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3196/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3196/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3196/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3196/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3196/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3196/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Oved Ourfali">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9ba64bad62810ce4f4d5ea0df5bb75c2?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9ba64bad62810ce4f4d5ea0df5bb75c2?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Yaniv Bronheim">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yaniv Bronheim</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3196/documentation/'>Documentation is available here.</a></div>

<h1 id="foreman-integration">Foreman Integration</h1>

<h2 id="summary">Summary</h2>

<p><a href="http://theforeman.org/">Foreman</a> [1] The Foreman is a complete lifecycle management tool for physical and virtual servers.
Through deep integration with configuration management, DHCP, DNS, TFTP, and PXE-based unattended installations, Foreman manages every stage of the lifecycle of your physical or virtual servers.</p>

<p>The Foreman provides comprehensive, auditable interaction facilities including a web frontend and robust, RESTful API.</p>

<p><a href="https://launchpad.net/cloud-init/">Cloud-init</a> [1] is a tool used to perform initial setup on cloud nodes, including networking, SSH keys, timezone, user data injection, and more.
It is a service that runs on the guest, and supports various Linux distributions including Fedora, RHEL, and Ubuntu.</p>

<p>Integrating Foreman with oVirt will help adding hypervisor hosts that are managed by Foreman to the oVirt engine (already provisioned hosts
or discovered hosts for bare-metal provisioning which will include the OS installation process.), VM configuration, package management and etc.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>
    <p>Name: Yaniv Bronheim</p>
  </li>
  <li>Name: Oved Ourfali</li>
  <li>Email: <a href="mailto:ovedo@redhat.com">ovedo@redhat.com</a></li>
</ul>

<h2 id="current-status">Current Status</h2>

<ul>
  <li>Supported in oVirt&gt;=3.5 over RHEL&gt;=6.6</li>
  <li>Tested with Satellite Version 6.0.4 (Setup details described in <a href="#make-foreman-appliance">Make Foreman Appliance</a>)</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>Adding Foreman provider:</p>

<ul>
  <li>In the tree on the left, press the “External Providers” tree item, and then you’ll see the Providers main tab on the right:</li>
</ul>

<p><img src="/ovirt-site/previews/3196/images/wiki/Providers-tree.png" alt="" /></p>

<ul>
  <li>Press “Add”, fill in the details:</li>
</ul>

<p><img src="/ovirt-site/previews/3196/images/wiki/Fill-provider-details.png" alt="" /></p>

<ul>
  <li>In order to check connectivity and credentials to the external provider, press the “Test” button. The result will appear:</li>
</ul>

<p><img src="/ovirt-site/previews/3196/images/wiki/Test-provider.png" alt="" /></p>

<ul>
  <li>If the provider is secured (https), the certificates will be read from it, and you’ll have an option to add them as trusted certificates.</li>
</ul>

<p>Using the Foreman provider:</p>

<h3 id="adding-installed-foreman-hosts-as-ovirt-hosts">Adding installed Foreman hosts as oVirt hosts</h3>

<p>When adding a new host to oVirt, the administrator has to know in advance different details about the host, such as the FQDN, root password, power management options and etc.</p>

<p>In this feature we will add a checkbox saying whether to show “external” hosts in the host dialog (external hosts are Foreman hosts, but in the future we might support other providers as well),
and if so the hosts will be loaded from Foreman, and displayed in the external hosts list box.
Once a user selects a host, it will automatically set the address as the FQDN we got from Foreman (non-changeable), and also set the name of the host to the FQDN (as a suggestion, changeable).</p>

<p>Screenshot 1 - The user didn’t choose to show external providers</p>

<p><img src="/ovirt-site/previews/3196/images/wiki/New-host-dialog-providers.png" alt="" /></p>

<p>Screenshot 2 - The user chose to see the external providers, and he selects one of them.
A free text search is shown (provider specific search), and the user can either write a search query, or just press the search button, which will retrieve all hosts.</p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Selected-provider.png" alt="" /></p>

<p>Screenshot 3 - Selecting a host. The name and address were updated automatically (and in the future also other properties)</p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Select-host-from-provider.png" alt="" /></p>

<p>Screenshot 4 - All the details that the host provider set, are updated automatically. The host address is grayed out. All the rest is editable.</p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Select-host-properties.png" alt="" /></p>

<p><strong>Implementation Notes</strong></p>

<p><strong>API Design</strong></p>

<p>No changes in the API. The external provider’s hosts will be shown only in the UI.</p>

<ul>
  <li>Engine/Backend/DB
    <ul>
      <li>Adding the provider DB/engine/UI and etc. is covered in another feature, <a href="/ovirt-site/previews/3196/develop/release-management/features/network/detailed-osn-integration.html">Features/Detailed Quantum Integration</a>.</li>
      <li>Additional changes:
        <ul>
          <li>Adding a host provider interface, with implementation for Foreman</li>
          <li>The host provider will currently support listing hosts, filtered listing of hosts
(we might add in the future a textbox in the add-host-dialog to support freetext search criteria), and testing connection (useful in the add provider dialog).</li>
          <li>Adding a query to get a provider by type (to get all the foreman providers)</li>
          <li>Adding a query to get all provider hosts</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="bare-metal-provisioning">Bare-Metal Provisioning</h3>

<p>Prerequisites:</p>

<ul>
  <li>Set Satellite Discovery: <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Satellite/6.0/html-single/User_Guide/#sect-Installing_the_Foreman_Discovery_Plugin">https://access.redhat.com/documentation/en-US/Red_Hat_Satellite/6.0/html-single/User_Guide/#sect-Installing_the_Foreman_Discovery_Plugin</a></li>
  <li>Enable discovery
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>foreman-installer <span class="nt">--foreman-plugin-discovery-install-images</span> <span class="nt">--foreman-plugin-discovery-install-images</span>
</code></pre></div>    </div>
  </li>
  <li>Add oVirt Provision Plugin:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>yum <span class="nb">install </span>ruby193-rubygem-ovirt_provision_plugin
<span class="gp">#</span><span class="w"> </span>foreman-installer <span class="nt">--enable-foreman-plugin-ovirt-provision</span>
</code></pre></div>    </div>
  </li>
  <li>Define Hostgroups: Foreman admin has a designated host group(s) in foreman for that purpose to define full provision setup with default values</li>
  <li>Have the proper images for the OS installation setup in the foreman setup</li>
  <li>Correlate the defined Host group with relevant templates (PXE / kickstart files) associated to the relevant OSs</li>
  <li>oVirt needs proper permissions to view relevant bare-metal hosts, host groups, compute resources and execute provision request [TODO define roles automatically]</li>
  <li>Set Foreman’s compute resource that correlates to the required permissions (Availability to approve and add host by oVirt provision plugin.</li>
  <li>Define puppet class for installing oVirt-Engine public key to allow deploy oVirt on provisioned host
(locate them under <code class="language-plaintext highlighter-rouge">/usr/share/puppet/modules</code>) - example in <a href="#make-foreman-appliance">Make Foreman Appliance</a>.</li>
</ul>

<p>Steps To Use:</p>

<ul>
  <li>Each new host in the network boots with the discovery image which registers the host’s info to Foreman under discovered hosts page.</li>
  <li>Once the host provider is configured, go to the Data Center view-&gt; Choose Hosts tab-&gt; Add new Host-&gt; sign “Use Foreman Hosts Providers”-&gt; Pick the provider name and choose Host, Compute Resource that refers to the engine’s setup, and the desired Host Group for the provision.</li>
  <li>When signing “Use Foreman Hosts Providers” the default choice is “Discovered Hosts”. You can also pick Provisioned Host and add them as regular host.</li>
  <li>Once click OK the server will start to be installed. Meanwhile the host’s status is InstallingOS. When provision is done OvirtProvisionPlugin (at foreman’s side) sends request to the engine to reinstall the host. After this is done the host’s status will be changed to Installing-&gt;UP.</li>
  <li>On failures please refer to engine.log in the oVirt-Engine setup and production.log in the Foreman setup.</li>
</ul>

<h3 id="user-flow">User-flow:</h3>

<p><img src="/ovirt-site/previews/3196/images/wiki/Discover-1-phase.png" alt="" /></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Discover-2-phase.png" alt="" /></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Discover-3-phase.png" alt="" /></p>

<h4 id="addnewhost-form-in-ovirt-shows-new-list-of-discovered-hosts-taken-from-foreman">AddNewHost form in oVirt shows new list of discovered hosts taken from Foreman</h4>

<ol>
  <li>Select a HostGroup for this host. All proper configuration needs to be declared in host group definition (part of Foreman setup)</li>
  <li>Select computeResource to allow access back from Foreman to oVirt (part of Foreman setup)</li>
  <li>All “Discovered” information will filled out in the new host form, edit them as desired</li>
</ol>

<p><img src="/ovirt-site/previews/3196/images/wiki/DiscoverUIexample.png" alt="" /></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Discover-4-phase.png" alt="" /></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Discover-5-phase.png" alt="" /></p>

<hr />

<p>The following system flow will occur:</p>

<ol>
  <li>Add the host to foreman using the API (Provision the discovered host)</li>
  <li>The host will be added and appear in the oVirt UI with status “Installing OS” util the following ends:
    <ol>
      <li>For oVirt-node hosts - the registration will occur through the oVirt-node (assuming the kernel parameters are configured for that Foreman template), and the host will be approved automatically by Foreman</li>
      <li>For other OS - at first step won’t do the registration by themselves, but foreman will do that using a plugin (plugin will send REST-API call to add or approve the host)</li>
    </ol>
  </li>
</ol>

<p><img src="/ovirt-site/previews/3196/images/wiki/InstallingOSExample.png" alt="" /></p>

<h3 id="future-plans-vm-provisioning">Future Plans: VM provisioning</h3>

<p>Two alternative:</p>

<ul>
  <li>Add the VM through oVirt, and then add it to Foreman as bare-metal (add the oVirt compute resource) - only PXE installation, passing the MAC address to foreman</li>
  <li>Add the VM through foreman (Using compute resource) (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1084001">https://bugzilla.redhat.com/show_bug.cgi?id=1084001</a>)</li>
</ul>

<p>I’d go with the former option, as it leaves the VM creation similar to what we have today. However, we don’t really leverage oVirt templates with that approach.</p>

<h2 id="setup-testing-environment">Setup Testing Environment</h2>

<p>To allow testing the feature in “allinone” configuration, which means running foreman on a VM and simulate new bare-metal hosts with new VMs,
you should configure the following on your hypervisor:</p>

<p>(NOTE: This manual set the foreman subnet to 192.168.223.0, which 192.168.223.2 is the foreman VM address and 192.168.223.1 is the gateway to the external network)</p>

<ul>
  <li>
    <p>Enable IP forwarding:</p>

    <p>Edit <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> and set <code class="language-plaintext highlighter-rouge">net.ipv4.ip_forward = 1</code></p>
  </li>
  <li>
    <p>Create virt network</p>

    <p>save the following to file called <code class="language-plaintext highlighter-rouge">foreman_net.xml</code>:</p>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;network&gt;</span>
        <span class="nt">&lt;name&gt;</span>foreman<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;uuid&gt;</span>3a80901c-a020-4e7a-bd3b-770b29844b03<span class="nt">&lt;/uuid&gt;</span>
        <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">'nat'</span><span class="nt">&gt;</span>
              <span class="nt">&lt;nat&gt;</span>
                    <span class="nt">&lt;port</span> <span class="na">start=</span><span class="s">'1024'</span> <span class="na">end=</span><span class="s">'65535'</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;/nat&gt;</span>
        <span class="nt">&lt;/forward&gt;</span>
        <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">'virbrforeman'</span> <span class="na">stp=</span><span class="s">'off'</span> <span class="na">delay=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'52:54:00:38:f9:08'</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;ip</span> <span class="na">address=</span><span class="s">'192.168.223.1'</span> <span class="na">netmask=</span><span class="s">'255.255.255.0'</span><span class="nt">&gt;&lt;/ip&gt;</span>
  <span class="nt">&lt;/network&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Set the network to virsh
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>virsh - vdsm@ovirt:shibboleth
<span class="gp">#</span><span class="w"> </span>net-define /path/to/foreman_net.xml
<span class="gp">#</span><span class="w"> </span>net-autostart foreman
<span class="gp">#</span><span class="w"> </span>net-start foreman
</code></pre></div>    </div>
    <p>With <code class="language-plaintext highlighter-rouge">ip -4 a</code> you should see that <code class="language-plaintext highlighter-rouge">virbrforeman</code> has the right ip</p>
  </li>
  <li>Config engine
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>engine-config <span class="nt">-s</span> <span class="nv">CustomDeviceProperties</span><span class="o">=</span><span class="s1">'{type=interface;prop={extnet=^[a-zA-Z0-9_ ---]+$}}'</span>
<span class="gp">#</span><span class="w"> </span>engine-config <span class="nt">-g</span> CustomDeviceProperties
</code></pre></div>    </div>
    <p>( You can read about it under <code class="language-plaintext highlighter-rouge">vdsm_hooks/extnet/README</code> )</p>
  </li>
  <li>Install the vdsm-hook-extnet rpm on host</li>
  <li>Add the host to engine if its not already there</li>
  <li>Create route rule on host
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>ip route add 192.168.223.0/24 scope <span class="nb">link </span>dev virbrforeman table 170066347
</code></pre></div>    </div>
    <p>(The number of table depends on your dhcp assigned address. You can check for yours by:  <code class="language-plaintext highlighter-rouge">ip rule show</code>)</p>
  </li>
  <li>
    <p>Configure oVirt</p>

    <p>Go to the Networks tab
  click on “ovirtmgmt”
  then on the “vNIC Profiles” subtab
  New -&gt; name: foreman_libvirt_net -&gt;  in “please select a key” select extnet and put “foreman” as value</p>
  </li>
  <li>Set foreman Vm network by running
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>ip addr add dev eth0 192.168.223.2/24
<span class="gp">#</span><span class="w"> </span>ip <span class="nb">link set </span>dev eth0 up
<span class="gp">#</span><span class="w"> </span>ip route add dev eth0 default via 192.168.223.1
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="make-foreman-appliance">Make Foreman Appliance</h3>

<p>[The following includes for instructions to make your own simple foreman’s environment with discovery abilities. Later we plan to have public template for this appliance]</p>

<ul>
  <li>I would suggest to do it all in a libvirt environment for testing, unless you have switch and few physical hosts for this test</li>
  <li>For user with virt-manager : Set isolated network with virt manager and create NAT to em1 on you physical hosts</li>
  <li>For ovirt users: Create another network, separated from the ovirtmgmt, all the machine will be connected to this network and will get connection outside by the host itself as default gw</li>
  <li>Install on one machine Centos 6.5 (Don’t create user foreman. Better to leave only root user)</li>
  <li>
    <p>Set static IP address in this network</p>

    <p>e.g for 192.168.100.0 subnet: <code class="language-plaintext highlighter-rouge">vi /etc/sysconfig/network-scripts/ifcfg-eth0</code></p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DEVICE</span><span class="o">=</span>eth0
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
<span class="nv">ONBOOT</span><span class="o">=</span><span class="nb">yes
</span><span class="nv">NM_CONTROLLED</span><span class="o">=</span>no
<span class="nv">BOOTPROTO</span><span class="o">=</span>static
<span class="nv">IPADDR</span><span class="o">=</span>192.168.100.2
<span class="nv">NETMASK</span><span class="o">=</span>255.255.255.0
<span class="nv">GATEWAY</span><span class="o">=</span>192.168.100.1
</code></pre></div>    </div>
  </li>
  <li>Copy <code class="language-plaintext highlighter-rouge">/etc/resolve.conf</code> from the physical host that runs the VMs and set this host as the default gw</li>
  <li>Set EPEL Repo:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>wget https://archives.fedoraproject.org/pub/archive/epel/6/x86_64/epel-release-6-8.noarch.rpm
<span class="gp">#</span><span class="w"> </span>rpm <span class="nt">-ivh</span> epel-release-6-8.noarch.rpm
</code></pre></div>    </div>
  </li>
  <li>Install foreman:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>yum <span class="nt">-y</span> <span class="nb">install </span>http://yum.theforeman.org/releases/1.6/el6/x86_64/foreman-release.rpm
<span class="gp">#</span><span class="w"> </span>yum <span class="nt">-y</span> <span class="nb">install </span>foreman-installer
<span class="gp">#</span><span class="w"> </span>foreman-installer <span class="nt">-i</span>
</code></pre></div>    </div>
    <p>while running the last command please note:</p>
    <ul>
      <li>enable <code class="language-plaintext highlighter-rouge">foreman_compute_ovirt</code> and <code class="language-plaintext highlighter-rouge">foreman_plugin_discovery</code> - you can always re-run it so don’t worry about mistakes</li>
      <li>better not to install <code class="language-plaintext highlighter-rouge">puppetdb_foreman</code> to avoid Bug <a href="http://projects.theforeman.org/issues/3570">http://projects.theforeman.org/issues/3570</a></li>
    </ul>

    <p>At the end you should see:</p>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">  Installing   Done   [100%] [.........................................................................................]
   Success!

 * Foreman is running at https://localhost.localdomain
       Initial credentials are admin / NUrbTvc6Vkv6XNxa
 * Foreman Proxy is running at https://localhost.localdomain:8443
   * Puppetmaster is running at port 8140
   The full log is at /var/log/foreman-installer/foreman-installer.log
</span></code></pre></div>    </div>

    <p>In case something failed follow the errors and try again. Don’t move on with the instructions.</p>
  </li>
  <li>Stop the iptables on your foreman machine
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>iptables <span class="nt">-F</span>
</code></pre></div>    </div>
  </li>
  <li>Go to foreman web interface and change admin password</li>
  <li>In the WebUI: Go to infrastructure -&gt; provisioning setup -&gt; follow the guide and configure and dns and dhcp by the foreman-installer command that the foreman suggested (see [1])</li>
  <li>Run the installer with the desired configuration</li>
  <li>Install the ovirt provision plugin
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>yum <span class="nt">-y</span> <span class="nb">install </span>ruby193-rubygem-ovirt_provision_plugin
</code></pre></div>    </div>
  </li>
  <li>Install the discovery images
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>foreman-installer <span class="nt">--foreman-plugin-discovery-install-images</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Go to the ui again -&gt;Hosts-&gt;Provisioning Templates-&gt; find PXELinux global default and add there in the end:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LABEL discovery
MENU LABEL Foreman Discovery
MENU DEFAULT
KERNEL boot/foreman-discovery-image-latest.el6.iso-vmlinuz
APPEND rootflags=loop initrd=boot/foreman-discovery-image-latest.el6.iso-img  root=live:/foreman.iso
                  rootfstype=auto ro rd.live.image rd.live.check rd.lvm=0 rootflags=ro crashkernel=128M
                  elevator=deadline max_loop=256 rd.luks=0 rd.md=0 rd.dm=0
                  nomodeset selinux=0 stateless foreman.url=`[`https://192.168.100.2`](https://192.168.100.2)` &lt;-- here put the foreman's ip
IPAPPEND 2
</code></pre></div>    </div>

    <p>Change also - ONTIMEOUT discovery</p>
  </li>
  <li>Go back to Host-&gt;Provisioning Templates and click on “Build PXE defaults”</li>
  <li>
    <p>Create puppet module for the engine’s ssh pk</p>

    <p>Go to Foreman’s appliance and create a folder under <code class="language-plaintext highlighter-rouge">/etc/puppet/modules</code> with the follow directories
(the directories’ names are important. otherwise puppet doesn’t recognize the classes):</p>

    <ul>
      <li>
        <p>Directory <code class="language-plaintext highlighter-rouge">files</code> -&gt; under it put the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file filled with the engine’s pk and set the file with execute permission.</p>

        <p>e.g:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvNAlTKk/L2I+uyzeqKPErywGgFuQ0GQVf4HT4ir64Wi41SDwtt0edVQ8PwAeyY2jhbwGy0EzPgg0z/SVFIay5uEDSS8ObPICpTNpVlLp5618DKlCnOo3AwYMqbSBsPw6mKVnTvGjdw3lbBey/mEWrx5w7QHJw6FqwDyQ4big12yOECigGr1NYZWzsdVgDzI5oG3fbYHj/tfdDYfeWixNVZG4a0wBONjKJewr8hApMa8BkGJi/gkQ9XWjfx/RClHXWwgR1YMEUG0oBxWf394tueytheAxhYyujq7TOfgwC1cCa8EYUJxEbNuCjL25b1WnC+hp66/O8TYRTpWBFs9Y/ ovirt-engine
</code></pre></div>        </div>
      </li>
      <li>
        <p>Directory <code class="language-plaintext highlighter-rouge">lib</code> -&gt; empty dir (there are puppet plugins which look for the lib directory, so better to have it if you installed one)</p>
      </li>
      <li>
        <p>Directory <code class="language-plaintext highlighter-rouge">manifests</code> -&gt; <code class="language-plaintext highlighter-rouge">init.pp</code> and <code class="language-plaintext highlighter-rouge">site.pp</code></p>

        <p><code class="language-plaintext highlighter-rouge">init.pp</code>:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ovirtpk {
    # create a directory
    file { "/root/.ssh":
            ensure =&gt; "directory",
            mode  =&gt; '0700',
            owner =&gt; 'root',
            group =&gt; 'root',
            before =&gt; File['/root/.ssh/authorized_keys'],
    }
    file { "/root/.ssh/authorized_keys":
            path =&gt; '/root/.ssh/authorized_keys',
            ensure =&gt; file,
            mode  =&gt; '0600',
            owner =&gt; 'root',
            group =&gt; 'root',
            source =&gt; "puppet:///modules/ovirtpk/authorized_keys",
    }
}
</code></pre></div>        </div>

        <p><code class="language-plaintext highlighter-rouge">site.pp</code>:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node default {
       include ovirtpk
}
</code></pre></div>        </div>
      </li>
      <li>
        <p>Directory <code class="language-plaintext highlighter-rouge">tests</code> -&gt; <code class="language-plaintext highlighter-rouge">init.pp</code></p>

        <p><code class="language-plaintext highlighter-rouge">init.pp</code>:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class { 'ovirtpk': }
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Run <code class="language-plaintext highlighter-rouge">puppet apply /etc/puppet/modules/ovirtpk/manifests/site.pp</code> to verify that all set as needed. and <code class="language-plaintext highlighter-rouge">puppet agent --test</code></li>
  <li>In Foreman’s UI: Go to Configure-&gt;Pupppet Classes-&gt; click on “Import from [your-hostname]”</li>
  <li>Now run new host in the same network and you’ll see the discovery screen. when this host\vm will finish to boot you should see new entery in the Hosts-&gt;Discovered Hosts page</li>
  <li>If you’ll add this foreman server as external provider to ovirt, you will be able to see discovered host in the add host tab and follow the instructions above.</li>
</ul>

<h3 id="benefit-to-ovirt">Benefit to oVirt</h3>

<ul>
  <li>Better integration with external host providers, that will ease the work for the administrator</li>
  <li>Providing an interface that other host providers can implement, to add their own properties and logic</li>
</ul>

<h3 id="documentation--external-references">Documentation / External References</h3>

<ol>
  <li>Foreman homepage: <a href="http://theforeman.org/">http://theforeman.org/</a></li>
  <li>Presentation for CloudOpen NA, 2014 - Integrating oVirt and Foreman to Empower your Data-Center: <a href="https://www.youtube.com/watch?v=gozX891kYAY">https://www.youtube.com/watch?v=gozX891kYAY</a></li>
</ol>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3196/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3196/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3196/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3196/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2025 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/foremanintegration.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/foremanintegration.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
