<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SR-IOV Live Migration without downtime | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="SR-IOV Live Migration without downtime" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/network/sriov-live-migration.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/network/sriov-live-migration.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SR-IOV Live Migration without downtime" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"SR-IOV Live Migration without downtime","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3012/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/network/sriov-live-migration.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3012/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3012/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3012/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3012/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3012/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3012/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3012/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3012/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3012/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6536e276265bfa4de65dbaf52bc396e1?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6536e276265bfa4de65dbaf52bc396e1?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ales Musil">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ales Musil</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3012/documentation/'>Documentation is available here.</a></div>

<h1 id="sr-iov-live-migration-without-downtime">SR-IOV Live Migration without downtime</h1>

<h2 id="summary">Summary</h2>

<p>This feature allows you to migrate VM that is connected via SR-IOV with
a minimal network downtime and supersedes the <a href="https://www.ovirt.org/develop/release-management/features/network/liveMigrationSupportForSRIOV.html">Live Migration Support For SRIOV</a>
that required additional configuration inside affected VM.</p>

<p>The state of the feature is tracked in <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1688177">[RFE] [SR-IOV] Migration should not require downtime as of today</a>.
Related patches can be found on <a href="https://gerrit.ovirt.org/#/q/topic:sriov_live_migration">gerrit topic:sriov_live_migration</a>.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>
    <p>Name: <a href="https://github.com/almusil">Ales Musil</a></p>
  </li>
  <li>
    <p>Email: <a href="mailto:amusil@redhat.com">amusil@redhat.com</a></p>
  </li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>In order to migrate a VM that is connected to SR-IOV passthrough profile
we need to first unplug the SR-IOV device from a VM on the source, migrate
the VM and plug SR-IOV device on the destination. This causes longer downtime
during which the VM is not connected to the network.</p>

<p>The current implementation allowed to mitigate this downtime
<a href="https://www.ovirt.org/develop/release-management/features/network/liveMigrationSupportForSRIOV.html">Live Migration Support For SRIOV</a>, however this approach required manual
configuration to be done in the guest which is not convenient for large setups.</p>

<p>In order to achieve minimal downtime the <a href="https://www.kernel.org/doc/html/latest/networking/net_failover.html">NET_FAILOVER</a> support was added
to Linux kernel. The driver provides automated mechanism which is transparent
to the VM, and the user space. It is achieved by <code class="language-plaintext highlighter-rouge">failover</code> netdev which acts
as master device and controls two slave devices, the <code class="language-plaintext highlighter-rouge">primary</code> device being
SR-IOV passtrough and the virtio as <code class="language-plaintext highlighter-rouge">standby</code>. The VM user access network
through the <code class="language-plaintext highlighter-rouge">failover</code> device.</p>

<p>There is still need to provide two interfaces, the SR-IOV passtrough device
and virtio device, to the affected VM, but the  overall configuration overhead
has been reduced to selecting suitable vNIC profile pair.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>The implementation requires a <a href="https://github.com/torvalds/linux/commit/30c8bd5aa8b2c78546c3e52337101b9c85879320">Linux kernel</a>, <a href="https://github.com/patchew-project/qemu/commit/9711cd0dfc3fa414f7f64935713c07134ae67971">libvirt</a> and <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1693587">qemu</a>
support with <code class="language-plaintext highlighter-rouge">net_failover</code>.</p>

<p>The <a href="https://github.com/torvalds/linux/commit/30c8bd5aa8b2c78546c3e52337101b9c85879320">Linux kernel</a> support has to be only on guest side.</p>

<h2 id="limitations">Limitations</h2>

<ul>
  <li>In addition to the SR-IOV NIC, a linux-bridge based has to be connected to the source, and the destination host.</li>
  <li>Because of the required support in the guest, only RHEL8 (Linux kernel version &gt;=4.18 or &gt;=5.10) and Windows
(Windows VirtIO Drivers &gt;=0.1.189) guests are supported.</li>
  <li>Hosts with Cluster level version of &gt;=4.6 are required.</li>
  <li>Updating of the vNIC profile acting as <code class="language-plaintext highlighter-rouge">failover</code> is not allowed.</li>
  <li>Due to internal implementation details attaching two <code class="language-plaintext highlighter-rouge">VF</code>s, that are using the same <code class="language-plaintext highlighter-rouge">failover</code> vNIC profile,
to the same VM will fail in libvirt.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<h3 id="entity-description">Entity Description</h3>

<p>vNIC profile will get a new attribute that will point to the failover virtio
vNIC profile. This selection will be only available with <code class="language-plaintext highlighter-rouge">Passthrough</code> and <code class="language-plaintext highlighter-rouge">Migratable</code>
selected.</p>

<h3 id="user-experience">User Experience</h3>

<p>Upon creation of vNIC profile, the user can enable failover and select
the failover network vNIC profile. The <code class="language-plaintext highlighter-rouge">Failover</code> selection is available
only for <code class="language-plaintext highlighter-rouge">Passthrough</code> and <code class="language-plaintext highlighter-rouge">Migratable</code> vNIC profiles.</p>

<p>REST API takes an additional parameter for vNIC called <code class="language-plaintext highlighter-rouge">failover</code>
containing id of the failover vNIC profile:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;vnic_profile id="123"&gt;
  &lt;name&gt;vNIC_name&lt;/name&gt;
  &lt;pass_through&gt;
    &lt;mode&gt;enabled&lt;/mode&gt;
  &lt;/pass_through&gt;
  &lt;migratable&gt;true&lt;/migratable&gt;
  &lt;failover id="456"/&gt;
&lt;/vnic_profile&gt;
</code></pre></div></div>

<p>VM interface then requires only single vNIC profile that has the <code class="language-plaintext highlighter-rouge">failover</code> attribute
in order to utilize this behavior.</p>

<h3 id="engine-backend">Engine backend</h3>

<p>As engine is responsible for creating XML for a new VM nic, the
appropriate XML will be created and provided to libvirt.</p>

<p>In order to ensure that the virtio network is available the migration policy needs to be updated.</p>

<p>The <code class="language-plaintext highlighter-rouge">ActivateDeactivateVmNicCommand</code> will be updated to handle plug/unplug of the failover nic, when needed.
During migration the command will ensure that only <code class="language-plaintext highlighter-rouge">VF</code> VM nic is unplugged and then plugged back, any other
user interaction will affect both <code class="language-plaintext highlighter-rouge">VF</code> and <code class="language-plaintext highlighter-rouge">failover</code> VM nic.</p>

<p>As mentioned in the <a href="#limitations">Limitations</a>, new cluster level is required to ensure correct package version
of libvirt and qemu.</p>

<h3 id="libvirt-xml">Libvirt XML</h3>

<p>If the feature is activated for a new VM nic, the libvirt XML definition
contains an additional network with attribute <a href="https://libvirt.org/formatdomain.html#teaming-a-virtio-hostdev-nic-pair">teaming element</a>,
as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;devices&gt;
  &lt;interface type='bridge'&gt;
    &lt;mac address='00:11:22:33:44:55' /&gt;
    &lt;model type='virtio' /&gt;
    &lt;link state='up' /&gt;
    &lt;source bridge='ovirtmgmt' /&gt;
    &lt;mtu size='1500' /&gt;
    &lt;alias name='ua-virtio-net' /&gt;
    &lt;teaming type='persistent'/&gt;
  &lt;/interface&gt;
  &lt;interface managed='no' type='hostdev'&gt;
    &lt;mac address='00:11:22:33:44:55' /&gt;
    &lt;source&gt;
      &lt;address bus='0xb3' domain='0x0000' function='0x3' slot='0x02' type='pci' /&gt;
    &lt;/source&gt;
    &lt;link state='up' /&gt;
    &lt;driver name='vfio' /&gt;
    &lt;alias name='ua-sriov-hostdev' /&gt;
    &lt;teaming type='transient' persistent='ua-virtio-net'/&gt;
  &lt;/interface&gt;
&lt;/devices&gt;
</code></pre></div></div>

<h3 id="vdsm">Vdsm</h3>

<p>Because of the current rule that <code class="language-plaintext highlighter-rouge">VF</code> and <code class="language-plaintext highlighter-rouge">failover</code> have same MAC address, vdsm code needs to adjusted
to account for that. In order to achieve that, vdsm will require matching of alias and MAC address if the
interface xml contains <code class="language-plaintext highlighter-rouge">teaming</code> attribute.</p>

<h2 id="installationupgrade">Installation/Upgrade</h2>

<p>The feature will not affect new or existing installations.</p>

<h2 id="testing">Testing</h2>

<p>To test this feature, the desired VM with SR-IOV failover
configured, should be migrated to a different host.</p>

<h2 id="open-qeustions">Open qeustions</h2>

<ul>
  <li>An allowed limit of packet drop during migration?</li>
  <li>Can the virtio device be connected to the same PF as VF?</li>
</ul>

<h2 id="documentation--external-references">Documentation &amp; External references</h2>

<p><a href="https://www.ovirt.org/develop/release-management/features/network/liveMigrationSupportForSRIOV.html">Live Migration Support For SRIOV</a></p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1688177">Bug 1688177 - [RFE] [SR-IOV] Migration should not require downtime as of today</a></p>

<p><a href="https://gerrit.ovirt.org/#/q/topic:sriov_live_migration">gerrit topic:sriov_live_migration</a></p>

<p><a href="https://www.kernel.org/doc/html/latest/networking/net_failover.html">Linux: NET_FAILOVER</a></p>

<p><a href="https://github.com/torvalds/linux/commit/30c8bd5aa8b2c78546c3e52337101b9c85879320">Linux: net: Introduce generic failover module</a></p>

<p><a href="https://github.com/patchew-project/qemu/commit/9711cd0dfc3fa414f7f64935713c07134ae67971">qemu: net/virtio: add failover support</a></p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1693587">Bug 1693587 - RFE: support for net failover devices in libvirt</a></p>

<p><a href="https://libvirt.org/formatdomain.html#teaming-a-virtio-hostdev-nic-pair">Teaming a virtio/hostdev NIC pair</a></p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3012/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3012/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3012/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3012/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/sriov-live-migration.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/network/sriov-live-migration.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
