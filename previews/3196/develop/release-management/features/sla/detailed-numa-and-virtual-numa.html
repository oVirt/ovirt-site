<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Detailed NUMA and Virtual NUMA | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Detailed NUMA and Virtual NUMA" />
<meta name="author" content="Bruce Shi" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/detailed-numa-and-virtual-numa.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/detailed-numa-and-virtual-numa.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Detailed NUMA and Virtual NUMA" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Bruce Shi" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Bruce Shi"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Detailed NUMA and Virtual NUMA","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3196/images/logo.svg"},"name":"Bruce Shi"},"url":"https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/detailed-numa-and-virtual-numa.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3196/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3196/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3196/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3196/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3196/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3196/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3196/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3196/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3196/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ed0a04fb71aa7d499870795b4252382c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ed0a04fb71aa7d499870795b4252382c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Bruce Shi">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Bruce Shi</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/2f88ac61607581f5833e228550ee2f34?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/2f88ac61607581f5833e228550ee2f34?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Jason Liao">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Jason Liao</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3196/documentation/'>Documentation is available here.</a></div>

<h1 id="numa-and-virtual-numa">NUMA and Virtual NUMA</h1>

<h2 id="summary">Summary</h2>

<p>This feature allow Enterprise customers to provision large guests for their traditional scale-up enterprise workloads and expect low overhead due to visualization.</p>

<ul>
  <li>Query target host’s NUMA topology</li>
  <li>NUMA bindings of guest resources (vCPUs &amp; memory)</li>
  <li>Virtual NUMA topology</li>
</ul>

<p>You may also refer to the <a href="/ovirt-site/previews/3196/develop/release-management/features/sla/numa-and-virtual-numa.html">simple feature page</a>.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Jason Liao (JasonLiao), Bruce Shi (BruceShi)</li>
  <li>Email: <a href="mailto:chuan.liao@hp.com">chuan.liao@hp.com</a>, <a href="mailto:xiao-lei.shi@hp.com">xiao-lei.shi@hp.com</a></li>
  <li>IRC: jasonliao, bruceshi @ #ovirt (irc.oftc.net)</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Target Release: oVirt 3.5</li>
  <li>Status: design</li>
  <li>Last updated: 25 Mar 2014</li>
</ul>

<p>This is the detailed design page for NUMA and Virtual NUMA</p>

<h2 id="data-flow-diagram">Data flow diagram</h2>

<p><img src="/ovirt-site/previews/3196/images/wiki/Data_Flow_Diagram.png" alt="" /></p>

<h2 id="interface--data-structure">Interface &amp; data structure</h2>

<h3 id="interface-between-vdsm-and-libvirt">Interface between VDSM and libvirt</h3>

<ol>
  <li>I-1.1 Host’s NUMA node index and CPU id of each NUMA node</li>
  <li>I-1.2 Host’s NUMA node memory information, include total and free memory</li>
  <li>I-1.5 Configuration of VM’s memory allocation mode and memory comes from which NUMA nodes</li>
  <li>I-1.6 Configuration of VM’s virtual NUMA topology</li>
</ol>

<ul>
  <li>I-1.1 Seek the host NUMA nodes information by using <code class="language-plaintext highlighter-rouge">getCapabilities</code> API in libvirt
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;capabilities&gt;</span>
    …
    <span class="nt">&lt;host&gt;</span>
        ...
        <span class="nt">&lt;topology&gt;</span>
            <span class="nt">&lt;cells</span> <span class="na">num=</span><span class="s">'1'</span><span class="nt">&gt;</span>
                <span class="nt">&lt;cell</span> <span class="na">id=</span><span class="s">'0'</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;cpus</span> <span class="na">num=</span><span class="s">'2'</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;cpu</span> <span class="na">id=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;cpu</span> <span class="na">id=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/cpus&gt;</span>
                <span class="nt">&lt;/cell&gt;</span>
      <span class="nt">&lt;/cells&gt;</span>
        <span class="nt">&lt;/topology&gt;</span>
        …
    <span class="nt">&lt;/host&gt;</span>
    …
<span class="nt">&lt;/capabilities&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>I-1.2 Seek the host NUMA nodes memory information by using <code class="language-plaintext highlighter-rouge">getMemoryStats</code> API in libvirt, the below is the data format of API returned value
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="err">total:</span><span class="w"> </span><span class="err">int</span><span class="p">,</span><span class="w"> </span><span class="err">free:</span><span class="w"> </span><span class="err">int</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>I-1.5 Create a new function <code class="language-plaintext highlighter-rouge">appendNumaTune</code> in VDSM vm module to write the VM numatune configuration into libvirt domain xml follow the below format
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;domain&gt;</span>
    ...
    <span class="nt">&lt;numatune&gt;</span>
        <span class="nt">&lt;memory</span> <span class="na">mode=</span><span class="s">'interleave'</span> <span class="na">nodeset=</span><span class="s">'0-1'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/numatune&gt;</span>
    …
<span class="nt">&lt;/domain&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>I-1.6 Modify function <code class="language-plaintext highlighter-rouge">appendCpu</code> in VDSM vm module to write the VM virtual NUMA topology configuration into libvirt domain xml follow the below format
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;cpu&gt;</span>
    ...
    <span class="nt">&lt;numa&gt;</span>
      <span class="nt">&lt;cell</span> <span class="na">cpus=</span><span class="s">'0-7'</span> <span class="na">memory=</span><span class="s">'10485760'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;cell</span> <span class="na">cpus=</span><span class="s">'8-15'</span> <span class="na">memory=</span><span class="s">'10485760'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/numa&gt;</span>
    ...
<span class="nt">&lt;/cpu&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="interface-between-vdsm-and-host">Interface between VDSM and Host</h3>

<ol>
  <li>I-1.3 Statistics data of each host CPU core which include %usr (%usr+%nice), %sys and %idle.</li>
  <li>I-1.4 Data structure to be provided to MOM component</li>
  <li>I-1.7 NUMA distances capture from command</li>
  <li>I-1.8 Automatic NUMA balancing on host</li>
</ol>

<ul>
  <li>I-1.3 Sampling host CPU statistics data in <code class="language-plaintext highlighter-rouge">/proc/stat</code>, the whole data format is showing as below. We will use column 1 to 5 which include user,
system, nice and idle CPU handlers to calculate CPU statistics data in engine side
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /proc/stat
<span class="go">cpu  268492078 16093 132943706 6545294629 19023496 898 138160 0 57789592
cpu0 62042038 3012 52198814 1638619972 2438624 4 12068 0 16721375
cpu1 62779520 2733 25830756 1647361083 6001324 1 34617 0 16341547
cpu2 77892630 5788 32963856 1610093241 8367287 889 80447 0 8205583
cpu3 65777888 4559 21950279 1649220333 2216260 4 11027 0 16521086
</span></code></pre></div>    </div>
  </li>
  <li>I-1.4 Data structure that provided to MOM component</li>
</ul>

<p>MOM use the VDSM HypervisorInterface using <code class="language-plaintext highlighter-rouge">API.py</code> <code class="language-plaintext highlighter-rouge">Global.getCapabilities</code> function to get host NUMA topology data</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s">'autoNumaBalancing'</span><span class="p">:</span> <span class="nb">int</span>
    <span class="s">'numaNodeDistance'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">...}</span>
    <span class="s">'numaNodes'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'cpus'</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s">'totalMemory'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
</code></pre></div></div>

<p>using <code class="language-plaintext highlighter-rouge">API.py</code> <code class="language-plaintext highlighter-rouge">Global.getStats</code> function to get host NUMA statistics data</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s">'numaNodeMemFree'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'memFree'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'memPercent'</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
    <span class="s">'cpuStatistics'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;cpuId&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'nodeIndex'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'cpuSys'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'cpuIdle'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'cpuUser'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>I-1.7 libivirt API do not support to get NUMA distances information, so we use command <code class="language-plaintext highlighter-rouge">numactl</code> to get the distances information
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>numactl <span class="nt">-H</span>
<span class="go">node distances:
node   0   1
  0:  10  20
  1:  20  10
</span></code></pre></div>    </div>
  </li>
  <li>I-1.8 In kernels who having Automatic NUMA balancing feature, use command <code class="language-plaintext highlighter-rouge">sysctl -a |grep numa_balancing</code> to check the Automatic NUMA balancing value is turn on or off
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>sysctl <span class="nt">-a</span> | <span class="nb">grep </span>numa_balancing
<span class="go">kernel.numa_balancing = 1
</span></code></pre></div>    </div>
  </li>
</ul>

<h3 id="interface-between-vdsm-and-engine-core">Interface between VDSM and engine core</h3>

<ol>
  <li>I-2.1 Report host support automatic NUMA balancing situation, NUMA node distances, NUMA nodes information, include NUMA node index, cpu ids and total memory, from VDSM to engine core</li>
  <li>I-2.2 Report host NUMA nodes memory information (free memory and used memory percentage) and each cpu statistics (system, idle, user cpu percentage) from VDSM to engine core</li>
  <li>I-2.3 Configuration of set VM’s numatune and virtual NUMA topology from engine core to VDSM</li>
</ol>

<ul>
  <li>I-2.1 Transfer data format of host NUMA nodes information
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'autoNumaBalancing'</span><span class="p">:</span> <span class="nb">int</span>
<span class="s">'numaDistances'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="p">...}</span>
<span class="s">'numaNodes'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'cpus'</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s">'totalMemory'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>I-2.2 Transfer data format of host CPU statistics and NUMA nodes memory information
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'numaNodeMemFree'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;nodeIndex&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'memFree'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'memPercent'</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
<span class="s">'cpuStatistics'</span><span class="p">:</span> <span class="p">{</span><span class="s">'&lt;cpuId&gt;'</span><span class="p">:</span> <span class="p">{</span><span class="s">'numaNodeIndex'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'cpuSys'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'cpuIdle'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'cpuUser'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="err">…</span><span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>I-2.3 Transfer data format of set VM numatune and virtual NUMA topology
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'numaTune'</span><span class="p">:</span> <span class="p">{</span><span class="s">'mode'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'nodeset'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">}</span>
<span class="s">'guestNumaNodes'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'cpus'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">,</span> <span class="s">'memory'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="err">…</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="interface-between-engine-core-and-database-schema">Interface between engine core and database (schema)</h3>

<ol>
  <li>I-3.1 Schema modification of <code class="language-plaintext highlighter-rouge">vds_dynamic</code> table to include host’s NUMA node count and automatic NUMA balancing status.</li>
  <li>I-3.2 Add table <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code> to include host cpu statistics information (system, user, idle cpu time and used cpu percentage).</li>
  <li>I-3.3 Schema modification of <code class="language-plaintext highlighter-rouge">vm_static</code> table to include numatune mode configuration and virtual NUMA node count.</li>
  <li>I-3.4 Add table <code class="language-plaintext highlighter-rouge">numa_node</code> to include host/vm NUMA node information (node index, total memory, cpu count of each node)
and statistics information (system, user, idle cpu time, used cpu percentage, free memory and used memory percentage).</li>
  <li>I-3.5 Add table <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code> to include the configuration of vm virtual NUMA nodes pinning to host NUMA nodes
   (this is a nested relationship table, store the map relations between vm NUMA nodes and host NUMA nodes which are all in table numa_node).</li>
  <li>I-3.6 Add table <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code> to include the cpu information that each host/vm NUMA node contains.</li>
  <li>I-3.7 Add table <code class="language-plaintext highlighter-rouge">numa_node_distance</code> to include the distance information between the NUMA nodes.</li>
</ol>

<p>The above interfaces are defined with database design diagram <img src="/ovirt-site/previews/3196/images/wiki/Database_design_diagram.png" alt="" /></p>

<ul>
  <li>Related database scripts change:
    <ol>
      <li>Add <code class="language-plaintext highlighter-rouge">numa_sp.sql</code> to include the store procedures which handle the operations in
table <code class="language-plaintext highlighter-rouge">numa_node</code>, <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code>, <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code> and <code class="language-plaintext highlighter-rouge">numa_node_distance</code>. It will provide the store procedures to insert, update and delete data and kinds of query functions.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">vds_sp.sql</code> to add some store procedures which handle the operations in table <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code>, including insert, update, delete and kinds of query functions.</li>
      <li>Modify the function of <code class="language-plaintext highlighter-rouge">InsertVdsDynamic</code>, <code class="language-plaintext highlighter-rouge">UpdateVdsDynamic</code> in <code class="language-plaintext highlighter-rouge">vds_sp.sql</code> to add new columns <code class="language-plaintext highlighter-rouge">auto_numa_banlancing</code> and <code class="language-plaintext highlighter-rouge">vds_numa_node_count</code>.</li>
      <li>Modify the function of <code class="language-plaintext highlighter-rouge">InsertVmStatic</code>, <code class="language-plaintext highlighter-rouge">UpdateVmStatic</code> in <code class="language-plaintext highlighter-rouge">vms_sp.sql</code> to add two new columns <code class="language-plaintext highlighter-rouge">numatune_mode</code> and <code class="language-plaintext highlighter-rouge">vm_numa_node_count</code>.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">create_views.sql</code> to add new columns <code class="language-plaintext highlighter-rouge">numatune_mode</code> and <code class="language-plaintext highlighter-rouge">vm_numa_node_count</code> in view <code class="language-plaintext highlighter-rouge">vms</code> and <code class="language-plaintext highlighter-rouge">vms_with_tags</code>;
add new columns <code class="language-plaintext highlighter-rouge">auto_numa_banlancing</code> and <code class="language-plaintext highlighter-rouge">vds_numa_node_count</code> in view <code class="language-plaintext highlighter-rouge">vds</code> and <code class="language-plaintext highlighter-rouge">vds_with_tags</code>.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">create_views.sql</code> to add new views, including view <code class="language-plaintext highlighter-rouge">vds_numa_node_view</code> which joins <code class="language-plaintext highlighter-rouge">vds_dynamic</code> and <code class="language-plaintext highlighter-rouge">numa_node</code>; view <code class="language-plaintext highlighter-rouge">vm_numa_node_view</code> which joins <code class="language-plaintext highlighter-rouge">vm_static</code> and <code class="language-plaintext highlighter-rouge">numa_node</code>.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">upgrade/post_upgrade/0010_add_object_column_white_list_table.sql</code> to add new columns <code class="language-plaintext highlighter-rouge">auto_numa_banlancing</code> and <code class="language-plaintext highlighter-rouge">vds_numa_node_count</code>.</li>
      <li>Add one script under <code class="language-plaintext highlighter-rouge">upgrade/</code> to create tables - <code class="language-plaintext highlighter-rouge">numa_node</code>, <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code>, <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code>, <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code>, <code class="language-plaintext highlighter-rouge">numa_node_distance</code>
and add columns in table <code class="language-plaintext highlighter-rouge">vds_dynamic</code> and <code class="language-plaintext highlighter-rouge">vm_static</code>.</li>
      <li>Create the following indexes:
        <ul>
          <li>Index on column <code class="language-plaintext highlighter-rouge">vm_or_vds_guid</code> of table <code class="language-plaintext highlighter-rouge">numa_node</code></li>
          <li>Index on column <code class="language-plaintext highlighter-rouge">vds_id</code> of table <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code></li>
          <li>Index on column <code class="language-plaintext highlighter-rouge">numa_node_id</code> of table <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code></li>
          <li>Index on column <code class="language-plaintext highlighter-rouge">numa_node_id</code> of table <code class="language-plaintext highlighter-rouge">numa_node_distance</code></li>
          <li>Indexes on each of the columns <code class="language-plaintext highlighter-rouge">vm_numa_node_id</code> and <code class="language-plaintext highlighter-rouge">vds_numa_node_id</code> of table <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code></li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Related DAO change:
    <ol>
      <li>Add <code class="language-plaintext highlighter-rouge">NumaNodeDAO</code> and related implemention to provide data save, update, delete and kinds of queries in
table <code class="language-plaintext highlighter-rouge">numa_node</code>, <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code>, <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code> and <code class="language-plaintext highlighter-rouge">numa_node_distance</code>. Add <code class="language-plaintext highlighter-rouge">NumaNodeDAOTest</code> for <code class="language-plaintext highlighter-rouge">NumaNodeDAO</code> meanwhile.</li>
      <li>Add <code class="language-plaintext highlighter-rouge">VdsCpuStatisticsDao</code> and related implementation to provide data save, update, delete and kinds of queries
in table <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code>. Add <code class="language-plaintext highlighter-rouge">VdsCpuStatisticsDAOTest</code> for <code class="language-plaintext highlighter-rouge">VdsCpuStatisticsDAO</code> meanwhile.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">VdsDynamicDAODbFacadeImpl</code> and <code class="language-plaintext highlighter-rouge">VdsDAODbFacadeImpl</code> to add the map of new 
columns <code class="language-plaintext highlighter-rouge">auto_numa_banlancing</code> and <code class="language-plaintext highlighter-rouge">vds_numa_node_count</code>. Run <code class="language-plaintext highlighter-rouge">VdsDynamicDAOTest</code> to verify the modification.</li>
      <li>Modify <code class="language-plaintext highlighter-rouge">VmStaticDAODbFacadeImpl</code> and <code class="language-plaintext highlighter-rouge">VmDAODbFacadeImpl</code> to add the map of new columns <code class="language-plaintext highlighter-rouge">numatune_mode</code> and <code class="language-plaintext highlighter-rouge">numa_node_count</code>. Run <code class="language-plaintext highlighter-rouge">VmStaticDAOTest</code> to verify the modification.</li>
    </ol>
  </li>
  <li>Related search engine change</li>
</ul>

<p>Currently, we plan to provide below search functions about NUMA feature, each field support the numeric relation of “&gt;”, “&lt;”, “&gt;=”, “&lt;=”, “=”, “!=”.</p>

<ol>
  <li>Search hosts with the below NUMA related fields:
    <ul>
      <li>NUMA node number</li>
      <li>NUMA node cpu count</li>
      <li>NUMA node total memory</li>
      <li>NUMA node memory usage</li>
      <li>NUMA node cpu usage</li>
    </ul>
  </li>
  <li>Search vms with the below NUMA related fields:
    <ul>
      <li>NUMA tune mode</li>
      <li>Virtual NUMA node number</li>
      <li>Virtual NUMA node vcpu count</li>
      <li>Virtual NUMA node total memory</li>
    </ul>
  </li>
</ol>

<p>NUMA tune mode support enum value relation, the others support the numeric relation.</p>

<p>We will do the following modifications:</p>

<ol>
  <li>Modify <code class="language-plaintext highlighter-rouge">org.ovirt.engine.core.searchbackend.SearchObjects</code> to add new entry NUMANODES.</li>
  <li>Add <code class="language-plaintext highlighter-rouge">org.ovirt.engine.core.searchbackend.NumaNodeConditionFieldAutoCompleter</code> to provide NUMA node related filters auto completion;</li>
  <li>Modify <code class="language-plaintext highlighter-rouge">org.ovirt.engine.core.searchbackend.SearchObjectAutoCompleter</code> to add new joins, one is HOST joins NUMANODES on vds_id, the other is VM joins NUMANODES on vm_guid.</li>
  <li>Add new entries in entitySearchInfo accordingly. NUMANODES will use new added view vds_numa_node_view and view vm_numa_node_view.</li>
  <li>Modify <code class="language-plaintext highlighter-rouge">org.ovirt.engine.core.searchbackend.VdsCrossRefAutoCompleter</code> to add auto complete entry NUMANODES.</li>
</ol>

<ul>
  <li>Cascade-delete
    <ol>
      <li>When user remove a virtual NUMA node, the related rows in table <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code>, <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code>, <code class="language-plaintext highlighter-rouge">numa_node_distance</code>
(maybe in future, currently no distance information for virtual NUMA node) and <code class="language-plaintext highlighter-rouge">numa_node</code> should be removed meanwhile.</li>
      <li>When user remove a vm, all the virtual NUMA nodes of this vm should be removed, follow above item to do the cascade-delete.</li>
      <li>When user remove a host, the related rows in table <code class="language-plaintext highlighter-rouge">numa_node_cpu_map</code>, <code class="language-plaintext highlighter-rouge">vm_vds_numa_node_map</code>, <code class="language-plaintext highlighter-rouge">numa_node_distance</code>, <code class="language-plaintext highlighter-rouge">numa_node</code> and <code class="language-plaintext highlighter-rouge">vds_cpu_statistics</code> should be removed meanwhile.</li>
    </ol>
  </li>
</ul>

<h3 id="interface-and-data-structure-in-engine-core">Interface and data structure in engine core</h3>

<p><img src="/ovirt-site/previews/3196/images/wiki/ARCH_Class_Diagram.png" alt="" /></p>

<ul>
  <li>Entities
    <ul>
      <li><code class="language-plaintext highlighter-rouge">VDS</code> has many <code class="language-plaintext highlighter-rouge">VdsNumaNode</code> objects in dynamic data (collect from vds capatibility)</li>
      <li><code class="language-plaintext highlighter-rouge">VdsNumaNode</code> is core entity for host NUMA topology, it links one statistics object <code class="language-plaintext highlighter-rouge">VdsNumaNodeStatistics</code> which contains some real-time data (free memory, NUMA node cpu usage etc.)</li>
      <li><code class="language-plaintext highlighter-rouge">VM</code> has many <code class="language-plaintext highlighter-rouge">VmNumaNode</code> object in dynamic data (configured by user)</li>
      <li><code class="language-plaintext highlighter-rouge">VmNumaNode</code> is core entity for VM NUMA topology.</li>
      <li><code class="language-plaintext highlighter-rouge">NumaTuneMode</code> is the memory tune mode (configured by user).</li>
      <li><code class="language-plaintext highlighter-rouge">VdsNumaNode</code> has one-to-many relationship with <code class="language-plaintext highlighter-rouge">VmNumaNode</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">VdsNumaNode.cpuIds</code> links with <code class="language-plaintext highlighter-rouge">CpuStatistics.cpuId</code> to take a look inside NUMA node each CPU usage</li>
    </ul>
  </li>
  <li>Action &amp; Query
    <ul>
      <li><code class="language-plaintext highlighter-rouge">GetVdsNumaNodeByVdsId, GetVmNumaNodeByVmId, GetVmNumaNodeByVdsNumaNodeId, GetCpuStatsByVdsId</code> use same parameters <code class="language-plaintext highlighter-rouge">IdQueryParameters</code></li>
      <li><code class="language-plaintext highlighter-rouge">AddVmNumaNode, UpdateVmNuamNode, RemoveVmNuamNode</code> use same parameters <code class="language-plaintext highlighter-rouge">VmNumaNodeParameters</code> to manage Virtual NUMA node in VM</li>
      <li><code class="language-plaintext highlighter-rouge">SetNumaTuneMode</code> use parameters <code class="language-plaintext highlighter-rouge">NumaTuneModeParameters</code> to set the NUMA tuning mode for VM</li>
      <li><code class="language-plaintext highlighter-rouge">GetVdsNumaNodeByVdsId</code> will return <code class="language-plaintext highlighter-rouge">List&lt;VdsNumaNode&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">GetVmNumaNodeByVmId, GetVmNumaNodeByVdsNumaNodeId</code> will return <code class="language-plaintext highlighter-rouge">List&lt;VmNumaNode&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">GetVmNumaNodeByVdsNumaNodeId</code> will query the <code class="language-plaintext highlighter-rouge">VmNumaNode</code>s under the <code class="language-plaintext highlighter-rouge">VdsNumaNode</code></li>
      <li><code class="language-plaintext highlighter-rouge">GetCpuStatsByVdsId</code> will return <code class="language-plaintext highlighter-rouge">List&lt;CpuStatistics&gt;</code></li>
      <li>When <code class="language-plaintext highlighter-rouge">VmNumaNodeParameters.vdsNumaNodeId</code> is set to null, the <code class="language-plaintext highlighter-rouge">VmNumaNode</code> is unsigned.</li>
    </ul>
  </li>
</ul>

<h3 id="interface-and-data-structure-in-ovirt-scheduler">Interface and data structure in ovirt scheduler</h3>

<p>Add NUMA filter and weight module to oVirt’s scheduler, and add those to all cluster policies (inc. user defined).</p>

<ul>
  <li>NUMA Filter
    <ul>
      <li>Fetches the (scheduled) VM virutal NUMA nodes.</li>
      <li>Fetches all virtual NUMA nodes topology ( CPU count, total memory ).</li>
      <li>Fetches all hosts NUMA nodes topology ( CPU count, total memory ).</li>
      <li>Remove all hosts that doesn’t meet the matched NUMA nodes topology
        <ul>
          <li>for positive, host NUMA node’s CPU count &gt; virtual NUMA node’s CPU count</li>
          <li>for positive, host NUMA node’s total memory &gt; virtual NUMA node’s total memory</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>NUMA Weight Module
    <ul>
      <li>Fetches the (scheduled) VM virutal NUMA nodes.</li>
      <li>Fetches all virtual NUMA nodes topology ( CPU count, total memory, NUMA distance ).</li>
      <li>Fetches all hosts NUMA nodes topology and statistics ( CPU usage, free memory ).</li>
      <li>Score the hosts according to each NUMA nodes score
        <ul>
          <li>for positive, in case a VM of the group is running on a certain host, give all other hosts a higher weight.</li>
          <li>for positive, give the host higher weight if the host NUMA node’s CPU usage use up.</li>
          <li>for positive, give the host higher weight if the host NUMA node’s memory use up.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Scheduler generate virtual NUMA topology To be continue …</p>

<h3 id="interface-and-data-structure-in-restful-api">Interface and data structure in restful API</h3>

<p>host NUMA sub-collection</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/hosts/{host:id}/numanodes/
</code></pre></div></div>

<ul>
  <li>Supported actions - <strong>GET</strong> returns a list of host NUMA nodes. (using query GetVdsNumaNodeByVdsId)</li>
</ul>

<p>host NUMA resource</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/hosts/{host:id}/numanodes/{numa:id}
</code></pre></div></div>

<ul>
  <li>Supported actions
    <ul>
      <li><strong>GET</strong> returns a specific NUMA node information: CPU list, total memory, map of distance with other nodes. (using VdsNumaNode properties)</li>
    </ul>
  </li>
</ul>

<p>host NUMA statistics</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/hosts/{host:id}/numanodes/{numa:id}/statistics
</code></pre></div></div>

<ul>
  <li>Supported actions
    <ul>
      <li><strong>GET</strong> returns a specific NUMA node statistics data: CPU usage, free memory. (using VdsNumaNode property NumaNodeStatistics)</li>
    </ul>
  </li>
</ul>

<p>vm virtual NUMA sub-collection</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/vms/{vm:id}/numanodes
</code></pre></div></div>

<ul>
  <li>Supported actions:
    <ul>
      <li><strong>GET</strong> returns a list of VM virtual NUMA nodes. (using query GetVmNumaNodeByVmId)</li>
      <li><strong>POST</strong> attach a new virtual NUMA node on VM. (using action AddVmNumaNode)</li>
    </ul>
  </li>
</ul>

<p>vm virtual NUMA resource</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/vms/{vm:id}/numanodes/{vnuma:id}
</code></pre></div></div>

<ul>
  <li>Supported actions:
    <ul>
      <li><strong>GET</strong> returns a specific virtual NUMA node information, CPU list, total memory, pin to host NUMA nodes. (using VmNumaNode properties)</li>
      <li><em>*PUT</em> a virtual NUMA node configured on the VM. (using action UpdateVmNumaNode)</li>
      <li><strong>DELETE</strong> removes a virtual NUMA node from the VM. (using action DeleteVmNumaNode)</li>
    </ul>
  </li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3196/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3196/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3196/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3196/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2025 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/detailed-numa-and-virtual-numa.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/detailed-numa-and-virtual-numa.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
