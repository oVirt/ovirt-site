<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Engine Command changes | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Engine Command changes" />
<meta name="author" content="Oved Ourfali" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2998/develop/release-management/features/infra/engine-command-changes.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2998/develop/release-management/features/infra/engine-command-changes.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Engine Command changes" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Oved Ourfali" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Oved Ourfali"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Engine Command changes","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2998/images/logo.svg"},"name":"Oved Ourfali"},"url":"https://ovirt.github.io/ovirt-site/previews/2998/develop/release-management/features/infra/engine-command-changes.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2998/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2998/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2998/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2998/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2998/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2998/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2998/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2998/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2998/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2998/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2998/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2998/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2998/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2998/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2998/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2998/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2998/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2998/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2998/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2998/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2998/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2998/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2998//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2998//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2998/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2998/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2998/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2998/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2998/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Oved Ourfali">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d65e24c0cf95ea2c32dc764429b6310a?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d65e24c0cf95ea2c32dc764429b6310a?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ravi Nori">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ravi Nori</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Yair Zaslavsky">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yair Zaslavsky</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2998/documentation/'>Documentation is available here.</a></div>

<h1 id="engine-commands-infrastructure-changes-for-35">Engine commands infrastructure changes for 3.5</h1>

<h2 id="context-changes">Context changes</h2>

<p>Version 3.5 introduced the usage of engine session ID through all over the engine flows.</p>

<p>Instead of holding the session ID on thread local, The commandContext object is used in order to propgate context through engine flow, including the engine session Id.</p>

<p>EngineContext is introduced In addition to the Lock , Execution context and compensation context that existed in version 3.4 .</p>

<p>EngineContext is a context that should exist throughout the engine flow , currently holding the engineSessionId.</p>

<p>In order to invoke an internal command, and pass the context of the calling command, one past perform the following steps:</p>

<ol>
  <li>Add a CTOR to the internal command, cotaning the “CommandContext commandContext” argument as the last argument.</li>
</ol>

<p>For example:
 public CreateSnapshotCommand(T parameters, CommandContext cmdContext) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                super(parameters, cmdContext);      
                setSnapshotName(parameters.getDescription());
        }
</code></pre></div></div>

<ol>
  <li>
    <p>From commands, instead of using getBackend().runInternalAction or Backend.getInstance().runInternalAction use</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     runInternalAction           This method was introduced at CommandBase, and is responsible for propagating the context.
</code></pre></div>    </div>
  </li>
</ol>

<p>For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>             VdcReturnValueBase returnValue = runInternalAction(VdcActionType.HotPlugDiskToVm, params);       
</code></pre></div></div>

<ol>
  <li>
    <p>Invoke internal commands properly from classes that are not commands In case a command is using a helper (a class that does not extend CommandBase, and usually holds some functionality that is shared for several commands who are not of the same inheritance sub tree) , or another class which is not a command - the syntax of</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          Backend.getInstance().runInternalAction(...) should be used. 
</code></pre></div>    </div>
  </li>
</ol>

<p>In this case, the caller might or might not pass the command context as a parameter to the call.</p>

<p>If command context is not passed, the Command class should have a CTOR without a command context.</p>

<p>If command context is passed, the Command class should have a CTOR with a command context.</p>

<p>For example: LiveSnapshotTaskHandler.execute invokes an internal action:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    VdcReturnValueBase vdcReturnValue =
                     Backend.getInstance().runInternalAction(VdcActionType.CreateAllSnapshotsFromVm,
                     getCreateSnapshotParameters(),
                     ExecutionHandler.createInternalJobContext());
</code></pre></div></div>

<p>The CTOR of the internal action is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     public CreateAllSnapshotsFromVmCommand(T parameters, CommandContext commandContext) {
         super(parameters, commandContext);
         //....
     }
</code></pre></div></div>

<ol>
  <li>Handle command context propagation</li>
</ol>

<p>In order to properly propagate context , the command context should be duplicated when calling a command.</p>

<p>This can be done either by using the clone method of the CommandContext object, or by calling CommandBase.cloneContext which will return a clone of the calling command’s context.</p>

<p>In some cases, we may want to alter fields of the duplicated context - for example, reset the compensation context (so the internal command will create its own compensation context).</p>

<p>In order to perform this, the following withXXX and withoutXXX methods were introduced to commandContext - withLock(EngineLock), withExecutionContext(ExecutionContext), withCompensationContext(CompensationContext), withEngineContext(EngineContext),</p>

<p>withoutLock(), withoutExecutionCOntext(, withoutCompensationContext()</p>

<p>for example -</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     cloneContext().withExecutionContext(runVmContext).withoutLock().withoutCompensationContext());
</code></pre></div></div>

<p>will clone the context, , set on it the runVM execution context, and reset both the lock and the compensation context.</p>

<p>It is also possible to use the CommandBase.cloneContextAndDetachFromParent in order to perform context cloning and “detach” from all the detachable components of the context which are the lock , the execution context and the compensation context.</p>

<p>In the case a command context should be duplicated and should have an execution context for tasks monitoring it is possible to use the method CommandBase.runInternalActionWithTasksContext</p>

<ol>
  <li>Propagate engine context to queries</li>
</ol>

<p>Similar to command context propgation it is required to propagate the engine context to internal queries.</p>

<p>CommandBase.runInternalQuery and QueriesCommandBase.runInternalQuery were introruced and can be used to run an internal query with the engine context associated with the current context.</p>

<p>Internal queries that are invoked using these methods should have a CTOR with engine context. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      runInternalQuery(VdcQueryType.GetAllFromExportDomain, params);
</code></pre></div></div>

<p>and</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      public GetAllFromExportDomainQuery(P parameters, EngineContext engineContext) {
            super(parameters, engineContext);
       }
</code></pre></div></div>

<h2 id="lock-mechanism-changes">Lock Mechanism changes</h2>

<p>In 3.5 the attribute LockIdNameAttribute has been removed and commands that need exclusive locking need to override a method defined in CommandBase. By default the lock scope has been set to none and the wait is set to false as shown below</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     @Override
     protected LockProperties applyLockProperties(LockProperties lockProperties) {
         return lockProperties.withScope(Scope.None).withWait(false);
     }
</code></pre></div></div>

<p>Any command that needs a different locking mechanism needs to override the above method to set the appropriate properties on the LockProperties object. Below is an example of the method overridden in a command that extends CommandBase. In the example the scope has been set to Execution, so the lock is released at the end of command execution. The code is equivalent to what was achieved using the annotation @LockIdNameAttribute.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     @Override
     protected LockProperties applyLockProperties(LockProperties lockProperties) {
         return lockProperties.withScope(Scope.Execution);
     }
</code></pre></div></div>

<p>The scope defines when lock is released.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     public static enum Scope {
         /**
          * Lock is release at the end of the command execution
          */
         Execution,
         /**
          * Lock is not release at the of command execution, used when
          * child command uses the lock of the parent. Child should
          * not release the lock, the parent will take care of releasing
          * the lock
          */
         Command,
         /**
          * No lock is required for the command execution
          */
         None
     }
</code></pre></div></div>

<p>To obtain a lock with wait in 3.4 the command had to be annotated with @LockIdNameAttribute(isWait = true). In 3.5 the same can be achieved by calling the withWait method on the lock properties</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     @Override
     protected LockProperties applyLockProperties(LockProperties lockProperties) {
         return lockProperties.withScope(Scope.Execution).withWait(true);
     }
</code></pre></div></div>

<p>When a child command uses the lock passed by the parent and does not release the lock, the scope “Command” is used to specify the scope of the lock.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     @Override
     protected LockProperties applyLockProperties(LockProperties lockProperties) {
         return lockProperties.withScope(Scope.Command);
     }
</code></pre></div></div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2998/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2998/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2998/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2998/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/engine-command-changes.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/infra/engine-command-changes.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
