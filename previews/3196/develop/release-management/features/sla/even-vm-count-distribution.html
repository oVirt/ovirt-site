<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Even VM Count Distribution | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Even VM Count Distribution" />
<meta name="author" content="Doron Fediuck" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/even-vm-count-distribution.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/even-vm-count-distribution.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Even VM Count Distribution" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Doron Fediuck" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Doron Fediuck"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Even VM Count Distribution","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3196/images/logo.svg"},"name":"Doron Fediuck"},"url":"https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/sla/even-vm-count-distribution.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3196/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3196/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3196/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3196/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3196/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3196/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3196/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3196/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3196/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Doron Fediuck">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Doron Fediuck</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d0a3e7930e20f7be44c787b4d3afd976?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d0a3e7930e20f7be44c787b4d3afd976?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Jiří Moskovčák">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Jiří Moskovčák</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3196/documentation/'>Documentation is available here.</a></div>

<h1 id="even-vm-distribution-based-on-vm-count-per-host">Even VM distribution based on VM count per host</h1>

<h2 id="summary">Summary</h2>

<p>The goal of this feature is to provide a cluster policy that evenly distributes VMs based on VM count.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Martin Sivak (msivak)</li>
  <li>Email: msivak@redhat.com</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Last updated: 4-Jan-2017</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<ul>
  <li><strong>HighVMSCount</strong> - Maximum VM limit. Exceeding it qualifies the host as overloaded.</li>
  <li><strong>MigrationThreshold</strong> - defines a buffer before we start migrating VMs from the host</li>
  <li><strong>SPMVMCountGrace</strong> - defines how many slots for VMs should be reserved on SPM hosts (the SPM host should have less load than others, so this variable defines how many VM less it should have)</li>
</ul>

<p>The cluster is considered unbalanced if there is VDS with more than HighVMSCount VMs running on it AND there is at least one VDS with more then MigrationThreshold less VMs</p>

<p><strong>Unbalanced cluster</strong></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Balancing-before.png" alt="Unbalanced cluster" /></p>

<p><strong>Cluster after 1 balancing iteration</strong></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Balancing-after1iter.png" alt="" /></p>

<p><strong>Cluster after 2 balancing iterations</strong></p>

<p><img src="/ovirt-site/previews/3196/images/wiki/Balancing-after2iter.png" alt="" /></p>

<h3 id="1-iteration">1. iteration</h3>

<ol>
  <li>VM1 moved from VDS1 to VDS3 (to make the example simple, there is no special logic involved in selecting the VDS, so even though VDS5 is also a good target we simply take whatever comes first, but the target VDS should and will be selected by the scoring mechanism based on the count of running VMs on the VDS)</li>
  <li>The MigrationThreshold top moved from 12 to 11 and minimum is now 7</li>
</ol>

<h3 id="2-iteration">2. iteration</h3>

<ol>
  <li>VM2 moved to VDS5 (the only possible target, because it’s the only one outside of the balancing window)</li>
  <li>The MigrationThreshold top moved from 11 to 10 and the minimum is now 6 which means the cluster is balanced because every VDS has VM count inside the MigrationThreshold</li>
</ol>

<p>The cluster from this example is balanced after the 2nd iteration. The final VM distribution is shown on img “Cluster after 2 balancing iterations”.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>This feature comes from customer request, so benefit to ovirt is a better customer satisfaction ;)</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<ul>
  <li>NONE</li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<p>pseudo (python) code for the balance() method</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getOccupiedVMSlots(VDS):
   occupiedVMSlots = VDS.activeVMSCount()
   if VDS.isSPM():
      occupiedVMSlots = occupiedVMSlots + SPMVMCountGrace

getBestVmToMigrate(VMS):  # just select the VM with the least CPU usage
  bestVMToMigrate = VMS[0]
  for vm in VMS:
    if vm.cpuUsage() &lt; bestVMToMigrate.cpuUsage():
      bestVMToMigrate = vm

  return bestVMToMigrate

getOverloadedVDS():
  worstVDS = None
  for vds in allVDS:
    if getOccupiedVMSlots(vds) &gt; HighVMSCount AND worstVDS == None OR getOccupiedVMSlots(vds) &gt; getOccupiedVMSlots(worstVDS)):
      worstVDS = vds

  return  worstVDS  # returns None (null) if no VDS has above HighVMSCount running vms

balance():
  worstVDS = getOverloadedVDS()
  if worstVDS == None:  # nothing to balance
     return None

  possibleTargets = []
  for vds in allVDS:
     if (getOccupiedVMSlots(worstVDS) - getOccupiedVMSlots(vds)) &gt;= MigrationThreshold:
        possibleTargets.add(vds)

  vmToMigrate = getBestVmToMigrate(worstVDS.getAllRunningVMS())
  return (possibleTargets, vmToMigrate)
</code></pre></div></div>

<p><a href="http://jmoskovc.fedorapeople.org/even_vm_distribution.py">Algorithm simulation in python</a></p>

<h2 id="testing">Testing</h2>

<ul>
  <li>TBD</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3196/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3196/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3196/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3196/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2025 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/even-vm-count-distribution.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/even-vm-count-distribution.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
