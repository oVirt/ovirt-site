<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AsyncTaskManagerChanges 3.3Detailed | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="AsyncTaskManagerChanges 3.3Detailed" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3019/develop/release-management/features/infra/asynctaskmanagerchanges-3.3detailed.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3019/develop/release-management/features/infra/asynctaskmanagerchanges-3.3detailed.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AsyncTaskManagerChanges 3.3Detailed" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"AsyncTaskManagerChanges 3.3Detailed","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3019/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3019/develop/release-management/features/infra/asynctaskmanagerchanges-3.3detailed.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3019/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3019/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3019/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3019/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3019/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3019/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3019/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3019/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3019/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3019/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3019/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3019/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3019/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3019/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3019/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3019/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3019/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3019/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3019/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3019/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3019/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3019/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3019//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3019//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3019/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3019/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3019/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3019/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3019/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d65e24c0cf95ea2c32dc764429b6310a?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d65e24c0cf95ea2c32dc764429b6310a?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ravi Nori">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ravi Nori</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3019/documentation/'>Documentation is available here.</a></div>

<h1 id="asynctaskmanagerchanges-33detailed">AsyncTaskManagerChanges 3.3Detailed</h1>

<h2 id="details-of-aysnc-task-manager-changes">Details of Aysnc Task Manager Changes</h2>

<h3 id="persists-task-place-holder-before-submitting-task-to-vdsm">Persists Task Place Holder Before Submitting Task to VDSM</h3>

<p>One of the issues addressed in these changes is the ability to fail a command if the server has been restarted during the execution of the command. In order for the server to determine that the task has been partially executed and needs to be failed, we need to determine the number of child tasks that need to be execute. This change inserts place holders in to the database table async_tasks for all child tasks of a command in a single transaction. The task id for each place holder is generated on the engine. Once the job has been submitted to the vdsm, the place holder is updated with the vdsm taskid. If the server is restarted during the execution of the command, on server restart we fail all commands that have place holders in the database with out a vdsm task id.</p>

<p>In order to achive this a few changes have been made to the under lying code in the engine.</p>

<h4 id="instantiate-and-execute-command-internally-rather-than-through-backend">Instantiate and execute command internally rather than through Backend</h4>

<p>In the current implementation we have been executing child commands using Backend.runInternalAction, which creates the command using reflection and executes it. But inorder for the command to call a method to insert place holders for the child command a command needs to instantiate the child command and call methods on it.</p>

<h4 id="changes-to-commandbase">Changes to CommandBase</h4>

<p>A few methods have been added to CommandBase, these methods will only be called from with in a command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /**
     * Checks to see if the command can be execute and sets a global flag
     */
     protected void checkCanDoAction()

   /**
     * This method is called before executeAction and after checkCanDoAction
     * to insert the async task place holders for the child commands.
     */
    protected void insertAsyncTaskPlaceHolders()

    /**
      * Commands can override this method to build a map of all child commands.
      * Called from insertAsyncTaskPlaceHolders to build a list of all child
      * commands and insert async task place holders for them
      * @return
      */
     protected Map`&lt;Guid, CommandBase&lt;?&gt;`&gt; buildChildCommands()

     /**
      * Called to construct the child command.
      * @param actionType
      * @param parameters
      * @param runAsInternal
      * @param context
      * @return
      */
     protected CommandBase`&lt;?&gt;` constructCommand(VdcActionType actionType,
             VdcActionParametersBase parameters,
             boolean runAsInternal,
             CommandContext context)

     /**
      * calls execute action the child command.
      * @param command
      * @param parameters
      * @return
      */
     protected VdcReturnValueBase runCommand(CommandBase`&lt;?&gt;` command)
</code></pre></div></div>

<h4 id="change-in-the-way-command-is-executed">Change in the way command is executed</h4>

<p>So to execute a command in the new framework we would use the following code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     command.checkCanDoAction();
     command.insertAsyncTaskPlaceHolders();
     returnValue = command.executeAction();
</code></pre></div></div>

<p>instead of just</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     returnValue = command.executeAction();
</code></pre></div></div>

<h4 id="modifications-to-parent-commands">Modifications to Parent Commands</h4>

<p>The CommandBase.insertAsyncTaskPlaceHolders method calls buildChildCommands to build a map of all child commands and insert place holders for them. There is a default implemantation provided in CommandBase for buildChildCommands which returns an empty map.</p>

<p>A parent command that is modified to use the feature should over write method buildChildCommands to build a map of child commands. For example the AddVmTemplateCommand can override the buildChildCommands method to build a map of all CreateImageTemplateCommands for each DiskImage.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     @Override
     protected Map`&lt;Guid, CommandBase&lt;?&gt;`&gt; buildChildCommands() {
         Guid vmSnapshotId = Guid.NewGuid();
         for (DiskImage diskImage : mImages) {
             commandsMap.put(diskImage.getImageId(), constructCommand(
                     VdcActionType.CreateImageTemplate,
                     buildChildCommandParameters(diskImage, vmSnapshotId),
                     true,
                     ExecutionHandler.createDefaultContexForTasks(getExecutionContext())));
         }
         return commandsMap;
     } 
</code></pre></div></div>

<p>and in the place where AddVmTemplateCommand was calling Back.runInternalAction the new code calls CommandBase.runCommand.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     for (DiskImage diskImage : mImages) {
             // The return value of this action is the 'copyImage' task GUID:
             VdcReturnValueBase retValue = runCommand(commandsMap.get(diskImage.getImageId()));
             .......
     }
</code></pre></div></div>

<h4 id="modifications-to-child-commands">Modifications to child Commands</h4>

<p>The child command that creates a task by calling CommandBase.createTask also needs to be modified. So in this case CreateImageTemplateCommand is modified to override the method insertAsyncTaskPlaceHolders. The method calls CommandBase.createAsyncTask to create a place holder in the db and return the task id associated with it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     private Guid taskId;
     protected void insertAsyncTaskPlaceHolders() {
            taskId = createAsyncTask(VdcActionType.AddVmTemplate,
                                         VdcObjectType.Storage,
                                         getParameters().getStorageDomainId(),
                                         getParameters().getDestinationStorageDomainId());
     }
</code></pre></div></div>

<p>The task id is passed to the createTask when executeCommand is called so that the row in the database can be updated with the vdsm id when the task is submitted to vdsm</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                 createTask(taskId,
                         vdsReturnValue.getCreationInfo(),
                         VdcActionType.AddVmTemplate,
                         VdcObjectType.Storage,
                         getParameters().getStorageDomainId(),
                         getParameters().getDestinationStorageDomainId());
</code></pre></div></div>

<h4 id="fail-commands-without-vdsm-id">Fail Commands Without Vdsm Id</h4>

<p>On server restart in AsyncTaskManager we check for all tasks that have empty vdsm id and fail the command. The empty place holders in the db are cleaned and the command is failed in a single transaction.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3019/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3019/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3019/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3019/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/asynctaskmanagerchanges-3.3detailed.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/asynctaskmanagerchanges-3.3detailed.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
