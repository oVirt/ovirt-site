<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Engine Setup | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Engine Setup" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2937/develop/developer-guide/engine/engine-setup.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2937/develop/developer-guide/engine/engine-setup.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Engine Setup" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Engine Setup","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2937/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2937/develop/developer-guide/engine/engine-setup.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2937/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2937/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2937/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2937/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2937/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2937/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2937/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2937/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2937/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2937/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2937/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2937/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2937/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2937/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2937/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2937/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2937/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2937/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2937/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2937/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2937/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2937/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2937//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2937//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2937/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2937/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2937/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2937/develop/developer-guide/engine/">
              <span property="name">Engine</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yedidyah Bar David</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="engine-setup">Engine Setup</h1>

<p>Some information about engine-setup and related tools - this currently includes engine-setup, engine-cleanup and <a href="/ovirt-site/previews/2937/develop/networking/changing-engine-hostname.html">ovirt-engine-rename</a>.</p>

<p>These tools are based on <a href="/ovirt-site/previews/2937/develop/developer-guide/engine/otopi.html">Otopi</a>.</p>

<h2 id="configuration">Configuration</h2>

<p>These tools share the following:</p>

<h3 id="etcovirt-engine-setupconfdconf">/etc/ovirt-engine-setup.conf.d/*.conf</h3>

<p>All of these tools read all of the configuration files /etc/ovirt-engine-setup.conf.d/*.conf .</p>

<p>Generally speaking, users should not touch these files. Some of them are shipped inside the rpm packages, and some are maintained by the tools themselves - keeping state needed between runs of these tools.</p>

<h3 id="answer-files">Answer files</h3>

<p>All of these tools generate upon completion an answer file, named ‘/var/lib/ovirt-engine/setup/answers/*.conf’, and mention that in their output.</p>

<p>The expected way to use these answer files is:</p>

<ol>
  <li>Have a system A in some state S0</li>
  <li>Run one of the tools interactively, answer its questions as needed, let it create an answer file Ans1.</li>
  <li>System A is now in state S1.</li>
  <li>Have some other system B in state S0, that you want to bring to state S1.</li>
  <li>Run there the same tool with –config-append=Ans1</li>
</ol>

<p>“S0” in this sense includes basically everything relevant - versions of relevant packages, enabled repos, history (such as previous runs of these tools, other data accumulated over time, etc), other manual configuration, etc.</p>

<p>When used this way, the tools should run unattended. If they still ask questions, it’s generally considered a bug.</p>

<p>Manually editing such an answer file is generally not supported/expected and should not be needed. You might do that to achieve special non-standard goals. If you do that, you should thoroughly verify that it works for you, and use in a controlled environment - same known initial state, same versions of relevant stuff, etc.</p>

<p>Just as an example for a simple and useful violation, if during testing you often run engine-setup on systems with little RAM, and want to get rid of the question if you want to continue with not enough RAM, you can create a file e.g. /etc/ovirt-engine-setup.conf.d/99-my-stuff.conf with content:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  [environment:default]
  OVESETUP_SYSTEM/memCheckEnabled=bool:False
</code></pre></div></div>

<p>Generation of answer files is done by OTOPI’s dialog module, and using them is immitating interactive runs. For details see <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1396925">Bug 1396925</a>.</p>

<h3 id="postinstall-file">Postinstall file</h3>

<p>The postinstall file, <code class="language-plaintext highlighter-rouge">/etc/ovirt-engine-setup.conf.d/20-setup-ovirt-post.conf</code>, seems like an answerfile, and has exactly the same syntax and semantics, but is very different: It serves as the place where engine-setup saves its internal data, the things it needs to remember for the next time it is ran, usually for upgrades. These generally include things like whether some feature/component is enabled.</p>

<p>In principle, it should never be touched manually, by any means other than running engine-setup itself.</p>

<h3 id="otopi-environment">Otopi Environment</h3>
<p>As mentioned above, engine-setup is mainly a set of plugins for <a href="/ovirt-site/previews/2937/develop/developer-guide/engine/otopi.html">Otopi</a>.
Both postinstall (if exists) and answerfile (if provided) are simply used to set values in Otopi’s environment.</p>

<p>Postinstall is always written in the end of a successful run, and is read, if exists, on start of run.</p>

<p>Answerfiles are written too, a unique one per each run, and are only read if provided using –config-append.</p>

<p>How does engine-setup decide what env keys/values to write to postinstall/answerfile? There are several “constants” files (not real constants, because python does not have any, but we treat them that way), and the ones that need to be written to postinstall/answerfile are actually functions with special decorators that mark this, for example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@util.export
@util.codegen
@osetupattrsclass
class CoreEnv(object):
...
    @osetupattrs(
        postinstallfile=True,
    )
    def GENERATED_BY_VERSION(self):
        return 'OVESETUP_CORE/generatedByVersion'
</code></pre></div></div>

<p>So, in this example, GENERATED_BY_VERSION is a “constant”, that has a value <code class="language-plaintext highlighter-rouge">'OVESETUP_CORE/generatedByVersion'</code>, and is marked to be written to the postinstall file.</p>

<h3 id="how-does-engine-setup-decides-what-to-do">How does engine-setup decides what to do</h3>

<p>(TODO perhaps write something more broad about engine-setup’s internals. Current text is written mainly so that I can refer to it when reviewing setup code).</p>

<ol>
  <li>
    <p>Each env var, especially ones stored in postinstall/answerfile, should have a very well-defined meaning. In particular, the following are two different meanings, and if both are needed, we need two vars:</p>

    <ol>
      <li>
        <p>A var that indicates that a user wants some feature. Such a var should be set right when we know that the user wants it - either because we asked, or because it was provided in an answerfile. It should be saved in the generated answerfile, and different plugins may want to look it up to check if the user wants this feature. To do that, the event that sets it should have a name=, and other events should be after=(that name). It should <em>not</em> be saved to the postinstall file.</p>
      </li>
      <li>
        <p>A var that indicates that some feature was enabled/configured/created/installed/etc. Such a var should be set only when that feature was actually handled, usually during STAGE_MISC (not customization). It MAY be saved in postinstall (see below), but <em>not</em> in answerfile. Similarly, of other plugins want to do something after the feature was made available, the event that did that should have a name=, and the other plugins should run after it.</p>
      </li>
    </ol>
  </li>
  <li>
    <p>How to decide if to handle a feature</p>

    <ol>
      <li>
        <p>Some features are harmless to enable every time. Check for example <a href="https://gerrit.ovirt.org/gitweb?p=ovirt-engine.git;a=blob;f=packaging/setup/plugins/ovirt-engine-setup/ovirt-engine/config/protocols.py;h=6b7a93ae7568bbd9b272800187e756ea47fcaabf;hb=HEAD">ovirt-engine-setup/ovirt-engine/config/protocols.py</a>. We always write out OVIRT_ENGINE_SERVICE_CONFIG_PROTOCOLS=<code class="language-plaintext highlighter-rouge">10-setup-protocols.conf</code> - in principle this is harmless, in practice this is optimized-out by otopi (it does not write the file if it already has the contents we want to write there).</p>
      </li>
      <li>
        <p>Others we do not want to enable/handle twice, but can check “internally” if they already are. “internally” meaning that we can check the feature itself and see if it’s handled already or not. Example: We do not want to create the database if it exists. So we have code <a href="https://gerrit.ovirt.org/gitweb?p=ovirt-engine.git;a=blob;f=packaging/setup/plugins/ovirt-engine-common/ovirt-engine/db/connection.py;h=0d4668e5966076c3f5ff210e2328ed72a0603ada;hb=HEAD">ovirt-engine-common/ovirt-engine/db/connection.py</a> to set NEW_DATABASE to False if it exists, and code <a href="https://gerrit.ovirt.org/gitweb?p=ovirt-engine.git;a=blob;f=packaging/setup/plugins/ovirt-engine-setup/ovirt-engine/provisioning/postgres.py;h=6bb891dfd15b230e40751e5e25bf7b90f88cbcba;hb=HEAD">ovirt-engine-setup/ovirt-engine/provisioning/postgres.py</a> that creates the database, which checks if NEW_DATABASE is set, before it even asks the user.</p>
      </li>
      <li>
        <p>Yet others we do not want to enable/handle twice, and also can’t (or don’t want to, or simply didn’t think about this) check internally. For these, we use vars of style (1.2.) above. An example is ApacheEnv.CONFIGURED, set in <a href="https://gerrit.ovirt.org/gitweb?p=ovirt-engine.git;a=blob;f=packaging/setup/plugins/ovirt-engine-setup/ovirt-engine-common/apache/misc.py;h=c43680e8a50839389ee75b77e8c131ba19ae85ae;hb=HEAD">ovirt-engine-setup/ovirt-engine-common/apache/misc.py</a>, used by <a href="https://gerrit.ovirt.org/gitweb?p=ovirt-engine.git;a=blob;f=packaging/setup/plugins/ovirt-engine-setup/ovirt-engine-common/apache/ssl.py;h=de37bc2482ef107254f09f80ea5114d75da8a639;hb=HEAD">ovirt-engine-setup/ovirt-engine-common/apache/ssl.py</a>.</p>
      </li>
    </ol>
  </li>
</ol>

<h3 id="secret-knobs">Secret Knobs</h3>

<p>Some env vars are like “Secret buttons”, that were not designed to be used easily, thus not asked about nor can be controlled with command line options or similar. This is usually because when adding them, we either considered them risky to change, yet wanted to have the option, or we simply expected almost no-one to need to change them, and didn’t want to bother users with even more questions.</p>

<p>These are usually not tested routinely, and officially are unsupported and should not be set. They are usually documented in the relevant bugzilla bug for which they were added, or at least in the message of the git commit that added them. And of course, this is Open Source, you can always read the code and see what they do!</p>

<p>Some examples:</p>

<ul>
  <li>
    <p>Vars to control the size of database dumps taken by engine-setup to allow rollback (not to be confused with engine-backup) and the speed of backup/restore. These were added for <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1188132">bug #1188132</a>, some details are in the commit message (<a href="https://gerrit.ovirt.org/39190">gerrit.ovirt.org/39190</a>).</p>
  </li>
  <li>
    <p>A variable to allow ignoring checks of PostgreSQL configuration options, might be useful if using a remote database and you have your own opinion about how some of them should be set. Added for <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1573091">bug #1573091</a>, see <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1573091#c6">comment 6</a> there for details.</p>
  </li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2937/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2937/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2937/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2937/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/engine/engine-setup.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/developer-guide/engine/engine-setup.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
