<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hot plug cpu | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Hot plug cpu" />
<meta name="author" content="Andrew Dahms" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2989/develop/release-management/features/virt/hot-plug-cpu.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2989/develop/release-management/features/virt/hot-plug-cpu.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hot plug cpu" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Andrew Dahms" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Andrew Dahms"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Hot plug cpu","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2989/images/logo.svg"},"name":"Andrew Dahms"},"url":"https://ovirt.github.io/ovirt-site/previews/2989/develop/release-management/features/virt/hot-plug-cpu.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2989/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2989/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2989/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2989/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2989/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2989/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2989/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2989/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2989/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2989/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2989/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2989/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2989/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2989/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2989/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2989/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2989/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2989/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2989/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2989/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2989/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2989/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2989//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2989//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2989/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2989/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2989/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2989/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2989/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Andrew Dahms">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Andrew Dahms</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Roy Golan">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Roy Golan</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Sven Kieske">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Sven Kieske</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2989/documentation/'>Documentation is available here.</a></div>

<h1 id="hot-plug-cpu">Hot plug cpu</h1>

<h2 id="summary">Summary</h2>

<p>This feature allows you to hot plug CPUs to a running virtual machine from the oVirt engine user interface and REST API.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Roy Golan</li>
  <li>Email: rgolan@redhat.com</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>phase 1 (i.e all content in this wiki) - Done</li>
  <li>phase 2 - <a href="#phase-2">Hot_plug_cpu#Phase_2</a> desgin stage</li>
  <li>limitations: unplug isn’t supported fully due to libvirt’s <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1017858#c11">Bug #1017858</a></li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>Historically, CPU and memory hot add and remove capabilities were thought of as server hardware RAS features.
However, the concepts of CPU and memory hot add and remove are both common and necessary for Virtualized environments.
Virtual CPUs and virtual memory assigned to a virtual machine (VM) need to be be added or removed from a running guest in order to meet either
the workload’s demands or to maintain the SLA associated with the workload.
It is also desired for the rapid reconfiguration of a guest once a workload has been completed or migrated and an administrator wants to reconfigure the VM without having to re-boot the VM.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>This feature enables the following powerful use cases:</p>

<ul>
  <li>Admins can ensure customer’s SLA are being met</li>
  <li>Spare hardware can be effectively used - it’s common to see systems overdimentioned x3 for an average max load</li>
  <li>System hardware can be dynamic scaled vertically, down or up, in accordance with your needs <strong>without restarting</strong> the virtual machine</li>
</ul>

<h2 id="detailed-design">Detailed Design</h2>

<h3 id="client-usage">Client Usage</h3>

<p>The term plug/unplug CPUs is simpler from the user POV.
The user just needs to set the desired number of sockets he needs.
I.e we support a number which is the multiplication of the Cores per sockets and sockets.</p>

<p>All of this means that the user can now simply change the number of sockets of a running VM while its status is UP.
This would trigger a call to VDSM to <code class="language-plaintext highlighter-rouge">setNumberOfCpus(vmId, num)</code>.
There is no notion of plug/unplug.</p>

<h4 id="ui">UI</h4>

<p>See that “Sockets” text input is editable while the VM is UP (its editable only when UP or DOWN statuses)</p>

<p><img src="/ovirt-site/previews/2989/images/wiki/Hotplug-cpu-gui.png" alt="" /></p>

<h4 id="rest">REST</h4>

<p>This is a typical update to a VM resource.
The number of sockets is changed to 2.
This will hotplug 1 more CPU to the machine.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>hotplug-cpu.xml
</code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;vm&gt;</span>
    <span class="nt">&lt;cpu&gt;</span>
      <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">"2"</span> <span class="na">cores=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/topology&gt;</span>
    <span class="nt">&lt;/cpu&gt;</span>
  <span class="nt">&lt;/vm&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> PUT <span class="se">\</span>
    <span class="nt">--user</span> user@domain:pass <span class="se">\</span>
    <span class="nt">-H</span> <span class="s2">"Content-Type:application/xml"</span> <span class="se">\</span>
    <span class="nt">-d</span>@hotplug-cpu.xml  http://localhost:8080/ovirt-engine/api/vms/<span class="k">${</span><span class="nv">vmId</span><span class="k">}</span>
</code></pre></div></div>

<h3 id="engine">Engine</h3>

<p>Engine must allow updates to the number of sockets field while the VM is up. When calling the <code class="language-plaintext highlighter-rouge">UpdateVmCommand</code>, we will check
if the current number is different then the stored number of sockets. if it is we then call VDSM setNumberOfCpus(vmId, num).
If we returned with no error, the new number of CPUs is stored into db. The engine view of the actual vCpus of this machine is now syncronized.</p>

<p>A pre-condition for adding more CPUs is that a VM has a <code class="language-plaintext highlighter-rouge">MAX_VCPUS</code> set in its xml.
This means we have to start the VM with some configured maximum.
This number doesn’t affect any reosurce allocation on the VM itself.
Till today the <code class="language-plaintext highlighter-rouge">MAX_VCPUS</code> was equal to the number of CPUs the VM started with.
So its impossible to hot plug more CPUs to machines that started &lt; 3.4 (i.e setup upgraded and the machines stayed UP)</p>

<p>pseudo-code for building a VM xml we send to VDSM</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="k">if</span> <span class="p">(</span><span class="n">hot</span> <span class="n">plug</span> <span class="ow">is</span> <span class="n">supported</span> <span class="k">for</span> <span class="n">this</span> <span class="n">compat</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">smp</span> <span class="o">=</span> <span class="n">ConfigValues</span><span class="p">.</span><span class="n">MaxNumOfVmCpus</span>
      <span class="p">}</span>
</code></pre></div></div>

<h4 id="update-vm-command---error-handling">Update Vm Command - Error handling</h4>

<p>The API to hot plug CPU is using <code class="language-plaintext highlighter-rouge">UpdateVmCommand</code>.
Essentially if there is a change in topology a child Command <code class="language-plaintext highlighter-rouge">HotSetNumberOfCpus</code> will be called.
The call to the child command fails atomically and it shall <strong>NOT</strong> abort the parent <code class="language-plaintext highlighter-rouge">UpdateVmCommand</code>.</p>

<p>e.g - we want to update a running’s VM desription and to hotplug 1 more cpu</p>

<ol>
  <li>the updated values are desctiption and numberOfSockets</li>
  <li>UpdateVmCommad saves the descitption to DB</li>
  <li>HostSetNumberOfCpus is called with new number of sockets but fails</li>
  <li>UpdateVmCommand check for the failure and outputs and AuditLog</li>
  <li>UpdateVmCommand terminates and commit changes to DB with the new description only. the old number of sockets remains unchanged</li>
</ol>

<h5 id="changes">changes</h5>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>requirement</th>
      <th>completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Engine</td>
      <td>UpdateVmCommand permits number of cpus change while VM is running</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>Engine</td>
      <td>UpdateVmCommand canDo fail if # of cpus is not supported on host (config value?, get the actual number from caps?)</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Engine</td>
      <td>UpdateVmCommand send setNumberOfCpus verb when cpus changes</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>Engine</td>
      <td>UpdateVmCommand stores the new number of CPUs only if the call to setNumberOfCpus succeeded</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>Engine - osinfo</td>
      <td>create configuration for plug/unplug</td>
      <td>not clear which OSs we block/allow - PPC is blocked entirely</td>
    </tr>
    <tr>
      <td>Engine</td>
      <td>create informative Audit log when setNumberOfCpus fails</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>VDSM</td>
      <td>create new verb ‘setNumberOfCpus’. it would be used for both plug/unplug cpus</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>VDSM</td>
      <td>in vm.py, bind the verb to an underling call to libvirt’s setVcpus</td>
      <td>Done</td>
    </tr>
    <tr>
      <td>VDSM</td>
      <td>call before/after hooks for plug/unplug to enable various method for onlining the CPU at the guest OS</td>
      <td>Done</td>
    </tr>
  </tbody>
</table>

<h6 id="check-list">check list</h6>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>check</th>
      <th>completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>VDSM</td>
      <td>check migration of a VM that was hotplugged with cpus and re-migrated it (not sure changes needed)</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<ul>
  <li><strong><em>setNumOfCpus –guest</em></strong> (using qemu guest agent for plug/unplug)</li>
</ul>

<p>There is no direct dependency on QEMU’s agent. But for the sake of documenting any detail we have, its worth mentioning that<b></b></p>

<p>libvirt’s setNumOfCpus –guest will use the guest agent to offline/online the requested cpu instead of a real plug/unplug</p>

<p>i.e that the as for RHEL, the guest alone handles the plug/unplug without the need of the agent to do the underling job.</p>

<p>for more details see comment 11 on <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1017858#c11">Bug #1017858</a></p>

<p><a href="https://wiki.qemu.org/Features/GuestAgent">qemu-guest-agent</a></p>

<h2 id="guest-os-support-matrix">Guest OS Support Matrix</h2>

<table>
  <thead>
    <tr>
      <th>OS</th>
      <th>Version</th>
      <th>Arch</th>
      <th>Plug</th>
      <th>Unplug</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Red Hat Enterprise Linux 6.3</td>
      <td> </td>
      <td>x86</td>
      <td>+</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Red Hat Enterprise Linux 6.5</td>
      <td> </td>
      <td>x86</td>
      <td>+</td>
      <td>+</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2003</td>
      <td>All</td>
      <td>x86</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2003</td>
      <td>All</td>
      <td>x64</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008</td>
      <td>All</td>
      <td>x86</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008</td>
      <td>Standard, Enterprise</td>
      <td>x64</td>
      <td>Reboot Required</td>
      <td>Reboot Required</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008</td>
      <td>Datacenter</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008 R2</td>
      <td>All</td>
      <td>x86</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008 R2</td>
      <td>Standard, Enterprise</td>
      <td>x64</td>
      <td>Reboot Required</td>
      <td>Reboot Required</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2008 R2</td>
      <td>Datacenter</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2012</td>
      <td>All</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows Server 2012 R2</td>
      <td>All</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows 7</td>
      <td>All</td>
      <td>x86</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>Microsoft Windows 7</td>
      <td>Starter, Home, Home Premium, Professional</td>
      <td>x64</td>
      <td>Reboot Required</td>
      <td>Reboot Required</td>
    </tr>
    <tr>
      <td>Microsoft Windows 7</td>
      <td>Enterprise, Ultimate</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows 8.x</td>
      <td>All</td>
      <td>x86</td>
      <td>+</td>
      <td>?</td>
    </tr>
    <tr>
      <td>Microsoft Windows 8.x</td>
      <td>All</td>
      <td>x64</td>
      <td>+</td>
      <td>?</td>
    </tr>
  </tbody>
</table>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1036492">oVIrt VDSM RFE</a></li>
  <li><a href="http://wiki.qemu.org/Features/CPUHotplug">QEMU hotplug cpu feature wiki page</a></li>
  <li><a href="https://www.kernel.org/doc/Documentation/core-api/cpu_hotplug.rst">Linux Kernel Documentation for hotplug</a></li>
</ul>

<h2 id="open-issues">Open Issues</h2>

<h4 id="possible-error-when-migrating-a-vm-which-its-max-cpu-is-lower-than-what-currently-in-vcpu-currentnmvcpu">Possible error when migrating a VM which its max cpu is lower than what currently in <code class="language-plaintext highlighter-rouge">&lt;vcpu current=n&gt;m&lt;/vcpu&gt;</code></h4>

<p>The current VM on the source has <strong><em>n</em></strong> cpus attached and need <strong><em>m</em></strong> maximum to be able to online more.
if <strong><em>m1</em></strong> is the max cores on the the source <strong><em>H1</em></strong> host and <strong><em>m2</em></strong> is the maximum on destination host <strong><em>H2</em></strong>
if <strong><em>m1 &gt; m2</em></strong> the underlying migration should fail?</p>

<h4 id="possible-cpu-pinning-problems">Possible CPU pinning problems</h4>

<p>if we have cpu pinning for cpu 1-4 and we start the VM with 4 CPU and then we offline 2 CPUs and then we online them back - is the pinning kept?</p>

<h4 id="hook-support">hook support</h4>

<p>hook support is provided to solve potential problems with online/offline the cpu after the actual addition to the VM system.
Its not clear if some linux versions will have the cpu added but offline in the system so the hook is to cover the gap.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/usr/libexec/vdsm/hooks/before_set_num_of_cpus</code></li>
  <li><code class="language-plaintext highlighter-rouge">/usr/libexec/vdsm/hooks/after_set_num_of_cpus</code></li>
</ul>

<h2 id="phase-2">Phase 2</h2>

<p>Due to libvirt bug on unplug the engine has an inconsistent view of the amount of CPUs the VM has.
i.e after unplugging 4 vcpus to 2 vcpus the VM entity in DB has 4 and in qemu process it will decrease to 2</p>

<p><strong>status:</strong> in progress
 <strong>related bugs:</strong> <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1077515">1077515</a></p>

<h3 id="block-unplug">block Unplug</h3>

<ul>
  <li>block unplug operation (based on static vm cpu count)</li>
  <li>engine can do</li>
  <li>UI grey-out lower values</li>
  <li>vdc_option for unplug=false in 3.4 till otherwise be it supported.</li>
  <li>add it to engine-config so its exposed to admins</li>
</ul>

<h3 id="notify-vdsm-guest-agent">notify VDSM Guest Agent</h3>

<ul>
  <li>call vga (vdsm guest agent) setNumCpus(num:int)</li>
  <li>log if unsupported operation on guest</li>
  <li>call setnumofCpu will trigger a refresh</li>
</ul>

<h3 id="report-topology">report topology</h3>

<ul>
  <li>
    <p>report the CPU topology under VM subtab</p>

    <p>TODO scketch it</p>
  </li>
  <li>
    <p>format of the topology (Vinzenz please fill in)</p>
  </li>
</ul>

<p>note: VDSM-guest-agent work for reporting this is already in progress - <a href="http://gerrit.ovirt.org/23268">http://gerrit.ovirt.org/23268</a></p>

<h2 id="testing">Testing</h2>

<ul>
  <li>how to check the guest CPUs - LINUX</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      lscpu <span class="nt">-e</span> <span class="nt">-a</span>
</code></pre></div></div>

<p>TODO - format the tests</p>

<ol>
  <li>CPU hot unplug \ CPU loaded
    <ol>
      <li>Set up</li>
      <li>Actions
        <ol>
          <li>Have a VM with 2 CPUs with 100 % utilization - try to hot unplug 1 CPU.</li>
          <li>Hot plug 1 CPU.</li>
        </ol>
      </li>
      <li>Expected Results
        <ol>
          <li>See how the OS handle the requiest in such case.</li>
          <li>As the unplug process should take time, interesting to see, how the OS respose to the hot plug.</li>
        </ol>
      </li>
      <li>Breakdown</li>
    </ol>
  </li>
  <li>Negative test - Add CPU above max
    <ol>
      <li>Set up</li>
      <li>Actions
        <ol>
          <li>Update VM number of CPUs, to a value greater than host capabilities, while VM is running.</li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p>(Check what is the maximum number of CPUs, supported on host by getVdsCaps on host).</p>

<ol>
  <li>
    <ol>
      <li>Expected Results
        <ol>
          <li><code class="language-plaintext highlighter-rouge">CanDoAction</code> fail</li>
        </ol>
      </li>
      <li>Breakdown</li>
    </ol>
  </li>
  <li>Negative test - CPU hot plug single CPU
    <ol>
      <li>Set up</li>
      <li>Actions
        <ol>
          <li>For a VM with 1 CPU, try to run CPU hot unplug.</li>
        </ol>
      </li>
      <li>Expected Results
        <ol>
          <li>Expect <code class="language-plaintext highlighter-rouge">CanDoAction</code>, since 1 CPU is the minimum.</li>
        </ol>
      </li>
      <li>Breakdown</li>
    </ol>
  </li>
  <li>Negative test - CPU hot plug, before qemu-kvm updated
    <ol>
      <li>Set up</li>
    </ol>
  </li>
</ol>

<p>Background:</p>

<p>When running CPU hot plug/unlug, the engine gets acked from qemu-kvm side, even before CPU count has actually updated in qemu-kvm. Therefore, user is reflected that the CPU number was already updated. At this point of time, user can run a 2nd CPU plug/hotplug. Actions</p>

<ol>
  <li>
    <p>Add CPUs to a running VM (2-&gt;4, for example)</p>
  </li>
  <li>
    <p>Remove CPU (4-&gt;2, for example), right after the hot add (step 1).</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  To see the number of CPUs is yet increased, see test plan documentation on how to do so on guest.
</code></pre></div>    </div>
  </li>
</ol>

<p>Expected Results</p>

<ol>
  <li>
    <p>Should fail nicely. Breakdown [338998] Negative test - CPU pinning Set up Actions</p>
  </li>
  <li>
    <p>Have a VM with cpu pinning defined to 3 first CPUs, in ordered manner. Start the VM with 4 CPUs.</p>
  </li>
  <li>
    <p>Hot unplug 2 CPUs. (update number of CPUs from 4 to 2), while VM is running.</p>
  </li>
  <li>
    <p>Have a VM with cpu pinning defined to 2 CPUs, and CPU pinning to #2, &amp; #3. Hot plug 2 CPUS, and then hot unplug 2 CPUs. Expected Results</p>
  </li>
  <li>
    <p>Should fail, cpu pinning should block this change.</p>
  </li>
  <li>
    <p>Should fail. Libvirt should block this upon cpu pinning. Breakdown [337910] Negative test - Hot plug during migration Set up Actions</p>
  </li>
  <li>
    <p>Try to CPU hot-plug (add or reduce CPUs) during VM migration. Expected Results</p>
  </li>
  <li>
    <p>Failure message or can do action (no exceptions in the log). Breakdown [338661] Positive test - CPU hot plug &amp; unplug toggle Set up Actions</p>
  </li>
  <li>
    <p>CPU hot plug &amp; unplug toggle several times. Expected Results</p>
  </li>
  <li>
    <p>CPU number should get updated as configured on guest. Breakdown [337912] Positive test - CPU pinning Set up Actions</p>
  </li>
  <li>
    <p>Have a VM with cpu pinning defined to 3 first CPUs, in ordered manner. Start the VM with 4 CPUs.</p>
  </li>
  <li>
    <p>Hot unplug 1 CPU (update number of CPUs from 4 to 3), while VM is running. Expected Results</p>
  </li>
  <li>
    <p>Should be successful.</p>
  </li>
  <li>
    <p>Should be successful. Breakdown [338718] Positive test - CPU thread Set up Actions</p>
  </li>
  <li>
    <p>CPU hot plug 2-&gt;4, without cluster CPU thread activated.</p>
  </li>
  <li>
    <p>Also consider here SLA cluster level hypertherding, and in case it is active, the number of CPUs = Hyperthreding (CPU Thred) * Cores * Sockets Expected Results</p>
  </li>
  <li>
    <p>See that the maximum allowed number of CPUs = CPU cores * CPU sockets.</p>
  </li>
  <li>
    <p>See that maximum allowed number of CPUs = CPU cores * CPU sockets * CPU thread Breakdown [337907] Positive test - Hot Add\Remove CPUs Set up Actions</p>
  </li>
  <li>
    <p>Start A VM with 2 CPUs, 2 cores each .</p>
  </li>
  <li>
    <p>Update number of CPUs to 4, while VM is running.</p>
  </li>
  <li>
    <p>Update number of CPUs to 2, while VM is running.</p>
  </li>
</ol>

<p>Expected Results</p>

<ol>
  <li>
    <p>a. See that the number of CPUs updated correctly &amp; successfully in UI and REST.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  b. Verify CPU count = 4, by checking it on guest (see test plan documentaion for how to).
  (it may take some time to reach the correct CPU count.)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Same as 2, expect CPU count =2. Breakdown [337909] Positive test - Migrate VM hot plugged with CPUs Set up</p>
  </li>
</ol>

<p>Require 2 hosts for migration. Actions</p>

<ol>
  <li>
    <p>CPU hotplug add: While VM is running, add more CPUs, for example, for a VM with 2 CPUs, update to 4 CPUs.</p>
  </li>
  <li>
    <p>Migrate the VM.</p>
  </li>
  <li>
    <p>Migrate VM back to original host.</p>
  </li>
  <li>
    <p>Repeat 1-3 for CPU hot unplug of 4-&gt;2.</p>
  </li>
  <li>
    <p>Have 2 VMs, each on a separate host. CPU hot plug on VM 1 from 2-&gt;4. CPU hot unplug on VM 2 from 4-&gt;2. Migrate concurretly VM1 and VM2. Expected Results</p>
  </li>
  <li>
    <p>CPU hot plug should be successful. Check on guest by running ‘lscpu’ that the CPU number has been updated to 4.</p>
  </li>
  <li>
    <p>Migration should succeed. Check on guest (see test plan documentaion for how to), that the CPU number = 4 .</p>
  </li>
  <li>
    <p>Same as 2.</p>
  </li>
  <li>
    <p>Expect same results as 1-3</p>
  </li>
  <li>
    <p>After migrations, the CPU number on guest should be as configured. Breakdown [337913] Positive test - vdsm hooks Set up</p>
  </li>
</ol>

<p>vdsm hooks - vdsm call before/after hooks for plug/unplug to enable various method for onlining the CPU at the guest OS Actions</p>

<ol>
  <li>Fill on host, where VM is running, these vdsm hook files:</li>
</ol>

<p>a. /usr/libexec/vdsm/hooks/before_set_num_of_cpu, for example, with this content: echo “running before_set_num_of_cpu”</p>

<p>b. /usr/libexec/vdsm/hooks/after_set_num_of_cpu, for example, with this content: echo “running after_set_num_of_cpu”</p>

<ol>
  <li>
    <p>Plug: Add CPUs to a VM, for example, 2-&gt;4.</p>
  </li>
  <li>
    <p>Unplug: Reduce CPUs to a VM, for example, 4-&gt;2.</p>
  </li>
</ol>

<p>Expected Results</p>

<ol>
  <li>
    <ul>
      <li>
        <p>Check on guest that CPU number was updated (see test plan documentaion for how to).</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    -  Verify that both hook files run &amp; exceuted.
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Same as 2, Except due to bug 1017858 , the after script will not be called till resolved. Breakdown [339000] System test Set up</li>
</ol>

<p>Have a VM with a single CPU, which is fully utilized Actions</p>

<ol>
  <li>
    <p>. Hot plug CPU 1 -&gt; 2. Expected Results</p>
  </li>
  <li>
    <p>Check adaptation of the OS of the CPU change: Verify indeed the hot plug indeed improve the performance, and the 2nd CPU is used to balance the load.</p>
  </li>
</ol>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2989/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2989/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2989/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2989/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/hot-plug-cpu.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/hot-plug-cpu.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
