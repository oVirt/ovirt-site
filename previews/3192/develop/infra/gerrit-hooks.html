<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gerrit hooks | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Gerrit hooks" />
<meta name="author" content="David" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3192/develop/infra/gerrit-hooks.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3192/develop/infra/gerrit-hooks.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gerrit hooks" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@David" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"David"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Gerrit hooks","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3192/images/logo.svg"},"name":"David"},"url":"https://ovirt.github.io/ovirt-site/previews/3192/develop/infra/gerrit-hooks.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3192/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3192/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3192/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3192/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3192/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3192/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3192/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3192/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3192/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bcb2aef8cc1559485f70f69eed60b9bb?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bcb2aef8cc1559485f70f69eed60b9bb?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of David">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">David</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6283090555baed00991434f7c2a060f8?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6283090555baed00991434f7c2a060f8?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eyal Edri">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eyal Edri</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Much of this developer documentation provides historical context but may not reflect the current state of the project.<br>If you see outdated content please navigate to the page footer and click "<strong>Report an issue on GitHub</strong>".<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3192/documentation/'>User Documentation is available here.</a></div>

<h1 id="gerrit-hooks">Gerrit hooks</h1>

<p><strong>Overview of the Gerrit Hooks</strong></p>

<p>WIP</p>

<h2 id="source-code">Source Code</h2>

<p>The source code is hosted in the <a href="http://gerrit.ovirt.org/gitweb?p=gerrit-admin.git;a=shortlog;h=HEAD">gerrit-admin</a> gerrit project, inside the hooks directory. There you’ll find a lib directory, that contains helper bash scripts and python modules used by the hooks. The custom_hooks directory, containing all the available hooks, and the hook-dispatcher file, that is the controller for the hooks execution.</p>

<h2 id="flow">Flow</h2>

<p>All the hooks execution starts on the hook-dispatcher, that’s the script that will be called by gerrit itself when an event happens (you can control which events are handled by adding/removing links on <em>$GERRIT_DIR/hooks</em> directory to this script).</p>

<p>The hook-dispatcher then detects which type of event was triggered by, and by which project, and from the project’s source directory (usually <em>$GERRIT_SOURCE/$project.git</em>) will look for a hooks directory and run all the hooks that match the event, that is, all the hooks that start with $event_name (see the event types below). They are ordered in alphanumeric order.</p>

<p>The hooks are run in chains, to know more about it, check the chaining section below. Right now we just need to know that a hook can succeed, fail silently, or break the execution completely.</p>

<p>Each hook will be passed the same parameters that gerrit used to invoke the hook-dispatcher script. And each hook will be required to reply in a specific format (see the hook output section). From that output a Code REview (<strong>CR</strong>) value, and a Verified (<strong>VR</strong>) value will be extracted, along with a comment.</p>

<p>From all the hooks, a <strong>CR</strong> and a <strong>VR</strong> value will be calculated, this is done taking the lowest value that was explicitly specified. A hook can avoid influencing the vote by no passing any <strong>CR</strong> or <strong>VR</strong> value.</p>

<p>After that, all the messages will be aggregated (if the hook did not specify any message, a simple informative one will be generated for it) and the global review will be sent to gerrit.</p>

<h3 id="hook-output-format">Hook Output Format</h3>

<p>Each hook output must fit a specific format, defined below (please, check the in-code documentation for the current format, as this wiki might be outdated).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  code_review_value
  verified_value
  multiline_message
</code></pre></div></div>

<p>The first two lines are optional, you can leave them blank or delete them, if only one suitable voting value passed it will be assumed to be the code review value. Some examples:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  +1
  +1
  This is a simple
  multiline message
</code></pre></div></div>

<p>This output will generate a <strong>CR</strong> of <strong>+1</strong>, a <strong>VR</strong> of <strong>+1</strong>, and everything else will be interpreted as message. If for example the next hook would return:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  0
  Second hook message
</code></pre></div></div>

<p>Then the CR punctuation will be flatted to 0, the VR value will be kept intact and the message for this hook will be appended to the global message. And if the last one would be this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Third hook 
  ouput message
</code></pre></div></div>

<p>Then neither of the review values will be changed and only the output message will be appended.</p>

<h3 id="chaining">Chaining</h3>

<p>You can create chains, chains are sets of hooks that run in a predefined sequentially flow, and any of them can break the chain to abort that flow and keep with the next chain.</p>

<p>Chains are defined as the second point-separated string in the hooks name, for example if you have the hooks:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  patchset-created.chain1.1.first_hook
  patchset-created.chain1.2.second_hook
  patchset-created.independent_hook
  patchset-created.independent_hook_2
</code></pre></div></div>

<p>Here we can see that we have 3 chains, <em>chain1</em>, <em>independent_hook</em> and <em>independent_hook_2</em>, if, for example, <em>patchset-created.chain1.1.first_hook</em> would return something different than <strong>0</strong> as it’s return code, <em>patchset-created.chain1.2.second_hook</em> would not be even executed and it will jump to <em>patchset-created.independent_hook</em>.</p>

<p>Flow execution is controlled with the return codes of each hook execution, if the hook exited with a return code different than <strong>0</strong>, the chain will be considered as broken and will jump to the next. The breakage of the chain does not imply that the review value must be negative, just that the execution was stopped, the <strong>CR</strong> and <strong>VR</strong> values will be extrapolated from the output of the hooks that were actually executed.</p>

<h3 id="event-types">Event types</h3>

<p>There is a limited set of events that gerrit will be able to trigger a hook by, you should take a look on gerrit documentation for all of them, but as the writing of this document, the most important ones are:</p>

<ul>
  <li>patchset-created: Run when a new patchset is sent to gerrit</li>
  <li>change-merged: Run where a patchset is merged into the branch.</li>
  <li>comment-added: Run when a new comment is sent to any patchset.</li>
  <li>change-abandoned: Run when a changeset is abandoned.</li>
</ul>

<p>You must note that all those hooks are run <strong>AFTER</strong> the even has taken place.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>If you find yourself stuck with a need to skip a bad hook (for e.g sometimes we don’t need to submit to major branch and only z-stream), you can just rerun a working hook by adding comment:</p>

<ul>
  <li>Rerun-Hooks: patchset-created.bz.0.has_bug_url</li>
</ul>

<p>This will remove the -Verified any other hook provided.</p>

<h2 id="installation">Installation</h2>

<p>The hooks are actually manually installed, so I’ll explain how is set up right now (it might change in the near future).</p>

<h3 id="base-direcotry">Base Direcotry</h3>

<p>Under <em>/home/gerrit2/review_site/hooks</em> you’ll find a copy of the <em>hooks</em> folder that’s in the source code repository. And also some soft-links (explained under Hook Dispatcher section) and a custom ‘config’ file.</p>

<h3 id="hook-dispatcher">Hook Dispatcher</h3>

<p>For gerrit to find the hook-dispatcher script, there are some soft-links under the base directory with the name of the default hooks that gerrit will execute, you can just delete or create more if you want to the hook-dispatcher to handle those events or not.</p>

<h3 id="custom-hooks">Custom Hooks</h3>

<p>Each custom hook that is written, is placed under $GERRIT_BASE/hooks/custom_hooks, and linked from each source repository that should run them, for example, if we wanted the hook ‘patchset-created.myhook’ to be run for the ovirt-engine project, we will create a link from $GERRIT_SRC/ovirt-engine.git/hooks/patchset-created.myhook to $GERRIT_BASE/hooks/custom_hooks/patchset-created.myhook, you can modify the links names to create chains or reorder the hooks.</p>

<h2 id="configuration">Configuration</h2>

<p>All the hooks can be configured using configuration files, there’s some hierarchy and inheritance that I’ll explain below. Each configuration file is just a shell script where you declare bash variables, but if you want to be able to use those variables in the python scripts hooks, you’ll have to make sure that they do not spawn more than one line, no bash ararays are used and no extra variable expansion is done in the value (that might be improved soon, but there’s have been no need yet).</p>

<h3 id="global-configuration-file">Global Configuration File</h3>

<p>There’s a global configuration file that will be used by all the hooks, no matter what. That configuration file is located under $GERRIT_BASE/hooks/config.</p>

<h3 id="per-project-configuration-file">Per Project Configuration File</h3>

<p>Each project can have it’s own configuration file too, it must be located at $GERRIT_SRC/$project.git/hooks/config, and it will overwrite any value that was declared in the cglobal configuration file.</p>

<h2 id="libraries">Libraries</h2>

<p>To ease the development of the hooks and avoid code duplication, some bash and python libraries are provided adding the $GERRIT_BASE/hooks/lib directory to poth the PATH and PYTHONPATH enviroment variables of the hooks when executing them.</p>

<p><strong>NOTE</strong>: For the latest docs, look the code, this wiki is not yet automatically updated, so it might be outdated.</p>

<p><a href="/ovirt-site/previews/3192/develop/infra/infrastructure-documentation.html">Category:Infrastructure documentation</a></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3192/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3192/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3192/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3192/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/infra/gerrit-hooks.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/infra/gerrit-hooks.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
