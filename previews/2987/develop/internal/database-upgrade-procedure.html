<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>oVirt-database-upgrade-procedure | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="oVirt-database-upgrade-procedure" />
<meta name="author" content="Eli Mesika" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2987/develop/internal/database-upgrade-procedure.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2987/develop/internal/database-upgrade-procedure.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt-database-upgrade-procedure" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Eli Mesika" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Eli Mesika"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"oVirt-database-upgrade-procedure","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2987/images/logo.svg"},"name":"Eli Mesika"},"url":"https://ovirt.github.io/ovirt-site/previews/2987/develop/internal/database-upgrade-procedure.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2987/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2987/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2987/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2987/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2987/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2987/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2987/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2987/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2987/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2987/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2987/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2987/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2987/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2987/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2987/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2987/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2987/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2987/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2987/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2987/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2987/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2987/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2987//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2987//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2987/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2987/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2987/develop/internal/">
              <span property="name">Internal</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eli Mesika">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Oved Ourfali">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Much of this developer documentation provides historical context but may not reflect the current state of the project.<br>If you see outdated content please navigate to the page footer and click "<strong>Report an issue on GitHub</strong>".<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2987/documentation/'>User Documentation is available here.</a></div>

<!-- TODO: Content review -->

<h1 id="ovirt-database-upgrade-procedure">oVirt database upgrade procedure</h1>

<h2 id="upgrade-procedure">Upgrade Procedure</h2>

<p>In order to handle DB upgrades, we will maintain a fixed schema plus initial data and from that point on All schema &amp; data changes will be done via upgrade scripts.</p>

<p>Each upgrade change should be in a separate file formatted by <code class="language-plaintext highlighter-rouge">MM_mm_nnnn_[Name].sql</code> where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MM</code> indicates Major Version number</li>
  <li><code class="language-plaintext highlighter-rouge">mm</code> indicates Minor Version number</li>
  <li><code class="language-plaintext highlighter-rouge">nnnn</code> are numbers starting from <code class="language-plaintext highlighter-rouge">0010</code>, each having an offset of <code class="language-plaintext highlighter-rouge">10</code> from previous script(i.e <code class="language-plaintext highlighter-rouge">0010</code> <code class="language-plaintext highlighter-rouge">0020</code> ….)</li>
  <li><code class="language-plaintext highlighter-rouge">[Name]</code> is a short descriptive name for the script (Please do not put your BZ # as part of the Name).</li>
</ul>

<h3 id="assumptions">Assumptions</h3>

<ul>
  <li>The following assumes that there are no schema changes in Z-stream. Exception description will follow.</li>
  <li>From now on, since upgrade run only new scripts, upgrade scripts do not need to be re-entrant.</li>
  <li>This assumption requires that new upgrade scripts should be pushed into git with a higher version than the latest script.</li>
</ul>

<h3 id="schema_version-table">schema_version table</h3>

<p>We now have a schema_version table that hold the db upgrade history and current version The upgrade script checks for the current version and run only new upgrade scripts.
The current upgrade schema is updated on each upgrade run and available as one file named <code class="language-plaintext highlighter-rouge">.schema</code></p>

<h3 id="configuration-changes">Configuration changes</h3>

<p>All changes to the configuration stored in the <code class="language-plaintext highlighter-rouge">vdc_options</code> table will be done using one script named
<strong><code class="language-plaintext highlighter-rouge">config.sql</code></strong> under <strong><code class="language-plaintext highlighter-rouge">dbscripts/upgrade/pre_upgrade</code></strong> directory.
<strong><code class="language-plaintext highlighter-rouge">config.sql</code></strong> script file is categorized to the following sections:</p>

<ul>
  <li>Add Section</li>
  <li>Update section (w/o overriding current value)</li>
  <li>Delete section</li>
  <li>Simple upgrades not available using a fn_db* function call</li>
  <li>Complex upgrades using temporary functions</li>
</ul>

<p><strong>Please note that the <code class="language-plaintext highlighter-rouge">config.sql</code> is now re-entrant.</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">pre_upgrade</code> directory hosts hook scripts that are executed before the upgrade executes
Scripts in the <code class="language-plaintext highlighter-rouge">pre_upgrade</code> directory are executed lexicography.
This change implies also that all upgrade scrips that modify vdc_options will be squashed to config_sql
Squashing is actually taking all the content of upgrade scripts that handle configuration and inserting it to <code class="language-plaintext highlighter-rouge">config.sql</code> in the same order
After doing so, the original upgrade scripts will be removed from the schema_version table leaving holes in the numbering (so we could have <code class="language-plaintext highlighter-rouge">0070</code> and after it <code class="language-plaintext highlighter-rouge">0100</code> for example).
This removal will be done using a regular upgrade script in order to execute it only once.</p>

<p>The <code class="language-plaintext highlighter-rouge">pre_upgrade</code> directory will be used only to resolve cases as we have already upstream where patch <code class="language-plaintext highlighter-rouge">0130</code> was installed (for 3.1) and after that <code class="language-plaintext highlighter-rouge">0250</code> was cherry picked,
blocking the possibility of the upgrade procedure to install patches <code class="language-plaintext highlighter-rouge">0140</code> to <code class="language-plaintext highlighter-rouge">0240</code>.
In this case we will add a script to the <code class="language-plaintext highlighter-rouge">pre_upgrade</code> directory that will remove the <code class="language-plaintext highlighter-rouge">0250</code> entry from schema_version, since <code class="language-plaintext highlighter-rouge">0250</code> is a configuration patch we have no problems with it,
but we should avoid such situation following this:</p>

<h3 id="version-squashing">Version Squashing</h3>

<p>To avoid high number of upgrade script files we can squash each version files to a single file after it is published.
Since upgrade scripts contains both schema and data changes, this issue is open for suggestion and will be implemented in future.</p>

<h3 id="temporary-functions-in-upgrade-scripts">Temporary Functions in Upgrade scripts</h3>

<p>Temporary functions in upgrade scripts should be renamed <code class="language-plaintext highlighter-rouge">__temp_&lt;name&gt;</code> This is in order to distinguish them from real persistent functions and preventing
the chance to drop such a function by mistake in an upgrade script.</p>

<h2 id="where-are-upgrade-scripts-located">Where are upgrade scripts located?</h2>

<p>All changes should be located under the <code class="language-plaintext highlighter-rouge">upgrade/</code> directory</p>

<p>In which order upgrade scripts are called? Upgrade scripts are sorted and executed alphabetically, that’s why it is important to follow the upgrade script naming convention.</p>

<h2 id="when-upgrade-scripts-are-called">When upgrade scripts are called?</h2>

<p>Clean Install In clean install this is done after initial (default) data is inserted to the database This makes sure that default data is inserted on
initial schema before any upgrade script change it.</p>

<p>Upgrade In upgrade we first drop all SPs &amp; Views and then run all upgrade scripts and finally restore views &amp; SPs</p>

<h2 id="which-files-should-not-be-changed">Which files should not be changed?</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">create_tables.sql</code></li>
  <li><code class="language-plaintext highlighter-rouge">insert_data.sql</code></li>
  <li><code class="language-plaintext highlighter-rouge">insert_predefined_roles.sql</code></li>
  <li><code class="language-plaintext highlighter-rouge">fill_config.sql</code></li>
</ul>

<h2 id="what-should-i-do-if-i-have-to-">What should I do if I have to ?</h2>

<table class="bordered">
  <tbody>
    <tr>
      <td>Add or change a column</td>
      <td>Add an upgrade script</td>
    </tr>
    <tr>
      <td>Add/Delete/Modify/Split configuration values</td>
      <td>Modify <code class="language-plaintext highlighter-rouge">config.sql</code> script in <code class="language-plaintext highlighter-rouge">pre_upgrade</code> directory using common <code class="language-plaintext highlighter-rouge">fn_db*</code> functions</td>
    </tr>
    <tr>
      <td>Add/Delete/Modify any default data</td>
      <td>Add an upgrade script</td>
    </tr>
    <tr>
      <td>Add/Delete/Modify a SP</td>
      <td>Change only the relevant <code class="language-plaintext highlighter-rouge">*_sp.sql</code> file</td>
    </tr>
    <tr>
      <td>Add/Delete/Modify a View</td>
      <td>Change only the relevant code in <code class="language-plaintext highlighter-rouge">create_views.sql</code> file</td>
    </tr>
  </tbody>
</table>

<p>Please note that if you change configuration value it is safer to use <code class="language-plaintext highlighter-rouge">fn_db_update_default_config_value</code> rather than <code class="language-plaintext highlighter-rouge">fn_db_update_config_value</code>.</p>

<p>Consider the following example:</p>

<ol>
  <li>we have a comma delimited configuration value for key X “a,b,c”</li>
  <li>user u1 creates an upgrade script adding d using <code class="language-plaintext highlighter-rouge">fn_db_update_config_value</code> =&gt; value in db is “a,b,c,d”</li>
  <li>user u2 creates an upgrade script adding e using <code class="language-plaintext highlighter-rouge">fn_db_update_config_value</code> =&gt; value in db is “a,b,c,e” , “d” is lost.</li>
</ol>

<p>Calling <code class="language-plaintext highlighter-rouge">fn_db_update_default_config_value</code> in 2) and 3) will result with 2) success and 3) fail</p>

<p>Since 3) will look for “a,b,c” that was already updated by 2) to “a,b,c,d” then the writer of 3) (u2) will check the script failure and update it to include the correct value:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">fn_db_update_default_config_value</span><span class="p">(</span><span class="s1">'X'</span><span class="p">,</span> <span class="s1">'a,b,c,d'</span><span class="p">,</span> <span class="s1">'a,b,c,d,e'</span><span class="p">,</span> <span class="s1">'`&lt;version&gt;`'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="what-are-the-helper-functions-i-can-use-in-my-upgrade-scripts">What are the helper functions I can use in my upgrade scripts?</h2>

<table class="bordered">
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_add_column</code></td>
      <td>Adds a column to a table</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_change_column_type</code></td>
      <td>Changes a column type,decimal precision etc. (Several formats)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_add_config_value</code></td>
      <td>Adds a new value to vdc_options</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_update_default_config_value</code></td>
      <td>Updates the value of an option in vdc_options if given default was not   changed.You can also define if your condition is case-sensitive or not</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_delete_config_value</code></td>
      <td>Deletes an option from vdc_options</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fn_db_split_config_value</code></td>
      <td>Given general configuration entry, creates new entries for each old cluster version, with the old value, and a new entry for the newest cluster version with the input value</td>
    </tr>
  </tbody>
</table>

<h2 id="examples">Examples</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">fn_db_add_column</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'group_ids'</span><span class="p">,</span> <span class="s1">'VARCHAR(2048)'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'storage_pool'</span><span class="p">,</span><span class="s1">'storage_pool_format_type'</span><span class="p">,</span><span class="s1">'integer'</span><span class="p">,</span><span class="s1">'varchar(50)'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span><span class="s1">'age'</span><span class="p">,</span><span class="s1">'int2'</span><span class="p">,</span><span class="s1">'int4 not null default 0'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'vm_statistics'</span><span class="p">,</span><span class="s1">'cpu_user'</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">'decimal(18,3)'</span><span class="p">);</span><span class="c1">-- change decimal scale.</span>
<span class="k">select</span> <span class="n">fn_db_add_config_value</span><span class="p">(</span><span class="s1">'VdcVersion'</span><span class="p">,</span><span class="s1">'3.0.0.0'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_update_config_value</span><span class="p">(</span><span class="s1">'DBEngine'</span><span class="p">,</span><span class="s1">'Postgres'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_update_default_config_value</span><span class="p">(</span><span class="s1">'LDAPSecurityAuthentication'</span><span class="p">,</span><span class="s1">'GSSAPI'</span><span class="p">,</span><span class="s1">'default:GSSAPI'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">,</span><span class="k">false</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_delete_config_value</span><span class="p">(</span><span class="s1">'ENMailEnableSsl'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
<span class="k">select</span> <span class="n">fn_db_split_config_value</span><span class="p">(</span><span class="s1">'SpiceSecureChannels'</span><span class="p">,</span><span class="s1">'all'</span><span class="p">);</span>
</code></pre></div></div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2987/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2987/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2987/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2987/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/internal/database-upgrade-procedure.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/internal/database-upgrade-procedure.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
