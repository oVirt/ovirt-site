<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>VDSM-Hooks | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="VDSM-Hooks" />
<meta name="author" content="Dan Yasny" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2672/develop/developer-guide/vdsm/hooks.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2672/develop/developer-guide/vdsm/hooks.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VDSM-Hooks" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dan Yasny" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Dan Yasny"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2672/images/logo.svg"},"name":"Dan Yasny"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"VDSM-Hooks","url":"https://ovirt.github.io/ovirt-site/previews/2672/develop/developer-guide/vdsm/hooks.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2672/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2672/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2672/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2672/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2672/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2672/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2672/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2672/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2672/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2672/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2672/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2672/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2672/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2672/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2672/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2672/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2672/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2672/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2672/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2672/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2672/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2672/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2672/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2672/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2672/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2672/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2672/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2672/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2672/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2672/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2672/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2672/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2672/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2672/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2672/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2672//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2672//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2672/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2672/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2672/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2672/develop/developer-guide/vdsm/">
              <span property="name">Vdsm</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/96683d5c86aced90f8fbb458c5d11a6b?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/96683d5c86aced90f8fbb458c5d11a6b?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Yasny</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard"></span><a rel="author" href="https://twitter.com/sandrobonazzola" title="Sandro Bonazzola">Sandro Bonazzola</a></span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="vdsm-hooks">VDSM-Hooks</h1>

<p>VDSM Hooks are a means to insert arbitrary commands and scripts at certain point in a VM’s lifecycle as well as in VDSM daemon’s lifecycle. VDSM, when entering a certain checkpoint in a VM’s execution cycle, will check whether there is a hook present for that point, and if a hook is found, it will be executed.</p>

<p><a href="/ovirt-site/previews/2672/develop/developer-guide/vdsm/hooks-catalogue.html">VDSM-Hooks Catalogue</a></p>

<p>The current repository of built hooks can be found at:</p>

<p>Fedora 19: <a href="http://resources.ovirt.org/pub/ovirt-3.4/rpm/fc19/noarch/">http://resources.ovirt.org/pub/ovirt-3.4/rpm/fc19/noarch/</a></p>

<p>Fedora 20: <a href="http://resources.ovirt.org/pub/ovirt-3.4/rpm/fc20/noarch/">http://resources.ovirt.org/pub/ovirt-3.4/rpm/fc20/noarch/</a></p>

<p>EL6: <a href="http://resources.ovirt.org/pub/ovirt-3.4/rpm/el6/noarch/">http://resources.ovirt.org/pub/ovirt-3.4/rpm/el6/noarch/</a></p>

<p>The hooks reside on every host in /usr/libexec/vdsm/hooks/ A hook can be any executable (bash/python/perl/binary/etc).</p>

<p>Here is the complete list:</p>

<p><em>before_vdsm_start</em> <em>after_vdsm_stop</em> These can be used to insert additional command sets before the vdsmd daemon starts and after it stops, this hook is not related specifically to VMs.</p>

<p><em>before_vm_start</em> <em>after_vm_start</em> These are executed before vdsmd passes a VM start command to libvirt, and afterwards. The flow is as follows: Engine is ordered to start a VM, it gathers the required parameters, and passed a createVM command to vdsmd on a host vdsmd gathers the parameters provided by Engine, and then executes the before_vm_start hook. At this point it is possible to alter the VM configuration on the fly, that will be discussed later on. After the hook is done running, vdsmd will start the VM by passing the parameters down to libvirt. Once the VM is started, vdsmd can execute an after_vm_start hook, usually a good place to finalize VM startup flows</p>

<p><em>before_vm_destroy</em> <em>after_vm_destroy</em> When Engine stops a VM, it passes a vmStop command to vdsmd, which receives the command, executes the before_vm_stop hooks, and then sends the VM a stop command. After the VM is down, after_vm_destroy hooks are called.</p>

<p><em>before_vm_pause</em> <em>after_vm_pause</em> When Engine pauses a VM, vdsmd will receive the pause command, execute the before_vm_pause hooks, and pause the VM. After the VM is paused, the after_vm_pause hooks will be called.</p>

<p><em>before_vm_cont</em> <em>after_vm_cont</em> When Engine unpauses (continues) a VM, vdsmd will receive the continue command, execute the before_vm_cont hooks, and un-pause the VM. After the VM is up and running, the after_vm_cont hooks will be called.</p>

<p><em>before_vm_hibernate</em> <em>after_vm_hibernate</em> When Engine sends a command to hibernate a VM, vdsmd will receive the hibernate command, execute the before_vm_hibernate hooks, and place the VM in hibernation mode. After the VM is hibernating, the after_vm_hibernate hooks will be called.</p>

<p>'’before_vm_dehibernate ‘’ <em>after_vm_dehibernate</em> When Engine sends a command to dehibernate a VM, vdsmd will receive the dehibernate command, execute the before_vm_dehibernate hooks, and then take the VM out of hibernation. After the VM is up and running, the after_vm_hibernate hooks will be called.</p>

<p><em>before_vm_migrate_source</em> <em>after_vm_migrate_source</em> These are called on the source migration host. Before the VM is live-migrated, before_vm_migrate_source hooks are called, and only then will vdsmd start the VM migration process. After the process is complete, after_vm_migrate_source hooks are executed</p>

<p><em>before_vm_migrate_destination</em> <em>after_vm_migrate_destination</em> These are called on the destination migration host. Before the VM is live-migrated, before_vm_migrate_destination hooks are called, and only then will vdsmd start receiving the migrating VM from the migration source host. After the process is complete, after_vm_migrate_destination hooks are executed</p>

<hr />

<p>Besides a simple script execution, there is a mechanism that allows us to connect specific VMs to hooks. This is done by using the vdsm hooking module, through which the VM runtime parameters can be obtained, parsed and acted upon. It is possible to either execute specific scripts if specific standard VM parameters (like VM name or VM UUID) are detected, or by looking for VM’s custom properties, and acting upon those. A custom property can be defined in RHEV-M and attached to a VM. It can be just a property as such (and a hook will simply check for it’s existence) or it can contain it’s own parameters (and the hook can take the property and it’s paramaters, parse them and perform actions specific to these custom parameters).</p>

<p>VMs are defined by an XML-formatted property list Example:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">'kvm'</span> <span class="na">id=</span><span class="s">'1'</span><span class="nt">&gt;</span>
 <span class="nt">&lt;name&gt;</span>myvm<span class="nt">&lt;/name&gt;</span>
 <span class="nt">&lt;uuid&gt;</span>3573e29e-5de9-468a-9fae-16050c6b3dcc<span class="nt">&lt;/uuid&gt;</span>
 <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>524288<span class="nt">&lt;/memory&gt;</span>
 <span class="nt">&lt;currentMemory</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>524288<span class="nt">&lt;/currentMemory&gt;</span>
 <span class="nt">&lt;vcpu</span> <span class="na">placement=</span><span class="s">'static'</span><span class="nt">&gt;</span>1<span class="nt">&lt;/vcpu&gt;</span>
 <span class="nt">&lt;cputune&gt;</span>
   <span class="nt">&lt;shares&gt;</span>1020<span class="nt">&lt;/shares&gt;</span>
 <span class="nt">&lt;/cputune&gt;</span>
 <span class="nt">&lt;sysinfo</span> <span class="na">type=</span><span class="s">'smbios'</span><span class="nt">&gt;</span>
   <span class="nt">&lt;system&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">name=</span><span class="s">'manufacturer'</span><span class="nt">&gt;</span>Red Hat<span class="nt">&lt;/entry&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">name=</span><span class="s">'product'</span><span class="nt">&gt;</span>RHEV Hypervisor<span class="nt">&lt;/entry&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">name=</span><span class="s">'version'</span><span class="nt">&gt;</span>6Server-6.3.0.3.el6<span class="nt">&lt;/entry&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">name=</span><span class="s">'serial'</span><span class="nt">&gt;</span>C0F9945F-3F73-B601-CE49-001A647A9462_00:1A:64:7A:94:62<span class="nt">&lt;/entry&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">name=</span><span class="s">'uuid'</span><span class="nt">&gt;</span>3573e29e-5de9-468a-9fae-16050c6b3dcc<span class="nt">&lt;/entry&gt;</span>
   <span class="nt">&lt;/system&gt;</span>
 <span class="nt">&lt;/sysinfo&gt;</span>
 <span class="nt">&lt;os&gt;</span>
   <span class="nt">&lt;type</span> <span class="na">arch=</span><span class="s">'x86_64'</span> <span class="na">machine=</span><span class="s">'rhel6.2.0'</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
   <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">'hd'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;smbios</span> <span class="na">mode=</span><span class="s">'sysinfo'</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/os&gt;</span>
 <span class="nt">&lt;features&gt;</span>
   <span class="nt">&lt;acpi/&gt;</span>
 <span class="nt">&lt;/features&gt;</span>
 <span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'custom'</span> <span class="na">match=</span><span class="s">'exact'</span><span class="nt">&gt;</span>
   <span class="nt">&lt;model</span> <span class="na">fallback=</span><span class="s">'allow'</span><span class="nt">&gt;</span>Conroe<span class="nt">&lt;/model&gt;</span>
   <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">'1'</span> <span class="na">cores=</span><span class="s">'1'</span> <span class="na">threads=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/cpu&gt;</span>
 <span class="nt">&lt;clock</span> <span class="na">offset=</span><span class="s">'variable'</span> <span class="na">adjustment=</span><span class="s">'0'</span><span class="nt">&gt;</span>
   <span class="nt">&lt;timer</span> <span class="na">name=</span><span class="s">'rtc'</span> <span class="na">tickpolicy=</span><span class="s">'catchup'</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/clock&gt;</span>
 <span class="nt">&lt;on_poweroff&gt;</span>destroy<span class="nt">&lt;/on_poweroff&gt;</span>
 <span class="nt">&lt;on_reboot&gt;</span>restart<span class="nt">&lt;/on_reboot&gt;</span>
 <span class="nt">&lt;on_crash&gt;</span>destroy<span class="nt">&lt;/on_crash&gt;</span>
 <span class="nt">&lt;devices&gt;</span>
   <span class="nt">&lt;emulator&gt;</span>/usr/libexec/qemu-kvm<span class="nt">&lt;/emulator&gt;</span>
   <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'block'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span> <span class="na">cache=</span><span class="s">'none'</span> <span class="na">error_policy=</span><span class="s">'stop'</span> <span class="na">io=</span><span class="s">'native'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">'/rhev/data-center/9fd8d38c-218e-4e8c-a78f-2895b447de0d/b3ecfe84-9f03-4245-b34a-131174cfdfc3/images/2b6843e5-b2fd-4007-b0fa-4aaa66515a31/73da4394-e024-4bc5-a440-e4672bfcfd85'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vda'</span> <span class="na">bus=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;serial&gt;</span>07-b0fa-4aaa66515a31<span class="nt">&lt;/serial&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'virtio-disk0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x07'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/disk&gt;</span>
   <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">device=</span><span class="s">'cdrom'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'hdc'</span> <span class="na">bus=</span><span class="s">'ide'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;readonly/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'ide0-1-0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'drive'</span> <span class="na">controller=</span><span class="s">'0'</span> <span class="na">bus=</span><span class="s">'1'</span> <span class="na">target=</span><span class="s">'0'</span> <span class="na">unit=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/disk&gt;</span>
   <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">'virtio-serial'</span> <span class="na">index=</span><span class="s">'0'</span> <span class="na">ports=</span><span class="s">'16'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'virtio-serial0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x06'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/controller&gt;</span>
   <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">'ide'</span> <span class="na">index=</span><span class="s">'0'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'ide0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x01'</span> <span class="na">function=</span><span class="s">'0x1'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/controller&gt;</span>
   <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">'usb'</span> <span class="na">index=</span><span class="s">'0'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'usb0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x01'</span> <span class="na">function=</span><span class="s">'0x2'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/controller&gt;</span>
   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'bridge'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'00:1a:4a:23:18:01'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">'rhevm'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vnet0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'net0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x03'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/interface&gt;</span>
   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'bridge'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'00:1a:4a:23:18:02'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">'rhevm'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vnet1'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'net1'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x04'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/interface&gt;</span>
   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'bridge'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'00:1a:4a:23:18:03'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">'rhevm'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vnet2'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'net2'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x05'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/interface&gt;</span>
   <span class="nt">&lt;channel</span> <span class="na">type=</span><span class="s">'unix'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;source</span> <span class="na">mode=</span><span class="s">'bind'</span> <span class="na">path=</span><span class="s">'/var/lib/libvirt/qemu/channels/myvm.com.redhat.rhevm.vdsm'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">'virtio'</span> <span class="na">name=</span><span class="s">'com.redhat.rhevm.vdsm'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'channel0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'virtio-serial'</span> <span class="na">controller=</span><span class="s">'0'</span> <span class="na">bus=</span><span class="s">'0'</span> <span class="na">port=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/channel&gt;</span>
   <span class="nt">&lt;channel</span> <span class="na">type=</span><span class="s">'spicevmc'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">'virtio'</span> <span class="na">name=</span><span class="s">'com.redhat.spice.0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'channel1'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'virtio-serial'</span> <span class="na">controller=</span><span class="s">'0'</span> <span class="na">bus=</span><span class="s">'0'</span> <span class="na">port=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/channel&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'mouse'</span> <span class="na">bus=</span><span class="s">'ps2'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;graphics</span> <span class="na">type=</span><span class="s">'spice'</span> <span class="na">port=</span><span class="s">'5900'</span> <span class="na">tlsPort=</span><span class="s">'5901'</span> <span class="na">autoport=</span><span class="s">'yes'</span> <span class="na">listen=</span><span class="s">'0'</span> <span class="na">keymap=</span><span class="s">'en-us'</span> <span class="na">passwdValidTo=</span><span class="s">'1970-01-01T00:00:01'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;listen</span> <span class="na">type=</span><span class="s">'address'</span> <span class="na">address=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;channel</span> <span class="na">name=</span><span class="s">'main'</span> <span class="na">mode=</span><span class="s">'secure'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;channel</span> <span class="na">name=</span><span class="s">'inputs'</span> <span class="na">mode=</span><span class="s">'secure'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/graphics&gt;</span>
   <span class="nt">&lt;video&gt;</span>
     <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'qxl'</span> <span class="na">vram=</span><span class="s">'65536'</span> <span class="na">heads=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'video0'</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x00'</span> <span class="na">slot=</span><span class="s">'0x02'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/video&gt;</span>
   <span class="nt">&lt;memballoon</span> <span class="na">model=</span><span class="s">'none'</span><span class="nt">&gt;</span>
     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'balloon0'</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/memballoon&gt;</span>
 <span class="nt">&lt;/devices&gt;</span>
 <span class="nt">&lt;seclabel</span> <span class="na">type=</span><span class="s">'dynamic'</span> <span class="na">model=</span><span class="s">'selinux'</span> <span class="na">relabel=</span><span class="s">'yes'</span><span class="nt">&gt;</span>
   <span class="nt">&lt;label&gt;</span>system_u:system_r:svirt_t:s0:c183,c514<span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;imagelabel&gt;</span>system_u:object_r:svirt_image_t:s0:c183,c514<span class="nt">&lt;/imagelabel&gt;</span>
 <span class="nt">&lt;/seclabel&gt;</span>
<span class="nt">&lt;/domain&gt;</span>
</code></pre></div></div>

<p>This xml can be changed in order to alter the VM settings in ways ovirt-engine doesn’t support directly.</p>

<p><strong>NOTE</strong>: Only the before_vm_start hooks are actually able to alter the VM’s xml definitions, this is due to the fact that once the xml definitions are passed to libvirt, they cannot be changed as long as the VM is running. All other VM related hooks can access the VM’s xml definitions, but in read-only mode.</p>

<p><strong>Writing VDSM hooks:</strong></p>

<p>Currently, the hooking module only exists in python. Here is an example of a simple vdsm hook that blocks a VM’s live migration: 50_cant_migrate.py placed in before_VM_migrate_source. This hook looks for a custom property calles “cantmigrate” and if it is found, will block the VM from migrating. This can be useful for VMs that rely on a specific resource found only locally on a specific host (like a passed through USB license dongle or a TBU)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span> 
<span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">'cantmigrate'</span><span class="p">):</span>
   <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'cantmigrate: before_vm_migrate_source: cannot migrate this VM</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
   <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>This script does not use the hooking module, because it does not need to actually act upon the VM’s specific XML.</p>

<p>And this is an example that uses the Hooking module to read a custom property that defines CPU pinning for a VM, and alters the VM’s XML accordingly:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python 
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">hooking</span>
<span class="kn">import</span> <span class="nn">traceback</span>
    
<span class="c1">#pincpu usages
#=============
#pincpu="0" (use the first cpu)
#pincpu="1-4" (use cpus 1-4)
#pincpu="^3" (don't use cpu 3)
#pincpu="1-4,^3,6" (or all together)
</span>  
<span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">'pincpu'</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
       <span class="n">domxml</span> <span class="o">=</span> <span class="n">hooking</span><span class="p">.</span><span class="n">read_domxml</span><span class="p">()</span>   <span class="c1">#here we read the VM XML into the domxml variable
</span>       <span class="n">vcpu</span> <span class="o">=</span> <span class="n">domxml</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'vcpu'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#find and read the CPU definition in the VM XML
</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s">'cpuset'</span><span class="p">):</span>
          <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'pincpu: pinning cpu to: %s</span><span class="se">\n</span><span class="s">'</span> <span class="o">%</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'pincpu'</span><span class="p">])</span>  <span class="c1">#sys.stderr.write is caught by vdsm and logged into vdsm.log for debugging
</span>          <span class="n">vcpu</span><span class="p">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s">'cpuset'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'pincpu'</span><span class="p">])</span>  <span class="c1">#change an attribute here
</span>          <span class="n">hooking</span><span class="p">.</span><span class="n">write_domxml</span><span class="p">(</span><span class="n">domxml</span><span class="p">)</span>                       <span class="c1">#and write to the altered domxml
</span>       <span class="k">else</span><span class="p">:</span>
          <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'pincpu: cpuset attribute is present in vcpu, doing nothing</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
       <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'pincpu: [unexpected error]: %s</span><span class="se">\n</span><span class="s">'</span> <span class="o">%</span> <span class="n">traceback</span><span class="p">.</span><span class="n">format_exc</span><span class="p">())</span>
       <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2672/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2672/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2672/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2672/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/vdsm/hooks.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/developer-guide/vdsm/hooks.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
