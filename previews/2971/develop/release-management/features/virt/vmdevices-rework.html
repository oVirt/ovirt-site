<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>VmDevices rework | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="VmDevices rework" />
<meta name="author" content="Dan Kenigsberg" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2971/develop/release-management/features/virt/vmdevices-rework.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2971/develop/release-management/features/virt/vmdevices-rework.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VmDevices rework" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dan Kenigsberg" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Dan Kenigsberg"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"VmDevices rework","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2971/images/logo.svg"},"name":"Dan Kenigsberg"},"url":"https://ovirt.github.io/ovirt-site/previews/2971/develop/release-management/features/virt/vmdevices-rework.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2971/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2971/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2971/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2971/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2971/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2971/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2971/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2971/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2971/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2971/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2971/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2971/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2971/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2971/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2971/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2971/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2971/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2971/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2971/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2971/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2971/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2971/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2971//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2971//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2971/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2971/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2971/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2971/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2971/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Dan Kenigsberg">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ae1cdbedb9e9b2211596267db7af9a2c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ae1cdbedb9e9b2211596267db7af9a2c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Martin Polednik">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Martin Polednik</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2971/documentation/'>Documentation is available here.</a></div>

<h1 id="vmdevices-rework">VmDevices rework</h1>

<h2 id="summary">Summary</h2>

<p>This feature will track the refactoring and reworking of VmDevices inside VDSM.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Martin Polednik (Martin Polednik)</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Last updated date: Thu Apr 28 2015</li>
  <li><a href="https://gerrit.ovirt.org/#/q/status:open+project:vdsm+branch:master+topic:device_isolation">gerrit topic branch</a></li>
</ul>

<h2 id="what-is-wrong-with-current-state">What is wrong with current state</h2>

<ul>
  <li>Information duplication - the data is kept in device objects AND self.conf[‘devices’] dictionary</li>
  <li>Most of the functionality is in the VM class itself (while device modules would be more suitable)</li>
  <li>Above goes for legacy device configuration and getUnderlying* family of methods</li>
  <li>The code is not well tested</li>
  <li>libvirt XML parsing and processing is ineffective - it loops all device elements in libvirt XML for every device, leading to quadratic asymptotic time complexity</li>
</ul>

<h2 id="formal-naming-system">Formal naming system</h2>

<p>Currently, there are multiple representations of a device in its lifetime inside VDSM. In order to work with them, it makes sense to formalize the naming of representations:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">{'device': '...', 'type': '...', 'deviceId', ...}</code> is the format in which the device is specified in configuration sent from engine. We will call this a <i>device specification</i> <code class="language-plaintext highlighter-rouge">dev_spec</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">[device_spec]</code> denotes a list of device specifications. Let’s call it <i>device specification list<i> <code class="language-plaintext highlighter-rouge">dev_spec_list</code>.</i></i></li>
  <li>Legacy VM conf section will be called <i>legacy conf</i>.</li>
  <li>And current VM conf section <i>conf</i>.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;Sound object at...&gt;</code> is python object representing the device, <i>device object</i> <code class="language-plaintext highlighter-rouge">dev_object</code> and plural <i>device objects</i> <code class="language-plaintext highlighter-rouge">dev_objects</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">{device_type: [device_object]}</code> is an internal format of VM’s _devices, that we will call <i>device mapping</i> <code class="language-plaintext highlighter-rouge">dev_map</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">{device_type: [device_spec]}</code> is a format used for transition from device specification list to device mapping - <i>device specification map</i> <code class="language-plaintext highlighter-rouge">dev_spec_map</code>.</li>
  <li>When initializing an empty structure, prefix with <code class="language-plaintext highlighter-rouge">empty</code>.</li>
</ul>

<!-- -->

<ul>
  <li>Type of the device is <code class="language-plaintext highlighter-rouge">dev_type</code>. Examples: sound device, disk devices, host devices, …</li>
  <li>Class of the device is <code class="language-plaintext highlighter-rouge">dev_class</code>. Examples: <code class="language-plaintext highlighter-rouge">Drive</code>, <code class="language-plaintext highlighter-rouge">NetworkInterfaceDevice</code>, <code class="language-plaintext highlighter-rouge">GraphicsDevice</code>, …</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">dev_</code> prefix can be omitted if for each occurrence of function/method call there exists a *device* word in one of the namespaces accessed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  PEP8: we're trying to make the code as consistent as possible while slowly converting everything to be pep8 compliant. Therefore, following rules can be used:
</code></pre></div></div>

<ul>
  <li>use pep8 conventions in new modules,</li>
  <li>use pep8 conventions in old module if the code is about to move,</li>
  <li>stay consistent within the file.</li>
</ul>

<h2 id="phase-1---vmpy-diet">Phase 1 - vm.py diet</h2>

<p>Using the names defined above, the first phase of devices rework will consist of removing device-specific code in vm.py and moving it to vmdevices/${device}.py, using consistent naming conventions. One of the first thing is isolating device object creation from _run method of VM class. This will allow us to work with multiple device objects in unit tests, possibly leading to better tests.</p>

<h3 id="phase-11">Phase 1.1</h3>

<p>VM class’s _run method contains a code that, given a device mapping, generates device objects and stores them in VM._devices attribute. The first step is simply moving this code to a new method and naming it correctly: <code class="language-plaintext highlighter-rouge">devObjectsFromDevMap</code> (lowerCamelCase for the sake of consistency). This is also opportunity to rename <code class="language-plaintext highlighter-rouge">buildConfDevices</code> to something a bit more descriptive and accurate: <code class="language-plaintext highlighter-rouge">devSpecMapFromConf</code>. The flow inside VDSM will therefore be</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def _run():
    ...
    dev_spec = devSpecMapFromConf()
    ...
    self._devices = devMapFromDevSpecMap(dev_spec)
</code></pre></div></div>

<h3 id="phase-12">Phase 1.2</h3>

<p>Legacy configuration had lower number of devices than current conf has. There exists a code that, given legacy conf, returns correct specification list. These devices are Drive, NetworkInterfaceController, Sound, Video, Graphics and Controller. The legacy methods called getConf${device} are currently in VM class. One possible destination for these methods are the device modules (not the classes). Moving them and respecting pep8 yields module functions <code class="language-plaintext highlighter-rouge">spec_list_from_legacy_conf</code>. This also requires purification of the methods, which isn’t exactly complex because each one of them contains reference to VM’s conf and possibly arch. Therefore, to make them easily iterable, the final signature should be <code class="language-plaintext highlighter-rouge">spec_list_from_legacy_conf(conf, arch)</code>.</p>

<h3 id="phase-13">Phase 1.3</h3>

<p>Support for engine &lt;3.3 was removed in <a href="https://gerrit.ovirt.org/#/c/40104/">https://gerrit.ovirt.org/#/c/40104/</a> and therefore, legacy code for device creation shouldn’t really exist. Complication is that there may be tests using this legacy configuration, therefore simple removal may not be the best solution. The methods used for legacy devices should therefore be marked as deprecated in the documentation (if they are documented at all) and should at least log some deprecation warning.</p>

<h2 id="phase-2---reading-libvirt-xml">Phase 2 - Reading libvirt XML</h2>

<p>Some (most?) of the device types have a code to parse the libvirt XML, find the device in device mapping and update it according to the real specification in libvirt’s XML. The code is currently encapsulated in methods called <code class="language-plaintext highlighter-rouge">getUnderlying${device_class}DeviceInfo</code> in class VM (vm.py). There are multiple issues with the code and it’s placement, therefore we will need few phases to get it somewhat correct.</p>

<h3 id="phase-21">Phase 2.1</h3>

<p>First, the code accesses internal VM attributes such as <code class="language-plaintext highlighter-rouge">_devices</code> and <code class="language-plaintext highlighter-rouge">conf['devices']</code>(possibly more) and cannot be moved as they are. To move them, we need to make them pure and then the move is possible - because it doesn’t really change functionality or anything, this can be done in a single step. Two methods must be kept at this point: getUnderlyingDeviceInfo and getUnderlyingUnknownDeviceInfo. The former is entry point for the moved function while the later one, as the name suggests, parses the devices that aren’t known to VDSM.</p>

<h3 id="phase-22">Phase 2.2</h3>

<h2 id="final-goal">Final Goal</h2>

<p>The device classes and modules would hold all methods, data and classes necessary to fully maintain the device. vm.py file, with a bit of luck, can be reduced by up to ~700 lines. conf[‘devices’] and _devices would be merged into a single entity that provides interface for legacy access but internally keeps all the information in device objects.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2971/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2971/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2971/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2971/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/vmdevices-rework.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/vmdevices-rework.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
