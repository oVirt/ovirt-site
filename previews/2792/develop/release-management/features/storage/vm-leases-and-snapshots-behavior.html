<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>VM leases and snapshots behavior | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="VM leases and snapshots behavior" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2792/develop/release-management/features/storage/vm-leases-and-snapshots-behavior.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2792/develop/release-management/features/storage/vm-leases-and-snapshots-behavior.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VM leases and snapshots behavior" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2792/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"VM leases and snapshots behavior","url":"https://ovirt.github.io/ovirt-site/previews/2792/develop/release-management/features/storage/vm-leases-and-snapshots-behavior.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2792/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2792/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2792/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2792/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2792/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2792/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2792/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2792/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2792/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2792/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2792/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2792/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2792/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2792/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2792/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2792/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2792/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2792/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2792/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2792/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2792/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2792/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2792/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2792/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2792/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2792/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2792/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2792/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2792/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2792/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2792/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2792/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2792/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2792/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2792/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2792//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2792//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2792/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2792/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2792/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2792/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2792/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c570d197071df880a1c71bd2388cd135?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c570d197071df880a1c71bd2388cd135?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eyal Shenitzky</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2792/documentation/'>Documentation is available here.</a></div>

<h1 id="vm-leases-and-snapshots-behavior">VM leases and snapshots behavior</h1>

<h2 id="summary">Summary</h2>

<p>Aligns the behavior of VM with a lease and VM snapshots operations.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Eyal Shenitzky</li>
</ul>

<h2 id="description">Description</h2>
<p>The VM leases feature was introduced in oVirt engine 4.1 version.
This feature adds the ability to acquire a lease per VM on shared storage in order to avoid split-brain, 
and starting a VM on another host if the original host becomes non-responsive.</p>

<p>Few improvements were made in oVirt 4.2.2.1 version which aligns the behavior of VM with a lease and VM snapshots operations:</p>
<ul>
  <li>Preview VM snapshot</li>
  <li>Undo VM snapshot</li>
  <li>
    <p>Commit VM snapshot</p>
  </li>
  <li>
    <h3 id="preview-vm-snapshot">Preview VM snapshot:</h3>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-the-same-domain">- In case the active snapshot and the previewed snapshot has a lease on the same domain:</h4>
    <p>The VM will use the existing lease.</p>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-different-domains">- In case the active snapshot and the previewed snapshot has a lease on different domains:</h4>
    <p>The VM will use the active snapshot lease.</p>
    <h4 id="--in-case-the-active-snapshot-has-a-lease-but-the-previewed-snapshot-doesnt-have-a-lease">- In case the active snapshot has a lease but the previewed snapshot doesn’t have a lease:</h4>
    <p>The VM will not use the active snapshot lease, but the lease will not be removed until the snapshot will be committed.</p>
    <h4 id="--in-case-the-active-snapshot-doesnt-have-a-lease-but-the-previewed-snapshot-has-a-lease">- In case the active snapshot doesn’t have a lease but the previewed snapshot has a lease:</h4>
    <p>A new VM lease will create for the VM on the storage domain which held the lease while the snapshot was taken.
If the storage domain doesn’t exist anymore, the preview will fail and the user can perform custom preview and choose
whether the preview should contain the lease and on which domain.</p>
  </li>
  <li>
    <h3 id="undo-vm-snapshot">Undo VM snapshot:</h3>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-the-same-domain-1">- In case the active snapshot and the previewed snapshot has a lease on the same domain:</h4>
    <p>The VM will use the existing lease.</p>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-different-domains-1">- In case the active snapshot and the previewed snapshot has a lease on different domains:</h4>
    <p>The VM will use the active snapshot lease.</p>
    <h4 id="--in-case-the-active-snapshot-has-a-lease-but-the-previewed-snapshot-doesnt-have-a-lease-1">- In case the active snapshot has a lease but the previewed snapshot doesn’t have a lease:</h4>
    <p>The VM will return to use the active snapshot lease.</p>
    <h4 id="--in-case-the-active-snapshot-doesnt-have-a-lease-but-the-previewed-snapshot-has-a-lease-1">- In case the active snapshot doesn’t have a lease but the previewed snapshot has a lease:</h4>
    <p>The VM lease that was created for the preview will be removed and the VM will return to use the active snapshot lease.</p>
  </li>
  <li>
    <h3 id="commit-vm-snapshot">Commit VM snapshot:</h3>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-the-same-domain-2">- In case the active snapshot and the previewed snapshot has a lease on the same domain:</h4>
    <p>The VM will use the existing lease.</p>
    <h4 id="--in-case-the-active-snapshot-and-the-previewed-snapshot-has-a-lease-on-different-domains-2">- In case the active snapshot and the previewed snapshot has a lease on different domains:</h4>
    <p>The VM will use the active snapshot lease.</p>
    <h4 id="--in-case-the-active-snapshot-has-a-lease-but-the-previewed-snapshot-doesnt-have-a-lease-2">- In case the active snapshot has a lease but the previewed snapshot doesn’t have a lease:</h4>
    <p>The active snapshot lease will be removed from the storage domain and the VM will not use any lease.</p>
    <h4 id="--in-case-the-active-snapshot-doesnt-have-a-lease-but-the-previewed-snapshot-has-a-lease-2">- In case the active snapshot doesn’t have a lease but the previewed snapshot has a lease:</h4>
    <p>The VM will use the lease that was created for the preview.</p>
  </li>
  <li>
    <h3 id="custom-preview-to-a-snapshot-with-a-lease">Custom preview to a snapshot with a lease:</h3>
    <p>It is possible to customize the preview of a snapshot and select whether the preview will include 
the VM lease or not.
Moreover, it is possible to select the VM lease from a different snapshot.
When performing a custom preview, the selected VM lease will be created even if the active snapshot 
has a lease.
This behavior is different than the regular preview, the active snapshot VM lease will 
not be removed from the storage domain until the snapshot will be committed, if the user selects to undo the 
snapshot preview the created lease will be removed.</p>
  </li>
</ul>

<h2 id="new-engine-api">New engine API</h2>

<p>In the REST API and via the UI a user should be able to:</p>

<ul>
  <li>Preview a snapshot with or without the lease</li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<p>This feature is required for resolving
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1484863">Bug 1484863</a></p>

<h2 id="testing">Testing</h2>

<ul>
  <li>Preview VM snapshot which contains a lease while active VM snapshot contains a lease on the same domain
    <ul>
      <li>snapshot previewed and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Preview VM snapshot which contains a lease while active VM snapshot contains a lease on the different domain
    <ul>
      <li>snapshot previewed and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Preview VM snapshot which doesn’t contain a lease while active VM snapshot contains a lease
    <ul>
      <li>snapshot previewed and doesn’t use the active snapshot lease, the active snapshot lease is not removed from the storage domain</li>
    </ul>
  </li>
  <li>Preview VM snapshot which contains a lease while active VM snapshot doesn’t contain a lease
    <ul>
      <li>snapshot previewed and a new VM lease created</li>
    </ul>
  </li>
  <li>Custom preview VM snapshot and use the active VM snapshot lease
    <ul>
      <li>snapshot previewed and use the active VM lease</li>
    </ul>
  </li>
  <li>Custom preview VM snapshot and use the previewed VM snapshot lease
    <ul>
      <li>snapshot previewed and use the previewed snapshot VM lease</li>
    </ul>
  </li>
  <li>Custom preview VM snapshot and use the other snapshot lease
    <ul>
      <li>snapshot previewed and use the other snapshot VM lease</li>
    </ul>
  </li>
  <li>Custom preview VM snapshot and doesn’t use a lease
    <ul>
      <li>snapshot previewed and doesn’t use any VM lease</li>
    </ul>
  </li>
  <li>Undo VM snapshot which contains a lease while active VM snapshot contains a lease on the same domain
    <ul>
      <li>active snapshot restored and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Undo VM snapshot which contains a lease while active VM snapshot contains a lease on the different domain
    <ul>
      <li>active snapshot restored and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Undo VM snapshot which doesn’t contain a lease while active VM snapshot contains a lease
    <ul>
      <li>active snapshot restored and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Undo VM snapshot which contains a lease while active VM snapshot doesn’t contain a lease
    <ul>
      <li>active snapshot restored and the new VM lease which created for the preview removed</li>
    </ul>
  </li>
  <li>Commit VM snapshot which contains a lease while active VM snapshot contains a lease on the same domain
    <ul>
      <li>snapshot committed and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Commit VM snapshot which contains a lease while active VM snapshot contains a lease on the different domain
    <ul>
      <li>snapshot committed and use the active snapshot lease</li>
    </ul>
  </li>
  <li>Commit VM snapshot which doesn’t contain a lease while active VM snapshot contains a lease
    <ul>
      <li>snapshot committed and doesn’t use the active snapshot lease, the active snapshot lease removed from the storage domain</li>
    </ul>
  </li>
  <li>Commit VM snapshot which contains a lease while active VM snapshot doesn’t contain a lease
    <ul>
      <li>snapshot committed and use the created VM lease</li>
    </ul>
  </li>
</ul>

<h3 id="negative-flows">Negative flows</h3>
<ul>
  <li>Preview VM snapshot which contains a lease on storage domain that doesn’t exist
    <ul>
      <li>snapshot preview will fail</li>
    </ul>
  </li>
  <li>Preview VM snapshot which contains a lease on storage domain that isn’t active
    <ul>
      <li>snapshot preview will fail</li>
    </ul>
  </li>
</ul>

<h2 id="references">References</h2>

<p>[1] <a href="https://gerrit.ovirt.org/#/c/86105/">https://gerrit.ovirt.org/#/c/86105/</a></p>

<p>[2] <a href="https://gerrit.ovirt.org/#/c/86228/">https://gerrit.ovirt.org/#/c/86228/</a></p>

<p>[3] <a href="https://gerrit.ovirt.org/#/c/86513/">https://gerrit.ovirt.org/#/c/86513/</a></p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2792/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2792/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2792/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2792/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/vm-leases-and-snapshots-behavior.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/storage/vm-leases-and-snapshots-behavior.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
