<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>oVirt-engine-backup | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="oVirt-engine-backup" />
<meta name="author" content="Bob Doolittle" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2723/develop/release-management/features/integration/engine-backup.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2723/develop/release-management/features/integration/engine-backup.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt-engine-backup" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Bob Doolittle" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Bob Doolittle"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2723/images/logo.svg"},"name":"Bob Doolittle"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"oVirt-engine-backup","url":"https://ovirt.github.io/ovirt-site/previews/2723/develop/release-management/features/integration/engine-backup.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2723/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2723/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2723/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2723/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2723/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2723/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2723/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2723/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2723/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2723/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2723/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2723/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2723/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2723/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2723/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2723/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2723/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2723/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2723/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2723/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2723/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2723/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2723/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2723/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2723/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2723/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2723/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2723/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2723/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2723/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2723/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2723/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2723/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2723/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2723/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2723//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2723//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2723/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2723/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2723/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2723/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2723/develop/release-management/features/integration/">
              <span property="name">Integration</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/3b6fffe5f75326340fe25989d80a35e1?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/3b6fffe5f75326340fe25989d80a35e1?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Bob Doolittle</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bdc8ca08102747efb50537d34ab6d73c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bdc8ca08102747efb50537d34ab6d73c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Brian Proffitt</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yedidyah Bar David</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/db6bc448daa2b0b1315b0184bbcc9b77?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/db6bc448daa2b0b1315b0184bbcc9b77?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Maor Lipchuk</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9e2a26c1b7751bdb65047a7ea281b23b?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9e2a26c1b7751bdb65047a7ea281b23b?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ofer Schreiber</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2723/documentation/'>Documentation is available here.</a></div>

<h1 id="ovirt-engine-backup">oVirt-engine-backup</h1>

<h2 id="summary">Summary</h2>

<p>A simple utility to backup and restore a complete ovirt-engine environment.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Ofer Schreiber</li>
</ul>

<h2 id="current-status">Current status</h2>

<h3 id="phase">Phase</h3>

<p>First version released in ovirt 3.3.</p>

<p>DWH/Reports support added in ovirt 3.4.1.</p>

<p>DB provisioning, speed/size tuning options, <a href="/ovirt-site/previews/2723/develop/release-management/features/infra/backupawareness.html">engine notification</a> added in oVirt 3.6.</p>

<h2 id="howto">Howto</h2>

<h3 id="backup">Backup</h3>

<p>Backup is straightforward. See <code class="language-plaintext highlighter-rouge">--help</code> for details.</p>

<p>Example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-backup --mode=backup --file=backup1 --log=backup1.log
</code></pre></div></div>

<h3 id="restore">Restore</h3>

<p>Requirements:</p>

<ul>
  <li>A clean machine</li>
  <li>oVirt installed but not set up</li>
</ul>

<p>To restore:</p>

<ul>
  <li>Run restore (<code class="language-plaintext highlighter-rouge">--help</code> for details)</li>
  <li>Run engine-setup</li>
</ul>

<p>Example:</p>

<p>With a backup file <code class="language-plaintext highlighter-rouge">backup1</code>, taken on a 4.0 engine+dwh machine in a default setup, this should restore the engine and dwh on a new machine:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install ovirt-engine ovirt-engine-dwh
engine-backup --mode=restore --log=restore1.log --file=backup1 --provision-db --provision-dwh-db --no-restore-permissions
engine-setup
</code></pre></div></div>

<h4 id="details">Details</h4>

<p>If backed up databases were provisioned by engine-setup (“Automatic” was accepted for the questions “Setup can configure the local postgresql server automatically for X…”), engine-backup can provision them too on restore if requested, since 3.6, using these options: <code class="language-plaintext highlighter-rouge">--provision-db</code>, <code class="language-plaintext highlighter-rouge">--provision-dwh-db</code>, <code class="language-plaintext highlighter-rouge">--provision-reports-db</code>.</p>

<p>When restoring a backup taken using the (default) <code class="language-plaintext highlighter-rouge">custom</code> dump format, the user must pass one of the options <code class="language-plaintext highlighter-rouge">--restore-permissions</code> or <code class="language-plaintext highlighter-rouge">--no-restore-permissions</code> - there is no default.
With <code class="language-plaintext highlighter-rouge">--no-restore-permissions</code>, only the database owner will have access to it, which is enough for the normal functioning of oVirt.</p>

<p>If extra users were added and granted access to the database, for example for integration with ManageIQ, they will not be created and will not have access. If they are manually created, passing <code class="language-plaintext highlighter-rouge">--restore-permissions</code> will run the extra GRANT commands.</p>

<p>In 4.0.4 and later, if passing both <code class="language-plaintext highlighter-rouge">--provision*db</code> and <code class="language-plaintext highlighter-rouge">--restore-permissions</code>, the extra users will be created automatically with random passwords. See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1369757#c1">BZ 1369757 Comment 1</a> for details.</p>

<p>Provisionoing is done using a utility based on the same code used by engine-setup, that is called by engine-backup. In particular, this means that these options will:</p>

<ul>
  <li>work either if a database does not exist (including if postgresql was not initialized at all) or if it exists and is empty (e.g. right after engine-cleanup). This should work even if the user exists and has a different password (it will be changed).</li>
  <li>fail if a database exists and is not empty. In such a case a new empty database will be created named BASENAME_TIMESTAMP (e.g. engine_20150506120000), as does engine-setup in such a case, but unlike engine-setup, restore will be aborted asking the user to clean up and retry.</li>
</ul>

<p><strong>The text below applies to versions &lt;= 3.5</strong>, as well as to 3.6 if <code class="language-plaintext highlighter-rouge">--provision-\*db</code> is not used.</p>

<h4 id="db-credentials">DB credentials</h4>

<p>If it happens that the credentials used during backup still work during restore, they can be used, and in this case restore is as simple as backup. Example scenarios where this is the case:</p>

<ul>
  <li>engine was setup with a local database, backup was created, some time later engine-cleanup was called, and we now want to restore to the state saved by backup. This works because engine-cleanup does not drop the user and/or database in postgresql, just the database’s content.</li>
  <li>engine was setup with a remote database, backup was created, engine-cleanup was ran, and now we want to restore the engine on another machine, but using the same database server. This will work too without supplying different credentials, for the same reason, provided that we make sure the new engine host has access to the database server/instance/etc.</li>
</ul>

<p>In most other cases, we have to manually create the database, make it accessible to the engine, and use the credentials we have chosen when calling restore. An example scenario that requires this:</p>

<ul>
  <li>engine was setup with a local database, backup was done, now we want to restore this backup on another machine (for testing or whatever).</li>
</ul>

<p>Due to some misunderstanding about the previous points, it was sometimes suggested on various places to do:</p>

<ul>
  <li>setup engine with local database on machineA</li>
  <li>backup</li>
  <li>Copy backup to machineB</li>
  <li>
    <p>On machineB:</p>

    <ul>
      <li>engine-setup</li>
      <li>engine-cleanup</li>
      <li>restore</li>
    </ul>
  </li>
</ul>

<p>This “almost” works. engine-setup/engine-cleanup on machineB create a user/database for us. What’s missing? The password is generated randomly by setup, and so will be different on both machines and restore will not be able to connect. What can we do to continue and save us from manually doing all the work (2x create, edit pg_hba, restart postgresql)? Generally, two options:</p>

<ol>
  <li>
    <p>change the password:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Open the backup in some temporary directory (it's a tar file)
* look at the file "files/etc/ovirt-engine/engine.conf.d/10-setup-database.conf" and find the password used when doing backup
* as user postgres, run psql, and there do:
   alter role engine ENCRYPTED PASSWORD 'MYPASSWORD';
  replace MYPASSWORD with the password you found inside the backup file.
</code></pre></div>    </div>
  </li>
  <li>
    <p>manually create with existing credentials:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* instead of doing setup/cleanup to merely create a database, do that yourself manually, but instead of inventing a new password (and other credentials), use the ones found inside the backup file (as explained in the previous option "change the password"). This is a bit more work than running setup/cleanup, but is probably much faster (especially if scripted).
</code></pre></div>    </div>
  </li>
  <li>
    <p>After running engine-setup and before engine-cleanup, check what random password was chosen by setup:</p>

    <p>grep ENGINE_DB_PASSWORD /etc/ovirt-engine/engine.conf.d/10-setup-database.conf</p>
  </li>
</ol>

<p>Then use this password on restore (after cleanup). Note that you must provide more credentials than just the password:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  engine-backup --mode=restore --file=BACKUP_FILE --log=LOG_FILE --change-db-credentials --db-host=localhost --db-user=engine --db-name=engine --db-password
</code></pre></div></div>

<h2 id="dwhreports">DWH/Reports</h2>

<p>The 3.4.1 release added support for DWH and Reports. On backup, whatever that’s installed/setup - among engine, DWH and Reports - is backed up, and on restore, you should install whatever packages that were used during backup (engine/dwh/reports), then restore and setup. Running engine-setup is now mandatory after restore.</p>

<p>The notes and discussion above about DB credentials apply also to the DWH and Reports databases - they are never created by restore but are expected to exist, and be usable with the credentials saved in the backup or passed using the various options.</p>

<h3 id="dwh-up-during-backup">DWH up during backup</h3>

<p><strong>Update for 3.6</strong>: <code class="language-plaintext highlighter-rouge">engine-backup --mode=restore</code> will automatically reset DwhCurrentlyRunning in the engine’s database.</p>

<p>The text below applies to versions &lt;= 3.5.</p>

<p>If dwhd is running during backup, ‘engine-setup’ after restore will emit the following error and exit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  [ ERROR ] dwhd is currently running. Its hostname is `*`hostname`*`. Please stop it before running Setup.
  [ ERROR ] Failed to execute stage 'Transaction setup': dwhd is currently running
</code></pre></div></div>

<p>This will be emitted whether or not dwh is setup on the same machine as the engine or on a different one. To “fix” this, connect to the engine db using psql and run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  UPDATE dwh_history_timekeeping SET var_value=0 WHERE var_name ='DwhCurrentlyRunning';
</code></pre></div></div>

<p>Then run ‘engine-setup’ again and it should succeed.</p>

<h2 id="speedsize-tuning">Speed/Size tuning</h2>

<p>In version 3.6, several options were added that can affect the size of the generated backup file, as well as the speed of backup/restore:</p>

<h3 id="compression">Compression</h3>

<p>Each of ‘files’ (which are now always tarred into their own tar file inside the final archive), ‘db’ (engine database) ‘dwhdb’ (DWH database) and ‘reportsdb’ (Reports database) and the final archive (<code class="language-plaintext highlighter-rouge">--file=FILE</code>) can be separately either left uncompressed, or compressed with one of gzip, bzip2, xz.</p>

<h3 id="database-dump-format">Database dump format</h3>

<p>For each of the databases:</p>

<ul>
  <li>The dump format can be selected - either ‘plain’ or ‘custom’ are accepted.</li>
  <li>If, during backup, ‘custom’ format and no compression (None) are selected, then during restore, the number of restore jobs can be set, and is passed to pg_restore’s <code class="language-plaintext highlighter-rouge">--jobs</code> option.</li>
</ul>

<h3 id="defaults-and-discussion">Defaults and discussion</h3>

<p>The defaults are currently (on the master branch):</p>

<ul>
  <li>Final archive compressed with gzip</li>
  <li>Files tar is compressed with xz</li>
  <li>Databases are using the ‘custom’ dump format, and are not compressed further (this format uses gzip internally)</li>
  <li>On restore, number of restore jobs is 2</li>
</ul>

<p>See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1213153">bug 1213153</a> about adding other “collections” of options.</p>

<p>For smallest size (e.g. for archiving), probably everything should be compressed with xz, with ‘plain’ dump format for databases.</p>

<p>For fastest restore, number of restore jobs should be set somewhere between N and 1.5*N, where N is the number of available cpu cores.</p>

<p>Also for fastest restore (and general good performance), each of the Engine/DWH/Reports can have its database on its own machine. In such a case, in principle, restore can be done in parallel. <code class="language-plaintext highlighter-rouge">engine-backup</code> currently does not support that natively, but a user can try to achieve that manually, by backing up each ‘scope’ (using <code class="language-plaintext highlighter-rouge">--scope=</code>) to its own file, and then, on restore, first restore the files, and after that restore the databases in parallel.</p>

<p>See also the documentation of PostgreSQL - on <a href="http://www.postgresql.org/">postgresql.org</a> and in the pg_restore man page.</p>

<h2 id="detailed-description">Detailed Description</h2>

<p>Backup logic:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  * Create Temporary directory
  * Copy configuration files into temp directory
     1. /etc/ovirt-engine/  (ovirt engine configuration)
     2. /etc/sysconfig/ovirt-engine (ovirt engine configuration)
     3. /etc/exports.d  (NFS export created on setup)
     4. /etc/pki/ovirt-engine (ovirt-engine keys)
     5. Firewall
     6. Other
   * Create tar file from that directory
   * Create database backup using pg_dump (database configuration should be read from /etc and written into temporary .pgpass file)
</code></pre></div></div>

<p>Restore: Phase one (BASH)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1. Request user to run engine-setup
  2. Override DB and PKI directories
</code></pre></div></div>

<p>Phase two (??)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  * Gather all needed information from the backup
  *  Run otopi based ovirt-engine-setup with special parameters (use pg_dump, don't create new PKI)
</code></pre></div></div>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<ul>
  <li>Easy to use backup utility</li>
  <li>Easy restore of existing environments.</li>
</ul>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>TBD</p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<p>See output of <code class="language-plaintext highlighter-rouge">engine-backup --help</code>.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2723/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2723/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2723/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2723/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/integration/engine-backup.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/integration/engine-backup.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
