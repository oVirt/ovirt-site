<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>OvfAutoUpdater | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="OvfAutoUpdater" />
<meta name="author" content="Ayal Baron" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/ovfautoupdater.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/ovfautoupdater.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OvfAutoUpdater" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Ayal Baron" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Ayal Baron"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"OvfAutoUpdater","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3192/images/logo.svg"},"name":"Ayal Baron"},"url":"https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/ovfautoupdater.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3192/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3192/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3192/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3192/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3192/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3192/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3192/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3192/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3192/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ayal Baron">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ayal Baron</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/8f07947836874690665b49430a562713?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/8f07947836874690665b49430a562713?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Liron Aravot">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Liron Aravot</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3192/documentation/'>Documentation is available here.</a></div>

<h1 id="ovfautoupdater">OvfAutoUpdater</h1>

<h2 id="summary">Summary</h2>

<p>The OvfAutoUpdater introduces a change to the system-wide behaviour of VM/template OVF updates. Currently every change in the VM configuration entails a synchronous vdsm call to update the OVF in the master domain. With OvfAutoUpdater OVF updates would be performed periodically for multiple OVFs of the same data-center in a single vdsm call. OVF deletions in case of VM/Template removal will be done by the OvfAutoUpdater as well periodically instead of during the execution of VM/Template removal by the user, which will make the operations execution faster.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Liron Aravot</li>
  <li>Email: <a href="mailto:laravot@redhat.com">laravot@redhat.com</a></li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>VM/template configurations (including disks info) are stored on the master storage domain for backup purposes and in order to provide the ability to run VMs without having a running engine/db. Currently OVF update/removal is done synchronously when performing various operations on VMs/templates - update, save, remove, adding/removing a disk, etc. What’s more, currently updating/removing the OVF (vdsm call) is usually done within a transaction.</p>

<p>The idea behind OvfAutoUpdater is to perform batch OVF update operations that aggregate all outstanding updates per data center. These updates will be done in specified time intervals which will reduce XML-RPC calls and will enable the removal of this synchronous vdsm call from all over the code.</p>

<p>The time interval (minutes) between OvfAutoUpdater runs can be configured by the config value <code class="language-plaintext highlighter-rouge">OvfUpdateIntervalInMinutes</code>, defaults to <code class="language-plaintext highlighter-rouge">60</code>. The items count per update (in single vdsm update call) can be configured by the config value <code class="language-plaintext highlighter-rouge">OvfItemsCountPerUpdate</code>, defaults to <code class="language-plaintext highlighter-rouge">100</code>.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<ul>
  <li>Reduce vdsm xml-rpc calls.</li>
  <li>Removal of OVF update call from all flows.</li>
  <li>Prevent running OVF update within transactions.</li>
</ul>

<h2 id="detailed-design">Detailed Design</h2>

<h3 id="db-changes">DB Changes</h3>

<p><code class="language-plaintext highlighter-rouge">vm_static</code> table:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   add column - `db_generation BIGINT default 1`
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">vm_ovf_generations</code> table - newly add table</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   vm_guid UUID PRIMARY KEY,
   storage_pool_id UUID REFERENCES storage_pool(id) ON DELETE CASCADE,
   ovf_generation BIGINT DEFAULT 0
</code></pre></div></div>

<p>Add to this table records for all the pre-exiting VMs/templates with initial <code class="language-plaintext highlighter-rouge">ovf_generation</code> of <code class="language-plaintext highlighter-rouge">1</code> (as their OVF should be already up to date from before)</p>

<p><code class="language-plaintext highlighter-rouge">vdc_options</code> table:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   add row - OvfUpdateIntervalInMinutes config value.
   add row - OvfItemsCountPerUpdate config value
</code></pre></div></div>

<h3 id="engine">Engine</h3>

<ul>
  <li>New singleton - <code class="language-plaintext highlighter-rouge">OvfDataUpdater</code> with an instance initiated during server startup - the constructor schedules a quartz job with interval as configured in the <code class="language-plaintext highlighter-rouge">OvfUpdateIntervalInMinutes</code> config value.</li>
  <li>When timer time has elapsed, performs the following:</li>
</ul>

<ol>
  <li>Get all Storage Pool in status ‘UP’ (meaning we have a valid master domain and SPM)</li>
  <li>For each storage pool in status ‘UP’ - Get all VM’s/Templates within that storage pool that were changed since last run (<code class="language-plaintext highlighter-rouge">db_generation &gt; ovf_generation</code>) which are not locked and none of their disks are locked.</li>
  <li>Try to run <code class="language-plaintext highlighter-rouge">UpdateVmInSpm</code> for all those VMs together in a single call (it might be necessary to split the update execution into chunks in order to avoid performing the operation on too many VMs/templates in the same call).</li>
  <li>If successful - for each VM update the <code class="language-plaintext highlighter-rouge">ovf_generation</code> to equal the <code class="language-plaintext highlighter-rouge">db_generation</code> that was returned in the VM entity when we performed the query to get the VMs for update.</li>
  <li>Load all id’s of VMs/templates that were deleted since last OvfAutoUpdater run and issue vdsm command to delete their OVFs.</li>
</ol>

<ul>
  <li>Replace <code class="language-plaintext highlighter-rouge">updateVmInSpm</code> call in commands with an increment to the <code class="language-plaintext highlighter-rouge">db_generation</code> version.</li>
  <li>Increment the <code class="language-plaintext highlighter-rouge">db_generation</code> column in <code class="language-plaintext highlighter-rouge">vm_static</code> should be performed in the start of the db transaction to prevent possible db deadlocks.</li>
  <li>Remove <code class="language-plaintext highlighter-rouge">removeVmInSpm</code> call in commands (removed VMs/templates will be “collected” automatically after removal in the next OvfAutoUpdater run).</li>
</ul>

<h3 id="notes">NOTES</h3>

<p>OVFs of VMs/Templates that are being/were updated exactly during their processing by OvfAutoUpdater run will have their OVF updated in the storage the next OvfAutoUpdater run, DB updates will occur regularly.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3192/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3192/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3192/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3192/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/ovfautoupdater.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/ovfautoupdater.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
