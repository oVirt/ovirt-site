<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>UpgradeManager | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="UpgradeManager" />
<meta name="author" content="Moti Asayag" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2754/develop/release-management/features/infra/upgrademanager.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2754/develop/release-management/features/infra/upgrademanager.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="UpgradeManager" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Moti Asayag" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Moti Asayag"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2754/images/logo.svg"},"name":"Moti Asayag"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"UpgradeManager","url":"https://ovirt.github.io/ovirt-site/previews/2754/develop/release-management/features/infra/upgrademanager.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2754/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2754/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2754/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2754/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2754/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2754/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2754/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2754/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2754/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2754/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2754/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2754/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2754/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2754/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2754/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2754/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2754/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2754/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2754/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2754/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2754/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2754/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2754/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2754/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2754/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2754/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2754/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2754/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2754/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2754/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2754/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2754/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2754/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2754/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2754/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2754//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2754//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2754/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2754/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2754/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2754/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2754/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/90758110b19ee0a2e03473012fdc1bd7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/90758110b19ee0a2e03473012fdc1bd7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Moti Asayag</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2754/documentation/'>Documentation is available here.</a></div>

<h1 id="upgrade-manager">Upgrade Manager</h1>

<h2 id="summary">Summary</h2>

<p>The process of upgrading cluster/hosts to a higher version is a manual process. When working with a small cluster of hosts that suffice. However, on large clusters it is very time-consuming to upgrade all the hosts manually. The purpose of this feature is to give administrators a set of tools to know when an upgrade is available for the hosts, upgrade separate hosts, and upgrade cluster as a whole, using rolling upgrade process.
See demo <a href="https://youtu.be/fDzBNKu5pyQ">here</a>.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: <a href="User:masayag">Moti Asayag</a></li>
  <li>Email: <a href="mailto:masayag@redhat.com">masayag@redhat.com</a></li>
  <li>IRC: masayag at #ovirt (irc.oftc.net)</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Upgrade is a big pain point on large oVirt deployments. The existence of tools to ease the upgrade process will make it easier to adopt oVirt.</p>

<h2 id="requirements">Requirements</h2>

<p>The set of tools that are in the scope of this feature are:</p>

<ol>
  <li>Notify the user that an update for the engine is available</li>
  <li>Make it easier to know whether a host has available updates</li>
  <li>Allow the user to upgrade a specific host automatically</li>
  <li>Allow the user to do a rolling cluster upgrade, either to a higher cluster level, or to a new version that supports the current one (out-of-scope of ovirt-engine-3.6)</li>
</ol>

<h2 id="user-experience">User Experience</h2>

<h3 id="make-it-easier-to-know-whether-a-host-has-an-available-update">Make it easier to know whether a host has an available update</h3>

<p>Currently, for oVirt-node, it already shows you that there is an upgrade available, by an alert on the bottom of the general sub-tab.
We can add a similar alert also for regular hosts:
* A notification will be added at the bottom of the ‘General’ sub-tab of the host, saying ‘Upgrade is available. <em>Upgrade</em>’. where <em>Upgrade</em> is a link to the action, based on the host type (plan host or ovirt-node).</p>

<ul>
  <li>Once an update is available, the “Upgrade” button will be enabled, both on the menu bar and in the host context menu.</li>
  <li>For consistency, a support will be added for updates available property for <strong>oVirt-node</strong></li>
  <li>Upgrading host in ‘Up’ status will trigger the following flow:
    <ul>
      <li>Host is set to maintenance mode, triggering the migration of the vms to other hosts in the cluster.</li>
      <li>New updates are being installed on the host using ovirt-host-deploy.</li>
      <li>Host is brought up once installation is completed.</li>
    </ul>
  </li>
</ul>

<p><img src="/ovirt-site/previews/2754/images/wiki/Update_available_mockups.png" alt=" 800px" title=" 800px" /></p>

<p><strong>API:</strong></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /hosts/{host:id}/
<span class="nt">&lt;host&gt;</span>
    ...
    <span class="nt">&lt;updates_available&gt;</span>`true`<span class="nt">&lt;/updates_available&gt;</span>
<span class="nt">&lt;/host&gt;</span>
</code></pre></div></div>

<h4 id="which-packages-are-checked-for-updates">Which packages are checked for updates?</h4>

<p>There is a system configuration value named ‘PackageNamesForCheckUpdate’ which contains the system required packages for upgrade (specifically ‘vdsm’).
A user may provide additional packages he wishes to monitor for updates by using ‘UserPackageNamesForCheckUpdate’ config value, which is a merge-able and supports wildcards.
Assuming the config value contains the value ‘libvirt, mom’, the use can use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>engine-config <span class="nt">-m</span> <span class="nv">UserPackageNamesForCheckUpdate</span><span class="o">=</span>qemu-kvm-rhev
</code></pre></div></div>

<p>which will result in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>engine-config <span class="nt">-g</span> UserPackageNamesForCheckUpdate
UserPackageNamesForUpdate: libvirt,mom,qemu-kvm-rhev version: general
</code></pre></div></div>

<p>The same behavior is applied during the upgrade sequence: All packages listed in ‘PackageNamesForCheckUpdate’ and ‘UserPackageNamesForCheckUpdate’ will be upgraded.</p>

<h4 id="when-packages-are-checked-for-updates">When packages are checked for updates?</h4>

<p>The interval for updates checking is determined by the configuration value ‘HostPackagesUpdateTimeInHours’, which is specified in hours.</p>

<h3 id="allow-the-user-to-upgrade-a-specific-host-automatically">Allow the user to upgrade a specific host automatically</h3>

<ul>
  <li>If an update is available:
    <ul>
      <li>and if the host’s status is ‘Up’ or ‘Maintenance’:
        <ul>
          <li>Enable “Upgrade” button on menu-bar and in the host context menu.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/ovirt-site/previews/2754/images/wiki/Upgrade_host_button.png" alt=" 800px" title=" 800px" /></p>

<ul>
  <li>For consistency, a support will be added for <strong>oVirt-node</strong> upgrade in UP status.</li>
</ul>

<p><strong>API:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /hosts/{host:id}/upgrade|rel=upgrade
</code></pre></div></div>

<h3 id="allow-the-user-to-do-a-rolling-cluster-upgrade-either-to-a-higher-cluster-level-or-to-a-new-version-that-supports-the-current-one">Allow the user to do a rolling cluster upgrade, either to a higher cluster level, or to a new version that supports the current one</h3>

<p><em>Not planned for 3.6</em>:
For a cluster we should add the option to “check for available upgrade”. This should go on all the operational hosts, and check whether there is a new version available, and what cluster levels it supports. If there is one, the minimal and maximal supported cluster level will be shown as well. Now, the user can upgrade to a higher cluster level, or to a higher version in the current one.
Two flows here behind the scenes:</p>
<ol>
  <li>Same cluster level - host by host is moved to maintenance, upgraded, activated. At the end of the day the cluster itself as a whole was upgraded. There should be an easy way to see the status of this upgrade, and information for all the hosts, whether they were upgraded or not (Task list?).</li>
  <li>Higher cluster level - same as #1, but upgrading the cluster levels once all hosts were upgraded.</li>
</ol>

<h2 id="implementation">Implementation</h2>

<h3 id="upgrade-host-flow">Upgrade Host Flow</h3>

<p>The upgrade process will reuse the existing re-install flow which updates the required packages (vdsm, vdsm-cli).
The host upgrade sequence is:</p>

<ul>
  <li>If VMs are running on the host - popup a warning confirmation dialog: “There are running VMs on the host. Would you like to continue?”</li>
  <li>If there are updates available for the host
    <ul>
      <li>Move host to ‘Maintenance’.
        <ul>
          <li>Migrate VMs if there are any running on the host.</li>
        </ul>
      </li>
      <li>Run ‘Re-install’ command</li>
      <li>Return the host to its origin status (Up or Maintenance).</li>
      <li>Clear updates notifications for the host</li>
    </ul>
  </li>
  <li>Upgrade failure will move the host to “Install Failed” status. From “Install Failed” the user should be able to “Upgrade” the host again.</li>
</ul>

<p><strong>The ovirt-engine</strong> will schedule a daily quartz job for querying vdsm for any available updates for the host.
 The packages availability check/upgrade action will be performed using the ovirt-host-deploy component.
 <strong>Install/Reinstall Host Flow changes:</strong></p>

<ul>
  <li>When host installation/re-installation fails, the available updates notification will be disabled.</li>
</ul>

<h2 id="open-issuesquestions">Open Issues/Questions</h2>

<ul>
  <li>Support a cluster upgrade when cluster contains both RHEL and RHEV-H hosts.
    <ul>
      <li>How cluster version should be determined?</li>
    </ul>
  </li>
  <li>Upgrade procedure of RHEV-H (done by selecting a specific image to upgrade)</li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2754/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2754/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2754/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2754/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/upgrademanager.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/infra/upgrademanager.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
