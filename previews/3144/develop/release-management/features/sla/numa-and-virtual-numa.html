<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>NUMA and Virtual NUMA | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="NUMA and Virtual NUMA" />
<meta name="author" content="Andrew Dahms" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3144/develop/release-management/features/sla/numa-and-virtual-numa.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3144/develop/release-management/features/sla/numa-and-virtual-numa.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="NUMA and Virtual NUMA" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Andrew Dahms" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Andrew Dahms"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"NUMA and Virtual NUMA","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3144/images/logo.svg"},"name":"Andrew Dahms"},"url":"https://ovirt.github.io/ovirt-site/previews/3144/develop/release-management/features/sla/numa-and-virtual-numa.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3144/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3144/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3144/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3144/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3144/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3144/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3144/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3144/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3144/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3144/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3144/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3144/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3144/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3144/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3144/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3144/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3144/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3144/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3144/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3144/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3144/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3144/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3144//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3144//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3144/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3144/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3144/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3144/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3144/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Andrew Dahms">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Andrew Dahms</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Dan Kenigsberg">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/2f88ac61607581f5833e228550ee2f34?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/2f88ac61607581f5833e228550ee2f34?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Jason Liao">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Jason Liao</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3144/documentation/'>Documentation is available here.</a></div>

<h1 id="numa-and-virtual-numa">NUMA and Virtual NUMA</h1>

<h2 id="summary">Summary</h2>

<p>This feature allows enterprise customers to provision large guests for their traditional scale-up enterprise workloads and expect low overhead due to virtualization.</p>

<ul>
  <li>Query target host’s NUMA topology</li>
  <li>NUMA bindings of guest resources (vCPUs &amp; memory)</li>
  <li>Virtual NUMA topology</li>
</ul>

<p>You may also refer to the <a href="/ovirt-site/previews/3144/develop/release-management/features/sla/detailed-numa-and-virtual-numa.html">detailed feature page</a>.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Jason Liao (JasonLiao), Bruce Shi (BruceShi)</li>
  <li>Email: <a href="mailto:chuan.liao@hp.com">chuan.liao@hp.com</a>, <a href="mailto:xiao-lei.shi@hp.com">xiao-lei.shi@hp.com</a></li>
  <li>IRC: jasonliao, bruceshi @ #ovirt (irc.oftc.net)</li>
</ul>

<h2 id="current-status">Current Status</h2>

<ul>
  <li>Target Release: oVirt 3.5</li>
  <li>Status: design</li>
  <li>Last updated: 25 Mar 2014</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<ul>
  <li>Query target host’s NUMA topology</li>
</ul>

<p>The ability to gather a given host’s NUMA topology (the number of NUMA nodes, CPUs, and total memory per node, NUMA node distances), NUMA statistics (free memory per node, CPUs and memory usage per node) from the UI, RESTful API and other APIs. Besides consuming this information for planning and provisioning guests and oVirt scheduler etc. there may be other likely consumers now and in the future.</p>

<ul>
  <li>NUMA bindings of guest resources (vCPUs &amp; memory)</li>
</ul>

<p>The ability to optionally specify the bindings for backing memory of a guest (i.e. via numatune with mode set to: strict, preferred, or interleave) along with the vCPU pinning across a desired set of host NUMA nodes from the UI, RESTful API and other APIs. An automatic NUMA balancing feature will be introduced in kernel 3.13. As this technology matures, it should reduce the need for having to specify explicit NUMA bindings.</p>

<ul>
  <li>Virtual NUMA topology</li>
</ul>

<p>The ability to specify virtual NUMA nodes for a medium- or large-sized guest from the UI, RESTful API and other APIs. This helps the operating system running in the guest to perform NUMA-aware allocation of data structures and scale better. Automatic NUMA balancing in the guest kernel can take advantage of this, too.</p>

<h2 id="use-case-diagram">Use Case Diagram</h2>

<p><img src="/ovirt-site/previews/3144/images/wiki/Use_case_diagram.png" alt="" /></p>

<ul>
  <li>Color of the use cases
    <ul>
      <li>Green - oVirt features are existed.</li>
      <li>Blue - NUMA related feature.</li>
      <li>Dashed - feature under discussion.</li>
    </ul>
  </li>
</ul>

<!-- -->

<ul>
  <li>Use cases in detailed (v1 - current version, v2 - next version)
    <ul>
      <li>When ovirt engine add some host or refresh host capabilities, the <code class="language-plaintext highlighter-rouge">Gather host NUMA topology</code> will collect the number of NUMA nodes, CPU list and total memory per node, NUMA distances (v2), Automatic NUMA balancing support (v2) from vdsm.</li>
      <li>When ovirt engine on timely to do get host statistics, the <code class="language-plaintext highlighter-rouge">Gather host NUMA statistics</code> will collect free memory per node, CPUs and memory usage per node from vdsm,</li>
      <li>The CPUs usage per node is the sum of NUMA node’s CPUs usage depending on <code class="language-plaintext highlighter-rouge">Gather per CPU statistics</code>. It contains CPU’s system, user and idle usage. These data will be used not only by NUMA feature, oVirt scheduler and Report will use them.</li>
      <li>By using user interface <code class="language-plaintext highlighter-rouge">Show host NUMA information</code>, administrator will take a loot at host NUMA information, then decide how to configure VM with NUMA aware.</li>
      <li>Thus <code class="language-plaintext highlighter-rouge">Manual binding NUMA node</code> feature turn on, administrator should know the operation will let the VM lose high availability and live migration as same as CPU pinning feature. Binding NUMA node contain three steps:
        <ul>
          <li>Select NUMA tuning mode (strict, preferred or interleave)</li>
          <li>Select NUMA node sets from specified host.</li>
          <li>Check the CPU pinning is suitable for node sets.</li>
        </ul>
      </li>
      <li>If the VM has the large size (i.e., 40 vCPUs and 512G memory) and cross the NUMA node, the <code class="language-plaintext highlighter-rouge">Guest NUMA topology</code> is the suggested feature that make the system has better performance. There are two checkpoints:
        <ul>
          <li>The sum of Guest NUMA node’s CPUs count must equal to VM total CPU count.</li>
          <li>The sum of Guest NUMA node’s memory size must equal to VM total memory size.</li>
        </ul>
      </li>
      <li>Follow up <code class="language-plaintext highlighter-rouge">oVirt Scheduler with NUMA policy</code>, these situation should consider:
        <ul>
          <li>When <code class="language-plaintext highlighter-rouge">Manual binding NUMA node</code> and <code class="language-plaintext highlighter-rouge">CPU pinning</code> are configured
            <ul>
              <li>If there is enough free memory (each or sum) for binding NUMA nodes to run VM. (v1)</li>
              <li>If there is enough CPU idle (each or sum) for binding NUMA nodes to run VM. (v1)</li>
              <li>If there is enough CPU idle (each or sum) for VM CPU pinning to run VM. (v2)</li>
            </ul>
          </li>
          <li>When <code class="language-plaintext highlighter-rouge">Guest NUMA topology</code> is configured
            <ul>
              <li>If there is enough free memory per NUMA node to run VM. (v2)</li>
              <li>If there is enough CPU idle per NUMA node to run VM. (v2)</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>The <code class="language-plaintext highlighter-rouge">NUMA topology section restful API</code> is under the Host and VM root section. It contains the list of NUMA nodes, each NUMA node’s CPUs and total memory, node distance (v2), automatic NUMA balancing support (v2).</li>
      <li>The <code class="language-plaintext highlighter-rouge">NUMA statistics section restful API</code> is under the Host root section, it contains each NUMA node’s free memory, CPUs &amp; memory usage.</li>
      <li><code class="language-plaintext highlighter-rouge">Search Host/VM by NUMA node count</code> and <code class="language-plaintext highlighter-rouge">MOM setting</code> with NUMA are still in discussion and will be published in v2.</li>
    </ul>
  </li>
</ul>

<h2 id="ui-design-prototype">UI Design Prototype</h2>

<p>Work in Progress…</p>

<ul>
  <li>Host sub tab NUMA information
    <ul>
      <li>Follow CPUs and Memory of each NUMA node information, CPU pinning and manual binding NUMA node on VM is much easier.</li>
      <li>Click Show NUMA distances button will popup panel show distances map.</li>
    </ul>
  </li>
  <li>Manual binding NUMA node
    <ul>
      <li>Specific host changed on Host tabs will refresh Tuning nodes from the specified host.</li>
      <li>Click Manual Binding NUMA node checkbox, the tuning mode selector and nodes checkboxes will enabled.</li>
      <li>Tuning mode has these values: strict, preferred, interleave</li>
      <li>There is one help box content: Configure wrong CPU pinning against NUMA nodes will take bad performance.</li>
    </ul>
  </li>
  <li>Guest NUMA topology
    <ul>
      <li>Left node0 CPUs and Memory be blank, system will ignore Guest NUMA topology configuration.</li>
      <li>Click Add and Minus button will increase and decrease NUMA nodes.</li>
      <li>On saving the VM, there are some checks in NUMA topology:</li>
      <li>The sum of every node’s CPUs number should equal to Total Virtual CPUs</li>
      <li>The sum of every node’s Memory number should equal to total Memory Size</li>
    </ul>
  </li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>The hypervisor’s default policy is to schedule and run the guest on any available resources on the host. As a result, the resources backing a given guest could end up getting spread out across multiple NUMA nodes and over a period of time may get moved around, leading to poor and unpredictable performance inside the guest. Use the NUMA feature configuration could allow the users to get better performance from their VM’s through using all CPU related memory - including the ones not handled by qemu/kvm. Allows users to get better performance from their VM’s through split virtual NUMA node</p>

<p>Note: Automatic NUMA balancing changes in the Linux kernel (i.e. upstream 3.8 kernel) should help reduce the need for having to explicitly specify this for a guest. But there will still be specific use cases where having this ability in the UI will prove useful.</p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1010059">BZ1010059 - NUMA aware and balanced allocation of backing host resources for large guests</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1010079">BZ1010079 - Virtual NUMA nodes inside larger guests</a></li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3144/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3144/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3144/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3144/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2023 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/numa-and-virtual-numa.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/numa-and-virtual-numa.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
