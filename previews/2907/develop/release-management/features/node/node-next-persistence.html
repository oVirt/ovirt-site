<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Next Gen Node RPM persistence | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Next Gen Node RPM persistence" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2907/develop/release-management/features/node/node-next-persistence.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2907/develop/release-management/features/node/node-next-persistence.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Next Gen Node RPM persistence" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Next Gen Node RPM persistence","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2907/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2907/develop/release-management/features/node/node-next-persistence.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2907/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2907/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2907/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2907/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2907/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2907/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2907/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2907/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2907/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2907/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2907/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2907/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2907/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2907/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2907/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2907/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2907/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2907/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2907/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2907/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2907/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2907/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2907//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2907//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2907/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2907/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2907/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2907/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2907/develop/release-management/features/node/">
              <span property="name">Node</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c7816d118bca28e91962b9be8f461f50?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c7816d118bca28e91962b9be8f461f50?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ryan Barry</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2907/documentation/'>Documentation is available here.</a></div>

<h1 id="node-rpm-persistence-after-upgrades">Node RPM Persistence After Upgrades</h1>

<h2 id="summary">Summary</h2>
<p><a href="/ovirt-site/previews/2907/develop/release-management/features/node/node.next.html">oVirt Node NG</a> is an advancement over vintage Node, especially that it allows users to install RPMs or customize the system through configuration management tools. Some of these changes are migrated over from /etc after upgrades, and some are kept persistenly in /var, but any packages which are installed on a running layer will be lost after upgrades and need re-installation. This presents some problems with vendor tooling, IPMI, utilities to collect statistics, and other add-ons.</p>

<p>This feature presents a mechanism by which packages installed through yum/dnf can be saved and automatically re-applied when the OS is updated.</p>

<p>A deep dive presentation of the feature is available on <a href="https://www.youtube.com/watch?v=tpAVkBEDdVg">youtube</a></p>

<h3 id="owner">Owner</h3>
<ul>
  <li>Name: Ryan Barry</li>
  <li>Email: rbarry@redhat.com</li>
</ul>

<h3 id="current-status">Current Status</h3>
<ul>
  <li>Status: On QA</li>
  <li>Last updated date: 29th Jan 2017</li>
</ul>

<h3 id="benefit-to-ovirt">Benefit to oVirt</h3>

<p>This feature will greatly improve the user experience of Node by maintaining a consistent userland and system configuration after upgrades. This allows for Node customizations to “stick”.</p>

<h3 id="dependencies">Dependencies</h3>
<p>None! We simply need to add an additional yum plugin to imgbased.</p>

<h2 id="detailed-description">Detailed Description</h2>

<p>Node NG performs a number of actions when updates are applied.</p>

<ul>
  <li>A new layer is added</li>
  <li>An event fires for the new layer</li>
</ul>

<h2 id="consumers">Consumers</h2>

<h2 id="osupdater">osupdater</h2>
<ul>
  <li>The new squashfs is extracted onto that layer</li>
  <li><code class="language-plaintext highlighter-rouge">/etc</code>/ and <code class="language-plaintext highlighter-rouge">/root</code> are rsynced to the new layer</li>
  <li>UIDs and GIDs are synchronized across packages, in case a drift occurred inbetween images for UIDs/GIDs which are not fixed</li>
  <li>A new bootloader entry is added and set as the default</li>
</ul>

<h2 id="rpm-persistence">RPM persistence</h2>

<ul>
  <li>An additional plugin can be added to imgbased which also consumes the ‘on-layer-added’ hook</li>
</ul>

<p>A reliable mechanism must be written in order to capture packages as they are installed, however.</p>

<p><a href="http://yum.baseurl.org/api/yum/yum/packages.html?highlight=yum.packages.packageobjec#yum.packages.PackageObject">yum.PackageObject</a> is able to immediately provide the location of a cached RPM (after downloading or from localinstall), and this is available as part of yum plugin hooks.</p>

<p>It <em>may</em> be possible to <a href="https://rpm-software-management.github.io/rpm/manual/plugins.html">extend RPM</a>, but some research must be done in order to discover whether RPM’s plugin interface is as informative as yum.PackageObject. It is possible that RPM’s plugin mechanism only triggers during the execution of the RPM specfile, and cannot be used to pin down the location of the actual package. This also provides the additional burden of maintaining a small codebase in C, though that may be an acceptable tradeoff.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="yum-plugin">yum plugin</h3>

<p>yum provides a <a href="http://yum.baseurl.org/wiki/WritingYumPlugins.html">variety of places to add hooks</a>, and actually somewhat more than what’s listed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>args
clean
close
compare_providers
config
exclude
historybegin
historyend
init
postconfig
postdownload
postreposetup
postresolve
posttrans
postverifytrans
predownload
prelistenabledrepos
prereposetup
preresolve
pretrans
preverifytrans
verify_package
</code></pre></div></div>

<p>While not all of these hooks run while yum has the package cached, we can rely on <code class="language-plaintext highlighter-rouge">pretrans</code> to have the cached package available, both for <code class="language-plaintext highlighter-rouge">yum localinstall</code> and <code class="language-plaintext highlighter-rouge">yum install</code>.</p>

<p>Though the hook should be limited to only run during certain transaction types (install, upgrade), the transaction package object is available, and we can grab the local file from <a href="http://yum.baseurl.org/api/yum/yum/packages.html#yumavailablepackage">YumAvailablePackage.localPkg</a> and save it off to /var, which is a persistent filesystem on Node NG, which is not versioned per layer.</p>

<p>The yum plugin will add a hook into <code class="language-plaintext highlighter-rouge">pretrans</code></p>

<ul>
  <li>The pretrans conduit is able to retrieve the transaction set from yum</li>
  <li>Inside this transaction set, if a package is being installed or updated, <code class="language-plaintext highlighter-rouge">TransactionSet.installed</code> will contain all package objects</li>
  <li>We can iterate over the package objects, and retrieve <code class="language-plaintext highlighter-rouge">TransactionSet.PackageObject.localpkg()</code> (this is actually <code class="language-plaintext highlighter-rouge">po.localpkg</code>, since yum uses short variable internally</li>
  <li>The package will be copied over to <code class="language-plaintext highlighter-rouge">/var/imgbased/persisted-rpms</code></li>
  <li>Using the yum cache is not reliable, as <code class="language-plaintext highlighter-rouge">yum clean all</code> would remove cached RPMs, and <code class="language-plaintext highlighter-rouge">yum localinstall</code> never touches the cache</li>
</ul>

<p>Additionally:</p>

<ul>
  <li>If the package set is empty, the plugin should check whether <code class="language-plaintext highlighter-rouge">remove</code> or <code class="language-plaintext highlighter-rouge">uninstall</code> have been used as verbs</li>
  <li>If they are, a <code class="language-plaintext highlighter-rouge">posttrans</code> hook can be used to remove the specified packages from <code class="language-plaintext highlighter-rouge">/var/imgbased/persisted-rpms</code>, so they are not spuriously installed again when users upgrade</li>
</ul>

<p>The yum plugin should provide a configuration file, with only one parameter necessary:</p>

<ul>
  <li>excludepkgs=foo,bar</li>
</ul>

<p>Any package which is on the list of exclusions will not be persisted.</p>

<h3 id="imgbased-plugin">imgbased plugin</h3>

<p>A new imgbased plugin will be added, which triggers when a new layer is added.</p>

<ul>
  <li>This plugin will mount the new layer, and bind mount /var into the tree</li>
  <li>Then we’ll set up a local yum repository, pointed at <code class="language-plaintext highlighter-rouge">/var/imgbased/persisted_packages</code>, and install all RPMs</li>
</ul>

<h3 id="imgbased-extension">imgbased extension</h3>

<p>With the packages saved in /var, imgbased.osupdater can set up a local yum repository which points at <code class="language-plaintext highlighter-rouge">/var/imgbased/persisted_packages</code> (pathname to be determined), and install them when osupdater triggers during a Node update.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2907/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2907/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2907/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2907/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/node/node-next-persistence.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/node/node-next-persistence.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
