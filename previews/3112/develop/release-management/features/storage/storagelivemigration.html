<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>StorageLiveMigration | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="StorageLiveMigration" />
<meta name="author" content="Ayal Baron" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3112/develop/release-management/features/storage/storagelivemigration.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3112/develop/release-management/features/storage/storagelivemigration.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="StorageLiveMigration" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Ayal Baron" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Ayal Baron"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"StorageLiveMigration","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3112/images/logo.svg"},"name":"Ayal Baron"},"url":"https://ovirt.github.io/ovirt-site/previews/3112/develop/release-management/features/storage/storagelivemigration.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3112/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3112/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3112/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3112/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3112/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3112/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3112/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3112/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3112/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3112/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3112/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3112/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3112/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3112/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3112/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3112/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3112/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3112/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3112/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3112/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3112/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3112/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3112//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3112//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3112/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3112/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3112/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3112/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3112/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/a283ddeeff169a8d3dbc71a3d6d3a2e5?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ayal Baron">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ayal Baron</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/2cd558daf047b198cf2152940ec6a812?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/2cd558daf047b198cf2152940ec6a812?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Federico Simoncelli">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Federico Simoncelli</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/869d772390b0b317e4b37bb0714ab68e?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/869d772390b0b317e4b37bb0714ab68e?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Allon Mureinik">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Allon Mureinik</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Daniel Erez">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Daniel Erez</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3112/documentation/'>Documentation is available here.</a></div>

<h1 id="storage-live-migration">Storage Live Migration</h1>

<p>Live block migration is the operation in charge of moving a running VM and its disks from one storage domain to another.</p>

<h2 id="gui">GUI</h2>

<p>No major GUI modifications are required. The action to move a VM from one storage to another should be enabled also when the VM is running,
in which case the engine will issue a live block migration.</p>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigrationGUI.png" alt="" /></p>

<h2 id="pre-copy-post-copy-and-mirrored-snapshot">Pre-Copy, Post-Copy and Mirrored-Snapshot</h2>

<ul>
  <li><strong>Pre-Copy:</strong> copy all the internal volumes and then live copy the leaf volume, when the task is completed live migrate the VM.
    <ul>
      <li><strong>Pros:</strong> safer and simpler to manage in the oVirt engine and VDSM.</li>
      <li><strong>Cons:</strong> if the snapshots are no longer needed then a lot of data is copied needlessly. NB. Not implemented upstream yet.</li>
    </ul>
  </li>
  <li><strong>Post-Copy:</strong> live migrate the VM with a live snapshot to the new domain, copy the internal volumes and when the task is completed switch the leaf backing file.
    <ul>
      <li><strong>Pros:</strong> better approach for HA/load balancing.</li>
      <li><strong>Cons:</strong> complex management in the oVirt engine and VDSM. Disk is split across multiple domains.</li>
    </ul>
  </li>
  <li><strong>Mirrored-Snapshot:</strong> mirror a new live snapshot on both source and destination, copy the parent volume to the destination and when completed switch to the new image.
    <ul>
      <li><strong>Pros:</strong> no need to implement cross-domain volume chains in VDSM.</li>
    </ul>
  </li>
</ul>

<p>Reference: <a href="http://wiki.qemu.org/Features/LiveBlockMigration">http://wiki.qemu.org/Features/LiveBlockMigration</a></p>

<h2 id="pre-copy-execution-diagrams-and-description">Pre-Copy Execution Diagrams and Description</h2>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigration3.png" alt="" /></p>

<p>The <strong>preliminary snapshot</strong> in <strong>step 2</strong> is not mandatory but it’s preferable since it will allow almost the entire copy to be done externally by the SPM (and not by the qemu-kvm process).</p>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigrationAPIDiagram3.png" alt="" /></p>

<h3 id="rest-api">REST API</h3>

<p>The REST API should take advantage of the <code class="language-plaintext highlighter-rouge">POST</code> operation on a VM disk, specifying the new storage domain.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/vms/{vm:id}/disks/{disk:id} HTTP/1.1
Accept: application/xml
Content-type: application/xml

<span class="nt">&lt;disk&gt;</span>
    <span class="nt">&lt;storage_domains&gt;</span>
        <span class="nt">&lt;storage_domain</span> <span class="na">id=</span><span class="s">"{storage_domain:id}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/storage_domains&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</code></pre></div></div>

<h3 id="engine-flow">Engine Flow</h3>

<p>Pseudocode (work in progress):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">storageLiveMigration</span><span class="p">(</span><span class="n">spmHost</span><span class="p">,</span> <span class="n">vmHost</span><span class="p">):</span>
    <span class="c1"># Start moving the image to the destination (leaf not included)
</span>    <span class="n">spmTask</span> <span class="o">=</span> <span class="n">spmHost</span><span class="p">.</span><span class="n">moveImage</span><span class="p">(</span><span class="n">spUUID</span><span class="p">,</span> <span class="n">srcDomUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">imgUUID</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">LIVECOPY_OP</span><span class="p">)</span>
    <span class="c1"># Wait for the empty leaf to appear on the destination
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">spmHost</span><span class="p">.</span><span class="n">getTaskStatus</span><span class="p">(</span><span class="n">spmTask</span><span class="p">)</span>
        <span class="c1"># If the task got interrupted try to delete the image on the destination and fail
</span>        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Failed</span><span class="p">:</span>
            <span class="n">spmHost</span><span class="p">.</span><span class="n">deleteImage</span><span class="p">(</span><span class="n">spUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">imgUUID</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">FailureException</span>
        <span class="c1"># Check that the new leaf has been created on the destination
</span>        <span class="n">status</span> <span class="o">=</span> <span class="n">spmHost</span><span class="p">.</span><span class="n">getVolumeInfo</span><span class="p">(</span><span class="n">spUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">imgUUID</span><span class="p">,</span> <span class="n">leafUUID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Done</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># Timeout?
</span>    <span class="c1"># Initiate the block migration in qemu-kvm
</span>    <span class="n">hsmTask</span> <span class="o">=</span> <span class="n">vmHost</span><span class="p">.</span><span class="n">blockMigrateStart</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">"srcDomUUID"</span><span class="p">:</span> <span class="n">srcDomUUID</span><span class="p">,</span>
        <span class="s">"dstDomUUID"</span><span class="p">:</span> <span class="n">dstDomUUID</span><span class="p">,</span>
        <span class="s">"imgUUID"</span><span class="p">:</span>    <span class="n">imgUUID</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">spmStatus</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">hsmStatus</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Wait for both the spm copy and the hsm copy/mirroring to finish
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spmStatus</span> <span class="o">!=</span> <span class="n">Done</span><span class="p">:</span>
            <span class="n">spmStatus</span> <span class="o">=</span> <span class="n">spmHost</span><span class="p">.</span><span class="n">getTaskStatus</span><span class="p">(</span><span class="n">spmTask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hsmStatus</span> <span class="o">!=</span> <span class="n">Done</span><span class="p">:</span>
            <span class="n">hsmStatus</span> <span class="o">=</span> <span class="n">hsmHost</span><span class="p">.</span><span class="n">getBlockMigrateStatus</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">hsmTask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spmStatus</span> <span class="o">==</span> <span class="n">Done</span> <span class="ow">and</span> <span class="n">hsmStatus</span> <span class="o">==</span> <span class="n">Done</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">spmStatus</span> <span class="o">==</span> <span class="n">Failure</span> <span class="ow">or</span> <span class="n">hsmStatus</span> <span class="o">==</span> <span class="n">Failure</span><span class="p">:</span>
            <span class="c1"># FIXME: we probably need more here
</span>            <span class="c1"># Reopen the leaf only on the source
</span>            <span class="n">vmHost</span><span class="p">.</span><span class="n">blockMigrateEnd</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">hsmTask</span><span class="p">,</span> <span class="n">srcDomUUID</span><span class="p">)</span>
            <span class="n">spmHost</span><span class="p">.</span><span class="n">deleteImage</span><span class="p">(</span><span class="n">spUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">imgUUID</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">FailureException</span>
    <span class="c1"># Finalize the migration to the destination
</span>    <span class="n">vmHost</span><span class="p">.</span><span class="n">blockMigrateEnd</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">hsmTask</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="vdsm-spm">VDSM SPM</h3>

<p>Add a new <code class="language-plaintext highlighter-rouge">moveImage</code> operation: <strong><code class="language-plaintext highlighter-rouge">LIVECOPY_OP</code></strong> (<code class="language-plaintext highlighter-rouge">0x03</code>):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">moveImage</span><span class="p">(</span><span class="n">spUUID</span><span class="p">,</span> <span class="n">srcDomUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">imgUUID</span><span class="p">,</span> <span class="n">vmUUID</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">postZero</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">spUUID</code>:</strong> storage pool UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">srcDomUUID</code>:</strong> source domain UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">dstDomUUID</code>:</strong> destination domain UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">imgUUID</code>:</strong> image UUID (it will be maintained on the destination)</li>
  <li><strong><code class="language-plaintext highlighter-rouge">vmUUID</code>:</strong> unused</li>
  <li><strong><code class="language-plaintext highlighter-rouge">op</code>:</strong> must be LIVECOPY_OP (0x03)</li>
  <li><strong><code class="language-plaintext highlighter-rouge">postZero</code>:</strong> unused</li>
  <li><strong><code class="language-plaintext highlighter-rouge">force</code>:</strong> unused</li>
</ul>

<p>Description of <strong>LIVECOPY_OP</strong>:</p>

<ul>
  <li>it copies all the volumes up to the leaf (not included)</li>
  <li>it prepares an empty volume for the leaf on the destination</li>
  <li>it doesn’t automatically rollback (because the SPM doesn’t know if the qemu-kvm process is already mirroring the new leaf)</li>
</ul>

<h3 id="vdsm-hsm">VDSM HSM</h3>

<p>Add the new block migrate commands:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">blkTask</span> <span class="o">=</span> <span class="n">blockMigrateStart</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">blkMigParams</span><span class="p">)</span>
    <span class="n">blkStatus</span> <span class="o">=</span> <span class="n">getBlockMigrateStatus</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">blkTask</span><span class="p">)</span>
    <span class="n">blockMigrateEnd</span><span class="p">(</span><span class="n">vmUUID</span><span class="p">,</span> <span class="n">blkTask</span><span class="p">,</span> <span class="n">tgtDomUUID</span><span class="p">)</span>
</code></pre></div></div>

<p>The only format supported for <strong><code class="language-plaintext highlighter-rouge">blkMigParams</code></strong> at the moment is:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">blkMigParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"srcDomUUID"</span><span class="p">:</span> <span class="s">"`&lt;srcDomUUID&gt;`"</span><span class="p">,</span>
        <span class="s">"dstDomUUID"</span><span class="p">:</span> <span class="s">"`&lt;dstDomUUID&gt;`"</span><span class="p">,</span>
        <span class="s">"imgUUID"</span><span class="p">:</span>    <span class="s">"`&lt;imgUUID&gt;`"</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">vmUUID</code>:</strong> VM UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">srcDomUUID</code>:</strong> source domain UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">dstDomUUID</code>:</strong> destination domain UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">imgUUID</code>:</strong> image UUID (it will be maintained on the destination)</li>
  <li><strong><code class="language-plaintext highlighter-rouge">blkTask</code>:</strong> a block task UUID</li>
  <li><strong><code class="language-plaintext highlighter-rouge">tgtDomUUID</code>:</strong> the target domain UUID to switch to (can be source or destination)</li>
</ul>

<p>Description of <strong><code class="language-plaintext highlighter-rouge">blockMigrateStart</code></strong>:</p>

<ul>
  <li>It should resize the new leaf on the destination to the size of the leaf on the source (using <code class="language-plaintext highlighter-rouge">lvExtend</code>),
this might not always result in an extension if a preliminary snapshot has been taken before the mirroring</li>
  <li>When the block device has been extended it relies on <code class="language-plaintext highlighter-rouge">virDomainBlockRebase</code> to start the mirroring and streaming</li>
</ul>

<p>Description of <strong><code class="language-plaintext highlighter-rouge">getBlockMigrateStatus</code></strong>:</p>

<ul>
  <li>It relies on <code class="language-plaintext highlighter-rouge">virDomainBlockJobInfo</code> to get the status of the block job</li>
</ul>

<p>Description of <strong>blockMigrateEnd</strong>:</p>

<ul>
  <li>It relies on <code class="language-plaintext highlighter-rouge">virDomainBlockJobAbort</code> both to pivot to the destination or fallback to the source</li>
</ul>

<h4 id="libvirt-function-calls">Libvirt Function Calls</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">virDomainBlockRebase</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="s">"/path/to/copy"</span><span class="p">,</span>
        <span class="n">VIR_DOMAIN_BLOCK_REBASE_COPY</span> <span class="o">|</span> <span class="n">VIR_DOMAIN_BLOCK_REBASE_SHALLOW</span> <span class="o">|</span>
        <span class="n">VIR_DOMAIN_BLOCK_REBASE_REUSE_EXT</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">virDomainBlockRebase</code> function call is used to start the mirroring and streaming.
This call assumes that <strong>/path/to/copy</strong> is already present (and initialized) and only the leaf content will be streamed to the new destination (no squashing).</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">virDomainBlockJobAbort</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">virDomainBlockJobAbort</code> function call with the <code class="language-plaintext highlighter-rouge">flags=0</code> is used to safely switch back on the source (it can be used at any time).</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">virDomainBlockJobAbort</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">VIR_DOMAIN_BLOCK_JOB_ABORT_PIVOT</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">virDomainBlockJobAbort</code> function call with the <code class="language-plaintext highlighter-rouge">flags=VIR_DOMAIN_BLOCK_JOB_ABORT_PIVOT</code> is used to pivot to the destination (drive-reopen).
It will fail if there is a streaming in progress. Eventually (probably not in VDSM) it can be used as polling mechanism to switch to the destination.</p>

<h4 id="watermark-and-lv-extend">Watermark and LV Extend</h4>

<p>On block domains VDSM is monitoring the qemu-kvm process watermark on the disks (how much space is actually used on the block devices).
During the mirroring the logical volumes extension should be replicated on the destination (with a 20% size increase because of the bitmap used during mirroring).</p>

<h1 id="storage-live-migration-alternatives">Storage Live Migration Alternatives</h1>

<h2 id="post-copy-execution-diagrams-and-description">Post-Copy Execution Diagrams and Description</h2>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigration1.png" alt="" /></p>

<ul>
  <li><strong>Note on [3]</strong>: when the SPM finishes the operation it’s also responsible to set the ‘Snapshot 2 Volume’ metadata to point to
‘Snapshot 1 Volume’ on ‘Source Domain’ even if the real swap happens in the next step.</li>
</ul>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigrationAPIDiagram1.png" alt="" /></p>

<h3 id="limitations-and-risks">Limitations and Risks</h3>

<ul>
  <li>VDSM doesn’t have the proper metadata to describe a VM running on volumes stored on two different storage domains</li>
  <li>missing libvirt operation to change the volume backing file on the fly, new design and patches:
    <ul>
      <li><a href="https://www.redhat.com/archives/libvir-list/2012-January/msg01448.html">https://www.redhat.com/archives/libvir-list/2012-January/msg01448.html</a></li>
      <li><a href="https://www.redhat.com/archives/libvir-list/2012-February/msg00014.html">https://www.redhat.com/archives/libvir-list/2012-February/msg00014.html</a></li>
    </ul>
  </li>
</ul>

<h3 id="engine-flow-1">Engine Flow</h3>

<p>Pseudocode:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">vm_live_block_migrate</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">destDomain</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">drive</span> <span class="ow">in</span> <span class="n">vm_get_drives</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
        <span class="n">createVolumeCrossSD</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span> <span class="c1"># to the SPM
</span>    <span class="c1"># Retry until it succeed or fails with a known error
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">blockMigrate</span><span class="p">(</span><span class="n">driveParams</span><span class="p">)</span> <span class="c1"># to the HSM
</span>        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SUCCESS</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">VM_NOT_RUNNING</span><span class="p">:</span>
            <span class="c1"># rollback the createVolumeCrossSD operations
</span>            <span class="k">return</span> <span class="n">VM_NOT_RUNNING</span>
    <span class="k">for</span> <span class="n">drive</span> <span class="ow">in</span> <span class="n">vm_get_drives</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">cloneInternalVolumes</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SUCESS</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="n">finalizeBlockMigrate</span><span class="p">()</span> <span class="c1"># to the HSM
</span></code></pre></div></div>

<h2 id="mirrored-snapshot-execution-diagrams-and-description">Mirrored-Snapshot Execution Diagrams and Description</h2>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigration2.png" alt="" /></p>

<p><img src="/ovirt-site/previews/3112/images/wiki/StorageLiveMigrationAPIDiagram2.png" alt="" /></p>

<h3 id="vdsm-api">VDSM API</h3>

<p>The command <code class="language-plaintext highlighter-rouge">copyVolume(...)</code> is used in step 2 and 4 to copy the volumes from the source to the destination.
For maximum flexibility it’s possible to change the volume and image UUIDs (on the destination) and update the parent volume UUID (so that it’s possible
to rebuild a consistent chain on the destination).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copyVolume</span><span class="p">(</span><span class="n">srcDomUUID</span><span class="p">,</span> <span class="n">dstDomUUID</span><span class="p">,</span> <span class="n">srcImgUUID</span><span class="p">,</span> <span class="n">dstImgUUID</span><span class="p">,</span>
               <span class="n">srcVolUUID</span><span class="p">,</span> <span class="n">dstVolUUID</span><span class="p">,</span> <span class="n">dstBakImgUUID</span><span class="p">,</span> <span class="n">dstBakVolUUID</span><span class="p">):</span>
    <span class="s">"""
    Copies a single volume from a source (domain, image, volume) to a new
    destination (domain, image, volume).
    If dstBakVolUUID is specified it will be used to rebase (unsafe) the
    volume (if dstBakImgUUID is not specified, dstImgUUID will be used).
    If dstBakVolUUID is not specified and the source volume has a parent,
    then the same srcImgUUID and srcVolUUID will be reused.
    :param srcDomUUID: The source storage domain UUID
    :type srcDomUUID: UUID
    :param dstDomUUID: The destination storage domain UUID
    :type dstDomUUID: UUID
    :param srcImgUUID: The source image UUID
    :type srcImgUUID: UUID
    :param dstImgUUID: The destination image UUID
    :type dstImgUUID: UUID
    :param srcVolUUID: The source volume UUID
    :type srcVolUUID: UUID
    :param dstVolUUID: The destination volume UUID
    :type dstVolUUID: UUID
    :param dstBakImgUUID: The new backing image UUID for the destination
                          (optional parameter)
    :type dstBakImgUUID: UUID
    :param dstBakVolUUID: The new backing volume UUID for the destination
                          (optional parameter)
    :type dstBakVolUUID: UUID
    """</span>
</code></pre></div></div>

<h3 id="engine-flow-2">Engine Flow</h3>

<ul>
  <li>Copy over all non-leaf volumes from source to destination (Step 2).</li>
  <li>Create a new volume for the disk on source and destination.</li>
  <li>Mark “Snapshot 1” (old leaf) as <code class="language-plaintext highlighter-rouge">MERGE_PENDING</code>.</li>
  <li>Mark “Snapshot 2” (new leaf) with the same <code class="language-plaintext highlighter-rouge">SNAPSHOT_ID</code> of “Snapshot 1” (NB. do <strong>not</strong> mark with <code class="language-plaintext highlighter-rouge">MERGE_PENDING</code>) - So that we know that this is the snapshot to work with.</li>
  <li>Call live snapshot with all (other disks) existing volumes the same, but this disk in mirroring mode with the new volumes on source and destination.</li>
  <li>Copy over the old leaf (it is merge pending).</li>
  <li>When finished, reopen on destination and delete disk on source. If the VM is down, do the next step.</li>
  <li>When VM stops/Disk is deactivated (unplugged) and the migration had finished - the Disk will go to locked state and cold merge for all pending merges of same snapshots will
begin (ie if we have 1 volume that is merge pending for snapshot id S1, and 1 volume that is merge pending for snapshot id S2).
In this state you can’t run the VM with the disk, so you can run without it, or have to wait for merge to finish.</li>
</ul>

<h4 id="engine-flow-diagram">Engine flow diagram</h4>

<p><img src="/ovirt-site/previews/3112/images/wiki/SLM.png" alt="" /></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3112/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3112/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3112/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3112/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2023 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/storagelivemigration.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/storagelivemigration.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
