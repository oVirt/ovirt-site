<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Cumulative RX TX Statistics | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Cumulative RX TX Statistics" />
<meta name="author" content="Dan Kenigsberg" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2782/develop/release-management/features/network/cumulative-rx-tx-statistics.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2782/develop/release-management/features/network/cumulative-rx-tx-statistics.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Cumulative RX TX Statistics" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dan Kenigsberg" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Dan Kenigsberg"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2782/images/logo.svg"},"name":"Dan Kenigsberg"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Cumulative RX TX Statistics","url":"https://ovirt.github.io/ovirt-site/previews/2782/develop/release-management/features/network/cumulative-rx-tx-statistics.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2782/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2782/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2782/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2782/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2782/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2782/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2782/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2782/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2782/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2782/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2782/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2782/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2782/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2782/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2782/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2782/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2782/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2782/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2782/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2782/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2782/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2782/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2782/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2782/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2782/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2782/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2782/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2782/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2782/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2782/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2782/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2782/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2782/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2782/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2782/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2782//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2782//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2782/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2782/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2782/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2782/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2782/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9a2fc6e0042ddce31e9484d1ed181663?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9a2fc6e0042ddce31e9484d1ed181663?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Lior Vernia</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2782/documentation/'>Documentation is available here.</a></div>

<h1 id="cumulative-network-usage-statistics">Cumulative Network Usage Statistics</h1>

<h2 id="summary">Summary</h2>

<p>This feature will implement reporting of total received/transmitted bytes per network interface (both for hosts and for VMs), on top of the currently-reported receive/transmit rate.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Lior Vernia</li>
  <li>Email: lvernia@redhat.com</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Numerous benefits have been suggested:</p>

<ul>
  <li>This data is useful in several use cases (e.g. hosting services), where total VM network usage needs to be accounted for. While it’s possible to compute total usage out of the reported rates, it requires implementing some logic in a script, and the precision of the reported rate is limited).</li>
  <li>Due to the aforementioned limited precision of reported rate (e.g. traffic needs to be bigger, on average over a 15-second period, than an interface’s speed divided by 1000 to be reported), reporting the total RX/TX statistics will allow to spot thinner traffic going through the interface, for example to make sure that an interface is operational.</li>
  <li>The reported ‘speed’ of each interface is nothing to be trusted. It may change during <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1118699">1118699 a single measurement window</a>, causing currently-reported rxRate/txRate utterly meaningless.</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>Currently, the only network usage statistics reported for network interfaces (whether host or VM) are momentary receive/transmit rates. By popular demand, as part of this feature reporting will be added for total received/transmitted bytes for both hosts and VMs, both in the GUI and via REST.</p>

<p>This will generally be implemented by having vdsm report total RX/TX byte statistics and sample times back to the engine, and having the engine store and show those statistics, as well as compute the average rate from the previous sample rather than depend on the reported vdsm rate (depending on cluster compatibility version).</p>

<p>To store cumulative statistics from the beginning of a VM interface’s life to its end, surviving shut downs, migrations and hot-unplugs - these reset the counters on the network devices - we will have to also store for each interface offset numbers for RX and TX traffic (and update whenever one of the above cases happen). A nice touch would be to also keep these offsets for hosts, starting from zero when they’re added to a deployment, which will enable VDI-type deployments to keep count of total network resources used by their hosts (e.g. in case the hosts are leased from a VPS provider).</p>

<p>All values will be stored as Long - this will limit them to values up to 2^63 (as Java currently only uses signed longs). This is probably okay and we would not have to deal with wraparound values. Null values will correspond to hosts/VMs residing in incompatible clusters (where the data is not reported so it’s not available).</p>

<h4 id="entity-description">Entity Description</h4>

<p>No new entities need to be implemented, but NetworkStatistics (used by both host and VM interfaces) will be added total RX, total TX, RX offset, TX offset and sample time members. Corresponding columns will be added to the vds_interface_statistics and vm_interface_statistics tables, whose DAOs will have to be updated accordingly. Related views will need to be updated as well.</p>

<h4 id="engine-flows">Engine Flows</h4>

<p>Whenever new statistics reported by vdsm (either for a host or for a VM) are collected for persistence to the DB, and assuming cluster compatibility version &gt;= 3.6:</p>

<ul>
  <li>Total RX/TX should be updated, after accounting for the offset at the time.</li>
  <li>The sample time should be stored as reported.</li>
  <li>RX/TX rates should be computed from the difference between the sampled values divided by the difference between sample times. Special care should be taken with statistics reported for the first time, when the previous sample value and sample time should be null - in which case, it’s best to set the rate to null (it will be updated as soon as the next sample arrives). Similar care should be taken if the time interval isn’t positive - this likely means that the host had been rebooted and the time measurement had reset.</li>
  <li>RX/TX offsets should be updated if the reported value is bigger than the previous one - this means that for some reason, RX/TX counters had reset. The offset should be set to the previously reported values (newly sampled values will start from zero again, so they would have to be added to whatever had been accumulated before). This should take care of VM interface hot-unplug, VM migration and host/VM reboot/shutdown. As with the rates, caution should be exercised in the case of a first-time measurement - this would mean that the interface has not been encountered yet, therefore its offset should be set to minus the currently-reported total RX/TX (so that accounting will begin from zero at this point in time).</li>
</ul>

<p>If the cluster compatibility version &lt; 3.6, rate and drop statistics should be updated as before, and the newly-reported statistics should be set to null (including the internally-used offsets). This should take care of hosts/VMs being moved from a compatible cluster to an incompatible one - whenever the first statistics data arrive in the new cluster, previous values will be cleared.</p>

<h4 id="user-experience">User Experience</h4>

<p>The “new” statistics should be reported as additional columns in all the existing tables where interface statistics are displayed: host/interfaces subtab, VM/interfaces subtab, network/hosts subtab, network/VMs subtab.</p>

<h4 id="vdsm">VDSM</h4>

<p>New data entries should be added to the NIC dictionaries reported in getVdsStats and getVmStats: “rx”, “tx” and “sampleTime”.</p>

<p><a href="http://gerrit.ovirt.org/#/q/status:merged+project:vdsm+branch:master+topic:rx_tx,n,z">http://gerrit.ovirt.org/#/q/status:merged+project:vdsm+branch:master+topic:rx_tx,n,z</a></p>

<h4 id="rest">REST</h4>

<p>New data entries should be added to the host and VM NIC statistical queries: “data.total.rx” and “data.total.tx”. There’s no apparent reason to expose the sample time, as the existing RFEs haven’t asked for it - it could be exposed in the future if need be. The new entries should all be of type “Counter”, of value “Integer” and of unit “Bytes”.</p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li>RFE for vdsm to report total byte count: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1066570">https://bugzilla.redhat.com/show_bug.cgi?id=1066570</a>.</li>
  <li>RFE for engine to report it via the GUI and REST: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1063343">https://bugzilla.redhat.com/show_bug.cgi?id=1063343</a></li>
  <li>RFE requesting better accounting information in general: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1172153">https://bugzilla.redhat.com/show_bug.cgi?id=1172153</a></li>
  <li>Workaround using existing reported rates: <a href="https://lists.ovirt.org/pipermail/users/2014-November/029048.html">https://lists.ovirt.org/pipermail/users/2014-November/029048.html</a></li>
  <li>Various other requests on the users@ovirt.org mailing list.</li>
</ul>

<h2 id="testing">Testing</h2>

<h3 id="host-interfaces">Host interfaces</h3>

<ul>
  <li>Verify the reported RX/TX values correspond to the ones reported inside the host itself, when running for example “ip -s link show” on the interface.</li>
  <li>Verify that when a host is moved from a compatible cluster to an incompatible cluster, the total RX/TX statistics are reset.</li>
  <li>Initiate constant traffic on a host interface (for example by using iperf), of a rate lower than the interface’s speed divided by 1000. Verify that while no rate is displayed, the total byte count increases as expected.</li>
</ul>

<h3 id="vm-interfaces">VM interfaces</h3>

<ul>
  <li>Verify that total RX/TX statistics are reset to zero when:
    <ul>
      <li>A new interface is created.</li>
      <li>A VM is moved from an incompatible cluster to a compatible cluster.</li>
    </ul>
  </li>
  <li>Verify that total RX/TX statistics are NOT reset to zero when:
    <ul>
      <li>An interface is hot-unplugged and then hot-plugged back.</li>
      <li>The VM is brought down and then up (possibly unplugging and plugging interfaces while the VM is down).</li>
      <li>The VM is migrated.</li>
    </ul>
  </li>
  <li>Verify that total RX/TX statistics are cleared (not reported) when:
    <ul>
      <li>A new interface is created for a VM in an incompatible cluster.</li>
      <li>A VM is moved from a compatible cluster to an incompatible cluster.</li>
    </ul>
  </li>
  <li>Run the same traffic test as with the host interfaces.</li>
</ul>

<h2 id="contingency-plan">Contingency Plan</h2>

<p>Could be postponed to the next minor version - this feature doesn’t provide critical functionality, and workarounds exist.</p>

<h2 id="comments-and-discussion">Comments and Discussion</h2>

<p>At the moment there don’t appear to be any critical open issues concerning this feature. The feature is being discussed in a dedicated thread on the users@ovirt.org mailing list.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2782/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2782/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2782/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2782/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/cumulative-rx-tx-statistics.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/network/cumulative-rx-tx-statistics.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
