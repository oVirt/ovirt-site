<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Upgrade Guide | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Upgrade Guide" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3179/documentation/upgrade_guide/" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3179/documentation/upgrade_guide/" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Upgrade Guide" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Upgrade Guide","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3179/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3179/documentation/upgrade_guide/"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3179/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3179/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3179/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3179/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3179/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3179/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3179/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3179/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/download/'>Download</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3179/documentation/'>Documentation</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3179//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/documentation/">
              <span property="name">Documentation</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
        
        <section id="content" class="content container">
          
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#upgrade-overview">1. oVirt Upgrade Overview</a></li>
<li><a href="#upgrading-standalone-engine-local-database-environment">2. Upgrading a standalone Engine local database environment</a></li>
<li><a href="#Upgrading_from_4-4">3. Upgrading from oVirt 4.4 to 4.5</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-4_local_db">3.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_local_db">3.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-5_4-4_local_db">3.3. Upgrading the oVirt Engine from 4.4 to 4.5</a></li>
<li><a href="#Upgrading_hosts_to_4-5_4-4_local_db">3.4. Migrating hosts oVirt 4.4 to 4.5</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-4_local_db">3.5. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_local_db">3.6. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_local_db">3.7. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#Upgrading_from_4-3">4. Upgrading from oVirt 4.3 to 4.4</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-3_local_db">4.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_local_db">4.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-4_4-3_local_db">4.3. Upgrading the oVirt Engine from 4.3 to 4.4</a></li>
<li><a href="#Upgrading_hosts_to_4-4_4-3_local_db">4.4. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</a></li>
<li><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_local_db">4.5. Upgrading oVirt Node while preserving local storage</a></li>
<li><a href="#Upgrading_hypervisor_preserve_gluster_storage">4.6. Upgrading oVirt Node while preserving Gluster storage</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-3_local_db">4.7. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_local_db">4.8. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_local_db">4.9. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#Upgrading_from_4-2">5. Upgrading from oVirt 4.2 to 4.3</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-2_local_db">5.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_local_db">5.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-3_4-2_local_db">5.3. Upgrading the oVirt Engine from 4.2 to 4.3</a></li>
<li><a href="#Updating_all_hosts_in_a_cluster_4-2_local_db">5.4. Updating All Hosts in a Cluster</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-2_local_db">5.5. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_local_db">5.6. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_local_db">5.7. Changing the Data Center Compatibility Version</a></li>
<li><a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_local_db">5.8. Replacing SHA-1 Certificates with SHA-256 Certificates</a></li>
</ul>
</li>
<li><a href="#upgrading-standalone-engine-remote-database-environment">6. Upgrading a standalone Engine remote database environment</a></li>
<li><a href="#Remote_Upgrading_from_4-4">7. Upgrading a Remote Database Environment from oVirt 4.4 to 4.5</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-4_remote_db">7.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_remote_db">7.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-5_4-4_remote_db">7.3. Upgrading the oVirt Engine from 4.4 to 4.5</a></li>
<li><a href="#Upgrading_hosts_to_4-5_4-4_remote_db">7.4. Migrating hosts oVirt 4.4 to 4.5</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-4_remote_db">7.5. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_remote_db">7.6. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_remote_db">7.7. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#Remote_Upgrading_from_4-3">8. Upgrading a Remote Database Environment from oVirt 4.3 to 4.4</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-3_remote_db">8.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_remote_db">8.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-4_4-3_remote_db">8.3. Upgrading the oVirt Engine from 4.3 to 4.4</a></li>
<li><a href="#proc_upgrading-the-remote-data-warehouse-service-and-database_4-3_remote_db">8.4. Upgrading the remote Data Warehouse service and database</a></li>
<li><a href="#Upgrading_hosts_to_4-4_4-3_remote_db">8.5. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</a></li>
<li><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_remote_db">8.6. Upgrading oVirt Node while preserving local storage</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-3_remote_db">8.7. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_remote_db">8.8. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_remote_db">8.9. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#Remote_Upgrading_from_4-2">9. Upgrading a Remote Database Environment from oVirt 4.2 to 4.3</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-2_remote_db">9.1. Prerequisites</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_remote_db">9.2. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_Remote_Databases_from_PG95_to_PG10_4-2_remote_db">9.3. Upgrading remote databases from PostgreSQL 9.5 to 10</a></li>
<li><a href="#Upgrading_the_Manager_to_4-3_4-2_remote_db">9.4. Upgrading the oVirt Engine from 4.2 to 4.3</a>
<ul class="sectlevel3">
<li><a href="#completing-the-remote-data-warehouse-database-upgrade">9.4.1. Completing the remote Data Warehouse database upgrade</a></li>
</ul>
</li>
<li><a href="#Updating_all_hosts_in_a_cluster_4-2_remote_db">9.5. Updating All Hosts in a Cluster</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-2_remote_db">9.6. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_remote_db">9.7. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_remote_db">9.8. Changing the Data Center Compatibility Version</a></li>
<li><a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_remote_db">9.9. Replacing SHA-1 Certificates with SHA-256 Certificates</a></li>
</ul>
</li>
<li><a href="#upgrading-self-hosted-engine-environment">10. Upgrading a self-hosted engine environment</a></li>
<li><a href="#SHE_Upgrading_from_4-4">11. Upgrading a self-Hosted engine from oVirt 4.4 to 4.5</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-4_SHE">11.1. Prerequisites</a></li>
<li><a href="#Migrating_VMs_from_SHE_host_4-4">11.2. Migrating virtual machines from the self-hosted engine host</a></li>
<li><a href="#Enabling_Global_Maintenance_Mode_4-4_SHE">11.3. Enabling global maintenance mode</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_SHE">11.4. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-5_4-4_SHE">11.5. Upgrading the oVirt Engine from 4.4 to 4.5</a></li>
<li><a href="#Upgrading_hosts_to_4-5_4-4_SHE">11.6. Migrating hosts oVirt 4.4 to 4.5</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-4_SHE">11.7. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_SHE">11.8. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_SHE">11.9. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#SHE_Upgrading_from_4-3">12. Upgrading a self-Hosted engine from oVirt 4.3 to 4.4</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-3_SHE">12.1. Prerequisites</a></li>
<li><a href="#Migrating_VMs_from_SHE_host">12.2. Migrating virtual machines from the self-hosted engine host</a></li>
<li><a href="#Enabling_Global_Maintenance_Mode_4-3_SHE">12.3. Enabling global maintenance mode</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_SHE">12.4. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-4_4-3_SHE">12.5. Upgrading the oVirt Engine from 4.3 to 4.4</a></li>
<li><a href="#Upgrading_hosts_to_4-4_4-3_SHE">12.6. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</a></li>
<li><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_SHE">12.7. Upgrading oVirt Node while preserving local storage</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-3_SHE">12.8. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_SHE">12.9. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_SHE">12.10. Changing the Data Center Compatibility Version</a></li>
</ul>
</li>
<li><a href="#SHE_Upgrading_from_4-2">13. Upgrading a Self-Hosted Engine from oVirt 4.2 to 4.3</a>
<ul class="sectlevel2">
<li><a href="#Upgrade_Prerequisites_4-2_SHE">13.1. Prerequisites</a></li>
<li><a href="#Enabling_Global_Maintenance_Mode_4-2_SHE">13.2. Enabling global maintenance mode</a></li>
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_SHE">13.3. Updating the oVirt Engine</a></li>
<li><a href="#Upgrading_the_Manager_to_4-3_4-2_SHE">13.4. Upgrading the oVirt Engine from 4.2 to 4.3</a></li>
<li><a href="#Disabling_Global_Maintenance_Mode_4-2_SHE">13.5. Disabling global maintenance mode</a></li>
<li><a href="#Updating_all_hosts_in_a_cluster_4-2_SHE">13.6. Updating All Hosts in a Cluster</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_4-2_SHE">13.7. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_SHE">13.8. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_SHE">13.9. Changing the Data Center Compatibility Version</a></li>
<li><a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_SHE">13.10. Replacing SHA-1 Certificates with SHA-256 Certificates</a></li>
</ul>
</li>
<li><a href="#updates-between-minor-releases">14. Updates between minor releases</a></li>
<li><a href="#Minor_Release_Updates">15. Updating oVirt between minor releases</a>
<ul class="sectlevel2">
<li><a href="#Updating_the_Red_Hat_Virtualization_Manager_minor_updates">15.1. Updating the oVirt Engine</a></li>
<li><a href="#Updating_a_self-hosted_engine_minor_updates">15.2. Updating a Self-Hosted Engine</a></li>
<li><a href="#Updating_all_hosts_in_a_cluster_minor_updates">15.3. Updating All Hosts in a Cluster</a></li>
<li><a href="#Changing_the_Cluster_Compatibility_Version_minor_updates">15.4. Changing the Cluster Compatibility Version</a></li>
<li><a href="#Changing_Virtual_Machine_Cluster_Compatibility_minor_updates">15.5. Changing Virtual Machine Cluster Compatibility</a></li>
<li><a href="#Changing_the_Data_Center_Compatibility_Version_minor_updates">15.6. Changing the Data Center Compatibility Version</a></li>
<li><a href="#Updating_Individual_Hosts_minor_updates">15.7. Updating Individual Hosts</a></li>
<li><a href="#Manually_Updating_Hosts_minor_updates">15.8. Manually Updating Hosts</a></li>
</ul>
</li>
<li><a href="#Updating_the_Local_Repository_for_an_Offline_Red_Hat_Enterprise_Virtualization_Manager_Installation">Appendix A: Updating the Local Repository for an Offline oVirt Engine Installation</a></li>
<li><a href="#ovirt-legal-notice">Appendix B: Legal notice</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<h1 id="upgrade-guide" class="discrete">Upgrade Guide</h1>
</div>
</div>
<div class="sect1">
<h2 id="upgrade-overview">1. oVirt Upgrade Overview</h2>
<div class="sectionbody">
<div id="Red_Hat_Virtualization_Upgrade_Overview" class="paragraph">
<p>This guide explains how to upgrade the following environments to oVirt 4.3 or 4.4 :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Self-hosted engine, local database</strong>: Both the Data Warehouse database and the Engine database are installed on the Engine.</p>
</li>
<li>
<p><strong>Standalone manager, local database</strong>: Both the Data Warehouse database and the Engine database are installed on the Engine.</p>
</li>
<li>
<p><strong>Standalone manager, remote database</strong>: Either the Data Warehouse database or the Engine database, or both, are on a separate machine.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Plan any necessary downtime in advance. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended VMs as soon as possible to apply the configuration changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Select the appropriate instructions for your environment from the following table. If your Engine and host versions differ (if you have previously upgraded the Engine but not the hosts), follow the instructions that match the Engine&#8217;s version.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported Upgrade Paths</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Current Engine version</th>
<th class="tableblock halign-left valign-top">Target Engine version</th>
<th class="tableblock halign-left valign-top">Relevant section</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.4</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Self-hosted engine, local database environment:</strong> <a href="#SHE_Upgrading_from_4-3">Upgrading a self-Hosted engine from oVirt 4.3 to 4.4</a></p>
</div>
<div class="paragraph">
<p><strong>Local database environment -</strong> <a href="#Upgrading_from_4-3">Upgrading from oVirt 4.3 to 4.4</a></p>
</div>
<div class="paragraph">
<p><strong>Remote database environment:</strong> <a href="#Remote_Upgrading_from_4-3">Upgrading a Remote Database Environment from oVirt 4.3 to 4.4</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Self-hosted engine, local database environment:</strong> <a href="#SHE_Upgrading_from_4-2">Upgrading a Self-Hosted Engine from oVirt 4.2 to 4.3</a></p>
</div>
<div class="paragraph">
<p><strong>Local database environment:</strong> <a href="#Upgrading_from_4-2">Upgrading from oVirt 4.2 to 4.3</a></p>
</div>
<div class="paragraph">
<p><strong>Remote database environment:</strong> <a href="#Remote_Upgrading_from_4-2">Upgrading a Remote Database Environment from oVirt 4.2 to 4.3</a></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="upgrading-standalone-engine-local-database-environment">2. Upgrading a standalone Engine local database environment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Upgrading_from_4-4">3. Upgrading from oVirt 4.4 to 4.5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.4 to 4.5 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-4_local_db">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_remote_db">Update the 4.4 Engine to the latest version of 4.4</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-5_4-4_local_db">Upgrade the Engine from 4.4 to 4.5</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-5_4-4_local_db">Migrate hosts and virtual machines while reducing virtual machine downtime</a></p>
</li>
<li>
<p><a href="#Upgrading_hypervisor_preserving_local_storage_4-4_local_db">(Optional) Upgrade oVirt Node while preserving local storage</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-4_local_db">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_local_db">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_local_db">Update the compatibility version of the data centers</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-4_local_db">3.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-4_local_db">3.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.5.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-5_4-4_local_db">3.3. Upgrading the oVirt Engine from 4.4 to 4.5</h3>
<div class="paragraph">
<p>oVirt Engine 4.5 is only supported on Enterprise Linux 8.6 or later.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf install -y centos-release-ovirt45</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
. Enable version 2.3 of the <code>mod_auth_openidc</code> module.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module -y enable mod_auth_openidc:2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then follow the procedure for updates between minor releases.</p>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-5_4-4_local_db">3.4. Migrating hosts oVirt 4.4 to 4.5</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.5 require Enterprise Linux 8.6 or later.</p>
</li>
<li>
<p>oVirt Engine 4.5 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.3 or higher.</p>
</li>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 higher before you start the procedure.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install -y centos-release-ovirt45</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts oVirt Nodes:</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install centos-release-ovirt45 --enablerepo=extras</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Common procedure</div>
<ol class="arabic">
<li>
<p>Follow the procedure for updates between minor releases.</p>
</li>
<li>
<p>Follow the procedure for updating the cluster compatibility version.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using GlusterFS Storage please note that oVirt 4.5 updates Gluster to version 10.
Please refer to <a href="https://docs.gluster.org/en/latest/Upgrade-Guide/upgrade-to-10/">Upgrade procedure to Gluster 10, from Gluster 9.x, 8.x and 7.x</a>
for more details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-4_local_db">3.5. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version for virtual machines in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-4_local_db">3.6. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the data center compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-4_local_db">3.7. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Upgrading_from_4-3">4. Upgrading from oVirt 4.3 to 4.4</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.3 to 4.4 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-3_local_db">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_remote_db">Update the 4.3 Engine to the latest version of 4.3</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-4_4-3_local_db">Upgrade the Engine from 4.3 to 4.4</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-4_4-3_local_db">Migrate hosts and virtual machines while reducing virtual machine downtime</a></p>
</li>
<li>
<p><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_local_db">(Optional) Upgrade oVirt Node while preserving local storage</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-3_local_db">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_local_db">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_local_db">Update the compatibility version of the data centers</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-3_local_db">4.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.3.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-3_local_db">4.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-4_4-3_local_db">4.3. Upgrading the oVirt Engine from 4.3 to 4.4</h3>
<div class="paragraph">
<p>oVirt Engine 4.4 is only supported on Enterprise Linux versions 8.2 to 8.6. You need to do a clean installation of Enterprise Linux 8.6 and oVirt Engine 4.4, even if you are using the same physical machine that you use to run oVirt Engine 4.3.</p>
</div>
<div class="paragraph">
<p>The upgrade process requires restoring oVirt Engine 4.3 backup files onto the oVirt Engine 4.4 machine.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3.</p>
</li>
<li>
<p>If you use an external CA to sign HTTPS certificates, follow the steps in <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>. The backup and restore include the 3rd-party certificate, so you should be able to log in to the Administration portal after the upgrade. Ensure the CA certificate is added to system-wide trust stores of all clients to ensure the foreign menu of virt-viewer works. See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1313379">BZ#1313379</a> for more information.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Engine machine.</p>
</li>
<li>
<p>Back up the oVirt Engine 4.3 environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --scope=all --mode=backup --file=backup.bck --log=backuplog.log</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the backup file to a storage device outside of the oVirt environment.</p>
</li>
<li>
<p>Install Enterprise Linux 8.6. See <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_a_standard_rhel_installation/index"><em>Performing a standard RHEL installation</em></a> for more information.</p>
</li>
<li>
<p>Complete the steps to install oVirt Engine 4.4, including running the command <code>yum install rhvm</code>, but do not run <code>engine-setup</code>. See one of the <em>Installing oVirt</em> guides for more information.</p>
</li>
<li>
<p>Copy the backup file to the oVirt Engine 4.4 machine and restore it.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --mode=restore --file=backup.bck --provision-all-databases</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the backup contained grants for extra database users, this command creates the extra users with random passwords. You must change these passwords manually if the extra users require access to the restored system. See <a href="https://access.redhat.com/articles/2686731" class="bare">https://access.redhat.com/articles/2686731</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Install optional extension packages if they were installed on the oVirt Engine 4.3 machine.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install ovirt-engine-extension-aaa-ldap ovirt-engine-extension-aaa-misc</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ovirt-engine-extension-aaa-ldap</code> is deprecated. For new installations, use Red Hat Single Sign On. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Configuring_Red_Hat_SSO">Installing and Configuring Red Hat Single Sign-On</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The configuration for these package extensions must be manually reapplied because they are not migrated as part of the backup and restore process.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the Engine by running the <code>engine-setup</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
</li>
<li>
<p>Decommission the oVirt Engine 4.3 machine if a different machine is used for oVirt Engine 4.4. Two different Engines must not manage the same hosts or storage.</p>
</li>
<li>
<p>Run <code>engine-setup</code> to configure the Engine.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The oVirt Engine 4.4 is now installed, with the cluster compatibility version set to 4.2 or 4.3, whichever was the preexisting cluster compatibility version.
Now you need to upgrade the hosts in your environment to oVirt 4.4, after which you can change the cluster compatibility version to 4.4.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/">Installing oVirt as a standalone Manager with local databases</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/">Installing oVirt as a standalone Manager with remote databases</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-4_4-3_local_db">4.4. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</h3>
<div class="paragraph">
<p>You can migrate hosts and virtual machines from oVirt 4.3 to 4.4 such that you minimize the downtime of virtual machines in your environment.</p>
</div>
<div class="paragraph">
<p>This process requires migrating all virtual machines from one host so as to make that host available to upgrade to oVirt 4.4. After the upgrade, you can reattach the host to the Engine.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When installing or reinstalling the host&#8217;s operating system, oVirt strongly recommends that you first detach any existing non-OS storage that is attached to the host to avoid accidental initialization of these disks, and with that, potential data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>CPU-passthrough virtual machines might not migrate properly from oVirt 4.3 to oVirt 4.4.</p>
</div>
<div class="paragraph">
<p>oVirt 4.3 and oVirt 4.4 are based on EL 7 and EL 8, respectively, which have different kernel versions with different CPU flags and microcodes. This can cause problems in migrating CPU-passthrough virtual machines.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.4 require Enterprise Linux versions 8.2 to 8.6. A clean installation of Enterprise Linux 8.6, or oVirt Node 4.4 is required, even if you are using the same physical machine that you use to run hosts for oVirt 4.3.</p>
</li>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.2 or 4.3.
All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3 before you start the procedure.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Pick a host to upgrade and migrate that host&#8217;s virtual machines to another host in the same cluster. You can use Live Migration to minimize virtual machine downtime. For more information, see
<a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Migrating_Virtual_Machines_Between_Hosts">Migrating Virtual Machines Between Hosts</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Put the host into maintenance mode and remove the host from the Engine. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Removing_a_host">Removing a Host</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Install Enterprise Linux 8.6, or oVirt Node 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Install the appropriate packages to enable the host for oVirt 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Add this host to the Engine, assigning it to the same cluster. You can now migrate virtual machines onto this host. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Adding_standard_hosts_to_the_Manager_SM_localDB_deploy">Adding Standard Hosts to the Engine</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat these steps to migrate virtual machines and upgrade hosts for the rest of the hosts in the same cluster, one by one, until all are running oVirt 4.4.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_self-hosted_engine_using_the_command_line/">Installing oVirt as a self-hosted engine using the command line</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_standalone_manager_with_local_databases/">Installing oVirt as a standalone Manager with local databases</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/">Installing oVirt as a standalone Manager with remote databases</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hypervisor_preserving_local_storage_4-3_local_db">4.5. Upgrading oVirt Node while preserving local storage</h3>
<div class="paragraph">
<p>Environments with local storage cannot migrate virtual machines to a host in another cluster because the local storage is not shared with other storage domains. To upgrade oVirt Node 4.3 hosts that have a local storage domain, reinstall the host while preserving the local storage, create a new local storage domain in the 4.4 environment, and import the previous local storage into the new domain.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the host belongs is set to 4.2 or 4.3.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the local storage on the oVirt Node 4.3 host&#8217;s local storage is in maintenance mode before starting this process. Complete these steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the <strong>Details</strong> pane and select the storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Maintenance</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Reinstall the oVirt Node, as described in <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Installing_Red_Hat_Virtualization_Hosts_SHE_deployment_host">Installing oVirt Node</a> in the <em>Installation Guide</em>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When selecting the device on which to install oVirt Node from the <strong>Installation Destination</strong> screen, do not select the device(s) storing the virtual machines. Only select the device where the operating system should be installed.</p>
</div>
<div class="paragraph">
<p>If you are using Kickstart to install the host, ensure that you preserve the devices containing the virtual machines by adding the following to the Kickstart file, replacing <em>`device`</em> with the relevant device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># clearpart --all --drives=<em>device</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on using Kickstart, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/performing_an_advanced_rhel_installation/index#kickstart_references">Kickstart references</a> in <em>Red Hat Enterprise Linux 8 Performing an advanced RHEL installation</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On the reinstalled host, create a directory, for example <code class="filename">/data</code> in which to recover the previous environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir /data</code></pre>
</div>
</div>
</li>
<li>
<p>Mount the previous local storage in the new directory. In our example, <code class="filename">/dev/sdX1</code> is the local storage:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mount /dev/sdX1 /data</code></pre>
</div>
</div>
</li>
<li>
<p>Set the following permissions for the new directory.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># chown -R 36:36 /data
# chmod -R 0755 /data</code></pre>
</div>
</div>
</li>
<li>
<p>oVirt recommends that you also automatically mount the local storage via <code class="filename">/etc/fstab</code> in case the server requires a reboot:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># blkid | grep -i sdX1
/dev/sdX1: UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; TYPE=&quot;ext4&quot;
# vi /etc/fstab
UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; /data    ext4    defaults     0       0</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, create a data center and select <strong>Local</strong> in the <strong>Storage Type</strong> drop-down menu.</p>
</li>
<li>
<p>Configure a cluster on the new data center. See <a href="https://ovirt.org/documentation/administration_guide/index#Creating_a_New_Cluster">Creating a New Cluster</a> in the <em>Administration Guide</em> for more information.</p>
</li>
<li>
<p>Add the host to the Engine. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Adding_standard_hosts_to_the_Manager_SHE_cli_deploy">Adding Standard Hosts to the oVirt Manager</a> in one of the <em>Installing oVirt</em> guides for more information.</p>
</li>
<li>
<p>On the host, create a new directory that will be used to create the initial local storage domain. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir -p /localfs
# chown 36:36 /localfs
# chmod -R 0755 /localfs</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, open the <strong>Storage</strong> tab and click <strong>New Domain</strong> to create a new local storage domain.</p>
</li>
<li>
<p>Set the name to <code>localfs</code> and set the path to <code class="filename">/localfs</code>.</p>
</li>
<li>
<p>Once the local storage is active, click <strong>Import Domain</strong> and set the domain&#8217;s details.
For example, define <code>Data</code> as the name, <code>Local on Host</code> as the storage type and <code class="filename">/data</code> as the path.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm the message that appears informing you that storage domains are already attached to the data center.</p>
</li>
<li>
<p>Activate the new storage domain:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the details pane and select the new data storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Activate</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once the new storage domain is active, import the virtual machines and their disks:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Storage</strong> tab, select <strong>data</strong>.</p>
</li>
<li>
<p>Select the <strong>VM Import</strong> tab in the details pane, select the virtual machines and click <strong>Import</strong>. See <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#Importing_a_Virtual_Machine_from_a_Data_Domain">Importing Virtual Machines from a Data Domain</a> in the <em>Virtual Machine Management Guide</em> for more details.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once you have ensured that all virtual machines have been successfully imported and are functioning properly, you can move <code>localfs</code> to maintenance mode.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab and select <strong>localfs</strong> from the results list.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the <strong>Data Center</strong> tab in the details pane.</p>
</li>
<li>
<p>Click Maintenance, then click <b class="button">OK</b> to move the storage domain to maintenance mode.</p>
</li>
<li>
<p>Click <strong>Detach</strong>. The Detach Storage confirmation window opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now upgraded the host to version 4.4, created a new local storage domain, and imported the 4.3 storage domain and its virtual machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hypervisor_preserve_gluster_storage">4.6. Upgrading oVirt Node while preserving Gluster storage</h3>
<div class="paragraph">
<p>Environments with Gluster as storage can take a backup of Gluster storage and be restored after the oVirt Node upgrade.
Try to keep workloads on all virtual machines using Gluster storage as light as possible to shorten the time required to upgrade. If there are highly write-intensive workloads, expect more time to restore.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>If there are geo-replication schedules on the storage domains, remove those schedules to avoid upgrade conflicts.</p>
</li>
<li>
<p>No geo-replication sync are currently running.</p>
</li>
<li>
<p>Additional disk space of 100 GB is required on 3 hosts for creating a new volume for the new oVirt Node 4.4 Engine deployment.</p>
</li>
<li>
<p>All data centers and clusters in the environment must have a cluster compatibility level of 4.3 before you start the procedure.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Restriction</div>
<ul>
<li>
<p>Network-Bound Disk Encryption (NBDE) is supported only with new deployments with oVirt 4.4. This feature cannot be enabled during the upgrade.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new Gluster volume for oVirt Node 4.4 Engine deployment.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a new brick on each host for the new oVirt Node 4.4 self-hosted engine virtual machine(VM).</p>
</li>
<li>
<p>If you have a spare disk in the setup, follow the document Create Volume from the web console.</p>
</li>
<li>
<p>If there is enough space for a new Engine 100GB brick in the existing Volume Group(VG), it can be used as a new Engine Logical Volume (LV).</p>
<div class="paragraph">
<p>Run the following commands on all the hosts, unless specified otherwise explicitly:</p>
</div>
</li>
<li>
<p>Check the free size of the Volume Group (VG).</p>
<div class="listingblock">
<div class="content">
<pre># vgdisplay &lt;VG_NAME&gt; | grep -i free</pre>
</div>
</div>
</li>
<li>
<p>Create one more Logical Volume in this VG.</p>
<div class="listingblock">
<div class="content">
<pre># lvcreate -n gluster_lv_newengine -L 100G &lt;EXISTING_VG&gt;</pre>
</div>
</div>
</li>
<li>
<p>Format the new Logical Volume (LV) as XFS.</p>
<div class="listingblock">
<div class="content">
<pre># mkfs.xfs  &lt;LV_NAME&gt;</pre>
</div>
</div>
</li>
<li>
<p>Create the mount point for the new brick.</p>
<div class="listingblock">
<div class="content">
<pre># mkdir /gluster_bricks/newengine</pre>
</div>
</div>
</li>
<li>
<p>Create an entry corresponding to the newly created filesystem in
<code>/etc/fstab</code> and mount the filesystem.</p>
</li>
<li>
<p>Set the SELinux Labels on the brick mount points.</p>
<div class="listingblock">
<div class="content">
<pre># semanage fcontext -a -t glusterd_brick_t /gluster_bricks/newengine
 restorecon -Rv /gluster_bricks/newengine</pre>
</div>
</div>
</li>
<li>
<p>Create a new gluster volume by executing the gluster command on one of the hosts in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre># gluster volume create newengine replica 3 host1:/gluster_bricks/newengine/newengine host2:/gluster_bricks/newengine/newengine host3:/gluster_bricks/newengine/newengine</pre>
</div>
</div>
</li>
<li>
<p>Set the required volume options on the newly created volume. Run the following commands on one of the hosts in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre># gluster volume set newengine group virt
 gluster volume set newengine network.ping-timeout 30
 gluster volume set newengine cluster.granular-entry-heal enable
 gluster volume set newengine network.remote-dio off
 gluster volume set newengine performance.strict-o-direct on
 gluster volume set newengine storage.owner-uid 36
 gluster volume set newengine storage.owner-gid 36</pre>
</div>
</div>
</li>
<li>
<p>Start the newly created Gluster volume. Run the following command on one of the hosts in the cluster.</p>
<div class="listingblock">
<div class="content">
<pre># gluster volume start newengine</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Back up the Gluster configuration on all oVirt Node 4.3 nodes using the backup playbook.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The backup playbook is available with the latest version of oVirt Node 4.3. If this playbook is not available, create a playbook and inventory file:</p>
<div class="literalblock">
<div class="content">
<pre>/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/archive_config.yml</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> all:
  hosts:
    host1:
    host2:
    host3:
  vars:
    backup_dir: /archive
    nbde_setup: false
    upgrade: true</pre>
</div>
</div>
</li>
<li>
<p>Edit the backup inventory file with correct details.</p>
<div class="listingblock">
<div class="content">
<pre>  Common variables
  backup_dir -&gt;  Absolute path to directory that contains the extracted contents of the backup archive
  nbde_setup -&gt; Set to false as the {virt-product-fullname} 4.3 setup doesn’t support NBDE
  upgrade -&gt; Default value true . This value will make no effect with backup</pre>
</div>
</div>
</li>
<li>
<p>Switch to the directory and execute the playbook.</p>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook -i archive_config_inventory.yml archive_config.yml --tags backupfiles</pre>
</div>
</div>
</li>
<li>
<p>The generated backup configuration tar file is generated under /root with the name <code>oVirt Node-&lt;HOSTNAME&gt;-backup.tar.gz</code>. On all the hosts, copy the backup configuration tar file to the backup host.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Using the Manager Administration Portal, migrate the VMs running on the first host to other hosts in the cluster.</p>
</li>
<li>
<p>Backup Engine configurations.</p>
<div class="listingblock">
<div class="content">
<pre># engine-backup --mode=backup --scope=all --file=&lt;backup-file.tar.gz&gt; --log=&lt;logfile&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before creating a backup, do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable  <strong>Global Maintenance</strong> for the self-hosted engine(SHE).</p>
</li>
<li>
<p>Log in to the Engine VM using SSH and stop the ovirt-engine service.</p>
</li>
<li>
<p>Copy the backup file from the self-hosted engine VM to the remote host.</p>
</li>
<li>
<p>Shut down the Engine.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Check for any pending self-heal tasks on all the replica 3 volumes. Wait for the heal to be completed.</p>
</li>
<li>
<p>Run the following command on one of the hosts:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># gluster volume heal &lt;volume&gt; info summary</code></pre>
</div>
</div>
</li>
<li>
<p>Stop the <code>glusterfs</code> brick process and unmount all the bricks on the first host to maintain file system consistency. Run the following on the first host:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># pkill glusterfsd; pkill glusterfs
# systemctl stop glusterd
# umount /gluster_bricks/*</code></pre>
</div>
</div>
</li>
<li>
<p>Reinstall the host with oVirt Node 4.4 ISO, only formatting the OS disk.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that the installation does not format the other disks, as bricks are created on top of those disks.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once the node is up following the oVirt Node 4.4 installation reboot, subscribe to oVirt Node 4.4 repos as outlined in the Installation Guide, or install the downloaded oVirt Node 4.4 appliance.</p>
<div class="listingblock">
<div class="content">
<pre># yum install &lt;appliance&gt;</pre>
</div>
</div>
</li>
<li>
<p>Disable the devices used for Gluster bricks.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create the new SSH private and public key pairs.</p>
</li>
<li>
<p>Establish SSH public key authentication ( passwordless SSH ) to the same host, using frontend and backend network FQDN.</p>
</li>
<li>
<p>Create the inventory file:</p>
<div class="literalblock">
<div class="content">
<pre>/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/blacklist_inventory.yml</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> hc_nodes:
  hosts:
    host1-backend-FQDN.example.com:
      blacklist_mpath_devices:
         - sda
         - sdb</pre>
</div>
</div>
</li>
<li>
<p>Run the playbook</p>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook -i blacklist_inventory.yml /etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/tasks/gluster_deployment.yml --tags blacklistdevices*</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the Engine backup and host config tar files from the backup host to the newly installed host and untar the content using scp.</p>
</li>
<li>
<p>Restore the Gluster configuration files.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract the contents of the Gluster configuration files</p>
<div class="listingblock">
<div class="content">
<pre> # mkdir /archive
 # tar -xvf /root/ovirt-host-host1.example.com.tar.gz -C /archive/</pre>
</div>
</div>
</li>
<li>
<p>Edit the inventory file to perform restoration of the configuration files. The Inventory file is available at <code>/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/archive_config_inventory.yml</code></p>
<div class="paragraph">
<p>Example playbook content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> all:
   hosts:
 	host1.example.com:
   vars:
 	backup_dir: /archive
 	nbde_setup: false
 	upgrade: true</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="literalblock">
<div class="content">
<pre>Use only one host under ‘hosts’ section of restoration playbook.</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Execute the playbook to restore configuration files</p>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook -i archive_config_inventory.yml archive_config.yml --tags restorefiles</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Perform Engine deployment with the option <code>--restore-from-file</code> pointing to the backed-up archive from the Engine. This Engine deployment can be done interactively using the <code>hosted-engine --deploy</code> command, providing the storage corresponds to the newly created Engine volume. The same can also be done using <code>ovirt-ansible-hosted-engine-setup</code> in an automated procedure.
The following procedure is an automated method for deploying a HostedEngine VM using the backup:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a playbook for HostedEngine deployment in the newly installed host:</p>
<div class="paragraph">
<p><code>/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/he.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>- name: Deploy oVirt hosted engine
  hosts: localhost
  roles:
    - role: ovirt.hosted_engine_setup</pre>
</div>
</div>
</li>
<li>
<p>Update the HostedEngine related information using the template file:</p>
<div class="paragraph">
<p><code>/etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/he_gluster_vars.json</code></p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment/he_gluster_vars.json

{
  &quot;he_appliance_password&quot;: &quot;&lt;password&gt;&quot;,
  &quot;he_admin_password&quot;: &quot;&lt;password&gt;&quot;,
  &quot;he_domain_type&quot;: &quot;glusterfs&quot;,
  &quot;he_fqdn&quot;: &quot;&lt;hostedengine.example.com&gt;&quot;,
  &quot;he_vm_mac_addr&quot;: &quot;&lt;00:18:15:20:59:01&gt;&quot;,
  &quot;he_default_gateway&quot;: &quot;&lt;19.70.12.254&gt;&quot;,
  &quot;he_mgmt_network&quot;: &quot;ovirtmgmt&quot;,
  &quot;he_storage_domain_name&quot;: &quot;HostedEngine&quot;,
  &quot;he_storage_domain_path&quot;: &quot;&lt;/newengine&gt;&quot;,
  &quot;he_storage_domain_addr&quot;: &quot;&lt;host1.example.com&gt;&quot;,
  &quot;he_mount_options&quot;: &quot;backup-volfile-servers=&lt;host2.example.com&gt;:&lt;host3.example.com&gt;&quot;,
  &quot;he_bridge_if&quot;: &quot;&lt;eth0&gt;&quot;,
  &quot;he_enable_hc_gluster_service&quot;: true,
  &quot;he_mem_size_MB&quot;: &quot;16384&quot;,
  &quot;he_cluster&quot;: &quot;Default&quot;,
  &quot;he_restore_from_file&quot;: &quot;/root/engine-backup.tar.gz&quot;,
  &quot;he_vcpus&quot;: 4
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In the above he_gluster_vars.json, There are 2 important values: “he_restore_from_file” and “he_storage_domain_path”. The first option “he_restore_from_file” should point to the absolute file name of the Engine backup archive copied to the local machine. The second option “he_storage_domain_path” should refer to the newly created Gluster volume.</p>
</li>
<li>
<p>Also note that the previous version of oVirt Node Version running inside the Engine VM is down and that will be discarded.  MAC Address and FQDN corresponding to the older Engine VM can be reused for the new Engine as well.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>For static Engine network configuration, add more options as listed below:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">  “he_vm_ip_addr”:  “&lt;engine VM ip address&gt;”
  “he_vm_ip_prefix”:  “&lt;engine VM ip prefix&gt;”
  “he_dns_addr”:  “&lt;engine VM DNS server&gt;”
  “he_default_gateway”:  “&lt;engine VM default gateway&gt;”</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there is no specific DNS available, try to include 2 more options:
“he_vm_etc_hosts”: true
and
“he_network_test”: “ping”</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the playbook to deploy HostedEngine Deployment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cd /etc/ansible/roles/gluster.ansible/playbooks/hc-ansible-deployment
# ansible-playbook he.yml --extra-vars &quot;@he_gluster_vars.json&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the self-hosted engine deployment to complete.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there are any failures during self-hosted engine deployment, find the problem looking at the log messages under <code>/var/log/ovirt-hosted-engine-setup</code>, fix the problem. Clean the failed self-hosted engine deployment using the command <code>ovirt-hosted-engine-cleanup</code> and rerun the deployment.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Log in to the oVirt Node 4.4 Administration Portal on the newly installed oVirt manager. Make sure all the hosts are in the ‘up’ state, and wait for the self-heal on the Gluster volumes to be completed.</p>
</li>
<li>
<p>Upgrade the next host</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Move the next host (ideally, the next one in order), to Maintenance mode from the Administration Portal. Stop the Gluster service while moving this host to Maintenance mode.</p>
</li>
<li>
<p>From the command line of the host, unmount Gluster bricks</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># umount /gluster_bricks/*</code></pre>
</div>
</div>
</li>
<li>
<p>Reinstall this host with oVirt Node 4.4.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that the installation does not format the other disks, as bricks are created on top of those disks.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If multipath configuration is not available on the newly installed host, disable the Gluster devices. The inventory file is already created in the first host as part of the step <em>Disable the devices used for Gluster bricks</em>.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Set up SSH public key authentication from the first host to the newly installed host.</p>
</li>
<li>
<p>Update the inventory with the new host name.</p>
</li>
<li>
<p>Execute the playbook.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the Gluster configuration tar files from the backup host to the newly installed host and untar the content.</p>
</li>
<li>
<p>Restore Gluster configuration on the newly installed host by executing the playbook as described in the step <em>Restoring the Gluster configurations files</em> on this host.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Edit the  playbook on the newly installed host and execute it as described in the step <em>Perform manager deployment with the option --restore-from-file&#8230;&#8203;</em>. Do not change hostname and execute on the same host.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Reinstall the host in oVirt Node Administration Portal Copy the authorized key from the first deployed host in oVirt Node 4.4</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># scp <a href="mailto:root@host1.example.com">root@host1.example.com</a>:/root/.ssh/authorized_keys /root/.ssh/</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>In the <strong>Administration Portal</strong>, The host will be in ‘Maintenance’. Go to <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Hosts</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Reinstall</b></span>.</p>
</li>
<li>
<p>In the <strong>New Host</strong> dialog box <strong>HostedEngine</strong> tab, and select the <strong>deploy</strong> self-hosted engine deployment action.</p>
</li>
<li>
<p>Wait for the host to reach <strong>Up</strong> status.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Make sure that there are no errors in the volumes related to GFID mismatch. If there are any errors, resolve them.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">grep -i &quot;gfid mismatch&quot; /var/log/glusterfs/*</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Repeat the step <em>Upgrade the next host</em>  for all the oVirt Node in the cluster.</p>
</li>
<li>
<p><strong>(optional)</strong> If a separate Gluster logical network exists in the cluster,  attach the Gluster logical network to the required interface on each host.</p>
</li>
<li>
<p>Remove the old Engine storage domain. Identify the old Engine storage domain by the name <strong>hosted_storage</strong> with no gold star next to it, listed under <span class="menuseq"><b class="menu">Storage</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Domains</b></span>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Go to the <span class="menuseq"><b class="menu">Storage</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Domains</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">hosted_storage</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data center</b></span> tab, and select <strong>Maintenance</strong>.</p>
</li>
<li>
<p>Wait for the storage domain to move into Maintenance mode.</p>
</li>
<li>
<p>Once the storage domain moves into Maintenance mode, click <b class="button">Detach</b>, the storage domain will move to <strong>unattached</strong>.</p>
</li>
<li>
<p>Select the unattached storage domain, click <b class="button">Remove</b>, and confirm <b class="button">OK</b>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Stop and remove the old Engine volume.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Go to <span class="menuseq"><b class="menu">Storage</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Volumes</b></span>, and select the old Engine volume. Click <b class="button">Stop</b>, and confirm <b class="button">OK</b>.</p>
</li>
<li>
<p>Select the same volume, click <b class="button">Remove</b>, and confirm <b class="button">OK</b>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Update the cluster compatibility version.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Go to <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> and select the cluster <strong>Default</strong>, click <b class="button">Edit</b>, update the <strong>Compatibility Version</strong> to 4.4 and click <b class="button">OK</b>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There will be a warning for changing compatibility version, which requires VMs on the cluster to be restarted. Click <b class="button">OK</b>to confirm.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>There are new Gluster volume options available with oVirt Node 4.4, apply those volume options on all the volumes. Execute the following on one of the nodes in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># for vol in <code>gluster volume list</code>; do gluster volume set $vol group virt; done</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the archives and extracted the contents of the backup configuration files on all nodes.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Creating an additional Gluster volume using the Web Console</div>
<ol class="arabic">
<li>
<p>Log in to the Engine web console.</p>
</li>
<li>
<p>Go to <span class="menuseq"><b class="menu">Virtualization</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosted Engine</b></span> and click <b class="button">Manage Gluster</b>.</p>
</li>
<li>
<p>Click <b class="button">Create Volume</b>.
In the Create Volume window, do the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Hosts</strong> tab, select three different <code>ovirt-ng-nodes</code> with unused disks and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In the <strong>Volumes</strong> tab, specify the details of the volume you want to create and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In the <strong>Bricks</strong> tab, specify the details of the disks to be used to create the volume and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In the <strong>Review</strong> tab, check the generated configuration file for any incorrect information. When you are satisfied, click <b class="button">Deploy</b>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-3_local_db">4.7. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version for virtual machines in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-3_local_db">4.8. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the data center compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-3_local_db">4.9. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Upgrading_from_4-2">5. Upgrading from oVirt 4.2 to 4.3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.2 to 4.3 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-2_local_db">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_local_db">Update the 4.2 Engine to the latest version of 4.2</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-3_4-2_local_db">Upgrade the Engine from 4.2 to 4.3</a></p>
</li>
<li>
<p><a href="#Updating_all_hosts_in_a_cluster_4-2_local_db">Update the hosts</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-2_local_db">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_local_db">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_local_db">Update the compatibility version of the data centers</a></p>
</li>
<li>
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, <a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_local_db">you must replace the certificates now</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-2_local_db">5.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-2_local_db">5.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-3_4-2_local_db">5.3. Upgrading the oVirt Engine from 4.2 to 4.3</h3>
<div class="paragraph">
<p>You need to be logged into the machine that you are upgrading.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the upgrade fails, the <code>engine-setup</code> command attempts to restore your oVirt Engine installation to its previous state. For this reason, do not remove the previous version&#8217;s repositories until after the upgrade is complete. If the upgrade fails, the <code>engine-setup</code> script explains how to restore your installation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable the oVirt 4.3 repositories:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install <a href="https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm" class="bare">https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>All other repositories remain the same across oVirt releases.</p>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Run <code>engine-setup</code> and follow the prompts to upgrade
the oVirt Engine:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">Execution of setup completed successfully</code></pre>
</div>
</div>
</li>
<li>
<p>Update the base operating system:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Engine is now upgraded to version 4.3.</p>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_all_hosts_in_a_cluster_4-2_local_db">5.4. Updating All Hosts in a Cluster</h3>
<div class="paragraph">
<p>You can update all hosts in a cluster instead of updating hosts individually. This is particularly useful during upgrades to new versions of oVirt. See <a href="https://github.com/oVirt/ovirt-ansible-collection/blob/master/roles/cluster_upgrade/README.md">oVirt Cluster Upgrade</a> for more information about the Ansible role used to automate the updates.</p>
</div>
<div class="paragraph">
<p>Update one cluster at a time.</p>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines are shut down during the update, unless you choose to skip that host instead.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> and select the cluster. The <strong>Upgrade status</strong> column shows if an upgrade is available for any hosts in the cluster.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>Select the hosts to update, then click <strong>Next</strong>.</p>
</li>
<li>
<p>Configure the options:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Stop Pinned VMs</strong> shuts down any virtual machines that are pinned to hosts in the cluster, and is selected by default. You can clear this check box to skip updating those hosts so that the pinned virtual machines stay running, such as when a pinned virtual machine is running important services or processes and you do not want it to shut down at an unknown time during the update.</p>
</li>
<li>
<p><strong>Upgrade Timeout (Minutes)</strong> sets the time to wait for an individual host to be updated before the cluster upgrade fails with a timeout. The default is <code>60</code>. You can increase it for large clusters where 60 minutes might not be enough, or reduce it for small clusters where the hosts update quickly.</p>
</li>
<li>
<p><strong>Check Upgrade</strong> checks each host for available updates before running the upgrade process. It is not selected by default, but you can select it if you need to ensure that recent updates are included, such as when you have configured the Engine to check for host updates less frequently than the default.</p>
</li>
<li>
<p><strong>Reboot After Upgrade</strong> reboots each host after it is updated, and is selected by default. You can clear this check box to speed up the process if you are sure that there are no pending updates that require a host reboot.</p>
</li>
<li>
<p><strong>Use Maintenance Policy</strong> sets the cluster&#8217;s scheduling policy to <a href="https://ovirt.org/documentation/administration_guide/index#Cluster_Scheduling_Policy_Settings"><code>cluster_maintenance</code></a> during the update. It is selected by default, so activity is limited and virtual machines cannot start unless they are highly available. You can clear this check box if you have a custom scheduling policy that you want to keep using during the update, but this could have unknown consequences. Ensure your custom policy is compatible with cluster upgrade activity before disabling this option.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Review the summary of the hosts and virtual machines that are affected.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>A cluster upgrade status screen displays with a progress bar showing the precentage of completion, and a list of steps in the upgrade process that have completed. You can click <strong>Go to Event Log</strong> to open the log entries for the upgrade. Closing this screen does not interrupt the upgrade process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can track the progress of host updates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> view, the <strong>Upgrade Status</strong> column displays a progress bar that displays the percentage of completion.</p>
</li>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> view</p>
</li>
<li>
<p>in the <strong>Events</strong> section of the <strong>Notification Drawer</strong> (<span class="image"><img src="common/images/EventsIcon.png" alt="EventsIcon" title="Events icon"></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can track the progress of individual virtual machine migrations in the <strong>Status</strong> column of the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span> view. In large environments, you may need to filter the results to show a particular group of virtual machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-2_local_db">5.5. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-2_local_db">5.6. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-2_local_db">5.7. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, you must do so now.</p>
</div>
</div>
<div class="sect2">
<h3 id="Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_local_db">5.8. Replacing SHA-1 Certificates with SHA-256 Certificates</h3>
<div class="paragraph">
<p>oVirt 4.5 uses SHA-256 signatures, which provide a more secure way to sign SSL certificates than SHA-1. Newly installed systems do not require any special steps to enable oVirt&#8217;s public key infrastructure (PKI) to use SHA-256 signatures.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do <em>NOT</em> let certificates expire. If they expire, the environment becomes non-responsive and recovery is an error prone and time consuming process. For information on renewing certificates, see <a href="https://ovirt.org/documentation/administration_guide/index#chap-Renewing_certificates_RHV_backup_restore">Renewing certificates before they expire</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="Preventing_Warning_Messages_from_Appearing_in_the_Browser_4-2_local_db" class="discrete">Preventing Warning Messages from Appearing in the Browser</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificate that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;apache&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the <strong>httpd</strong> service:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
</ol>
</div>
<h4 id="Replacing_All_Signed_Certificates_with_SHA-256_4-2_local_db" class="discrete">Replacing All Signed Certificates with SHA-256</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Re-sign the CA certificate by backing it up and creating a new certificate in <strong>ca.pem.new</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/private/ca.pem /etc/pki/ovirt-engine/private/ca.pem.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# openssl x509 -signkey /etc/pki/ovirt-engine/private/ca.pem -in /etc/pki/ovirt-engine/ca.pem -out /etc/pki/ovirt-engine/ca.pem.new -days 3650 -sha256</code></pre>
</div>
</div>
</li>
<li>
<p>Replace the existing certificate with the new certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mv /etc/pki/ovirt-engine/ca.pem.new /etc/pki/ovirt-engine/ca.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificates that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine apache websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you replaced the oVirt Engine SSL Certificate after the upgrade, run the following instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details see <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>.</p>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the following services:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd
# systemctl restart ovirt-engine
# systemctl restart ovirt-websocket-proxy
# systemctl restart ovirt-imageio</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
<li>
<p>Enroll the certificates on the hosts. Repeat the following procedure for each host.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span>.</p>
</li>
<li>
<p>Select the host and click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>Once the host is in maintenance mode, click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Enroll Certificate</b></span>.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Activate</b></span>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrading-standalone-engine-remote-database-environment">6. Upgrading a standalone Engine remote database environment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Remote_Upgrading_from_4-4">7. Upgrading a Remote Database Environment from oVirt 4.4 to 4.5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.4 to 4.5 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-4_remote_db">Make sure you meet the prerequisites, including enabling the correct repositories.</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_remote_db">Update the 4.4 Engine to the latest version of 4.4.</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-5_4-4_remote_db">Upgrade the Engine from 4.4 to 4.5.</a></p>
</li>
<li>
<p><a href="#proc_upgrading-the-remote-data-warehouse-service-and-database_4-4_remote_db">Upgrade the remote Data Warehouse service and database.</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-5_4-4_remote_db">Migrate hosts and virtual machines while reducing virtual machine downtime.</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-4_remote_db">Update the compatibility version of the clusters.</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_remote_db">Reboot any running or suspended virtual machines to update their configuration.</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_remote_db">Update the compatibility version of the data centers.</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-4_remote_db">7.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-4_remote_db">7.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.5.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-5_4-4_remote_db">7.3. Upgrading the oVirt Engine from 4.4 to 4.5</h3>
<div class="paragraph">
<p>oVirt Engine 4.5 is only supported on Enterprise Linux 8.6 or later.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf install -y centos-release-ovirt45</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
. Enable version 2.3 of the <code>mod_auth_openidc</code> module.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module -y enable mod_auth_openidc:2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then follow the procedure for updates between minor releases.</p>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-5_4-4_remote_db">7.4. Migrating hosts oVirt 4.4 to 4.5</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.5 require Enterprise Linux 8.6 or later.</p>
</li>
<li>
<p>oVirt Engine 4.5 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.3 or higher.</p>
</li>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 higher before you start the procedure.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install -y centos-release-ovirt45</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts oVirt Nodes:</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install centos-release-ovirt45 --enablerepo=extras</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Common procedure</div>
<ol class="arabic">
<li>
<p>Follow the procedure for updates between minor releases.</p>
</li>
<li>
<p>Follow the procedure for updating the cluster compatibility version.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using GlusterFS Storage please note that oVirt 4.5 updates Gluster to version 10.
Please refer to <a href="https://docs.gluster.org/en/latest/Upgrade-Guide/upgrade-to-10/">Upgrade procedure to Gluster 10, from Gluster 9.x, 8.x and 7.x</a>
for more details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-4_remote_db">7.5. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version for virtual machines in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-4_remote_db">7.6. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the data center compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-4_remote_db">7.7. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Remote_Upgrading_from_4-3">8. Upgrading a Remote Database Environment from oVirt 4.3 to 4.4</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.3 to 4.4 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-3_remote_db">Make sure you meet the prerequisites, including enabling the correct repositories.</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_remote_db">Update the 4.3 Engine to the latest version of 4.3.</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-4_4-3_remote_db">Upgrade the Engine from 4.3 to 4.4.</a></p>
</li>
<li>
<p><a href="#proc_upgrading-the-remote-data-warehouse-service-and-database_4-3_remote_db">Upgrade the remote Data Warehouse service and database.</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-4_4-3_remote_db">Migrate hosts and virtual machines while reducing virtual machine downtime.</a></p>
</li>
<li>
<p><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_remote_db">Optional: Upgrade oVirt Node while preserving local storage.</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-3_remote_db">Update the compatibility version of the clusters.</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_remote_db">Reboot any running or suspended virtual machines to update their configuration.</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_remote_db">Update the compatibility version of the data centers.</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-3_remote_db">8.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.3.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-3_remote_db">8.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-4_4-3_remote_db">8.3. Upgrading the oVirt Engine from 4.3 to 4.4</h3>
<div class="paragraph">
<p>oVirt Engine 4.4 is only supported on Enterprise Linux versions 8.2 to 8.6. You need to do a clean installation of Enterprise Linux 8.6 and oVirt Engine 4.4, even if you are using the same physical machine that you use to run oVirt Engine 4.3.</p>
</div>
<div class="paragraph">
<p>The upgrade process requires restoring oVirt Engine 4.3 backup files onto the oVirt Engine 4.4 machine.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3.</p>
</li>
<li>
<p>If you use an external CA to sign HTTPS certificates, follow the steps in <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>. The backup and restore include the 3rd-party certificate, so you should be able to log in to the Administration portal after the upgrade. Ensure the CA certificate is added to system-wide trust stores of all clients to ensure the foreign menu of virt-viewer works. See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1313379">BZ#1313379</a> for more information.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Engine machine.</p>
</li>
<li>
<p>Back up the oVirt Engine 4.3 environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --scope=all --mode=backup --file=backup.bck --log=backuplog.log</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the backup file to a storage device outside of the oVirt environment.</p>
</li>
<li>
<p>Install Enterprise Linux 8.6. See <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_a_standard_rhel_installation/index"><em>Performing a standard RHEL installation</em></a> for more information.</p>
</li>
<li>
<p>Complete the steps to install oVirt Engine 4.4, including running the command <code>yum install rhvm</code>, but do not run <code>engine-setup</code>. See one of the <em>Installing oVirt</em> guides for more information.</p>
</li>
<li>
<p>Copy the backup file to the oVirt Engine 4.4 machine and restore it.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --mode=restore --file=backup.bck --provision-all-databases</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the backup contained grants for extra database users, this command creates the extra users with random passwords. You must change these passwords manually if the extra users require access to the restored system. See <a href="https://access.redhat.com/articles/2686731" class="bare">https://access.redhat.com/articles/2686731</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Install optional extension packages if they were installed on the oVirt Engine 4.3 machine.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install ovirt-engine-extension-aaa-ldap ovirt-engine-extension-aaa-misc</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ovirt-engine-extension-aaa-ldap</code> is deprecated. For new installations, use Red Hat Single Sign On. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Configuring_Red_Hat_SSO">Installing and Configuring Red Hat Single Sign-On</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The configuration for these package extensions must be manually reapplied because they are not migrated as part of the backup and restore process.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the Engine by running the <code>engine-setup</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
</li>
<li>
<p>Decommission the oVirt Engine 4.3 machine if a different machine is used for oVirt Engine 4.4. Two different Engines must not manage the same hosts or storage.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The oVirt Engine 4.4 is now installed, with the cluster compatibility version set to 4.2 or 4.3, whichever was the preexisting cluster compatibility version.</p>
</div>
<div class="paragraph">
<p>Now you need to upgrade the remote databases in your environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>'engine-setup' also stops the Data Warehouse service on the remote Data Warehouse machine.</p>
</div>
<div class="paragraph">
<p>If you intend to postpone the next parts of this procedure, log in to the Data Warehouse machine and start the Data Warehouse service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl start ovirt-engine-dwhd.service</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/">Installing oVirt as a standalone Manager with local databases</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/">Installing oVirt as a standalone Manager with remote databases</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc_upgrading-the-remote-data-warehouse-service-and-database_4-3_remote_db">8.4. Upgrading the remote Data Warehouse service and database</h3>
<div class="paragraph _abstract">
<p>Run this procedure on the remote machine with the Data Warehouse service and database.</p>
</div>
<div class="paragraph">
<p>Notice that part of this procedure requires you to install Enterprise Linux 8.6, or oVirt Node 4.4.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are logged in to the Data Warehouse machine.</p>
</li>
<li>
<p>A storage device outside the oVirt environment.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Back up the Data Warehouse machine.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Grafana is not supported on oVirt 4.3, but on oVirt 4.4, this command also includes the Grafana service and the Grafana database.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --file=<em>&lt;backupfile&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Copy the backup file to a storage device.</p>
</li>
<li>
<p>Stop and disable the Data Warehouse service:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine-dwhd
# systemctl disable ovirt-engine-dwhd</code></pre>
</div>
</div>
</li>
<li>
<p>Reinstall the Data Warehouse machine with Enterprise Linux 8.6, or oVirt Node 4.4.</p>
</li>
<li>
<p>Prepare a PostgreSQL database. For information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/index#Preparing_a_Remote_PostgreSQL_Database_install_RHVM">Preparing a Remote PostgreSQL Database</a> in <em>Installing oVirt as a standalone Engine with remote databases</em>.</p>
</li>
<li>
<p>Enable the correct repositories on the server and install the Data Warehouse service. For detailed instructions, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/index#Installing_and_Configuring_Data_Warehouse_on_a_Separate_Machine_install_RHVM">Installing and Configuring Data Warehouse on a Separate Machine</a> for oVirt 4.4. Complete the steps in that procedure up to and including the <code>dnf install ovirt-engine-dwh-setup</code> command. Then continue to the next step in this procedure.</p>
</li>
<li>
<p>Copy the backup file from the storage device to the Data Warehouse machine.</p>
</li>
<li>
<p>Restore the backup file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --mode=restore --file=backup.bck --provision-all-databases</code></pre>
</div>
</div>
</li>
<li>
<p>On the Data Warehouse machine, run the <code>engine-setup</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
</li>
<li>
<p>On the Engine machine, restart the Engine to connect it to the Data Warehouse database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart ovirt-engine</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_a_standard_rhel_installation/index"><em>Performing a standard RHEL installation</em></a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_remoteDB_deploy">Installing Hosts for oVirt</a> in <em>Installing oVirt as a standalone Manager with remote databases</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-4_4-3_remote_db">8.5. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</h3>
<div class="paragraph">
<p>You can migrate hosts and virtual machines from oVirt 4.3 to 4.4 such that you minimize the downtime of virtual machines in your environment.</p>
</div>
<div class="paragraph">
<p>This process requires migrating all virtual machines from one host so as to make that host available to upgrade to oVirt 4.4. After the upgrade, you can reattach the host to the Engine.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When installing or reinstalling the host&#8217;s operating system, oVirt strongly recommends that you first detach any existing non-OS storage that is attached to the host to avoid accidental initialization of these disks, and with that, potential data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>CPU-passthrough virtual machines might not migrate properly from oVirt 4.3 to oVirt 4.4.</p>
</div>
<div class="paragraph">
<p>oVirt 4.3 and oVirt 4.4 are based on EL 7 and EL 8, respectively, which have different kernel versions with different CPU flags and microcodes. This can cause problems in migrating CPU-passthrough virtual machines.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.4 require Enterprise Linux versions 8.2 to 8.6. A clean installation of Enterprise Linux 8.6, or oVirt Node 4.4 is required, even if you are using the same physical machine that you use to run hosts for oVirt 4.3.</p>
</li>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.2 or 4.3.
All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3 before you start the procedure.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Pick a host to upgrade and migrate that host&#8217;s virtual machines to another host in the same cluster. You can use Live Migration to minimize virtual machine downtime. For more information, see
<a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Migrating_Virtual_Machines_Between_Hosts">Migrating Virtual Machines Between Hosts</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Put the host into maintenance mode and remove the host from the Engine. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Removing_a_host">Removing a Host</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Install Enterprise Linux 8.6, or oVirt Node 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Install the appropriate packages to enable the host for oVirt 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Add this host to the Engine, assigning it to the same cluster. You can now migrate virtual machines onto this host. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Adding_standard_hosts_to_the_Manager_SM_localDB_deploy">Adding Standard Hosts to the Engine</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat these steps to migrate virtual machines and upgrade hosts for the rest of the hosts in the same cluster, one by one, until all are running oVirt 4.4.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_self-hosted_engine_using_the_command_line/">Installing oVirt as a self-hosted engine using the command line</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_standalone_manager_with_local_databases/">Installing oVirt as a standalone Manager with local databases</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/">Installing oVirt as a standalone Manager with remote databases</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hypervisor_preserving_local_storage_4-3_remote_db">8.6. Upgrading oVirt Node while preserving local storage</h3>
<div class="paragraph">
<p>Environments with local storage cannot migrate virtual machines to a host in another cluster because the local storage is not shared with other storage domains. To upgrade oVirt Node 4.3 hosts that have a local storage domain, reinstall the host while preserving the local storage, create a new local storage domain in the 4.4 environment, and import the previous local storage into the new domain.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the host belongs is set to 4.2 or 4.3.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the local storage on the oVirt Node 4.3 host&#8217;s local storage is in maintenance mode before starting this process. Complete these steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the <strong>Details</strong> pane and select the storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Maintenance</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Reinstall the oVirt Node, as described in <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Installing_Red_Hat_Virtualization_Hosts_SHE_deployment_host">Installing oVirt Node</a> in the <em>Installation Guide</em>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When selecting the device on which to install oVirt Node from the <strong>Installation Destination</strong> screen, do not select the device(s) storing the virtual machines. Only select the device where the operating system should be installed.</p>
</div>
<div class="paragraph">
<p>If you are using Kickstart to install the host, ensure that you preserve the devices containing the virtual machines by adding the following to the Kickstart file, replacing <em>`device`</em> with the relevant device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># clearpart --all --drives=<em>device</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on using Kickstart, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/performing_an_advanced_rhel_installation/index#kickstart_references">Kickstart references</a> in <em>Red Hat Enterprise Linux 8 Performing an advanced RHEL installation</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On the reinstalled host, create a directory, for example <code class="filename">/data</code> in which to recover the previous environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir /data</code></pre>
</div>
</div>
</li>
<li>
<p>Mount the previous local storage in the new directory. In our example, <code class="filename">/dev/sdX1</code> is the local storage:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mount /dev/sdX1 /data</code></pre>
</div>
</div>
</li>
<li>
<p>Set the following permissions for the new directory.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># chown -R 36:36 /data
# chmod -R 0755 /data</code></pre>
</div>
</div>
</li>
<li>
<p>oVirt recommends that you also automatically mount the local storage via <code class="filename">/etc/fstab</code> in case the server requires a reboot:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># blkid | grep -i sdX1
/dev/sdX1: UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; TYPE=&quot;ext4&quot;
# vi /etc/fstab
UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; /data    ext4    defaults     0       0</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, create a data center and select <strong>Local</strong> in the <strong>Storage Type</strong> drop-down menu.</p>
</li>
<li>
<p>Configure a cluster on the new data center. See <a href="https://ovirt.org/documentation/administration_guide/index#Creating_a_New_Cluster">Creating a New Cluster</a> in the <em>Administration Guide</em> for more information.</p>
</li>
<li>
<p>Add the host to the Engine. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Adding_standard_hosts_to_the_Manager_SHE_cli_deploy">Adding Standard Hosts to the oVirt Manager</a> in one of the <em>Installing oVirt</em> guides for more information.</p>
</li>
<li>
<p>On the host, create a new directory that will be used to create the initial local storage domain. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir -p /localfs
# chown 36:36 /localfs
# chmod -R 0755 /localfs</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, open the <strong>Storage</strong> tab and click <strong>New Domain</strong> to create a new local storage domain.</p>
</li>
<li>
<p>Set the name to <code>localfs</code> and set the path to <code class="filename">/localfs</code>.</p>
</li>
<li>
<p>Once the local storage is active, click <strong>Import Domain</strong> and set the domain&#8217;s details.
For example, define <code>Data</code> as the name, <code>Local on Host</code> as the storage type and <code class="filename">/data</code> as the path.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm the message that appears informing you that storage domains are already attached to the data center.</p>
</li>
<li>
<p>Activate the new storage domain:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the details pane and select the new data storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Activate</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once the new storage domain is active, import the virtual machines and their disks:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Storage</strong> tab, select <strong>data</strong>.</p>
</li>
<li>
<p>Select the <strong>VM Import</strong> tab in the details pane, select the virtual machines and click <strong>Import</strong>. See <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#Importing_a_Virtual_Machine_from_a_Data_Domain">Importing Virtual Machines from a Data Domain</a> in the <em>Virtual Machine Management Guide</em> for more details.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once you have ensured that all virtual machines have been successfully imported and are functioning properly, you can move <code>localfs</code> to maintenance mode.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab and select <strong>localfs</strong> from the results list.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the <strong>Data Center</strong> tab in the details pane.</p>
</li>
<li>
<p>Click Maintenance, then click <b class="button">OK</b> to move the storage domain to maintenance mode.</p>
</li>
<li>
<p>Click <strong>Detach</strong>. The Detach Storage confirmation window opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now upgraded the host to version 4.4, created a new local storage domain, and imported the 4.3 storage domain and its virtual machines.</p>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-3_remote_db">8.7. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version for virtual machines in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-3_remote_db">8.8. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the data center compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-3_remote_db">8.9. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Remote_Upgrading_from_4-2">9. Upgrading a Remote Database Environment from oVirt 4.2 to 4.3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading your environment from 4.2 to 4.3 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-2_remote_db">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_remote_db">Update the 4.2 Engine to the latest version of 4.2</a></p>
</li>
<li>
<p><a href="#Upgrading_Remote_Databases_from_PG95_to_PG10_4-2_remote_db">Upgrade the database from PostgreSQL 9.5 to 10.0</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-3_4-2_remote_db">Upgrade the Engine from 4.2 to 4.3</a></p>
</li>
<li>
<p><a href="#Updating_all_hosts_in_a_cluster_4-2_remote_db">Update the hosts</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-2_remote_db">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_remote_db">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_remote_db">Update the compatibility version of the data centers</a></p>
</li>
<li>
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, <a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_remote_db">you must replace the certificates now</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-2_remote_db">9.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.2.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-2_remote_db">9.2. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_Remote_Databases_from_PG95_to_PG10_4-2_remote_db">9.3. Upgrading remote databases from PostgreSQL 9.5 to 10</h3>
<div class="paragraph">
<p>oVirt 4.3 uses PostgreSQL 10 instead of PostgreSQL 9.5. If your databases are installed locally, the upgrade script automatically upgrades them from version 9.5 to 10. However, if either of your databases (Engine or Data Warehouse) is installed on a separate machine, you must perform the following procedure on each remote database before upgrading the Engine.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the service running on the machine:</p>
<div class="ulist">
<ul>
<li>
<p>When upgrading the Engine database, stop the <code>ovirt-engine</code> service on the Engine machine:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine</code></pre>
</div>
</div>
</li>
<li>
<p>When upgrading the Data Warehouse database, stop the <code>ovirt-engine-dwhd</code> service on the Data Warehouse machine:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine-dwhd</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Enable the required repository to receive the PostgreSQL 10 package:</p>
<div class="ulist">
<ul>
<li>
<p>Ensure the correct repositories are enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install <a href="https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm" class="bare">https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm</a></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Install the PostgreSQL 10 packages:</p>
<div class="listingblock">
<div class="content">
<pre># yum install rh-postgresql10 rh-postgresql10-postgresql-contrib</pre>
</div>
</div>
</li>
<li>
<p>Stop and disable the PostgreSQL 9.5 service:</p>
<div class="listingblock">
<div class="content">
<pre># systemctl stop rh-postgresql95-postgresql
# systemctl disable rh-postgresql95-postgresql</pre>
</div>
</div>
</li>
<li>
<p>Upgrade the PostgreSQL 9.5 database to PostgreSQL
10:</p>
<div class="listingblock">
<div class="content">
<pre># scl enable rh-postgresql10 -- postgresql-setup --upgrade-from=rh-postgresql95-postgresql --upgrade</pre>
</div>
</div>
</li>
<li>
<p>Start and enable the <code>rh-postgresql10-postgresql.service</code> and check that it is running:</p>
<div class="listingblock">
<div class="content">
<pre># systemctl start rh-postgresql10-postgresql.service
# systemctl enable rh-postgresql10-postgresql.service
# systemctl status rh-postgresql10-postgresql.service</pre>
</div>
</div>
<div class="paragraph">
<p>Ensure that you see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">rh-postgresql10-postgresql.service - PostgreSQL database server
   Loaded: loaded (/usr/lib/systemd/system/rh-postgresql10-postgresql.service;
enabled; vendor preset: disabled)
   Active: active (running) since ...</pre>
</div>
</div>
</li>
<li>
<p>Copy the <code class="filename">pg_hba.conf</code> client configuration file from the PostgreSQL 9.5 environment to the PostgreSQL 10 environment:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /var/opt/rh/rh-postgresql95/lib/pgsql/data/pg_hba.conf  /var/opt/rh/rh-postgresql10/lib/pgsql/data/pg_hba.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Update the following parameters in <code class="filename">/var/opt/rh/rh-postgresql10/lib/pgsql/data/postgresql.conf</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">listen_addresses='*'
autovacuum_vacuum_scale_factor=0.01
autovacuum_analyze_scale_factor=0.075
autovacuum_max_workers=6
maintenance_work_mem=65536
max_connections=150
work_mem = 8192</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the PostgreSQL 10 service to apply the configuration changes:</p>
<div class="listingblock">
<div class="content">
<pre># systemctl restart rh-postgresql10-postgresql.service</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.3.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-3_4-2_remote_db">9.4. Upgrading the oVirt Engine from 4.2 to 4.3</h3>
<div class="paragraph">
<p>Follow these same steps when upgrading any of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the oVirt Engine</p>
</li>
<li>
<p>a remote machine with the Data Warehouse service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to be logged into the machine that you are upgrading.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the upgrade fails, the <code>engine-setup</code> command attempts to restore your oVirt Engine installation to its previous state. For this reason, do not remove the previous version&#8217;s repositories until after the upgrade is complete. If the upgrade fails, the <code>engine-setup</code> script explains how to restore your installation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable the oVirt 4.3 repositories:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install <a href="https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm" class="bare">https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>All other repositories remain the same across oVirt releases.</p>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Run <code>engine-setup</code> and follow the prompts to upgrade
the oVirt Engine, the remote database or remote service:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During the upgrade process for the Engine, the <code>engine-setup</code> script might prompt you to disconnect the remote Data Warehouse database. You must disconnect it to continue the setup.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">Execution of setup completed successfully</code></pre>
</div>
</div>
</li>
<li>
<p>Update the base operating system:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Engine is now upgraded to version 4.3.</p>
</div>
<div class="sect3">
<h4 id="completing-the-remote-data-warehouse-database-upgrade">9.4.1. Completing the remote Data Warehouse database upgrade</h4>
<div class="paragraph">
<p>Complete these additional steps when upgrading a remote Data Warehouse database from PostgreSQL 9.5 to 10.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>The <code>ovirt-engine-dwhd</code> service is now running on the Engine machine. If the <code>ovirt-engine-dwhd</code> service is on a remote machine, stop and disable the <code>ovirt-engine-dwhd</code> service on the Engine machine, and remove the configuration files that <code>engine-setup</code> created:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine-dwhd
# systemctl disable ovirt-engine-dwhd
# rm -f /etc/ovirt-engine-dwh/ovirt-engine-dwhd.conf.d/*</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the steps in <a href="#Upgrading_the_Manager_to_4-3_4-2_remote_db">Upgrading the Engine to 4.3</a> on the machine hosting the <code>ovirt-engine-dwhd</code> service.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now update the hosts.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Updating_all_hosts_in_a_cluster_4-2_remote_db">9.5. Updating All Hosts in a Cluster</h3>
<div class="paragraph">
<p>You can update all hosts in a cluster instead of updating hosts individually. This is particularly useful during upgrades to new versions of oVirt. See <a href="https://github.com/oVirt/ovirt-ansible-collection/blob/master/roles/cluster_upgrade/README.md">oVirt Cluster Upgrade</a> for more information about the Ansible role used to automate the updates.</p>
</div>
<div class="paragraph">
<p>Update one cluster at a time.</p>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines are shut down during the update, unless you choose to skip that host instead.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> and select the cluster. The <strong>Upgrade status</strong> column shows if an upgrade is available for any hosts in the cluster.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>Select the hosts to update, then click <strong>Next</strong>.</p>
</li>
<li>
<p>Configure the options:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Stop Pinned VMs</strong> shuts down any virtual machines that are pinned to hosts in the cluster, and is selected by default. You can clear this check box to skip updating those hosts so that the pinned virtual machines stay running, such as when a pinned virtual machine is running important services or processes and you do not want it to shut down at an unknown time during the update.</p>
</li>
<li>
<p><strong>Upgrade Timeout (Minutes)</strong> sets the time to wait for an individual host to be updated before the cluster upgrade fails with a timeout. The default is <code>60</code>. You can increase it for large clusters where 60 minutes might not be enough, or reduce it for small clusters where the hosts update quickly.</p>
</li>
<li>
<p><strong>Check Upgrade</strong> checks each host for available updates before running the upgrade process. It is not selected by default, but you can select it if you need to ensure that recent updates are included, such as when you have configured the Engine to check for host updates less frequently than the default.</p>
</li>
<li>
<p><strong>Reboot After Upgrade</strong> reboots each host after it is updated, and is selected by default. You can clear this check box to speed up the process if you are sure that there are no pending updates that require a host reboot.</p>
</li>
<li>
<p><strong>Use Maintenance Policy</strong> sets the cluster&#8217;s scheduling policy to <a href="https://ovirt.org/documentation/administration_guide/index#Cluster_Scheduling_Policy_Settings"><code>cluster_maintenance</code></a> during the update. It is selected by default, so activity is limited and virtual machines cannot start unless they are highly available. You can clear this check box if you have a custom scheduling policy that you want to keep using during the update, but this could have unknown consequences. Ensure your custom policy is compatible with cluster upgrade activity before disabling this option.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Review the summary of the hosts and virtual machines that are affected.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>A cluster upgrade status screen displays with a progress bar showing the precentage of completion, and a list of steps in the upgrade process that have completed. You can click <strong>Go to Event Log</strong> to open the log entries for the upgrade. Closing this screen does not interrupt the upgrade process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can track the progress of host updates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> view, the <strong>Upgrade Status</strong> column displays a progress bar that displays the percentage of completion.</p>
</li>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> view</p>
</li>
<li>
<p>in the <strong>Events</strong> section of the <strong>Notification Drawer</strong> (<span class="image"><img src="common/images/EventsIcon.png" alt="EventsIcon" title="Events icon"></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can track the progress of individual virtual machine migrations in the <strong>Status</strong> column of the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span> view. In large environments, you may need to filter the results to show a particular group of virtual machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-2_remote_db">9.6. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-2_remote_db">9.7. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-2_remote_db">9.8. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, you must do so now.</p>
</div>
</div>
<div class="sect2">
<h3 id="Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_remote_db">9.9. Replacing SHA-1 Certificates with SHA-256 Certificates</h3>
<div class="paragraph">
<p>oVirt 4.5 uses SHA-256 signatures, which provide a more secure way to sign SSL certificates than SHA-1. Newly installed systems do not require any special steps to enable oVirt&#8217;s public key infrastructure (PKI) to use SHA-256 signatures.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do <em>NOT</em> let certificates expire. If they expire, the environment becomes non-responsive and recovery is an error prone and time consuming process. For information on renewing certificates, see <a href="https://ovirt.org/documentation/administration_guide/index#chap-Renewing_certificates_RHV_backup_restore">Renewing certificates before they expire</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="Preventing_Warning_Messages_from_Appearing_in_the_Browser_4-2_remote_db" class="discrete">Preventing Warning Messages from Appearing in the Browser</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificate that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;apache&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the <strong>httpd</strong> service:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
</ol>
</div>
<h4 id="Replacing_All_Signed_Certificates_with_SHA-256_4-2_remote_db" class="discrete">Replacing All Signed Certificates with SHA-256</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Re-sign the CA certificate by backing it up and creating a new certificate in <strong>ca.pem.new</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/private/ca.pem /etc/pki/ovirt-engine/private/ca.pem.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# openssl x509 -signkey /etc/pki/ovirt-engine/private/ca.pem -in /etc/pki/ovirt-engine/ca.pem -out /etc/pki/ovirt-engine/ca.pem.new -days 3650 -sha256</code></pre>
</div>
</div>
</li>
<li>
<p>Replace the existing certificate with the new certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mv /etc/pki/ovirt-engine/ca.pem.new /etc/pki/ovirt-engine/ca.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificates that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine apache websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you replaced the oVirt Engine SSL Certificate after the upgrade, run the following instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details see <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>.</p>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the following services:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd
# systemctl restart ovirt-engine
# systemctl restart ovirt-websocket-proxy
# systemctl restart ovirt-imageio</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
<li>
<p>Enroll the certificates on the hosts. Repeat the following procedure for each host.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span>.</p>
</li>
<li>
<p>Select the host and click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>Once the host is in maintenance mode, click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Enroll Certificate</b></span>.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Activate</b></span>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrading-self-hosted-engine-environment">10. Upgrading a self-hosted engine environment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="SHE_Upgrading_from_4-4">11. Upgrading a self-Hosted engine from oVirt 4.4 to 4.5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading a self-hosted engine environment from version 4.4 to 4.5 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-4_SHE">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Migrating_VMs_from_SHE_host_4-4">Migrate any virtual machines that are running on the same host as the Engine virtual machine to another host in the same cluster</a></p>
</li>
<li>
<p><a href="#Enabling_Global_Maintenance_Mode_4-4_SHE">Place the environment in global maintenance mode</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-4_SHE">Update the 4.4 Engine to the latest version of 4.4</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-5_4-4_SHE">Upgrade the Engine from 4.4 to 4.5</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-5_4-4_SHE">Upgrade the self-hosted engine nodes, and any standard hosts, while reducing virtual machine downtime</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-4_SHE">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-4_SHE">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-4_SHE">Update the compatibility version of the data centers</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-4_SHE">11.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Migrating_VMs_from_SHE_host_4-4">11.2. Migrating virtual machines from the self-hosted engine host</h3>
<div class="paragraph">
<p>Only the Engine virtual machine should remain on the host until after you have finished upgrading the host. Migrate any virtual machines other than the Engine virtual machine to another host in the same cluster.</p>
</div>
<div class="paragraph">
<p>You can use Live Migration to minimize virtual machine down-time. For more information, see
<a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Migrating_Virtual_Machines_Between_Hosts">Migrating Virtual Machines Between Hosts</a> in the <em>Virtual Machine Management Guide</em> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="Enabling_Global_Maintenance_Mode_4-4_SHE">11.3. Enabling global maintenance mode</h3>
<div class="paragraph">
<p>You must place the self-hosted engine environment in global maintenance mode before performing any setup or upgrade tasks on the Engine virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the environment is in global maintenance mode before proceeding:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a message indicating that the cluster is in global maintenance mode.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-4_SHE">11.4. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.5.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-5_4-4_SHE">11.5. Upgrading the oVirt Engine from 4.4 to 4.5</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3 or higher.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf install -y centos-release-ovirt45</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
. Enable version 2.3 of the <code>mod_auth_openidc</code> module.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module -y enable mod_auth_openidc:2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then follow the procedure for updates between minor releases.</p>
</div>
<div class="paragraph">
<p>You can now update the self-hosted engine nodes, and then any standard hosts. The procedure is the same for both host types.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-5_4-4_SHE">11.6. Migrating hosts oVirt 4.4 to 4.5</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.5 require Enterprise Linux 8.6 or later.</p>
</li>
<li>
<p>oVirt Engine 4.5 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.3 or higher.</p>
</li>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.3 higher before you start the procedure.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install -y centos-release-ovirt45</pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure for Enterprise Linux hosts oVirt Nodes:</div>
<ol class="arabic">
<li>
<p>Enable oVirt 4.5 repositories</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf install centos-release-ovirt45 --enablerepo=extras</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Common procedure</div>
<ol class="arabic">
<li>
<p>Follow the procedure for updates between minor releases.</p>
</li>
<li>
<p>Follow the procedure for updating the cluster compatibility version.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using GlusterFS Storage please note that oVirt 4.5 updates Gluster to version 10.
Please refer to <a href="https://docs.gluster.org/en/latest/Upgrade-Guide/upgrade-to-10/">Upgrade procedure to Gluster 10, from Gluster 9.x, 8.x and 7.x</a>
for more details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-4_SHE">11.7. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-4_SHE">11.8. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>The Engine virtual machine does not need to be rebooted.</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-4_SHE">11.9. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="SHE_Upgrading_from_4-3">12. Upgrading a self-Hosted engine from oVirt 4.3 to 4.4</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading a self-hosted engine environment from version 4.3 to 4.4 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-3_SHE">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Migrating_VMs_from_SHE_host">Migrate any virtual machines that are running on the same host as the Engine virtual machine to another host in the same cluster</a></p>
</li>
<li>
<p><a href="#Enabling_Global_Maintenance_Mode_4-3_SHE">Place the environment in global maintenance mode</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-3_SHE">Update the 4.3 Engine to the latest version of 4.3</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-4_4-3_SHE">Upgrade the Engine from 4.3 to 4.4</a></p>
</li>
<li>
<p><a href="#Upgrading_hosts_to_4-4_4-3_SHE">Upgrade the self-hosted engine nodes, and any standard hosts, while reducing virtual machine downtime</a></p>
</li>
<li>
<p><a href="#Upgrading_hypervisor_preserving_local_storage_4-3_SHE">(Optional) Upgrade oVirt Node while preserving local storage</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-3_SHE">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-3_SHE">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-3_SHE">Update the compatibility version of the data centers</a></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-3_SHE">12.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Migrating_VMs_from_SHE_host">12.2. Migrating virtual machines from the self-hosted engine host</h3>
<div class="paragraph">
<p>Only the Engine virtual machine should remain on the host until after you have finished upgrading the host. Migrate any virtual machines other than the Engine virtual machine to another host in the same cluster.</p>
</div>
<div class="paragraph">
<p>You can use Live Migration to minimize virtual machine down-time. For more information, see
<a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Migrating_Virtual_Machines_Between_Hosts">Migrating Virtual Machines Between Hosts</a> in the <em>Virtual Machine Management Guide</em> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="Enabling_Global_Maintenance_Mode_4-3_SHE">12.3. Enabling global maintenance mode</h3>
<div class="paragraph">
<p>You must place the self-hosted engine environment in global maintenance mode before performing any setup or upgrade tasks on the Engine virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the environment is in global maintenance mode before proceeding:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a message indicating that the cluster is in global maintenance mode.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now update the Engine to the latest version of 4.3.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-3_SHE">12.4. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now upgrade the Engine to 4.4.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-4_4-3_SHE">12.5. Upgrading the oVirt Engine from 4.3 to 4.4</h3>
<div class="paragraph">
<p>The oVirt Engine 4.4 is only supported on Enterprise Linux versions 8.2 to 8.6. You need to do a clean installation of Enterprise Linux 8.6, or oVirt Node on the self-hosted engine host, even if you are using the same physical machine that you use to run the oVirt 4.3 self-hosted engine.</p>
</div>
<div class="paragraph">
<p>The upgrade process requires restoring oVirt Engine 4.3 backup files onto the oVirt Engine 4.4 virtual machine.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3.</p>
</li>
<li>
<p>All virtual machines in the environment must have the cluster compatibility level set to version 4.3.</p>
</li>
<li>
<p>Make note of the MAC address of the self-hosted engine if you are using DHCP and want to use the same IP address. The deploy script prompts you for this information.</p>
</li>
<li>
<p>During the deployment you need to provide a new storage domain for the Engine machine. The deployment script renames the 4.3 storage domain and retains its data to enable disaster recovery.</p>
</li>
<li>
<p>Set the cluster scheduling policy to <code>cluster_maintenance</code> in order to prevent automatic virtual machine migration during the upgrade.</p>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In an environment with multiple highly available self-hosted engine nodes, you need to detach the storage domain hosting the version 4.3 Engine after upgrading the Engine to 4.4. Use a dedicated storage domain for the 4.4 self-hosted engine deployment.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you use an external CA to sign HTTPS certificates, follow the steps in <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>. The backup and restore include the 3rd-party certificate, so you should be able to log in to the Administration portal after the upgrade. Ensure the CA certificate is added to system-wide trust stores of all clients to ensure the foreign menu of virt-viewer works. See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1313379">BZ#1313379</a> for more information.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Connected hosts and virtual machines can continue to work while the Engine is being upgraded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Engine virtual machine and shut down the engine service.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine</code></pre>
</div>
</div>
</li>
<li>
<p>Back up the oVirt Engine 4.3 environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-backup --scope=all --mode=backup --file=backup.bck --log=backuplog.log</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the backup file to a storage device outside of the oVirt environment.</p>
</li>
<li>
<p>Shut down the self-hosted engine.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># shutdown</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to reuse the self-hosted engine virtual machine to deploy the oVirt Engine 4.4, note the MAC address of the self-hosted engine network interface before you shut it down.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Make sure that the self-hosted engine is shut down.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status | grep -E 'Engine status|Hostname'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any of the hosts report the <code>detail</code> field as <code>Up</code>, log in to that specific host and shut it down with the <code>hosted-engine --vm-shutdown</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Install oVirt Node 4.4 or Enterprise Linux 8.6 on the existing node currently running the Engine virtual machine to use it as the self-hosted engine deployment host. See <a href="https://ovirt.org/documentation//installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Installing_the_self-hosted_engine_deployment_host_SHE_cli_deploy">Installing the Self-hosted Engine Deployment Host</a> for more information.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Install the self-hosted engine deployment tool.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install ovirt-hosted-engine-setup</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the backup file to the host.</p>
</li>
<li>
<p>Log in to the Engine host and deploy the self-hosted engine with the backup file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --deploy --restore-from-file=/<em>path</em>/backup.bck</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>tmux</code> enables the deployment script to continue if the connection to the server is interrupted, so you can reconnect and attach to the deployment and continue. Otherwise, if the connection is interrupted during deployment, the deployment fails.</p>
</div>
<div class="paragraph">
<p>To run the deployment script using <code>tmux</code>, enter the <code>tmux</code> command before you run the deployment script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># tmux
# hosted-engine --deploy --restore-from-file=backup.bck</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The deployment script automatically disables global maintenance mode and calls the HA agent to start the self-hosted engine virtual machine. The upgraded host with the 4.4 self-hosted engine reports that HA mode is active, but the other hosts report that global maintenance mode is still enabled as they are still connected to the old self-hosted engine storage.</p>
</div>
</li>
<li>
<p>Detach the storage domain that hosts the Engine 4.3 machine. For details, see <a href="https://ovirt.org/documentation/administration_guide/index#Detaching_a_storage_domain">Detaching a Storage Domain from a Data Center</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Log in to the Engine virtual machine and shut down the engine service.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl stop ovirt-engine</code></pre>
</div>
</div>
</li>
<li>
<p>Install optional extension packages if they were installed on the oVirt Engine 4.3 machine.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install ovirt-engine-extension-aaa-ldap ovirt-engine-extension-aaa-misc</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ovirt-engine-extension-aaa-ldap</code> is deprecated. For new installations, use Red Hat Single Sign On. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Configuring_Red_Hat_SSO">Installing and Configuring Red Hat Single Sign-On</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The configuration for these package extensions must be manually reapplied because they are not migrated as part of the backup and restore process.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the Engine by running the <code>engine-setup</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The oVirt Engine 4.4 is now installed, with the cluster compatibility version set to 4.2 or 4.3, whichever was the preexisting cluster compatibility version.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_self-hosted_engine_using_the_command_line/">Installing oVirt as a self-hosted engine using the command line</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now update the self-hosted engine nodes, and then any standard hosts. The procedure is the same for both host types.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hosts_to_4-4_4-3_SHE">12.6. Migrating hosts and virtual machines from oVirt 4.3 to 4.4</h3>
<div class="paragraph">
<p>You can migrate hosts and virtual machines from oVirt 4.3 to 4.4 such that you minimize the downtime of virtual machines in your environment.</p>
</div>
<div class="paragraph">
<p>This process requires migrating all virtual machines from one host so as to make that host available to upgrade to oVirt 4.4. After the upgrade, you can reattach the host to the Engine.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When installing or reinstalling the host&#8217;s operating system, oVirt strongly recommends that you first detach any existing non-OS storage that is attached to the host to avoid accidental initialization of these disks, and with that, potential data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>CPU-passthrough virtual machines might not migrate properly from oVirt 4.3 to oVirt 4.4.</p>
</div>
<div class="paragraph">
<p>oVirt 4.3 and oVirt 4.4 are based on EL 7 and EL 8, respectively, which have different kernel versions with different CPU flags and microcodes. This can cause problems in migrating CPU-passthrough virtual machines.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Hosts for oVirt 4.4 require Enterprise Linux versions 8.2 to 8.6. A clean installation of Enterprise Linux 8.6, or oVirt Node 4.4 is required, even if you are using the same physical machine that you use to run hosts for oVirt 4.3.</p>
</li>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the hosts belong is set to 4.2 or 4.3.
All data centers and clusters in the environment must have the cluster compatibility level set to version 4.2 or 4.3 before you start the procedure.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Pick a host to upgrade and migrate that host&#8217;s virtual machines to another host in the same cluster. You can use Live Migration to minimize virtual machine downtime. For more information, see
<a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Migrating_Virtual_Machines_Between_Hosts">Migrating Virtual Machines Between Hosts</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Put the host into maintenance mode and remove the host from the Engine. For more information, see <a href="https://ovirt.org/documentation/administration_guide/index#Removing_a_host">Removing a Host</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Install Enterprise Linux 8.6, or oVirt Node 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Install the appropriate packages to enable the host for oVirt 4.4. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
<li>
<p>Add this host to the Engine, assigning it to the same cluster. You can now migrate virtual machines onto this host. For more information, see <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#Adding_standard_hosts_to_the_Manager_SM_localDB_deploy">Adding Standard Hosts to the Engine</a> in one of the <em>Installing oVirt</em> guides.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat these steps to migrate virtual machines and upgrade hosts for the rest of the hosts in the same cluster, one by one, until all are running oVirt 4.4.</p>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_self-hosted_engine_using_the_command_line/">Installing oVirt as a self-hosted engine using the command line</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation//installing_ovirt_as_a_standalone_manager_with_local_databases/">Installing oVirt as a standalone Manager with local databases</a></p>
</li>
<li>
<p><a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_remote_databases/">Installing oVirt as a standalone Manager with remote databases</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_hypervisor_preserving_local_storage_4-3_SHE">12.7. Upgrading oVirt Node while preserving local storage</h3>
<div class="paragraph">
<p>Environments with local storage cannot migrate virtual machines to a host in another cluster because the local storage is not shared with other storage domains. To upgrade oVirt Node 4.3 hosts that have a local storage domain, reinstall the host while preserving the local storage, create a new local storage domain in the 4.4 environment, and import the previous local storage into the new domain.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>oVirt Engine 4.4 is installed and running.</p>
</li>
<li>
<p>The compatibility level of the data center and cluster to which the host belongs is set to 4.2 or 4.3.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the local storage on the oVirt Node 4.3 host&#8217;s local storage is in maintenance mode before starting this process. Complete these steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the <strong>Details</strong> pane and select the storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Maintenance</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Reinstall the oVirt Node, as described in <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Installing_Red_Hat_Virtualization_Hosts_SHE_deployment_host">Installing oVirt Node</a> in the <em>Installation Guide</em>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When selecting the device on which to install oVirt Node from the <strong>Installation Destination</strong> screen, do not select the device(s) storing the virtual machines. Only select the device where the operating system should be installed.</p>
</div>
<div class="paragraph">
<p>If you are using Kickstart to install the host, ensure that you preserve the devices containing the virtual machines by adding the following to the Kickstart file, replacing <em>`device`</em> with the relevant device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># clearpart --all --drives=<em>device</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on using Kickstart, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/performing_an_advanced_rhel_installation/index#kickstart_references">Kickstart references</a> in <em>Red Hat Enterprise Linux 8 Performing an advanced RHEL installation</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On the reinstalled host, create a directory, for example <code class="filename">/data</code> in which to recover the previous environment.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir /data</code></pre>
</div>
</div>
</li>
<li>
<p>Mount the previous local storage in the new directory. In our example, <code class="filename">/dev/sdX1</code> is the local storage:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mount /dev/sdX1 /data</code></pre>
</div>
</div>
</li>
<li>
<p>Set the following permissions for the new directory.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># chown -R 36:36 /data
# chmod -R 0755 /data</code></pre>
</div>
</div>
</li>
<li>
<p>oVirt recommends that you also automatically mount the local storage via <code class="filename">/etc/fstab</code> in case the server requires a reboot:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># blkid | grep -i sdX1
/dev/sdX1: UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; TYPE=&quot;ext4&quot;
# vi /etc/fstab
UUID=&quot;a81a6879-3764-48d0-8b21-2898c318ef7c&quot; /data    ext4    defaults     0       0</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, create a data center and select <strong>Local</strong> in the <strong>Storage Type</strong> drop-down menu.</p>
</li>
<li>
<p>Configure a cluster on the new data center. See <a href="https://ovirt.org/documentation/administration_guide/index#Creating_a_New_Cluster">Creating a New Cluster</a> in the <em>Administration Guide</em> for more information.</p>
</li>
<li>
<p>Add the host to the Engine. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#Adding_standard_hosts_to_the_Manager_SHE_cli_deploy">Adding Standard Hosts to the oVirt Manager</a> in one of the <em>Installing oVirt</em> guides for more information.</p>
</li>
<li>
<p>On the host, create a new directory that will be used to create the initial local storage domain. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mkdir -p /localfs
# chown 36:36 /localfs
# chmod -R 0755 /localfs</code></pre>
</div>
</div>
</li>
<li>
<p>In the Administration Portal, open the <strong>Storage</strong> tab and click <strong>New Domain</strong> to create a new local storage domain.</p>
</li>
<li>
<p>Set the name to <code>localfs</code> and set the path to <code class="filename">/localfs</code>.</p>
</li>
<li>
<p>Once the local storage is active, click <strong>Import Domain</strong> and set the domain&#8217;s details.
For example, define <code>Data</code> as the name, <code>Local on Host</code> as the storage type and <code class="filename">/data</code> as the path.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm the message that appears informing you that storage domains are already attached to the data center.</p>
</li>
<li>
<p>Activate the new storage domain:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <strong>Data Centers</strong> tab.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab in the details pane and select the new data storage domain in the results list.</p>
</li>
<li>
<p>Click <strong>Activate</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once the new storage domain is active, import the virtual machines and their disks:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the <strong>Storage</strong> tab, select <strong>data</strong>.</p>
</li>
<li>
<p>Select the <strong>VM Import</strong> tab in the details pane, select the virtual machines and click <strong>Import</strong>. See <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#Importing_a_Virtual_Machine_from_a_Data_Domain">Importing Virtual Machines from a Data Domain</a> in the <em>Virtual Machine Management Guide</em> for more details.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once you have ensured that all virtual machines have been successfully imported and are functioning properly, you can move <code>localfs</code> to maintenance mode.</p>
</li>
<li>
<p>Click the <strong>Storage</strong> tab and select <strong>localfs</strong> from the results list.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the <strong>Data Center</strong> tab in the details pane.</p>
</li>
<li>
<p>Click Maintenance, then click <b class="button">OK</b> to move the storage domain to maintenance mode.</p>
</li>
<li>
<p>Click <strong>Detach</strong>. The Detach Storage confirmation window opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now upgraded the host to version 4.4, created a new local storage domain, and imported the 4.3 storage domain and its virtual machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-3_SHE">12.8. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-3_SHE">12.9. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>The Engine virtual machine does not need to be rebooted.</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-3_SHE">12.10. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="SHE_Upgrading_from_4-2">13. Upgrading a Self-Hosted Engine from oVirt 4.2 to 4.3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading a self-hosted engine environment from version 4.2 to 4.3 involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrade_Prerequisites_4-2_SHE">Make sure you meet the prerequisites, including enabling the correct repositories</a></p>
</li>
<li>
<p><a href="#Enabling_Global_Maintenance_Mode_4-2_SHE">Place the environment in global maintenance mode</a></p>
</li>
<li>
<p><a href="#Updating_the_Red_Hat_Virtualization_Manager_4-2_SHE">Update the 4.2 Engine to the latest version of 4.2</a></p>
</li>
<li>
<p><a href="#Upgrading_the_Manager_to_4-3_4-2_SHE">Upgrade the Engine from 4.2 to 4.3</a></p>
</li>
<li>
<p><a href="#Disabling_Global_Maintenance_Mode_4-2_SHE">Disable global maintenance mode</a></p>
</li>
<li>
<p><a href="#Updating_all_hosts_in_a_cluster_4-2_SHE">Upgrade the self-hosted engine nodes, and any standard hosts</a></p>
</li>
<li>
<p><a href="#Changing_the_Cluster_Compatibility_Version_4-2_SHE">Update the compatibility version of the clusters</a></p>
</li>
<li>
<p><a href="#Changing_Virtual_Machine_Cluster_Compatibility_4-2_SHE">Reboot any running or suspended virtual machines to update their configuration</a></p>
</li>
<li>
<p><a href="#Changing_the_Data_Center_Compatibility_Version_4-2_SHE">Update the compatibility version of the data centers</a></p>
</li>
<li>
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, <a href="#Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_SHE">you must replace the certificates now</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="Upgrade_Prerequisites_4-2_SHE">13.1. Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Plan for any necessary virtual machine downtime. After you update the clusters' compatibility versions during the upgrade, a new hardware configuration is automatically applied to each virtual machine once it reboots. You must reboot any running or suspended virtual machines as soon as possible to apply the configuration changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure your environment meets the requirements for oVirt 4.5.</p>
</li>
<li>
<p>When upgrading oVirt Engine, it is recommended that you use one of the existing hosts. If you decide to use a new host, you must assign a unique name to the new host and then add it to the existing cluster before you begin the upgrade procedure.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Enabling_Global_Maintenance_Mode_4-2_SHE">13.2. Enabling global maintenance mode</h3>
<div class="paragraph">
<p>You must place the self-hosted engine environment in global maintenance mode before performing any setup or upgrade tasks on the Engine virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the environment is in global maintenance mode before proceeding:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a message indicating that the cluster is in global maintenance mode.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_4-2_SHE">13.3. Updating the oVirt Engine</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_the_Manager_to_4-3_4-2_SHE">13.4. Upgrading the oVirt Engine from 4.2 to 4.3</h3>
<div class="paragraph">
<p>You need to be logged into the machine that you are upgrading.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the upgrade fails, the <code>engine-setup</code> command attempts to restore your oVirt Engine installation to its previous state. For this reason, do not remove the previous version&#8217;s repositories until after the upgrade is complete. If the upgrade fails, the <code>engine-setup</code> script explains how to restore your installation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable the oVirt 4.3 repositories:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum install <a href="https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm" class="bare">https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>All other repositories remain the same across oVirt releases.</p>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Run <code>engine-setup</code> and follow the prompts to upgrade
the oVirt Engine:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># engine-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">Execution of setup completed successfully</code></pre>
</div>
</div>
</li>
<li>
<p>Update the base operating system:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># yum update</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Engine is now upgraded to version 4.3.</p>
</div>
</div>
<div class="sect2">
<h3 id="Disabling_Global_Maintenance_Mode_4-2_SHE">13.5. Disabling global maintenance mode</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Engine virtual machine and shut it down.</p>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes
and disable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=none</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you exit global maintenance mode, ovirt-ha-agent starts the Engine virtual machine, and then the Engine automatically starts. It can take up to ten minutes for the Engine to start.</p>
</div>
</li>
<li>
<p>Confirm that the environment is running:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listed information includes <strong>Engine Status</strong>. The value for <strong>Engine status</strong> should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"health": "good", "vm": "up", "detail": "Up"}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the virtual machine is still booting and the Engine hasn&#8217;t started yet, the <strong>Engine status</strong> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"reason": "bad vm status", "health": "bad", "vm": "up", "detail": "Powering up"}</pre>
</div>
</div>
<div class="paragraph">
<p>If this happens, wait a few minutes and try again.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now update the self-hosted engine nodes, and then any standard hosts. The procedure is the same for both host types.</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_all_hosts_in_a_cluster_4-2_SHE">13.6. Updating All Hosts in a Cluster</h3>
<div class="paragraph">
<p>You can update all hosts in a cluster instead of updating hosts individually. This is particularly useful during upgrades to new versions of oVirt. See <a href="https://github.com/oVirt/ovirt-ansible-collection/blob/master/roles/cluster_upgrade/README.md">oVirt Cluster Upgrade</a> for more information about the Ansible role used to automate the updates.</p>
</div>
<div class="paragraph">
<p>Update one cluster at a time.</p>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines are shut down during the update, unless you choose to skip that host instead.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> and select the cluster. The <strong>Upgrade status</strong> column shows if an upgrade is available for any hosts in the cluster.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>Select the hosts to update, then click <strong>Next</strong>.</p>
</li>
<li>
<p>Configure the options:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Stop Pinned VMs</strong> shuts down any virtual machines that are pinned to hosts in the cluster, and is selected by default. You can clear this check box to skip updating those hosts so that the pinned virtual machines stay running, such as when a pinned virtual machine is running important services or processes and you do not want it to shut down at an unknown time during the update.</p>
</li>
<li>
<p><strong>Upgrade Timeout (Minutes)</strong> sets the time to wait for an individual host to be updated before the cluster upgrade fails with a timeout. The default is <code>60</code>. You can increase it for large clusters where 60 minutes might not be enough, or reduce it for small clusters where the hosts update quickly.</p>
</li>
<li>
<p><strong>Check Upgrade</strong> checks each host for available updates before running the upgrade process. It is not selected by default, but you can select it if you need to ensure that recent updates are included, such as when you have configured the Engine to check for host updates less frequently than the default.</p>
</li>
<li>
<p><strong>Reboot After Upgrade</strong> reboots each host after it is updated, and is selected by default. You can clear this check box to speed up the process if you are sure that there are no pending updates that require a host reboot.</p>
</li>
<li>
<p><strong>Use Maintenance Policy</strong> sets the cluster&#8217;s scheduling policy to <a href="https://ovirt.org/documentation/administration_guide/index#Cluster_Scheduling_Policy_Settings"><code>cluster_maintenance</code></a> during the update. It is selected by default, so activity is limited and virtual machines cannot start unless they are highly available. You can clear this check box if you have a custom scheduling policy that you want to keep using during the update, but this could have unknown consequences. Ensure your custom policy is compatible with cluster upgrade activity before disabling this option.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Review the summary of the hosts and virtual machines that are affected.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>A cluster upgrade status screen displays with a progress bar showing the precentage of completion, and a list of steps in the upgrade process that have completed. You can click <strong>Go to Event Log</strong> to open the log entries for the upgrade. Closing this screen does not interrupt the upgrade process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can track the progress of host updates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> view, the <strong>Upgrade Status</strong> column displays a progress bar that displays the percentage of completion.</p>
</li>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> view</p>
</li>
<li>
<p>in the <strong>Events</strong> section of the <strong>Notification Drawer</strong> (<span class="image"><img src="common/images/EventsIcon.png" alt="EventsIcon" title="Events icon"></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can track the progress of individual virtual machine migrations in the <strong>Status</strong> column of the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span> view. In large environments, you may need to filter the results to show a particular group of virtual machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_4-2_SHE">13.7. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_4-2_SHE">13.8. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>The Engine virtual machine does not need to be rebooted.</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_4-2_SHE">13.9. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you previously upgraded to 4.2 without replacing SHA-1 certificates with SHA-256 certificates, you must do so now.</p>
</div>
</div>
<div class="sect2">
<h3 id="Replacing_SHA-1_Certificates_with_SHA-256_Certificates_4-2_SHE">13.10. Replacing SHA-1 Certificates with SHA-256 Certificates</h3>
<div class="paragraph">
<p>oVirt 4.5 uses SHA-256 signatures, which provide a more secure way to sign SSL certificates than SHA-1. Newly installed systems do not require any special steps to enable oVirt&#8217;s public key infrastructure (PKI) to use SHA-256 signatures.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do <em>NOT</em> let certificates expire. If they expire, the environment becomes non-responsive and recovery is an error prone and time consuming process. For information on renewing certificates, see <a href="https://ovirt.org/documentation/administration_guide/index#chap-Renewing_certificates_RHV_backup_restore">Renewing certificates before they expire</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="Preventing_Warning_Messages_from_Appearing_in_the_Browser_4-2_SHE" class="discrete">Preventing Warning Messages from Appearing in the Browser</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificate that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;apache&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the <strong>httpd</strong> service:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd</code></pre>
</div>
</div>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes and disable global maintenance:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=none</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
</ol>
</div>
<h4 id="Replacing_All_Signed_Certificates_with_SHA-256_4-2_SHE" class="discrete">Replacing All Signed Certificates with SHA-256</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Engine machine as the root user.</p>
</li>
<li>
<p>Check whether <strong>/etc/pki/ovirt-engine/openssl.conf</strong> includes the line <code>default_md = sha256</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it still includes <code>default_md = sha1</code>, back up the existing configuration and change the default to <code>sha256</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/openssl.conf /etc/pki/ovirt-engine/openssl.conf.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# sed -i 's/^default_md = sha1/default_md = sha256/' /etc/pki/ovirt-engine/openssl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Re-sign the CA certificate by backing it up and creating a new certificate in <strong>ca.pem.new</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cp -p /etc/pki/ovirt-engine/private/ca.pem /etc/pki/ovirt-engine/private/ca.pem.&quot;$(date +&quot;%Y%m%d%H%M%S&quot;)&quot;
# openssl x509 -signkey /etc/pki/ovirt-engine/private/ca.pem -in /etc/pki/ovirt-engine/ca.pem -out /etc/pki/ovirt-engine/ca.pem.new -days 3650 -sha256</code></pre>
</div>
</div>
</li>
<li>
<p>Replace the existing certificate with the new certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># mv /etc/pki/ovirt-engine/ca.pem.new /etc/pki/ovirt-engine/ca.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Define the certificates that should be re-signed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine apache websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you replaced the oVirt Engine SSL Certificate after the upgrade, run the following instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># names=&quot;engine websocket-proxy jboss imageio-proxy&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details see <a href="https://ovirt.org/documentation/administration_guide/index#Replacing_the_Manager_CA_Certificate">Replacing the oVirt Engine CA Certificate</a> in the <em>Administration Guide</em>.</p>
</div>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>On the Engine, save a backup of the <code>/etc/ovirt-engine/engine.conf.d</code> and <code>/etc/pki/ovirt-engine</code> directories, and re-sign the certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># . /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
# for name in $names; do
    subject=&quot;$(
        openssl \
            x509 \
            -in /etc/pki/ovirt-engine/certs/&quot;${name}&quot;.cer \
            -noout \
            -subject \
            -nameopt compat \
        | sed \
            's;subject=\(.*\);\1;' \
    )&quot;
   /usr/share/ovirt-engine/bin/pki-enroll-pkcs12.sh \
        --name=&quot;${name}&quot; \
        --password=mypass \ &lt;1&gt;
        --subject=&quot;${subject}&quot; \
        --san=DNS:&quot;${ENGINE_FQDN}&quot; \
        --keep-key
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not change this the password value.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the following services:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># systemctl restart httpd
# systemctl restart ovirt-engine
# systemctl restart ovirt-websocket-proxy
# systemctl restart ovirt-imageio</code></pre>
</div>
</div>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes and disable global maintenance:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=none</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Administration Portal to confirm that the warning no longer appears.</p>
</li>
<li>
<p>If you previously imported a CA or https certificate into the browser, find the certificate(s), remove them from the browser, and reimport the new CA certificate. Install the certificate authority according to the instructions provided by your browser. To get the certificate authority&#8217;s certificate, navigate to <code>http://<em>your-manager-fqdn</em>/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code>, replacing <em>your-manager-fqdn</em> with the fully qualified domain name (FQDN).</p>
</li>
<li>
<p>Enroll the certificates on the hosts. Repeat the following procedure for each host.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span>.</p>
</li>
<li>
<p>Select the host and click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>Once the host is in maintenance mode, click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Enroll Certificate</b></span>.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Activate</b></span>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="updates-between-minor-releases">14. Updates between minor releases</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Minor_Release_Updates">15. Updating oVirt between minor releases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To update from your current version of 4.5 to the latest version of 4.5, update the Engine,  update the hosts, and then change the compatibility version for the cluster, virtual machines, and data center.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If upgrading from version 4.4.9 to a later version fails on oVirt Node, run the <code>dnf reinstall ovirt-node-ng-image-update</code> command to fix the issue.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To update a standalone Engine, follow the standard procedure for minor updates:</p>
</div>
<div class="sect2">
<h3 id="Updating_the_Red_Hat_Virtualization_Manager_minor_updates">15.1. Updating the oVirt Engine</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The centos-release-ovirt45 RPM package is installed and updated to the latest version. This package includes the necessary repositories.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated, reboot the machine to complete the update.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Updating_a_self-hosted_engine_minor_updates">15.2. Updating a Self-Hosted Engine</h3>
<div class="paragraph">
<p>To update a self-hosted engine from your current version to the latest version, you must place the environment in global maintenance mode and then follow the standard procedure for updating between minor versions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure the Engine has the correct repositories enabled. For the list of required repositories, see the section Updating the oVirt Engine.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="Enabling_Global_Maintenance_Mode_SHE_minor_updates" class="discrete">Enabling global maintenance mode</h4>
<div class="paragraph">
<p>You must place the self-hosted engine environment in global maintenance mode before performing any setup or upgrade tasks on the Engine virtual machine.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to one of the self-hosted engine nodes and enable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=global</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the environment is in global maintenance mode before proceeding:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a message indicating that the cluster is in global maintenance mode.</p>
</div>
</li>
</ol>
</div>
<h4 id="Updating_the_Red_Hat_Virtualization_Manager_SHE_minor_updates" class="discrete">Updating the oVirt Engine</h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The centos-release-ovirt45 RPM package is installed and updated to the latest version. This package includes the necessary repositories.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Engine machine, check if updated packages are available:</p>
<div class="listingblock">
<div class="content">
<pre># engine-upgrade-check</pre>
</div>
</div>
</li>
<li>
<p>Update the setup packages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update ovirt\*setup\*</code></pre>
</div>
</div>
</li>
<li>
<p>Update the oVirt Engine with the <code>engine-setup</code> script. The <code>engine-setup</code> script prompts you with some configuration questions, then stops the <code>ovirt-engine</code> service, downloads and installs the updated packages, backs up and updates the database, performs post-installation configuration, and starts the <code>ovirt-engine</code> service.</p>
<div class="listingblock">
<div class="content">
<pre># engine-setup</pre>
</div>
</div>
<div class="paragraph">
<p>When the script completes successfully, the following message appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Execution of setup completed successfully</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>engine-setup</code> script is also used during the oVirt Engine installation process, and it stores the configuration values supplied. During an update, the stored values are displayed when previewing the configuration, and might not be up to date if <code>engine-config</code> was used to update configuration after installation. For example, if <code>engine-config</code> was used to update <code>SANWipeAfterDelete</code> to <code>true</code> after installation, <code>engine-setup</code> will output "Default SAN wipe after delete: False" in the configuration preview. However, the updated values will not be overwritten by <code>engine-setup</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The update process might take some time. Do not stop the process before it completes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the base operating system and any optional packages installed on the Engine:</p>
<div class="listingblock">
<div class="content">
<pre># yum update --nobest</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter a required Ansible package conflict during the update, see <a href="https://access.redhat.com/solutions/5480561">Cannot perform yum update on my RHV manager (ansible conflict)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any kernel packages were updated:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Disable global maintenance mode</p>
</li>
<li>
<p>Reboot the machine to complete the update.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Related Information</div>
<p><a href="#Disabling_Global_Maintenance_Mode_SHE_minor_updates">Disabling global maintenance mode</a></p>
</div>
<h4 id="Disabling_Global_Maintenance_Mode_SHE_minor_updates" class="discrete">Disabling global maintenance mode</h4>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Engine virtual machine and shut it down.</p>
</li>
<li>
<p>Log in to one of the self-hosted engine nodes
and disable global maintenance mode:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --set-maintenance --mode=none</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you exit global maintenance mode, ovirt-ha-agent starts the Engine virtual machine, and then the Engine automatically starts. It can take up to ten minutes for the Engine to start.</p>
</div>
</li>
<li>
<p>Confirm that the environment is running:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># hosted-engine --vm-status</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listed information includes <strong>Engine Status</strong>. The value for <strong>Engine status</strong> should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"health": "good", "vm": "up", "detail": "Up"}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the virtual machine is still booting and the Engine hasn&#8217;t started yet, the <strong>Engine status</strong> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"reason": "bad vm status", "health": "bad", "vm": "up", "detail": "Powering up"}</pre>
</div>
</div>
<div class="paragraph">
<p>If this happens, wait a few minutes and try again.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Updating_all_hosts_in_a_cluster_minor_updates">15.3. Updating All Hosts in a Cluster</h3>
<div class="paragraph">
<p>You can update all hosts in a cluster instead of updating hosts individually. This is particularly useful during upgrades to new versions of oVirt. See <a href="https://github.com/oVirt/ovirt-ansible-collection/blob/master/roles/cluster_upgrade/README.md">oVirt Cluster Upgrade</a> for more information about the Ansible role used to automate the updates.</p>
</div>
<div class="paragraph">
<p>Update one cluster at a time.</p>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines are shut down during the update, unless you choose to skip that host instead.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> and select the cluster. The <strong>Upgrade status</strong> column shows if an upgrade is available for any hosts in the cluster.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>Select the hosts to update, then click <strong>Next</strong>.</p>
</li>
<li>
<p>Configure the options:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Stop Pinned VMs</strong> shuts down any virtual machines that are pinned to hosts in the cluster, and is selected by default. You can clear this check box to skip updating those hosts so that the pinned virtual machines stay running, such as when a pinned virtual machine is running important services or processes and you do not want it to shut down at an unknown time during the update.</p>
</li>
<li>
<p><strong>Upgrade Timeout (Minutes)</strong> sets the time to wait for an individual host to be updated before the cluster upgrade fails with a timeout. The default is <code>60</code>. You can increase it for large clusters where 60 minutes might not be enough, or reduce it for small clusters where the hosts update quickly.</p>
</li>
<li>
<p><strong>Check Upgrade</strong> checks each host for available updates before running the upgrade process. It is not selected by default, but you can select it if you need to ensure that recent updates are included, such as when you have configured the Engine to check for host updates less frequently than the default.</p>
</li>
<li>
<p><strong>Reboot After Upgrade</strong> reboots each host after it is updated, and is selected by default. You can clear this check box to speed up the process if you are sure that there are no pending updates that require a host reboot.</p>
</li>
<li>
<p><strong>Use Maintenance Policy</strong> sets the cluster&#8217;s scheduling policy to <a href="https://ovirt.org/documentation/administration_guide/index#Cluster_Scheduling_Policy_Settings"><code>cluster_maintenance</code></a> during the update. It is selected by default, so activity is limited and virtual machines cannot start unless they are highly available. You can clear this check box if you have a custom scheduling policy that you want to keep using during the update, but this could have unknown consequences. Ensure your custom policy is compatible with cluster upgrade activity before disabling this option.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Review the summary of the hosts and virtual machines that are affected.</p>
</li>
<li>
<p>Click <strong>Upgrade</strong>.</p>
</li>
<li>
<p>A cluster upgrade status screen displays with a progress bar showing the precentage of completion, and a list of steps in the upgrade process that have completed. You can click <strong>Go to Event Log</strong> to open the log entries for the upgrade. Closing this screen does not interrupt the upgrade process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can track the progress of host updates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span> view, the <strong>Upgrade Status</strong> column displays a progress bar that displays the percentage of completion.</p>
</li>
<li>
<p>in the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> view</p>
</li>
<li>
<p>in the <strong>Events</strong> section of the <strong>Notification Drawer</strong> (<span class="image"><img src="common/images/EventsIcon.png" alt="EventsIcon" title="Events icon"></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can track the progress of individual virtual machine migrations in the <strong>Status</strong> column of the <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span> view. In large environments, you may need to filter the results to show a particular group of virtual machines.</p>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Cluster_Compatibility_Version_minor_updates">15.4. Changing the Cluster Compatibility Version</h3>
<div class="paragraph">
<p>oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the cluster compatibility level, you must first update all the hosts in your cluster to a level that supports your desired compatibility level. Check if there is an icon next to the host indicating an update is available.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Virtio NICs are enumerated as a different device after upgrading the cluster compatibility level to 4.6. Therefore, the NICs might need to be reconfigured. oVirt recommends that you test the virtual machines before you upgrade the cluster by setting the cluster compatibility level to 4.6 on the virtual machine and verifying the network connection.</p>
<div class="paragraph">
<p>If the network connection for the virtual machine fails, configure the virtual machine with a custom emulated machine that matches the current emulated machine, for example pc-q35-rhel8.3.0 for 4.5 compatibility version, before upgrading the cluster.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Clusters</b></span>.</p>
</li>
<li>
<p>Select the cluster to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>On the <strong>General</strong> tab, change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Cluster Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An error message might warn that some virtual machines and templates are incorrectly configured. To fix this error, edit each virtual machine manually. The <strong>Edit Virtual Machine</strong> window provides additional validations and warnings that show what to correct. Sometimes the issue is automatically corrected and the virtual machine&#8217;s configuration just needs to be saved again. After editing each virtual machine, you will be able to change the cluster compatibility version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the cluster compatibility version for virtual machines in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_Virtual_Machine_Cluster_Compatibility_minor_updates">15.5. Changing Virtual Machine Cluster Compatibility</h3>
<div class="paragraph">
<p>After updating a cluster&#8217;s compatibility version, you must update the cluster compatibility version of all running or suspended virtual machines by rebooting them from the Administration Portal, or using the REST API, or from within the guest operating system. Virtual machines that require a reboot are marked with the pending changes icon (<span class="image"><img src="common/images/pendingchanges.png" alt="pendingchanges" title="Pending Changes icon"></span>).</p>
</div>
<div class="paragraph">
<p>Although you can wait to reboot the virtual machines at a convenient time, rebooting immediately is highly recommended so that the virtual machines use the latest configuration. Any virtual machine that has not been rebooted runs with the previous configuration, and subsequent configuration changes made to the virtual machine might overwrite its pending cluster compatibility changes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Virtual Machines</b></span>.</p>
</li>
<li>
<p>Check which virtual machines require a reboot. In the <strong>Vms:</strong> search bar, enter the following query:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">next_run_config_exists=True</code></pre>
</div>
</div>
<div class="paragraph">
<p>The search results show all virtual machines with pending changes.</p>
</div>
</li>
<li>
<p>Select each virtual machine and click <strong>Restart</strong>. Alternatively, if necessary you can reboot a virtual machine from within the virtual machine itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the virtual machine starts, the new compatibility version is automatically applied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the cluster compatibility version of a virtual machine snapshot that is in preview. You must first commit or undo the preview.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now update the data center compatibility version.</p>
</div>
</div>
<div class="sect2">
<h3 id="Changing_the_Data_Center_Compatibility_Version_minor_updates">15.6. Changing the Data Center Compatibility Version</h3>
<div class="paragraph">
<p>oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt with which the data center is intended to be compatible. All clusters in the data center must support the desired compatibility level.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>To change the data center compatibility level, you must first update the compatibility version of all clusters and virtual machines in the data center.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Data Centers</b></span>.</p>
</li>
<li>
<p>Select the data center to change and click <b class="button">Edit</b>.</p>
</li>
<li>
<p>Change the <strong>Compatibility Version</strong> to the desired value.</p>
</li>
<li>
<p>Click <b class="button">OK</b>. The <strong>Change Data Center Compatibility Version</strong> confirmation dialog opens.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to confirm.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can also update hosts individually:</p>
</div>
</div>
<div class="sect2">
<h3 id="Updating_Individual_Hosts_minor_updates">15.7. Updating Individual Hosts</h3>
<div class="paragraph">
<p>Use the host upgrade manager to update individual hosts directly from the Administration Portal.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The upgrade manager only checks hosts with a status of <strong>Up</strong> or <strong>Non-operational</strong>, but not <strong>Maintenance</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.
Update a host when its usage is relatively low.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines must be shut down before updating the host.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the correct repositories are enabled. To view a list of currently enabled repositories, run <code>dnf repolist</code>.</p>
<div class="ulist">
<ul>
<li>
<p>For oVirt Nodes the <code>centos-release-ovirt45`</code> RPM package enabling the correct repositories is already installed.</p>
</li>
<li>
<p>For Enterprise Linux hosts:</p>
</li>
<li>
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update -y centos-release-ovirt45</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> and select the host to be updated.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Check for Upgrade</b></span> and click <b class="button">OK</b>.</p>
<div class="paragraph">
<p>Open the <strong>Notification Drawer</strong> (<span class="image"><img src="common/images/EventsIcon.png" alt="EventsIcon" title="Events icon"></span>) and expand the <strong>Events</strong> section to see the result.</p>
</div>
</li>
<li>
<p>If an update is available, click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Upgrade</b></span>.</p>
</li>
<li>
<p>Click <b class="button">OK</b> to update the host. Running virtual machines are migrated according to their migration policy. If migration is disabled for any virtual machines, you are prompted to shut them down.</p>
<div class="paragraph">
<p>The details of the host are updated in <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> and the status transitions through these stages:</p>
</div>
<div class="paragraph">
<p><strong>Maintenance &gt; Installing &gt; Reboot &gt; Up</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the update fails, the host&#8217;s status changes to <strong>Install Failed</strong>. From <strong>Install Failed</strong> you can click <span class="menuseq"><b class="menu">Installation</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Upgrade</b></span> again.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat this procedure for each host in the oVirt environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should update the hosts from the Administration Portal. However, you can update the hosts using <code>dnf upgrade</code> instead.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Manually_Updating_Hosts_minor_updates">15.8. Manually Updating Hosts</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This information is provided for advanced system administrators who need to update hosts manually, but oVirt does not support this method. The procedure described in this topic does not include important steps, including certificate renewal, assuming advanced knowledge of such information. oVirt supports updating hosts using the Administration Portal. For details, see  <a href="https://ovirt.org/documentation/administration_guide/index#Updating_Individual_Hosts_admin">Updating individual hosts</a> or <a href="https://ovirt.org/documentation/administration_guide/index#Updating_all_hosts_in_a_cluster_admin">Updating all hosts in a cluster</a> in the <em>Administration Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use the <code>dnf</code> command to update your hosts. Update your systems regularly, to ensure timely application of security and bug fixes.</p>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>On oVirt Node, the update only preserves modified content in the <code>/etc</code> and <code>/var</code> directories. Modified data in other paths is overwritten during an update.</p>
</li>
<li>
<p>If the cluster has migration enabled, virtual machines are automatically migrated to another host in the cluster.
Update a host when its usage is relatively low.</p>
</li>
<li>
<p>In a self-hosted engine environment, the Engine virtual machine can only migrate between self-hosted engine nodes in the same cluster. It cannot migrate to standard hosts.</p>
</li>
<li>
<p>The cluster must have sufficient memory reserved for its hosts to perform maintenance. Otherwise, virtual machine migrations will hang and fail. You can reduce the memory usage of host updates by shutting down some or all virtual machines before updating hosts.</p>
</li>
<li>
<p>You cannot migrate a pinned virtual machine (such as a virtual machine using a vGPU) to another host.
Pinned virtual machines must be shut down before updating the host.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure the correct repositories are enabled. You can check which repositories are currently enabled by running <code>dnf repolist</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Upgrading from an older 4.5 to latest 4.5:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For oVirt Nodes, the <code>centos-release-ovirt45</code> RPM package enabling the correct repositories is already installed.</p>
</li>
<li>
<p>For Enterprise Linux hosts:</p>
</li>
<li>
<p>If you are going to install on RHEL or derivatives please follow <a href="/ovirt-site/previews/3179/download/install_on_rhel.html">Installing on RHEL or derivatives</a> first.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update -y centos-release-ovirt45</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As <a href="https://lists.ovirt.org/archives/list/users@ovirt.org/thread/DMCC5QCHL6ECXN674JOLABH36U2LVJLJ/">discussed in oVirt Users mailing list</a>
we suggest the user community to use <a href="/ovirt-site/previews/3179/develop/dev-process/install-nightly-snapshot.html">oVirt master snapshot repositories</a>
ensuring that the latest fixes for the platform regressions will be promptly available.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Upgrading from an older 4.4 to latest 4.4:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For oVirt Nodes, the <code>ovirt-release44</code> RPM package enabling the correct repositories is already installed.</p>
</li>
<li>
<p>For Enterprise Linux hosts ensure <code>ovirt-release44</code> RPM package is updated to the latest version:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf update -y ovirt-release44</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Common procedure valid for both 4.4 and 4.5:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Administration Portal, click <span class="menuseq"><b class="menu">Compute</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Hosts</b></span> and select the host to be updated.</p>
</li>
<li>
<p>Click <span class="menuseq"><b class="menu">Management</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Maintenance</b></span> and <b class="button">OK</b>.</p>
</li>
<li>
<p>For Enterprise Linux hosts:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Identify the current version of Enterprise Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># cat /etc/redhat-release</code></pre>
</div>
</div>
</li>
<li>
<p>Check which version of the redhat-release package is available:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf --refresh info --available redhat-release</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command shows any available updates. For example, when upgrading from Enterprise Linux 8.2.<em>z</em> to 8.3, compare the version of the package with the currently installed version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">Available Packages
Name         : redhat-release
Version      : 8.3
Release      : 1.0.el8
&#8230;&#8203;</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Enterprise Linux Advanced Virtualization module is usually released later than the Enterprise Linux y-stream. If no new Advanced Virtualization module is available yet, or if there is an error enabling it, stop here and cancel the upgrade. Otherwise you risk corrupting the host.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the Advanced Virtualization stream is available for Enterprise Linux 8.3 or later, reset the <code>virt</code> module:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module reset virt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If this module is already enabled in the Advanced Virtualization stream, this step is not necessary, but it has no negative impact.</p>
</div>
<div class="paragraph">
<p>You can see the value of the stream by entering:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># dnf module list virt</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Enable the <code>virt</code> module in the Advanced Virtualization stream with the following command:</p>
<div class="ulist">
<ul>
<li>
<p>For oVirt 4.4.2:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module enable virt:8.2</code></pre>
</div>
</div>
</li>
<li>
<p>For oVirt 4.4.3 to 4.4.5:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module enable virt:8.3</code></pre>
</div>
</div>
</li>
<li>
<p>For oVirt 4.4.6 to 4.4.10:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module enable virt:av</code></pre>
</div>
</div>
</li>
<li>
<p>For oVirt 4.5 and later:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># dnf module enable virt:rhel</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Starting with EL 8.6 the Advanced virtualization packages will use the standard <code>virt:rhel</code> module. For EL 8.4 and 8.5, only one Advanced Virtualization stream is used, <code>rhel:av</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Enable version 14 of the <code>nodejs</code> module:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf module -y enable nodejs:14</code></pre>
</div>
</div>
</li>
<li>
<p>Update the host:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># dnf upgrade --nobest</code></pre>
</div>
</div>
</li>
<li>
<p>Reboot the host to ensure all updates are correctly applied.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Check the imgbased logs to see if any additional package updates have failed for a oVirt Node. If some packages were not successfully reinstalled after the update, check that the packages are listed in <strong>/var/imgbased/persisted-rpms</strong>. Add any missing packages then run <code>rpm -Uvh /var/imgbased/persisted-rpms/*</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat this process for each host in the oVirt environment.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Updating_the_Local_Repository_for_an_Offline_Red_Hat_Enterprise_Virtualization_Manager_Installation">Appendix A: Updating the Local Repository for an Offline oVirt Engine Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If your oVirt Engine is hosted on a machine that receives packages via FTP from a local repository, you must regularly synchronize the repository to download package updates from the Content Delivery Network, then update or upgrade that machine. Updated packages address security issues, fix bugs, and add enhancements.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the system hosting the repository, synchronize the repository to download the most recent version of each available package:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># reposync --newest-only /var/ftp/pub/ovirtrepo</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command might download a large number of packages, and take a long time to complete.</p>
</div>
</li>
<li>
<p>Ensure that the repository is available on the Engine machine, and then update or upgrade the machine.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ovirt-legal-notice">Appendix B: Legal notice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Certain portions of this text first appeared in <a href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/html-single/upgrade_guide/index">Red Hat Virtualization 4.4 Upgrade Guide</a>. Copyright © 2022 Red Hat, Inc. Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 Unported License</a>.</p>
</div>
</div>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3179/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3179/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3179/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3179/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=documentation&amp;title=Issue:%20/documentation/upgrade_guide/&amp;template=issue_template_documentation.md' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/documentation/upgrade_guide/index.adoc' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
