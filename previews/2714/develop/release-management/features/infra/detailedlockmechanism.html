<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>DetailedLockMechanism | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="DetailedLockMechanism" />
<meta name="author" content="Michael Kublin" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2714/develop/release-management/features/infra/detailedlockmechanism.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2714/develop/release-management/features/infra/detailedlockmechanism.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DetailedLockMechanism" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Michael Kublin" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Michael Kublin"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2714/images/logo.svg"},"name":"Michael Kublin"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"DetailedLockMechanism","url":"https://ovirt.github.io/ovirt-site/previews/2714/develop/release-management/features/infra/detailedlockmechanism.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2714/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2714/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2714/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2714/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2714/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2714/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2714/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2714/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2714/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2714/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2714/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2714/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2714/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2714/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2714/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2714/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2714/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2714/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2714/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2714/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2714/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2714/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2714/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2714/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2714/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2714/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2714/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2714/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2714/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2714/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2714/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2714/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2714/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2714/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2714/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2714//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2714//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2714/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2714/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2714/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2714/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2714/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9942503c8cf556c85339e8454f375905?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9942503c8cf556c85339e8454f375905?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Michael Kublin</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard"></span><a rel="author" href="https://twitter.com/sandrobonazzola" title="Sandro Bonazzola">Sandro Bonazzola</a></span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yair Zaslavsky</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2714/documentation/'>Documentation is available here.</a></div>

<h1 id="detailed-lock-mechanism">Detailed Lock Mechanism</h1>

<h2 id="internal-locking-mechanism">Internal Locking Mechanism</h2>

<h3 id="summary">Summary</h3>

<p>The following feature should solve collisions which are occurring between sententious flows</p>

<h3 id="owner">Owner</h3>

<ul>
  <li>Name: Michael Kublin (mkublin)</li>
</ul>

<!-- -->

<ul>
  <li>Email: mkublin@redhat.com</li>
</ul>

<h3 id="current-status">Current status</h3>

<ul>
  <li>Target Release: 3.3</li>
  <li>Status: Design of additional functionality</li>
  <li>Previous status: merged</li>
  <li>Last updated date: 29.01.13</li>
</ul>

<h3 id="detailed-description">Detailed Description</h3>

<p><strong>These is design of additional functionality which should allow the following</strong>:</p>
<ol>
  <li>Locks can be kept until end of the execution of all asynchronous task of the command</li>
  <li>Improve error messages for cases when lock can not be acquired</li>
  <li>Integration with AsyncTask manager in order to solve a problem of restart , when there are left command with asynchronous tasks
<strong>The following feature already exists and implemented as in memory generic locking mechanism.</strong>
A locking mechanism can be used all over bll in order to prevent concurrent flows using the same entities.
The feature will include :</li>
  <li>Implementation of locking mechanism, implementation will be memory based</li>
  <li>Introducing it all over a bll logic</li>
  <li>A lock will be short term, and should be released after the appropriate entity was updated in DB (For example, during canDoAction of ActivateStorageDomain we locked domain by internal in memory, and when the canDoAction successes we update status of domain to ‘Locked’ and released an internal in memory lock).</li>
</ol>

<h4 id="entity-description">Entity Description</h4>

<p>Existing entity : EngineLock.
The entity represents the logical representation of the all objects needed to be locked.
An entity will contains a lists of “read locked” entities and “write locked” entites</p>

<h4 id="crud">CRUD</h4>

<p>No need for new CRUD.</p>

<h4 id="user-experience">User Experience</h4>

<p>No GUI required</p>

<h4 id="installationupgrade">Installation/Upgrade</h4>

<p>No impact</p>

<h4 id="user-work-flows">User work-flows</h4>

<p>The implementation will be based on the following algorithm :</p>
<ol>
  <li>The lock command will be marked by annotation and lock of object will be done before canDoAction</li>
  <li>If needed additional treatment the appropriate command will override getReadLocks() and getWriteLocks() methods of CommandBase</li>
  <li>At the end of command the locked will be released (if failure occurred during canDoAction - a lock will be released immediately), if new option is not used</li>
  <li>Additional option will be introduced inside annotation - don’t release lock after end of the execute(). 5. If command is marked by these option a lock will be released at the end of endAction()</li>
</ol>

<p><strong>Explanation on regular flow</strong>:</p>
<ol>
  <li>We are running activate/detach/remove/etc domain</li>
  <li>The entry with domainId will be handled as required lock entity</li>
  <li>The entry with poolId will be handled as read lock, if it is already exists: we will try to update count = count+1 when not write lock is acquired on that entity</li>
  <li>Start Activate Domain.
 Now we want to start Reconstruct:</li>
  <li>The entry with poolId will be handled as write lock. At case that lock on entity can not be acquired - meaning that one of the domains is Locked.
The same issue is regarding HandleFailedStorageDomain because of it can lead to Reconstruct.
 <strong>Explanation on flow with asynchronous tasks</strong>:</li>
  <li>We are running create vm from template</li>
  <li>The entity with templateId will be locked using a read lock</li>
  <li>During execution command the status of template will not be changed in DB</li>
  <li>After finishing all tasks for creation vm - the read lock will be released during a call to AddVmFromTemplateCommand.endAction()
If during a run we will run for example RemoveTemplate, this command should try to acquire exclusive lock on templateId and it will fail.
 <strong>The major change</strong> is that from now all statuses which today is persisted to DB like: status of disk, template, vm will be used only for representative purpose and in memory locks should be used in order to determine if the operation can be run or not.</li>
</ol>

<h4 id="failures">Failures</h4>

<p>During restart of JBOSS a following improvements will be done in AsyncTaskManger</p>
<ol>
  <li>All tasks which are kept in DB will be loaded to memory (Should be done at any case, in order to improve AsyncTaskManager)</li>
  <li>During load of tasks, appropriate objects will be created, because of such object are representing a tasks - all appropriate locks will be acquired again</li>
  <li>If task is not found in DB , but exists in VDSM - no problem , locks will not be acquired - should solve a problem of locked objects forever</li>
  <li>If task found in DB and not found in VDSM - appropriate mechanism in AsyncTaskManager will clean a task and will release all locks (The following mechanism should be improved , with out any connection to following feature)
The described changes will solve a problem of lack persistence (The locks are in memory locks).</li>
</ol>

<h4 id="events">Events</h4>

<p>In case that user did not successes to acquire a lock appropriate canDoaction message should appeared to user. In order to improve user experience will be added an options to specify error message for chosen lock.</p>

<h3 id="dependencies--related-features-and-projects">Dependencies / Related Features and Projects</h3>

<p>The following feature will provide a generic mechanism for synchronization different flows in ovirt, by default it will be applied only on known problematic flows , like: storage, vms and permissions flows.</p>

<h3 id="documentation--external-references">Documentation / External references</h3>

<p>NA</p>

<h3 id="open-issues">Open Issues</h3>

<p><a href="/ovirt-site/previews/2714/develop/release-management/features/">LockMechanism</a> <a href="/ovirt-site/previews/2714/develop/release-management/releases/3.3/feature.html">LockMechanism</a></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2714/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2714/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2714/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2714/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/detailedlockmechanism.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/infra/detailedlockmechanism.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
