<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Engine Vacuum Tool | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Engine Vacuum Tool" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3051/develop/release-management/features/infra/Engine_vacuum.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3051/develop/release-management/features/infra/Engine_vacuum.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Engine Vacuum Tool" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Engine Vacuum Tool","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3051/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3051/develop/release-management/features/infra/Engine_vacuum.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3051/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3051/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3051/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3051/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3051/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3051/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3051/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3051/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3051/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3051/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3051/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3051/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3051/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3051/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3051/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3051/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3051/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3051/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3051/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3051/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3051/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3051/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3051//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3051//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3051/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3051/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3051/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3051/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3051/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Roy Golan">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Roy Golan</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3051/documentation/'>Documentation is available here.</a></div>

<h1 id="engine-vacuum">Engine Vacuum</h1>

<h1 id="description">Description</h1>
<p>This page describes the <strong><em>engine-vacuum</em></strong> cli tool and the <strong><em>vacuum setup-plugin</em></strong> that uses it.</p>

<h1 id="motivation">Motivation</h1>

<blockquote>
  <p>“PostgreSQL databases require periodic maintenance known as vacuuming.
For many installations, it is sufficient to let vacuuming be performed by the autovacuum daemon”</p>
  <ul>
    <li>routine-vacuuming, <a href="https://www.postgresql.org/docs/9.2/static/routine-vacuuming.html">postgres documentation</a></li>
  </ul>
</blockquote>

<p>Apart from updating the tables and removing garbage from the tables,
full vacuum is the only vacuum operation that can reclaim disk space back to the operating system.
If the engine db is falling behind in collecting garbage,(autovacuum doesn’t perfom optimally) we will
see disk usage growth in time as a result.</p>

<p>The engine-vacuum tool is a wrapper around postgres commands and is aimed to ease Vacuum
maintenance actions on the DB, and can be used easily and securely, as they reuse
the setup credentials to authenticate against the engine db. The tool is being
used by an engine-setup plugin and act as a maintenance task, taking advantage of
the downtime period when updating the engine. The tool can be used just as well
by cron, script or just manual invocation and it covers most of the functionality
of the vacuum commands.</p>

<h1 id="scope">Scope</h1>
<p>This page covers the tool itself, and the engine-setup plugin that was created to use it.</p>

<p>Not covered - Vacuum design and functionality. See the references section to read about vacuum.</p>

<h1 id="synopsis">Synopsis</h1>

<h2 id="engine-vacuum-1">engine-vacuum</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  engine-vacuum <span class="o">[</span>OPTION]...
</code></pre></div></div>
<p>Located under <code class="language-plaintext highlighter-rouge">/bin/engine-vacuum</code>, invoking this can perform vacuum, vacuum full
and analyze against the installed engine db, optionally specifying the tables,
without needing to specifying the engine db, user and password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum <span class="nt">--help</span>

  <span class="nt">-a</span>          - run analyze, update optimizer statistics
  <span class="nt">-A</span>          - run analyze only, only update optimizer stats, no vacuum
  <span class="nt">-f</span>          - <span class="k">do </span>full vacuuming
  <span class="nt">-t</span>          - vacuum specific table
  <span class="nt">-v</span>          - verbose output
  <span class="nt">-h</span>          - print this usage message
</code></pre></div></div>

<h2 id="examples">Examples</h2>
<p>Run vacuum only:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum
</code></pre></div></div>

<p>Run vacuum analyze:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum <span class="nt">-a</span>
</code></pre></div></div>

<p>Only update <a href="https://wiki.postgresql.org/wiki/Introduction_to_VACUUM,_ANALYZE,_EXPLAIN,_and_COUNT#Using_ANALYZE_to_optimize_PostgreSQL_queries">optimizer stats</a>, no vacuum:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum <span class="nt">-A</span>
</code></pre></div></div>
<p>Run vacuum full, and verbose for more output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum <span class="nt">-f</span> <span class="nt">-v</span>
</code></pre></div></div>
<p>Run vacuum full, verbose on vm_dynamic and vds_dynamic tables only:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-vacuum <span class="nt">-f</span> <span class="nt">-v</span> <span class="nt">-t</span> vm_dynamic <span class="nt">-t</span> vds_dynamic
</code></pre></div></div>

<h2 id="vacuum-setup-plugin">Vacuum setup plugin</h2>
<p>During an execution of engine-setup, excluding new installation, at the
 customization stage, the setup will raise a dialog, asking to perform full vacuum:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>engine-setup
...
<span class="o">[</span> INFO  <span class="o">]</span> Stage: Environment customization
...
          Perform full vacuum on the engine database engine@localhost?
          This operation may take a <span class="k">while </span>depending on this setup health and the
          configuration of the db vacuum process.
          See https://www.postgresql.org/docs/9.2/static/sql-vacuum.html
          <span class="o">(</span>Yes, No<span class="o">)</span> <span class="o">[</span>No]:
</code></pre></div></div>

<p>Choosing <code class="language-plaintext highlighter-rouge">[Yes]</code>, will invoke vacuum full verbose on the engine db by
invoking <code class="language-plaintext highlighter-rouge">engine-vacuum -f -v</code> and by setting <code class="language-plaintext highlighter-rouge">/tmp/{tmpdir}/.pgpass</code> - See <a href="https://www.postgresql.org/docs/9.2/static/libpq-pgpass.html">pgpass documantation</a>.</p>

<ul>
  <li>Default value: <em>No</em> (does nothing)</li>
  <li>Output: to the install log, small elapsed time summary to the console</li>
  <li>Answer file entry: <code class="language-plaintext highlighter-rouge">OVESETUP_DB/engineVacuumFull=bool:False</code></li>
  <li>Fail install on error: <em>Yes</em>, output will go to the installation log</li>
</ul>

<h2 id="security">Security</h2>
<p>The credentials of the user, engine db and password
are taken from /etc/ovirt-engine/engine.conf.d/10-setup-database and passed
using .pgpass file thus not used as a command argument and not in risk to
go into history, log or similar. See <a href="https://www.postgresql.org/docs/9.2/static/libpq-pgpass.html">pgpass documentation</a> for more details.</p>

<h2 id="todo">TODO</h2>
<ul>
  <li>Try to give a rough estimation of how long this is going to take. We can count
the dead rows and at least provide the size of amount of bytes to delete.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">relname</span><span class="p">,</span><span class="n">n_dead_tup</span> <span class="k">from</span> <span class="n">pg_stat_user_tables</span> <span class="k">order</span> <span class="k">by</span> <span class="n">n_dead_tup</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://www.postgresql.org/docs/9.2/static/routine-vacuuming.html">Postgres routine vacuuming documentation page</a></li>
  <li><a href="https://www.postgresql.org/docs/9.2/static/libpq-pgpass.html">Postgres pgpass documentation page</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1388430">The original RFE for this page</a> - https://bugzilla.redhat.com/show_bug.cgi?id=1388430</li>
  <li><a href="https://wiki.postgresql.org/wiki/Introduction_to_VACUUM,_ANALYZE,_EXPLAIN,_and_COUNT#Using_ANALYZE_to_optimize_PostgreSQL_queries">Using ANALYZE to optimize PostgreSQL queries</a></li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3051/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3051/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3051/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3051/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/Engine_vacuum.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/Engine_vacuum.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
