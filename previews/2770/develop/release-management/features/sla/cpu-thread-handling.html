<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>CPU thread handling | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="CPU thread handling" />
<meta name="author" content="Dave Neary" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2770/develop/release-management/features/sla/cpu-thread-handling.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2770/develop/release-management/features/sla/cpu-thread-handling.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CPU thread handling" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dave Neary" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Dave Neary"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2770/images/logo.svg"},"name":"Dave Neary"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"CPU thread handling","url":"https://ovirt.github.io/ovirt-site/previews/2770/develop/release-management/features/sla/cpu-thread-handling.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2770/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2770/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2770/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2770/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2770/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2770/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2770/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2770/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2770/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2770/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2770/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2770/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2770/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2770/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2770/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2770/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2770/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2770/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2770/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2770/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2770/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2770/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2770/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2770/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2770/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2770/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2770/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2770/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2770/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2770/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2770/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2770/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2770/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2770/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2770/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2770//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2770//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2770/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2770/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2770/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2770/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2770/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cae1a4eca8b71a21d58846508922e062?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cae1a4eca8b71a21d58846508922e062?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dave Neary</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Doron Fediuck</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Greg Padgett</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2770/documentation/'>Documentation is available here.</a></div>

<h1 id="cpu-thread-handling">CPU Thread Handling</h1>

<h2 id="summary">Summary</h2>

<p>CPU Thread Handling allows hosts to run VMs with a total number of processor cores greater than number of cores in the host. This can be useful for non-CPU-intensive workloads, where allowing a greater number of VMs to start can reduce hardware requirements (along with the associated benefits of easier management, energy savings, lower hardware costs, etc). It also allows VMs to run with CPU topologies that wouldn’t be allowed without this option, specifically if the number of guest cores is between the number of host cores and number of host threads.</p>

<p>This project would allow the engine to optionally treat host CPU threads as cores for the purposes of running VMs, on a user-configurable cluster-by-cluster basis. When both SMT (AMD Clustered MultiThreading or Intel Hyper-Threading technology) and this feature are enabled, this would increase the capacity of hosts and may help performance for certain workloads.</p>

<p>There is a possibility that enabling this feature will cause performance degradation and unacceptable QoS on the guests. Currently, there is no QoS monitoring or alerting for this feature. This is planned for the future–this project is just a first step to full CPU Overcommitment support.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Greg Padgett (Gpadgett)</li>
  <li>Email: <a href="mailto:gpadgett@redhatdotcom">gpadgett@redhatdotcom</a></li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>4/5 patches merged, 1 in code review</li>
  <li>Last updated date: 21 Dec 2012</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>This project would allow, on a configurable per-cluster basis, hosts to effectively treat host threads as cores which guests can utilize. The exposed threads would look like cores to the guest VMs. For example, a 24-core system with 2 threads per core (48 threads total) could run VMs with up to 48 cores each, and the algorithms to calculate host CPU load would compare load against twice as many potential utilized cores.</p>

<p>In contrast, oVirt 3.1 has very limited facilities to run VMs past the point where a 1:1 virtual-to-physical CPU mapping is achieved. The described functionality can be achieved in 3.1 by changing a vdsm setting that exposes threads as cores, but it is on a host-by-host basis configured on the host itself (in vdsm.conf; report_host_threads_as_cores=true).</p>

<p>The proposal is to give the engine the knowledge of the host cores and threads, as well as the ability to choose how it wants to treat them with respect to VM capacity. When enabled, this feature would allow guest virtual CPU cores to run on host CPU threads based on host membership to a cluster, further utilizing host CPU SMT capabilities. The running guests would not have knowledge of the threads (they would appear as cores) or the host-to-guest CPU mapping.</p>

<h3 id="changes">Changes</h3>

<ul>
  <li>UI:
    <ul>
      <li>add CPU threading info to Host status, General tab
        <ul>
          <li>this shows up only if a host is not a member of a 3.1 cluster</li>
        </ul>
      </li>
      <li>redesign Optimization tab of Add/Edit Cluster dialog, to include CPU Threading option
        <ul>
          <li>new option not visible if cluster compatibility version &lt; 3.2</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/ovirt-site/previews/2770/images/wiki/Cpuovercommit.png" alt="" /></p>

<p><img src="/ovirt-site/previews/2770/images/wiki/Cputhreads-hostsgeneral.png" alt="" /></p>

<ul>
  <li>backend:
    <ul>
      <li>add db column, boolean vds_groups.count_threads_as_cores</li>
      <li>add db column, integer vds_dynamic.cpu_threads
        <ul>
          <li>db scripts, DAO for above changes</li>
        </ul>
      </li>
      <li>vdsbroker changes to store new cpu_threads value</li>
      <li>logic changes for when VMs can run or migrate (VdsSelector)
        <ul>
          <li>compute an effective core count based on cpu threading capability and cluster configuration</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>REST API:
    <ul>
      <li>add new cluster and vds attributes</li>
    </ul>
  </li>
  <li>VDSM:
    <ul>
      <li>expose threading info (see VDSM section)</li>
    </ul>
  </li>
</ul>

<!-- -->

<ul>
  <li>
    <ul>
      <li>-or- add boolean vds_dynamic.cpu_real_cores (see VDSM section for more detail)</li>
    </ul>
  </li>
</ul>

<h3 id="vdsm">VDSM</h3>

<p>VDSM currently exposes host count of cpuCores and cpuSockets, both in getVdsCapabilities. There is a configuration setting, report_host_threads_as_cores, which if true may cause the reported cpuCores value to not reflect the physical cpu topology of the host. To enable engine control of CPU threads, we need both an accurate core count, and a way to determine the number of cpu threads on the host. Moving forward, having an accurate cpu topology of the host will help enable performance optimization with NUMA considerations, CPU pinning (e.g. share L1 cache by pinning guest CPUs to the same physical cores), etc.</p>

<p>One new option will be returned from getVdsCapabilities: an integer cpuThreads. This will always report the actual number of threads on the host. It is possible for the cpuCores value returned from vdsm to not be true, based on the vdsm.conf report_threads_as_cores setting on the host. ** It is recommended to turn this setting off for hosts in 3.2 clusters and let the engine manage cpu thread utilization. ** This configuration option may be removed in the future, now that the engine can accomplish the same task.</p>

<p>(For historical context, note that an option to return an extra value to allow engine to determine the true number of cores was discussed. This would have been either a boolean reflecting the vdsm.conf option above, or an integer e.g. cpuCores2 which would always report the true number of cores. However, the additional complexity and cruft in the API wasn’t justified by the [estimated] rare use of this option.)</p>

<p>CPU topology returned by getVdsCapabilities</p>

<table>
  <thead>
    <tr>
      <th>version</th>
      <th>attributes</th>
      <th>notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>3.1</td>
      <td>cpuSockets, cpuCores</td>
      <td>cpuCores may actually be cpuThreads</td>
    </tr>
    <tr>
      <td>3.2</td>
      <td>cpuSockets, cpuCores, cpuThreads</td>
      <td>engine should controls 3.2 cluster threading; vdsm controls &lt;3.2; users should turn off vdsm.conf report_host_threads_as_cores for 3.2 clusters</td>
    </tr>
    <tr>
      <td>after 3.2</td>
      <td>cpuSockets, cpuCores, cpuThreads</td>
      <td>if min cluster version is 3.2, vdsm.conf report_host_threads_as_cores may be removed</td>
    </tr>
  </tbody>
</table>

<h3 id="compatibility">Compatibility</h3>

<p>This feature will be enabled for clusters with Compatibility Version &gt;= 3.2. For those with lower versions, the default will be disabled: only host physical cores will be available for guest cores to run on. (Adjustable via VDSM, as today.) In this case, the section to set the Treat Threads as Cores attribute in the Add/Edit Cluster dialog will not be visible.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Increase capacity of hosts for certain workloads.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<ul>
  <li>TBD</li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li>TBD</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2770/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2770/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2770/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2770/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/cpu-thread-handling.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/sla/cpu-thread-handling.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
