<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Migration encryption | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Migration encryption" />
<meta name="author" content="Milan Zamazal" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2830/develop/release-management/features/virt/migration-encryption.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2830/develop/release-management/features/virt/migration-encryption.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Migration encryption" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Milan Zamazal" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Milan Zamazal"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Migration encryption","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2830/images/logo.svg"},"name":"Milan Zamazal"},"url":"https://ovirt.github.io/ovirt-site/previews/2830/develop/release-management/features/virt/migration-encryption.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2830/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2830/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2830/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2830/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2830/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2830/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2830/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2830/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2830/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2830/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2830/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2830/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2830/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2830/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2830/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2830/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2830/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2830/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2830/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2830/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2830/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2830/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2830//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2830//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2830/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2830/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2830/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2830/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2830/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Milan Zamazal</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Lucia Jelinkova</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2830/documentation/'>Documentation is available here.</a></div>

<h1 id="migration-encryption">Migration encryption</h1>

<h2 id="summary">Summary</h2>

<p>Add support for native TLS encryption of live migrations.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>
    <p>Name: Milan Zamazal (mz-pdm)</p>
  </li>
  <li>
    <p>Email: <a href="mailto:mzamazal@redhat.com">mzamazal@redhat.com</a></p>
  </li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>Now, when QEMU provides native TLS encryption support, we can add support for secure migrations with a low performance overhead.  A user can enable encrypted migration for a cluster in Engine and then libvirt is asked to perform native QEMU TLS migrations when migrating VMs between hosts.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Cluster level 4.4 or higher is required to enable migration encryption.</p>

<h2 id="limitations">Limitations</h2>

<p>Currently, an encrypted migration cannot use a separate migration network.  The destination certificate contains only the host name and not its IP addresses.  Putting IP addresses there would be cumbersome for both the code and the user (a host must be switched to the maintenance mode to update its certificate), difficult to maintain and error-prone, since the IP addresses may change at different times and places.  The migration client checks the presence of the destination address in the destination certificate, thus only the host name (and the related network) can be used as the migration destination address.</p>

<p>A solution would be to enhance libvirt with a migration parameter that specifies the host name to check for in the certificate, independently of the destination address used.  QEMU already provides the facility, it just needs to be supported by libvirt, see this RFE: https://bugzilla.redhat.com/show_bug.cgi?id=1754533.</p>

<p>We will be able to remove the limitation once the libvirt RFE is implemented and released.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Live migrations can be secured, providing more protection to the data transferred between the hosts.</p>

<h2 id="user-experience">User Experience</h2>

<p>There is new “Enable migration encryption” option in Migration Policy tab of the cluster edit dialog.  It’s possible to enable or disable encrypted migrations there or to use the system default, which is not to encrypt migrations currently.</p>

<p><img src="/ovirt-site/previews/2830/images/wiki/migration-encryption-cluster.png" alt="" /></p>

<p>There is a similar item in Host tab of the VM edit dialog, to enable or disable encrypted migrations for a particular VM if needed.</p>

<p><img src="/ovirt-site/previews/2830/images/wiki/migration-encryption-vm.png" alt="" /></p>

<p>Migration encryption support is available only on cluster level 4.4 or higher.</p>

<p>There is no way to enable or disable migration encryption for individual migrations.</p>

<h2 id="implementation">Implementation</h2>

<p>Migration encryption is supported in Vdsm by passing <code class="language-plaintext highlighter-rouge">encrypted</code> migration parameter, of boolean type, to <code class="language-plaintext highlighter-rouge">VM.migrate</code> API call.  According to the value of the parameter, Vdsm asks libvirt to perform an encrypted or non-encrypted migration.  In case the parameter is missing, non-encrypted migration is used, to be compatible with older hosts.</p>

<p>To make migration encryption working, there are some changes needed in certificate handling:</p>

<ul>
  <li>libvirt support for checking the expected host name in the certificate, see <a href="#limitations">Limitations</a> above.</li>
  <li>Introduction of QEMU-only certificates.</li>
</ul>

<p>QEMU-only certificates are needed because a direct secure connection between QEMU processes is established and used for the migration.  For security reasons, QEMU processes must not be able to connect to libvirt, Vdsm or other services.  That means separate distinguishable QEMU certificates must be used for QEMU connections.  The safest and most robust way to separate QEMU certificates from other certificates is to use a separate certification authority for issuing QEMU certificates.  Then it is automatically ensured that QEMU processes can’t connect to libvirt or Vdsm, since their certificates are signed by a different certificate authority than the other services expect.  We need to add:</p>

<ul>
  <li>Certificate of the QEMU certification authority and its management.</li>
  <li>Management of QEMU certificates and their deployment to hosts.</li>
  <li>Libvirt configuration amendment to specify the location of the QEMU certificates on the host.</li>
</ul>

<h2 id="rest-api">REST API</h2>

<p>Migration encryption, as described above, can be managed from the REST API.  New boolean option <code class="language-plaintext highlighter-rouge">encrypted</code> has been added to other migration options in the REST API.  It can be used to enable or disable encrypted migrations for a given cluster or a VM.</p>

<h2 id="testing">Testing</h2>

<p>The following facts should be checked:</p>

<ul>
  <li>An encrypted migration can be performed successfully.</li>
  <li>The migration is indeed encrypted.</li>
  <li>There is no huge impact on migration performance when using encryption (there may still be a noticeable impact though).</li>
  <li>All the cluster/VM combinations of the options to enable or disable migration encryption work as expected.</li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2830/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2830/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2830/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2830/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/migration-encryption.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/migration-encryption.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
