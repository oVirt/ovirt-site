<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Profiling Vdsm | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Profiling Vdsm" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3092/develop/developer-guide/vdsm/profiling-vdsm.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3092/develop/developer-guide/vdsm/profiling-vdsm.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Profiling Vdsm" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Profiling Vdsm","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3092/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3092/develop/developer-guide/vdsm/profiling-vdsm.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3092/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3092/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3092/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3092/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3092/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3092/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3092/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3092/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3092/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3092/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3092/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3092/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3092/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3092/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3092/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3092/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3092/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3092/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3092/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3092/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3092/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3092/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3092//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3092//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3092/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3092/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3092/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3092/develop/developer-guide/vdsm/">
              <span property="name">Vdsm</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/7054bd65a0f097bbc1e54f4652d59f8b?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/7054bd65a0f097bbc1e54f4652d59f8b?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Francesco Romani">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Francesco Romani</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="profiling-vdsm">Profiling Vdsm</h1>

<h2 id="summary">Summary</h2>

<p>This page collects informations and hints about how to profile VDSM. To profile VDSM, you need to do some small and self-contained modifications. Make sure you have the cProfile package available.</p>

<p><strong>WORK IN PROGRESS</strong></p>

<h2 id="general-recommendations">General recommendations</h2>

<ul>
  <li>use standard python tools wherever/whenever feasible and as first choice: they are the most common, widely available, well understood and easily interoperable</li>
</ul>

<!-- -->

<ul>
  <li>bear in mind VDSM is a multi-thread and multi-process system daemon. It has both short-running and long-running threads.</li>
</ul>

<h2 id="collecting-and-inspecting-statistics">collecting and inspecting statistics</h2>

<p>The advantage of using the standard python tools is that statistics are in the Pstats format, so the <a href="http://docs.python.org/2/library/profile.html">standard way of inspecting them applies</a>.</p>

<p>To explore statistics or to quickly change the presentation of the statistics, the pstats interactive mode can be handy</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     python -m pstats /path/to/main/profile/data
</code></pre></div></div>

<p><a href="http://stefaanlippens.net/python_profiling_with_pstats_interactive_mode">quick description of the interactive mode</a></p>

<p>TODO: add helper snippets/scripts</p>

<h2 id="profiling-functions">profiling functions</h2>

<p>If you want to profile single funcions, this decorator is a simple yet effective solution. Credit for this code goes to Antoni Segura Puimedon for the original implementation; the version presented here was edited with the sole purpose to be self-contained:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     def profile(func):
         from cProfile import Profile
         from functools import wraps
         from tempfile import NamedTemporaryFile
         @wraps(func)
         def profiled_execution(*args, **kwargs):
             logging.info('profiling method %s' % func.__name__)
             profiler = Profile()
             ret = profiler.runcall(func, *args, **kwargs)
             prof_file = NamedTemporaryFile(mode='w',
                                            prefix=func.__name__,
                                            delete=False)
             profiler.dump_stats(prof_file.name)
             logging.info('profiled method %s and dumped results to %s' % (
                          func.__name__, prof_file.name))
             return ret
         return profiled_execution
</code></pre></div></div>

<p>The “logging” module is already used extensively inside VDSM so it is assumed to be available. You can embed this snippet in the file containing the function you want to profile, or in the vdsm library code. In this case, a good place is lib/vdsm/utils.py in the VDSM source tree.</p>

<h2 id="profile-the-entire-vdsm">profile the entire VDSM</h2>

<p>To profile the entire VDSM, you may use <a href="http://code.google.com/p/yappi/">yappi</a>. Despite being a third-party solution, yappi fits nicely with VDSM because it is not intrusive and it is designed to work with long-running multi-threaded applications.</p>

<p>yappi is eaily installable from pip. It is a C extension, so make sure you have the C compiler and the python development packages installed.</p>

<p><strong>FIXME</strong> explain how to integrate yappi in VDSM</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3092/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3092/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3092/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3092/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/vdsm/profiling-vdsm.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/vdsm/profiling-vdsm.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
