<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Phoenix Lab oVirt Hosts | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Phoenix Lab oVirt Hosts" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2780/develop/infra/phoenix-lab-hosts.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2780/develop/infra/phoenix-lab-hosts.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Phoenix Lab oVirt Hosts" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2780/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Phoenix Lab oVirt Hosts","url":"https://ovirt.github.io/ovirt-site/previews/2780/develop/infra/phoenix-lab-hosts.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2780/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2780/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2780/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2780/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2780/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2780/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2780/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2780/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2780/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2780/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2780/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2780/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2780/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2780/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2780/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2780/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2780/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2780/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2780/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2780/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2780/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2780/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2780/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2780/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2780/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2780/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2780/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2780/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2780/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2780/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2780/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2780/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2780/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2780/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2780/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2780//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2780//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2780/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2780/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2780/develop/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bcb2aef8cc1559485f70f69eed60b9bb?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bcb2aef8cc1559485f70f69eed60b9bb?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">David</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>This developer documentation is <strong>outdated</strong>, but provides historical context.<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2780/documentation/'>Documentation is available here.</a></div>

<h1 id="phoenix-lab-ovirt-hosts">Phoenix Lab oVirt Hosts</h1>

<p><strong>NOTE</strong>: for the latest version of this doc, see <a href="http://ovirt-infra-docs.readthedocs.org/en/latest/">http://ovirt-infra-docs.readthedocs.org/en/latest/</a></p>

<p>All the hosts have a server installation of Fedora 19, with a hardware RAID5 setup and bonding on all interfaces.</p>

<p>The hosts are separated in two groups, one that hosts the hosted engine and all the others. Right now we also have one of the hosts reserved (ovirt-srv08.ovirt.org) for the new integration testing framework.</p>

<h2 id="network-configuration">Network configuration</h2>

<p>Due to an restriction of the bonding drivers on Fedora 19, the network bond interfaces has to be bond1 instead of bond0, so the relevant networking configuration files end up as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ovirt-srv01 ~]# cat /etc/sysconfig/network
HOSTNAME=ovirt-srv01
GATEWAY=66.187.230.126
[root@ovirt-srv01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-em1
# Generated by VDSM version 4.14.9-0.fc19
DEVICE=em1
ONBOOT=yes
HWADDR=f8:bc:12:3b:4e:08
NM_CONTROLLED=no
SLAVE=yes
MASTER=bond1
USERCTL=no

[root@ovirt-srv01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond1
DEVICE=bond1
ONBOOT=yes
BRIDGE=ovirtmgmt
NM_CONTROLLED=no
STP=no
HOTPLUG=no
BONDING_OPTS="mode=4 miimon=100 lacp_rate=1"
</code></pre></div></div>

<p>Note the special <em>BONDING_OPTS</em>, that sets the type of bonding and rate to the same configured in the switch.</p>

<p>The current network range that we are using is 66.187.230.0/25, with the gateway at 60.187.230.126. All the ips are public but there’s a transparent firewall that blocks any incoming request.</p>

<h2 id="hosted-engine-management">Hosted engine management</h2>

<p>The three first hosts (when writing this), <code class="language-plaintext highlighter-rouge">ovirt-srv01</code>, <code class="language-plaintext highlighter-rouge">ovirt-srv02</code> and <code class="language-plaintext highlighter-rouge">ovirt-srv03</code> are the ones that manage the hosted engine vm. That hosted engine is not handled by itself but by a couple of services and scripts installed bu the hosted-engine rpms.</p>

<p>To check the current status of the hosted engine cluster, you can run from any of those hosts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ovirt-srv01 ~]# hosted-engine --vm-status

--== Host 1 status ==--

Status up-to-date                  : True
Hostname                           : 66.187.230.3
Host ID                            : 1
Engine status                      : {"health": "good", "vm": "up", "detail": "up"}
Score                              : 2400
Local maintenance                  : False
Host timestamp                     : 1415642612
Extra metadata (valid at timestamp):
    metadata_parse_version=1
    metadata_feature_version=1
    timestamp=1415642612 (Mon Nov 10 11:03:32 2014)
    host-id=1
    score=2400
    maintenance=False
    state=EngineUp

--== Host 2 status ==--

Status up-to-date                  : True
Hostname                           : 66.187.230.4
Host ID                            : 2
Engine status                      : {"reason": "vm not running on this host", "health": "bad", "vm": "down", "detail": "unknown"}
Score                              : 2400
Local maintenance                  : False
Host timestamp                     : 1415642616
Extra metadata (valid at timestamp):
    metadata_parse_version=1
    metadata_feature_version=1
    timestamp=1415642616 (Mon Nov 10 11:03:36 2014)
    host-id=2
    score=2400
    maintenance=False
    state=EngineDown

--== Host 3 status ==--

Status up-to-date                  : True
Hostname                           : ovirt-srv03.ovirt.org
Host ID                            : 3
Engine status                      : {"reason": "vm not running on this host", "health": "bad", "vm": "down", "detail": "unknown"}
Score                              : 2400
Local maintenance                  : False
Host timestamp                     : 1415642615
Extra metadata (valid at timestamp):
    metadata_parse_version=1
    metadata_feature_version=1
    timestamp=1415642615 (Mon Nov 10 11:03:35 2014)
    host-id=3
    score=2400
    maintenance=False
    state=EngineDown
</code></pre></div></div>

<p>You can see that the engine is running only on one of the hosts. You can set one host into maintenance mode executing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ovirt-srv01 ~]# hosted-engine --set-maintenance=local
</code></pre></div></div>

<p>From the selected host. You can also handle the vm engine with hoset-endine command (<strong>don’t do it through the engine ui</strong>).</p>

<h2 id="ovirt-datacenter-organization">oVirt datacenter organization</h2>

<p>All the hosts are distributed across two datacenters, jenkins and production (Default in the ui), the first one is ment to host all the jenkins related vms and any testing vm outside jenkins. The production one is configured for high availability and is ment to host all the service vms that host production services like foreman, jenkins or resources01.</p>

<h3 id="production-vms">Production VMs</h3>

<p>There are no templates yet in this datacenter but some base netinstall images are uploaded, so if you have to create a new vm you’d be able to do so using the netinstall boot from foreman.</p>

<p>Currently these are the vms that we have in the production datacenter:</p>

<ul>
  <li>foreman-phx: Foreman proxy serving the phoenix network, includes DHCP, TFTP and DNS services. Also serves (or will) as DNS for the network.</li>
  <li>HostedEngine: VM with the hosted engine, is not actually managed by itself but by the hosted engine services.</li>
  <li>resources01-phx-ovirt-org: Frontend to serve the old repositories in resources.ovirt.org. It’s connected to a special shared disk where the repos are stored, so it’s easy to plug-unplug it from the vm if need upgrading or anything.</li>
  <li>proxy-phx-ovirt-org: This will be the local network squid proxy, is not yet functional but the idea is to use it to cache mostly yum packages, as we use intensive use of those when building with mock.</li>
</ul>

<h3 id="jenkins-vms">Jenkins VMs</h3>

<p>The jenkins DC has all the slaves and templates used to build them. The amount and oses/distros varies often but the organization should be quite stable.</p>

<p>The slaves are named following the pattern:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${DISTRO}${VERSION}-vm${NUMBER}-phx-ovirt-org
</code></pre></div></div>

<p>That way is fairly easy to know the relevant information about the slave just by it’s name. The number is used only to distinguish between the vms from the same distro/version, so it’s only requirement is to be unique, though we usually try to use the lowest available number (that might change in the future when we automate the slave creation, thatn might be replace with the build name or just a hash).</p>

<p>The templates are named the same way the slaves are, but instead of using the <code class="language-plaintext highlighter-rouge">vm${NUMBER}</code> suffix you only have two suffixes, <code class="language-plaintext highlighter-rouge">-base</code> and <code class="language-plaintext highlighter-rouge">-jenkins-slave</code>. The <code class="language-plaintext highlighter-rouge">-base</code> template (sometimes you’ll see also a vm with that name, used to update the template) is a template you can use to build any server, it has only the base foreman hostgroup applied. The <code class="language-plaintext highlighter-rouge">-jenkins-slave</code> template has applied the jenkins-slave hostgroup.</p>

<p>Also keep in mind that puppet will be run again by the foreman finisher script when creating a new machine to make sure to apply the latest puppet manifests and configurations.</p>

<h2 id="tips-and-tricks">Tips and Tricks</h2>

<h3 id="strange-routingnetwork-issues">Strange routing/network issues</h3>

<p>For example, once saw that ping was unable to resolve any names, while dig/nslookup worked perfectly, that was caused by having wrong custom routing rules in a routing table aside from the main one, to see all the routing rules you can type:</p>

<blockquote>
  <p>ip route show table all</p>
</blockquote>

<p>Those were defined in the /etc/network-scripts/rules-ovirtmgmt file.</p>

<h3 id="vdsm-did-not-create-the-ovirtmgmt-libvirt-network">VDSM did not create the ovirtmgmt libvirt network</h3>

<p>In one of the hosts, after messing the network, vdsm did not automatically create the ovirtmgmt network in the libvirt setting, you can create it manually by:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~# echo &lt;&lt;EOC &gt; ovirtmgmt_net.xml
&lt;network&gt;
  &lt;name&gt;vdsm-ovirtmgmt&lt;/name&gt;
  &lt;forward mode='bridge'/&gt;
  &lt;bridge name='ovirtmgmt'/&gt;
  &lt;/network&gt;
EOC
~# virsh -c qemu:///system user: vdsm@ovirt pass: shibboleth
(virsh)# net-create ovirtmgmt_net.xml # this creates the network in non-persistent mode, to force persistent we can
                                      # just edit it and add a newline at the end
(virsh)# net-edit ovirtmgmt
(virsh)# net-autostart ovirtmgmt
</code></pre></div></div>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2780/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2780/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2780/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2780/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/infra/phoenix-lab-hosts.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/infra/phoenix-lab-hosts.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
