<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>NVDIMM devices | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="NVDIMM devices" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2779/develop/release-management/features/virt/nvdimm-device.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2779/develop/release-management/features/virt/nvdimm-device.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="NVDIMM devices" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"NVDIMM devices","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2779/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2779/develop/release-management/features/virt/nvdimm-device.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2779/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2779/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2779/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2779/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2779/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2779/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2779/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2779/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2779/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2779/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2779/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2779/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2779/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2779/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2779/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2779/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2779/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2779/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2779/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2779/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2779/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2779/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2779//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2779//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2779/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2779/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2779/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2779/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2779/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Milan Zamazal</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2779/documentation/'>Documentation is available here.</a></div>

<h1 id="nvdimm-devices">NVDIMM devices</h1>

<h2 id="summary">Summary</h2>

<p>This feature allows adding NVDIMM (non-volatile memory) devices to VMs.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Milan Zamazal</li>
  <li>Email: mzamazal@redhat.com</li>
</ul>

<h2 id="description">Description</h2>

<p>NVDIMM devices provide persistent RAM.  QEMU and libvirt allow to add an emulated NVDIMM device to a VM, backed by a real NVDIMM device on the host to ensure data persistence.</p>

<p>This feature allows assigning host NVDIMM devices to VMs.  A new NVDIMM category of host devices is added (although technically NVDIMM devices are treated as memory rather than host devices by libvirt).</p>

<p>The NVDIMM device in the guest is emulated so its mode, partitioning, etc. can be reconfigured in the guest independently of the host device settings.</p>

<p>Information about the emulation details can be found in
<a href="https://github.com/qemu/qemu/blob/master/docs/nvdimm.txt">QEMU NVDIMM documentation</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>NVDIMM hardware is needed to test this feature.  To a limited extent, QEMU emulated devices in VMs used as hosts can be used for testing during implementation.</p>

<h2 id="limitations">Limitations</h2>

<p>Memory snapshots are disabled when an NVDIMM device is present in a VM.  There is no way to make a snapshot of NVDIMM content and a memory snapshot cannot work correctly without having the corresponding NVDIMM data.</p>

<p>In oVirt, each NVDIMM device passed to a VM has an automatically assigned label area of a fixed size of 128 KB.  Having a label is required on POWER and 128 KB is the minimum label size allowed by QEMU.</p>

<p>The guest device size is not user configurable.  If the whole host NVDIMM device size should not be used, the device should be partitioned accordingly on the host and the corresponding partition should be used.</p>

<p>The guest device size may be a bit lower to be in compliance with libvirt and QEMU alignment and size adjustments.  Precise sizing is also needed in order to make memory hot plug work.</p>

<p>libvirt and QEMU perform their own size and label placement adjustments.  If those internal arrangements ever get changed, data loss may be experienced.</p>

<p>NVDIMM hot plug is not supported by the platform.</p>

<p>VMs with NVDIMM devices must be pinned to a host and cannot be migrated.</p>

<p>SELinux currently prevents access to NVDIMM devices in devdax mode, see <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1855336">https://bugzilla.redhat.com/show_bug.cgi?id=1855336</a>.</p>

<p>NVDIMM on POWER is currently not expected to be stable, until platform fixes are completed.</p>

<p>Data persistence cannot be guaranteed in case of a host crash unless devdax mode is used for the host device, see <a href="https://github.com/qemu/qemu/blob/master/docs/nvdimm.txt">QEMU documentation</a> for more details.</p>

<h2 id="user-experience">User Experience</h2>

<p>An NVDIMM device is added or removed to or from the VM the same way as a host device.  There is a special NVDIMM category of host devices containing NVDIMM devices available on the host.</p>

<p><img src="/ovirt-site/previews/2779/images/wiki/nvdimm-host-device.png" alt="" /></p>

<h2 id="testing">Testing</h2>

<p>A host with one or more NVDIMM devices is needed.  Testing should cover:</p>

<ul>
  <li>Checking with the NVDIMM device on the host in all the possible NVDIMM modes.</li>
  <li>Checking with different NVDIMM sizes (should be achievable by partitioning).</li>
</ul>

<p>The following should be checked:</p>

<ul>
  <li>NVDIMM devices are visible in host devices in the Web UI.</li>
  <li>They can be added to the VM.</li>
  <li>The VM can be started and the NVDIMM device is present there (its mode is independent of the host device mode and can be changed in the guest OS).</li>
  <li>The NVDIMM device can be partitioned etc. in the guest OS.</li>
  <li>Data written to the NVDIMM device is still available after VM restart (assuming configuration of the device on the host hasn’t been changed in the meantime).</li>
</ul>

<p>Other tests common to host devices can be applied.  NVDIMM devices aren’t technically host devices but they are handled as such by oVirt.</p>

<h2 id="implementation-considerations">Implementation considerations</h2>

<p>Vdsm must report NVDIMM devices present on the host and their attributes (path, mode, size, alignment, …).  Vdsm uses ndctl tool for that purpose and is dependent on the content of its JSON output.  Contingent changes to the ndctl output could break the functionality in future.</p>

<p>NVDIMM size computation on the Engine side is dependent on libvirt and QEMU internal size adjustments in order to ensure that:</p>

<ul>
  <li>It can fit into the size of the backing device (which is a bit more complicated than just using size &lt;= size of the backing device).</li>
  <li>It is properly aligned in the end result (to the architecture minimum DIMM size) to make regular memory hot plug work in the guest OS.</li>
</ul>

<p>If the libvirt or QEMU internal adjustments ever change, it can break, misplace the label or trim data, possibly resulting in data loss.  There is currently no way to deal with that problem.  Options such as implementing automated tests to detect contingent changes or improving the QEMU and libvirt implementations are being discussed.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2779/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2779/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2779/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2779/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/nvdimm-device.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/nvdimm-device.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
