<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>oVirt Metrics Store - Setting Up ViaQ Logging | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="oVirt Metrics Store - Setting Up ViaQ Logging" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3083/develop/release-management/features/metrics/setting-up-viaq-logging.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3083/develop/release-management/features/metrics/setting-up-viaq-logging.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt Metrics Store - Setting Up ViaQ Logging" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"oVirt Metrics Store - Setting Up ViaQ Logging","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3083/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3083/develop/release-management/features/metrics/setting-up-viaq-logging.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3083/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3083/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3083/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3083/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3083/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3083/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3083/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3083/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3083/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3083/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3083/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3083/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3083/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3083/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3083/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3083/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3083/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3083/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3083/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3083/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3083/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3083/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3083//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3083//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3083/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3083/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3083/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3083/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3083/develop/release-management/features/metrics/">
              <span property="name">Metrics</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/7994226372822da5ac75322d097186c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/7994226372822da5ac75322d097186c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Shirly Radco">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Shirly Radco</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3083/documentation/'>Documentation is available here.</a></div>

<div class="alert alert-warning">
  <p><strong>ATTENTION: This page is no longer up to date. Please follow the link for the updated documentation:</strong>
  <br /></p>
  <ul>
    <li><a href="/ovirt-site/previews/3083/documentation/administration_guide/#monitoring_and_observability">Monitoring and observability</a></li>
  </ul>
</div>

<h1 id="setting-up-ovirt-metrics-store">Setting Up oVirt metrics store</h1>

<h2 id="intro">Intro</h2>

<p>The oVirt metrics store is based on the <a href="https://github.com/openshift/origin-aggregated-logging">OpenShift
Logging</a> stack.
You can use either the OpenShift Container Platform (OCP) based on RHEL7, or
OpenShift Origin (Origin) based on CentOS7.  Ansible is used to install logging
using the <a href="https://github.com/openshift/openshift-ansible">OpenShift Ansible</a>
logging <a href="https://github.com/openshift/openshift-ansible/blob/release-3.11/roles/openshift_logging/README.md">roles</a>.</p>

<p>Ansible is used to install oVirt metrics store using OpenShift Ansible.
The following packages are required:</p>

<h3 id="customizing-varsyaml">Customizing vars.yaml</h3>

<p>In the first playbook you run
<a href="/ovirt-site/previews/3083/develop/release-management/features/metrics/metrics-store-installation.html#run-ovirt-metrics-store-installation-playbook">Run ovirt-metrics-store-installation playbook</a>,
a few files are generated and copied to the metrics store virtual machine.</p>

<h2 id="running-ansible">Running Ansible</h2>

<p>Log into the admin portal and review the metrics store installer virtual machine creation.</p>

<p>Log into the metrics store installer virtual machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # ssh root@&lt;metrics-store-installer ip or fqdn&gt;
</code></pre></div></div>

<p>Run the ansible plabook that creates the OpenShift vms and deploys OpenShift</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # ANSIBLE_ROLES_PATH="/usr/share/ansible/roles/:/usr/share/ansible/openshift-ansible/roles" \
    ANSIBLE_JINJA2_EXTENSIONS="jinja2.ext.do" \
    ansible-playbook -i integ.ini install_okd.yaml -e @vars.yaml
</code></pre></div></div>

<ol>
  <li>Check <code class="language-plaintext highlighter-rouge">/tmp/ansible.log</code> if there are any errors during the run.  If this
hangs, just kill it and run it again - Ansible is (mostly) idempotent.  Same
applies if there are any errors during the run - fix the machine and/or the
<code class="language-plaintext highlighter-rouge">vars.yaml</code> and run it again.</li>
</ol>

<h2 id="enabling-elasticsearch-to-mount-the-directory">Enabling Elasticsearch to Mount the Directory</h2>
<p>The installation of Elasticsearch will fail because there is currently no way to grant
the Elasticsearch service account permission to mount that directory.
After installation is complete, do the following steps to enable Elasticsearch to mount the directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # oc project logging
    # oc adm policy add-scc-to-user hostmount-anyuid \
      system:serviceaccount:logging:aggregated-logging-elasticsearch

    # oc rollout cancel $( oc get -n logging dc -l component=es -o name )
    # oc rollout latest $( oc get -n logging dc -l component=es -o name )
    # oc rollout status -w $( oc get -n logging dc -l component=es -o name )
</code></pre></div></div>

<h2 id="enabling-kopf">Enabling Kopf</h2>
<p>kopf is a simple web administration tool for elasticsearch.</p>

<p>It offers an easy way of performing common tasks on an elasticsearch cluster.
Not every single API is covered by this plugin, but it does offer a REST client
which allows you to explore the full potential of the ElasticSearch API.</p>

<p>See:</p>

<p>https://github.com/openshift/origin-aggregated-logging/tree/master/hack/kopf</p>

<h3 id="post-install-checking">Post-Install Checking</h3>

<ol>
  <li>
    <p>To confirm that Elasticsearch, Curator, Kibana, and Fluentd pods are running, run:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc project logging
# oc get pods
</code></pre></div>    </div>
  </li>
  <li>
    <p>To confirm that the Elasticsearch and Kibana services are running, run:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc project logging
# oc get svc
</code></pre></div>    </div>
  </li>
  <li>
    <p>To confirm that there are routes for Elasticsearch and Kibana, run:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc project logging
# oc get routes
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="test-elasticsearch">Test Elasticsearch</h3>

<p>To search Elasticsearch, first get the name of the Elasticsearch pod, then use oc exec to query Elasticsearch.
The example search below will look for all log records in project.logging and will sort them by @timestamp
(which is the timestamp when the record was created at the source) in descending order (that is, latest first):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # oc project logging
    # espod=`oc get pods -l component=es -o jsonpath='{.items[0].metadata.name}'`
    # oc exec -c elasticsearch $espod -- curl --connect-timeout 1 -s -k \
      --cert /etc/elasticsearch/secret/admin-cert \
      --key /etc/elasticsearch/secret/admin-key \
      'https://localhost:9200/project.logging.*/_search?sort=@timestamp:desc' | \
      python -mjson.tool | more


    {
    "_shards": {
        "failed": 0,
        "successful": 1,
        "total": 1
    },
    "hits": {
        "hits": [
            {
                "_id": "AVi70uBa6F1hLfsBbCQq",
                "_index": "project.logging.42eab680-b7f9-11e6-a793-fa163e8a98f9.2016.12.01",
                "_score": 1.0,
                "_source": {
                    "@timestamp": "2016-12-01T14:09:53.848788-05:00",
                    "docker": {
                        "container_id": "adcf8981baf37f3dab0a659fbd78d6084fde0a2798020d3c567961a993713405"
                    },
                    "hostname": "host-192-168-78-2.openstacklocal",
                    "kubernetes": {
                        "container_name": "deployer",
                        "host": "host-192-168-78-2.openstacklocal",
                        "labels": {
                            "app": "logging-deployer-template",
                            "logging-infra": "deployer",
                            "provider": "openshift"
                        },
                        "namespace_id": "42eab680-b7f9-11e6-a793-fa163e8a98f9",
                        "namespace_name": "logging",
                        "pod_id": "b2806c29-b7f9-11e6-a793-fa163e8a98f9",
                        "pod_name": "logging-deployer-akqwb"
                    },
                    "level": "3",
                    "message": "writing new private key to '/etc/deploy/scratch/system.logging.fluentd.key'",
                    "pipeline_metadata": {
                        "collector": {
                            "inputname": "fluent-plugin-systemd",
                            "ipaddr4": "10.128.0.26",
                            "ipaddr6": "fe80::30e3:7cff:fe55:4134",
                            "name": "fluentd openshift",
                            "received_at": "2016-12-01T14:09:53.848788-05:00",
                            "version": "0.12.29 1.4.0"
                        }
                    }
                },
                "_type": "com.redhat.viaq.common"
            }
        ],
        "max_score": 1.0,
        "total": 1453
    },
    "timed_out": false,
    "took": 15
    }
</code></pre></div></div>

<h2 id="creating-the-admin-user">Creating the Admin User</h2>

<p>During the metrics store installation an admin user is created.
The admin user has permissions to access Kibana and view the oVirt metrics and log data and dashboards.</p>

<p>By default, the password for the user “admin” is “admin”.
This can be uodate in the config.yml file, buy updating the “ovirt_metrics_admin_password”.</p>

<p>To create additional admin users, Run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc project logging
# oc create user $username
# oc create identity allow_all:$username
# oc create useridentitymapping allow_all:$username $username
# oc adm policy add-cluster-role-to-user cluster-admin $username
</code></pre></div></div>

<p>This will create the user account.  The password is set at the
first login.  To set the password now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc login --username=$username --password=$userpassword
</code></pre></div></div>

<h2 id="creating-a-normal-user">Creating a “Normal” User</h2>
<p>To create an “normal” user that can only view logs in a particular set of
projects, follow the steps above, except do not assign the <code class="language-plaintext highlighter-rouge">cluster-admin</code>
role, use the following instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc project $namespace
# oc adm policy add-role-to-user view $username
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">$username</code> is the name of the user you created instead of <code class="language-plaintext highlighter-rouge">admin</code>,
and <code class="language-plaintext highlighter-rouge">$namespace</code> is the name of the project or namespace you wish to allow
the user to have access to the logs of.</p>

<p>For example, to create a user
named <code class="language-plaintext highlighter-rouge">loguser</code> that can view logs in <code class="language-plaintext highlighter-rouge">ovirt-metrics-engine</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc create user loguser
# oc create identity allow_all:loguser
# oc create useridentitymapping allow_all:loguser loguser
# oc project ovirt-metrics-engine
# oc adm policy add-role-to-user view loguser
</code></pre></div></div>

<p>and to assign the password immediately instead of waiting for the user
to login:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># oc login --username=loguser --password=loguser
# oc login --username=system:admin
</code></pre></div></div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3083/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3083/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3083/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3083/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/metrics/setting-up-viaq-logging.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/metrics/setting-up-viaq-logging.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
