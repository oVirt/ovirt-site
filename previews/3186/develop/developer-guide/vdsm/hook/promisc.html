<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>promisc | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="promisc" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/hook/promisc.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/hook/promisc.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="promisc" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"promisc","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3186/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/hook/promisc.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3186/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3186/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3186/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3186/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3186/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3186/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3186/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3186/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3186/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/developer-guide/vdsm/">
              <span property="name">Vdsm</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/developer-guide/vdsm/hook/">
              <span property="name">Hook</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/96683d5c86aced90f8fbb458c5d11a6b?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/96683d5c86aced90f8fbb458c5d11a6b?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Dan Yasny">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Yasny</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="promisc">promisc</h1>

<p>The promisc vdsm hook provides the ability to mirror/redirect other VMs network traffic to a single VM.</p>

<p>The hook is getting network (bridge) name and mode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  promisc=blue:mirror,red:redirect 
</code></pre></div></div>

<p>and sets the current running VM in promiscuous mode, ie: mirror all blue traffic to current VM</p>

<p>syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  promisc=blue:mirror
</code></pre></div></div>

<p>mirror monitoring the network blue (all traffic will goto the VMs interface and the network)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  promisc=vnet0:redirect
</code></pre></div></div>

<p>redirect vm traffic to vnet0 interface (all traffic will go to the VM’s interface, and it’s the VM responsibility to redirect the traffic back to the VM)</p>

<h2 id="redirect-mode">redirect mode:</h2>

<p>In redirect mode with tc we filter the vm interface, NOTE: currently the redirect is redirecting vm interface and not the bridge like the mirror mode does, if you use the bridge interface in redirect mode you can lose the network connection to the server!</p>

<p>vnet0 = security vm, running IPS/IDS vnet1 = the vm which we want to monitor its traffic</p>

<p>add filter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ ifconfig blue promisc
  $ tc qdisc add dev vnet1 ingress
  $ tc filter add dev vnet1 parent ffff: protocol ip u32 match u8 0 0 action mirred egress redirect dev vnet0
  $ tc qdisc replace dev vnet1 parent root prio
  ` $ id=`tc qdisc show dev vnet1 | grep prio | awk '{print $3}'` `
  $ tc filter add dev vnet1 parent $id protocol ip u32 match u8 0 0 action mirred egress redirect dev vnet0
</code></pre></div></div>

<p>remove filter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ tc qdisc del dev vnet1 root
  $ tc qdisc del dev vnet1 ingress
  $ ifconfig blue -promisc
</code></pre></div></div>

<h2 id="in-line-redirect-mode-with-ebtables-sample">in-line (redirect) mode with ebtables sample:</h2>

<ul>
  <li>use redirect instead of mirror for in-line mode (ie don’t copy the packets forward it to ifaceName and he will redirect them)</li>
  <li>redirect (not mirror) with ebtables:</li>
</ul>

<p>need to change the mac address of the packets from monitored interface to the monitoring interface. (the IP stays the same, so this way you know that the packets are not meant for the monitoring machine).</p>

<p>set the bridge in promisc mode</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ ifconfig `&lt;netwok name&gt;` promisc
</code></pre></div></div>

<p>traffic to the monitoring machine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ ebtables -t nat -A PREROUTING -d 00:1a:4a:16:01:51 -i eth0 -j dnat --to-destination 00:1a:4a:16:01:11
</code></pre></div></div>

<p>traffic from the monitoring machine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ ebtables -t nat -A PREROUTING -s 00:1a:4a:16:01:51 -i vnet0 -j dnat --to-destination 00:1a:4a:16:01:11
</code></pre></div></div>





        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3186/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3186/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3186/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3186/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/vdsm/hook/promisc.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/vdsm/hook/promisc.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
