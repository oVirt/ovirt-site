<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>CD-ROM support for block storage | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="CD-ROM support for block storage" />
<meta name="author" content="Vojtěch Juránek" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/storage/cd-block-storage.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/storage/cd-block-storage.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CD-ROM support for block storage" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Vojtěch Juránek" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Vojtěch Juránek"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"CD-ROM support for block storage","url":"https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/storage/cd-block-storage.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2740/images/logo.svg"},"name":"Vojtěch Juránek"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2740/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2740/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2740/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2740/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2740/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2740/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2740/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2740/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2740/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2740/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2740/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2740/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2740/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2740/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2740/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2740/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2740/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2740/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2740/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2740/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2740/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2740/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/1e22e63a68883ad2de90dd541b6e2b32?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/1e22e63a68883ad2de90dd541b6e2b32?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Vojtěch Juránek</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/25f5a61a5a1e1290bc14e350ce6d8977?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/25f5a61a5a1e1290bc14e350ce6d8977?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Nir Soffer</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2740/documentation/'>Documentation is available here.</a></div>

<h1 id="cd-rom-support-for-block-storage">CD-ROM support for block storage</h1>

<h2 id="summary">Summary</h2>

<p>This feature adds new implementation for CD-ROM management on block storage domains,
namely for loading, ejecting and changing CD-ROM.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Vojtech Juranek (<a href="mailto:vjuranek@redhat.com">vjuranek@redhat.com</a>)</li>
</ul>

<h2 id="overview">Overview</h2>

<h3 id="what-was-available-before-this-feature">What was available before this feature?</h3>

<p>Before this feature, oVirt engine provided functions for changing and ejecting CD-ROM.
However, non of these functions worked properly with block based storage.
Changing CD failed on block storage as the appropriate volume wasn’t activated.
Ejecting CD failed to deactivate the volume.
For more details, see following bugs.</p>

<h4 id="cd-rom-related-xml">CD-ROM related XML</h4>

<p>Currently each VM contains CD-ROM (without CD), e.g.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">device=</span><span class="s">'cdrom'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">error_policy=</span><span class="s">'report'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">startupPolicy=</span><span class="s">'optional'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'sdc'</span> <span class="na">bus=</span><span class="s">'sata'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;readonly/&gt;</span>
      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'ua-79287c04-4eea-4db7-a376-99a9f85ad0ed'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'drive'</span> <span class="na">controller=</span><span class="s">'0'</span> <span class="na">bus=</span><span class="s">'0'</span> <span class="na">target=</span><span class="s">'0'</span> <span class="na">unit=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
</code></pre></div></div>

<p>When VM is booted with CD, it chages e.g. to</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'block'</span> <span class="na">device=</span><span class="s">'cdrom'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span> <span class="na">error_policy=</span><span class="s">'report'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">'/rhev/data-center/mnt/blockSD/88252cf6-381e-48f0-8795-a294a32c7149/images/89f05c7d-b961-4935-993f-514499024515/626a493f-5214-4337-b580-96a1ce702c2a'</span> <span class="na">index=</span><span class="s">'2'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;seclabel</span> <span class="na">model=</span><span class="s">'dac'</span> <span class="na">relabel=</span><span class="s">'no'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/source&gt;</span>
      <span class="nt">&lt;backingStore/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'sdc'</span> <span class="na">bus=</span><span class="s">'sata'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;readonly/&gt;</span>
      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'ua-79287c04-4eea-4db7-a376-99a9f85ad0ed'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'drive'</span> <span class="na">controller=</span><span class="s">'0'</span> <span class="na">bus=</span><span class="s">'0'</span> <span class="na">target=</span><span class="s">'0'</span> <span class="na">unit=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
</code></pre></div></div>

<p>so that it contains path to the ISO.</p>

<p>Besides this libvirt XML, oVirt adds its own XML for each disk to be able to identify
the volume by PDIV (pool, domain, image volume) coordinates and includes other useful info like lease path. e.g.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ovirt-vm:domainID&gt;</span>88252cf6-381e-48f0-8795-a294a32c7149<span class="nt">&lt;/ovirt-vm:domainID&gt;</span>
        <span class="nt">&lt;ovirt-vm:imageID&gt;</span>89f05c7d-b961-4935-993f-514499024515<span class="nt">&lt;/ovirt-vm:imageID&gt;</span>
        <span class="nt">&lt;ovirt-vm:poolID&gt;</span>13345997-b94f-42dd-b8ef-a1392f65cebf<span class="nt">&lt;/ovirt-vm:poolID&gt;</span>
        <span class="nt">&lt;ovirt-vm:volumeID&gt;</span>626a493f-5214-4337-b580-96a1ce702c2a<span class="nt">&lt;/ovirt-vm:volumeID&gt;</span>
        <span class="nt">&lt;ovirt-vm:volumeChain&gt;</span>
            <span class="nt">&lt;ovirt-vm:volumeChainNode&gt;</span>
                <span class="nt">&lt;ovirt-vm:domainID&gt;</span>88252cf6-381e-48f0-8795-a294a32c7149<span class="nt">&lt;/ovirt-vm:domainID&gt;</span>
                <span class="nt">&lt;ovirt-vm:imageID&gt;</span>89f05c7d-b961-4935-993f-514499024515<span class="nt">&lt;/ovirt-vm:imageID&gt;</span>
                <span class="nt">&lt;ovirt-vm:leaseOffset</span> <span class="na">type=</span><span class="s">"int"</span><span class="nt">&gt;</span>105906176<span class="nt">&lt;/ovirt-vm:leaseOffset&gt;</span>
                <span class="nt">&lt;ovirt-vm:leasePath&gt;</span>/dev/88252cf6-381e-48f0-8795-a294a32c7149/leases<span class="nt">&lt;/ovirt-vm:leasePath&gt;</span>
                <span class="nt">&lt;ovirt-vm:path&gt;</span>/rhev/data-center/mnt/blockSD/88252cf6-381e-48f0-8795-a294a32c7149/images/89f05c7d-b961-4935-993f-514499024515/626a493f-5214-4337-b580-96a1ce702c2a<span class="nt">&lt;/ovirt-vm:path&gt;</span>
                <span class="nt">&lt;ovirt-vm:volumeID&gt;</span>626a493f-5214-4337-b580-96a1ce702c2a<span class="nt">&lt;/ovirt-vm:volumeID&gt;</span>
            <span class="nt">&lt;/ovirt-vm:volumeChainNode&gt;</span>
        <span class="nt">&lt;/ovirt-vm:volumeChain&gt;</span>
    <span class="nt">&lt;/ovirt-vm:device&gt;</span>
</code></pre></div></div>

<p>When CD is not loaded, this element is still present (as CD-ROM is always present), but is empty, e.g.:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<h3 id="bugs">Bugs</h3>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1589763">Bug 1589763: Error changing CD for a running VM when ISO image is on a block domain</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1868643">Bug 1868643: Volume not deactivated after ejecting CDROM</a></li>
</ul>

<h3 id="functionality-added-with-this-feature">Functionality added with this feature</h3>

<p>This feature reworks existing vdsm API for loading, ejecting and
changing CD to be able to work on block storage domains.
From implementation point of view it is only one function,<code class="language-plaintext highlighter-rouge">ChangeCD</code>.
This function will handle all aforementioned cases - loading CD, ejecting CD and changing CD.
It will also ensure, that the CD will be changed atomically.
This means that the change either happens or previous state will be preserved,
e.g. if user wants to change CD by another and activation of new CD fails, CDROM will still hold
old CD once the operation finishes.</p>

<h4 id="vdsm">Vdsm</h4>

<ul>
  <li>Rework <code class="language-plaintext highlighter-rouge">VM.changeCD</code> API implementation.</li>
  <li>Updated recovery flow to check <code class="language-plaintext highlighter-rouge">status</code> flag for CDs.</li>
  <li>If ISO is not specified by PDIV but by path, fall back to old behaviour.</li>
</ul>

<h3 id="flows">Flows</h3>

<h4 id="vm-with-empty-tray-insert-cd">VM with empty tray, insert CD</h4>

<ol>
  <li>engine sends <code class="language-plaintext highlighter-rouge">changeCD</code> command, specifying ISO by PDIV format.</li>
  <li>add new drive spec to VM metadata with new attribute <code class="language-plaintext highlighter-rouge">state="loading"</code>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span> <span class="na">state=</span><span class="s">"loading"</span><span class="nt">&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>prepare new drive spec
    <ul>
      <li>if failed:</li>
    </ul>
    <ol>
      <li>remove drive spec (log errors)</li>
      <li>fail the flow with original error</li>
    </ol>
  </li>
  <li>loads CD into VM
    <ul>
      <li>if failed:</li>
    </ul>
    <ol>
      <li>tear down the volume (log error)</li>
      <li>remove the drive spec (log error)</li>
      <li>fail the flow with the original error</li>
    </ol>
  </li>
  <li>remove <code class="language-plaintext highlighter-rouge">state</code> attribute from VM metadata
    <ul>
      <li>if failed: log the error and succeed</li>
    </ul>
  </li>
</ol>

<h4 id="vm-with-loaded-cd-eject-cd">VM with loaded CD, eject CD</h4>

<ol>
  <li>engine sends <code class="language-plaintext highlighter-rouge">changeCD</code> command with empty PDIV format.</li>
  <li>vdsm updates VM metadata with new attribute <code class="language-plaintext highlighter-rouge">state="ejecting"</code>:
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span> <span class="na">state=</span><span class="s">"ejecting"</span><span class="nt">&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>vdsm ejects CD from VM (calling libvirt <code class="language-plaintext highlighter-rouge">updateDeviceFlags()</code>)
    <ul>
      <li>if failed (e.g. timeout?):</li>
    </ul>
    <ol>
      <li>remove the <code class="language-plaintext highlighter-rouge">state</code> attribute (log error)</li>
      <li>fail with original error</li>
    </ol>
  </li>
  <li>tear down drive spec
    <ul>
      <li>if tearing down volume fails: log error if volume used by another VM and succeed</li>
      <li>if error is anything else except device in use error, remove <code class="language-plaintext highlighter-rouge">state</code> attribute from metadata, re-throw the exception and fail</li>
    </ul>
  </li>
  <li>remove drive spec from VM metadata
    <ul>
      <li>if failed: log error and succeed</li>
    </ul>
  </li>
</ol>

<h4 id="vm-with-loaded-cd-changecd">VM with loaded CD, changeCD</h4>

<ol>
  <li>engine sends <code class="language-plaintext highlighter-rouge">changeCD</code>, specifying new ISO path by PDIV format and also path.</li>
  <li>update exiting drive spec for loaded CD with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>:
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span> <span class="na">state=</span><span class="s">"ejecting"</span><span class="nt">&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>add another drive spec to VM metadata for CD being loaded with attribute <code class="language-plaintext highlighter-rouge">state="loading"</code>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;ovirt-vm:device</span> <span class="na">devtype=</span><span class="s">"disk"</span> <span class="na">name=</span><span class="s">"sdc"</span> <span class="na">state=</span><span class="s">"loading"</span><span class="nt">&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>prepare new drive spec
    <ul>
      <li>if failed:</li>
    </ul>
    <ol>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from loaded CD metadata</li>
      <li>remove newly added drive spec (log errors)</li>
      <li>fail the flow with original error</li>
    </ol>
  </li>
  <li>loads new CD into VM (by calling libvirt <code class="language-plaintext highlighter-rouge">updateDeviceFlags()</code>)
    <ul>
      <li>if failed:</li>
    </ul>
    <ol>
      <li>tear down new CD volume (log error)</li>
      <li>remove the new CD drive spec (log error)</li>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from old drive spec metadata</li>
      <li>fail the flow with the original error</li>
    </ol>
  </li>
  <li>remove the <code class="language-plaintext highlighter-rouge">state="loading"</code> attribute from new drive spec metadata
    <ul>
      <li>if failed: log the error and continue</li>
    </ul>
  </li>
  <li>tear down old drive spec
    <ul>
      <li>if failed (e.g. timeout?):</li>
    </ul>
    <ol>
      <li>log the error and continue (tearing down new CD would probably fail
   as well and we would end up with unused activated volume anyway, so
   there’s no reason to fail it now)</li>
    </ol>
  </li>
  <li>remove old CD drive spec
    <ul>
      <li>if failed: log the error and succeed</li>
    </ul>
  </li>
</ol>

<h4 id="vm-recovery-flow">VM recovery flow</h4>

<p>Try to cleanup storage leftovers from loading and ejecting operations without changing VM state.</p>

<h5 id="vm-with-empty-tray-insert-cd-1">VM with empty tray, insert CD</h5>

<ol>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="loading"</code>, there are no other matadata for CDROM, volume is prepared, CD is loaded
    <ul>
      <li>remove <code class="language-plaintext highlighter-rouge">state="loading"</code> from metadata from XML</li>
    </ul>
  </li>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="loading"</code>, there are no other matadata for CDROM, volume is prepared, CD isn’t loaded
    <ul>
      <li>tear down the volume and remove drive spec from XML</li>
    </ul>
  </li>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="loading"</code>, there are no other matadata for CDROM, volume is torn down, CD isn’t loaded
    <ul>
      <li>remove drive spec metadata</li>
    </ul>
  </li>
</ol>

<h5 id="vm-with-loaded-cd-eject-cd-1">VM with loaded CD, eject CD</h5>

<ol>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, there are no other matadata for CDROM, volume is prepared, CD is loaded
    <ul>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from metadata from XML</li>
    </ul>
  </li>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, there are no other matadata for CDROM, volume is prepared, CD not loaded
    <ul>
      <li>tear down the volume and remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from metadata from XML</li>
    </ul>
  </li>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, there are no other matadata for CDROM, volume is torn down, CD not loaded
    <ul>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from metadata from XML</li>
    </ul>
  </li>
</ol>

<h5 id="vm-with-loaded-cd-changecd-1">VM with loaded CD, changeCD</h5>

<ol>
  <li>metadata <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, there are no other matadata for CDROM
    <ul>
      <li>see previous paragraph</li>
    </ul>
  </li>
  <li>there are two metadata for CDROM, one with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, second with <code class="language-plaintext highlighter-rouge">state="loading"</code>, volume for loading is torn down
    <ul>
      <li>remove metadata for loading from VM XML</li>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from ejecting metadata</li>
    </ul>
  </li>
  <li>there are two metadata for CDROM, one with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, second with <code class="language-plaintext highlighter-rouge">state="loading"</code>, volume for loading is prepared, CDROM still contains ejecting CD
    <ul>
      <li>tear down loading CD volume</li>
      <li>remove metadata for loading CD</li>
      <li>remove <code class="language-plaintext highlighter-rouge">state="ejecting"</code> from metadata</li>
    </ul>
  </li>
  <li>there are two metadata for CDROM, one with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, second with <code class="language-plaintext highlighter-rouge">state="loading"</code>, volume for loading is prepared, CDROM still contains loading CD
    <ul>
      <li>tear down ejecting CD volume</li>
      <li>remove metadata for ejecting CD</li>
      <li>remove <code class="language-plaintext highlighter-rouge">state="loading"</code> from metadata</li>
    </ul>
  </li>
  <li>there are two metadata for CDROM, one with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, second without <code class="language-plaintext highlighter-rouge">state</code> attribute, volume for ejected CD is prepared
    <ul>
      <li>tear down ejecting CD volume</li>
      <li>remove metadata for ejecting CD</li>
    </ul>
  </li>
  <li>there are two metadata for CDROM, one with <code class="language-plaintext highlighter-rouge">state="ejecting"</code>, second without <code class="language-plaintext highlighter-rouge">state</code> attribute, volume for ejected CD is torn down
    <ul>
      <li>remove metadata for ejecting CD</li>
    </ul>
  </li>
</ol>

<p><code class="language-plaintext highlighter-rouge">state</code> attribute is an optimization for easy cleanup.
E.g. in case of hot disk plug, this is not used and if vdsm fails between activation of the volume
and pluging disk into VM, unused active disk is left in the storage.</p>

<h3 id="changes-in-engine">Changes in Engine</h3>

<p>Engine will only use PDIV in ChangeCD command and there will be no changes visible to the user.</p>

<ul>
  <li>Update ChangeCD to use PDIV for CD specification on 4.5 cluster version</li>
</ul>

<h3 id="changes-in-sdk">Changes in SDK</h3>

<p><code class="language-plaintext highlighter-rouge">VmCdromResource</code> used SDK uses <code class="language-plaintext highlighter-rouge">ChangeDisk</code> command.
Once internal engine implementation will switch to using PDIV, this will be available also in SDK.
Therefore, similarly to engine, there will be no changes in public SDK API visible to user.</p>

<h2 id="installationupgrade">Installation/Upgrade</h2>

<p>Changed implementation of <code class="language-plaintext highlighter-rouge">ChangeCD</code> we delivered with new vdsm packages containing these changes.
Changes in engine will require appropriate vdsm version to use new vdsm APIs.
Once user upgrades to this engine version, changes will be available to the user.</p>

<p>New <code class="language-plaintext highlighter-rouge">ChangeCD</code> implementation will be used for ISOs on DATA domains.
Old  <code class="language-plaintext highlighter-rouge">ChangeCD</code> implementation will be used for ISOs on old ISO domains.</p>

<h2 id="testing">Testing</h2>

<h3 id="test-setup">Test setup</h3>

<ul>
  <li>create block storage domain</li>
  <li>upload an ISO into block storage domain</li>
  <li>create VM with CD</li>
</ul>

<h3 id="preposed-testing-scenarios">Preposed testing scenarios</h3>

<ul>
  <li>eject CD from CD-ROM
    <ul>
      <li>verify CD was removed in engine UI</li>
      <li>verify that metadata related to this CD-ROM was removed from VM XML</li>
      <li>verify ISO volume was deactivated on the host</li>
    </ul>
  </li>
  <li>load CD into CD-ROM
    <ul>
      <li>verify CD was loaded in engine UI</li>
      <li>verify that metadata related to this CD-ROM was added into VM XML</li>
      <li>verify ISO volume was activated on the host</li>
      <li>verify ISO is not visible to VM (e.g by running <code class="language-plaintext highlighter-rouge">virsh domblklist</code>)</li>
    </ul>
  </li>
  <li>eject CD from CD-ROM
    <ul>
      <li>verify CD was removed in engine UI</li>
      <li>verify that metadata related to this CD-ROM was removed from VM XML</li>
      <li>verify ISO volume was deactivated on the host</li>
      <li>verify ISO is visible to VM (e.g by running <code class="language-plaintext highlighter-rouge">virsh domblklist</code>)</li>
    </ul>
  </li>
  <li>change CD in CD-ROM
    <ul>
      <li>verify new CD was loaded in engine UI</li>
      <li>verify that metadata related to old CD-ROM was removed from VM XML</li>
      <li>verify that metadata related to new CD-ROM was added into VM XML</li>
      <li>verify old ISO volume was deactivated on the host</li>
      <li>verify new ISO volume was activated on the host</li>
      <li>verify old ISO is not visible to VM (e.g by running <code class="language-plaintext highlighter-rouge">virsh domblklist</code>)</li>
      <li>verify ISO is visible to VM (e.g by running <code class="language-plaintext highlighter-rouge">virsh domblklist</code>)</li>
    </ul>
  </li>
</ul>

<h3 id="related-links">Related links</h3>

<ul>
  <li><a href="https://www.mail-archive.com/devel@ovirt.org/msg16082.html">Discussion in ovirt devel mailing list.</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1725915">Bug 1725915: Vdsm tries to tear down in-use volume of ISO in block storage domain</a></li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2740/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2740/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2740/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2740/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/cd-block-storage.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/storage/cd-block-storage.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
