<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DiscardAfterDelete | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="DiscardAfterDelete" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3125/develop/release-management/features/storage/discard-after-delete.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3125/develop/release-management/features/storage/discard-after-delete.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DiscardAfterDelete" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"DiscardAfterDelete","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3125/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3125/develop/release-management/features/storage/discard-after-delete.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3125/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3125/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3125/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3125/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3125/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3125/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3125/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3125/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3125/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3125/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3125/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3125/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3125/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3125/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3125/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3125/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3125/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3125/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3125/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3125/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3125/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3125/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3125//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3125//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3125/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3125/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3125/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3125/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3125/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Idan Shaby">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Idan Shaby</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3125/documentation/'>Documentation is available here.</a></div>

<h1 id="discard-after-delete">Discard after delete</h1>

<h2 id="summary">Summary</h2>

<h3 id="how-thinly-provisioned-luns-were-used-so-far">How thinly provisioned luns were used so far</h3>
<p>Generally, the underlying storage can provide two types of luns - <em>pre allocated</em> and <em>thinly provisioned</em>.</p>

<ul>
  <li>When a <em>pre allocated</em> lun is created with a size of <em>x</em> Gigabytes, the storage array allocates those <em>x</em> Gigabytes for that lun, so that other luns are not able to use those blocks.<br /></li>
  <li>When a <em>thinly provisioned</em> lun is created with a size of <em>x</em> Gigabytes, the storage array may allocate less than <em>x</em> Gigabytes for that lun, and each time it reaches a certain limit of used space, it is extended by the array until it reaches it’s virtual size and cannot be extended anymore.</li>
</ul>

<h3 id="what-could-be-improved">What could be improved</h3>
<p>Suppose that a VM contains a disk <em>disk1</em> on a block storage domain <em>sd1</em>, and that <em>disk1</em> is removed. Also suppose that <em>sd1</em> is built on a 20GB lun, <em>lun1</em>.</p>

<ul>
  <li>If <em>lun1</em> is a <em>pre allocated</em> lun, then there’s no reason to go and try to tell the storage array that some blocks were freed because <em>lun1</em> uses the whole 20GB anyway.</li>
  <li>If <em>lun1</em> is a <em>thinly provisioned</em> lun, and we could tell the storage array that some blocks were freed, it could have shrinked <em>lun1</em> so that other luns in the array could make use of those unused blocks.</li>
</ul>

<p>This feature is about freeing (discarding) the whole disk space right before removing it.</p>

<h3 id="for-whom-is-this-feature-useful">For whom is this feature useful</h3>
<p>This feature is useful for users that have thinly provisioned luns and wish to reclaim space when removing a disk from a block storage domain that is built from them.</p>

<h2 id="owner">Owner</h2>
<ul>
  <li>Idan Shaby</li>
</ul>

<h2 id="current-status">Current status</h2>
<ul>
  <li><a href="#usage">First phase</a> - implemented in vdsm config file (per host) - released in oVirt 4.0.</li>
  <li><a href="#future-plans">Second phase</a> - implemented in the engine (per storage domain) - released in oVirt 4.1.</li>
</ul>

<h2 id="general-functionality-and-restrictions">General functionality and restrictions</h2>

<h3 id="under-the-hood">Under the hood</h3>

<h4 id="using-vdsms-configuration-file">Using vdsm’s configuration file</h4>
<p>A new parameter was added to the <em>vdsm</em> configuration file, <strong><em>discard_enable</em></strong>.<br />
When it is <em>true</em> in a specific vdsm host, that host will issue a <em>blkdiscard</em> command on a logical volume right before removing it. That means that each disk or snapshot that this host removes, automatically triggers  it to inform the storage array that this logical volume’s blocks were freed and can be used by other luns in the array.<br />
Note that <strong>this option will be dropped in oVirt 4.2</strong> and thus it is not recommended to use it any more. The right way of using this feature is by configuring the storage domain in the engine’s side.</p>

<h4 id="using-engines-storage-domain-configuration">Using engine’s storage domain configuration</h4>
<p>This feature adds a new storage domain property called <strong><em>Discard After Delete</em></strong>.<br />
If all the <a href="#restrictions">restrictions</a> are met, a <em>blkdiscard</em> command will be issued on each logical volume before it is removed in two possible cases:</p>

<ol>
  <li><em>Discard After Delete</em> is enabled for the relevant storage domain.<br /></li>
  <li>The disk is attached to at least one virtual machine with <a href="/ovirt-site/previews/3125/develop/release-management/features/storage/pass-discard-from-guest-to-underlying-storage.html"><em>Pass Discard</em></a> enabled.<br />
The logic behind this is that if the user wanted “live” discarding, he will probably want to discard the whole disk when it is removed even if its storage domain’s <em>Discard After Delete</em> property is disabled.</li>
</ol>

<p>The consequences are the same as those from the previous section, when using vdsm configuration file. The differences between the two are:</p>

<ul>
  <li>The configuration is per storage domain, and not per host.</li>
  <li>Any host in the data center is capable of issuing the <em>blkdiscard</em> command on a removed disk or snapshot.</li>
  <li><em>Discard After Delete</em> cannot be enabled for unsupported storage domains, so users should know what to expect.</li>
</ul>

<h3 id="possible-consumers-of-the-discarded-blocks">Possible consumers of the discarded blocks</h3>
<p>After a disk is removed from a block storage domain and its blocks are discarded, anything can use them:</p>

<ul>
  <li>New and existing disks on the same storage domain (if there’s enough free space in the storage domain, of course).</li>
  <li>New and existing disks on other storage domains that are built on luns from the same storage array.</li>
  <li>Other processes that use luns from the same storage array.</li>
</ul>

<h3 id="restrictions">Restrictions</h3>

<h4 id="the-storage-type">The storage type</h4>
<p>This feature is relevant only for <strong>block</strong> storage domains, i.e <em>iSCSI</em> and <em>Fibre Channel</em> storage domains.</p>

<h4 id="the-underlying-storage">The underlying storage</h4>
<p>Let <em>lunX</em> be a device and <em>dm-X</em> be its corresponding dm device for a natural number X. Then <em>lunX</em> is considered to <strong><em>support discard</em></strong> iff the value of <code class="language-plaintext highlighter-rouge">/sys/block/dm-X/queue/discard_max_bytes</code> is bigger than 0 <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p>

<p>The luns in the underlying storage must <em>support discard</em> in order for this to work.<br />
If the underlying storage doesn’t <em>support discard</em>:</p>

<ul>
  <li>When using vdsm’s configuration file - the <em>blkdiscard</em> command that <em>vdsm</em> tries to execute will fail with a log but will not break the lv removal. That is, the lv will be removed but the space will not be reclaimed.</li>
  <li>When using the storage domain’s configuration - the <em>Discard After Delete</em> property cannot be enabled and thus disks and snapshots under that storage domain will not be discarded.</li>
</ul>

<h4 id="wipe-after-delete-and-discard-after-deletediscard_enable"><em>Wipe After Delete</em> and <em>Discard After Delete</em>/<em>discard_enable</em></h4>
<p>These two properties are completely independent.<br />
To understand it better, let’s take a look at the flow of removing a disk from a block domain in <em>vdsm</em>:</p>

<ol>
  <li>If the disk’s <em>Wipe After Delete</em> is enabled, then the disk is first wiped. If not, <em>vdsm</em> moves to phase 2.</li>
  <li>If the the disk should be discarded (see <a href="#under-the-hood">Under the hood</a>), then <em>vdsm</em> issues a <em>blkdiscard</em> command on that disk’s logical volumes. If not, it moves to phase 3.</li>
  <li>The disk’s logical volumes are removed.</li>
</ol>

<h2 id="usage">Usage</h2>

<h3 id="using-vdsms-configuration-file-1">Using vdsm’s configuration file</h3>
<p>The administrator should set the <em>discard_enable</em> property in <code class="language-plaintext highlighter-rouge">/etc/vdsm/vdsm.conf</code> to <strong><em>true</em></strong> and then <strong>restart the <em>vdsmd</em> service</strong>.<br />
The value of <em>discard_enable</em> is <strong><em>false</em></strong> by default.<br /></p>

<h3 id="using-engines-storage-domain-configuration-1">Using engine’s storage domain configuration</h3>
<p>The user should enable the <em>Discard After Delete</em> property of the relevant block storage domain.<br /></p>

<h4 id="gui">GUI</h4>
<p>The <em>Discard After Delete</em> checkbox can be found under the <em>“Advanced Parameters”</em> section in the “Manage Domain” and “New Domain” windows, right bellow the <em>Wipe After Delete</em> checkbox.</p>

<h5 id="manage-domain">Manage Domain</h5>
<p><img src="/ovirt-site/previews/3125/images/wiki/Manage_Domain_With_Discard_After_Delete_Bolded.png" alt="" /></p>

<h4 id="rest-api">REST-API</h4>

<h5 id="add-a-new-block-domain">Add a new block domain</h5>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST api/storagedomains
Content-Type: application/xml

<span class="nt">&lt;storage_domain&gt;</span>
  <span class="nt">&lt;host</span> <span class="na">id=</span><span class="s">"123"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;type&gt;</span>data<span class="nt">&lt;/type&gt;</span>
  <span class="nt">&lt;discard_after_delete&gt;</span>true<span class="nt">&lt;/discard_after_delete&gt;</span>
  <span class="nt">&lt;name&gt;</span>xtremio_sd<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;storage&gt;</span>
    ...
  <span class="nt">&lt;/storage&gt;</span>
<span class="nt">&lt;/storage_domain&gt;</span>
</code></pre></div></div>

<h5 id="update-an-existing-block-domain">Update an existing block domain</h5>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST api/storagedomains/<span class="nt">&lt;storage_domain_id&gt;</span>
Content-Type: application/xml

<span class="nt">&lt;storage_domain&gt;</span>
  <span class="nt">&lt;discard_after_delete&gt;</span>true<span class="nt">&lt;/discard_after_delete&gt;</span>
<span class="nt">&lt;/storage_domain&gt;</span>
</code></pre></div></div>

<h2 id="future-plans">Future Plans</h2>
<ul>
  <li>The support for <em>discard_enable</em> in vdsm’s configuration file should be dropped in oVirt 4.2.</li>
</ul>

<h2 id="related-bugs">Related Bugs</h2>
<ul>
  <li>Send discard when deleting virtual disks from block based storage domain to regain space in thin provisioned storage (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=981626">Bug 981626</a>)</li>
  <li>Make discard configurable by a storage domain rather than a host (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1342919">Bug 1342919</a>)</li>
</ul>

<h2 id="related-features">Related Features</h2>
<ul>
  <li><a href="/ovirt-site/previews/3125/develop/release-management/features/storage/pass-discard-from-guest-to-underlying-storage.html">Pass discard from guest to underlying storage</a></li>
  <li><a href="/ovirt-site/previews/3125/develop/release-management/features/storage/wipe-volumes-using-blkdiscard.html">Wipe volume using blkdiscard</a></li>
</ul>

<h2 id="references">References</h2>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>See “discard_max_bytes” in “Queue sysfs files” - <a href="https://www.kernel.org/doc/Documentation/block/queue-sysfs.txt">https://www.kernel.org/doc/Documentation/block/queue-sysfs.txt</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3125/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3125/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3125/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3125/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2023 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/discard-after-delete.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/discard-after-delete.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
