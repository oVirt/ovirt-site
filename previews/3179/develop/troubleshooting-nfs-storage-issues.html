<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Troubleshooting NFS Storage Issues | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Troubleshooting NFS Storage Issues" />
<meta name="author" content="Andrew Dahms" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3179/develop/troubleshooting-nfs-storage-issues.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3179/develop/troubleshooting-nfs-storage-issues.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Troubleshooting NFS Storage Issues" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Andrew Dahms" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Andrew Dahms"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Troubleshooting NFS Storage Issues","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3179/images/logo.svg"},"name":"Andrew Dahms"},"url":"https://ovirt.github.io/ovirt-site/previews/3179/develop/troubleshooting-nfs-storage-issues.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3179/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3179/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3179/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3179/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3179/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3179/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3179/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3179/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class="masthead hidden-print" id="branding" role="banner"><section class="hgroup"></section><div id="access"><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3179/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3179/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li>
<li role="menuitem">  <a href="/ovirt-site/previews/3179/download/">Download</a>
</li>
<li role="menuitem">  <a href="/ovirt-site/previews/3179/documentation/">Documentation</a>
</li>
<li class="active" role="menuitem">  <a href="/ovirt-site/previews/3179/develop/">Developers</a>
</li>
<li role="menuitem">  <a href="/ovirt-site/previews/3179/community/">Community</a>
</li>
<li role="menuitem">  <a href="/ovirt-site/previews/3179//lists.ovirt.org/archives/">Forum</a>
</li>
<li role="menuitem">  <a href="/ovirt-site/previews/3179//blogs.ovirt.org/">Blog</a>
</li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/">
              <span property="name"></span>
              <meta property="position" content="1">
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3179/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2">
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Andrew Dahms">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Andrew Dahms</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a29d28811a6b9fc71f135fc57cbb3ee4?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Yedidyah Bar David">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yedidyah Bar David</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/d82d85b7a1f1dca30d833f777fc0c7df?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d82d85b7a1f1dca30d833f777fc0c7df?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Douglas Landgraf">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Douglas Landgraf</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/df31c3a16c31d8322c6ecc1334a56698?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/df31c3a16c31d8322c6ecc1334a56698?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Deepak C Shetty">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Deepak C Shetty</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/7f1cc17ac58177d19921783d200a0604?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7f1cc17ac58177d19921783d200a0604?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Jason Brooks">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Jason Brooks</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/cbccb13b9d42aebbf895417aabf7e7da?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cbccb13b9d42aebbf895417aabf7e7da?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Nicholas Kesick">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Nicholas Kesick</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/de4309ef8cfa874c394239e9bb24be58?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/de4309ef8cfa874c394239e9bb24be58?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Ryan Harper">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ryan Harper</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/c489669ce6f88f4b35f0d0b4464250f2?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c489669ce6f88f4b35f0d0b4464250f2?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Steve Gordon">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Steve Gordon</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/b64af159420782a0d7dc29c95d3e80c6?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b64af159420782a0d7dc29c95d3e80c6?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Markus Stockhausen">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Markus Stockhausen</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img src="https://secure.gravatar.com/avatar/8872455242aae9492e0581a0e074c9c5?s=32&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8872455242aae9492e0581a0e074c9c5?s=64&amp;d=mm&amp;r=g 2x" class="avatar avatar-32 photo" height="32" width="32" loading="lazy" alt="avatar of Will Dennis">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Will Dennis</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="troubleshooting-nfs-storage-issues">Troubleshooting NFS Storage Issues</h1>

<h3 id="introduction">Introduction</h3>

<p>To attach NFS storage domains to an oVirt environment, the NFS exports must be configured in a specific way. This page is designed to outline the core requirements for configuring NFS exports, and assist in troubleshooting issues encountered when attempting to attach NFS storage domains to an oVirt environment for the first time.</p>

<h3 id="permissions">Permissions</h3>

<p>In principle, the user <strong>vdsm</strong>, with uid <strong>36</strong> and gid <strong>36</strong>, must have read and write permissions on all NFS exports. However, some daemons on the hypervisor hosts (for example, sanlock) use a different uid but need access to the directory too. Therefore, all incoming NFS requests must be mapped to the aforementioned uid and gid. Two steps are required to ensure this mapping:</p>

<ol>
  <li>Change the ownership of the export directory, replacing <em>directory_name</em> with the name of the directory:
    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nb">chown </span>36:36 directory_name
</code></pre></div>    </div>
  </li>
  <li>Add the <strong>rw</strong> options on the export in <code class="language-plaintext highlighter-rouge">/etc/exports</code>.
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>/exports/directory_name       *(rw)
</code></pre></div>    </div>
  </li>
  <li>Set the permissions of the export directory, replacing <em>directory_name</em> with the name of the directory:
    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nb">chmod </span>0755 directory_name
</code></pre></div>    </div>
  </li>
  <li>The NFS server must actually be running.</li>
</ol>

<p>a. Ensure that the <strong>nfs</strong> and <strong>rpcbind</strong> services are running on the NFS server,
b. Ensure that <code class="language-plaintext highlighter-rouge">showmount -e &lt;nfs_server_ip&gt;</code> shows the expected export(s).</p>

<h4 id="selinux">SELinux</h4>

<ul>
  <li>Ensure that selinux is not interfering with NFS access.
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">getsebool -a | grep virt_use_nfs</code> should show <code class="language-plaintext highlighter-rouge">virt_use_nfs --&gt; on</code>, if not then do <code class="language-plaintext highlighter-rouge">setsebool virt_use_nfs 1</code> to allow NFS access for VMs</li>
      <li>One can also use <code class="language-plaintext highlighter-rouge">setsebool -P virt_use_nfs 1</code> to make this setting persistent across reboots.</li>
    </ul>
  </li>
</ul>

<p>The easiest way to definitively test that an NFS export is ready for use by oVirt is to:</p>

<ul>
  <li>Create the <strong>vdsm</strong> user with uid <strong>36</strong> on the ovirt-engine host if it does not already exist.</li>
  <li>Change to the <strong>vdsm</strong> user using <code class="language-plaintext highlighter-rouge">su - vdsm -s /bin/bash</code>
</li>
  <li>Attempt to mount the export on a temporary directory (for example, <code class="language-plaintext highlighter-rouge">/tmpmnt</code>) using the following command form:
    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/usr/bin/sudo <span class="nt">-n</span> /bin/mount <span class="nt">-t</span> nfs <span class="nt">-o</span> soft,nosharecache,timeo<span class="o">=</span>600,retrans<span class="o">=</span>6,nfsvers<span class="o">=</span>3 <span class="k">*</span>servername:/path/of/export<span class="k">*</span> /tmpmnt
</code></pre></div>    </div>
  </li>
  <li>If the mount succeeds, then try to create a file in it via the <code class="language-plaintext highlighter-rouge">touch</code> command, i.e. <code class="language-plaintext highlighter-rouge">touch /tmpmnt/tempfile</code>
</li>
</ul>

<h4 id="iso-domain">ISO Domain</h4>

<h5 id="todo-update-to-a-current-version">TODO: Update to a current version</h5>

<p>The <strong>engine-setup</strong> command can optionally create an ISO domain and export it.</p>

<ul>
  <li>Until oVirt 3.3, it always exported to the entire network.</li>
  <li>In 3.4 it prompted the user for an ACL, and the default was still the entire network.</li>
  <li>In 3.5 it still prompts the user, but the default was changed to allow access for the local machine only.</li>
</ul>

<p>The format for the ACL is simply that of <code class="language-plaintext highlighter-rouge">/etc/exports</code> - see the exports(5) manpage for details. Some simple examples:</p>

<ul>
  <li>To allow access to 3 hosts host1, host2 and host3, input: <em>host1(rw) host2(rw) host3(rw)</em>
</li>
  <li>To allow access to the entire Internet, input: <em>*(rw)</em>
</li>
</ul>

<p>If you use the last example, you must ensure that other means such as a firewall are in place to protect the ISO domain. When configuring this option, also consider protecting the ISO domain from untrusted guests that you might want to run on your hosts.</p>

<h3 id="nfs-check-program">nfs-check program</h3>

<p>A new <strong>nfs-check</strong> script is now available to test whether an NFS export is ready for use by oVirt :</p>

<ul>
  <li>
<strong>nfs-check.py</strong> is a python script to validate nfs targets to use with oVirt project. Some operations include: mount the nfs target, create a file as vdsm:kvm and then remove it.</li>
  <li>
<strong>nfs-check.py</strong> is available in the <strong>vdsm/contrib/</strong> directory of the vdsm source</li>
  <li>Run it on a node via <code class="language-plaintext highlighter-rouge">python nfs-check.py 'server:/target'</code>
    <div class="language-console highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>git clone <span class="s2">"https://gerrit.ovirt.org/vdsm"</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>vdsm/contrib
<span class="gp">$</span><span class="w"> </span>python nfs-check.py myNFSServer:/nfsTarget
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="setting-nfs-server">Setting NFS Server</h3>

<h4 id="debian-squeeze">Debian Squeeze</h4>
<h5 id="todo-update-to-current-debian">TODO: Update to current Debian</h5>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">     #</span><span class="o">&gt;</span> groupadd kvm <span class="nt">-g</span> 36
<span class="gp">     #</span><span class="o">&gt;</span> useradd vdsm <span class="nt">-u</span> 36 <span class="nt">-g</span> kvm
<span class="go">
</span><span class="gp">     #</span><span class="w"> </span><span class="nb">mkdir</span> /storage
<span class="go">
</span><span class="gp">     #</span><span class="o">&gt;</span> <span class="nb">chmod </span>0755 /storage
<span class="gp">     #</span><span class="o">&gt;</span> <span class="nb">chown </span>36:36 /storage/
<span class="gp">     #</span><span class="o">&gt;</span> <span class="nb">cat</span> /etc/exports
<span class="go">     /storage    *(rw)

</span><span class="gp">     #</span><span class="o">&gt;</span>/etc/init.d/nfs-kernel-server restart
</code></pre></div></div>

<h4 id="fedora-26-or-higher">Fedora 26 or higher</h4>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">      #</span><span class="o">&gt;</span> groupadd kvm <span class="nt">-g</span> 36
<span class="gp">      #</span><span class="o">&gt;</span> useradd vdsm <span class="nt">-u</span> 36 <span class="nt">-g</span> kvm
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">mkdir</span> /storage
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">chmod </span>0755 /storage
<span class="gp">      #</span><span class="w"> </span><span class="nb">chown </span>36:36 /storage/
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span>yum <span class="nt">-y</span> <span class="nb">install </span>nfs-utils
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">cat</span> /etc/exports
<span class="go">      /storage    *(rw)

</span><span class="gp">      #</span><span class="w"> </span>systemctl start rpcbind.service
<span class="gp">      #</span><span class="w"> </span>systemctl start nfs-server.service
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span>Relevant only <span class="k">for </span>NFS v3
<span class="gp">      #</span><span class="w"> </span>systemctl start nfs-lock.service
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span>systemctl <span class="nb">enable </span>rpcbind.service
<span class="gp">      #</span><span class="w"> </span>systemctl <span class="nb">enable </span>nfs-server.service
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span>Relevant only <span class="k">for </span>NFS v3
<span class="gp">      #</span><span class="w"> </span>systemctl <span class="nb">enable </span>nfs-lock.service
</code></pre></div></div>

<h4 id="rhel7-based-distro">RHEL7 based distro</h4>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">      #</span><span class="o">&gt;</span> groupadd kvm <span class="nt">-g</span> 36
<span class="gp">      #</span><span class="o">&gt;</span> useradd vdsm <span class="nt">-u</span> 36 <span class="nt">-g</span> kvm
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">mkdir</span> /storage
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">chmod </span>0755 /storage
<span class="gp">      #</span><span class="w"> </span><span class="nb">chown </span>36:36 /storage/
<span class="go">
</span><span class="gp">      #</span><span class="w"> </span><span class="nb">cat</span> /etc/exports
<span class="go">      /storage    *(rw)

</span><span class="gp">      #</span><span class="w"> </span>systemctl <span class="nb">enable </span>rpcbind
<span class="gp">      #</span><span class="w"> </span>systemctl <span class="nb">enable </span>nfs-server
<span class="gp">      #</span><span class="w"> </span>systemctl start rpcbind
<span class="gp">      #</span><span class="w"> </span>systemctl start nfs-server
</code></pre></div></div>

<h4 id="synology-dsm-624-25556-update-2-and-later">Synology DSM 6.2.4-25556 Update 2 and later</h4>

<p>Synology DSM 6.2.4-25556 Update 2 / DSM 7 extends Access Control Lists (ACLs) on all shared folders, and removes <code class="language-plaintext highlighter-rouge">groupadd</code> and <code class="language-plaintext highlighter-rouge">useradd</code> commands.
To allow ovirt nodes to connect via NFS the ACL permissions and /etc/exports file need to be updated manually (<em>take backups before editing!</em>).</p>

<ol>
  <li>
    <p>Create the shared folder required as usual and allow your oVirt host IP’s in the NFS permissions section</p>
  </li>
  <li>
    <p>Login to your Synology NAS via SSH (search the web for ‘synology enable ssh access’) as root or sudo to root once logged in</p>
  </li>
  <li>
    <p>Add a line for the kvm group (id 36) to /etc/group</p>

    <p><code class="language-plaintext highlighter-rouge">kvm:x:36</code></p>
  </li>
  <li>
    <p>Add a line for the vdsm user (id 36) to /etc/passwd</p>

    <p><code class="language-plaintext highlighter-rouge">vdsm:x:36:36::/dev/null:/bin/false</code></p>
  </li>
  <li>Update the Synology ACLs to allow access to kvm:vdsm
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>    <span class="nv">EXPORT_DIR</span><span class="o">=</span>/volumeX/...
    <span class="nv">ALLOW_USER</span><span class="o">=</span><span class="s1">'user:vdsm:allow:rwxpdDaARWcCo:fd--'</span>
    <span class="nv">ALLOW_GROUP</span><span class="o">=</span><span class="s1">'group:kvm:allow:rwxpdDaARWcCo:fd--'</span>

    synoacltool <span class="nt">-get</span> <span class="s2">"</span><span class="nv">$EXPORT_DIR</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$ALLOW_USER</span><span class="s2">"</span> <span class="o">||</span> synoacltool <span class="nt">-add</span> <span class="s2">"</span><span class="nv">$EXPORT_DIR</span><span class="s2">"</span> <span class="nv">$ALLOW_USER</span> <span class="o">&gt;</span> /dev/null
    synoacltool <span class="nt">-get</span> <span class="s2">"</span><span class="nv">$EXPORT_DIR</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$ALLOW_GROUP</span><span class="s2">"</span> <span class="o">||</span> synoacltool <span class="nt">-add</span> <span class="s2">"</span><span class="nv">$EXPORT_DIR</span><span class="s2">"</span> <span class="nv">$ALLOW_GROUP</span> <span class="o">&gt;</span> /dev/null
    synoacltool <span class="nt">-get</span> <span class="s2">"</span><span class="nv">$EXPORT_DIR</span><span class="s2">"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Edit /etc/exports and replace the <code class="language-plaintext highlighter-rouge">anonuid</code> and <code class="language-plaintext highlighter-rouge">anongid</code> values with 36, e.g.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>/volume1/ovirt 1.1.1.1(&lt;Synology defined options&gt;,anonuid=1025,anongid=100) 1.1.1.2(&lt;Synology defined options&gt;anonuid=1025,anongid=100)
</code></pre></div>    </div>
  </li>
</ol>

<p>Would become</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /volume1/ovirt 1.1.1.1(&lt;Synology defined options&gt;,anonuid=36,anongid=36) 1.1.1.2(&lt;Synology defined options&gt;,anonuid=36,anongid=36)
</code></pre></div></div>

<p><strong>Warning</strong> any edits (i.e. adding a new host) to the NFS share in the Synology UI will reset the <code class="language-plaintext highlighter-rouge">anonuid</code> and <code class="language-plaintext highlighter-rouge">anongid</code> back to Synology defatuls.</p>

<h2 id="workarounds-for-known-issues">Workarounds for known issues</h2>

<h4 id="todo-update-for-the-newer-supported-releases">TODO: update for the newer supported releases</h4>

<h3 id="nfs-lockups">NFS Lockups</h3>

<p>Normally the NFS server of any distro should work out of the box. Using older NFS servers or following different tuning advices throughout the internet may lead to a misconfiguration that gives lockups/freezes/stalls. Rule of thumb is to always ensure that the tcp window size parameters of your server are larger than the wsize and rsize mount option of your hypervisor hosts. E.g. using Fedora 19 as a hypervisor node these parameters are set to 1 MB.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">       #</span><span class="w"> </span><span class="nb">df</span>
<span class="c">      ...
</span><span class="go">      10.10.30.253:/var/nas3/ovirt on /rhev/data-center/mnt/10.10.30.253:_var_nas3_ovirt type nfs (...,rsize=1048576,wsize=1048576,...)
</span><span class="c">      ...
</span></code></pre></div></div>

<p>In this case it is a good idea to set the tcp window parameters on the NFS server to at least 4 MB in <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">       #</span><span class="w"> </span><span class="nb">cat</span> /etc/sysctl.conf
<span class="go">      net.ipv4.tcp_mem=4096 65536 4194304
      net.ipv4.tcp_rmem=4096 65536 4194304
      net.ipv4.tcp_wmem=4096 65536 4194304
      net.core.rmem_max=8388608
      net.core.wmem_max=8388608
</span></code></pre></div></div>

<p>To activate these settings for the running server reload them with</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">       #</span><span class="w"> </span>sysctl <span class="nt">-p</span>
</code></pre></div></div>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3179/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class="text-center" id="footer"><hr class="visible-print">
<ul class="footer-nav-list">
<li><a href="/ovirt-site/previews/3179/privacy-policy.html" target="_blank" title="Privacy policy">Privacy policy</a></li>
<li><a href="/ovirt-site/previews/3179/community/about.html" target="_blank" title="About">About</a></li>
<li><a href="/ovirt-site/previews/3179/general-disclaimer.html" target="_blank" title="Disclaimers">Disclaimers</a></li>
</ul>© 2013–2024 oVirt<div class="edit-this-page"><a href="https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/troubleshooting-nfs-storage-issues.html&amp;template=" target="_blank" title="Report an issue"><i class="icon fab fa-github"></i>Report an issue with this page</a></div>
<div class="edit-this-page"><a href="https://github.com/oVirt/ovirt-site/edit/main/source/develop/troubleshooting-nfs-storage-issues.md" target="_blank" title="Edit this page"><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
