<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>oVirt | oVirt is a free open-source virtualization solution for your entire enterprise</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="oVirt" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3069/documentation/disaster_recovery_guide/" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3069/documentation/disaster_recovery_guide/" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="oVirt" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"oVirt","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3069/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3069/documentation/disaster_recovery_guide/"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3069/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3069/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3069/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3069/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3069/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3069/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3069/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3069/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/download/'>Download</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3069/documentation/'>Documentation</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/documentation/">
              <span property="name">Documentation</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
        
        <section id="content" class="content container">
          
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#disaster_recovery_solutions">1. Disaster Recovery Solutions</a></li>
<li><a href="#active_active">2. Active-Active Disaster Recovery</a>
<ul class="sectlevel2">
<li><a href="#active_active_overview">2.1. Active-Active Overview</a></li>
<li><a href="#network_considerations">2.2. Network Considerations</a></li>
<li><a href="#storage_considerations_active_active">2.3. Storage Considerations</a></li>
<li><a href="#configure_she_stretch_cluster">2.4. Configuring a Self-hosted Engine Stretch Cluster Environment</a></li>
<li><a href="#configure_standalone_manager_stretch_cluster">2.5. Configuring a Standalone Engine Stretch Cluster Environment</a></li>
</ul>
</li>
<li><a href="#active_passive">3. Active-Passive Disaster Recovery</a>
<ul class="sectlevel2">
<li><a href="#active_passive_overview">3.1. Active-Passive Overview</a></li>
<li><a href="#network_considerations_active_passive">3.2. Network Considerations</a></li>
<li><a href="#storage_considerations_active-passive">3.3. Storage Considerations</a></li>
<li><a href="#create_ansible_playbooks">3.4. Create the Required Ansible Playbooks</a>
<ul class="sectlevel3">
<li><a href="#Using-ovirt-dr-script">3.4.1. The <code>ovirt-dr</code> Script for Ansible Tasks</a></li>
<li><a href="#generate_mapping">3.4.2. Creating the Playbook to Generate the Mapping File</a></li>
<li><a href="#create_failover_failback">3.4.3. Create the Failover and Failback Playbooks</a></li>
<li><a href="#create_cleanup">3.4.4. Create the Playbook to Clean the Primary Site</a></li>
</ul>
</li>
<li><a href="#execute_failover">3.5. Executing a Failover</a></li>
<li><a href="#clean">3.6. Cleaning the Primary Site</a></li>
<li><a href="#execute_failback">3.7. Executing a Failback</a></li>
</ul>
</li>
<li><a href="#mapping_file_attributes">Appendix A: Mapping File Attributes</a></li>
<li><a href="#testing_active_passive">Appendix B: Testing the Active-Passive Configuration</a>
<ul class="sectlevel2">
<li><a href="#discreet_failover">B.1. Discreet Failover Test</a></li>
<li><a href="#discreet_failover_failback">B.2. Discreet Failover and Failback Test</a></li>
<li><a href="#non_discreet_failover_failback">B.3. Full Failover and Failback test</a></li>
</ul>
</li>
<li><a href="#ovirt-legal-notice">Appendix C: Legal notice</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<h1 id="disaster-recovery-guide" class="discrete">Disaster Recovery Guide</h1>
</div>
</div>
<div class="sect1">
<h2 id="disaster_recovery_solutions">1. Disaster Recovery Solutions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>oVirt supports two types of disaster recovery solutions to ensure that environments can recover when a site outage occurs. Both solutions support two sites, and both require replicated storage.</p>
</div>
<div class="paragraph">
<div class="title">Active-Active Disaster Recovery</div>
<p>This solution is implemented using a stretch cluster configuration. This means that there is a single oVirt environment with a cluster that contains hosts capable of running the required virtual machines in the primary and secondary site. Virtual machines automatically migrate to hosts in the secondary site if an outage occurs. However, the environment must meet latency and networking requirements. See <a href="#active_active_overview">Active-Active Overview</a> for more information.</p>
</div>
<div class="paragraph">
<div class="title">Active-Passive Disaster Recovery</div>
<p>Also referred to as site-to-site failover, this disaster recovery solution is implemented by configuring two separate oVirt environments: the active primary environment, and the passive secondary (backup) environment. Failover and failback between sites must be manually executed, and is managed by Ansible. See <a href="#active_passive_overview">Active-Passive Overview</a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="active_active">2. Active-Active Disaster Recovery</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="active_active_overview">2.1. Active-Active Overview</h3>
<div class="paragraph">
<p>The active-active disaster recovery failover configuration can span two sites. Both sites are active, and if the primary site becomes unavailable, the oVirt environment continues to operate in the secondary site to ensure business continuity.</p>
</div>
<div class="paragraph">
<p>The active-active failover configuration includes a stretch cluster in which hosts capable of running the virtual machines are located in both the primary and secondary sites. All the hosts belong to the same oVirt cluster.</p>
</div>
<div class="paragraph">
<p>This configuration requires replicated storage that is writeable on both sites so virtual machines can migrate between the two sites and continue running on both sites' storage.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/StretchCluster.png" alt="Stretch Cluster Configuration">
</div>
<div class="title">Figure 1. Stretch Cluster Configuration</div>
</div>
<div class="paragraph">
<p>Virtual machines migrate to the secondary site if the primary site becomes unavailable. The virtual machines automatically failback to the primary site when the site becomes available and the storage is replicated in both sites.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/StretchClusterFailover.png" alt="Failed Over Stretch Cluster">
</div>
<div class="title">Figure 2. Failed Over Stretch Cluster</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To ensure virtual machine failover and failback works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Virtual machines must be configured to be highly available, and each virtual machine must have a lease on a target storage domain to ensure the virtual machine can start even without power management.</p>
</li>
<li>
<p>Soft enforced virtual machine to host affinity must be configured to ensure the virtual machines only start on the selected hosts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information see <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Improving_Uptime_with_Virtual_Machine_High_Availability">Improving Uptime with Virtual Machine High Availability</a> and <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Affinity_Groups">Affinity Groups</a> in the <em>Virtual Machine Management Guide</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The stretched cluster configuration can be implemented using a self-hosted engine environment, or a standalone Engine environment. For more information about the different types of deployments see <a href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/html-single/product_guide/index#RHV_Architecture">Red Hat Virtualization Architecture</a> in the <em>Product Guide</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="network_considerations">2.2. Network Considerations</h3>
<div class="paragraph">
<p>All hosts in the cluster must be on the same broadcast domain over an L2 network. So connectivity between the two sites must be L2.</p>
</div>
<div class="paragraph">
<p>The maximum latency requirements between the sites across the L2 network differ for the two setups. The standalone Engine environment requires a maximum latency of 100ms, while the self-hosted engine environment requires a maximum latency of 7ms.</p>
</div>
</div>
<div class="sect2">
<h3 id="storage_considerations_active_active">2.3. Storage Considerations</h3>
<div class="paragraph">
<p>The storage domain for oVirt can comprise either block devices (SAN - iSCSI or FCP) or a file system (NAS - NFS, GlusterFS, or other POSIX compliant file systems). For more information about oVirt storage, see <a href="https://ovirt.org/documentation/administration_guide/index#chap-Storage">Storage</a> in the <em>Administration Guide</em>.</p>
</div>
<div class="paragraph">
<p>The sites require synchronously replicated storage that is writeable on both sites with shared layer 2 (L2) network connectivity. The replicated storage is required to allow virtual machines to migrate between sites and continue running on the site’s storage. All storage replication options supported by Enterprise Linux 7 and later can be used in the stretch cluster.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have a custom multipath configuration that is recommended by the storage vendor, see the instructions and important limitations in <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/index#proc-Customizing_Multipath_Configurations_for_SAN_Vendors_SHE_cli_deploy">Customizing Multipath Configurations for SAN Vendors</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set the SPM role on a host at the primary site to have precedence. To do so, configure SPM priority as high in the primary site hosts and SPM priority as low on secondary site hosts. If you have a primary site failure that impacts network devices inside the primary site, preventing the fencing device for the SPM host from being reachable, such as power loss, the hosts in the seconday site are not able to take over the SPM role.</p>
</div>
<div class="paragraph">
<p>In such a scenario virtual machines do a failover, but operations that require the SPM role in place cannot be executed, including adding new disks, extending existing disks, and exporting virtual machines.</p>
</div>
<div class="paragraph">
<p>To restore full functionality, detect the actual nature of the disaster and after fixing the root cause and rebooting the SPM host, select <strong>Confirm 'Host has been Rebooted'</strong> for the SPM host.</p>
</div>
<div class="paragraph">
<div class="title">Additional resources</div>
<p><a href="https://ovirt.org/documentation/administration_guide/index#Manually_fencing_or_isolating_a_nonresponsive_host">Manually Fencing or Isolating a Non-Responsive Host</a> in the <em>Administration Guide</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure_she_stretch_cluster">2.4. Configuring a Self-hosted Engine Stretch Cluster Environment</h3>
<div class="paragraph">
<p>This procedure provides instructions to configure a stretch cluster using a self-hosted engine deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A writable storage server in both sites with L2 network connectivity.</p>
</li>
<li>
<p>Real-time storage replication service to duplicate the storage.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Maximum 7ms latency between sites.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Configuring the Self-hosted Engine Stretch Cluster</div>
<ol class="arabic">
<li>
<p>Deploy the self-hosted engine. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line">Installing oVirt as a self-hosted engine using the command line</a>.</p>
</li>
<li>
<p>Install additional self-hosted engine nodes in each site and add them to your cluster. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/#Adding_self-hosted_engine_nodes_to_the_Manager_SHE_cli_deploy">Adding Self-hosted Engine Nodes to the oVirt Engine</a> in <em>Installing oVirt as a self-hosted engine using the command line</em>.</p>
</li>
<li>
<p>Optionally, install additional standard hosts. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_self-hosted_engine_using_the_command_line/#Adding_standard_hosts_to_the_Manager_SHE_cli_deploy">Adding Standard Hosts to the oVirt Engine</a> in <em>Installing oVirt as a self-hosted engine using the command line</em>.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the SPM priority to be higher on all hosts in the primary site to ensure SPM failover to the secondary site occurs only when all hosts in the primary site are unavailable. See <a href="https://ovirt.org/documentation/administration_guide/index#SPM_Priority">SPM Priority</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Configure all virtual machines that must failover as highly available, and ensure that the virtual machine has a lease on the target storage domain. See <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#Configuring_a_highly_available_virtual_machine">Configuring a Highly Available Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Configure virtual machine to host soft affinity and define the behavior you expect from the affinity group. See  <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Affinity_Groups">Affinity Groups</a> in the <em>Virtual Machine Management Guide</em> and <a href="https://ovirt.org/documentation/administration_guide/index#sect-Scheduling_Policies">Scheduling Policies</a> in the <em>Administration Guide</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The active-active failover can be manually performed by placing the main site&#8217;s hosts into maintenance mode.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure_standalone_manager_stretch_cluster">2.5. Configuring a Standalone Engine Stretch Cluster Environment</h3>
<div class="paragraph">
<p>This procedure provides instructions to configure a stretch cluster using a standalone Engine deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A writable storage server in both sites with L2 network connectivity.</p>
</li>
<li>
<p>Real-time storage replication service to duplicate the storage.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Limitations</div>
<ul>
<li>
<p>Maximum 100ms latency between sites.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Engine must be highly available for virtual machines to failover and failback between sites. If the Engine goes down with the site, the virtual machines will not failover.</p>
</div>
<div class="paragraph">
<p>The standalone Engine is only highly available when managed externally. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Red Hat’s High Availability Add-On.</p>
</li>
<li>
<p>As a highly available virtual machine in a separate virtualization environment.</p>
</li>
<li>
<p>Using Enterprise Linux Cluster Suite.</p>
</li>
<li>
<p>In a public cloud.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install and configure the oVirt Engine. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/index#"><em>Installing oVirt as a standalone Engine with local databases</em></a>.</p>
</li>
<li>
<p>Install the hosts in each site and add them to the cluster. See <a href="https://ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/#Installing_Hosts_for_RHV_SM_localDB_deploy">Installing Hosts for oVirt</a> in <em>Installing oVirt as a standalone Engine with local databases</em>.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the SPM priority to be higher on all hosts in the primary site to ensure SPM failover to the secondary site occurs only when all hosts in the primary site are unavailable. See <a href="https://ovirt.org/documentation/administration_guide/index#SPM_Priority">SPM Priority</a> in the <em>Administration Guide</em>.</p>
</li>
<li>
<p>Configure all virtual machines that must failover as highly available, and ensure that the virtual machine has a lease on the target storage domain. See <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#Configuring_a_highly_available_virtual_machine">Configuring a Highly Available Virtual Machine</a> in the <em>Virtual Machine Management Guide</em>.</p>
</li>
<li>
<p>Configure virtual machine to host soft affinity and define the behavior you expect from the affinity group. See  <a href="https://ovirt.org/documentation/virtual_machine_management_guide/index#sect-Affinity_Groups">Affinity Groups</a> in the <em>Virtual Machine Management Guide</em> and <a href="https://ovirt.org/documentation/administration_guide/index#sect-Scheduling_Policies">Scheduling Policies</a> in the <em>Administration Guide</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The active-active failover can be manually performed by placing the main site&#8217;s hosts into maintenance mode.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="active_passive">3. Active-Passive Disaster Recovery</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="active_passive_overview">3.1. Active-Passive Overview</h3>
<div class="paragraph">
<p>oVirt supports an active-passive disaster recovery solution that can span two sites. If the primary site becomes unavailable, the oVirt environment can be forced to fail over to the secondary (backup) site.</p>
</div>
<div class="paragraph">
<p>The failover is achieved by configuring a oVirt environment in the secondary site, which requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An active oVirt Engine.</p>
</li>
<li>
<p>A data center and clusters.</p>
</li>
<li>
<p>Networks with the same general connectivity as the primary site.</p>
</li>
<li>
<p>Active hosts capable of running critical virtual machines after failover.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must ensure that the secondary environment has enough resources to run the failed over virtual machines, and that both the primary and secondary environments have identical Engine versions, data center and cluster compatibility levels, and PostgreSQL versions. The minimum supported compatibility level is 4.2.</p>
</div>
<div class="paragraph">
<p>Storage domains that contain virtual machine disks and templates in the primary site must be replicated. These replicated storage domains must not be attached to the secondary site.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The failover and failback process must be executed manually. To do this you must create Ansible playbooks to map entities between the sites, and to manage the failover and failback processes. The mapping file instructs the oVirt components where to fail over or fail back to on the target site.</p>
</div>
<div class="paragraph">
<p>The following diagram describes an active-passive setup where the machine running Red Hat Ansible Engine is highly available, and has access to the <code>oVirt.disaster-recovery</code> Ansible role, configured playbooks, and mapping file. The storage domains that store the virtual machine disks in Site A is replicated. Site B has no virtual machines or attached storage domains.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/SiteToSite.png" alt="Active-Passive Configuration">
</div>
<div class="title">Figure 3. Active-Passive Configuration</div>
</div>
<div class="paragraph">
<p>When the environment fails over to Site B, the storage domains are first attached and activated in Site B&#8217;s data center, and then the virtual machines are registered. Highly available virtual machines will fail over first.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/SiteToSiteFailover.png" alt="Failover to Backup Site">
</div>
<div class="title">Figure 4. Failover to Backup Site</div>
</div>
<div class="paragraph">
<p>You must manually fail back to the primary site (Site A) when it is running again.</p>
</div>
</div>
<div class="sect2">
<h3 id="network_considerations_active_passive">3.2. Network Considerations</h3>
<div class="paragraph">
<p>You must ensure that the same general connectivity exists in the primary and secondary sites.</p>
</div>
<div class="paragraph">
<p>If you have multiple networks or multiple data centers then you must use an empty network mapping in the mapping file to ensure that all entities register on the target during failover. See <a href="#mapping_file_attributes">Mapping File Attributes</a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="storage_considerations_active-passive">3.3. Storage Considerations</h3>
<div class="paragraph">
<p>The storage domain for oVirt can comprise either block devices (SAN - iSCSI or FCP) or a file system (NAS - NFS, GlusterFS, or other POSIX compliant file systems). For more information about oVirt storage see <a href="https://ovirt.org/documentation/administration_guide/index#chap-Storage">Storage</a> in the <em>Administration Guide</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Local storage domains are unsupported for disaster recovery.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A primary and secondary storage replica is required. The primary storage domain’s block devices or shares that contain virtual machine disks or templates must be replicated. The secondary storage must not be attached to any data center, and will be added to the backup site’s data center during failover.</p>
</div>
<div class="paragraph">
<p>If you are implementing disaster recovery using a self-hosted engine, ensure that the storage domain used by the Engine virtual machine does not contain virtual machine disks because in such a case the storage domain will not be failed over.</p>
</div>
<div class="paragraph">
<p>All storage solutions that have replication options that are supported by Enterprise Linux 7 and later can be used.</p>
</div>
</div>
<div class="sect2">
<h3 id="create_ansible_playbooks">3.4. Create the Required Ansible Playbooks</h3>
<div class="paragraph">
<p>Ansible is used to initiate and manage the disaster recovery failover and failback. So you must create Ansible playbooks to facilitate this. For more information about creating Ansible playbooks, see the <a href="http://docs.ansible.com/ansible/latest/playbooks.html">Ansible documentation</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Fully functioning oVirt environment in the primary site.</p>
</li>
<li>
<p>A backup environment in the secondary site with the same data center and cluster compatibility level as the primary environment. The backup environment must have:</p>
<div class="ulist">
<ul>
<li>
<p>A oVirt Engine.</p>
</li>
<li>
<p>Active hosts capable of running the virtual machines and connecting to the replicated storage domains.</p>
</li>
<li>
<p>A data center with clusters.</p>
</li>
<li>
<p>Networks with the same general connectivity as the primary site.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Replicated storage. See <a href="#storage_considerations_active-passive">Storage Considerations</a> for more information.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The replicated storage that contains virtual machines and templates must not be attached to the secondary site.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>The <code>oVirt.disaster-recovery</code> package must be installed on the highly available Red Hat Ansible Engine machine that will automate the failover and failback.</p>
</li>
<li>
<p>The machine running Red Hat Ansible Engine must be able to use SSH to connect to the Engine in the primary and secondary site.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is also recommended to create environment properties that exist in the primary site, such as affinity groups, affinity labels, users, on the secondary site.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default behaviour of the Ansible playbooks can be configured in the <code>/usr/share/ansible/roles/oVirt.disaster-recovery/defaults/main.yml</code> file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following playbooks must be created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The playbook that creates the file to map entities on the primary and secondary site.</p>
</li>
<li>
<p>The failover playbook.</p>
</li>
<li>
<p>The failback playbook.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also create an optional playbook to clean the primary site before failing back.</p>
</div>
<div class="paragraph">
<p>Create the playbooks and associated files in <code>/usr/share/ansible/roles/oVirt.disaster-recovery/</code> on the Ansible machine that is managing the failover and failback. If you have multiple Ansible machines that can manage it, ensure that you copy the files to all of them.</p>
</div>
<div class="paragraph">
<p>You can test the configuration using one or more of the testing procedures in <a href="#testing_active_passive">Testing the Active-Passive Configuration</a>.</p>
</div>
<div class="sect3">
<h4 id="Using-ovirt-dr-script">3.4.1. The <code>ovirt-dr</code> Script for Ansible Tasks</h4>
<div class="paragraph">
<p>The <code>ovirt-dr</code> script simplifies the following Ansible tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generating a <code>var</code> mapping file of the primary and secondary sites for failover and fallback</p>
</li>
<li>
<p>Validating the <code>var</code> mapping file</p>
</li>
<li>
<p>Executing failover on a target site</p>
</li>
<li>
<p>Executing failback from a target site to a source site</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This script is located in <code>/usr/share/ansible/roles/oVirt.disaster-recovery/files</code></p>
</div>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ./ovirt-dr <em>generate/validate/failover/failback</em>
              [--conf-file=dr.conf]
              [--log-file=ovirt-dr-<em>log_number</em>.log]
              [--log-level=<em>DEBUG/INFO/WARNING/ERROR</em>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can set the parameters for the script&#8217;s actions in the configuration file,  <strong>/usr/share/ansible/roles/oVirt.disaster-recovery/files/dr.conf</strong>.</p>
</div>
<div class="paragraph">
<p>You can change the location of the configuration file with the <code>--conf-file</code> option.</p>
</div>
<div class="paragraph">
<p>You can set the location and level of logging detail with the <code>--log-file</code> and <code>--log-level</code> options.</p>
</div>
</div>
<div class="sect3">
<h4 id="generate_mapping">3.4.2. Creating the Playbook to Generate the Mapping File</h4>
<div class="paragraph">
<p>The Ansible playbook used to generate the mapping file will prepopulate the file with the target (primary) site’s entities. You then must manually add the backup site’s entities, such as IP addresses, cluster, affinity groups, affinity label, external LUN disks, authorization domains, roles, and vNIC profiles, to the file.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The mapping file generation will fail if you have any virtual machine disks on the self-hosted engine’s storage domain. Also, the mapping file will not contain an attribute for this storage domain because it must not be failed over.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this example the Ansible playbook is named <code>dr-rhv-setup.yml</code>, and is executed on the Engine machine in the primary site.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an Ansible playbook to generate the mapping file. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: Generate mapping</span></span>
  <span style="color:#606">hosts</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">localhost</span></span>
  <span style="color:#606">connection</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">local</span></span>

  <span style="color:#606">vars</span>:
    <span style="color:#606">site</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">https://example.engine.redhat.com/ovirt-engine/api</span></span>
    <span style="color:#606">username</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">admin@internal</span></span>
    <span style="color:#606">password</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">my_password</span></span>
    <span style="color:#606">ca</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">/etc/pki/ovirt-engine/ca.pem</span></span>
    <span style="color:#606">var_file</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">disaster_recovery_vars.yml</span></span>

  <span style="color:#606">roles</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">oVirt.disaster-recovery</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For extra security, you can encrypt your Engine password in a <code>.yml</code> file. See <a href="https://ovirt.org/documentation/administration_guide/index">Using Ansible Roles to Configure oVirt</a> in the <em>Administration Guide</em> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the Ansible command to generate the mapping file. The primary site’s configuration will be prepopulated.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook dr-rhv-setup.yml --tags &quot;generate_mapping&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the mapping file (<code>disaster_recovery_vars.yml</code> in this case) with the backup site’s configuration. See <a href="#mapping_file_attributes">Mapping File Attributes</a> for more information about the mapping file’s attributes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you have multiple Ansible machines that can perform the failover and failback, then copy the mapping file to all relevant machines.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_failover_failback">3.4.3. Create the Failover and Failback Playbooks</h4>
<div class="paragraph">
<p>Ensure that you have the mapping file that you created and configured, in this case <code>disaster_recovery_vars.yml</code>, because this must be added to the playbooks.</p>
</div>
<div class="paragraph">
<p>You can define a password file (for example <code>passwords.yml</code>) to store the Engine passwords of the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">---
# This file is in plain text, if you want to
# encrypt this file, please execute following command:
#
# $ ansible-vault encrypt passwords.yml
#
# It will ask you for a password, which you must then pass to
# ansible interactively when executing the playbook.
#
# $ ansible-playbook myplaybook.yml --ask-vault-pass
#
dr_sites_primary_password: primary_password
dr_sites_secondary_password: secondary_password</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For extra security you can encrypt the password file. However, you must use the <code>--ask-vault-pass</code> parameter when running the playbook. See <em>Using Ansible Roles to Configure oVirt</em> in the <a href="https://ovirt.org/documentation/administration_guide/index#Using_Ansible_Roles">Administration Guide</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In these examples the Ansible playbooks to fail over and fail back are named <code>dr-rhv-failover.yml</code> and  <code>dr-rhv-failback.yml</code>.</p>
</div>
<div class="paragraph">
<p>Create the  following Ansible playbook to failover the environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">---
- name: Failover RHV
  hosts: localhost
  connection: local
  vars:
    dr_target_host: secondary
    dr_source_map: primary
  vars_files:
    - disaster_recovery_vars.yml
    - passwords.yml
  roles:
    - oVirt.disaster-recovery</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the  following Ansible playbook to failback the environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">---
- name: Failback RHV
  hosts: localhost
  connection: local
  vars:
    dr_target_host: primary
    dr_source_map: secondary
  vars_files:
    - disaster_recovery_vars.yml
    - passwords.yml
  roles:
    - oVirt.disaster-recovery</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create_cleanup">3.4.4. Create the Playbook to Clean the Primary Site</h4>
<div class="paragraph">
<p>Before you fail back to the primary site, you must ensure that the primary site is cleaned of all storage domains to be imported. You can do so manually on the Engine, or optionally you can create an Ansible playbook to do it for you.</p>
</div>
<div class="paragraph">
<p>The Ansible playbook to clean the primary site is named <code>dr-cleanup.yml</code> in this example, and it uses the mapping file generated by another Ansible playbook:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: clean RHV</span></span>
  <span style="color:#606">hosts</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">localhost</span></span>
  <span style="color:#606">connection</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">local</span></span>
  <span style="color:#606">vars</span>:
    <span style="color:#606">dr_source_map</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">primary</span></span>
  <span style="color:#606">vars_files</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">disaster_recovery_vars.yml</span></span>
  <span style="color:#606">roles</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">oVirt.disaster-recovery</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="execute_failover">3.5. Executing a Failover</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Engine and hosts in the secondary site are running.</p>
</li>
<li>
<p>Replicated storage domains are in read/write mode.</p>
</li>
<li>
<p>No replicated storage domains are attached to the secondary site.</p>
</li>
<li>
<p>A machine running Red Hat Ansible Engine that can connect via SSH to the Engine in the primary and secondary site, with the required packages and files:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>oVirt.disaster-recovery</code> package.</p>
</li>
<li>
<p>The mapping file and required failover playbook.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Sanlock must release all storage locks from the replicated storage domains before the failover process starts.
These locks should be released automatically approximately 80 seconds after the disaster occurs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This example uses the <code>dr-rhv-failover.yml</code> playbook created earlier.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the failover playbook with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook dr-rhv-failover.yml --tags &quot;fail_over&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>When the primary site becomes active, ensure that you clean the environment before failing back. See <a href="#clean">Cleaning the Primary Site</a> for more information.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="clean">3.6. Cleaning the Primary Site</h3>
<div class="paragraph">
<p>After you fail over, you must clean the environment in the primary site before failing back to it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reboot all hosts in the primary site.</p>
</li>
<li>
<p>Ensure the secondary site&#8217;s storage domains are in read/write mode and the primary site&#8217;s storage domains are in read only mode.</p>
</li>
<li>
<p>Synchronize the replication from the secondary site&#8217;s storage domains to the primary site&#8217;s storage domains.</p>
</li>
<li>
<p>Clean the primary site of all storage domains to be imported. This can be done manually in the Engine, or by creating and running an Ansible playbook. See <a href="https://ovirt.org/documentation/administration_guide/index#Detaching_a_storage_domain">Detaching a Storage Domain</a> in the <em>Administration Guide</em> for manual instructions, or <a href="#create_cleanup">Create the Playbook to Clean the Primary Site</a> for information to create the Ansible playbook.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example uses the <code>dr-cleanup.yml</code> playbook created earlier to clean the environment.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Clean up the primary site with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook dr-cleanup.yml --tags &quot;clean_engine&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>You can now failback the environment to the primary site. See <a href="#execute_failback">Executing a Failback</a> for more information.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="execute_failback">3.7. Executing a Failback</h3>
<div class="paragraph">
<p>Once you fail over, you can fail back to the primary site when it is active and you have performed the necessary steps to clean the environment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The environment in the primary site is running and has been cleaned, see <a href="#clean">Cleaning the Primary Site</a> for more information.</p>
</li>
<li>
<p>The environment in the secondary site is running, and has active storage domains.</p>
</li>
<li>
<p>A machine running Red Hat Ansible Engine that can connect via SSH to the Engine in the primary and secondary site, with the required packages and files:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>oVirt.disaster-recovery</code> package.</p>
</li>
<li>
<p>The mapping file and required failback playbook.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example uses the <code>dr-rhv-failback.yml</code> playbook created earlier.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run the failback playbook with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">#  ansible-playbook dr-rhv-failback.yml --tags &quot;fail_back&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Enable replication from the primary storage domains to the secondary storage domains.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping_file_attributes">Appendix A: Mapping File Attributes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table describes the attributes in the mapping file that is used to fail over and fail back between the two sites in an active-passive disaster recovery solution.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Mapping File Attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mapping File Section</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Site details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>These attributes map the Engine details in the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_sites_primary_url: <a href="https://manager1.example.redhat.com/ovirt-engine/api" class="bare">https://manager1.example.redhat.com/ovirt-engine/api</a>
dr_sites_primary_username: admin@internal
dr_sites_primary_ca_file: /etc/pki/ovirt-engine/ca.pem

# Please fill in the following properties for the secondary site:
dr_sites_secondary_url: <a href="https://manager2.example.redhat.com/ovirt-engine/api" class="bare">https://manager2.example.redhat.com/ovirt-engine/api</a>
dr_sites_secondary_username: admin@internal
dr_sites_secondary_ca_file: /etc/pki/ovirt-engine/ca.pem</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage domain details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>These attributes map the storage domain details between the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_import_storages:
- dr_domain_type: nfs
  dr_primary_name: DATA
  dr_master_domain: True
  dr_wipe_after_delete: False
  dr_backup: False
  dr_critical_space_action_blocker: 5
  dr_warning_low_space: 10
  dr_primary_dc_name: Default
  dr_discard_after_delete: False
  dr_primary_path: /storage/data
  dr_primary_address: 10.64.100.xxx
  # Fill in the empty properties related to the secondary site
  dr_secondary_dc_name: Default
  dr_secondary_path: /storage/data2
  dr_secondary_address:10.64.90.xxx
  dr_secondary_name: DATA</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>These attributes map the cluster names between the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_cluster_mappings:
  - primary_name: cluster_prod
    secondary_name: cluster_recovery
  - primary_name: fc_cluster
    secondary_name: recovery_fc_cluster</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Affinity group details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>These attributes map the affinity groups that virtual machines belong to. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_affinity_group_mappings:
- primary_name: affinity_prod
  secondary_name: affinity_recovery</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Affinity label details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>These attributes map the affinity labels that virtual machines belong to. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_affinity_label_mappings:
- primary_name: affinity_label_prod
  secondary_name: affinity_label_recovery</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain AAA details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The domain Authentication, Authorization and Accounting (AAA) attributes map authorization details between the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_domain_mappings:
- primary_name: internal-authz
  secondary_name: recovery-authz
- primary_name: external-authz
  secondary_name: recovery2-authz</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Role details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The Role attributes provide mapping for specific roles. For example, if a virtual machine is registered with a user with a <code>VmCreator</code> role, it is possible on failover for the Engine to register a permission for that virtual machine with the same user but with a different role. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_role_mappings:
- primary_name: VmCreator
  Secondary_name: NewVmCreator</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The network attributes map the vNIC details between the primary and secondary site. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_network_mappings:
- primary_network_name: ovirtmgmt
  primary_profile_name: ovirtmgmt
  primary_profile_id: 0000000a-000a-000a-000a-000000000398
  # Fill in the correlated vnic profile properties in the secondary site for profile 'ovirtmgmt'
  secondary_network_name: ovirtmgmt
  secondary_profile_name: ovirtmgmt
  secondary_profile_id:  0000000a-000a-000a-000a-000000000410</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have multiple networks or multiple data centers then you must use an empty network mapping in the mapping file to ensure that all entities register on the target during failover. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_network_mappings:
# No mapping should be here</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">External LUN disk details</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The external LUN attributes allow virtual machines to be registered with the appropriate external LUN disk after failover and failback. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">dr_lun_mappings:
- primary_logical_unit_id: 460014069b2be431c0fd46c4bdce29b66
  primary_logical_unit_alias: Fedora_Disk
  primary_wipe_after_delete: False
  primary_shareable: False
  primary_logical_unit_description: 2b66
  primary_storage_type: iscsi
  primary_logical_unit_address: 10.35.xx.xxx
  primary_logical_unit_port: 3260
  primary_logical_unit_portal: 1
  primary_logical_unit_target: iqn.2017-12.com.prod.example:444
  secondary_storage_type: iscsi
  secondary_wipe_after_delete: False
  secondary_shareable: False
  secondary_logical_unit_id: 460014069b2be431c0fd46c4bdce29b66
  secondary_logical_unit_address: 10.35.x.xxx
  secondary_logical_unit_port: 3260
  secondary_logical_unit_portal: 1
  secondary_logical_unit_target: iqn.2017-12.com.recovery.example:444</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="testing_active_passive">Appendix B: Testing the Active-Passive Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You must test your disaster recovery solution after configuring it. This section provides multiple options to test the active-passive disaster recovery configuration.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Test failover while the primary site remains active and without interfering with virtual machines on the primary site&#8217;s storage domains. See <a href="#discreet_failover">Discreet Failover Test</a>.</p>
</li>
<li>
<p>Test failover and failback using specific storage domains attached to the the primary site, therefore allowing the primary site to remain active. See <a href="#discreet_failover_failback">Discreet Failover and Failback Test</a>.</p>
</li>
<li>
<p>Test failover and failback for an impending disaster where you have a grace period to failover to the secondary site, or an unplanned shutdown of the primary site. See <a href="#non_discreet_failover_failback">Full Failover and Failback test</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that you completed all the steps to configure your active-passive configuration before running any of these tests.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="discreet_failover">B.1. Discreet Failover Test</h3>
<div class="paragraph">
<p>This test simulates a failover while the primary site and all its storage domains remain active, allowing users to continue working in the primary site. To enable this scenario, you must disable replication between the primary storage domains and the replicated (secondary) storage domains. During this test the primary site is unaware of the failover activities on the secondary site.</p>
</div>
<div class="paragraph">
<p>This test will not allow you to test the failback functionality.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that no production tasks are performed after the failover. For example, ensure that email systems are blocked from sending emails to real users, or redirect emails elsewhere. If systems are used to directly manage other systems, prohibit access to the systems or ensure that they access parallel systems in the secondary site.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Performing the discreet failover test:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Disable storage replication between the primary and replicated storage domains, and ensure that all replicated storage domains are in read/write mode.</p>
</li>
<li>
<p>Run the command to fail over to the secondary site:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;fail_over&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <a href="#execute_failback">Executing a Failback</a>.</p>
</div>
</li>
<li>
<p>Verify that all relevant storage domains, virtual machines, and templates are registered and running successfully.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Restoring the environment to its active-passive state:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Detach the storage domains from the secondary site.</p>
</li>
<li>
<p>Enable storage replication between the primary and secondary storage domains.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="discreet_failover_failback">B.2. Discreet Failover and Failback Test</h3>
<div class="paragraph">
<p>For this test you must define testable storage domains that will be used specifically for testing the failover and failback. These storage domains must be replicated so that the replicated storage can be attached to the secondary site. This allows you to test the failover while users continue to work in the primary site.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You should define the testable storage domains on a separate storage server that can be offline without affecting the primary storage domains used for production in the primary site.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information about failing over the environment, cleaning the environment, and performing the failback, see <a href="#execute_failover">Executing a Failover</a>, <a href="#clean">Cleaning the Primary Site</a>, and <a href="#execute_failback">Executing a Failback</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Discreet failover test:</div>
<ol class="arabic">
<li>
<p>Stop the test storage domains in the primary site. You can do this by, for example, shutting down the server host or blocking it with a firewall rule.</p>
</li>
<li>
<p>Disable the storage replication between the testable storage domains and ensure that all replicated storage domains used for the test are in read/write mode.</p>
</li>
<li>
<p>Place the test primary storage domains into read-only mode.</p>
</li>
<li>
<p>Run the command to fail over to the secondary site:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;fail_over&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that all relevant storage domains, virtual machines, and templates are registered and running successfully.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure: Discreet failback test*</div>
<ol class="arabic">
<li>
<p>Run the command to clean the primary site and remove all inactive storage domains and related virtual machines and templates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;clean_engine&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Run the failback command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;fail_back&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Enable replication from the primary storage domains to the secondary storage domains.</p>
</li>
<li>
<p>Verify that all relevant storage domains, virtual machines, and templates are registered and running successfully.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="non_discreet_failover_failback">B.3. Full Failover and Failback test</h3>
<div class="paragraph">
<p>This test performs a full failover and failback between the primary and secondary site. You can simulate the disaster by shutting down the primary site&#8217;s hosts or by adding firewall rules to block writing to the storage domains.</p>
</div>
<div class="paragraph">
<p>For more information about failing over the environment, cleaning the environment, and performing the failback, see <a href="#execute_failover">Executing a Failover</a>, <a href="#clean">Cleaning the Primary Site</a>, and <a href="#execute_failback">Executing a Failback</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Failover test</div>
<ol class="arabic">
<li>
<p>Disable storage replication between the primary and replicated storage domains and ensure that all replicated storage domains are in read/write mode.</p>
</li>
<li>
<p>Run the command to fail over to the secondary site:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;fail_over&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that all relevant storage domains, virtual machines, and templates are registered and running successfully.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure: Failback test</div>
<ol class="arabic">
<li>
<p>Synchronize replication between the secondary site’s storage domains and the primary site’s storage domains. The secondary site’s storage domains must be in read/write mode and the primary site’s storage domains must be in read-only mode.</p>
</li>
<li>
<p>Run the command to clean the primary site and remove all inactive storage domains and related virtual machines and templates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;clean_engine&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Run the failback command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal"># ansible-playbook <em>playbook</em> --tags &quot;fail_back&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Enable replication from the primary storage domains to the secondary storage domains.</p>
</li>
<li>
<p>Verify that all relevant storage domains, virtual machines, and templates are registered and running successfully.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ovirt-legal-notice">Appendix C: Legal notice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Certain portions of this text first appeared in <a href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/html-single/disaster_recovery_guide/index">Red Hat Virtualization 4.4 Disaster Recovery Guide</a>. Copyright © 2022 Red Hat, Inc. Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 Unported License</a>.</p>
</div>
</div>
</div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3069/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3069/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3069/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3069/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=documentation&amp;title=Issue:%20/documentation/disaster_recovery_guide/&amp;template=issue_template_documentation.md' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/documentation/disaster_recovery_guide/index.adoc' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
