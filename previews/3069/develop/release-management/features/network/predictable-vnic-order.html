<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Predictable vNIC Order | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Predictable vNIC Order" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3069/develop/release-management/features/network/predictable-vnic-order.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3069/develop/release-management/features/network/predictable-vnic-order.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Predictable vNIC Order" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Predictable vNIC Order","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3069/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3069/develop/release-management/features/network/predictable-vnic-order.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3069/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3069/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3069/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3069/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3069/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3069/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3069/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3069/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3069/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3069/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3069/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3069//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3069/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Dan Kenigsberg">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3069/documentation/'>Documentation is available here.</a></div>

<h1 id="predictable-vnic-order">Predictable vNIC Order</h1>

<h2 id="summary">Summary</h2>

<p>Make the in-guest order of NICs predictable, given their visual order.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Dan Kenigsberg (danken)</li>
  <li>Email: <a href="mailto:danken@redhat.com">danken@redhat.com</a></li>
  <li>IRC: danken at #ovirt (irc.oftc.net)</li>
</ul>

<h2 id="background">Background</h2>

<p>The term “vNIC order” may mean multiple things to multiple people. Let us enumerate them first:</p>

<table>
  <thead>
    <tr>
      <th>mnemonic</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td>oVirt nic names (nic1,nic2..)</td>
    </tr>
    <tr>
      <td>mac</td>
      <td>mac addresses</td>
    </tr>
    <tr>
      <td>libvirt</td>
      <td>order in libvirt domxml</td>
    </tr>
    <tr>
      <td>pci</td>
      <td>pci addresses</td>
    </tr>
    <tr>
      <td>guest</td>
      <td>guest device names (eth0,p1p2,em1..)</td>
    </tr>
    <tr>
      <td>boot</td>
      <td>bios boot order of nics</td>
    </tr>
  </tbody>
</table>

<h2 id="detailed-description">Detailed Description</h2>

<p>A virtual machine may have multiple network interface cards (vNICs), each connected to profoundly different networks. Users need to know the mapping between [name] and [guest]. If a VM is connected to two networks, RED and BLUE, it is important to tell within the guest which network device leads to which network. It is also important to maintain the [name]-[guest] mapping when cloning a VM from a template.</p>

<p>However, when adding a vNIC, the end user can select her favorite address, and if she hasn’t done so, Engine would draw a random address from a pool of available addresses. In both cases, the [name]-[mac] mapping is random.</p>

<p>oVirt uses the [mac] ordering to pass the devices to [libvirt]. On the first startup of a vNIC in a VM, libvirt assigns it with a [pci] address. [mac] and [pci] are used by the guest operating system to obtain the [guest] name for the vNIC. The latter step depends heavily on the make and version of the the OS. For example, EL5 orders interfaces based on their [mac]; So does EL6 (since biosdevname is disabled in guests); Modern Fedoras and EL7_beta with systemd&gt;=197 use pci addresses; Forgotten ifcfg files and udev.rules affect clones; And a guest admin can always override the name. Bottom line: [mac/pci]-[guest] mapping is a big mess.</p>

<p>Another, somewhat related problem, is the need to control the boot order [boot]. Currently, [boot] matches [mac].</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Assume that we have two networks. RED is classified, and BLUE is public. We would like to have several intrusion detection VMs, monitoring BLUE and sending reports to RED. We create such a VM, find out that eth0 leads to RED and eth1 leads to BLUE, and configure our application appropriately. We create a template from the VM, and clone another VM from it.</p>

<p>Without predictable vNIC order, the cloned VM may have eth0 leading to BLUE, and our IDS would leak information from the classified network to the public one. That’s bad.</p>

<h2 id="possible-solutions">Possible Solutions</h2>

<h3 id="transactional-mac-allocation---chosen-solution">Transactional MAC allocation - Chosen Solution</h3>

<p>mac addresses should not be allocated when a vNIC is first added to the VM. Only when a VM is first run, or is cloned from a template, allocate all addresses and make sure that [mac] matches [name]. This leads to a predictable [name]-[mac]-[pci] mapping, which in sane, clean guests, leads to predictable [name]-[guest].</p>

<p>Cons:</p>

<ul>
  <li>Does not handle plugging (hot or cold) of vNICs after initial run. Consider a VM created with 3 vNICs (nic1, nic2, nic3). If nic2 is removed, and later added, there is no guarantee that it would receive the original mac or pci addresses. It most likely would not receive its original guest name without admin intervension.</li>
</ul>

<!-- -->

<ul>
  <li>Awkward to implement in Engine</li>
</ul>

<!-- -->

<ul>
  <li>Does not give explicit control on [boot], but nic1 boots first on template and on clones.</li>
</ul>

<p>Pros:</p>

<ul>
  <li>Would soothe the pains of most of users.</li>
</ul>

<p>Transactional MAC allocation should take place in the following occasions:</p>

<ul>
  <li>Create Vm from template</li>
  <li>Create Vm from snapshot</li>
  <li>Add Vm dialog</li>
  <li>Import Vm</li>
</ul>

<p>On such the addresses should be allocated to NIC entities based on the original order (on the template, snapshot, or exported Vm). If the information is missing, the MAC order should match the NIC name order.</p>

<h3 id="user-control-on-libvirt-order">User control on libvirt order</h3>

<p>We can expose [libvirt] to the end users, who could then sort vNICs to their liking. On first boot, the [libvirt] order controls [pci], which translates predictably to [guest] on modern Fedoras.</p>

<p>Cons:</p>

<ul>
  <li>Complete solution of boot order must involve disks, cdroms, floppies and usb cards, on top of vNICs.</li>
  <li>No predictability on EL5 and EL6 guests. A user can move a vNIC to the top, it would receive the lowest PCI address and would be booted from, but it may be named <code class="language-plaintext highlighter-rouge">eth7</code>.</li>
</ul>

<h3 id="ovirt-control-on-guest-names">oVirt control on guest names</h3>

<p>Before starting up a VM (and before hot-plugging a vNIC), we could use libguestfs (and guest-side config) to configure ifcfg and udev.rules according to our requested naming.</p>

<p>Pros:</p>

<ul>
  <li>Gives oVirt complete control on [guest]</li>
</ul>

<p>Cons:</p>

<ul>
  <li>Requires intimacy with each guest OS.</li>
  <li>Guests that already have a predictable naming convention are going to suffer unneeded level of complexity.</li>
  <li>Not workable for guests based on the blank template, or when the guest host is re-installed.</li>
</ul>

<h2 id="user-experience">User Experience</h2>

<p>TBD</p>

<h2 id="implementation">Implementation</h2>

<h3 id="rest">REST</h3>

<h3 id="engine">Engine</h3>

<h3 id="vdsm">Vdsm</h3>

<h3 id="guest-agent">Guest Agent</h3>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<h2 id="documentation--external-references">Documentation / External references</h2>

<p>The case for iface name predictability in general</p>

<ul>
  <li><a href="http://fedoraproject.org/wiki/Features/ConsistentNetworkDeviceNaming">http://fedoraproject.org/wiki/Features/ConsistentNetworkDeviceNaming</a></li>
  <li><a href="http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/</a></li>
  <li>
    <p><a href="http://lwn.net/Articles/531850/">http://lwn.net/Articles/531850/</a></p>
  </li>
  <li>On the arch@ovirt.org mailing list.</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3069/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3069/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3069/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3069/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/predictable-vnic-order.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/network/predictable-vnic-order.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
