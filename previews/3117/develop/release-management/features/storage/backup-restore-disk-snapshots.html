<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Backup-Restore Disk-Snapshots | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Backup-Restore Disk-Snapshots" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3117/develop/release-management/features/storage/backup-restore-disk-snapshots.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3117/develop/release-management/features/storage/backup-restore-disk-snapshots.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Backup-Restore Disk-Snapshots" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Backup-Restore Disk-Snapshots","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3117/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3117/develop/release-management/features/storage/backup-restore-disk-snapshots.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3117/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3117/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3117/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3117/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3117/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3117/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3117/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3117/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3117/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3117/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3117/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3117/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3117/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3117/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3117/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3117/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3117/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3117/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3117/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3117/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3117/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3117/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3117//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3117//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3117/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3117/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3117/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3117/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3117/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Daniel Erez">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Daniel Erez</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3117/documentation/'>Documentation is available here.</a></div>

<h1 id="backup-restore-disk-snapshots">Backup-Restore Disk-Snapshots</h1>

<h2 id="summary">Summary</h2>

<p>This feature is a complementary component for providing ability to backup and
restore virtual machines. The feature introduces a support for downloading and
uploading disk-snapshots, using the REST-API. Images transfer is facilitated
using <a href="https://github.com/oVirt/ovirt-imageio">ovirt-imageio</a></p>

<p>The following backup/restore examples are facilitated using oVirt Python-SDK.
oVirt REST-API/SDKs can be used in a similar manner.</p>

<h2 id="backup">Backup</h2>

<h3 id="download-a-vm-ovf">Download a VM OVF</h3>

<p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_vm_ovf.py">Full Example</a></p>

<p>In order to fetch a VM configuration data, ‘all_content’ flag should be specified.
Then, it can be written into a new file - that’s the OVF.
Note: The OVF contains sufficient information about disks and snapshots to restore
the VM to original state (e.g. alias/description/date). However, it isn’t automatically
parsed by the system, but rather should be done by the SDK user.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vm_name</span> <span class="o">=</span> <span class="s">'myvm'</span>
<span class="n">vm</span> <span class="o">=</span> <span class="n">vms_service</span><span class="p">.</span><span class="nb">list</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="s">"name=%s"</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">all_content</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ovf_filename</span> <span class="o">=</span> <span class="s">"%s.ovf"</span> <span class="o">%</span> <span class="n">vm</span><span class="p">.</span><span class="nb">id</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ovf_filename</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ovf_file</span><span class="p">:</span>
    <span class="n">ovf_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">vm</span><span class="p">.</span><span class="n">initialization</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="download-disks">Download Disks</h3>

<p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_all_disk_snapshots.py">Full Example</a></p>

<p>The following example demonstrates the procedure of downloading the non-active disk-snapshots
of a specified disk. Hence, in order to include the active layer as well, either create
a new snapshot for the disk in advance, or download the active disk-snapshot using the<a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_disk.py">Download Disk Example</a></p>

<p>In order to download the active</p>

<ul>
  <li>
    <p>For each disk, iterate over its disk-snapshots and execute image transfer.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Set relevant disk and stroage domain IDs
</span>  <span class="n">disk_id</span> <span class="o">=</span> <span class="s">'ccdd6487-0a8f-40c8-9f45-40e0e2b30d79'</span>
  <span class="n">sd_name</span> <span class="o">=</span> <span class="s">'mydata'</span>

  <span class="c1"># Get a reference to the storage domains service:
</span>  <span class="n">storage_domains_service</span> <span class="o">=</span> <span class="n">system_service</span><span class="p">.</span><span class="n">storage_domains_service</span><span class="p">()</span>

  <span class="c1"># Look up for the storage domain by name:
</span>  <span class="n">storage_domain</span> <span class="o">=</span> <span class="n">storage_domains_service</span><span class="p">.</span><span class="nb">list</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="s">'name=%s'</span> <span class="o">%</span> <span class="n">sd_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

  <span class="c1"># Get a reference to the storage domain service in which the disk snapshots reside:
</span>  <span class="n">storage_domain_service</span> <span class="o">=</span> <span class="n">storage_domains_service</span><span class="p">.</span><span class="n">storage_domain_service</span><span class="p">(</span><span class="n">storage_domain</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>

  <span class="c1"># Get a reference to the disk snapshots service:
</span>  <span class="n">disk_snapshot_service</span> <span class="o">=</span> <span class="n">storage_domain_service</span><span class="p">.</span><span class="n">disk_snapshots_service</span><span class="p">()</span>

  <span class="c1"># Get a list of disk snapshots by a disk ID
</span>  <span class="n">all_disk_snapshots</span> <span class="o">=</span> <span class="n">disk_snapshot_service</span><span class="p">.</span><span class="nb">list</span><span class="p">()</span>

  <span class="c1"># Filter disk snapshots list by disk id
</span>  <span class="n">disk_snapshots</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_disk_snapshots</span> <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">disk</span><span class="p">.</span><span class="nb">id</span> <span class="o">==</span> <span class="n">disk_id</span><span class="p">]</span>

  <span class="c1"># Download disk snapshots
</span>  <span class="k">for</span> <span class="n">disk_snapshot</span> <span class="ow">in</span> <span class="n">disk_snapshots</span><span class="p">:</span>
      <span class="n">download_disk_snapshot</span><span class="p">(</span><span class="n">disk_snapshot</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>The ImageTransfer object should be specified with a ‘snapshot’ attribute.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">transfer</span> <span class="o">=</span> <span class="n">transfers_service</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
      <span class="n">types</span><span class="p">.</span><span class="n">ImageTransfer</span><span class="p">(</span>
          <span class="n">snapshot</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">DiskSnapshot</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">disk_snapshot_id</span><span class="p">),</span>
          <span class="n">direction</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">ImageTransferDirection</span><span class="p">.</span><span class="n">DOWNLOAD</span><span class="p">,</span>
      <span class="p">)</span>
  <span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="restore">Restore</h2>

<p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/upload_disk_snapshots.py">Full Example</a></p>

<h3 id="compose-disk-snapshots-chain">Compose disk-snapshots chain</h3>

<p>Using the saved images files, create a chain of the disk-snapshots.
The chain is built by fetching the volume info (using qemu-img)
of each file, and find the backing filename (volume’s parent).
By maintaing a map between parent and child volumes, we can
construct the chain, starting from base volume.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">volumes_info</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># {filename -&gt; vol_info}
</span>    <span class="n">backing_files</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {backing_file (parent) -&gt; vol_info (child)}
</span>    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">file_names</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">disk_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
            <span class="n">volume_info</span> <span class="o">=</span> <span class="n">get_volume_info</span><span class="p">(</span><span class="s">"%s/%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">disk_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
            <span class="n">volumes_info</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume_info</span>
            <span class="k">if</span> <span class="s">'full-backing-filename'</span> <span class="ow">in</span> <span class="n">volume_info</span><span class="p">:</span>
                <span class="n">backing_files</span><span class="p">[</span><span class="n">volume_info</span><span class="p">[</span><span class="s">'full-backing-filename'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">volume_info</span>

    <span class="n">base_volume</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volumes_info</span><span class="p">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="s">'full-backing-filename'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">backing_files</span><span class="p">[</span><span class="n">base_volume</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]]</span>
    <span class="n">images_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_volume</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">child</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">images_chain</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">child</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]</span> <span class="ow">in</span> <span class="n">backing_files</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">backing_files</span><span class="p">[</span><span class="n">parent</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">images_chain</span>
</code></pre></div></div>

<h3 id="create-disks">Create disks</h3>

<p>For each disk, invoke disk creation for the base image using
the generated images chain from previous step. The content of
the disks will be uploaded in a later step.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">base_image</span> <span class="o">=</span> <span class="n">images_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">initial_size</span> <span class="o">=</span> <span class="n">base_image</span><span class="p">[</span><span class="s">'actual-size'</span><span class="p">]</span>
    <span class="n">provisioned_size</span> <span class="o">=</span> <span class="n">base_image</span><span class="p">[</span><span class="s">'virtual-size'</span><span class="p">]</span>
    <span class="n">image_id</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">base_image</span><span class="p">[</span><span class="s">'filename'</span><span class="p">])</span>

    <span class="n">disk</span> <span class="o">=</span> <span class="n">disks_service</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">types</span><span class="p">.</span><span class="n">Disk</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">disk_id</span><span class="p">,</span>
            <span class="n">image_id</span><span class="o">=</span><span class="n">image_id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">disk_id</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">DiskFormat</span><span class="p">.</span><span class="n">RAW</span><span class="p">,</span>
            <span class="n">provisioned_size</span><span class="o">=</span><span class="n">provisioned_size</span><span class="p">,</span>
            <span class="n">initial_size</span><span class="o">=</span><span class="n">initial_size</span><span class="p">,</span>
            <span class="n">storage_domains</span><span class="o">=</span><span class="p">[</span>
                <span class="n">types</span><span class="p">.</span><span class="n">StorageDomain</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">sd_name</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="add-a-vm-from-ovf">Add a VM from OVF</h3>

<p>Adding the saved VM is done by specifing the ovf data within the configuration element.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">ovf_file_path</span> <span class="o">=</span> <span class="s">'c3a8e806-106d-4aff-b59a-3a113eabf5a9.ovf'</span>
    <span class="n">ovf_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ovf_file_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
    <span class="n">vms_service</span> <span class="o">=</span> <span class="n">system_service</span><span class="p">.</span><span class="n">vms_service</span><span class="p">()</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="n">vms_service</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">types</span><span class="p">.</span><span class="n">Vm</span><span class="p">(</span>
            <span class="n">cluster</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">Cluster</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">'Default'</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">initialization</span> <span class="o">=</span> <span class="n">types</span><span class="p">.</span><span class="n">Initialization</span><span class="p">(</span>
                <span class="n">configuration</span> <span class="o">=</span> <span class="n">types</span><span class="p">.</span><span class="n">Configuration</span><span class="p">(</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="n">types</span><span class="p">.</span><span class="n">ConfigurationType</span><span class="p">.</span><span class="n">OVF</span><span class="p">,</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">ovf_data</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="create-snapshots">Create Snapshots</h3>

<p>For each disk-snapshot in the chain, create a snapshot using the disk ID and image ID
(and optionally the saved description).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Locate the service that manages the snapshots of the virtual machine:
</span>    <span class="n">snapshots_service</span> <span class="o">=</span> <span class="n">vm_service</span><span class="p">.</span><span class="n">snapshots_service</span><span class="p">()</span>

    <span class="c1"># Add the new snapshot:
</span>    <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshots_service</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">types</span><span class="p">.</span><span class="n">Snapshot</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">disk_attachments</span><span class="o">=</span><span class="p">[</span>
                <span class="n">types</span><span class="p">.</span><span class="n">DiskAttachment</span><span class="p">(</span>
                    <span class="n">disk</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">Disk</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">disk_id</span><span class="p">,</span>
                        <span class="n">image_id</span><span class="o">=</span><span class="n">image_id</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></div>

<h3 id="upload-disks">Upload disks</h3>

<p>For each disk-snapshot in the chain, start an upload transfer.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Get a reference to the service that manages the image transfer:
</span>    <span class="n">transfers_service</span> <span class="o">=</span> <span class="n">system_service</span><span class="p">.</span><span class="n">image_transfers_service</span><span class="p">()</span>

    <span class="c1"># Add a new image transfer:
</span>    <span class="n">transfer</span> <span class="o">=</span> <span class="n">transfers_service</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">types</span><span class="p">.</span><span class="n">ImageTransfer</span><span class="p">(</span>
            <span class="n">snapshot</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">DiskSnapshot</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">disk_snapshot_id</span><span class="p">),</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">types</span><span class="p">.</span><span class="n">ImageTransferDirection</span><span class="p">.</span><span class="n">UPLOAD</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get reference to the created transfer service:
</span>    <span class="n">transfer_service</span> <span class="o">=</span> <span class="n">transfers_service</span><span class="p">.</span><span class="n">image_transfer_service</span><span class="p">(</span><span class="n">transfer</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">transfer</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">types</span><span class="p">.</span><span class="n">ImageTransferPhase</span><span class="p">.</span><span class="n">INITIALIZING</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">transfer_service</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proxy_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">transfer</span><span class="p">.</span><span class="n">proxy_url</span><span class="p">)</span>
        <span class="n">proxy_connection</span> <span class="o">=</span> <span class="n">get_proxy_connection</span><span class="p">(</span><span class="n">proxy_url</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">disk_path</span>

        <span class="c1"># Set needed headers for uploading:
</span>        <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'Authorization'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">.</span><span class="n">signed_ticket</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">disk</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="c1"># Extend the transfer session.
</span>                <span class="n">transfer_service</span><span class="p">.</span><span class="n">extend</span><span class="p">()</span>
                <span class="c1"># Set the content range, according to the chunk being sent.
</span>                <span class="n">upload_headers</span><span class="p">[</span><span class="s">'Content-Range'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"bytes %d-%d/%d"</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="c1"># Perform the request.
</span>                <span class="n">proxy_connection</span><span class="p">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="s">'PUT'</span><span class="p">,</span>
                    <span class="n">proxy_url</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">disk</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Print response
</span>                <span class="n">r</span> <span class="o">=</span> <span class="n">proxy_connection</span><span class="p">.</span><span class="n">getresponse</span><span class="p">()</span>
                <span class="k">print</span> <span class="n">r</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">reason</span><span class="p">,</span> <span class="s">"Completed"</span><span class="p">,</span> <span class="s">"{:.0%}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
                <span class="c1"># Continue to next chunk.
</span>                <span class="n">pos</span> <span class="o">+=</span> <span class="n">chunk_size</span>

        <span class="k">print</span> <span class="s">"Completed"</span><span class="p">,</span> <span class="s">"{:.0%}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Finalize the session.
</span>        <span class="n">transfer_service</span><span class="p">.</span><span class="n">finalize</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="appendix">Appendix</h2>

<h3 id="python-sdk-examples">Python SDK examples</h3>

<ul>
  <li>
    <p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_vm_ovf.py">Download VM OVF</a></p>
  </li>
  <li>
    <p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_all_disk_snapshots.py">Download Disk Snapshots</a></p>
  </li>
  <li>
    <p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/upload_disk_snapshots.py">Upload Disk Snapshots</a></p>
  </li>
  <li>
    <p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/download_disk.py">Download Disk</a></p>
  </li>
  <li>
    <p><a href="https://github.com/oVirt/python-ovirt-engine-sdk4/blob/main/examples/upload_disk.py">Upload Disk</a></p>
  </li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3117/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3117/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3117/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3117/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2023 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/backup-restore-disk-snapshots.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/backup-restore-disk-snapshots.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
