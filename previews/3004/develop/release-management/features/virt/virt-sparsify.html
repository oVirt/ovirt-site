<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Virt-Sparsify | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Virt-Sparsify" />
<meta name="author" content="Doron Fediuck" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3004/develop/release-management/features/virt/virt-sparsify.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3004/develop/release-management/features/virt/virt-sparsify.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Virt-Sparsify" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Doron Fediuck" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Doron Fediuck"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Virt-Sparsify","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3004/images/logo.svg"},"name":"Doron Fediuck"},"url":"https://ovirt.github.io/ovirt-site/previews/3004/develop/release-management/features/virt/virt-sparsify.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3004/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3004/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3004/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3004/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3004/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3004/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3004/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3004/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3004/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3004/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3004/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3004/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3004/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3004/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3004/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3004/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3004/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3004/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3004/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3004/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3004/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3004/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3004//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3004//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3004/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3004/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3004/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3004/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3004/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c1c090237aa1d976e9388542299a75f4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Doron Fediuck">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Doron Fediuck</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/7c6257b29245987d17e77cbc4535da1b?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/7c6257b29245987d17e77cbc4535da1b?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Shahar Havivi">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Shahar Havivi</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cd28135f3bdc2a6146213104dfe6bf79?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cd28135f3bdc2a6146213104dfe6bf79?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Shmuel Leib Melamud">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Shmuel Leib Melamud</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3004/documentation/'>Documentation is available here.</a></div>

<h2 id="summary">Summary</h2>
<p>This feature enables the user to run <a href="http://libguestfs.org/virt-sparsify.1.html">virt-sparsify</a> utility on the virtual machine disks. <code class="language-plaintext highlighter-rouge">virt-sparsify</code> removes unused space from a disk image and returns it to storage.</p>

<h2 id="owner">Owner</h2>
<ul>
  <li>Name: Shmuel Melamud</li>
  <li>Email: smelamud@redhat.com</li>
</ul>

<h2 id="detailed-design">Detailed Design</h2>
<h3 id="vdsm">VDSM</h3>

<p>Previously VDSM supported <code class="language-plaintext highlighter-rouge">virt-sparsify</code> in a simple form that created a temporary disk. With the new approach, a temporary disk, location, and extra disk space are not needed, thanks to in-place operation mode of <code class="language-plaintext highlighter-rouge">virt-sparsify</code>.</p>

<p>The new <code class="language-plaintext highlighter-rouge">SDM.sparsify_volume</code> verb was created that runs virt-sparsify asynchronously using storage jobs mechanism. Storage jobs allow the operation to be performed on any host.</p>

<p>Since <code class="language-plaintext highlighter-rouge">virt-sparsify</code> tool cannot leave the volume in corrupted state, there is no need to mark the volume as ILLEGAL before running the tool. Otherwise, if the storage domain becomes unavailable during the operation, the volume will be left in ILLEGAL state and its futher usage will be impossible.</p>

<h3 id="engine">Engine</h3>
<p>Added <code class="language-plaintext highlighter-rouge">SparsifyImageCommand</code> to sparsify the given disk image. This command checks all prerequisites, locks the disk and invokes <code class="language-plaintext highlighter-rouge">SparsifyImageVDSCommand</code>. <code class="language-plaintext highlighter-rouge">SparsifyImageVDSCommand</code> uses <code class="language-plaintext highlighter-rouge">SDM.sparsify_inplace</code> VDSM API call to perform the actual work.</p>

<p>In the REST API, added the <code class="language-plaintext highlighter-rouge">sparsify</code> method to <code class="language-plaintext highlighter-rouge">DiskService</code> that invokes <code class="language-plaintext highlighter-rouge">SparsifyImageCommand</code> on the disk.</p>

<h3 id="ui">UI</h3>
<p>Added “Sparsify” button to Disks subtab of Virtual Machines main tab. This button opens a confirmation dialog to approve sparsification operation and, after the operation is confirmed, invokes <code class="language-plaintext highlighter-rouge">SparsifyImageCommand</code> for the disk selected.</p>

<h3 id="limitations">Limitations</h3>
<ul>
  <li>Only the leaf volume of the image (the active snapshot) can be sparsified.</li>
  <li>If some file existed in previous snapshots and was deleted in the latest snapshot, its space cannot be freed and returned to the storage. In such situations the virtual disk may even become slightly bigger (maximum 0.01% of its size), because sparsification may need more space in the disk’s metadata. To sparsify effectively, merge all snapshots before sparsification.</li>
  <li>The disk cannot have derived disks.</li>
  <li>If the disk is attached to a VM, it must be down.</li>
  <li>Direct LUNs cannot be sparsified.</li>
  <li>Cinder disks cannot be sparsified.</li>
  <li>Pre-allocated disks cannot be sparsified. <code class="language-plaintext highlighter-rouge">virt-sparsify</code> works on pre-allocated disks, but its usage is not justified for this case. User chooses pre-allocated option if she needs better performance, because no additional allocation and no fragmentation will occur when the disk is used. Deallocating some clusters as result of sparsification will overturn this advantage. If user wants to save space at cost of some performance decrease, she can select thin-provisioned option.</li>
  <li>Disks on NFS storage may be sparsified only if NFS version &gt;= 4.2. <strong>Note</strong> <code class="language-plaintext highlighter-rouge">nfs-utils</code> package in RHEL 7.4 contains <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1489262">bug 1489262</a> that prevents NFS storage to be mounted as NFS 4.2. That means that <code class="language-plaintext highlighter-rouge">virt-sparsify</code> will not work on NFS partitions if RHEL 7.4 is installed on the host. This bug is fixed in <code class="language-plaintext highlighter-rouge">nfs-utils-1.3.0-0.49.el7</code> that is planned to be released with RHEL 7.5. A backport to RHEL 7.4.z is requested also.</li>
  <li>
    <p>For an iSCSI volume to be sparsified, support of both host kernel and the actual backing store is required.</p>

    <p>You can verify this support using various SCSI flags reported by the device. These are contained in the SCSI “VPD” data. Run <code class="language-plaintext highlighter-rouge">sg_inq</code> and <code class="language-plaintext highlighter-rouge">sg_vpd</code> (from <code class="language-plaintext highlighter-rouge">sg3_utils</code>) on the device:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ sudo sg_inq -p 0xb0 /dev/sda
 $ sudo sg_vpd -p 0xb2 /dev/sda
</code></pre></div>    </div>

    <p>The LBPRZ and various unmap settings are all relevant.</p>

    <p>See also <a href="https://rwmj.wordpress.com/2014/03/11/blkdiscard-blkzeroout-blkdiscardzeroes-blksecdiscard/">https://rwmj.wordpress.com/2014/03/11/blkdiscard-blkzeroout-blkdiscardzeroes-blksecdiscard/</a></p>
  </li>
</ul>

<h2 id="future-development">Future Development</h2>
<ul>
  <li>Display the actual size of disks (currently we display only the virtual size).</li>
  <li>Add indication that disk needs to be sparsified, if amount of unused space passes a defined threshold.</li>
  <li>Added a user-configurable periodic job that sparsifies disks when needed.</li>
</ul>

<h2 id="current-status">Current Status</h2>
<ul>
  <li>VDSM: Released</li>
  <li>Engine: Released</li>
  <li>UI: Released</li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3004/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3004/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3004/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3004/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/virt-sparsify.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/virt-sparsify.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
