<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>PrestartedVm | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="PrestartedVm" />
<meta name="author" content="Muli Salem" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2653/develop/release-management/features/virt/prestartedvm.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2653/develop/release-management/features/virt/prestartedvm.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PrestartedVm" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Muli Salem" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Muli Salem"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2653/images/logo.svg"},"name":"Muli Salem"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"PrestartedVm","url":"https://ovirt.github.io/ovirt-site/previews/2653/develop/release-management/features/virt/prestartedvm.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2653/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2653/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2653/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2653/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2653/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2653/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2653/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2653/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2653/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2653/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2653/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2653/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2653/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2653/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2653/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2653/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2653/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2653/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2653/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2653/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2653/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2653/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2653/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2653/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2653/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2653/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2653/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2653/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2653/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2653/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2653/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2653/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2653/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2653/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2653/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2653//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2653//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2653/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2653/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2653/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2653/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2653/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/5a3da0b81e7e9b1e1c78621348bdfe11?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/5a3da0b81e7e9b1e1c78621348bdfe11?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Muli Salem</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/92517631861d6438bbc8b312cf9ef0a7?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Oved Ourfali</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c1ff6f0bd87d7886212604a000e4750d?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c1ff6f0bd87d7886212604a000e4750d?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Tomas Dosek</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2653/documentation/'>Documentation is available here.</a></div>

<h1 id="prestarted-vm">Prestarted Vm</h1>

<hr />

<h2 id="summary">Summary</h2>

<p>The Prestarted Vm feature allows holding a predefined number of unassigned ready to use Vms running in a pool.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>
    <p>Feature owner: Muli Salem (msalem)</p>

    <ul>
      <li>
        <p>Backend Component owner: Muli Salem (msalem)</p>
      </li>
      <li>
        <p>GUI Component owner: <a href="User:?"> ?</a></p>
      </li>
      <li>
        <p>REST Component owner: Michael Pasternak (mpasternak)</p>
      </li>
      <li>
        <p>QA Owner: Tomas Dosek (Tdosek)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Email: msalem@redhat.com</p>
  </li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Status: Engine-done, API-done, GUI-design, QA-test plans ready and reviewed</li>
  <li>Last updated date: Tue Dec 27 2011:</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<ol>
  <li>Today there are 2 types of Vm pools:
    <ol>
      <li>Manual - the Vm is supposed to be manually returned to the pool. In practice, this is not really entirely supported.</li>
      <li>Automatic - once the user shuts down the Vm - it returns to the pool (stateless).</li>
    </ol>
  </li>
</ol>

<p><strong>The prestarted Vm feature will deal with Automatic Vm pools.</strong></p>

<p>In ovirt, a VmPool is created based on a specific template. A Vm in the pool can either be assigned to a specific user or be in shutdown state. Therefore, when an admin assigns a Vm to a user, the Vm needs to boot before the user can begin using it.</p>

<p>The prestarted Vm will maintain a number of Vms that are running and not assigned to a specific user (unassigned). This will be at a “best effort” basis, meaning there may be cases in which the number of prestarted Vms will be smaller than the amount defined by the admin.</p>

<h2 id="benefit-to-ovirt">Benefit to ovirt</h2>

<p>The prestarted Vms will allow instant assignment of a Vm from the pool to a user without the user needing to wait for the Vm to start.</p>

<h2 id="prd">PRD</h2>

<p>The requirements are the following:</p>

<ol>
  <li>Enable a Vm in a pool to be both running and unassigned to a specific user.</li>
  <li>Maintain a minimal amount of prestarted Vms, that are running and waiting to be assigned.
    <ol>
      <li>The number of prestarted Vms is a new VMpool property. This number can be changed after Vm pool was already created. In case it is changed, the system is not required to shutdown prestarted Vms, but rather this will be done manually by the admin if necessary.</li>
      <li>The maximum number of prestarted Vms is the size of the VmPool.</li>
    </ol>
  </li>
  <li>When a Vm is shut down its base snapshot is restored and it is returned to the pool (no change in behaviour here).</li>
  <li>The prestarted Vms creation does not have to begin immediately upon pool creation, but rather can be happen periodically.</li>
</ol>

<h2 id="design">Design</h2>

<p>Current flow:</p>

<ol>
  <li>When running Vm from administrator - the RunVm command is called. The changes he makes actually stay on the Vm even after shutdown.</li>
  <li>When running Vm from user portal - AttachUserToVmFromPoolAndRunCommand executes, which runs the addPermission + CreateAllSnapshotsFromVm. On endSuccessfully the RunVm command runs. When Vm is shut down - VmPoolHandler.ProcessVmPoolOnStopVm(vmId) -&gt; removePermission + RestoreAllSnapshots.</li>
</ol>

<p>New Design:</p>

<ol>
  <li>Adding a prestarted_vms field to each VmPool.
    <ol>
      <li>This field is configurable upon Vmpool creation by the admin, and has a default value of 0;</li>
      <li>It can be edited after the pool has been created. In case an admin lowers the minimum number, the “extra” Vms will not be shutdown. He will be supplied with the following message:</li>
    </ol>
  </li>
</ol>

<p><em>The prestarted Vms will not be shut down automatically.</em></p>

<p><span style="color:Teal"><strong>prestarted_vms</strong></span>:
{|class=”wikitable sortable” !border=”1”| Column Name ||Column Type ||Null? / Default ||Description |- |prestarted_vms || smallint ||not null / default 0 ||The minimum number of prestarted vms |- |}</p>

<ul>
  <li>We also need to add this column to vm_pools_view and vm_pools_full_view.</li>
</ul>

<p><strong>VmPoolMonitor</strong>
Maintaining the number of prestarted will be done periodically. The periodic approach was chosen since it avoids relying on the different stages in the VmPool’s life cycle. There will be a job that runs every x minutes. x is defined in vdc_options in a new row called VmPoolRefreshRate. A new property needs to be added to the engine-config.properties file. The default will be 2 minutes. The job will go over each pool, check whether there are enough prestarted Vms running. If not, it will start the needed amount.</p>

<p>We will the following config values for this job: <span style="color:Teal"><strong>prestarted_vms</strong></span>:
{|class=”wikitable sortable” !border=”1”| config key || config type ||Null? / Default ||Description |- |VmPoolMonitorBatchSize || smallint ||5||The maximum amount of vms that will be prestarted in a single run of the VmPoolMonitor |- |VmPoolMonitorIntervalInMinutes || smallint ||5||The size of interval between VmPoolMonitor runs |- |VmPoolMonitorMaxAttempts || smallint ||3||The number of attempts that are made to prestart a Vm |}</p>

<ul>
  <li>This option can be optimized by triggering the job upon certain events. Events that should trigger: addVmPool, AttachUserToVmFromPoolCommand…?</li>
</ul>

<p><strong>Algorithm for selecting a Vm for user</strong></p>

<hr />

<ol>
  <li>A vm will be assigned to a user in the following priority:
    <ol>
      <li>
        <ol>
          <li>The Vm is up</li>
          <li>is not running by the admin (Can be deduced from the images status?)</li>
          <li>is not given to another user</li>
        </ol>
      </li>
      <li>Current assignment:
        <ol>
          <li>The Vm is down</li>
          <li>is not given to a user</li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p><strong>Algorithm for maintaining number of prestarted Vms</strong></p>

<hr />

<ol>
  <li>The Prestarted Vm Job counts the number of Vms that:
    <ol>
      <li>
        <ol>
          <li>Are running (*) not by the admin</li>
          <li>are not assigned to a user</li>
        </ol>
      </li>
      <li>If there are not enough of them, he looks for Vms that are:
        <ol>
          <li>down</li>
          <li>not assigned to a user</li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p>The implementation will be as follows:</p>

<ol>
  <li>The AttachUserToVmFromPoolAndRunCommand and AttachUserToVmFromPoolCommand will be combined to one command named AllocateVmFromPoolCommand.</li>
  <li>A new command called PrepareVmForUse will be added. The command will run the CreateAllSnapshotsFromVmCommand, and upon ending successfully will run RunVm. The command will be used both by the command in the previous clause, and by the scheduler that prepares prestarted vms.</li>
  <li>We will add a flow that checks if there are available prestarted Vms. If so, do only “AddPermission”. If no prestarted Vms were found, run AddPermission + PrepareVmForUse.</li>
</ol>

<h3 id="rest-api">REST API</h3>

<p>A new integer property, “prestarted_vms”, was added to the VmPool resource</p>

<h2 id="affected-commands">Affected Commands</h2>

<ol>
  <li>AttachUserToVmFromPoolCommandAndRun + AttachUserToVmFromPoolCommandAndRun - As explained above.</li>
  <li>AddVmPoolCommand - no change since the parameter held is of type vm_pools.</li>
  <li>UpdateVmPoolCommand - no change since the parameter held is of type vm_pools.</li>
  <li>RemoveVmPoolCommand - no change since the parameter held is of type vm_pools.</li>
</ol>

<h2 id="open-issues">Open Issues</h2>

<ol>
  <li>
    <ul>
      <li>We need to define what the scheduler counts to be as a prestarted vm (only up, maybe VM.isStatusQualifyToMigrate() which includes Up, PoweringUp, Paused, RebootInProgress)</li>
    </ul>
  </li>
  <li>We need to decide whether we take the periodic approach (with or without optimization), or the event driven one.</li>
</ol>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>Affected rhevm projects:</p>

<ul>
  <li>API</li>
  <li>CLI</li>
  <li>backend</li>
  <li>Webadmin</li>
  <li>User Portal</li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<hr />




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2653/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2653/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2653/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2653/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/prestartedvm.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/prestartedvm.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
