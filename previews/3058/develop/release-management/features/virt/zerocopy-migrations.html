<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Zero-copy migrations | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Zero-copy migrations" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3058/develop/release-management/features/virt/zerocopy-migrations.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3058/develop/release-management/features/virt/zerocopy-migrations.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Zero-copy migrations" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Zero-copy migrations","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3058/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3058/develop/release-management/features/virt/zerocopy-migrations.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3058/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3058/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3058/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3058/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3058/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3058/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3058/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3058/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3058/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3058/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3058/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3058/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3058/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3058/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3058/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3058/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3058/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3058/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3058/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3058/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3058/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3058/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3058//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3058//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3058/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3058/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3058/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3058/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3058/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Milan Zamazal">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Milan Zamazal</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3058/documentation/'>Documentation is available here.</a></div>

<h1 id="zero-copy-migrations">Zero-copy migrations</h1>

<h2 id="summary">Summary</h2>

<p>This feature adds support for zero-copy migrations.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Milan Zamazal</li>
  <li>Email: mzamazal@redhat.com</li>
</ul>

<h2 id="description">Description</h2>

<p>Zero-copy migrations further improve migration speed and may allow migrating large VMs (&gt;1 TB RAM).</p>

<p>Zero-copy migrations can be enabled by passing <code class="language-plaintext highlighter-rouge">VIR_MIGRATE_ZEROCOPY</code> flag to <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainMigrateToURI3">virDomainMigrateToURI3</a> libvirt call.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Nothing special, just up-to-date libvirt and QEMU.</p>

<h2 id="limitations">Limitations</h2>

<p>Current implementation of zero-copy migration in QEMU has some restrictions:</p>

<ul>
  <li>
    <p>It can be used only with <a href="parallel-migration-connections.html">parallel migrations</a> and thus the same limitations as for parallel migrations apply.</p>
  </li>
  <li>
    <p>It cannot be used with migration encryption.</p>
  </li>
  <li>
    <p>QEMU must be permitted to lock guest RAM pages in memory (libvirt takes care of this unless memory limits are set manually in <code class="language-plaintext highlighter-rouge">&lt;memtune&gt;</code>.</p>
  </li>
  <li>
    <p>This is a new feature in QEMU/libvirt and may contain bugs.  It’s not recommended to use it in oVirt at the moment it unless it is really needed.</p>
  </li>
  <li>
    <p>Vdsm, libvirt and QEMU on the migration source host must support the feature.</p>
  </li>
</ul>

<h2 id="user-experience">User experience</h2>

<p>A new migration policy <em>Very large VMs</em> is introduced in cluster migration options.  If this policy is selected, zero-copy migrations are enabled (unless other settings prevent it, see below) and other migrations parameters specified in the policy are applied (this allows using migrations parameters such as downtime schedule customized for such migrations).  The policy is available only when parallel migrations are enabled in Engine config (i.e. on cluster level 4.7 by default).</p>

<p>Since the policy is aimed at very large VMs where short downtimes are unlikely to suffice, especially if the other migration policies are insufficient to migrate the VM, it sets longer initial downtimes.  Autoconverge is enabled; although very large VMs are supposed to be mostly idle when being migrated and thus autoconverge doesn’t help much, having it enabled may be still useful to migrate busy large (although not very large) VMs.</p>

<p>If this policy is selected while the <a href="#limitations">limitations above</a> are not satisfied then:</p>

<ul>
  <li>
    <p>If parallel migrations are disabled or only conditionally enabled (“Auto”) then they are enabled with automatic number of parallel connections.</p>
  </li>
  <li>
    <p>If migration encryption is enabled then zero-copy is not enabled.</p>
  </li>
</ul>

<p>If the policy is selected and the host doesn’t support the feature then:</p>

<ul>
  <li>If Vdsm doesn’t support the feature, API call mismatch is logged and zero-copy is not enabled.</li>
</ul>

<p>This applies only when parallel migrations are enabled in Engine config (cluster level 4.7 by default) and the host is not up-to-date.</p>

<p>In all the cases, VM migration proceeds, although with different parameters.</p>

<h2 id="testing">Testing</h2>

<p>It should be tested that when the policy above is selected and the limitations above are satisfied then <code class="language-plaintext highlighter-rouge">VIR_MIGRATE_ZEROCOPY</code> flag is passed to the libvirt migration call.</p>

<h2 id="changes-to-engine-and-vdsm">Changes to Engine and Vdsm</h2>

<p><code class="language-plaintext highlighter-rouge">VM.migrate</code> Vdsm API call gets an additional boolean parameter <code class="language-plaintext highlighter-rouge">zerocopy</code>.  Iff it is set to true, zero-copy migration flag is passed to the libvirt migration call.  It is responsibility of the caller (Engine) to pass a correct combination of migration parameters to <code class="language-plaintext highlighter-rouge">VM.migrate</code>; if this is not satisfied the migration may fail.</p>

<p>Vdsm adds functionality for processing the parameter and passing the corresponding flag and parameter to the libvirt migration call.</p>

<p>Engine adds the new migration policy.  The policy contains a new policy boolean argument <code class="language-plaintext highlighter-rouge">zerocopy</code>.  In case the argument is set to true, Engine ensures the contingent requirement conflicts are silently resolved as described in <a href="#user-experience">User experience</a> above.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3058/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3058/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3058/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3058/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/zerocopy-migrations.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/virt/zerocopy-migrations.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
