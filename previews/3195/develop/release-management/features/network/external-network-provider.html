<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>External Network Providers | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="External Network Providers" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3195/develop/release-management/features/network/external-network-provider.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3195/develop/release-management/features/network/external-network-provider.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="External Network Providers" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"External Network Providers","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3195/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3195/develop/release-management/features/network/external-network-provider.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3195/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3195/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3195/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3195/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3195/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3195/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3195/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3195/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3195/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3195/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3195/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3195/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3195/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3195/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3195/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3195/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3195/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3195/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3195/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3195/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3195/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3195/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3195//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3195//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3195/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3195/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3195/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3195/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3195/develop/release-management/features/network/">
              <span property="name">Network</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Marcin Mirecki">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Marcin Mirecki</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3195/documentation/'>Documentation is available here.</a></div>

<h1 id="external-network-providers">External Network Providers</h1>

<h2 id="summary">Summary</h2>

<p>Currently it is possible to integrate oVirt with Openstack Neutron (using  the
“Openstack Neutron Integration” feature). The purpose of this feature is to
simplify this and to make it easier to add support for networks supplied by
external providers. The providers will be able to provide networks using a
simplified Neutron-like API.</p>

<h3 id="owner">Owner</h3>

<ul>
  <li>Feature Owner: Marcin Mirecki: mmirecki (mmirecki)</li>
  <li>Email: <a href="mailto:mmirecki@redhat.com">mmirecki@redhat.com</a></li>
</ul>

<h3 id="benefit-to-ovirt">Benefit to oVirt</h3>

<p>oVirt VMs will be able to use networks definded by external providers.
oVirt will provide an API for the external providers (vendors of Software Defined
Networking products) allowing them to easily integrate with oVirt.</p>

<h2 id="detailed-description">Detailed Description</h2>

<p>Many organizations use centralized network management systems to handle all
their networking, and would like them to manage the network topology of
their oVirt environments.
Currently the only option of using external networks in oVirt is to use the
OpenStack Neutron integration, which allows the import of OpenStack Neutron
networks and the provisioning of VM’s connected to these networks.
This feature is however very specific to OpenStack Neutron and tied to its Linux bridge and OVS plugins.
We would like to extend this functionality to other external network providers,
by making it simpler, more general and less dependant on OpenStack Neutron features.
The result should be an API over which oVirt can communicate with an external
network management systems, and use the networks defined in them in provisioned VMs.</p>

<p>For information about OpenStack Neutron integration please refer to:
<a href="/ovirt-site/previews/3195/develop/release-management/features/network/osn-integration.html">OSN Integration</a>
<a href="/ovirt-site/previews/3195/develop/release-management/features/network/detailed-osn-integration.html">Detailed OSN Integration</a></p>

<h3 id="differences-from-openstack-neutron-integration">Differences from OpenStack Neutron Integration</h3>

<ul>
  <li>
    <p>hiding of UI features related to OpenStack Neutron, such as tenants and OpenStack Neutron driver details
<img src="/ovirt-site/previews/3195/images/wiki/external_network_provider_import_dialog_changes.png" alt="" /></p>
  </li>
  <li>
    <p>simplified REST API. Base on the OpenStack Neutron API, but simplified to contain
only a subset of its schema which is relevant to the external network providers.
This will require a rework of the UI and REST API layer.</p>
  </li>
  <li>
    <p>read-only mode for external network</p>
  </li>
  <li>
    <p>(optionally) read-only mode for subnets</p>
  </li>
  <li>
    <p>VIF driver - the implementation of the VIF driver is now completely the responsibility
of the external network provider</p>
  </li>
  <li>
    <p>No special handling of OpenStack Neutron agent. - since the VIF driver implementation is provider dependent,
the OpenStack Neutron agent is not a part of the solution anymore (unless the provider
decides otherwise)</p>
  </li>
  <li>
    <p>VIF driver reference implementation - a sample VIF driver showing a simple implementation is provided</p>
  </li>
</ul>

<h3 id="main-functional-parts-of-the-system">Main functional parts of the system</h3>
<p>The API for external network providers consists of 3 main parts:</p>

<ol>
  <li>External network provider administration.
  This allows to perform admistrative tasks:
    <ul>
      <li>connecting to a new network provider (External Providers -&gt; Add)</li>
      <li>importing networks from an external provider (External Providers -&gt; Networks Subtab -&gt; Import)</li>
      <li>removing a network (Networks -&gt; Remove)</li>
      <li>adding a new subnet pool (Networks -&gt; Subnets tab -&gt; New)</li>
      <li>removing a subnet pool (Networks -&gt; Subnets tab -&gt; Remove)</li>
    </ul>
  </li>
  <li>
    <p>Communication with an external provider at VM provisioning time.
This is reponsible for exchanging information with the external provider when a new VM NIC is
created/changed/removed and is connected/disconnected to/from and external networks.</p>
  </li>
  <li>VIF Driver
The virtual interface driver is a driver provided by the external provider which implements
the connecting of VM NICs to external networks.</li>
</ol>

<h3 id="data-structure">Data structure</h3>

<p>The data structure of an external network provider:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="err">provider:</span><span class="p">{</span><span class="w">
        </span><span class="err">name:</span><span class="w"> </span><span class="s2">"&lt;network name&gt;"</span><span class="w">
        </span><span class="err">url:</span><span class="w">
        </span><span class="err">networks:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ACTIVE"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;id of network in external provider&gt;"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"subnets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;subnet name&gt;"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"enable_dhcp"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"network_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"59b48a4c-893c-47d2-9df3-84102329bbb9"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"dns_nameservers"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="nl">"gateway_ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.1"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"ipv6_ra_mode"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"allocation_pools"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                            </span><span class="p">{</span><span class="w">
                                </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.2"</span><span class="p">,</span><span class="w">
                                </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.254"</span><span class="w">
                            </span><span class="p">}</span><span class="w">
                        </span><span class="p">],</span><span class="w">
                        </span><span class="nl">"host_routes"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="nl">"ip_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"ipv6_address_mode"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"cidr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.0/24"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6ed90628-5d9c-4eae-8665-0b2420e683d4"</span><span class="p">,</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="err">...</span><span class="w">
		</span><span class="p">],</span><span class="w">
                </span><span class="err">ports:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nic5"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"device_owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oVirt"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"49ccb785-eadb-469d-8c33-e7bc87d37e4e"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"network_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bf864bf3-81d8-438d-bf68-4b0c357309b3"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"device_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5cc10431-0b25-41bd-941c-3a1aed8edd87"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"mac_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:1a:4a:16:01:59"</span><span class="w">
                        </span><span class="err">...</span><span class="w">
                        </span><span class="err">&lt;more</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">added</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="err">required&gt;</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="err">...</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="user-work-flows">User work-flows</h2>

<p>The user flows in the UI will mostly match the flows of “OpenStack Networking”</p>

<h3 id="external-network-provider-administration">External network provider administration</h3>

<h4 id="adding-an-external-network-provider">Adding an external network provider</h4>

<p>The external provider will be added from “External Providers”.
The UI Panel for adding a new external network provider will look as follows:
<img src="/ovirt-site/previews/3195/images/wiki/external_network_provider_add.png" alt="" />
This will add the provider to the list of external providers.</p>

<h6 id="read-only-option">Read only option</h6>
<p>When the read only option is chosen, all the configuration items related to this provider will be read-only.
This includes:</p>

<ul>
  <li>
    <p>no subnetworks can be added or removed</p>
  </li>
  <li>
    <p>when an external network is deleted, the option to remove it from a provider will be disabled.</p>
  </li>
</ul>

<p>Creating and deleting of ports must be allowed as it is required to create and distroy VM NICs.</p>

<h4 id="importing-networks-from-external-provider-into-ovirt-ui">Importing networks from external provider into oVirt (UI)</h4>
<p>This opens a dialog where networks from the external provider can be imported.
Each external network is identified by an “id” given by the external provider.</p>

<p>Same as OpenStack Neutron Integration</p>

<p>External network provider interactions:</p>

<ul>
  <li>get all network from the external providers (<code class="language-plaintext highlighter-rouge">GET networks</code>)</li>
</ul>

<h4 id="delete-external-network">Delete external network</h4>

<p>An external network is deleted (Networks -&gt; Remove).
Same as OpenStack Neutron Integration</p>

<p>External network provider interactions:
When the “Remove network(s) from the external provider(s) as well.” ceckbox is checked:</p>

<ul>
  <li>delete network (<code class="language-plaintext highlighter-rouge">DELETE networks</code>)</li>
</ul>

<h4 id="subnets-management-ui">Subnets management (UI)</h4>
<p>Same as OpenStack Neutron Integration</p>

<p>The oVirt “Networks” tab has a “Subnets” subtab (only available for external
networks), which can be used to list/add/remove the subnets of an external network.</p>

<p>External network provider interactions when adding a subnet (Networks -&gt; Subnets tab -&gt; New):</p>

<ul>
  <li>Get network (<code class="language-plaintext highlighter-rouge">GET networks/&lt;id&gt;</code>)</li>
  <li>Add subnet (<code class="language-plaintext highlighter-rouge">POST subnets</code>)</li>
</ul>

<p>External network provider interactions when removing a subnet (Networks -&gt; Subnets tab -&gt; Remove):</p>
<ul>
  <li>Add subnet (<code class="language-plaintext highlighter-rouge">DELETE subnets/&lt;id&gt;</code>)</li>
</ul>

<p>Opening the subnets subtab causes a request for the list of subnets</p>
<ul>
  <li>Get subnets (<code class="language-plaintext highlighter-rouge">GET subnets</code>)</li>
</ul>

<h4 id="setup-networks-dialog-ui---optional">Setup networks dialog (UI) - optional</h4>

<p>External network providers may depend on prior host-level connectivity. For example,
OpenStack Neutron needs to be configured to use a specific bond (or NIC) for its VM networks. The network partner may ship a network_setup vdsm hook to integrate this configuration into the setup network dialog. For example, a custom property named “underlay” may be added to a network, which is attached to a bond0. When applied to the host, the hook script would do the necessary configuration to Neutron plugin so the “underlay” network’s bond is used.</p>

<h3 id="vm-nic-lifecycle">VM NIC lifecycle</h3>

<p>The most important function of this feature is to handle the lifecycle of
VM NICs connected to a network defined outside of oVirt.</p>

<h4 id="vm-nic-provisioning">VM NIC provisioning</h4>

<p>When a new nic is added to a VM the following actions are being executed:</p>

<p>Port allocation:</p>

<ul>
  <li>the engine checks if the port for the VM NIC exists (<code class="language-plaintext highlighter-rouge">GET ports</code>)</li>
  <li>if no port exists, the engine will create a new port (<code class="language-plaintext highlighter-rouge">POST ports</code>)</li>
  <li>if the port already exists, the engine will update it with information
about new allocation (‘POST ports’)</li>
  <li>in both cases the new/updated port is identified by a <code class="language-plaintext highlighter-rouge">&lt;PORT ID&gt;</code> returned
by the external network provider</li>
  <li>the engine will send a nic plug request to VDSM, passing the <code class="language-plaintext highlighter-rouge">&lt;PORT ID&gt;</code>
as one of the parameters. The <code class="language-plaintext highlighter-rouge">&lt;PORT ID&gt;</code> is passed to the VIF driver as  a “vnic_id”
parameter.</li>
  <li>on VDSM, the VIF Driver, invoked using the VDSM before_nic_hotplug hook,
will connect the VM NIC to the network provided by the external provider</li>
</ul>

<p><img src="/ovirt-site/previews/3195/images/wiki/external_network_provider_schema1.png" alt="" /></p>

<p>Additional parameters used to identify the external network provider and the specific
port which is to be connected are passed to the VIF driver when provisioning a nic.</p>

<ul>
  <li>vnic_id - the external id of the port which is to be connected</li>
  <li>provider_type - type of provider, in case of external network providers this will always be “EXTERNAL_NETWORK”</li>
</ul>

<p>Under consideration:</p>

<ul>
  <li>custom properties defined when an external network provider is added</li>
  <li>a property used to identify the VIF driver used to handle the NIC provisioning. This would be helpful
in case of automatic deployment of VIF drivers on new hosts.</li>
</ul>

<h4 id="vm-nic-unplug">VM NIC unplug</h4>

<p>When the nic is unplugged from the VM, the following actions are being executed:</p>

<ul>
  <li>on VDSM, the VIF Driver, invoked using the VDSM before_nic_hotunplug hook,
will unplug the VM NIC from the network provided by the external provider.
The nic is identified by the same <code class="language-plaintext highlighter-rouge">&lt;PORT ID&gt;</code> a during nic plug</li>
</ul>

<h4 id="vm-nic-delete">VM NIC delete</h4>

<p>When a nic is already unplugged, it can be deleted from a VM. This will trigger the following actions:</p>

<ul>
  <li>the engine will try to locate the port on the external provider (<code class="language-plaintext highlighter-rouge">GET ports</code>)</li>
  <li>the engine will delete the port from the external provider (<code class="language-plaintext highlighter-rouge">DELETE ports</code>)</li>
</ul>

<h4 id="migrate-a-vm-to-another-host">Migrate a VM to another host</h4>

<p>When a VM is migrated to another host the following actions are executed:</p>

<ul>
  <li>the VIF driver, invoked by the VDSM before_migration_source disconnects the
NIC from the external network on the source VDSM</li>
  <li>the VIF driver, invoked by the VDSM before_migration_destination connects
the NIC ti\o the external network on the destination VDSM</li>
</ul>

<h4 id="vm-nic-provisioning-synchronization-issues">VM NIC provisioning synchronization issues</h4>

<p>Care must be taken for the VIF driver to leave the networking operations in a finished state before exiting.
For example should a VIF driver just initiate connecting a VM NIC during VM
startup and exit, the connecting operation could still not be finished when
the VM starts up and leave it booting without a network connection.</p>

<p>A reference to the problem in OpenStack Neutron:
https://blueprints.launchpad.net/neutron/+spec/nova-event-callback</p>

<h2 id="external-networks-rest-api">External networks REST API</h2>

<p>The communication between the engine and the external network provider is
done using a REST API based on this of OpenStack neutron. Only a subset of
the Neutron API is used.</p>

<p>The REST API uses the following operations:</p>

<p>Required tokens:
<code class="language-plaintext highlighter-rouge">headers={Content-Type=[application/json], x-openstack-request-id=[&lt;authentication token&gt;]}</code></p>

<p>Authentication (optional):</p>

<ul>
  <li>authenticate: <code class="language-plaintext highlighter-rouge">POST: http://host:35357/v2.0/tokens</code></li>
</ul>

<p>Request:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"auth"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"passwordCredentials"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;user&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="p">}}}</span><span class="w">
</span><span class="err">Response:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="nl">"access"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;token&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>tets connection: <code class="language-plaintext highlighter-rouge">GET: http://host:9696/v2.0/</code></li>
</ul>

<p>Networks:</p>

<ul>
  <li>
    <p>network details: <code class="language-plaintext highlighter-rouge">GET: http://host:9696/v2.0/network/&lt;network id&gt;</code></p>
  </li>
  <li>
    <p>list networks: <code class="language-plaintext highlighter-rouge">GET: http://host:9696/v2.0/networks</code></p>
  </li>
  <li>
    <p>delete a network: <code class="language-plaintext highlighter-rouge">DELETE: http://host:9696/v2.0/networks</code></p>
  </li>
</ul>

<p>Ports:</p>

<ul>
  <li>
    <p>list ports: <code class="language-plaintext highlighter-rouge">GET: http://host::9696/v2.0/ports</code>   (Check if port exists)</p>
  </li>
  <li>
    <p>port details:  <code class="language-plaintext highlighter-rouge">GET: http://host::9696/v2.0/ports/&lt;port id&gt;</code></p>
  </li>
  <li>
    <p>add a port: <code class="language-plaintext highlighter-rouge">POST:  http://host::9696/v2.0/ports/&lt;port id&gt;</code></p>
  </li>
  <li>
    <p>delete port: <code class="language-plaintext highlighter-rouge">DELETE:  http://host::9696/v2.0/ports/&lt;port id&gt;</code></p>
  </li>
</ul>

<p>Subnets:</p>

<ul>
  <li>
    <p>list subnets: <code class="language-plaintext highlighter-rouge">GET: http://host:9696/v2.0/subnets</code></p>
  </li>
  <li>
    <p>adding a subnet: <code class="language-plaintext highlighter-rouge">POST: http://host:9696/v2.0/subnets</code></p>
  </li>
  <li>
    <p>deleting a subnet: <code class="language-plaintext highlighter-rouge">DELETE: http://host:9696/v2.0/network/&lt;network id&gt;</code></p>
  </li>
</ul>

<h2 id="vif-driver-prepared-by-the-external-network-provider">VIF driver (prepared by the external network provider)</h2>

<p>The “virtual interface driver” will be a set of scripts provided by the external network provider which will facilitate the network operations related to an external network on a host (VDSM).
The operations include:</p>

<ul>
  <li>
    <p>setting up the external network on the host</p>
  </li>
  <li>
    <p>creating and attaching a VM NIC to an external network</p>
  </li>
  <li>
    <p>deleteing and detaching a VM NIC from an external network</p>
  </li>
  <li>
    <p>hotplugging a NIC</p>
  </li>
  <li>
    <p>unplugging a NIC</p>
  </li>
  <li>
    <p>VM migration</p>
  </li>
  <li>
    <p>reporting the external network and it’s relations to any host NIC to the engine</p>
  </li>
  <li>
    <p>reporting VM NIC statistics to the engine</p>
  </li>
</ul>

<p>The VIF driver will be notified about any life-cycle events relevant to external
networks by means of the VDSM “hooks”.
VDSM Hooks are a means to insert arbitrary commands and scripts at certain point
in a VM’s lifecycle as well as in VDSM daemon’s lifecycle.</p>

<p>The following hooks are relevant to the external networks:</p>

<h4 id="before_device_createafter_device_create">before_device_create/after_device_create</h4>
<p>Called before/after a device (in this case a NIC) is created.
Network provider reponsibilities:</p>

<ul>
  <li>
    <p>make sure the network exists on this host</p>
  </li>
  <li>
    <p>connect the VM NIC to the specified external network</p>
  </li>
</ul>

<h4 id="before_nic_hotplugafter_nic_hotplug">before_nic_hotplug/after_nic_hotplug</h4>
<p>Called before/after a nic is hot plugged.
Network provider reponsibilities:</p>

<ul>
  <li>
    <p>make sure the network exists on this host</p>
  </li>
  <li>
    <p>connect the VM NIC to the specified external network</p>
  </li>
</ul>

<h4 id="before_nic_hotunplug">before_nic_hotunplug</h4>
<p>Called before a nic is hot unplugged.
Network provider reponsibilities:</p>

<ul>
  <li>unplug the VM NIC from the external network (if required)</li>
</ul>

<h4 id="before_vm_migration_source">before_vm_migration_source</h4>
<p>Called on the source host before a VM is migrated.
Network provider reponsibilities:</p>

<ul>
  <li>unplug the VM NIC from the external network (if required)</li>
</ul>

<h4 id="before_vm_migration_destination">before_vm_migration_destination</h4>
<p>Called on the destination host before a VM is migrated.
Network provider reponsibilities:</p>

<ul>
  <li>
    <p>make sure the network exists on this host</p>
  </li>
  <li>
    <p>connect the VM NIC to the specified external network</p>
  </li>
</ul>

<h4 id="after_get_stats">after_get_stats</h4>
<p>Called after generating the network statistics which are to be send to the engine
Network provider reponsibilities:</p>

<ul>
  <li>provide the statistics for the VM NIC attached to the external network</li>
</ul>

<h4 id="after_get_caps">after_get_caps</h4>
<p>Called after generating the host capabilites (host configuration) which are to be send to the engine.
Network provider reponsibilities:</p>

<ul>
  <li>provider information about the host network configuration related to the external network.
Depending on the implementation, the provider might want report the external network being
attached to any of the host NICS, report the external network being attached to a virtual host
NIC, hide some host NICs used by the external network implementation, or report any other implemented configuration.</li>
</ul>

<h4 id="before_network_setupafter_network_setup">before_network_setup/after_network_setup</h4>
<p>Called before and after the network setup operation on the host.
Network provider reponsibilities:</p>

<ul>
  <li>if needed, the network provider might prevent network setup actions which would interfere with the external networks on the host.</li>
</ul>

<h2 id="external-provider-reference-implementation">External provider reference implementation</h2>

<p>A reference implementation of an external provider is prepared to show how.
The implementation show in the reference implementation is very simple (naive),
it’s purpose is to show where rather than how different parts of the
functionality should be implemented.</p>

<p>The reference implementation consists of two parts:</p>

<ul>
  <li>
    <p>the REST API - implementing the external provider REST API</p>
  </li>
  <li>
    <p>VIF driver - implementing the driver which connects VM NICs on the hosts</p>
  </li>
</ul>

<h2 id="features-under-discussion">Features under discussion</h2>

<h3 id="provider-custom-properties">Provider custom properties</h3>

<p>Custom properties for an external network provider will be added. The user will be able to add the custom properties when adding the provider. The changed UI will should look like this (best guess - this might still change):</p>

<p><img src="/ovirt-site/previews/3195/images/wiki/external_network_provider_custom_properties.png" alt="" /></p>

<p>These properties will be passed to the VIF driver upon pluging of a nic, the same way the “vnic_id” property
is passed.
These properties might also be passed to the VIF driver when unplugging a nic (to be decided).</p>

<p>As an example, this would allow to add custom properties to native networks vNIC profiles. vNIC profiles are not available for external network; this subfeature would allow another means to pass provider-specific customization to starting up a vNIC.</p>

<h3 id="automatic-vif-driver-deployment">Automatic VIF driver deployment</h3>

<p>In the later stages of the external network provider feature, support for automated deployment
of VIF drivers during host deploy will be added. This will be similar to the current OpenStack Neutron
provider deployment.
In future versions VIF driver deployment should be integrated into ovirt-host-deploy.</p>

<h3 id="multiple-vif-drivers-on-a-host">Multiple VIF drivers on a host</h3>

<p>It should be possible to add more than one VIF driver automatically.</p>

<p><img src="/ovirt-site/previews/3195/images/wiki/external_network_provider_automated_deploy.png" alt="" /></p>

<p>The id of the provider would then be passed each time a nic is provisioned to let the appropriate VIF driver
handle the connecting action.</p>

<h4 id="simple-use-case-for-having-more-than-one-vif-driver">Simple use case for having more than one VIF driver</h4>

<p>A user might want to provision vm’s having multiple VPN connections to different sites. Each such connection
could require a different external network provider. In such a case a host should handle multiple
VIF drivers to establish each of these connections.</p>

<h3 id="vif-driver-api">VIF driver API</h3>

<p>In order to be automatically provisioned, the VIF driver will have to implement a “VIF driver API”.
This “VIF driver API” will be called by the hooks in reponse to NIC lifecycle events.</p>

<p>The VIF driver will not have to implement this API, instead it could use the hooks directly. This however
would disable the automatic deployment of the VIF driver and the paralel use of more than one external
network provider on the host (unless implemented by the user).</p>

<ul>
  <li>plug_device(domxml, properties)</li>
  <li>unplug_device(domxml, properties)</li>
  <li>migration_source(domxml, properties)</li>
  <li>migration_destination(domxml, properties)</li>
  <li>get_caps(caps, properties)</li>
  <li>get_stats(stats, properties)</li>
</ul>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>This feature is strongly related to the “Openstack Neutron provider” feature.
It is providing a similar functionality, but not limited to only Openstack.
The implementation is based mostly on the functionality/code of the “Openstack Neutron provider” feature.</p>

<h3 id="documentation--external-references">Documentation / External references</h3>

<h3 id="open-issues">Open Issues</h3>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3195/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3195/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3195/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3195/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2025 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/network/external-network-provider.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/network/external-network-provider.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
