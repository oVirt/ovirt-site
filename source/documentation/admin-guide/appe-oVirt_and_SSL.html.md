# Appendix D: oVirt and SSL

## Replacing the oVirt Engine SSL Certificate

**Warning:** Do not change the permissions and ownerships for the `/etc/pki` directory or any subdirectories. The permission for the `/etc/pki` and the `/etc/pki/ovirt-engine` directory must remain as the default 755.

You want to use your organization's commercially signed certificate to identify your oVirt Engine to users connecting over HTTPS.

**Note:** Using a commercially issued certificate for HTTPS connections does not affect the certificate used for authentication between your Engine and hosts. They will continue to use the self-signed certificate generated by the Engine.

**Prerequisites**

This procedure requires a PEM formatted certificate from your commercial certificate issuing authority, a *.nokey* file, and a *.cer* file. The *.nokey* and *.cer* files are sometimes distributed as a certificate-key bundle in the P12 format.

This procedure assumes that you have a certificate-key bundle in the *P12* format.

**Important:** For new oVirt installations, you must complete all of the steps in this procedure. If you upgraded from a oVirt 3.6 environment with a commercially signed certificate already configured, only steps 1, 8, and 9 are required.

**Replacing the oVirt Engine Apache SSL Certificate**

1. Add your commercially issued certificate to the host-wide trust store.

        # cp YOUR-3RD-PARTY-CERT.pem /etc/pki/ca-trust/source/anchors
        # update-ca-trust

2. The Engine has been configured to use `/etc/pki/ovirt-engine/apache-ca.pem`, which is symbolically linked to `/etc/pki/ovirt-engine/ca.pem`. Remove the symbolic link.

        # rm /etc/pki/ovirt-engine/apache-ca.pem

3. Save your commercially issued certificate as `/etc/pki/ovirt-engine/apache-ca.pem`. The certificate chain must be complete up to the root certificate. The chain order is important and should be from the last intermediate certificate to the root certificate.

        mv YOUR-3RD-PARTY-CERT.pem /etc/pki/ovirt-engine/apache-ca.pem

4. Back up your *P12* bundle, and then move it to `/etc/pki/ovirt-engine/keys/apache.p12`.

5. Extract the key from the bundle.

        # openssl pkcs12 -in  /etc/pki/ovirt-engine/keys/apache.p12 -nocerts -nodes > /etc/pki/ovirt-engine/keys/apache.key.nopass

6. Extract the certificate from the bundle.

        # openssl pkcs12 -in /etc/pki/ovirt-engine/keys/apache.p12 -nokeys > /etc/pki/ovirt-engine/certs/apache.cer

7. Restart the Apache server.

        # systemctl restart httpd.service

8. Create a new trust store configuration file.

        # vi /etc/ovirt-engine/engine.conf.d/99-custom-truststore.conf

    Add the following content and save the file.

        ENGINE_HTTPS_PKI_TRUST_STORE="/etc/pki/java/cacerts"
        ENGINE_HTTPS_PKI_TRUST_STORE_PASSWORD=""

9. Restart the `ovirt-engine` service.

        systemctl restart ovirt-engine.service

Your users can now connect to the Administration and User portals without being warned about the authenticity of the certificate used to encrypt HTTPS traffic.

**Important:** Replacing the certificate can cause the log collector to fail. To avoid this failure, edit the log collector's configuration:

1. Export the CA certificate from the CA server and copy it to the oVirt Engine server.

2. Point the log collector to the new location by adding the following to `/etc/ovirt-engine/logcollector.conf`:

         cert-file=/path/to/new/CA/file

## Setting Up SSL or TLS Connections between the Engine and an LDAP Server

To set up a secure connection between the oVirt Engine and an LDAP server, obtain the root CA certificate of the LDAP server, copy the root CA certificate to the Engine, and create a PEM-encoded CA certificate. The keystore type can be any Java-supported type. The following procedure uses the Java KeyStore (JKS) format.

**Note:** For more information on creating a PEM-encoded CA certificate and importing certificates, see the `X.509 CERTIFICATE TRUST STORE` section of the README file at `/usr/share/doc/ovirt-engine-extension-aaa-ldap-version`.

**Creating a PEM-encoded CA certificate**

1. On the oVirt Engine, copy the root CA certificate of the LDAP server to the `/tmp` directory and import the root CA certificate using `keytool` to create a PEM-encoded CA certificate. The following command imports the root CA certificate at `/tmp/myrootca.pem` and creates a PEM-encoded CA certificate `myrootca.jks` under `/etc/ovirt-engine/aaa/`. Note down the certificate's location and password. If you are using the interactive setup tool, this is all the information you need. If you are configuring the LDAP server manually, follow the rest of the procedure to update the configuration files.

        $ keytool -importcert -noprompt -trustcacerts -alias myrootca -file /tmp/myrootca.pem -keystore /etc/ovirt-engine/aaa/myrootca.jks -storepass password

2. Update the `/etc/ovirt-engine/aaa/profile1.properties` file with the certificate information:

    **Note:** `${local:_basedir}` is the directory where the LDAP property configuration file resides and points to the `/etc/ovirt-engine/aaa` directory. If you created the PEM-encoded CA certificate in a different directory, replace `${local:_basedir}` with the full path to the certificate.

    * To use startTLS (recommended):

            # Create keystore, import certificate chain and uncomment
            pool.default.ssl.startTLS = true
            pool.default.ssl.truststore.file = ${local:_basedir}/myrootca.jks
            pool.default.ssl.truststore.password = password
    * To use SSL:

            # Create keystore, import certificate chain and uncomment
            pool.default.serverset.single.port = 636
            pool.default.ssl.enable = true
            pool.default.ssl.truststore.file = ${local:_basedir}/myrootca.jks
            pool.default.ssl.truststore.password = password

To continue configuring an external LDAP provider, see [Configuring an External LDAP Provider](Configuring_an_External_LDAP_Provider). To continue configuring LDAP and Kerberos for Single Sign-on, see [Configuring LDAP and Kerberos for Single Sign-on](Configuring_LDAP_and_Kerberos_for_Single_Sign-on).

**Prev:** [Appendix C: oVirt User Interface Plugins](../appe-oVirt_User_Interface_Plugins)<br>
**Next:** [Appendix E: Using Search Bookmarks and Tags](../appe-Using_Search_Bookmarks_and_Tags)
