<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>dbupgrade | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="dbupgrade" />
<meta name="author" content="Eli Mesika" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/db-issues/dbupgrade.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/db-issues/dbupgrade.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="dbupgrade" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Eli Mesika" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Eli Mesika"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"dbupgrade","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3177/images/logo.svg"},"name":"Eli Mesika"},"url":"https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/db-issues/dbupgrade.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3177/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3177/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3177/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3177/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3177/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3177/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3177/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3177/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3177/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/developer-guide/db-issues/">
              <span property="name">Db Issues</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eli Mesika">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/5ac847571702ef76c9b9fc6f628f0e3c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/5ac847571702ef76c9b9fc6f628f0e3c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Mooli Tayer">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Mooli Tayer</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="upgrade">Upgrade</h1>

<p>We have here our home-made infrastructures based on concepts of an existing tool named <a href="http://flywaydb.org/">Flyway</a>, however,
Flyway has it own limitations and is also bundled with a relatively big set of other dependant libraries that makes it hard to
integrate &amp; customise to our needs. In order to handle DB upgrades, we maintain a fixed schema plus initial data and from that
point on All schema &amp; data changes will be done via upgrade scripts.</p>

<p>Since upgrade run only new scripts, upgrade scripts do not need to be re-entrant. New upgrade scripts should be pushed into git with a higher version than the latest script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ovirt=# \d schema_version
                                      Table "public.schema_version"
     Column    |            Type             |                        Modifiers
  -------------+-----------------------------+----------------------------------------------------------
  id           | integer                     | not null default nextval('schema_version_seq'::regclass)
  version      | character varying(10)       | not null
  script       | character varying(255)      | not null
  checksum     | character varying(128)      |
  installed_by | character varying(30)       | not null
  started_at   | timestamp without time zone | default now()
  ended_at     | timestamp without time zone |
  state        | character varying(15)       | not null
  current      | boolean                     | not null
  comment      | text                        | default ''::text
  Indexes:
     "schema_version_primary_key" PRIMARY KEY, btree (id)
</code></pre></div></div>

<p><strong>NOTE : If you are testing upgrade, you must compile the origin and upgraded branch to the same PREFIX.</strong></p>

<p>In production, you should</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   1. install ovirt-engine with remote database
   2. reinstall machine
   3. install ovirt-engine with database of (1)
</code></pre></div></div>

<p>or:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   1. install ovirt-engine
   2. execute engine-cleanup without cleaning up database
   3. install ovirt-engine reuse database
</code></pre></div></div>

<h2 id="what-is-my-database-version">What is my database version?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   select version,script,current from schema_version order by id desc limit 1;
</code></pre></div></div>

<h2 id="what-are-the-upgrade-script-naming-conventions">What are the upgrade script naming conventions?</h2>

<p>Each upgrade change should be in a separate file formatted by <code class="language-plaintext highlighter-rouge">MM_mm_nnnn_[Name].sql</code> where:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       MM  indicates Major Version number
       mm indicates Minor Version number
       nnnn are numbers starting from 0010, each having an offset of 10 from previous script(i.e 0010 0020 ....)
       [Name] is a short descriptive name for the script.(Please do not put your BZ # as part of the Name)
</code></pre></div></div>

<p>Upgrade scripts are sorted and executed lexicography, that’s why it is important to follow the upgrade script naming convention.</p>

<p>Temporary functions in upgrade scripts should be renamed <code class="language-plaintext highlighter-rouge">__temp_&lt;name&gt;</code> This is in order to distinguish them from real persistent functions and preventing the chance to drop such a function by mistake in an upgrade script.</p>

<h2 id="when-upgrade-scripts-are-called-">When upgrade scripts are called ?</h2>

<p><em>Clean Install</em>
In clean install this is done after initial (default) data is inserted to the database
This makes sure that default data is inserted on initial schema before any upgrade script change it.
 <em>Upgrade</em>
In upgrade we first drop all SPs &amp; Views and then run all upgrade scripts and finally restore views &amp; SPs</p>

<h2 id="what-is-done-in-the-pre-upgrade-step">What is done in the pre-upgrade step?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   configuration changes
   schema_version table changes
   special fixes
</code></pre></div></div>

<h2 id="what-is-done-in-the-post-upgrade-step">What is done in the post-upgrade step?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Modifications that are using views/stored procedures
   Example:
     Object column white list
</code></pre></div></div>

<h2 id="how-does-the-upgrade-script-works">How does the upgrade script works</h2>

<p>validates scripts for changes &amp; version duplication
drops views &amp; stored procedures
runs pre-upgrade scripts
checks for gaps
check for already installed scripts
run the upgrade script
updates schema_version
restore views &amp; stored procedures
run post upgrade scripts
generate .schema file</p>

<h2 id="how-do-i-upgrade-db-configuration">How do I upgrade db configuration?</h2>

<p>All changes to the configuration stored in the vdc_options table will be done using one script named
<strong>config.sql</strong> under <strong>dbscripts/upgrade/pre_upgrade</strong> directory.
<strong>config.sql</strong> script file is categorized to the following sections:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     Add Section
     Update section (w/o overriding current value)
     Delete section
     Simple upgrades not available using a fn_db* function call
     Complex upgrades using temporary functions
</code></pre></div></div>

<p><strong>Please note that the config.sql is re-entrant.</strong></p>

<h2 id="how-do-i-upgrade-db-schema">How do I upgrade db schema?</h2>

<p>When the DB schema is changed (using DDL), the change must be introduced via an upgrade script.
That means that the <code class="language-plaintext highlighter-rouge">create_tables.sql</code> is stable and all modifications are done using upgrade scripts.</p>

<h2 id="how-do-i-upgrade-db-data">How do I upgrade db data?</h2>

<p>When the DB data is changed (using DML), the change must be introduced via an upgrade script.</p>

<h2 id="how-do-i-cherry-pick-a-commit-from-upstream-to">How do I cherry-pick a commit from upstream to?</h2>

<p>Assume upstream installed patches 0010 0020 0030 0040 0050 0060 and z-stream installed 0010 and 0020 when 0030 0040 0050 belongs to f1 feature and 0060 belongs to f2 feature Now ,
we would like to merge f2 changes to Z-stream There can be two cases here :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  In case that f2 depends on f1 , we will have to insert both f1 &amp; f2 patches (0030 - 0060)
  In case that f2 is independent , we will add 0060 as 0021 in Z-stream
</code></pre></div></div>

<p>When we will add f1 to Z-stream it will run without any problem since it version is bigger than the last installed version.</p>

<p>When we will add the real f2 to Z-stream , the upgrade will compare its checksum with existing scripts and it will be skipped (and will be marked as SKIPPED in the schema_version table)</p>

<p>This assumes of course that f2 script were not changed from the time it was cherry-picked to the time the real script is taken.</p>

<h2 id="how-to-prevent-script-collisions">How to prevent script collisions?</h2>

<p>Upgrade scripts have the MM_mm_nnnn prefix, this uniquely defines the upgrade script
The <em>upgrade.sh</em> script check for such duplications and fails with a detailed error pointing on the duplicate version if found.
In addition we have a <em>pom.xml</em> under <em>dbscripts</em> that uses the <em>Maven Exec Plugin</em> to run a script that checks for duplications each time the engine is compiled
In short , please follow
 verify that your upgrade script is running OK</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     compile
     In case that you messed up, `*`Jenkins`*` will find the duplicate script and will send you a nice note.
</code></pre></div></div>

<h2 id="what-helper-functions-can-i-use-in-upgrade-scripts">What helper functions can I use in upgrade scripts</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   fn_db_add_column                     Adds a column to a table
   fn_db_change_column_type             Changes a column type,decimal precision etc. (Several formats)
   fn_db_add_config_value               Adds a new value to vdc_options
   fn_db_update_default_config_value    Updates the value of an option in vdc_options if given default was not
                                        changed.You can also define if your condition is case-sensitive or not
   fn_db_delete_config_value            Deletes an option from vdc_options
   fn_db_split_config_value             Given general configuration entry, creates new entries for each old
                                        cluster version, with the old value,
                                        and a new entry for the newest cluster version with the input  value
   fn_db_create_constraint              Creates a constraint
   fn_db_drop_constraint                Drops a constraint
</code></pre></div></div>

<p>Examples:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       <span class="k">select</span> <span class="n">fn_db_add_column</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'group_ids'</span><span class="p">,</span> <span class="s1">'VARCHAR(2048)'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'storage_pool'</span><span class="p">,</span><span class="s1">'storage_pool_format_type'</span><span class="p">,</span><span class="s1">'integer'</span><span class="p">,</span><span class="s1">'varchar(50)'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span><span class="s1">'age'</span><span class="p">,</span><span class="s1">'int2'</span><span class="p">,</span><span class="s1">'int4 not null default 0'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_change_column_type</span><span class="p">(</span><span class="s1">'vm_statistics'</span><span class="p">,</span><span class="s1">'cpu_user'</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">'decimal(18,3)'</span><span class="p">);</span><span class="c1">-- change decimal scale.</span>
       <span class="k">select</span> <span class="n">fn_db_add_config_value</span><span class="p">(</span><span class="s1">'VdcVersion'</span><span class="p">,</span><span class="s1">'3.0.0.0'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_update_config_value</span><span class="p">(</span><span class="s1">'DBEngine'</span><span class="p">,</span><span class="s1">'Postgres'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_update_default_config_value</span><span class="p">(</span><span class="s1">'LDAPSecurityAuthentication'</span><span class="p">,</span><span class="s1">'GSSAPI'</span><span class="p">,</span><span class="s1">'default:GSSAPI'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">,</span><span class="k">false</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_delete_config_value</span><span class="p">(</span><span class="s1">'ENMailEnableSsl'</span><span class="p">,</span><span class="s1">'general'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_split_config_value</span><span class="p">(</span><span class="s1">'SpiceSecureChannels'</span><span class="p">,</span><span class="s1">'all'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_create_constraint</span><span class="p">(</span><span class="s1">'vds_static'</span><span class="p">,</span> <span class="s1">'vds_static_vds_name_unique'</span><span class="p">,</span> <span class="s1">'UNIQUE(vds_name)'</span><span class="p">);</span>
       <span class="k">select</span> <span class="n">fn_db_drop_constraint</span> <span class="p">(</span> <span class="s1">'vds_static_vds_name_unique'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="what-should-i-do-if-i-have-to-">What should I do if I have to ?</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Add or change a column                         Add an upgrade script
   Add/Delete/Modify/Split configuration values   Modify config.sql script in pre_upgrade directory using
                                                  common fn_db* functions
   Add/Delete/Modify any default data             Add an upgrade script
   Add/Delete/Modify a SP                         Change only the relevant *_sp.sql file
   Add/Delete/Modify a View                       Change only the relevant code in create_views.sql file
</code></pre></div></div>

<h2 id="i-need-to-run-a-shell-script-as-an-upgrade-step-is-this-possible">I need to run a shell script as an upgrade step, is this possible?</h2>

<p>Yes, just:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>write &lt;MM_mm_nnnn_your_script.sh&gt;
</code></pre></div></div>

<p>keep in mind that script follows same naming conventions and numbering as SQL upgrade script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod +x &lt;MM_mm_nnnn_your_script.sh&gt;
</code></pre></div></div>

<p>The ability to run shell scripts cover also the content of the pre/post upgrade directories.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3177/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3177/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3177/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3177/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/db-issues/dbupgrade.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/db-issues/dbupgrade.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
