<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>VDSM on Ubuntu | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="VDSM on Ubuntu" />
<meta name="author" content="Dan Kenigsberg" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/on-ubuntu.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/on-ubuntu.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VDSM on Ubuntu" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Dan Kenigsberg" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Dan Kenigsberg"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"VDSM on Ubuntu","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3186/images/logo.svg"},"name":"Dan Kenigsberg"},"url":"https://ovirt.github.io/ovirt-site/previews/3186/develop/developer-guide/vdsm/on-ubuntu.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3186/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3186/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3186/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3186/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3186/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3186/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3186/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3186/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3186/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3186/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3186/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3186//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3186/develop/developer-guide/vdsm/">
              <span property="name">Vdsm</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Dan Kenigsberg">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9518fafe8a918bea7471374d2f2580dc?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9518fafe8a918bea7471374d2f2580dc?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Zheng Sheng Zhou">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Zheng Sheng Zhou</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="vdsm-on-ubuntu">VDSM on Ubuntu</h1>

<p>This page describes Ubuntu imcompabilities that must be fixed to run VDSM.
With the workaround, it is possible to build VDSM on Ubuntu and run some functional tests.
The last section presents a code repository containing the modified VDSM to be run on Ubuntu.
This is a working VDSM snapshot with the following workarounds.
If you are interested, please pick a workaround and create long term solution patch for it, then paste the Gerrit link beside the workdaround.</p>

<p>Targeted Ubuntu Version: <strong>Ubuntu Server 12.10</strong></p>

<h2 id="dependency-deb-packages">Dependency deb Packages</h2>

<ul>
  <li>For accessing the git repo</li>
</ul>

<p>git git-email git-completion git-review git-man git-doc</p>

<ul>
  <li>For Packaging</li>
</ul>

<p>autoconf automake genisoimage gcc gdb make libtool libguestfs-tools policycoreutils sasl2-bin sysv-rc</p>

<ul>
  <li>Python related</li>
</ul>

<p>python-parted python-nose pep8 pyflakes python-libvirt python-dev python-ethtool python-pip python-m2crypto python-selinux python-rpm python-libguestfs</p>

<ul>
  <li>Security</li>
</ul>

<p>selinux-utils</p>

<ul>
  <li>Other dependencies</li>
</ul>

<p>fence-agents ntp iproute nfs-server nfs-client lvm2 e2fsprogs open-iscsi psmisc bridge-utils dosfstools glusterfs-client glusterfs-common multipath-tools libsanlock-dev sanlock qemu-kvm-spice qemu-kvm qemu-utils gnutls-bin python-rtslib</p>

<p><strong>Workaround</strong>: install them manually through apt-get</p>

<h3 id="dependency-problems">Dependency Problems</h3>

<ul>
  <li>Missing dependencies</li>
</ul>

<p>mom sos policycoreutils-python vhostmd</p>

<p><strong>Workaround</strong>: ignore or skip the related feature.</p>

<ul>
  <li>python-pthreading is not available through apt-get</li>
</ul>

<p><strong>Workaround</strong>: use pip to install it.</p>

<ul>
  <li>sanlock-python is not available through neither apit-get nor pip</li>
</ul>

<p><strong>Workaround</strong>: compile and install sanlock from the source. GCC 4.7 requires all link flags comes after source file names, should adjust the Makefile in the sanlock git to avoid symbol not defined error. Firstly install Ubuntu’s sanlock and libsanlock-dev to get the init files, then compile and install sanlock from source but do not install the init files. The init files in the sanlock source is not compatible with Ubuntu.</p>

<ul>
  <li>/usr/lib/libvirt/lock-driver/sanlock.so is not available</li>
</ul>

<p><strong>Workaround</strong>: disable sanlock in qemu.conf of libvirt</p>

<ul>
  <li>python-rtslib is not fresh enough</li>
</ul>

<p><strong>Workaround</strong>: install python-rtslib from pip</p>

<h2 id="failed-unit-tests">Failed Unit Tests</h2>

<ul>
  <li>Exception in ssl test</li>
</ul>

<p>M2Crypto API differs between versions. Ubuntu and Fedora have different versions of M2Crypto .</p>

<p><strong>Workaround</strong>: Modify M2Crypto related VDSM code of the SSL wrapper and add the missing API adapter</p>

<ul>
  <li>AlignmentScanTests.test_aligned_image and AlignmentScanTests.test_nonaligned_image fails with the same error</li>
</ul>

<p>libguestfs is not in vdsm dependency, after installing it, should run update-guestfs-appliance</p>

<p>The libguestfs-test-tool fails as well, the default path of guest appliance is wrong</p>

<p><strong>Workaround</strong>: ln -s /usr/lib/guestfs /usr/lib/x86_64-linux-gnu/guestfs</p>

<ul>
  <li>AlignmentScanTests sometimes cause the CPU stuck</li>
</ul>

<p><strong>Workaround</strong>: Ubuntu should provide new kernel version with better nested KVM support. Now just skip the test.</p>

<ul>
  <li>testMethodMissingMethod</li>
</ul>

<p><strong>Workaround</strong>: Fail in both Fedora and Ubuntu, just skip it</p>

<h2 id="packaging">Packaging</h2>

<ul>
  <li>chkconfig is not in 12.10. It’s called in vdsmd and the post installation script in rpm.</li>
</ul>

<p><strong>Workaround</strong>: use update-rc.d or sysv-rc-conf, but they do not respect the runlevel and start sequence in the chkconfig header. So the start sequence must be defined manually when adding a service.</p>

<ul>
  <li>Different Service names</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Fedora</th>
      <th>Ubuntu</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>libvirtd</td>
      <td>libvirt-bin</td>
    </tr>
    <tr>
      <td>iscsid</td>
      <td>open-iscsi</td>
    </tr>
    <tr>
      <td>multipathd</td>
      <td>multipath-tools</td>
    </tr>
    <tr>
      <td>ntpd</td>
      <td>ntp</td>
    </tr>
    <tr>
      <td>network</td>
      <td>networking</td>
    </tr>
  </tbody>
</table>

<p><strong>Workaround</strong>: edit vdsmd.init to change the service name</p>

<ul>
  <li>Ubuntu has no /etc/init.d/functions, should use /lib/lsb/init-functions in the init scripts.</li>
</ul>

<p><strong>Workaround</strong>: edit vdsmd.init to change the service name</p>

<ul>
  <li>/etc/init.d/functions v.s. /lib/lsb/init-functions</li>
</ul>

<p>Fedora has daemon util function definition in /etc/init.d/functions, Ubuntu has start_daemon, the options are different, no equivalent to –user option in Fedora.</p>

<p>If we can not define the running user, vdsm main programme will detect it and exit immediately</p>

<p><strong>Workaround</strong>: use /usr/sbin/sudo -u vdsm to start respawn in the init script instead of start respawn directly</p>

<p>The killproc() function in /etc/init.d/functions supports “-d delay” option, /lib/lsb/init-functions does not.</p>

<p><strong>Workaround</strong>: delete “-d” option from all invocation of killproc() in vdsmd.init.in.</p>

<ul>
  <li>Some functions namely “success” and “failure” do not exist in /lib/lsb/init-functions</li>
</ul>

<p><strong>Workaround</strong>: write empty “success” and “failure” functions in vdsmd.init.</p>

<h2 id="file-system-hierachy">File System Hierachy</h2>

<table>
  <thead>
    <tr>
      <th>Fedora</th>
      <th>Ubuntu</th>
      <th><strong>Workaround</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>/sbin/nologin</td>
      <td>/usr/sbin/nologin</td>
      <td>change the path in the code and script</td>
    </tr>
    <tr>
      <td>/sbin/service</td>
      <td>/usr/sbin/service</td>
      <td>change the path in the code and script</td>
    </tr>
    <tr>
      <td>/var/lock/subsys/</td>
      <td>/var/lock/</td>
      <td>change the path in the code and script</td>
    </tr>
    <tr>
      <td>/etc/sysconfig/libvirtd</td>
      <td>/etc/default/libvirt-bin</td>
      <td>change the path in the code and script</td>
    </tr>
    <tr>
      <td>/usr/lib/udev/scsi_id</td>
      <td>/lib/udev/scsi_id</td>
      <td>change the path in the code and script <a href="http://gerrit.ovirt.org/#/c/13086/">Patch</a></td>
    </tr>
    <tr>
      <td>/sys/class/cpuid/</td>
      <td>equivalent not found</td>
      <td>change the code to use os.sysconf(‘SC_NPROCESSORS_ONLN’) <a href="http://gerrit.ovirt.org/#/c/12815/">Patch</a></td>
    </tr>
    <tr>
      <td>/etc/iscsi/initiatorname.iscsi 644</td>
      <td>same file but permission is 600, vdsm cannot read it</td>
      <td>chmod in the installation script</td>
    </tr>
    <tr>
      <td>/boot/initramfs-kernelVer.img</td>
      <td>/boot/initrd.img-kernelVer</td>
      <td>change the path in the code and script</td>
    </tr>
    <tr>
      <td>/var/lib/libvirt/qemu/channels vdsm:kvm</td>
      <td>owner is root:root</td>
      <td>chmod in the installation script</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>User and Group</li>
</ul>

<p>Fedora qemu process started by libvirt is qemu:qemu</p>

<p>Ubuntu qemu process started by libvirt is libvirt-qemu:kvm, and there is no group name qemu, only group kvm</p>

<p><strong>Workaround</strong>: some code and scripts are changed to use the path and group in Ubuntu.</p>

<p><a href="http://gerrit.ovirt.org/12915">Patch</a></p>

<ul>
  <li>Ubuntu does not mount configfs by default.</li>
</ul>

<p><strong>Workaround</strong>: configfs is used by LIO target, LIO target is used by iSCSI functional test, the user should mount the filesystem manually mount -t configfs configfs /sys/kernel/config/ .Now I modprobe the iscsi target module and mount configfs in run_tests.sh.in .</p>

<h2 id="differences-of-the-underlying-tools">Differences of the Underlying Tools</h2>

<ul>
  <li>Ubuntu uses apparmor not selinux by default, apparmor prevents qemu from binding unix socket, and maybe prevent other things that affect vdsm.</li>
</ul>

<p><strong>Workaround</strong>: disable apparmor in the install script</p>

<ul>
  <li>No –copy option in Ubuntu sed</li>
</ul>

<p><strong>Workaround</strong>: delete this option in the script</p>

<ul>
  <li>bug in Ubuntu kill, parsing kill -9 -xxx will go wrong</li>
</ul>

<p><strong>Workaround</strong>: must use kill -9 – -xxx</p>

<p><a href="http://gerrit.ovirt.org/#/c/12817/">Patch</a></p>

<ul>
  <li>udev problem</li>
</ul>

<p>There is a 85-lvm2.rules under Ubuntu /lib/udev/rules.d/, it sets the owner group of LV to “disk’, preventing VDSM from chown-ing, reading, writing the LV. VDSM will chown the LV in the code and 12-vdsm-lvm.rules does this as well. However 85-lvm2.rules are run after 12-vdsm-lvm.rules, so the owner is always set by 85-lvm2.rules “root:disk” finally. In Fedora, there is no such 85-lvm2.rules, so there is no such problem.</p>

<p><strong>Workaround</strong>:rename 12-vdsm-lvm.rules to 86-vdsm-lvm.rules, so that VDSM udev rules run after the default lvm rules.</p>

<p><a href="http://gerrit.ovirt.org/#/c/12816/">Patch</a></p>

<h2 id="upstart-vs-systemd">upstart vs. systemd</h2>

<p>As <a href="https://wiki.ubuntu.com/systemd">https://wiki.ubuntu.com/systemd</a> says, systemd is very incompatible with upstart, we should create upstart jobs for vdsm. We should not run systemd within or instead of upstart. since upstats can run traditional sysv services, we can use vdsdm.init directly, just with some necessary modifications</p>

<p>DK: it would be highly advises to break the nasty SysV service to something smaller, that makes calls to vdsm-tool commands. Then, a port to upstart could become much simpler.</p>

<h2 id="existing-effort">Existing Effort</h2>

<ul>
  <li><a href="/ovirt-site/previews/3186/develop/developer-guide/ubuntu.html">oVirt build on debian/ubuntu</a></li>
  <li><a href="/ovirt-site/previews/3186/develop/developer-guide/porting-ovirt.html">Porting oVirt</a></li>
</ul>

<h2 id="code">Code</h2>

<p>Most of the workarounds needs to modify the source code and scripts. The modified VDSM source code is as follow. After resolve the dependencies manually as mentioned in the first section of this WIKI, you can clone the code, and run ./ubuntuInstall.sh to build, run unit tests and install VDSM. After the installation you can use “service vdsmd start” to start VDSM daemon.</p>

<p>To run functional tests, cd to /usr/share/vdsm/tests and ./run_tests.sh functional/xmlrpcTests.py . Currently we can run VM creation tests with iSCSI and LOCALFS storage.</p>

<p><a href="https://github.com/edwardbadboy/vdsm-ubuntu">https://github.com/edwardbadboy/vdsm-ubuntu</a></p>

<p>Contact: zhshzhou AT linux DOT vnet DOT ibm DOT com</p>





        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3186/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3186/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3186/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3186/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/vdsm/on-ubuntu.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/vdsm/on-ubuntu.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
