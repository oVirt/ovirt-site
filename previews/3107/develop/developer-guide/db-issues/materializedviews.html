<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MaterializedViews | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="MaterializedViews" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3107/develop/developer-guide/db-issues/materializedviews.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3107/develop/developer-guide/db-issues/materializedviews.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MaterializedViews" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"MaterializedViews","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3107/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3107/develop/developer-guide/db-issues/materializedviews.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3107/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3107/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3107/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3107/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3107/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3107/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3107/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3107/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3107/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3107/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3107/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3107/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3107/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3107/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3107/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3107/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3107/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3107/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3107/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3107/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3107/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3107/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3107//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3107//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3107/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3107/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3107/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3107/develop/developer-guide/db-issues/">
              <span property="name">Db Issues</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eli Mesika">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="materialized-views">Materialized Views</h1>

<h2 id="overview">Overview</h2>

<p>A materialized view is a table that actually contains rows, but behaves like a view. That is, the data in the table changes when the data in the underlying tables changes.</p>

<p>There are several different types of materialized views:</p>

<ul>
  <li><strong>Snapshot materialized views</strong>* are the simplest to implement. They are only updated when manually refreshed.</li>
  <li><strong>Eager materialized views</strong> are updated as soon as any change is made to the database that would affect it.
Eagerly updated materialized views may have incorrect data if the view it is based on has dependencies on mutable functions like now().</li>
  <li><strong>Lazy materialized views</strong> are updated when the transaction commits. They too may fall out of sync with the base view if the view depends on mutable functions like now().</li>
  <li><strong>Very Lazy materialized views</strong> are functionally equivalent to Snapshot materialized views.
The only difference is that changes are recorded incrementally and applied when the table is manually refreshed.
(This may be faster than a full snapshot upon refresh.)</li>
</ul>

<p><strong>In this document we will only discuss the Snapshot Materialized Views implementation.</strong></p>

<h2 id="why-materialized-views-">Why Materialized Views ?</h2>

<p>Before we get too deep into how to implement materialized views, let’s first examine why we may want to use materialized views.
You may notice that certain queries are very slow. You may have exhausted all the techniques in the standard bag of techniques to speed up those queries.
In the end, you realize that getting the queries to run as fast as you like simply isn’t possible without completely restructuring the data.
What you end up doing is storing pre-queried bits of information so that you don’t have to run the real query when you need the data.
This is typically called “caching” outside of the database world.
What you are really doing is creating a materialized view. You are taking a view and turning it into a real table that holds real data, rather than a gateway to a <code class="language-plaintext highlighter-rouge">SELECT</code> query.</p>

<h2 id="implementation">Implementation</h2>

<p>Candidates for Snapshot Materialized Views are views that are based on slowly-changing data. The Snapshot Materialized Views is actually functioning as a cache.
The Snapshot Materialized View is refreshed per request.
The Snapshot Materialized View definitions are stored in the materialized_views table.</p>

<table class="bordered">
  <thead>
    <tr>
      <th>Column</th>
      <th>Type</th>
      <th>Modifiers</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mv_name</td>
      <td>name</td>
      <td>not null</td>
      <td>the Materialized View name</td>
    </tr>
    <tr>
      <td>v_name</td>
      <td>name</td>
      <td>not null</td>
      <td>the original view name on which mv_name is based</td>
    </tr>
    <tr>
      <td>refresh_rate_in_sec</td>
      <td>integer</td>
      <td> </td>
      <td>the Materialized View refresh rate in seconds</td>
    </tr>
    <tr>
      <td>last_refresh</td>
      <td>timestamp with time zone</td>
      <td> </td>
      <td>the timestamp of the last refresh</td>
    </tr>
    <tr>
      <td>avg_cost_ms</td>
      <td>integer</td>
      <td>not null default 0</td>
      <td>the average cost of a refresh operation on the Materialized View in miliseconds.</td>
    </tr>
    <tr>
      <td>min_refresh_rate_in_sec</td>
      <td>integer</td>
      <td>default 0</td>
      <td>the min refresh rate allowed when refresh is called with teh force flag</td>
    </tr>
    <tr>
      <td>custom</td>
      <td>boolean</td>
      <td>default false</td>
      <td>flag indicating if a Materialized View is custom</td>
    </tr>
    <tr>
      <td>active</td>
      <td>boolean</td>
      <td>default true</td>
      <td>flag indicating if a Materialized View is active</td>
    </tr>
  </tbody>
</table>

<h2 id="flow">Flow</h2>

<ol>
  <li>Create the Materialized View by calling:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">CreateMaterializedView</code> - if you are creating a new product view</li>
      <li><code class="language-plaintext highlighter-rouge">CreateMaterializedViewAs</code> - preserves the original view name, The original view will be renamed and the new product  Materialized View will have the original  view name.</li>
      <li><code class="language-plaintext highlighter-rouge">CreateCustomMaterializedView</code> - if you are creating a new custom view</li>
      <li><code class="language-plaintext highlighter-rouge">CreateCustomMaterializedViewAs</code> - preserves the original view name, The original view will be renamed and the new custom  Materialized View will have the original  view name.</li>
    </ul>
  </li>
  <li>If your Snapshot Materialized View is <code class="language-plaintext highlighter-rouge">my_mt</code> you should create Stored Procedures:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">MtDropmy_mtIndexes</code> - Drops indexes on <code class="language-plaintext highlighter-rouge">my_mt</code></li>
      <li><code class="language-plaintext highlighter-rouge">MtCreatemy_mtIndexes</code> - Creates needed indexes on <code class="language-plaintext highlighter-rouge">my_mt</code></li>
    </ul>

    <p>Those indexes should be defined in the “Snapshot Materialized Views Index Definitions Section”
in <code class="language-plaintext highlighter-rouge">post_upgrade/0020_create_materialized_views.sql</code> file.</p>

    <p>Those SP are called automatically when a Snapshot Materialized View is refreshed to boost refresh performance.</p>
  </li>
</ol>

<p>3) You can call <code class="language-plaintext highlighter-rouge">IsMaterializedViewRefreshed</code> to check if it is time to refresh the view and if yes call <code class="language-plaintext highlighter-rouge">RefreshMaterializedView</code> manually.</p>

<p>or</p>

<p>You can define a cron job that calls <code class="language-plaintext highlighter-rouge">RefreshAllMaterializedViews</code> that loops over all  Snapshot Materialized Views and refreshes it automatically
   <code class="language-plaintext highlighter-rouge">RefreshAllMaterializedViews</code> recieves a boolean <code class="language-plaintext highlighter-rouge">v_force</code> flag, Please set this flag to <code class="language-plaintext highlighter-rouge">false</code> when calling it from a cron job
   in order to update the materialized views only when needed.
   (This SP is called with <code class="language-plaintext highlighter-rouge">v_force = true</code> after create/upgrade DB)</p>

<p>There are 4 additional functions :</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CreateAllMaterializedViewsiIndexes</code> - Creates indexes for all Snapshot Materialized views</li>
  <li><code class="language-plaintext highlighter-rouge">DropMaterializedView</code> - Drops the Materialized View</li>
  <li><code class="language-plaintext highlighter-rouge">DropAllMaterializedViews</code> - Drop all Materialized Views</li>
  <li><code class="language-plaintext highlighter-rouge">UpdateMaterializedViewRefreshRate</code> - Updates the Materialized View refresh rate</li>
  <li><code class="language-plaintext highlighter-rouge">UpdateMaterializedViewMinRefreshRate</code> - Updates the Materialized View minimal refresh rate</li>
  <li><code class="language-plaintext highlighter-rouge">ActivateMaterializedView</code> - activates/decativates a  Materialized View</li>
  <li><code class="language-plaintext highlighter-rouge">ActivateAllMaterializedViews</code> - activates/decativates all Materialized Views</li>
</ul>

<h3 id="example-of-possible-post_upgrade0020_create_materialized_viewssql">Example of possible <code class="language-plaintext highlighter-rouge">post_upgrade/0020_create_materialized_views.sql</code></h3>

<p>This file includes only product Materialized Views for Custom Materialized Views please refer to the <strong>Customization</strong> section</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cm">/******************************************************************************************************
                          Snapshot Materialized Views Definitions Section
 ******************************************************************************************************/</span>
 <span class="k">select</span> <span class="n">CreateMaterializedViewAs</span><span class="p">(</span><span class="s1">'vms'</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
 <span class="cm">/******************************************************************************************************
                          Snapshot Materialized Views Index Definitions Section
 ******************************************************************************************************/</span>
 <span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">function</span> <span class="n">MtCreatevmsIndexes</span><span class="p">()</span>
 <span class="k">returns</span> <span class="n">void</span>
 <span class="k">as</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
 <span class="k">begin</span>
 <span class="k">create</span> <span class="k">index</span> <span class="n">vms_index</span> <span class="k">on</span> <span class="n">vms</span> <span class="p">(</span><span class="n">vm_guid</span><span class="p">);</span>
 <span class="k">end</span><span class="p">;</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
 <span class="k">language</span> <span class="n">plpgsql</span><span class="p">;</span>
 <span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">function</span> <span class="n">MtDropvmsIndexes</span><span class="p">()</span>
 <span class="k">returns</span> <span class="n">void</span>
 <span class="k">as</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
 <span class="k">begin</span>
 <span class="k">drop</span> <span class="k">index</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">vms_index</span> <span class="k">cascade</span><span class="p">;</span>
 <span class="k">end</span><span class="p">;</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
 <span class="k">language</span> <span class="n">plpgsql</span><span class="p">;</span>
 <span class="k">select</span> <span class="n">RefreshMaterializedView</span><span class="p">(</span><span class="s1">'vms'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="upgrade">Upgrade</h2>

<p>When the DB is upgraded, all Materilized Views are dropped in the pre-upgrade step in order to reflect any change that may be done in the original views.
The Materilized Views are recreated in the post-upgrade step insuring that after the upgrade the Materilized Views are updated and play the same role as before it.
<strong>NOTE : Materialized Views are automatically refreshed upon create/upgrade</strong></p>

<h2 id="customization">Customization</h2>

<p>In addition, you can create a file named <code class="language-plaintext highlighter-rouge">create_materialized_views.sql</code> under <code class="language-plaintext highlighter-rouge">dbscripts/upgrade/post_upgrade/custom/</code>
This file may include other custom materialized views settings and is executed by the create/upgrade database scripts.</p>

<p><strong>NOTE: If from any reason you want to drop a Snapshot Materialized View that was setup in the product context, you can always do that by calling <code class="language-plaintext highlighter-rouge">DropMaterializedView</code> in <code class="language-plaintext highlighter-rouge">create_materialized_views.sql</code></strong></p>

<p>If <code class="language-plaintext highlighter-rouge">create_materialized_views.sql</code> is executed manually :</p>

<ol>
  <li>verify that the the user that runs the psql is engine so the objects created will have the same credentials</li>
  <li>the custom dir and <code class="language-plaintext highlighter-rouge">create_materialized_views.sql</code> file under it should have the following permissions:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">drwxr-xr-x 2 root root  custom
-rw-r--r-- 1 root root  create_materialized_views.sql
</span></code></pre></div>    </div>
  </li>
</ol>

<h3 id="example">Example</h3>

<p>This is an example of how <code class="language-plaintext highlighter-rouge">dbscripts/upgrade/post_upgrade/custom/create_materialized_views.sql</code> may look like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="cm">/******************************************************************************************************
                               Snapshot Materialized Views Definitions Section
      ******************************************************************************************************/</span>
      <span class="k">select</span> <span class="n">CreateCustomMaterializedViewAs</span><span class="p">(</span><span class="s1">'vds'</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
      <span class="cm">/******************************************************************************************************
                               Snapshot Materialized Views Index Definitions Section
      ******************************************************************************************************/</span>
      <span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">function</span> <span class="n">MtCreatevdsIndexes</span><span class="p">()</span>
      <span class="k">returns</span> <span class="n">void</span>
      <span class="k">as</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
      <span class="k">begin</span>
      <span class="k">create</span> <span class="k">index</span> <span class="n">vds_index2</span> <span class="k">on</span> <span class="n">vds</span> <span class="p">(</span><span class="n">vds_id</span><span class="p">);</span>
      <span class="k">end</span><span class="p">;</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
      <span class="k">language</span> <span class="n">plpgsql</span><span class="p">;</span>
      <span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">function</span> <span class="n">MtDropvdsIndexes</span><span class="p">()</span>
      <span class="k">returns</span> <span class="n">void</span>
      <span class="k">as</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
      <span class="k">begin</span>
      <span class="k">drop</span> <span class="k">index</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">vds_index2</span> <span class="k">cascade</span><span class="p">;</span>
      <span class="k">end</span><span class="p">;</span> <span class="err">$</span><span class="k">procedure</span><span class="err">$</span>
      <span class="k">language</span> <span class="n">plpgsql</span><span class="p">;</span>
      <span class="k">select</span> <span class="n">RefreshMaterializedView</span><span class="p">(</span><span class="s1">'vds'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="schedule">Schedule</h2>

<p>The simplest way to schedule all Materialized Views updates is via a <strong>cron</strong> job that will perform the following command</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-U</span> &lt;user&gt; <span class="nt">-c</span> <span class="s2">"select RefreshAllMaterializedViews(false);"</span> &lt;db&gt;
</code></pre></div></div>

<p>You can also call</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql <span class="nt">-U</span> &lt;user&gt; <span class="nt">-c</span> <span class="s2">"select RefreshAllMaterializedViews(true);"</span> &lt;db&gt;
</code></pre></div></div>

<p>In this case all Materialized Views will be refreshed but if for example the crom run every minute and the minimun update rate for a view is 5 minutes,
the minimum update rate is honored(so, in this example this view will be updated once in each 5 cron invocation of teh refresh SP.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3107/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3107/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3107/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3107/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/db-issues/materializedviews.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/db-issues/materializedviews.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
