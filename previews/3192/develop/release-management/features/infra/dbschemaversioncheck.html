<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DBSchemaVersionCheck | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="DBSchemaVersionCheck" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/infra/dbschemaversioncheck.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/infra/dbschemaversioncheck.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DBSchemaVersionCheck" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"DBSchemaVersionCheck","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3192/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/infra/dbschemaversioncheck.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3192/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3192/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3192/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3192/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3192/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3192/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3192/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3192/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3192/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Yair Zaslavsky">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yair Zaslavsky</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3192/documentation/'>Documentation is available here.</a></div>

<h1 id="db-schema-version-check">DB Schema version check</h1>

<h2 id="summary">Summary</h2>

<p>This feature will allow checking if there is a parity between the DB schema version as calculated from code, and by the schema version that is obtained from the DB.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Yair Zaslavsky (Yair Zaslavsky)</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Last updated date: Wed Jan 25 2012</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>The engine schema contains the <strong>schema_version</strong> table that holds information on upgrade scripts and their installation status.
As both clean install and upgrade run these scripts, and any schema change is performed by adding another upgrade script it is crucial to keep
version information about the upgrade scripts in order to make sure unchanged scripts will not be re-run when upgrade process is being re-run.
In order to maintain the version for a given upgrade script, for each upgrade script the md5 calculation of its content is kept in the above mentioned DB.
 The table description is as follows:
| Column Name | Column Type | Null? | Definition | index/pk/fk |
| id | int | No | Version ID | PK |
| version | varchar(10) | No | The version of the schema the upgrade script tried to acieve | |
| script | varchar(255) | No | The script file name | |
| checksum | varchar(128) | No | md5 of the script file | |
| installed_by | varchar(30) | No | The db user that runs the upgrade script | |
| started_at | timestamp | No | Script start time | |
| ended_at | timestamp | Yes | Script end time | |
| state | varchar (15) | No | INSTALLED/FAILED | |
| current | boolean | No | true only for last version installed successfully | |</p>

<h3 id="1-storing-md5-information-per-installed-upgrade-scripts-in-db">1. Storing MD5 information per installed upgrade scripts in DB</h3>

<p>When running upgrade script, the script runs all scriptsl ocated in the upgrade folder that follow the pattern of MAJOR_MINOR_SCRIPTINDEX_DESCRIPTION.sql (i.e - 03_01_0050_add_cancel_migration_to_action_version_map.sql).
After each step an entry is kept to kept in version_schema , holding information on the md5 sum of the script and its state (there are other columns which are used for other issues which are out of this scope of this document, as this design is using a table that already exists in the db, and does not proprose a new one)</p>

<h3 id="2-calculating-the-db-schema-md5-and-storing-it-for-db-schema-check">2. calculating the db schema MD5 and storing it for db schema check</h3>

<p>A script called store_db_schema_checksum.sh will invoke a sciprt called calculate_db_schema_checksum.sh that calculates the db schema checksum the following way:
It performs select of the checksum column from the checksum_version table for all the installed scripts, and runs md5 calculation on the result (a list of checksum values).
The script store_db_schema_checksum.sh will store the information at the file $GIT_REPO/ovit-engine/ear/target/version.info
This script will be run by the build system (or a developer during a development stage).
During packaging a formal build, this file will be taken from the above location.
The installer is already responsible for deploying this file to /etc/engine during installation, and should be responsible to upgrade its content during upgrade (see comment at open issues).
It will also be possible to run this script via mvn clean install, by providing the -D skip.db.checksum.store=false flag&lt;BR<br /></p>

<h3 id="3-service-for-starting-engine-core-and-performing-the-db_schema_check">3. Service for starting engine-core and performing the db_schema_check</h3>

<p>A service called engine-cored (see open issues about the service name) will be developed for the following purposes:
.a. Perform validity checks
.b. If validity checks pass, the jboss service will start
The service will run the script check_db_schema_checksum.sh that will compare the md5 values in DB by running calculate_db_schema.checksum.sh (see above) and compare the result with the value of the key DB_SCHEMA_CHECKSUM stored at /etc/engine/version.info.
In case of success this validity check passes. In case of error an error message should be prompted.
It will also be possible to run the script via mvn test at the DAL module or root pom level by providing the flag -D db.checksum.check=false</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>The benefit for oVirt from this feature is the ability to ensure at customers sites (and also for oVirt developers) that there is a parity between the schema version as reflected from the code, and the one that is calculated in the DB. Adding this check to a service that will start the jboss service will prevent the system from working with corrupted/mismatched DB.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>Dependencies on features:</p>

<p>Affected oVirt projects:</p>

<ul>
  <li>Engine-core</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3192/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3192/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3192/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3192/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/dbschemaversioncheck.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/dbschemaversioncheck.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
