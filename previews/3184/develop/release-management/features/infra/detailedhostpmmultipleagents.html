<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DetailedHostPMMultipleAgents | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="DetailedHostPMMultipleAgents" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3184/develop/release-management/features/infra/detailedhostpmmultipleagents.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3184/develop/release-management/features/infra/detailedhostpmmultipleagents.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DetailedHostPMMultipleAgents" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"DetailedHostPMMultipleAgents","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3184/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3184/develop/release-management/features/infra/detailedhostpmmultipleagents.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3184/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3184/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3184/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3184/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3184/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3184/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3184/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3184/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3184/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3184/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3184/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3184//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3184/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eli Mesika">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3184/documentation/'>Documentation is available here.</a></div>

<h1 id="detailed-host-pm-multiple-agents">Detailed Host PM Multiple Agents</h1>

<h2 id="host-power-management-multiple-agent-support">Host Power Management Multiple Agent Support</h2>

<h3 id="summary">Summary</h3>

<p>Current implementation assumes that a Host that its Power Management is configured has only one fencing agent from a certain type (i.e. rsa, ilo, apc etc.)
This document describes what should be done in order to support dual-power Hosts in which each power switch may have its own agent or two agents connected to the same power switch.
Agents may be from same or different type
We will treat current Power Management agent as Primary Agent and the added one as Secondary Agent.</p>

<h3 id="owner">Owner</h3>

<ul>
  <li>
    <p>Feature owner: Eli Mesika (emesika)</p>

    <ul>
      <li>
        <p>GUI Component owner: Eli Mesika (emesika)</p>
      </li>
      <li>
        <p>REST Component owner: Eli Mesika (emesika)</p>
      </li>
      <li>
        <p>Engine Component owner: Eli Mesika (emesika)</p>
      </li>
      <li>
        <p>QA Owner: Yaniv Kaul (ykaul)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Email: emesika@redhat.com</p>
  </li>
</ul>

<h3 id="current-status">Current status</h3>

<ul>
  <li>Target Release: 3.2</li>
  <li>Status: Design</li>
  <li>Last updated date: Nov 15 2012</li>
</ul>

<h3 id="detailed-description">Detailed Description</h3>

<p>There may be two main configurations for Primary/Secondary Agents:
1) Concurrent, when Host is fenced both agents are used concurrently, for Stop command we need both to succeed and for Start command if one succeeded the Host is considered to be UP.
 <img src="/ovirt-site/previews/3184/images/wiki/Hostdualpower.png" alt="" />
 2) Sequential, when Host is fenced either for Stop or Start commands, Primary Agent is used, if it fails (after all configured retries) then the Secondary Agent is used.
 <img src="/ovirt-site/previews/3184/images/wiki/Hostsinglepower.png" alt="" /></p>

<h3 id="crud">CRUD</h3>

<p>Adding the following columns to vds_static:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="n">pm_secondary_ip</span>
      <span class="n">pm_secondary_options</span>
      <span class="n">pm_secondary_port</span>
      <span class="n">pm_secondary_password</span>
      <span class="n">pm_secondary_user</span>
      <span class="n">pm_secondary_type</span>
      <span class="n">pm_secondary_concurrent</span>
</code></pre></div></div>

<p>Views:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">vds</span> <span class="p">(</span><span class="n">adding</span> <span class="k">all</span> <span class="n">pm_secondary</span><span class="o">*</span> <span class="n">fields</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="n">vds_with_tags</span> <span class="p">(</span><span class="n">adding</span> <span class="k">all</span> <span class="n">pm_secondary</span><span class="o">*</span> <span class="n">fields</span><span class="p">)</span>
      <span class="n">dwh_host_configuration_history_view</span> <span class="p">(</span><span class="n">adding</span> <span class="k">only</span> <span class="n">pm_secondary_ip</span><span class="p">)</span>
      <span class="n">dwh_host_configuration_full_check_view</span> <span class="p">(</span><span class="n">adding</span> <span class="k">only</span> <span class="n">pm_secondary_ip</span><span class="p">)</span>
</code></pre></div></div>

<p>Stored Procedures:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="n">InsertVdsStatic</span>
      <span class="n">UpdateVdsStatic</span>
      <span class="n">InsertVds</span>
</code></pre></div></div>

<h4 id="dao">DAO</h4>

<p>Adding handling of <code class="language-plaintext highlighter-rouge">pm_secondary*</code> fields to</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VdsStaticDAODbFacadeImpl</span>
<span class="n">VdsDAODbFacadeImpl</span>
</code></pre></div></div>

<h4 id="metadata">Metadata</h4>

<p>Adding test data for <code class="language-plaintext highlighter-rouge">VdsStaticDAOTest</code> and <code class="language-plaintext highlighter-rouge">fixtures.xml</code></p>

<h3 id="configuration">Configuration</h3>

<p>Change default configuration <code class="language-plaintext highlighter-rouge">FenceStopStatusDelayBetweenRetriesInSec</code> and <code class="language-plaintext highlighter-rouge">FenceStartStatusDelayBetweenRetriesInSec</code> to 10 and <code class="language-plaintext highlighter-rouge">FenceStopStatusRetries</code> , <code class="language-plaintext highlighter-rouge">FenceStartStatusRetries</code> to 18, this will insure we are responding faster to Hosts while it change status.</p>

<h3 id="business-logic">Business Logic</h3>

<p>Add <code class="language-plaintext highlighter-rouge">pm_secondary*</code> fields to <code class="language-plaintext highlighter-rouge">VdsStatic</code>
Add <code class="language-plaintext highlighter-rouge">pm_secondary*</code> fields to <code class="language-plaintext highlighter-rouge">VDS</code>
 Changing <code class="language-plaintext highlighter-rouge">FenceVdsBaseCommand::executeCommand()</code> to handle all scenarios described in <a href="#flow">Flow</a></p>

<h3 id="api">API</h3>

<p>The REST API will be enhanced to include the multiple Agents definitions as follows
Keep in mind that we should preserve the former syntax for backward compatibility and deprecate it in future
For any case in which we found old flat PM definitions and other definitions inside the agents block, the setting in the agent block will take presence.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;power_management</span> <span class="na">type=</span><span class="s">"rsa"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
  <span class="nt">&lt;address&gt;</span>ip or fqdn<span class="nt">&lt;/address&gt;</span>
  <span class="nt">&lt;username&gt;</span>user<span class="nt">&lt;/username&gt;</span>
  <span class="nt">&lt;password&gt;</span>password<span class="nt">&lt;/password&gt;</span>
  <span class="nt">&lt;options&gt;&lt;option</span> <span class="na">value=</span><span class="s">""</span> <span class="na">name=</span><span class="s">"port"</span><span class="nt">/&gt;&lt;option</span> <span class="na">value=</span><span class="s">"false"</span> <span class="na">name=</span><span class="s">"secure"</span><span class="nt">/&gt;&lt;/options&gt;</span>
  <span class="nt">&lt;agents&gt;</span>
    <span class="nt">&lt;agent</span> <span class="na">type=</span><span class="s">"rsa"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;address&gt;</span>ip or fqdn<span class="nt">&lt;/address&gt;</span>
      <span class="nt">&lt;username&gt;</span>user<span class="nt">&lt;/username&gt;</span> order="primary"
      <span class="nt">&lt;password&gt;</span>password<span class="nt">&lt;/password&gt;</span>
      <span class="nt">&lt;options&gt;&lt;option</span> <span class="na">value=</span><span class="s">""</span> <span class="na">name=</span><span class="s">"port"</span><span class="nt">/&gt;&lt;option</span> <span class="na">value=</span><span class="s">"false"</span> <span class="na">name=</span><span class="s">"secure"</span><span class="nt">/&gt;&lt;/options&gt;</span>
      <span class="nt">&lt;concurrent&gt;</span>false<span class="nt">&lt;/concurrent&gt;</span>
      <span class="nt">&lt;order&gt;</span>1<span class="nt">&lt;/order&gt;</span>
    <span class="nt">&lt;/agent&gt;</span>
    <span class="nt">&lt;agent</span> <span class="na">type=</span><span class="s">"ipmi"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;address&gt;</span>ip or fqdn<span class="nt">&lt;/address&gt;</span>
      <span class="nt">&lt;username&gt;</span>user<span class="nt">&lt;/username&gt;</span> order="primary"
      <span class="nt">&lt;password&gt;</span>password<span class="nt">&lt;/password&gt;</span>
      <span class="nt">&lt;options&gt;&lt;option</span> <span class="na">value=</span><span class="s">""</span> <span class="na">name=</span><span class="s">"port"</span><span class="nt">/&gt;&lt;option</span> <span class="na">value=</span><span class="s">"false"</span> <span class="na">name=</span><span class="s">"secure"</span><span class="nt">/&gt;&lt;/options&gt;</span>
      <span class="nt">&lt;concurrent&gt;</span>false<span class="nt">&lt;/concurrent&gt;</span>
      <span class="nt">&lt;order&gt;</span>2<span class="nt">&lt;/order&gt;</span>
    <span class="nt">&lt;/agent&gt;</span>
    ...
  <span class="nt">&lt;/agents&gt;</span>
<span class="nt">&lt;/power_management&gt;</span>
</code></pre></div></div>

<p><em>concurrent</em> flag will be handled in the Host level
Add custom mapping for these new power-management fields in HostMapper.java, for both REST–&gt;Backend and Backend–&gt;REST directions)</p>

<h3 id="flow">Flow</h3>

<p><strong>No Secondary Agent</strong>
If no Power Management is defined , the Stop/Start scenarios works without a change. For example, the Restart scenario is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Send a Stop command
   Wait for status 'off' [1]
   Send a Start command
   Wait for status 'on' [2]
</code></pre></div></div>

<p>If a secondary agent is defined
 <strong>Sequential</strong>:
 Send a Stop command to Primary agent</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Wait for status 'off' [1]
   If Stop failed
      Send a Stop command to Secondary agent and wait for status 'off'
   Send a Start command to Primary agent
   Wait for status 'on' [2]
   If Start failed
      Send a Start command to Secondary agent and wait for status 'on'
</code></pre></div></div>

<p><strong>Concurrent</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Send a Stop command to Primary and Secondary agents
   Wait for status 'off' on both Primary and Secondary agents[1]
   Send a Start command to Primary and Secondary agents
   Wait for status 'on' on either  Primary or Secondary agent[2]
</code></pre></div></div>

<p>[1] Controlled by FenceStopStatusDelayBetweenRetriesInSec,FenceStopStatusRetries configuration values
[2] Controlled by FenceStartStatusDelayBetweenRetriesInSec,FenceStartStatusRetries configuration values</p>

<h3 id="user-experience">User Experience</h3>

<p>A new drop-down box will be added to the Power Management screen that enables selection of Primary/Secondary agents in order to insert agent details and test the agent.
The Concurrent check box controls if the secondary agent works in the concurrent or sequential mode
 <img src="/ovirt-site/previews/3184/images/wiki/Pmmultiagentscreen.png" alt="" /></p>

<h3 id="installationupgrade">Installation/Upgrade</h3>

<p>Add the new <code class="language-plaintext highlighter-rouge">pm_secondary*</code> columns in the upgrade script.</p>

<h4 id="user-work-flows">User work-flows</h4>

<h3 id="enforcement">Enforcement</h3>

<h3 id="dependencies--related-features-and-projects">Dependencies / Related Features and Projects</h3>

<h4 id="affected-ovirt-projects">Affected oVirt projects</h4>

<p><a href="/ovirt-site/previews/3184/develop/release-management/features/infra/hostpmproxypreferences.html">Host Power Management Proxy Preferences</a></p>

<h3 id="documentation--external-references">Documentation / External references</h3>

<p><a href="/ovirt-site/previews/3184/develop/release-management/features/infra/hostpmmultipleagents.html">Features/HostPMMultipleAgents</a></p>

<h3 id="future-directions">Future Directions</h3>

<p>For 3.2 we will handle only Primary/Secondary agents
We may add 3rd agent support in future to handle other scenarios</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3184/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3184/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3184/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3184/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/detailedhostpmmultipleagents.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/detailedhostpmmultipleagents.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
