<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hosted engine VM management | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Hosted engine VM management" />
<meta name="author" content="Roy Golan" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3015/develop/release-management/features/sla/hosted-engine-vm-management.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3015/develop/release-management/features/sla/hosted-engine-vm-management.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hosted engine VM management" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Roy Golan" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Roy Golan"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Hosted engine VM management","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3015/images/logo.svg"},"name":"Roy Golan"},"url":"https://ovirt.github.io/ovirt-site/previews/3015/develop/release-management/features/sla/hosted-engine-vm-management.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3015/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3015/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3015/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3015/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3015/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3015/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3015/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3015/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3015/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3015/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3015/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3015/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3015/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3015/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3015/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3015/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3015/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3015/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3015/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3015/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3015/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3015/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3015//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3015//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3015/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3015/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3015/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3015/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3015/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6a6ee5db5d55d1918022cb4a22f64286?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Roy Golan">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Roy Golan</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/65fafd7adcef0c369b149759491fae7f?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Sandro Bonazzola">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard"><a rel="author" href="https://twitter.com/sandrobonazzola" title="Sandro Bonazzola">Sandro Bonazzola</a></span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3015/documentation/'>Documentation is available here.</a></div>

<h1 id="hosted-engine-vm-management-enhancements">Hosted engine VM management enhancements</h1>

<h2 id="summary">Summary</h2>

<ol>
  <li>Allow editing the Hosted engine VM, storage domain, disks, networks etc - new feature</li>
  <li>Have a shared configuration for the hosted engine VM - new feature</li>
  <li>Have a backup for the hosted engine VM configuration - new feature</li>
</ol>

<p>the 1st feature by-products are the 2nd and 3rd.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Roy Golan <a href="mailto:rgolan@redhat.com">rgolan@redhat.com</a></li>
  <li>Sandro Bonazzola <a href="mailto:sbonazzo@redhat.com">sbonazzo@redhat.com</a></li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>Managing the hosted-engine engine VM is a non trivial taks and mostly manual today. if the engine Vm needs tuning, or some addition(add a device), one must reach all the hosted engine capable hosts and alter the local /etc/ovirt-hosted-engine/vm.conf instances. Although visible in the UI, the engine-VM have most of the provisioning actions blocked, as the VM is a external or foreign VM to the setup, as we don’t manage its Storage Domains, Disks, Data-Center and Networks.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>The engine-VM should be treated as any other VM in the system, from provisioning standpoint. We should be able to edit its configuration using webadmin or API and expect the next time it will run it will take effect. This saves the time consuming, error-prone, non-trivial task of updating the vm.conf under each and every capable host in the system. As a regular VM, the engine VM would automatically gain most of the functionally supported by ovirt. More-over, the engine VM configuration would be backed up in the engine DB and in the OVF_STORE under the preconfigured hosted engine storage domain.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<ul>
  <li>vdsmcli API must be changed for allowing to start a VM provided the VM UUID (OVF can be taken from OVF_STORE automatically just giving the VM UUID)</li>
  <li>host-deploy must be changed in order to allow the deployment / configuration of the ha daemons (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1200469">Bug 1200469</a> - [RFE] add support for hosted-engine deployment on additional hosts)</li>
  <li>[<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1139793">Bug 1139793</a> - [RFE] Keep hosted engine VM configuration in the shared storage</li>
  <li>ovirt-engine must be changed for allowing hosted-engine storage domain to be visible / handled</li>
  <li>ovirt-engine must be changed to allow the deployment of hosted-engine nodes from the portal (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1167262">Bug 1167262</a> - [RFE] allow to deploy additional hosts from webadmin portal)</li>
  <li>ovirt-ha daemons should use vdscli new API instead of using legacy vdsClient (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1101554">Bug 1101554</a> - [RFE] Use vdsm api instead of vdsClient ) in order to start the VM by UUID</li>
</ul>

<h2 id="design">Design</h2>

<h3 id="high-level-flow">High level flow</h3>

<ol>
  <li>installation creates and upload the OVF {VM guid}.ovf to a pre-created OVF_DISK</li>
  <li>HA Agent read’s OVF from OVF_STORE</li>
  <li>watchdog send a vdsm “create” verb with the OVF as argument. VM starts.</li>
  <li>Installation imports the SD into ovirt-engine</li>
  <li>Installation imports the engine VM from the OVF which resides in OVF_STORE</li>
  <li>Changes made to the engine VM are persisted back to the OVF_STORE under the OVF file</li>
  <li>Regular API usage apply to the engine VM - should we prevent the engine VM deletion or one of its disks? (for sure make it delete protected at first)</li>
</ol>

<h3 id="user-experience">User Experience</h3>

<h4 id="crud">CRUD</h4>

<ul>
  <li>Waiting for the RFE for full requirements*</li>
</ul>

<p>engine VM is auto added to engine(no change 3.5) Initially, once the Host is doing the first Vm monitoring cycle it will auto add the engine VM to ovirt-engine. the VM then will be an “External VM” - it can’t be edited. import storage domain <strong><em>[4]</em></strong> Now the storage domain which have the OVF_STORE disks previously created by hosted-engine setup must be imported into the engine. Engine 3.5 already support importing a storage domain.</p>

<p>import the VM from OVF_STORE disks <strong><em>[5]</em></strong> Once the domain is imported, the OVFs in the OVF_STORE can be read by engine and be imported into the setup. Importing a VM from OVF on OVF_STORE disk is supported in 3.5</p>

<p><strong>Once the engine VM is imported a user can:</strong></p>

<ul>
  <li>add/edit VM configuration</li>
  <li>add/edit disks</li>
  <li>add/edit nics</li>
  <li>edit certain storage domain attributes //TODO need editing</li>
</ul>

<p>overall interface has on real change.</p>

<p>could be nice to have - a special icon/markup on the VMs grid to distinguish it from other VMs</p>

<p><strong>Some operation are blocked altogether using CanDoAction:</strong></p>

<ul>
  <li>remove storage domain</li>
  <li>remove OVF_STORE disk</li>
  <li>any other actions should be prevented in order not to chop the branch we sit on</li>
</ul>

<h4 id="installupgrade">Install/Upgrade</h4>

<h5 id="fresh-install">Fresh install</h5>

<ol>
  <li>ovirt-hosted-engine-setup shall create an OVF_STORE disk (using vdsm api)</li>
  <li>ovirt hosted-engine-setup shall store the vm config as OVF in the disk (using vdsm api)</li>
  <li>post VM install and verification, setup should add the SD which the OVF_STORE</li>
  <li>located on the engine-VM (engine api)</li>
  <li>engine VM shall be imported from the SD above mentioned (engine api)</li>
</ol>

<h5 id="upgrade">Upgrade</h5>

<ol>
  <li>convert the current vm.conf to OVF(some python util?) or export the OVF from the engine DB (should be there under vm_ovf_generations)</li>
  <li>create OVF store disk on the existing hosted engine SD (vdsm api) - or maybe it already exists? need to check that</li>
  <li>import SD (engine api)</li>
  <li>import VM (engine api)</li>
</ol>

<h5 id="persistency">Persistency</h5>

<p>Once imported, the VM is considered a regular VM and every changed to its configuration is exported to its underlying OVF on the OVF_STORE. That way changes are persistent and shared across all cluster nodes.</p>

<p>All VM changes are persisted to OVF_STORE once an hour by a task which isn’t good for this case. Changes to Engine VM should be persisted synchronously <strong><em>[6]</em></strong> user should be able to edit the VM and after short time the changes should already be persisted.</p>

<table>
  <tbody>
    <tr>
      <td>This means that editing an engine-VM must trigger a new upload of tar.gz to the host of the new OVF. ovirt-engine must have a nice separation in CRUD operations on</td>
      <td>engine-VM in order not to fill up the code with if-(hosted-engine)-then(do)-else It would be an enhancement if VDSM would be able to get a single ovf updated instead of whole new tar.gz</td>
    </tr>
  </tbody>
</table>

<h2 id="open-issues">Open Issues</h2>

<p>There is no easy way to convert an OVF to vm.conf in a standalone way. OVF have engine specific information which VDSM isn’t aware of (cluster-specific details, osinfo details, internal engine enum id’s and so on) - see Documentation / External references</p>

<p>TODO - map what fields rely on engine - some may be not that important for now and some may be extended to be non engine dependant in some way (e.g display protocol as sting “vnc” instead of a number) - see Documentation / External references VDSM maintainers might not accept to handle OVF file as an alternative argument for the “create” verb. so instead of putting the translation of OVF-vmParams in VDSM we might expose that tool differently.</p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li>Bug: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1160094">1160094</a></li>
  <li>OVF -&gt; vm.conf compatibility - in effort to understand the gap for of OVF to vm.conf or vmParameters (the vm arguments for starting a VM using VDSM API)</li>
</ul>

<h2 id="testing">Testing</h2>

<p>//TODO</p>

<h2 id="release-notes">Release Notes</h2>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3015/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3015/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3015/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3015/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/hosted-engine-vm-management.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/hosted-engine-vm-management.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
