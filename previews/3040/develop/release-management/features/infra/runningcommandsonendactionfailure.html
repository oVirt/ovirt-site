<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>RunningCommandsOnEndActionFailure | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="RunningCommandsOnEndActionFailure" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3040/develop/release-management/features/infra/runningcommandsonendactionfailure.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3040/develop/release-management/features/infra/runningcommandsonendactionfailure.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="RunningCommandsOnEndActionFailure" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"RunningCommandsOnEndActionFailure","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3040/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3040/develop/release-management/features/infra/runningcommandsonendactionfailure.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3040/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3040/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3040/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3040/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3040/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3040/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3040/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3040/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3040/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3040/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3040/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3040/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3040/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3040/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3040/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3040/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3040/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3040/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3040/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3040/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3040/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3040/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3040//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3040//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3040/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3040/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3040/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3040/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3040/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/cf9b98d6d79d0dd07d167017789bac45?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Yair Zaslavsky">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yair Zaslavsky</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3040/documentation/'>Documentation is available here.</a></div>

<h1 id="running-commands-on-endaction-failure">Running commands on endAction failure</h1>

<h2 id="summary">Summary</h2>

<p>This design discusses the need for running commands during the step of ending action on failure (as a part of rollback mechanism that does not depent on the VDSM verb RevertTask).</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Yair Zaslavsky (Yair Zaslavsky)</li>
</ul>

<h2 id="current-status">Current status</h2>

<ul>
  <li>Last updated date: Sun Feb 26 2012</li>
</ul>

<h2 id="motivation">Motivation</h2>

<p>The motivation will be provided by an example (other flows may need this mechanism as well):</p>

<ul>
  <li>AddVmFromTemplate command creates a VM based on a given template.</li>
  <li>The commands invokes internally for each image related with the template a CreateCloneFromTemplate command.</li>
  <li>CreateCloneFromTemplateCommand invokes the CopyImage VDSM verb.</li>
  <li>CopyImage is an asynchronous operation, and monitored by an async task.</li>
  <li>If one of the of the tasks fails, all the sibling tasks should be reverted - this is usually done using the revert task mechanism.</li>
  <li>The revert task mechanism performs the VDSM verb SPMRevertTask, but for there is no implementation of task reverting for CopyImage at VDSM.</li>
  <li>Engine-core should implement a mechanism that will know how to issue an “opposite command” to the copy image for each successful sibling task to the failed task.</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<ul>
  <li>All tasks are created with the same entity ID (the cloned VM) ID - as a result, failure in one of them will yield invocation of AddVmFromTemplate.endWithFailure</li>
  <li>endWithFailure will invoke in turn endWithFailure on each one of the child commands (CreateCloneFromTemplate).</li>
  <li>CreateCloneFromTemplate will call revertTasks method.</li>
  <li>The revertTasks method will invoke the RemoveImageCommand, setting the parent command to CreateCloneFromTemplate</li>
  <li>In order to avoid invocation of CreateCloneFromTemplate.endSuccessfully upon successful image removal, and to invoke the endWithFailure instead the following will be added:</li>
</ul>

<ol>
  <li>a new field will be introduced to VdcActionParameterBase: ExecutionReason executionReason.</li>
  <li>ExecutionReason is an enum with values of REGULAR_FLOW (which is the default value) and ROLLBACK_FLOW (which is the flow for the current described scenario of invoking command from endWithFailure)</li>
  <li>AsyncTaskManager code will be changed in such a way that if the parameters include executionReason with value of ROLLBACK_FLOW, even in case of successful execution, endithFailure will be executed.</li>
  <li>In order to prevent endless loop of invocation of remove image, due to end less return to CreateCloneFromTemplate, a check for checking if the image exist in DB will be added (RemoveImage will be executed only in case the image does not exist in DB).</li>
</ol>

<ul>
  <li>In order to have ROLLBACK_FLOW value persistent, it will be set on the parameters, prior to the task creation (which creates an entry in async_tasks table with serialized parameters).</li>
  <li>As tasks are being pollled only during “executeAction” stage (command starts execution) it is required to add task polling at the end of the command that invokes the rollback command (after the rollback command is invoked).</li>
  <li>The entity ID for which the rollback task is created should be the entity ID of the command creating the rollback command (i.e - destination image ID in case of CreateCloneOfTemplate that invokes RemoveImageCommand which in turn creates a task).</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Implementing such mechanism will contribute to resource consistency of engine-core, in a sense that no “leftover resources” will remain at VDSM.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>Dependencies on features:</p>

<p>Affected oVirt projects:</p>

<ul>
  <li>Engine-core</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3040/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3040/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3040/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3040/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/runningcommandsonendactionfailure.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/infra/runningcommandsonendactionfailure.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
