<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Normalizing scheduling policy weights | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Normalizing scheduling policy weights" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2778/develop/release-management/features/sla/scheduling-weight-normalization.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2778/develop/release-management/features/sla/scheduling-weight-normalization.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Normalizing scheduling policy weights" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2778/images/logo.svg"}},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Normalizing scheduling policy weights","url":"https://ovirt.github.io/ovirt-site/previews/2778/develop/release-management/features/sla/scheduling-weight-normalization.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2778/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2778/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2778/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2778/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2778/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2778/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2778/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2778/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2778/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2778/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2778/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2778/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2778/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2778/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2778/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2778/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2778/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2778/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2778/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2778/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2778/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2778/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2778/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2778/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2778/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2778/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2778/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2778/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2778/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2778/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2778/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2778/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2778/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2778/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2778/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2778//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2778//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2778/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2778/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2778/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2778/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2778/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d3e5014dcc318e6606b18a8f5fd90dae?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d3e5014dcc318e6606b18a8f5fd90dae?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Martin Sivak</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2778/documentation/'>Documentation is available here.</a></div>

<h2 id="normalizing-scheduling-policy-weights">Normalizing scheduling policy weights</h2>

<h3 id="summary">Summary</h3>

<p>The currently used weight policy units do not use any common result value range. Each unit reports numbers as needed and this causes issues with user configured preferences (policy unit multiplier), because for example memory (very high numbers) always wins over CPU (0-100).</p>

<h3 id="owner">Owner</h3>

<ul>
  <li>Name: <a href="User:msivak">Martin Sivák</a></li>
  <li>Email: <a href="mailto:msivak@redhat.com">msivak@redhat.com</a></li>
</ul>

<h3 id="detailed-description">Detailed Description</h3>

<h4 id="comparing-the-current-cpu-and-memory-weight-units">Comparing the current CPU and memory weight units</h4>

<p>I selected the CPU vs. memory balancing to demonstrate the issue and the possible fix.</p>

<p>The CPU load policy unit is currently not effective as the weight values used are too low (0-100) and the memory policy unit almost always overrules the CPU (2**31 - max scheduling memory in MB). The factor value the user can assign to the policy units is confusing for this reason, because 2x memory weight has a huge impact, but 1000x CPU weight is still not enough to overrule memory.</p>

<h4 id="weight-normalization-algorithms">Weight normalization algorithms</h4>

<p>As you see in the CPU and memory example we have to either normalize the weights reported by all policy units (either manually in the code or automatically) or use some different reduction step.</p>

<p>I was reading a bit and the three basic normalization options we can use are:</p>

<ul>
  <li>Using percentage of hardcoded maximum values for each policy unit</li>
  <li>Using percentage of the maximum reported value (during the scheduling attempt) of a policy unit</li>
  <li>Using rank (sorting reported weights and awarding points according to the position; my example calculation computes rank as number of hosts that are better than the ranked one)</li>
</ul>

<p>All three options have advantages and disadvantages. Hardcoded maximum is obviously a problem for future memory size values, dynamic maximum depends on which hosts make it into the weighting step and rank does not do a good job when there are huge gaps in weight values.</p>

<p>Personally I am in favour of testing rank though as it is future proof and the factor multiplier has predictable results (and we already have the code too).</p>

<h4 id="algorithm-results-comparison">Algorithm results comparison</h4>

<p>This is a simple case where all three algorithms report the same result. That won’t always be so.</p>

<ul>
  <li>CPU, factor 10 (hardcoded maximum 100%)</li>
  <li>Memory, factor 1 (hardcoded maximum 4096 MB)</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Host / Metric</th>
      <th>CPU load</th>
      <th>Occupied memory</th>
      <th>Normalized (lower is better)</th>
      <th>Normalized dynamic (lower is better)</th>
      <th>Ranked (lower is better)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Host A</td>
      <td>90</td>
      <td>1024 MB</td>
      <td>10 * 90 + 25 = 925</td>
      <td>10 * 100 + 25 = 1025</td>
      <td>10 * 2 + 0 = 20</td>
    </tr>
    <tr>
      <td>Host B</td>
      <td>50</td>
      <td>2048 MB</td>
      <td>10 * 50 + 50 = 550</td>
      <td>10 * 55 + 50 = 600</td>
      <td>10 * 1 + 1 = 11</td>
    </tr>
    <tr>
      <td>Host C</td>
      <td>10</td>
      <td>4096 MB</td>
      <td>10 * 10 + 100 = 200</td>
      <td>10 * 11 + 100 = 210</td>
      <td>10 * 0 + 2 = 2</td>
    </tr>
  </tbody>
</table>

<h3 id="benefit-to-ovirt">Benefit to oVirt</h3>

<p>The multiplier factor in the Scheduling policy edit dialog will become predictable. This will also allow the user to fine tune his preferences (for example: CPU vs. memory vs. weak affinity rules).</p>

<h3 id="implementation-details">Implementation details</h3>

<h4 id="scheduling-process-changes">Scheduling process changes</h4>

<p>The existing policy units won’t be affected. The normalization process will be done by adding an extra step to the current Filter / Weight sequence. It will become Filter / Weight / Select.</p>

<h4 id="user-experience">User Experience</h4>

<p>No changes to the UI or REST will be necessary, this change will be totally transparent.</p>

<h4 id="installationupgrade">Installation/Upgrade</h4>

<p>Users using the weight multipliers might need to update them to reasonable values.</p>

<h3 id="dependencies--related-features">Dependencies / Related Features</h3>

<p>This normalization is needed as a ground work for all weak affinity features, including host affinity and Rack based balancing.</p>

<h3 id="documentation--external-references">Documentation / External references</h3>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1207255">Bug: Soft negative affinity</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1306263">Bug: Normalize policy unit weights</a></li>
</ul>

<h3 id="testing">Testing</h3>

<p>Basic sanity checks for scheduling VMs are needed. The internal weighting rules were never really exposed so a slight change in behaviour might not be even noticed.</p>

<p>The selection step result is visible in the DEBUG log (logger name: org.ovirt.engine.core.bll.scheduling.policyunits.RankSelectorPolicyUnit) in a CSV table form. Each row represents one weight unit and columns representing hosts have two walues: rank (higher is better), raw weight returned by policy unit.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2016-12-01 18:03:18,299+01 DEBUG [org.ovirt.engine.core.bll.scheduling.policyunits.RankSelectorPolicyUnit] (org.ovirt.thread.pool-6-thread-49) [ceadae95-bc68-4ae7-ac85-55b610194981] Ranking selector:
*;factor;4adcef93-a088-437e-ac0d-479046deae71;;5bec53b1-548a-4f3a-beee-ee55c9180b34;;71d65d53-bd3d-4028-b5f8-ec4f4f276394;
98e92667-6161-41fb-b3fa-34f820ccbc4b;1;2;1;2;1;2;1
84e6ddee-ab0d-42dd-82f0-c297779db567;1;2;1;2;1;2;1
7db4ab05-81ab-42e8-868a-aee2df483edb;1;2;4;0;5;2;4
7f262d70-6cac-11e3-981f-0800200c9a66;1;2;0;2;0;2;0
591cdb81-ba67-45b4-9642-e28f61a97d57;1;2;10000;2;10000;2;10000
4134247a-9c58-4b9a-8593-530bb9e37c59;1;2;1;2;1;0;47
</code></pre></div></div>

<p>Testing with many different VMs might reveal interesting situations though.</p>

<h3 id="contingency-plan">Contingency Plan</h3>

<p>The feature is ready and only needs to be enabled.</p>

<h3 id="release-notes">Release Notes</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  == Scheduling multipliers changed ==
  The impact of scheduling multipliers was changed as the underlying weight values were normalized. Please check that the values you use represent the real relative value of importance instead of empirical number that you used to get the desired behaviour in the past.
</code></pre></div></div>

<h3 id="comments-and-discussion">Comments and Discussion</h3>

<p>Please use the devel@ovirt.org mailinglist for discussing this feature.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2778/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2778/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2778/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2778/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/scheduling-weight-normalization.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/sla/scheduling-weight-normalization.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
