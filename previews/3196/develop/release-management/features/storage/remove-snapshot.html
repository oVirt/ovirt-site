<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Remove Snapshot | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Remove Snapshot" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/storage/remove-snapshot.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/storage/remove-snapshot.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Remove Snapshot" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Remove Snapshot","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3196/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3196/develop/release-management/features/storage/remove-snapshot.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3196/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3196/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3196/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3196/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3196/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3196/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3196/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3196/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3196/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3196/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3196/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3196//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3196/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/4c272a93ab76b20b3f96ab8c2523aa6a?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/4c272a93ab76b20b3f96ab8c2523aa6a?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Ala Hino">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Ala Hino</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3196/documentation/'>Documentation is available here.</a></div>

<h1 id="remove-snapshot">Remove Snapshot</h1>

<h2 id="summary">Summary</h2>

<p>Use <code class="language-plaintext highlighter-rouge">qemu-img commit</code> instead of ‘qemu-img rebase’ when deleting snapshots while the VM is down.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Ala Hino</li>
  <li>Email: <a href="mailto:ahino@redhat.com">ahino@redhat.com</a></li>
</ul>

<h2 id="terminology">Terminology</h2>

<p>This feature page is about removing snapshots when the VM is down. Today, the term ‘Live Merge’ is used to describe removing snapshots while the VM is running. I will use ‘Cold Merge’ when referring to removing snapshots while the VM is down.</p>

<h2 id="background">Background</h2>

<p>Initially, when Cold Merge feature was implemented, qemu-img didn’t support <code class="language-plaintext highlighter-rouge">commit</code> operations hence, qemu-img <code class="language-plaintext highlighter-rouge">rebase</code> performed. When running <code class="language-plaintext highlighter-rouge">qemu-img rebase</code>, a temporary volume is created, and data is copied from base volume to the temporary volume. In certain, is not in most, use cases, <code class="language-plaintext highlighter-rouge">qemu-img rebase</code> could take long time, because the base volume is significantly larger than the top volume.</p>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Removing snapshots will work faster when the VM is not running.</p>

<h2 id="design">Design</h2>

<h3 id="design-considerations">Design considerations:</h3>

<ul>
  <li>SPM is a bottleneck and we want to reduce SPM tasks as much as possible</li>
  <li>Live and Cold merge flows are equivalent so it is a good chance to have a single implementation for both flows.</li>
</ul>

<h3 id="flow">Flow:</h3>

<ul>
  <li>
    <p>Prepare</p>

    <p>Prepare step updates Vdsm metadata and must be run as SPM task.</p>

    <ul>
      <li>
        <p>Mark base volume as ILLEGAL</p>

        <p>Mark base volume as ILLEGAL in order to prevent running the VM while cold merge is running.</p>
      </li>
      <li>
        <p>Update base capacity</p>

        <p>If top volume is larger than base volume size, update base volume capacity:
  If base volume is block and RAW, extend LV. Otherwise, update Vdsm volume metadata.</p>
      </li>
      <li>
        <p>Update base allocation</p>

        <p>For now, base volume allocation is updated to worse case, i.e. to minimum of top-size + size and to maximum allocation:</p>

        <p>potential-alloc = base-size + top-size
  max-alloc = base-capacity * 1.1 (QCOW-OVERHEAD)
  new-alloc = min(potential-alloc, max-alloc)</p>

        <p>In the future the plan is to use <code class="language-plaintext highlighter-rouge">qemu-img map</code> to calculate the accurate allocation size.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Merge</p>

    <p>Merge step is another data operation command and is implements as an SDM job.
  In this step, <code class="language-plaintext highlighter-rouge">qemu-img commit</code> is used to perform the merge.</p>
  </li>
  <li>
    <p>Finalize</p>

    <p>Finalize step updates Vdsm and qemu metadata and must be run as SPM task.</p>

    <ul>
      <li>
        <p>Update qemu metadata</p>

        <p>Update qemu metadata to reflect the chain after the merge. If the top volume is not the leaf, update its child parent to be the base volume. This is done by performing qemu-img rebase -u.</p>
      </li>
      <li>
        <p>Update Vdsm metadata</p>

        <p>Update Vdsm chain to reflect the cgain after mergre. This is done by execute Image.syncVolumeChain, providing a list without the removed volume.</p>
      </li>
      <li>
        <p>Mark base volume as LEGAL</p>

        <p>At this point, merge successfully completed, Vdsm and qemu chains updated, hence it is safe now to mark the base volume as LEGAL.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Destroy image
  Remove the top volume that was merged.</p>
  </li>
</ul>

<h3 id="recovery">Recovery</h3>

<p>Today, no recovery special handling is required because data is copied from base volume to top. This copy cannot end with data corruption hence, on failures, the admin simply needs to retry. However, when using <code class="language-plaintext highlighter-rouge">qemu-img commit</code>, data is copied from top to base, similar to Live Merge. In this case, recovery isn’t as trivial and recovery is performed based on the failure step:</p>

<ul>
  <li>
    <p>Engine reboot during Cold Merge</p>

    <p>If engine goes down during Cold Merge, there are two options when it comes up again:</p>

    <ul>
      <li>
        <p>The job still exists at the storage. In this case, we continue monitoring the job</p>
      </li>
      <li>
        <p>The job doesn’t exist at the storage. In this case, as done in Live Merge, we continue to Merge Status and check whether the volume exists in the chain. If not, flow continues; oOtherwise, the opeartion fails</p>
      </li>
    </ul>
  </li>
  <li>
    <p>No connectivity to host during Cold Merge</p>

    <p>Once connectivity reestablished, the engine tries to continue monitoring the job on the host. There are two options:</p>

    <ul>
      <li>
        <p>The job exists on the host. In this case, the engine continues to monitor it</p>
      </li>
      <li>
        <p>The job wasn’t found on the host. In this case, the engine checks the base value state, if it is LEGAL, the merge didn’t start and the engine has to send merge command again; if the state is ILLEGAL, the engine fails the merge operation and the admin has to retry</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Vdsm fails to get Engine command</p>

    <p>Operation fails and the admin needs to try again</p>
  </li>
  <li>
    <p>Vdsm fails to return response to Engine</p>

    <p>Usually engine gets timeout when failing to get Vdsm response. In this case, as done in Live Merge, the operation fails and the admin needs to try merge again. However, where in Live Merge reporting errors to engine was naive, in this case Vdsm will report the exact errors to the engine: a job is running, base/top doesn’t exist, etc.</p>
  </li>
</ul>

<h2 id="security">Security</h2>

<p>No new consequences here; what run before this feature will behave the same wrt security and according to TLM</p>

<h2 id="upgrade">Upgrade</h2>

<p>Following table describes the behavior of the available deployments:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Old Engine</th>
      <th>New Engine</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Old Vdsm</td>
      <td>qemu-img rebase</td>
      <td>qemu-img rebase</td>
    </tr>
    <tr>
      <td>New Vdsm</td>
      <td>qemu-img rebase</td>
      <td>qemu-img commit</td>
    </tr>
  </tbody>
</table>

<h2 id="hosted-engine">Hosted Engine</h2>

<p>No effects is expected on hosted engine deployments</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3196/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3196/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3196/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3196/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2025 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/remove-snapshot.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/remove-snapshot.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
