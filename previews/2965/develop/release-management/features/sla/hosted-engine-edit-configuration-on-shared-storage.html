<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>hosted-engine-edit-configuration-on-shared-storage | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="hosted-engine-edit-configuration-on-shared-storage" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2965/develop/release-management/features/sla/hosted-engine-edit-configuration-on-shared-storage.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2965/develop/release-management/features/sla/hosted-engine-edit-configuration-on-shared-storage.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="hosted-engine-edit-configuration-on-shared-storage" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"hosted-engine-edit-configuration-on-shared-storage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2965/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/2965/develop/release-management/features/sla/hosted-engine-edit-configuration-on-shared-storage.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2965/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2965/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2965/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2965/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2965/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2965/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2965/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2965/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2965/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2965/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2965/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2965/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2965/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2965/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2965/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2965/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2965/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2965/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2965/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2965/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2965/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2965/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2965//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2965//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2965/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2965/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2965/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2965/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2965/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Jenny Tokar">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Jenny Tokar</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2965/documentation/'>Documentation is available here.</a></div>

<h1 id="allow-updating-hosted-engine-configuration-on-shared-storage">Allow updating Hosted Engine configuration on shared storage</h1>

<h2 id="summary">Summary</h2>
<p>Currently the hosted engine configuration is saved in a tar archive on a shared storage without any way of editing or updating it. This will allow users to easily update and get the shared configuration.</p>

<p>Currently there are two configuration archives on the shared storage, one contains the vm ovf and the other contains the hosted engine configuration.
For the first stage this feature will provide the ability to edit broker.conf (that is located inside the configuration archive), for the second stage support for editing parts of the vm ovf will be added.</p>

<h2 id="detailed-description">Detailed Description</h2>
<p>To achieve this new functionalities will be added to the hosted engine client:</p>

<h3 id="already-implemented">Already implemented:</h3>
<ol>
  <li>Set a new value</li>
  <li>Get the current value for a specific key</li>
</ol>

<h3 id="future-functionality">Future functionality:</h3>
<ol>
  <li>Get a list of all keys and their current value</li>
  <li>Download a configuration archive</li>
  <li>Upload a configuration archive</li>
</ol>

<h3 id="handling-keys-collisions">Handling keys collisions:</h3>
<p>Since there are two (and some day maybe more) editable files, the get and set methods will receive an optional argument: “type”.
This argument can be one of two options:</p>

<ol>
  <li>broker</li>
  <li>vm</li>
</ol>

<p>Currently only broker is supported.</p>

<p>In case of a collision the methods will return an error message with a request to use the desired type: “Duplicate key, please specify the key type.”</p>

<h3 id="handling-synchronization-on-the-shared-storage---optimistic-locking">Handling synchronization on the shared storage - optimistic locking:</h3>
<p>To avoid sync issues, before updating the archive, an md5 checksum will be calculated. A new archive will be created, and after that if the checksum of the original archive remained the same, the new archive will be moved instead of the old one.
In case the checksum is different an error will be returned: “Update failed. The configuration file was changed by somebody else, try again.“</p>

<h3 id="editable-keys-for-the-first-stage">Editable keys for the first stage:</h3>
<p>Broker.conf:</p>

<ol>
  <li>smtp-server</li>
  <li>smtp-port</li>
  <li>source-email</li>
  <li>destination-emails</li>
  <li>state_transition</li>
</ol>

<h2 id="usage-examples">Usage examples:</h2>

<h3 id="for-non-duplicate-keys">For non duplicate keys:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hosted-engine --set-shared-config key value
  sets the value, returns nothing

  hosted-engine --set-shared-config key value --type broker
  sets the value, returns nothing
  
  hosted-engine --get-shared-config key
  returns: key: value type

  hosted-engine --get-shared-config key --type broker
  returns: key:  value type
</code></pre></div></div>

<h3 id="for-duplicate-keys">For duplicate keys:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hosted-engine --set-shared-config key value
  returns an error: Duplicate key, please specify the key type.

  hosted-engine --set-shared-config key value --type broker
  sets the value, returns nothing

  hosted-engine --get-shared-config key
  returns an error: Duplicate key, please specify the key type.

  hosted-engine --get-shared-config key --type broker
  returns: key:  value type
</code></pre></div></div>

<h3 id="for-missing-keys">For missing keys:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hosted-engine --set-shared-config missing_key --type=broker
  returns an error:
  Invalid configuration key missing_key.
  Available keys are:
  broker : ['smtp-port', 'destination-emails', 'smtp-server', 'source-email', 'state_transition']
  
  hosted-engine --set-shared-config missing_key
  returns an error:
  Invalid configuration key missing_key.
  Available keys are:
  broker : ['smtp-port', 'destination-emails', 'smtp-server', 'source-email', 'state_transition']
  
  hosted-engine --get-shared-config key --type=missing_type
  returns an error:
  Invalid configuration type missing_type, supported types are: broker
</code></pre></div></div>

<h3 id="in-case-the-archive-was-changed-during-update">In case the archive was changed during update:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hosted-engine --set-shared-config key value
  returns an error: Update failed. The configuration file was changed by somebody else, try again.
</code></pre></div></div>

<h3 id="to-get-all-keys-and-values-not-yet-implemented">To get all keys and values (not yet implemented):</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    hosted-engine --get-all-config
    returns:
      type: broker  
      key: value
      key2: value
</code></pre></div></div>

<h2 id="detailed-design">Detailed Design</h2>

<h3 id="ovirt-hosted-engine-ha">ovirt-hosted-engine-ha</h3>

<h4 id="clientpy">Client.py</h4>

<ol>
  <li>Add a new method: set_config(key,value), the method will get a key and value that the user wants to update.</li>
  <li>Add a new method get_config(), the method will return the current configuration for the editable files (currently broker.conf).</li>
</ol>

<h4 id="configpy">Config.py</h4>

<ol>
  <li>Add a new set of sharedStorageFiles that will contain the names of the editable files that are stored in the shared storage archive</li>
  <li>Add a new dictionary: {type -&gt; {key -&gt; fileName}}</li>
  <li>Load the dictionary in the init method:
  Iterate over the editable files (defined in the sharedStorageFiles set), extract the keys and the files’ names.</li>
  <li>Add a new method setSharedConfig that will use the methods that already exist in  heconflib.py:</li>
  <li>Verify the file is editable.</li>
  <li>Load the configuration archive, get the md5 checksum.</li>
  <li>Locate the needed file according to the files names dictionary:</li>
  <li>If type is provided, extract the file from the dictionary</li>
  <li>If type is not provided, go over the dictionaries and extract the file name,</li>
  <li>If there is a collision raise an exception</li>
  <li>Extract the needed file and update as needed.</li>
  <li>Create a temporary configuration archive.</li>
  <li>Load the configuration archive again, verify  the md5 checksum hasn’t changed. If it was changed raise an error to the user. If not rename the temp archive to the real name.</li>
  <li>Add a new method getConfig that will use the methods that already exist in  heconflib.py, and will return the current shared configuration.</li>
</ol>

<h3 id="ovirt-hosted-engine-setup">ovirt-hosted-engine-setup</h3>

<h4 id="hosted-enginein">Hosted-engine.in</h4>
<p>Add a new command set-config
Add a new command get-config
Add a new command download-archive
Add a new command upload-archive</p>

<h4 id="set-configpy">Set-config.py</h4>
<p>A new file with a new class that will use the he client code to set the configuration.</p>

<h4 id="get-configpy">Get-config.py</h4>
<p>A new file with a new class that will use the he client code to get the shared configuration</p>

<h4 id="download-archivepy">Download-archive.py</h4>
<p>A new file with a new class that will use the he client code to download the shared configuration</p>

<h4 id="upload-archivepy">Upload-archive.py</h4>
<p>A new file with a new class that will use the he client code to upload the shared configuration</p>

<h2 id="second-stage-add-support-for-editing-vm-ovf">Second stage: Add support for editing vm ovf</h2>
<p>Editing the ovf can be dangerous, so extra care is needed for this feature.</p>

<p>To support editing the vm we will have to add an interactive warning to the user as part of the setting of the configuration, as well as a force option for automatic tools that want to run it.
Also, since the ovf is in a different format than the broker we will need to add a different handling for the setting and getting of the configuration.</p>

<h3 id="editable-keys">Editable keys:</h3>
<p>Vm ovf:</p>

<ol>
  <li>Num of sockets</li>
  <li>Cpu per socket</li>
  <li>Threads per cpu</li>
  <li>Min allocated memory</li>
  <li>Memory size</li>
  <li>Nic parameters</li>
</ol>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2965/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2965/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2965/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2965/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/hosted-engine-edit-configuration-on-shared-storage.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/hosted-engine-edit-configuration-on-shared-storage.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
