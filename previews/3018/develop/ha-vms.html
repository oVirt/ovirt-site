<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Highly Available VMs | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Highly Available VMs" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3018/develop/ha-vms.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3018/develop/ha-vms.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Highly Available VMs" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Highly Available VMs","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3018/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3018/develop/ha-vms.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3018/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3018/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3018/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3018/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3018/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3018/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3018/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3018/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3018/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3018/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3018/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3018/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3018/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3018/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3018/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3018/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3018/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3018/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3018/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3018/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3018/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3018/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3018//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3018//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3018/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3018/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Milan Zamazal">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Milan Zamazal</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="highly-available-vms">Highly Available VMs</h1>

<ol id="markdown-toc">
  <li><a href="#highly-available-vms" id="markdown-toc-highly-available-vms">Highly Available VMs</a>    <ol>
      <li><a href="#what-is-a-highly-available-vm" id="markdown-toc-what-is-a-highly-available-vm">What is a highly available VM?</a></li>
      <li><a href="#how-to-make-a-vm-highly-available" id="markdown-toc-how-to-make-a-vm-highly-available">How to make a VM highly available</a></li>
      <li><a href="#are-highly-available-vms-always-restarted-automatically" id="markdown-toc-are-highly-available-vms-always-restarted-automatically">Are highly available VMs always restarted automatically?</a></li>
      <li><a href="#paused-vms" id="markdown-toc-paused-vms">Paused VMs</a></li>
      <li><a href="#highly-available-vms-and-io-errors" id="markdown-toc-highly-available-vms-and-io-errors">Highly available VMs and I/O errors</a></li>
      <li><a href="#resume-behaviors" id="markdown-toc-resume-behaviors">Resume behaviors</a></li>
      <li><a href="#vm-leases" id="markdown-toc-vm-leases">VM leases</a></li>
      <li><a href="#additional-notes" id="markdown-toc-additional-notes">Additional notes</a></li>
    </ol>
  </li>
</ol>

<h2 id="what-is-a-highly-available-vm">What is a highly available VM?</h2>

<p>Highly available VMs (<em>HA</em> VMs) are VMs restarted by oVirt automatically whenever they disappear accidentally, such as due to failure of the host running the VM, storage problems or QEMU crash.</p>

<h2 id="how-to-make-a-vm-highly-available">How to make a VM highly available</h2>

<p>High availability settings are present in the VM editing dialog.  Make sure to show Advanced Options there and select <em>High Availability</em>.</p>

<p><img src="/ovirt-site/previews/3018/images/wiki/ha-vm-edit.png" alt="" /></p>

<p>You can see there are several settings there.  The primary one is <em>Highly Available</em> check box that must be checked.  Some of the additional settings are discussed later in this document.</p>

<h2 id="are-highly-available-vms-always-restarted-automatically">Are highly available VMs always restarted automatically?</h2>

<p>Starting a VM automatically is a bit more complicated than one might initially think.  Several conditions must be satisfied in order to start such a VM safely and consistently with user actions.</p>

<p>The very first condition is that oVirt Engine must be fully certain that the VM is not running anywhere at the moment.  Failing to satisfy this condition could lead to multiple instances of the VM running concurrently on different hosts, so called <em>split brain</em> situation.  oVirt uses safety mechanisms such as sanlock data, VM leases and resume behaviors to prevent split brain.  But it’s still important to be aware that if oVirt Engine doesn’t know (under certain setups) for sure that a VM is not already running, it can’t start it automatically elsewhere.  For instance, if a host running a VM is unreachable it doesn’t mean that the VM is not happily running there.  If corresponding protection mechanisms are not enabled then oVirt Engine may not be able to start the VM elsewhere, despite it is highly available.</p>

<p>VMs manually shut down or powered off from oVirt, from the guest operating system, or by admin-issued host shutdown (which counts as user initiated shutdown) are not restarted automatically.  Switching VMs off manually is a user action and oVirt honors it.  The user is responsible for starting such a VM again manually.</p>

<p>There may be other reasons preventing start of a highly available VM, such as impossibility to run the VM due to resource constraints at a given moment.</p>

<p>You can watch <a href="https://www.youtube.com/watch?v=Gh2eB06IE2A">DevConf.cz talk</a> about highly available VMs and their restarts.</p>

<h2 id="paused-vms">Paused VMs</h2>

<p>Besides being running, stopped or unreachable, highly available VMs (as well as other VMs) may also be paused. VMs can be paused for different reasons, for instance:</p>

<ul>
  <li>A user asks the VM to start paused.</li>
  <li>A VM can be paused for a short while in the final stages of migrations or when making a snapshot with memory.  This typically doesn’t harm VM availability.</li>
  <li>When a thin provisioned disk image is getting full and must be enlarged.  This is again only temporary situation.</li>
  <li>An I/O error due to inaccessible or broken storage occurs.  This is a real problem.</li>
</ul>

<p>A paused VM can be later switched to another state (typically Running or Down) either automatically (e.g. on migrations) or manually by the user.</p>

<h2 id="highly-available-vms-and-io-errors">Highly available VMs and I/O errors</h2>

<p>When a VM attempts to access an unreachable or otherwise broken storage and I/O error occurs, the VM may get paused (unless QEMU hangs in host I/O access or another irregular conditions occur).  Then it can’t get running again until the storage problem disappears.  The paused VMs can then be handled in different ways by oVirt.  Once storage domain is working again, Vdsm goes over all the VMs, highly available or not, on the given host that have been paused due to storage errors (it doesn’t try to resume any other paused VMs).  What happens with each of the paused VMs depends on VM <em>resume behavior</em>.</p>

<h2 id="resume-behaviors">Resume behaviors</h2>

<p>VM resume behavior defines how a VM previously paused due to an I/O error is handled once the previously broken storage starts working again.  Resume behavior can be selected in High Availability section of VM editing dialog, together with other VM high availability settings.</p>

<p>The following resume behaviors are defined:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AUTO_RESUME</code>: The VM is resumed automatically, as soon as the storage gets working again.  This is the simplest scenario – the VM simply pauses for the time of storage problems and then continues running again, without user intervention.  It is supposed to be used for non-highly available VMs without special requirements and for highly available VMs when using <code class="language-plaintext highlighter-rouge">KILL</code> behavior is not desirable for some reason.</li>
  <li><code class="language-plaintext highlighter-rouge">LEAVE_PAUSED</code>: The VM is never resumed automatically.  A user must handle the VM (run it or power it off) manually.  This behavior is suitable for VMs that require additional manual interventions after being paused, e.g. some remedy in their guest OS or software running there.</li>
  <li><code class="language-plaintext highlighter-rouge">KILL</code>: This is similar to <code class="language-plaintext highlighter-rouge">AUTO_RESUME</code> unless the VM is paused for too long.  If the storage problem is remedied within a given time interval (80 seconds by default), the VM is automatically resumed.  But if the storage problem persists for longer time, the VM is going to be killed sooner or later.  This behavior is suitable for highly available VMs, in order to permit them to start on another host, which doesn’t suffer from the storage problem.</li>
</ul>

<p>Resume behavior can be selected on any VM, not just highly available VMs.  But there are special considerations regarding highly available VMs:</p>

<ul>
  <li>As long as a VM is paused, it may prevent Engine from starting it on another, working, host.</li>
  <li>Or a paused VM may be started on another host and later resumed on the original host, resulting in split brain (the VM runs in multiple instances at the same time).</li>
</ul>

<p>There is also a special consideration if you use application level high availability in a non-highly available VM.  It may be a bad idea to use <code class="language-plaintext highlighter-rouge">AUTO_RESUME</code> resume behavior in such a case: If the VM gets paused and the application level high availability handles the situation by running the application elsewhere, confusion may arise if the paused VM starts again.  It may be better to use <code class="language-plaintext highlighter-rouge">LEAVE_PAUSED</code> or <code class="language-plaintext highlighter-rouge">KILL</code> resume behaviors in such setups.</p>

<p>Another special consideration is if an application or other functionality in a highly available VM takes long time to start on boot.  Then it may be preferred to leave the VM paused and trying to recover it even if it takes some time rather than trying to restart the VM as soon as possible and then wait for long time before the services inside start working.  <code class="language-plaintext highlighter-rouge">AUTO_RESUME</code> resume behavior may be preferable to <code class="language-plaintext highlighter-rouge">KILL</code> in such a case.</p>

<h2 id="vm-leases">VM leases</h2>

<p>VM lease is a feature that guarantees a VM can’t be run in multiple instances at the same time.  That guarantee makes restarting highly available VMs safer and thus easier.  Split brain is not possible when a VM has been started with a lease and the lease is kept enabled for the VM.</p>

<p>VM leases can be enabled only for highly available VMs, in High Availability section of the VM editing dialog again.  Just select <em>Target Storage Domain for VM Lease</em> in the dialog.</p>

<p>Basically, a VM with a lease can start on a given host only after it acquires its lease there.  Once the VM stops, gets paused, is killed or its QEMU process crashes, it releases the lease, making it available for starting the VM on another host.  VM leases are thoroughly described in a separate <a href="/ovirt-site/previews/3018/develop/release-management/features/storage/vm-leases.html">document about leases</a>.</p>

<p>To prevent split brain it’s best to use VM leases on highly available VMs.  The same also helps restarting highly available VMs on other hosts in case of prolonged storage problems on some of the hosts.  Since paused VMs release their leases, the VMs become available for running on other hosts, but can cause trouble when attempting to resume them later on the original host.  For that reason <code class="language-plaintext highlighter-rouge">KILL</code> is the only possible resume behavior for VMs with leases, which helps destroy the paused VM instance when Engine moves the VM to Unknown status and attempts to start it elsewhere.  Of course, <code class="language-plaintext highlighter-rouge">KILL</code> behavior means killing the VM under the given conditions, so think about your setup before using it.</p>

<h2 id="additional-notes">Additional notes</h2>

<p>VM resume behaviors are available since oVirt 4.2.  Older oVirt releases applied <code class="language-plaintext highlighter-rouge">AUTO_RESUME</code> behavior on all VMs.</p>

<p>Before oVirt 4.2.2 VMs with <code class="language-plaintext highlighter-rouge">KILL</code> behavior used to be killed only once the storage became available, i.e. Vdsm tried to resume the paused VMs.  Starting from oVirt 4.2.2 VMs are killed shortly after the timeout expires even when the storage problem persists.</p>

<p>If a VM is attempted to resume while the storage problem persists, it’s going to be paused again sooner or later.  That can happen when a user attempts to resume the VM manually or when a Vdsm is tricked into thinking the storage domain status has been changed.  The killing timeout resets and starts counting again from the new pause action in such a case.</p>

<p>The killing timeout value can be adjusted in <code class="language-plaintext highlighter-rouge">/etc/vdsm/vdsm.conf</code> on the hosts using <code class="language-plaintext highlighter-rouge">vm_kill_paused_time</code> option.  But don’t do that unless you really know what you are doing!</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3018/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3018/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3018/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3018/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/ha-vms.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/ha-vms.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
