<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Multipath Alerts | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Multipath Alerts" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/multipath-events.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/multipath-events.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Multipath Alerts" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Multipath Alerts","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3192/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3192/develop/release-management/features/storage/multipath-events.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3192/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3192/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3192/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3192/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3192/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3192/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3192/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3192/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3192/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3192/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3192/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3192//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3192/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/6261848c1efa431a180b0da119660b8a?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/6261848c1efa431a180b0da119660b8a?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Fred Rolland">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Fred Rolland</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3192/documentation/'>Documentation is available here.</a></div>

<h1 id="multipath-alerts">Multipath Alerts</h1>

<h2 id="overview">Overview</h2>

<p>This feature adds the ability to display alerts to the user in
the engine UI when some multipath device have faulty paths, when
some multipath devices are non-operational because all paths became faulty,
and when all multipath devices on a host recover.</p>

<p>The purpose of this feature is to help users troubleshoot storage issues
before they become critical when a multipath device is lost, and to
make it easier to troubleshoot cases when some LUNs are not available
because all paths became faulty.</p>

<p>Currently, the user has no indication in oVirt of faulty paths.
As a result only when all paths are faulty and the access to the storage
domain is not working, the user will get an indication:</p>
<ul>
  <li>If the all the hosts in the Data Center are reporting a problem in the 
storage domain. the storage domain status that will become ‘Inactive’.</li>
  <li>If only one host reports a problem in the storage domain, the status
of the host will become ‘Non Operational’.</li>
</ul>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: <a href="https://github.com/rollandf">Fred Rolland</a></li>
  <li>Email: <a href="mailto:frolland@redhat.com">frolland@redhat.com</a></li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<h3 id="how-it-works">How it works</h3>

<p>Vdsm will register to udev multipath events during storage initialization.
Vdsm will also build a map of all the faulty paths. 
For each event, Vdsm will update the map, according to the event.
The details of the faulty paths will be part of the statistics provided by
‘Host.getStats’ verb.</p>

<p>Engine polls the hosts for the statistics every 15 seconds.
Engine creates an audit log event according to the information provided
in the statistics. Only if there are changes in the faulty paths report,
an event will be created.</p>

<h3 id="new-vdsm-api">New vdsm API</h3>

<p>Host.getStats will report now new ‘multipathHealth’ key. The contents is a map of multipath alerts.</p>

<h4 id="multipath-health-map">Multipath Health Map</h4>

<p>The key of the map is the device mapper GUID.
The value is a MultipathAlert that contains:</p>
<ul>
  <li>List of faulty paths.</li>
  <li>Number of valid paths</li>
</ul>

<p>Here is an example of the map structure:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"multipathHealth"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"36001405976dc283c6bf497b940e69eed"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"valid_paths"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"failed_paths"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"sdae"</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="vdsm-multipath-event-listener">Vdsm multipath event listener</h3>

<p>Introduce a new Vdsm internal service for listening to multipath events:</p>

<ul>
  <li>Code interested in receiving multipath events will subscribe a callback to receive the event</li>
  <li>When an event is received, all subscribers will receive the events (in another thread).</li>
  <li>If nobody is registered for events, the events are dropped</li>
  <li>The multipath event monitor will be started during storage initialization</li>
</ul>

<p>The service will be implemented using ‘pyudev’, listening to these events:</p>
<ul>
  <li>action=change,DM_ACTION=PATH_FAILED</li>
  <li>action=change,DM_ACTION=PATH_REINSTATED</li>
  <li>action=remove (for multipath devices)</li>
</ul>

<p>We don’t know yet how to detect multipath devices events efficiently for detecting removed devices.</p>

<ul>
  <li>The user can disable this feature in a specific host in Vdsm configuration file</li>
</ul>

<p>In the future, the monitor can be used for other code, for example maintaining LVM filter.</p>

<h3 id="vdsm-multipath-health-monitor">Vdsm multipath health monitor</h3>

<p>To report multipath health status to engine, we will add a multipath health monitor.</p>

<ul>
  <li>The monitor subscribes to multipath events during startup</li>
  <li>The monitor builds a map of all the faulty paths during startup.</li>
  <li>The monitor updates the data set of the faulty paths when its callback is called:
    <ul>
      <li>PATH_FAILED - Add the faulty path to the map according to the device GUID</li>
      <li>PATH_REINSTATED - Remove the faulty path to the map according to the device GUID</li>
      <li>Multipath device removed  - remove the device from the map</li>
    </ul>
  </li>
  <li>Multipath health status is provided to engine via ‘Host.getStats’ verb.</li>
</ul>

<h3 id="new-engine-api">New engine API</h3>

<p>New audit logs are added:</p>
<ul>
  <li>Faulty multipath paths on host “HOST_NAME” on devices: “GUID”, “GUID” …</li>
  <li>Devices without valid paths on host “HOST_NAME” : “GUID”, “GUID” …</li>
  <li>No faulty multipath paths on host “HOST_NAME”</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<ul>
  <li>The user will be able to detect storage issues faster.</li>
</ul>

<h2 id="user-experience">User Experience</h2>

<p>New audit logs are added with information on the device path status.
The logs are per host.
Since the length of the information available in the audit log is limited,
the full information of the failing paths will be available in the logs.
The events are not generated on “real-time”, but are based on polling of
the statistics. Only if a change in the data received is detected, a new
audit log will be created</p>

<p>If a single LUN goes down on all the hosts, the user will get an alarm
for each host in the DC.</p>

<p>If a single path goes down on one of the hosts, the user will get an alarm
only for this host.</p>

<h2 id="logs">Logs</h2>

<p>Vdsm logs the changes in the status of the paths.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO  (mpathlistener) [storage.mpathhealth] Path u'sdae' reinstated for multipath device u'36001405976dc283c6bf497b940e69eed', all paths are valid (mpathhealth:124)
WARN  (mpathlistener) [storage.mpathhealth] Path u'sdae' failed for multipath device u'36001405976dc283c6bf497b940e69eed', no valid paths left (mpathhealth:138)
</code></pre></div></div>

<h2 id="installationupgrade">Installation/Upgrade</h2>

<p>This feature does not affect engine or Vdsm installation or upgrades</p>

<h2 id="user-workflows">User workflows</h2>

<ul>
  <li>
    <p>Once a user connects to a new ISCSI server, no events will be created.</p>
  </li>
  <li>
    <p>If there is an issue with the storage server, and multipath reports
an issue with one or more device path, a “Faulty multipath paths on host” event will be created</p>
  </li>
  <li>
    <p>Once the issue is fixed, and all paths are up a “No faulty multipath paths on host “HOST_NAME”
event will be created</p>
  </li>
  <li>
    <p>If only part of the paths are fixed, a “Faulty multipath paths on host” event will be created with the details of the devices.</p>
  </li>
</ul>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>Additional package dependency in Vdsm:</p>
<ul>
  <li>pyudev</li>
</ul>

<p>No related features.</p>

<h3 id="entity-description">Entity Description</h3>

<p>NA</p>

<h2 id="crud">CRUD</h2>

<p>NA</p>

<h2 id="event-reporting">Event Reporting</h2>

<ul>
  <li>Faulty multipath paths on host “HOST_NAME” on devices: “GUID”, “GUID” …</li>
  <li>No faulty multipath paths on host “HOST_NAME”</li>
  <li>Devices without valid paths on host “HOST_NAME” : “GUID”, “GUID” …</li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<p>This feature is required for resolving
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=723931">Bug 723931</a></p>

<p>Pyudev - <a href="http://pyudev.readthedocs.io/en/latest/guide.html#monitoring-devices">pyudev documentation</a></p>

<p>Uevent <a href="https://www.kernel.org/doc/Documentation/device-mapper/dm-uevent.txt">device mapper events kernel documentation</a></p>

<h2 id="testing">Testing</h2>

<h3 id="negative-flows">Negative flows</h3>

<ul>
  <li>Block network to ISCSI storage server on a specific host
    <ul>
      <li>‘Faulty multipath paths on host “HOST_NAME” on devices: “GUID”, “GUID” …’ is triggered</li>
    </ul>
  </li>
  <li>Unblock access to ISCSI server on a specific host
    <ul>
      <li>Wait until all paths go up. a ‘No faulty multipath paths on host “HOST_NAME”’ is triggered</li>
    </ul>
  </li>
  <li>Stop Vdsm, block network to ISCSI storage server on a specific host and start Vdsm
    <ul>
      <li>‘Faulty multipath paths on host “HOST_NAME” on devices: “GUID”, “GUID” …’ is triggered</li>
    </ul>
  </li>
</ul>

<h2 id="release-notes">Release Notes</h2>

<p>TBD</p>

<h2 id="open-issues">Open Issues</h2>

<ul>
  <li>In a scale environment, issue on the storage server or network can trigger
a lot of events. (Note that the events are generated per hosts and not per path).</li>
</ul>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3192/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3192/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3192/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3192/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/multipath-events.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/multipath-events.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
