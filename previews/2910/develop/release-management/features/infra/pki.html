<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>PKI | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="PKI" />
<meta name="author" content="Alon Bar-Lev" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2910/develop/release-management/features/infra/pki.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2910/develop/release-management/features/infra/pki.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PKI" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Alon Bar-Lev" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Alon Bar-Lev"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"PKI","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2910/images/logo.svg"},"name":"Alon Bar-Lev"},"url":"https://ovirt.github.io/ovirt-site/previews/2910/develop/release-management/features/infra/pki.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2910/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2910/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2910/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2910/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2910/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2910/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2910/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2910/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2910/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2910/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2910/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/2910/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/2910/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/2910/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/2910/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/2910/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2910/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2910/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2910/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2910/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2910/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2910/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2910//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2910//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2910/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2910/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2910/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2910/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2910/develop/release-management/features/infra/">
              <span property="name">Infra</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/73dbd7b0a4e813ae529563511ec671b4?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/73dbd7b0a4e813ae529563511ec671b4?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Alon Bar-Lev</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Sven Kieske</span></p>
                      
                    </section>
                  </span>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2910/documentation/'>Documentation is available here.</a></div>

<h1 id="pki">PKI</h1>

<p>oVirt project uses PKI for various of tasks, this article outlines the PKI usage and is correct for versions 3.2, 3.3.</p>

<h2 id="channels">Channels</h2>

<h3 id="ovirt-enginesslvdsm">ovirt-engine–SSL–&gt;vdsm</h3>

<p>During the deployment of a host as hypervisor a certificate is enrolled using engine’s internal CA.</p>

<p>The communication between ovirt-engine and host is performed using mutually authenticated SSL session based on engine certificate and vdsm certificate.</p>

<p>Due to legacy issue, the protocol that is being used is SSLv3 and not TLS.</p>

<p>Caveats: vdsm does not perform revocation check, current setup does not support intermediate certificates.</p>

<h3 id="ovirt-enginesshhosts">ovirt-engine–SSH–&gt;hosts</h3>

<p>ovirt-engine is capable of authenticating using its certificate public key to hosts using SSH protocol. This feature is optional for generic hosts, and mandatory during deploy post registration and upgrade of ovirt-node distribution.</p>

<p>Caveats: ovirt-engine does not perform revocation check, current setup does not support intermediate certificates.</p>

<h3 id="ovirt-enginessldatabase">ovirt-engine–SSL–&gt;database</h3>

<p>Based on connection setting, the database connection can use SSL, the trusted certificate authority are the jre trusted certificate authorities at $JAVA_HOME/lib/security/cacerts.</p>

<h3 id="ovirt-engine-database-fields">ovirt-engine database fields</h3>

<p>Sensitive database fields are encrypted using engine certificate, it should have used own certificate but due to legacy reasons it remained the same.</p>

<h3 id="usersslapacheajpovirt-engine">User–SSL–&gt;apache–AJP–&gt;ovirt-engine</h3>

<p>User access ovirt-engine via web browser using TLS/SSL via apache web server. By default the certificate enrolled is issued by the internal engine CA, but this certificate can be replaced by any 3rd party certificate without limiting the functionality.</p>

<p>Replacing certificate can be done using manually configuration of the mod_ssl, or by replacing the following files within /etc/pki/ovirt-engine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  apache-ca.pem
  keys/apache.p12
  keys/apache.key.nopass
  certs/apache.cer
</code></pre></div></div>

<h3 id="usersslspiceqemu">User–SSL–&gt;spice(qemu)</h3>

<p>qemu is configured to use the same certificate as vdsm, which is due to legacy design and is somewhat incorrect as unlike vdsm this certificate is exposed to end users.</p>

<p>During session initiation the internal engine certificate authority is sent to the spice client as trusted root so session can be established.</p>

<p>Caveats: current setup does not support intermediate certificates.</p>

<h3 id="libvirtssllibvirt-or-qemusslqemu">libvirt–SSL–&gt;libvirt or qemu–SSL–&gt;qemu</h3>

<p>Used for migration, mutual authentication using vdsm certificate.</p>

<p>Caveats: current setup does not support intermediate certificates.</p>

<h3 id="ovirt-nodesslovirt-engine">ovirt-node–SSL–&gt;ovirt-engine</h3>

<p>Used for registration protocol, the web certificate is pulled out of the SSL handshake and trusted based on fingerprint. Then SSH public key (engine certificate public key) is retrieved and installed for root user.</p>

<p>Caveats:ovirt-node does not perform revocation check.</p>

<h3 id="log-collectorsshhosts">log-collector–SSH–&gt;hosts</h3>

<p>Uses the same method and keys of ovirt-engine to access hosts.</p>

<h2 id="expiration">Expiration</h2>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>Default</th>
      <th>Configuration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Engine internal CA</td>
      <td>15 years</td>
      <td> </td>
    </tr>
    <tr>
      <td>Engine Certificates</td>
      <td>15 years</td>
      <td> </td>
    </tr>
    <tr>
      <td>VDSM Certificates</td>
      <td>5 years</td>
      <td>VdsCertificateValidityInYears at engine config</td>
    </tr>
  </tbody>
</table>

<h2 id="file-locations">File locations</h2>

<h3 id="ovirt-engine">ovirt-engine</h3>

<p>All files are relative to /etc/pki/ovirt-engine.</p>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>File</th>
      <th>Description</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Engine internal CA</td>
      <td>ca.pem</td>
      <td>Certificate pem encoded.</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>private/ca.pem</td>
      <td>Internal CA private key <strong>SENSITIVE!</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td>Apache artifacts</td>
      <td>apache-ca.pem</td>
      <td>Apache trusted CA, by default same as ca.pem</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>keys/apache.p12</td>
      <td>Key bundle</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>keys/apache.key.nopass</td>
      <td>Extracted from keys/apache.p12 used by mod_ssl</td>
      <td>Can be replaced by 3rd party certificate by apache configuration, do not override this file.</td>
    </tr>
    <tr>
      <td> </td>
      <td>certs/apache.cer</td>
      <td>Extracted from keys/apache.p12 used by mod_ssl</td>
      <td>Can be replaced by 3rd party certificate by apache configuration, do not override this file.</td>
    </tr>
    <tr>
      <td>Engine artifacts</td>
      <td>keys/engine.p12</td>
      <td>used by engine for ssh and ssl authentication against hosts and vdsm, also used to encrypt database fields.</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>keys/engine_id_rsa</td>
      <td>Extracted from keys/engine.p12 used by various components that should not access private key.</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>certs/engine.cer</td>
      <td>Extracted from keys/engine.p12 used by log-collector.</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>.truststore</td>
      <td>JKS containing trusted certificate authorities for engine.</td>
      <td> </td>
    </tr>
    <tr>
      <td>Jboss artifacts</td>
      <td>keys/jboss.p12</td>
      <td>Used for jboss ssl in ovirt-engine-3.2, for debug only at ovirt-engine-3.3</td>
      <td> </td>
    </tr>
    <tr>
      <td>websocket-proxy artifacts</td>
      <td>keys/websocket-proxy.p12</td>
      <td>Key bundle</td>
      <td> </td>
    </tr>
    <tr>
      <td>websocket-proxy artifacts</td>
      <td>keys/websocket-proxy.key.nopass</td>
      <td>Extracted from keys/websocket-proxy.p12 as python does not know how to work with PKCS#12.</td>
      <td>Can be overridden by 3rd party certificate key by /etc/ovirt-engine/ovirt-websocket-proxy.conf.d/20-pki.conf::SSL_KEY.</td>
    </tr>
    <tr>
      <td>websocket-proxy artifacts</td>
      <td>certs/websocket-proxy.cer</td>
      <td>Extracted from keys/websocket-proxy.p12 as python does not know how to work with PKCS#12.</td>
      <td>Can be overridden by 3rd party certificate chain (end certificate first) by /etc/ovirt-engine/ovirt-websocket-proxy.conf.d/20-pki.conf::SSL_CERTIFICATE.</td>
    </tr>
  </tbody>
</table>

<h3 id="vdsm">vdsm</h3>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>File</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>vdsm</td>
      <td>/etc/pki/vdsm/certs/cacert.pem</td>
      <td>trusted engine certificate, engine internal CA</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/vdsm/certs/vdsmcert.pem</td>
      <td>vdsm certificate</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/vdsm/keys/vdsmkey.pem</td>
      <td>vdsm key.</td>
    </tr>
    <tr>
      <td>qemu/libvirt</td>
      <td>/etc/pki/vdsm/libvirt-spice/ca-cert.pem</td>
      <td>qemu spice pki store, same as vdsm ca.</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/vdsm/libvirt-spice/server-key.pem</td>
      <td>qemu spice pki store, same as vdsm key.</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/vdsm/libvirt-spice/server-cert.pem</td>
      <td>qemu spice pki store, same as vdsm certificate.</td>
    </tr>
    <tr>
      <td>libvirt</td>
      <td>/etc/pki/libvirt/clientcert.pem</td>
      <td>libvirt certificate, same as vdsm certificate.</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/libvirt/private/clientkey.pem</td>
      <td>libvirt key, same as vdsm key.</td>
    </tr>
    <tr>
      <td> </td>
      <td>/etc/pki/CA/cacert.pem</td>
      <td>libvirt trust store.</td>
    </tr>
  </tbody>
</table>

<h2 id="services">Services</h2>

<h3 id="ovirt-engine-1">ovirt-engine</h3>

<p>Servlet:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /ovirt-engine/services/pki-resource?resource=RESOURCE&amp;format=FORMAT
</code></pre></div></div>

<h4 id="resource">RESOURCE</h4>

<ul>
  <li>ca-certificate</li>
  <li>engine-certificate</li>
</ul>

<h4 id="format">FORMAT</h4>

<ul>
  <li>X509-PEM</li>
  <li>X509-PEM-CA</li>
  <li>OPENSSH-PUBKEY</li>
</ul>

<h2 id="caveats">Caveats</h2>

<ul>
  <li>Internal engine CA does not support revocation.</li>
  <li>Engine does not allow certificate management, for example revocation of hosts that are removed.</li>
  <li>Engine/vdsm do not support renewal protocol of certificates.</li>
  <li>vdsm does not support revocation protocol (crl, ocsp), engine (java) support is not enabled.</li>
  <li>Unsupported installation of internal CA on separate computer.</li>
  <li>No protocol for CA interaction to allow using different CA implementations.</li>
  <li>Certificate of database encryption should be separate certificate.</li>
  <li>Certificate of spice SSL should be separate certificate.</li>
  <li>Engine does not validate vdsm’s certificate’s name to match remote address.</li>
  <li>vdsm does not validate peer certificate name, nor revocation.</li>
  <li>vdsClient does not validate peer certificate name nor revocation.</li>
</ul>

<h2 id="see-also">See Also</h2>

<ul>
  <li><a href="/ovirt-site/previews/2910/develop/release-management/features/infra/pkireduce.html">Features/PKIReduce</a></li>
</ul>

<p>Author: –Alon Bar-Lev (Alonbl)  02:24, 1 July 2014 (GMT)</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2910/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2910/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2910/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2910/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/infra/pki.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/infra/pki.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
