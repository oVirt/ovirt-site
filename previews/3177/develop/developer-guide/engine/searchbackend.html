<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Searchbackend | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Searchbackend" />
<meta name="author" content="Laszlo Hornyak" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/engine/searchbackend.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/engine/searchbackend.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Searchbackend" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Laszlo Hornyak" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Laszlo Hornyak"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Searchbackend","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3177/images/logo.svg"},"name":"Laszlo Hornyak"},"url":"https://ovirt.github.io/ovirt-site/previews/3177/develop/developer-guide/engine/searchbackend.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3177/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3177/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3177/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3177/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3177/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3177/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3177/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3177/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3177/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3177/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3177/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3177//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/">
              <span property="name">Joining the developers community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/developer-guide/">
              <span property="name">Developer Guide</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3177/develop/developer-guide/engine/">
              <span property="name">Engine</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f9883612f789d69b89b9449fb740ca53?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f9883612f789d69b89b9449fb740ca53?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Laszlo Hornyak">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Laszlo Hornyak</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/492dd720f87a98ef3009a933127d3877?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/492dd720f87a98ef3009a933127d3877?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Yaniv Kaul">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Yaniv Kaul</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          
<h1 id="search-backend">Search backend</h1>

<p>Search backend is part of the ovirt engine backend, it translates search queries to SQL, runs them against the database and returns the result.</p>

<h2 id="query-syntax">Query syntax</h2>

<p>Some example query:</p>

<ul>
  <li>Events : event_host = dev-164</li>
  <li>Users : name = admin</li>
  <li>Vms : ip = 127.0.0.1</li>
</ul>

<h2 id="autocompleters">Autocompleters</h2>

<p>Autocompleters help the users to build a query, the logic is built into searchbackend. See org.ovirt.engine.core.searchbackend.IAutoCompleter interface and implementing classes.</p>

<h2 id="generated-sql">Generated SQL</h2>

<p>The generated SQL would need some optimization.</p>

<p>The problems in general:</p>

<ul>
  <li>The operator `=` is interpreted as like, which is fine with string results, but no good with identifiers</li>
  <li>
    <p>The search query is wrapped with an outer query and mapped with id, so the primary key will be scanned even if it is not used in the result and not filtered</p>

    <p>engine=# explain SELECT * FROM (SELECT * FROM audit_log WHERE ( audit_log_id IN (SELECT audit_log.audit_log_id FROM  audit_log   WHERE  audit_log.vds_id::varchar LIKE ‘78933a44-360c-11e1-8fec-2f707af25b44’ ))  ORDER BY audit_log_id DESC ) as T1 OFFSET (1 -1) LIMIT 100;
                                                        QUERY PLAN                                                      <br />
  ————————————————————————————————————————-
  Limit  (cost=<code class="language-plaintext highlighter-rouge">**</code>592.60..593.13<code class="language-plaintext highlighter-rouge">**</code> rows=42 width=3163)
    -&gt;  Sort  (cost=592.60..592.71 rows=42 width=826)
          Sort Key: public.audit_log.audit_log_id
          -&gt;  Nested Loop  (cost=335.25..591.47 rows=42 width=826)
                -&gt;  HashAggregate  (cost=335.25..335.67 rows=42 width=8)
                      -&gt;  Seq Scan on audit_log  (cost=0.00..335.14 rows=42 width=8)
                            Filter: (((vds_id)::character varying)::text ~~ ‘78933a44-360c-11e1-8fec-2f707af25b44’::text)
                -&gt;  Index Scan using pk_audit_log on audit_log  (cost=0.00..6.08 rows=1 width=826)
                      Index Cond: (public.audit_log.audit_log_id = public.audit_log.audit_log_id)</p>
  </li>
</ul>

<p>(9 rows)</p>

<p>The first problem is that LIKE can not use indices. In this query, we could just use =.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  engine=# EXPLAIN SELECT * FROM (SELECT * FROM audit_log WHERE ( audit_log_id IN (SELECT audit_log.audit_log_id  FROM  audit_log   WHERE  audit_log.vds_id = '78933a44-360c-11e1-8fec-2f707af25b44' ))  ORDER BY audit_log_id DESC ) as T1 OFFSET (1 -1) LIMIT 100;                                            QUERY  PLAN                                            
  --------------------------------------------------------------------------------------------------
  Limit  (cost=`**`499.25..499.64`**` rows=31 width=3163)
    -&gt;  Sort  (cost=499.25..499.33 rows=31 width=826)
          Sort Key: public.audit_log.audit_log_id
          -&gt;  Nested Loop  (cost=293.46..498.49 rows=31 width=826)
                -&gt;  HashAggregate  (cost=293.46..293.77 rows=31 width=8)
                      -&gt;  Seq Scan on audit_log  (cost=0.00..293.39 rows=31 width=8)
                            Filter: (vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'::uuid)
                -&gt;  Index Scan using pk_audit_log on audit_log  (cost=0.00..6.59 rows=1 width=826)
                      Index Cond: (public.audit_log.audit_log_id = public.audit_log.audit_log_id)
</code></pre></div></div>

<p>As a result of this simplification, the estimated query cost dropped from ~600 to ~500. Now let’s introduce an index to support the query</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  engine=# CREATE INDEX idx_audit_log_vds_id on audit_log(vds_id);CREATE INDEX
  engine=# EXPLAIN SELECT * FROM (SELECT * FROM audit_log WHERE (audit_log_id IN (SELECT audit_log.audit_log_id  FROM  audit_log   WHERE  audit_log.vds_id = '78933a44-360c-11e1-8fec-2f707af25b44' ))  ORDER BY audit_log_id DESC ) as T1 OFFSET (1 -1) LIMIT 100;
                                                  QUERY PLAN                                                 
  ------------------------------------------------------------------------------------------------------------
  Limit  (cost=`**`292.67..293.05`**` rows=31 width=3163)
    -&gt;  Sort  (cost=292.67..292.74 rows=31 width=826)
          Sort Key: public.audit_log.audit_log_id
          -&gt;  Nested Loop  (cost=86.88..291.90 rows=31 width=826)
                -&gt;  HashAggregate  (cost=86.88..87.19 rows=31 width=8)
                      -&gt;  Bitmap Heap Scan on audit_log  (cost=4.49..86.80 rows=31 width=8)
                            Recheck Cond: (vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'::uuid)
                            -&gt;  Bitmap Index Scan on idx_audit_log_vds_id  (cost=0.00..4.48 rows=31 width=0)
                                  Index Cond: (vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'::uuid)
                -&gt;  Index Scan using pk_audit_log on audit_log  (cost=0.00..6.59 rows=1 width=826)
                      Index Cond: (public.audit_log.audit_log_id = public.audit_log.audit_log_id)
</code></pre></div></div>

<p>(11 rows)</p>

<p>Note that the estimated cost dropped because it can check a relevant index. Now let’s simplify the SQL statement to avoid index-scanning pk_audit_log, by removing the redundant outer query.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  engine=# EXPLAIN SELECT * FROM audit_log   WHERE  audit_log.vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'  ORDER BY audit_log_id DESC OFFSET 0 LIMIT 100;
                                            QUERY PLAN                                           
  ------------------------------------------------------------------------------------------------
  Limit  (cost=`**`87.57..87.65`**` rows=31 width=826)
    -&gt;  Sort  (cost=87.57..87.65 rows=31 width=826)
          Sort Key: audit_log_id
          -&gt;  Bitmap Heap Scan on audit_log  (cost=4.49..86.80 rows=31 width=826)
                Recheck Cond: (vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'::uuid)
                -&gt;  Bitmap Index Scan on idx_audit_log_vds_id  (cost=0.00..4.48 rows=31 width=0)
                      Index Cond: (vds_id = '78933a44-360c-11e1-8fec-2f707af25b44'::uuid)
</code></pre></div></div>

<p>(7 rows)</p>

<p>This refactoring dropped query cost estimation from ~500 to less than 100, therefore this simplification in the searchbackend could give results faster and generate less load on the database server.</p>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3177/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3177/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3177/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3177/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2024 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/developer-guide/engine/searchbackend.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/developer-guide/engine/searchbackend.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
