<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Online Virtual Drive Resize | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Online Virtual Drive Resize" />
<meta name="author" content="Daniel Erez" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/storage/online-virtual-drive-resize.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/storage/online-virtual-drive-resize.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Online Virtual Drive Resize" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Daniel Erez" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Daniel Erez"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Online Virtual Drive Resize","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3084/images/logo.svg"},"name":"Daniel Erez"},"url":"https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/storage/online-virtual-drive-resize.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3084/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3084/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3084/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3084/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3084/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3084/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3084/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3084/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3084/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/93875e42e9b962947becb4e425504fab?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Daniel Erez">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Daniel Erez</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/2cd558daf047b198cf2152940ec6a812?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/2cd558daf047b198cf2152940ec6a812?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Federico Simoncelli">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Federico Simoncelli</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/e563929a31cef762537008247dce66fd?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/e563929a31cef762537008247dce66fd?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Sergey Gotliv">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Sergey Gotliv</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3084/documentation/'>Documentation is available here.</a></div>

<h1 id="enable-online-virtual-drive-resize">Enable Online Virtual Drive Resize</h1>

<h2 id="summary">Summary</h2>

<p>This feature allows oVirt users to resize virtual disks while they are in use by one or more virtual machines without the need of pausing, hibernating or rebooting the guests. The virtual disk is disk seen by the guest operating system and should not be confused with the hardware storage (storage domain) which already support online extension.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Feature owner: Sean Cohen <a href="mailto:scohen@redhat.com">scohen@redhat.com</a></li>
  <li>Engine Component owner: Sergey Gotliv</li>
  <li>VDSM Component owner: Federico Simoncelli <a href="mailto:fsimonce@redhat.com">fsimonce@redhat.com</a></li>
</ul>

<h2 id="current-status">Current Status</h2>

<ul>
  <li>QEMU
    <ul>
      <li>must support the online resizing of virtual disks: <strong>Done in 0.12.1.2-2.295</strong></li>
    </ul>
  </li>
  <li>Libvirt
    <ul>
      <li>libvirt needs to expose an API to use such capability: <strong>Done in 0.10.2-18 (EL) and 1.0.2-1 (Fedora)</strong></li>
    </ul>
  </li>
  <li>VDSM
    <ul>
      <li>changes to block devices (new SPM API call): <strong>Done in v4.12</strong></li>
      <li>additional API call to passthrough to libvirt: <strong>Done in v4.12</strong></li>
    </ul>
  </li>
  <li>oVirt Engine
    <ul>
      <li>need to create a new command to coordinate the entire flow (call to SPM and then call to VM): <strong>Done in oVirt Engine 3.3</strong></li>
    </ul>
  </li>
  <li>oVirt GUI
    <ul>
      <li>need to expose the new functionality: <strong>Done in oVirt Engine 3.3</strong></li>
    </ul>
  </li>
  <li>Rest API
    <ul>
      <li>need to expose the new functionality: <strong>Done oVirt Engine 3.3</strong></li>
    </ul>
  </li>
  <li>QEMU-GA
    <ul>
      <li>support for notifying the guest and updating the size of the visible disk: <strong>To be integrated</strong></li>
    </ul>
  </li>
</ul>

<h2 id="limitations">Limitations</h2>

<ul>
  <li>Shrinking of the virtual drive currently is not supported</li>
  <li>Floating disk, the disk which is not attached to any VM, is not supported</li>
</ul>

<h1 id="user-experience">User Experience</h1>

<p>User can extend virtual drive size using UI or REST API.</p>

<h4 id="ui">UI:</h4>

<ul>
  <li>Go to “Virtual Machines” tab and select virtual machine</li>
  <li>Go to “Disks” sub tab and select disk</li>
  <li>Click on “Edit”, pay attention that if disk is locked or VM has other status than “UP”, “PAUSED”, “DOWN” or “SUSPENDED”, editing is not allowed so “Edit” option is grayed out.</li>
  <li>Use “Extend Size By(GB)” field to insert the size in GB which should be added to the existing size</li>
</ul>

<p><img src="/ovirt-site/previews/3084/images/wiki/OnlineVirtualDiskResizeDiagram4.png" alt="" /></p>

<h4 id="rest-api">REST API:</h4>

<h4 id="standard-updating-of-virtual-machine-disk">Standard updating of virtual machine disk:</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /api/vms/{VM_ID}/disks/{DISK_ID} HTTP/1.1
Accept: application/xml
Content-type: application/xml
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;disk&gt;</span>
        <span class="nt">&lt;size&gt;</span>{NEW_SIZE_IN_BYTES}<span class="nt">&lt;/size&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
</code></pre></div></div>
<h1 id="detailed-description">Detailed Description</h1>

<ol>
  <li>A request from oVirt Engine is sent to the SPM to extend the image. The scope of this request is mainly to extend the Logical Volume where the image resides and to update the metadata. The extension relevant only when the image is RAW and resides on both a block device and file domain. QCOW images will be treated as a NO-OP at this phase. In the case of a RAW image on a file domain a “truncate” command will be issued on the image to add additional sparse space at the end but we expect the QEMU process to do this anyway as part of its implementation. A preallocated RAW file will be extended using a non-sparse dd command to add zeroes at the end of the image (this is for consistence even if preallocating data on NFS doesn’t guarantee that the space is actually reserved).</li>
  <li>The oVirt Engine polls the <code class="language-plaintext highlighter-rouge">extendVolumeSize</code> status. Generally this task is expected to complete quite quickly (NO-OP or lvm command to extend a volume). The only case which might take a long time to complete is preallocating the space on file domains.</li>
  <li>The <code class="language-plaintext highlighter-rouge">extendVolumeSize</code> task is completed with success.</li>
  <li>A <code class="language-plaintext highlighter-rouge">diskSizeExtend</code> is sent to the HSM where the virtual machine is running. This command is used to notify the request to extend the image seen by the virtual machine.</li>
  <li>The request of extending the virtual image is passed to libvirt as it’s the layered interface on top of the QEMU process (virtual machine)</li>
  <li>The request to extend the virtual image is passed by libvirt to QEMU. QEMU is in charge of truncating the file when relevant, changing the QCOW header of the image (if applicable) to reflect the new size and update all its internal structures (including the ones reporting the disk size to the guest).</li>
  <li>Once the extension is successfully updated on disk (QCOW) and in the internal representation of the QEMU process an optional (in terms of libvirt API) request to the guest agent is delivered to notify the change and to update the guest OS</li>
</ol>

<p><img src="/ovirt-site/previews/3084/images/wiki/OnlineVirtualDiskResizeDiagram3.png" alt="`OnlineVirtualDiskResizeDiagram3.png`" /></p>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li><a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainBlockResize">https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainBlockResize</a></li>
</ul>

<h2 id="future-work">Future Work</h2>

<ul>
  <li>Enable to extend size of the floating disks.</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3084/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3084/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3084/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3084/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/online-virtual-drive-resize.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/online-virtual-drive-resize.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
