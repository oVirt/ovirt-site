<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>VM-Affinity | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="VM-Affinity" />
<meta name="author" content="Andrew Dahms" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3067/develop/release-management/features/sla/vm-affinity.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3067/develop/release-management/features/sla/vm-affinity.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="VM-Affinity" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Andrew Dahms" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Andrew Dahms"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"VM-Affinity","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3067/images/logo.svg"},"name":"Andrew Dahms"},"url":"https://ovirt.github.io/ovirt-site/previews/3067/develop/release-management/features/sla/vm-affinity.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3067/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3067/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3067/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3067/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3067/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3067/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3067/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3067/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3067/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3067/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3067/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3067/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3067/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3067/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3067/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3067/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3067/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3067/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3067/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3067/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3067/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3067/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3067//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3067//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3067/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3067/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3067/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3067/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3067/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d17fe401696c1bc6269a18d0a9c3132c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Andrew Dahms">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Andrew Dahms</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d23ba59f40f03f1390a8bbe87e4a8060?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d23ba59f40f03f1390a8bbe87e4a8060?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Gilad Chaplik">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Gilad Chaplik</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3067/documentation/'>Documentation is available here.</a></div>

<h1 id="vm-affinity">VM Affinity</h1>

<h2 id="summary">Summary</h2>

<p>The oVirt scheduler capabilities introduced in version 3.3 have opened opportunities to enhance how virtual machine workloads are scheduled to run in a cluster. By using the filtering and weighing mechanisms introduced in the Scheduler, it is now possible to apply Affinity and Anti-Affinity rules to virtual machines to manually dictate scenarios in which virtual machines should run together on the same hypervisor host, or separately on different hypervisor hosts.</p>

<h3 id="owners">Owners</h3>

<ul>
  <li>Name: Scott Herold (sherold)</li>
  <li>Email: <a href="mailto:sherold@redhat.com">sherold@redhat.com</a></li>
  <li>Name: Yanir Quinn (yquinn)</li>
  <li>Email: <a href="mailto:yquinn@redhat.com">yquinn@redhat.com</a></li>
</ul>

<h3 id="current-status">Current status</h3>

<ul>
  <li>Status: merged, version: 3.4</li>
  <li>Last updated: ,</li>
</ul>

<h2 id="benefits-to-ovirt">Benefits to oVirt</h2>

<ul>
  <li>Leverages the oVirt Scheduler to manually assign virtual machine workload affinity policies</li>
  <li>Enables users to accommodate advanced workload scenarios
    <ul>
      <li>Strict licensing requirements</li>
      <li>High Availability Workload planning</li>
    </ul>
  </li>
</ul>

<h3 id="terminology">Terminology</h3>

<ul>
  <li>Affinity Group - A group of two or more virtual machine for which a set of identical conditions and parameters are applied.</li>
  <li>Affinity Policy - The combination of an Affinity Group, a Condition statement, and optional Parameters. For example, VM A, VM B, and VM C Must Run Together on Host 1.</li>
  <li>VM Affinity - Affinity that is applied at the virtual machine entity level regardless of its workload characteristics.</li>
  <li>Positive Affinity (Run Together) - An affinity policy can be set as a Run Together policy to dictate that the identified virtual machines are to be run on the same hypervisor host.</li>
  <li>Anti (Negative) Affinity (Run Independently) - An affinity policy can be set as Run Independently to dictate that the identified virtual machines are to be run on separate hypervisor hosts.</li>
  <li>Must Condition (enforce = hard) - This is a hard condition which indicates that two or more virtual machines are required to run either on the same hypervisor host or on independent hypervisor hosts, regardless of external circumstances.</li>
  <li>Should Condition (enforce = soft) - This is a soft condition which indicates that there is a preference that two or more virtual machines run either on the same hypervisor host or on independent hypervisor hosts, but is not a hard requirement.</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>A new entity has been defined in the system called Affinity Group. An Affinity Group will hold a set of virtual machines (could be other entities later on) and properties. Each virtual machine can be associated with multiple groups. The virtual machine will be scheduled according to the rules defined in the affinity groups (properties and members) to which that virtual machine belongs.</p>

<h3 id="engine">Engine</h3>

<h4 id="queries">Queries</h4>

<ul>
  <li>getAllAffinityGroupsByClusterId</li>
</ul>

<p>Populates Affinity Groups subtab in clusters main tab</p>

<ul>
  <li>getAffinityGroupsByVmId</li>
</ul>

<p>Populates Affinity Groups subtab in VMs main tab</p>

<h4 id="commands">Commands</h4>

<p>Adding CRUD actions for Affinity Groups, currently supported only in the admin portal (user portal support will be added later- if needed) MLA: adding new action group for manipulate Affinity Groups (including all CRUD commands), this action group will be added to ClusterAdmin Role and above.</p>

<p>New commands:</p>

<ul>
  <li>AddAffinityGroup</li>
</ul>

<p>Adds a Affinity Group to the engine.</p>

<ul>
  <li>RemoveAffinityGroup</li>
</ul>

<p>Removes a Affinity Group from the engine.</p>

<ul>
  <li>EditAffinityGroup</li>
</ul>

<p>Edits a Affinity Group, making it possible to add or remove virtual machines to or from an Affinity Group. Altered Commands:</p>

<ul>
  <li>ChangeVmCluster</li>
</ul>

<p>When a virtual machine is moved from one cluster to another, we need to remove its reference from all Affinity Groups (open question: should such actions fail if the virtual machine is associated with an Affinity Group?).</p>

<h3 id="data-base">Data Base</h3>

<p>Tables: affinity_groups: id, name, cluster_id (foreign key to vds_groups + delete cascade), affinity_group_type (positive/negative), enforcement (hard/soft).</p>

<p>affinity_group_members: affinity_group_id (foreign key to affinity_groups + delete cascade), member_id (foreign key to vm_static + delete cascade).</p>

<h3 id="ui">UI</h3>

<p><img src="/ovirt-site/previews/3067/images/wiki/Relation-cluster.png" alt="Relations sub tab under clusters" title="Relations sub tab under clusters" /></p>

<p>An overview of all Affinity Groups in the cluster.</p>

<p><img src="/ovirt-site/previews/3067/images/wiki/Relation-vm.png" alt="Relations sub tab under clusters" title="Relations sub tab under clusters" /></p>

<p>All Affinity Groups associated with a single virtual machine.</p>

<p><img src="/ovirt-site/previews/3067/images/wiki/Relation-dialog.png" alt="Add/Edit Relation Dialog" title="Add/Edit Relation Dialog" /></p>

<p>Dialog for adding or editing a single relation, specifying Name, polarity, enforcement mode, and members (virtual machines). The virtual machine drop-down menu should support typing (a suggestion combo box) for quick selection.</p>

<h3 id="scheduling">Scheduling</h3>

<p>Add affinity filter and weight module to oVirt’s scheduler, and add those to all cluster policies (inc. user defined).</p>

<h4 id="affinity-filter">Affinity Filter</h4>

<p>Filters out host according to affinity enforce mode (hard).</p>

<ul>
  <li>Fetches all (scheduled) VM <strong>hard</strong> Affinity Groups.</li>
  <li>Fetches all VMs who are members in the scheduled VM Affinity Groups.</li>
  <li>Removes all hosts that doesn’t meet the Affinity Group hard enforce:
    <ul>
      <li>for positive affinity, in case a VM of the group is running on a certain host, remove all other hosts.</li>
      <li>for negative affinity, for each running VM in the group, remove its host.</li>
    </ul>
  </li>
</ul>

<h4 id="affinity-weight-module">Affinity Weight Module</h4>

<ul>
  <li>Fetches all (schedule) VM <strong>soft</strong> Affinity Groups.</li>
  <li>Fetches all VMs who are members in the scheduled VM Affinity Groups.</li>
  <li>Score the hosts according to the soft enforcement Affinity Groups:
    <ul>
      <li>for positive affinity, in case a VM of the group is running on a certain host, give all other hosts a higher weight.</li>
      <li>for negative affinity, for each running VM in the group, give the VM’s host higher weight.</li>
    </ul>
  </li>
</ul>

<h3 id="rest-api">REST API</h3>

<p>A new type was added to the engine’s API model - <strong>AffinityRule</strong> . It has two attributes: one for virtual machines and another for hosts.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;vms_rule&gt;</span>
  <span class="nt">&lt;positive&gt;</span>true|false<span class="nt">&lt;/positive&gt;</span>
  <span class="nt">&lt;enforcing&gt;</span>true|false<span class="nt">&lt;/enforcing&gt;</span>
  <span class="nt">&lt;enabled&gt;</span>true|false<span class="nt">&lt;/enabled&gt;</span>
<span class="nt">&lt;/vms_rule&gt;</span>
<span class="nt">&lt;hosts_rule&gt;</span>
  <span class="nt">&lt;positive&gt;</span>true|false<span class="nt">&lt;/positive&gt;</span>
  <span class="nt">&lt;enforcing&gt;</span>true|false<span class="nt">&lt;/enforcing&gt;</span>
  <span class="nt">&lt;enabled&gt;</span>true|false<span class="nt">&lt;/enabled&gt;</span>
<span class="nt">&lt;/hosts_rule&gt;</span>
</code></pre></div></div>

<blockquote>
  <p><strong>NOTE</strong> : The existing positive and enforcing attributes (for vms) will be preserved, and marked as deprecated.
   They will have the same meaning that they had before.</p>
</blockquote>

<p>Here are more examples:</p>

<p>GET /api/clusters/00000002-0002-0002-0002-000000000222/affinitygroups</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;affinity_groups&gt;</span>
  <span class="nt">&lt;affinity_group</span> <span class="na">href=</span><span class="s">"/ovirt-engine/api/clusters/00000002-0002-0002-0002-000000000222/affinitygroups/31ef70c1-e636-45a6-9492-aa4fad753e6f"</span> <span class="na">id=</span><span class="s">"31ef70c1-e636-45a6-9492-aa4fad753e6f"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;name&gt;</span>Test_aff_group<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/ovirt-engine/api/clusters/00000002-0002-0002-0002-000000000222/affinitygroups/31ef70c1-e636-45a6-9492-aa4fad753e6f/vms"</span> <span class="na">rel=</span><span class="s">"vms"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;cluster</span> <span class="na">href=</span><span class="s">"/ovirt-engine/api/clusters/00000002-0002-0002-0002-000000000222"</span> <span class="na">id=</span><span class="s">"00000002-0002-0002-0002-000000000222"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;positive&gt;</span>true<span class="nt">&lt;/positive&gt;</span>
    <span class="nt">&lt;enforcing&gt;</span>true<span class="nt">&lt;/enforcing&gt;</span>
    <span class="nt">&lt;vms_rule&gt;</span>
      <span class="nt">&lt;positive&gt;</span>true<span class="nt">&lt;/positive&gt;</span>
      <span class="nt">&lt;enforcing&gt;</span>true<span class="nt">&lt;/enforcing&gt;</span>
      <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
    <span class="nt">&lt;/vms_rule&gt;</span>
  <span class="nt">&lt;/affinity_group&gt;</span>
<span class="nt">&lt;/affinity_groups&gt;</span>
</code></pre></div></div>

<p>GET /api/clusters/00000002-0002-0002-0002-000000000222/affinitygroups/31ef70c1-e636-45a6-9492-aa4fad753e6f/vms</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;vms&gt;</span>
  <span class="nt">&lt;vm</span> <span class="na">href=</span><span class="s">"/ovirt-engine/api/vms/d4532fce-787b-4e45-ab35-018a1df55e35"</span> <span class="na">id=</span><span class="s">"d4532fce-787b-4e45-ab35-018a1df55e35"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/vms&gt;</span>
</code></pre></div></div>

<p>POST /api/clusters/00000002-0002-0002-0002-00000000017a/affinitygroups</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;affinity_group&gt;</span>
    <span class="nt">&lt;name&gt;</span>Affinity_Group_A<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;vms&gt;</span>
        <span class="nt">&lt;vm</span> <span class="na">id=</span><span class="s">"adf661d2-747e-4e74-a6bc-25fa2a457c5e"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;vm</span> <span class="na">id=</span><span class="s">"1b0a1ceb-525c-4a12-afee-907c99fac106"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/vms&gt;</span>
    <span class="nt">&lt;positive&gt;</span>true<span class="nt">&lt;/positive&gt;</span>
    <span class="nt">&lt;enforcing&gt;</span>true<span class="nt">&lt;/enforcing&gt;</span>
    <span class="nt">&lt;vms_rule&gt;</span>
        <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
        <span class="nt">&lt;enforcing&gt;</span>true<span class="nt">&lt;/enforcing&gt;</span>
        <span class="nt">&lt;positive&gt;</span>true<span class="nt">&lt;/positive&gt;</span>
    <span class="nt">&lt;/vms_rule&gt;</span>
    <span class="nt">&lt;cluster</span> <span class="na">id=</span><span class="s">"00000002-0002-0002-0002-00000000017a"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/affinity_group&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">PUT /api/clusters/00000002-0002-0002-0002-00000000017a/affinitygroups/e7237677-ff5c-47a4-877c-194d525d5f92</code></p>

<p><code class="language-plaintext highlighter-rouge">DELETE /api/clusters/00000002-0002-0002-0002-00000000017a/affinitygroups/e7237677-ff5c-47a4-877c-194d525d5f92</code></p>

<p><a href="/ovirt-site/previews/3067/develop/release-management/features/sla/affinity-rules-enforcement-manager.html">Affinity Rules Enforcement Manager</a>
<a href="/ovirt-site/previews/3067/develop/release-management/features/sla/soft-host-to-vm-affinity-support.html">VM to host Affinity</a></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3067/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3067/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3067/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3067/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/vm-affinity.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/vm-affinity.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
