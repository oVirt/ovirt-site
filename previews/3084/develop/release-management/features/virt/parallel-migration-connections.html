<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Parallel migration connections | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Parallel migration connections" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/virt/parallel-migration-connections.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/virt/parallel-migration-connections.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Parallel migration connections" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Parallel migration connections","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3084/images/logo.svg"}},"url":"https://ovirt.github.io/ovirt-site/previews/3084/develop/release-management/features/virt/parallel-migration-connections.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3084/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3084/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3084/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3084/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3084/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3084/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3084/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3084/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3084/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3084/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3084/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3084//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3084/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/f4f3e4820685eab0c3b448e59d3f2703?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Milan Zamazal">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Milan Zamazal</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3084/documentation/'>Documentation is available here.</a></div>

<h1 id="parallel-migration-connections">Parallel migration connections</h1>

<h2 id="summary">Summary</h2>

<p>This feature adds support for multiple connections in migrations.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Milan Zamazal</li>
  <li>Email: mzamazal@redhat.com</li>
</ul>

<h2 id="description">Description</h2>

<p>libvirt and QEMU allow using multiple parallel connections for a single migration (QEMU calls this feature <em>multifd</em>).  With just a single migration connection and sufficient network bandwidth, the single migration thread can become a bottleneck due to a limited single-CPU capacity.  By using multiple connections fed with multiple threads run by multiple CPUs, a full network capacity can be utilized.  For instance, 8-16 connections can saturate 100 Gbps network bandwidth.</p>

<p>Additionally, multifd implementation of data transfer is simpler and more efficient than the traditional migration mechanism and can be faster even with lower network bandwidths.  This concerns only the way memory data is transferred, the other migration concepts such as counting iterations or setting the maximum downtime are unaffected.</p>

<p>Parallel migration connections can be enabled by passing <code class="language-plaintext highlighter-rouge">VIR_MIGRATE_PARALLEL</code> flag to <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainMigrateToURI3">virDomainMigrateToURI3</a> call.  The number of connections to use is specified using  <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#VIR_MIGRATE_PARAM_PARALLEL_CONNECTIONS">VIR_MIGRATE_PARAM_PARALLEL_CONNECTIONS</a> migration parameter.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Nothing special, just up-to-date libvirt and QEMU.</p>

<h2 id="limitations">Limitations</h2>

<p>Current implementation of parallel migration connections in QEMU has some restrictions:</p>

<ul>
  <li>
    <p>It doesn’t support switching to post-copy.</p>
  </li>
  <li>
    <p>RDMA doesn’t work.  This is not a limitation for oVirt, because RDMA is not supported in oVirt.</p>
  </li>
  <li>
    <p>XBZRLE compression is not supported.  However this kind of compression is generally not recommended to use in migrations because it adds little benefit and a significant overhead.  gzip/zstd is supported instead and migrations should actually benefit from it (but libvirt apparently doesn’t currently provide means to select this compression kind).</p>
  </li>
  <li>
    <p>Due to their better implementation, parallel migration connections can be faster than the traditional migration implementation even when the network bandwidth can be saturated with a single connection.  However, when single connection is specified, the parallel migration connection implementation uses a different code path, which may not be sufficiently robust, and it’s recommended to always use at least two connections.  In the worst case, one of the threads will be idle while causing only a little overhead.</p>
  </li>
  <li>
    <p>Parallel migration connections haven’t been tested extensively with connections faster than 100 Gbps.  Due to current multifd implementation, there is an increasing overhead when using many connections and it’s not clear whether using more than 16 parallel connections adds a real benefit.</p>
  </li>
  <li>
    <p>It still applies that large guests with terrabytes of RAM are difficult to migrate successfully.</p>
  </li>
  <li>
    <p>Since it’s easier to saturate network bandwidth with multiple connections, it’s advisable to not migrate multiple VMs from a single host at the same time.</p>
  </li>
  <li>
    <p>VM CPU pinning may restrict the number of CPUs available to the QEMU process and thus impose a limit on the meaningful number of parallel connections.</p>
  </li>
  <li>
    <p>It’s difficult to guess the right number of parallel connections to use.  A rule of thumb is to use one connection per 10 Gbps of available network bandwidth.  If the number of connections is a bit high, some threads may remain idle while the related overhead should be negligible.</p>
  </li>
  <li>
    <p>There is very little documentation about parallel migration connections and the information above was obtained directly from platform developers.</p>
  </li>
</ul>

<h2 id="user-experience">User experience</h2>

<p>A new migration option to enable parallel migration connections is introduced in cluster and VM edit dialogs.  The cluster option specifies what to use in the given cluster.  VMs can override the cluster value individually.  The new option offers the following choices:</p>

<ul>
  <li>
    <p><strong>Disabled</strong> (the default in clusters): Parallel migration connections are not used.</p>
  </li>
  <li>
    <p><strong>Auto</strong>: Use or do not use parallel migration connections and set their number automatically based on the available resources (network bandwidth and CPU power).</p>
  </li>
  <li>
    <p><strong>Parallel</strong>: Always use parallel migration connections (for the supposed benefit of a more efficient implementation over non-parallel implementation) and set their number automatically based on the available resources (network bandwidth and CPU power).</p>
  </li>
  <li>
    <p><strong>Custom</strong>: Use parallel migration connections and use the number of connections specified by the user.  The minimum number of connections is 2.  There is no upper limit but it is recommended not to use more than 16 and the actual number of connections used for a particular migration is restricted to the number of threads on the source and destination hosts (whichever is lower).</p>
  </li>
  <li>
    <p><strong>Cluster value</strong> (only in the VM edit dialog; it’s the default there): Use parallel connections as specified in the VM’s cluster settings.</p>
  </li>
</ul>

<p>We use <strong>Disabled</strong> as the cluster default because it’s a newly introduced feature in oVirt and there is not enough experience with it.  We may consider changing it to <strong>Auto</strong> or <strong>Parallel</strong> in next releases, especially if QEMU decides using parallel migration connections by default; this would be limited to a future cluster level.</p>

<p>If <strong>Parallel</strong> is selected then the number of parallel connections is set to the lower number of the currently available migration network bandwidth divided by 10 Gbps and the number of VM vCPUs, but no less than 2 and no more than a configurable upper limit, which will be 16 by default.  <strong>Auto</strong> is the same except that parallel connection are not used if the computed number of connections is less than 2.</p>

<p>Since parallel migration connections cannot be currently used with post-copy in QEMU, <strong>Parallel</strong> and <strong>Custom</strong> cannot be set if post-copy migration policy is set, or vice versa post-copy migration policy cannot be set if <strong>Parallel</strong> or <strong>Custom</strong> migration options are set (this must be checked for all the VMs in the cluster on cluster migration policy changes).</p>

<p>If parallel migration connections are enabled, the following adjustments are made when a migration is initiated:</p>

<ul>
  <li>
    <p>Compression is disabled regardless of the selected migration policy.  (Current libvirt apparently doesn’t support using gzip/zstd compression, which could be helpful and it might be a good idea to always enable it.)</p>
  </li>
  <li>
    <p>The maximum number of outgoing migrations is set to 1 regardless of the selected migration policy.  This may not be optimal if there is a non-parallel migration running that cannot saturate the available bandwidth but even in such a case it’s generally simpler and safer not to start competing for the bandwidth.</p>
  </li>
  <li>
    <p>If <strong>Auto</strong> is set and post-copy migration policy is selected, parallel migration connections are disabled.</p>
  </li>
</ul>

<h2 id="testing">Testing</h2>

<p>It should be tested that migrations with parallel connection work as described above.  It requires at least about 40 Gbps network bandwidth.  The selected migration parameters can be checked in Vdsm logs.  Network bandwidth utilized by the migration should be measured to check that the data is indeed flowing in the specified amounts approximately, i.e. it works as expected on the side of Vdsm, libvirt, and QEMU.</p>

<h2 id="changes-to-engine-and-vdsm">Changes to Engine and Vdsm</h2>

<p><code class="language-plaintext highlighter-rouge">VM.migrate</code> Vdsm API call gets an additional parameter <code class="language-plaintext highlighter-rouge">parallel</code>.  If it is unset, parallel migration connections are not used.  Otherwise the specified number of connections, which must be at least 1 (Engine is going to be stricter and not to permit sending less than 2), is used.</p>

<p>Vdsm adds functionality for processing the parameter and passing the corresponding flag and parameter to the libvirt migration call.</p>

<p>Engine implements the functionality as described above, including corresponding modifications to the Web UI and REST API.</p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3084/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3084/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3084/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3084/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/parallel-migration-connections.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/virt/parallel-migration-connections.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
