<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>IPAM | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="IPAM" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2810/develop/internal/ipam.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2810/develop/internal/ipam.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="IPAM" />
<meta name="twitter:site" content="@ovirt" />
<script type="application/ld+json">
{"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"IPAM","url":"https://ovirt.github.io/ovirt-site/previews/2810/develop/internal/ipam.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2810/images/logo.svg"}},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2810/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2810/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2810/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2810/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2810/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2810/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2810/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2810/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2810/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2810/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2810/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2810/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2810/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2810/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2810/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2810/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2810/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2810/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2810/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2810/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2810/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2810/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2810/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2810/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2810/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2810/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2810/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2810/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2810/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2810/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2810/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2810/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2810/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2810/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2810/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2810//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2810//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2810/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2810/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2810/develop/internal/">
              <span property="name">Internal</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/03383bfa9bb468b9f0264d74539b19d0?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/03383bfa9bb468b9f0264d74539b19d0?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Michael Kolesnic</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>This developer documentation is <strong>outdated</strong>, but provides historical context.<br><br>It is <strong>not</strong> user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2810/documentation/'>Documentation is available here.</a></div>

<!-- TODO: Content review -->

<h1 id="ipam">IPAM</h1>

<h2 id="wip">WIP</h2>

<p>WIP,. do not take anything in this document as a declaration of intent, it is merely a textual representation of some design ideas..</p>

<h2 id="expectation">Expectation</h2>

<p>We expect to have a capability of IP Address Management (IPAM) in oVirt, meaning that:</p>

<ul>
  <li>VM networks can have IPAM enabled</li>
  <li>There can be one or more subnets in each network</li>
  <li>Each vNIC on an IPAM enabled network can reserve an IP on one of the subnets of that network</li>
  <li>The vNIC will receive the reserved IP through DHCP</li>
</ul>

<h2 id="enabling-ipam-in-ovirt">Enabling IPAM in oVirt</h2>

<h3 id="related-entities">Related entities</h3>

<h4 id="network">Network</h4>

<p>The IPAM capability will be available on a per-network basis - For each network you can choose to enable IPAM or not. The network entity will have these new fields:</p>

<ul>
  <li>IPAM enabled</li>
  <li>IPAM servers count (perhaps a general configuration value at first)</li>
</ul>

<h4 id="subnet">Subnet</h4>

<p>If IPAM is enabled for a network, one ore more subnets can be defined on it. A subnet has the following properties:</p>

<ul>
  <li>Subnet IP</li>
  <li>Netmask (must be valid)</li>
  <li>Gateway IP</li>
  <li>Optionally provide DNS, NTP properties</li>
</ul>

<h4 id="vms-vnic">VM’s vNIC</h4>

<p>A vNIC will have an option to belong to a certain subnet on the network.</p>

<ul>
  <li>If a vNIC doesn’t belong to any subnet, it will not receive IPAM service.</li>
  <li>If a vNIC belongs to a subnet:
    <ul>
      <li>It will get a dynamic IP from the subnet upon start of the vNIC (VM start. Plug, Re-link, etc).</li>
      <li>It will release it’s IP back to the subnet upon stop of the vNIC (VM stop, Unplug, Re-link, etc).</li>
    </ul>
  </li>
</ul>

<h3 id="general-behaviour">General behaviour</h3>

<p>IPAM capability can be split to two sections:</p>

<ul>
  <li>Managing IP assignments</li>
  <li>Delivering the IP assignments to the VM guest OS</li>
</ul>

<p>The focus initially will be on providing both:</p>

<ul>
  <li>IP assignment will be managed internally by oVirt.</li>
  <li>IP delivery to VM will be provided by DHCP (explanation later on).</li>
</ul>

<h4 id="management-module">Management Module</h4>

<p>There will be an IPAM management module which is responsible on managing the service in an engine-level.</p>

<ul>
  <li>Once a network with IPAM enabled has at least one subnet defined, the IPAM management module will pick it up and attempt to provision it by making sure there are IPAM servers running for the network.
    <ul>
      <li>The management module will seek out applicable hosts (they must have the network set-up already) and command them to serve IPAM capabilities for the network.</li>
    </ul>
  </li>
  <li>If a host that is serving as IPAM server goes down, the manager should attempt to stop it from serving as an IPAM server (best effort). and start another IPAM server on an applicable host.</li>
</ul>

<p>This leads to the following requirements:</p>

<ul>
  <li>We need a way to mark &amp; identify a host as an IPAM server.</li>
  <li>The IPAM data should be persistent to recover from crash of the engine.
    <ul>
      <li>i.e. it would be unhealthy to swap all IPAM servers upon service start, we need a way to keep track of them instead.</li>
    </ul>
  </li>
  <li>The DHCP servers should run in a “restricted” mode: They shouldn’t allocate IP to a lease request, unless it is known to the server.</li>
</ul>

<h4 id="dhcp-ipam-provider">DHCP IPAM Provider</h4>

<p>The DHCP IPAM providers have to support certain functionality:</p>

<ul>
  <li>Allow to start/stop a DHCP server for a number of networks on a given host.</li>
  <li>Allow to reserve/release IPs.</li>
</ul>

<p>The DHCP provider is responsible for the proliferation of reservations to the DHCP servers it is managing. When a new host is added, the reservations for the networks this host will provide IPAM for should be proliferated by the provider itself (i.e. there is no need to re-reserve the IP via an explicit call).</p>

<h3 id="pseudo-code">Pseudo Code</h3>

<h4 id="interface-of-a-ipam-dhcp-provider">Interface of a IPAM DHCP provider</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /**
   * An IPAM (IP Address Management) DHCP provider can provide IP allocations on a host for one or more networks. The IP
   * distribution is done via DHCP which is configured to provide only the allocations it knows about.
   */ **`interface` `IpamDhcpProvider` `{`**
      /**
       * Provide IPAM on the given host to the given networks.
        * If the networks list is empty then IPAM provisioning on will be turned off on this host.
       *
       * @param host
       *            The host to provide IPAM on.
       * @param networks
       *            The list of networks to provide IPAM for, on this host. Each network should contain the desired
       *            subnets for which the IPs will be provided.
       */ `    `**`void` `provide(Host` `host,` `List`&lt;Network&gt; `networks);`**
      /**
       * Stop providing IPAM on the given host. Same as calling {@link IpamDhcpProvider#provide(Host, List)} with an empty
       * networks list.
       *
       * @param host
       *            The host to stop providing IPAM for.
       */ `    `**`void` `dontProvide(Host` `host);`**
      /**
       * Add a reservation for the given MAC on the subnet. The provider will choose an available IP address.
       *
       * @param subnet
       *            The subnet to reserve on.
       * @param mac
       *            The MAC to reserve for.
       * @return The IP that was reserved.
       */ `    `**`IP` `addReservation(Subnet` `subnet,` `MAC` `mac);`**
      /**
       * Add a reservation of the given IP for the given MAC on the subnet.
       *
       * @param subnet
       *            The subnet to reserve on.
       * @param mac
       *            The MAC to reserve for.
       * @param ip
       *            The IP to reserve.
       */ `    `**`void` `addReservation(Subnet` `subnet,` `MAC` `mac,` `IP` `ip);`**
      /**
       * Remove the given IP reservation from the given subnet.
       *
       * @param subnet
       *            The subnet to remove from.
       * @param ip
       *            The IP reservation to remove.
       */ `    `**`void` `removeReservation(Subnet` `subnet,` `IP` `ip);`**
  }
</code></pre></div></div>

<h4 id="class-that-manages-the-ipam-per-network">Class that manages the IPAM per network</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  public class IpamManager {
      private IpamDhcpProvider provider;
      @OnTimer
      public void manage() {
          for (Network net : getAllNetworks()) {
              if (net.isIpamEnabled() &amp;&amp; !net.getSubnets().isEmpty()) {
                  /*
                   * Balance number of hosts running IPAM for the network:
                   *  * If a host that is tracked as running IPAM is not up, attempt to stop the IPAM on it.
                   *  * Make sure that the amount of hosts providing IPAM for the network is running.
                   */
              } else {
                  /* Stop IPAM for this network on all hosts that are running it (if there are any). */
              }
          }
      }
      /**
       * Stop managing IPAM on the given host.
       *
       * @param host
       *            The host to stop managing.
       */
      public void stopManaging(Host host) {
          /* ... */
      }
  }
</code></pre></div></div>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2810/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2810/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2810/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2810/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/internal/ipam.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/internal/ipam.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
