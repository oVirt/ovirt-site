---
title: Enhance import-export with OVA
category: feature
authors: arik
wiki_category: Feature
wiki_title: Features/Enhance import-export with OVA
wiki_revision_count: 20
wiki_last_updated: 2015-10-21
feature_name: Enhance import-export with OVA
feature_modules: engine, vdsm
feature_status: 
---

# Backgroud
Open Virtual Appliance (OVA) is a package that contains the different elements of a Virual Machine (VM). OVA is typically a tar archive file that includes the configuration of the VM in the form of Open Virtualization Format (OVF) file (XML file) as well as virtual disks and other VM-related data.  

OVA is a known format that is used by different organizations and virtualization platforms. Its specification can be found [here](http://www.dmtf.org/standards/ovf). The standard aims at being an ["open, secure, portable, efficient and extensible format for the packaging and distribution of software to be run in virtual machines"](https://en.wikipedia.org/wiki/Open_Virtualization_Format).  

Recently oVirt was enhanced with support for importing OVAs that were generated by VMware. In addition, oVirt makes an extensive use of the OVF standard to describe VM configuration of VM snapshots, exported VMs, etc. In other platforms OVAs are used to represent VM templates and as an intermediate representation during export of VMs to different management platforms.  

The ability to package all VM data, optionally compressed, in one file ease the process of migrating VMs to different platforms and hypervisors. Unfortunately, the portability is limited by compatibility issues. Different disks format, drivers, guest-agents, OVF structure hinder the ability to import any OVA to any platform. Therefore, different organizations develop different conversions tools, like Red Hat's virt-v2v for converting VMs to the KVM hypervisor.   

# Scope
This feature is about enhancing the import-export processes in oVirt by making a broader use of the OVA format.  

## Upload OVA
Today, the process of importing an OVA requires one to copy the OVA file into one of hosts managed by oVirt (and consequently installed with VDSM and virt-v2v) and set the file permissions to vdsm:kvm. It is a cumbersome and error-prone process.  

This feature provides a more user-friendly alternative, that enables one to upload an OVA straight from the browser (much like the image-upload functionality that already exists in oVirt).  

Note 1: The supported OVA files would be those generated by different platforms that virt-v2v supports the conversions of their OVAs, and those generated by oVirt.  

Note 2: Export domain would not be required for the upload functionality.  

TBD: Support for a compressed OVA file.

## Export VM/template as OVA
Today, users are provided with two ways to migrate VMs and templates between environments. First, one can use an export domain. However, this way is suitable only for migration between different oVirt environments. Moreover, there is an on-going planning to drop the somehow limited form of an export domain. Second, one can detach a data domain and attach it to another setup. This way is tailored to disaster recovery and is less suitable for the migration use-case due to the side effects in detaching a data domain.  

This feature provides an alternative way to migrate VMs and templates between environments by generating an OVA from existing VM or template. By encapsulating all VM data (optionally compressed) in a single file, we achieve improved portability. By using the standard OVA specification (rather than our unique structure of a storage domain), we achieve better compatibility with other platforms.  

We will strive to generate an OVA that is as close as possible to the OVA specification at the path . Specifically, the OVA will include neither snapshots nor the template that the VM may be based on.  

## Enhance Import OVA
This feature enhances the current support provided for import OVAs with:  
1. Ability to import OVA that is generated by oVirt.  
2. Ability to specify a data/export domain as a source.  
3. List all OVAs in a directory if the source is a directory.  
4. TBD: Ability to import OVA in which the disks are compressed (zipped).  

This way is more suitable for mass import and for import without a browser.

## Download OVA
Once a support for download-image will be provided, this feature will be enhanced with the ability to download an OVA generated by oVirt to a remote machine.    

# Design
This section details the high-level design of the different aspects described in the previous section.

## Upload OVA
In principle, the mechanism implemented for image-upload can be reused for uploading an OVA. On the one hand, there is a lot of similarity in image-updload and OVA-upload because in both cases the user selects a resource from within the browser and that resource needs to be copied into a storage domain.  

On the other hand, uploading an OVA is different than uploading an image. First, OVA contains several resources as opposed to a single image. Second, unlike an image, OVA contains the full configuration of the resource.  

The upload process will be comprised of the following operations:  
1. The broswer validates the input file. Specifically, that file is a tar file, that it contains an OVF file and that the references within the OVF exist inside the given file.  
2. The OVF inside the OVA is sent to the back-end that parses it and returns a VM representation to the front-end (it would therefore make sense to move/copy the parsing we do in VDSM today to the engine).  
3. The user is provided with a dialog that allows him to configure the import parameters, in a similar way one can configure the parameters for ordinary import operations today. In addition, the dialog enables the user to select to which storage domain to copy the OVA. By default the system automatically chooses a storage domain with enough space.  
4. A temporary disk is created and the OVA is copied to that disk (this part should be similar to image-upload).  
5. An import OVA command is initiated with the temporary disk as a source and the parameters provided by the user as an input (see Enhance Import OVA).  
6. The temporary disk is removed.  

## Export VM/template as OVA
The user will be able to specify that a VM or a template should be exported as an OVA in the export dialog. In that case, the user needs to specify a storage domain that the OVA will be generated on or an absolute path on a host.  

The export process will be comprised of the following operations:  
1. Validation that there is enough space for the full OVA on the target storage domain/path plus for a clone of each of the disks on any storage domain.  
2. A volume for the target OVA will be created in ```<pool_id>/<domain_id>/master/ova``` called <vm_name>.ova (raw, preallocated).
3. Each disk of the VM/template will be cloned (raw, preallocated, collapse snapshots) to some storage domain.
4. An OVF that conforms the OVA specification will be produced in ```/var/run/vdsm```.  
5. The cloned disks and the OVF will be archived according to the OVA specification (TBD: should the disks be compressed?).  
6. The cloned disks and the OVF are removed.  
7. If the user provided a path on the host, the ova is moved to that location.  

## Enhance Import OVA
For better support for importing from a directory that contains multiple OVAs that was mounted into one of the hosts, we will allow users to specify a path to a directory. In this case, VDSM will return the OVF of each of the OVAs and the engine will allow the user to select some of these OVAs.  

Specifically, the user will be able to select a storage domain as a source and then the process described above will be applied to the ```<pool_id>/<domain_id>/master/ova``` directory. This allows users to drop their OVAs in that folder (they still have to ensure VDSM has read permissions) and import them from the GUI/REST-API.  

The import operation would be similar to the current _ImportVmFromOvaCommand_:
1. VM/template will be added to the system.  
2. Disks will be created.  
3. If the OVA was created by an external system, virt-v2v will convert the OVA. Otherwise, the disks will be copied extracted from the tar into their volumes in the storage domain.  
4. If specified by the user, the original OVA will be removed.  

## Download OVA
If download functionality will be provided for images, the generated OVA could be downloaded in a similar way. The generated OVA will then be removed by default at the end of the download operation.  
