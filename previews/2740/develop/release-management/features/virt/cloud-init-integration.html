<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Cloud-Init Integration | oVirt</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Cloud-Init Integration" />
<meta name="author" content="Amedeo Salvati" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/virt/cloud-init-integration.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/virt/cloud-init-integration.html" />
<meta property="og:site_name" content="oVirt" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Cloud-Init Integration" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Amedeo Salvati" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Amedeo Salvati"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","@type":"WebPage","headline":"Cloud-Init Integration","url":"https://ovirt.github.io/ovirt-site/previews/2740/develop/release-management/features/virt/cloud-init-integration.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/2740/images/logo.svg"},"name":"Amedeo Salvati"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/2740/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/2740/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/2740/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <!-- Begin Jekyll Favicon tag v0.2.9 -->
<!-- Classic -->
<link rel="shortcut icon" href="/ovirt-site/previews/2740/favicon.ico">
<link rel="icon" sizes="48x48 32x32 16x16" href="/ovirt-site/previews/2740/favicon.ico">
  <link rel="icon" sizes="16x16" type="image/png" href="/ovirt-site/previews/2740/images/favicon-16x16.png">
  <link rel="icon" sizes="32x32" type="image/png" href="/ovirt-site/previews/2740/images/favicon-32x32.png">
  <link rel="icon" sizes="64x64" type="image/png" href="/ovirt-site/previews/2740/images/favicon-64x64.png">
  <link rel="icon" sizes="144x144" type="image/png" href="/ovirt-site/previews/2740/images/favicon-144x144.png">
<!-- Safari -->
  <link rel="apple-touch-icon" sizes="57x57" href="/ovirt-site/previews/2740/images/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/ovirt-site/previews/2740/images/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/ovirt-site/previews/2740/images/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/ovirt-site/previews/2740/images/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/ovirt-site/previews/2740/images/favicon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ovirt-site/previews/2740/images/favicon-180x180.png">
<!-- Chrome -->
  <link rel="icon" sizes="192x192" href="/ovirt-site/previews/2740/images/favicon-192x192.png">
  <link rel="icon" sizes="96x96" href="/ovirt-site/previews/2740/images/favicon-96x96.png">
  <link rel="icon" sizes="48x48" href="/ovirt-site/previews/2740/images/favicon-48x48.png">
<link rel="manifest" href="/ovirt-site/previews/2740/manifest.webmanifest">
<!-- IE -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ovirt-site/previews/2740/images/favicon-144x144.png">
<meta name='msapplication-config' content="/ovirt-site/previews/2740/browserconfig.xml">
<!-- End Jekyll Favicon tag -->
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/2740/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/2740/images/logo.svg">      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/2740/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/2740//blogs.ovirt.org/'>Blog</a></li>              </ul>          </div>          <!-- /.navbar-collapse -->      </div>      <!-- /.container-fluid -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/2740/develop/release-management/features/virt/">
              <span property="name">Virt</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <header class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/c32417f8d266342ceacd8157038bcb3d?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/c32417f8d266342ceacd8157038bcb3d?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Amedeo Salvati</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ce421080e5d2da87febb626f6e8906c9?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Dan Kenigsberg</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Greg Padgett</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/361364687a20a9ac6bde72c339b1b6f3?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/361364687a20a9ac6bde72c339b1b6f3?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">R P Herrold</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/b1766f2c8efbe055218f5ccdae3bc8da?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/b1766f2c8efbe055218f5ccdae3bc8da?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Omer Frenkel</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d1444ce9dae56ad479be1aa9e2b217bd?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Sven Kieske</span></p>
                      
                    </section>
                  </span>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/469b83a72384b6c5feffe3f7ebc1e853?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/469b83a72384b6c5feffe3f7ebc1e853?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy">
                  </div>
                  <span class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Vinzenz Feenstra</span></p>
                      
                    </section>
                  </span>
                
              </header>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/2740/documentation/'>Documentation is available here.</a></div>

<h1 id="cloud-init-integration">Cloud-Init Integration</h1>

<h2 id="summary">Summary</h2>

<p><a href="https://launchpad.net/cloud-init/">Cloud-init</a> [1] is a tool used to perform initial setup on cloud nodes, including networking, SSH keys, timezone, user data injection, and more. It is a service that runs on the guest, and supports various Linux distributions including Fedora, RHEL, and Ubuntu.</p>

<p>Integrating support for it into oVirt will help facilitate provisioning of virtual machines. It’s already in wide use by cloud software such as OpenStack (via Heat) as well as providers such as Amazon, and its capabilities are a natural fit in our environment.</p>

<h2 id="owner">Owner</h2>

<ul>
  <li>Name: Greg Padgett</li>
  <li>Email: gpadgett@redhatdotcom</li>
</ul>

<h2 id="current-status">Current Status</h2>

<p>Implementation</p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1039009">existing functionality since 3.3.2</a> can’t use cloud-init /run once via api</p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1045484">existing functionality since 3.4.0</a> REST API cloud init: can’t set root password [using json]</p>

<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1330217">open RFE</a> Enable configuring IPv6 in VM cloud-init (planned to be implemented in 4.2.0)</p>

<h2 id="detailed-description">Detailed Description</h2>

<p><strong>Use Case</strong></p>

<p>Use of cloud-init to help provision a guest requires that the guest have cloud-init installed. For cloud instances, this is typically done during image creation; in our use case, it would be installed on a VM or template.</p>

<p>The package currently supports Fedora, RHEL, Debian, and Ubuntu (and compatible derivatives). Initially, we’d like to support Fedora (18), RHEL (6.4), and Ubuntu (12.04 LTS).</p>

<p>After package installation, cloud-init will start during the boot process and looks for various “data sources” that supply it with instructions on what to configure. These sources can be local configuration data stored on the VM itself, an attached block device (config disk) identified by a specific volume labels and directory structure, or a metadata server accessible via the network at a predefined IP address. We’ll be using a config disk, which will allow the engine to create and attach data to the VMs dynamically based on user preferences, as well as allowing a user to attach their own already-prepared config disks.</p>

<p>Note that there are multiple config disk types supported by cloud-init, each with their own varying structures and capabilities. We are most interested in using config-drive version 2 [2], which is also in supported by OpenStack.</p>

<p>Once cloud-init discovers a data source, it scans it for meta-data and user-data. Generally, meta-data contains information about the cloud that is passed to the guest (instance identification, network setup, etc [3]), whereas user-data contains instructions on provisioning the specific system in question (usernames/passwords to configure, timezone, custom scripts to run, packages to install, files to inject, etc [4]). If cloud-init has not previously seen the supplied instance identifier (i.e. this is a new configuration), it will proceed to set up the system accordingly. The end result is a system with all basic provisioning complete before the first login.</p>

<p>In summary, a typical workflow for using cloud-init in oVirt to assist in guest provisioning might involve:</p>

<ul>
  <li>Create new VM</li>
  <li>Install OS</li>
  <li>Install cloud-init</li>
  <li>(Create template if desired)</li>
  <li>Configure cloud-init options through webadmin or rest api, or attach disk/payload with pre-constructed config disk</li>
  <li>Start VM</li>
  <li>Wait (usually just seconds) for cloud-init configuration to complete</li>
  <li>VM is configured and ready for use</li>
</ul>

<p>TODO: still pending is whether and/or how to communicate to oVirt engine that cloud-init has finished guest setup, set vm initialized flag, …</p>

<p><strong>Functionality</strong></p>

<p>There is a long list of configuration options supported by cloud-init. The ones we are currently targeting for inclusion in oVirt include:</p>

<ul>
  <li>set root password</li>
  <li>set timezone</li>
  <li>add ssh authorized keys for root user</li>
  <li>set static IP (address/mask/gateway) for both IPv4 and IPv6 stacks</li>
  <li>set and persist hostname*</li>
  <li>inject user data/files to guest disk</li>
</ul>

<p>Some additional options for later investigation:</p>

<ul>
  <li>create users and/or set user passwords</li>
  <li>auto-generate system ssh key (public &amp; private) - should consider using <a href="http://libvirt.org/formatdomain.html#elementsRng">virtio-rng before doing so</a></li>
  <li>assign system ssh key to user-specified value (public &amp; private)</li>
  <li>“phone home” once system is up</li>
  <li>shut down and/or reboot</li>
  <li>run custom scripts and/or commands</li>
  <li>set system locale</li>
</ul>

<p>In addition, there are some usability goals for the project:</p>

<ul>
  <li>allow guest setup with default cloud-init package installation (no custom configuration steps necessary)*</li>
  <li>don’t create additional user only for cloud-init setup (e.g. ec2-user)</li>
  <li>after reboot, cloud-init shouldn’t cause a delay due to no data source being present*</li>
</ul>

<p>(* Items with asterisk indicate that a workaround or bugfix is needed, these are expected by the time the feature is ready.)</p>

<p><strong>\1</strong></p>

<ul>
  <li>Config disks will be attached to VMs as ISOs using the VM Payload feature, so both a payload and cloud-init configuration cannot be used at the same time. However, cloud-init can be used to inject files into the guest, effectively an alternate way to deliver a payload.</li>
</ul>

<p><strong>UI Mock-Up</strong></p>

<p>Details subject to change:</p>

<p><img src="/ovirt-site/previews/2740/images/wiki/Cloud-init-ui-mock-up.png" alt="" /></p>

<p><strong>Screenshot</strong></p>

<p><img src="/ovirt-site/previews/2740/images/wiki/Cloud-init-webadmin-screenshot.png" alt="" /></p>

<p><strong>API Design</strong></p>

<p>Example of usage:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;vm&gt;</span>
  …
  <span class="nt">&lt;initialization&gt;</span>
      <span class="nt">&lt;host&gt;</span>
        <span class="nt">&lt;address&gt;</span>cloudInitInstanceName<span class="nt">&lt;/address&gt;</span>
      <span class="nt">&lt;/host&gt;</span>
      <span class="nt">&lt;authorized_keys&gt;</span>
        <span class="nt">&lt;authorized_key&gt;</span>
          <span class="nt">&lt;user&gt;</span>
            <span class="nt">&lt;user_name&gt;</span>root<span class="nt">&lt;/user_name&gt;</span>
          <span class="nt">&lt;/user&gt;</span>
          <span class="nt">&lt;key&gt;</span>ssh-rsa AAAAB3Nza[…]75zkdD user@domain.com<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;/authorized_key&gt;</span>
      <span class="nt">&lt;/authorized_keys&gt;</span>
      <span class="nt">&lt;regenerate_ssh_keys&gt;</span>true<span class="nt">&lt;/regenerate_ssh_keys&gt;</span>
      <span class="nt">&lt;timezone&gt;</span>Asia/Jerusalem<span class="nt">&lt;/timezone&gt;</span>
      <span class="nt">&lt;users&gt;</span>
        <span class="nt">&lt;user&gt;</span>
          <span class="nt">&lt;user_name&gt;</span>root<span class="nt">&lt;/user_name&gt;</span>
          <span class="nt">&lt;password&gt;</span>myPass<span class="nt">&lt;/password&gt;</span>
        <span class="nt">&lt;/user&gt;</span>
      <span class="nt">&lt;/users&gt;</span>
      <span class="nt">&lt;dns_search&gt;</span>qa.lab redhat.com<span class="nt">&lt;/dns_search&gt;</span>
      <span class="nt">&lt;dns_servers&gt;</span>8.8.8.8 127.0.0.1<span class="nt">&lt;/dns_servers&gt;</span>
      <span class="nt">&lt;nic_configurations&gt;</span>
        <span class="nt">&lt;nic_configuration&gt;</span>
          <span class="nt">&lt;name&gt;</span>eth0<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;boot_protocol&gt;</span>static<span class="nt">&lt;/boot_protocol&gt;</span>
          <span class="nt">&lt;ip&gt;</span>
            <span class="nt">&lt;address&gt;</span>192.168.2.11<span class="nt">&lt;/address&gt;</span>
            <span class="nt">&lt;netmask&gt;</span>255.255.255.0<span class="nt">&lt;/netmask&gt;</span>
            <span class="nt">&lt;gateway&gt;</span>192.168.2.1<span class="nt">&lt;/gateway&gt;</span>
          <span class="nt">&lt;/ip&gt;</span>
          <span class="nt">&lt;ipv6_boot_protocol&gt;</span>static<span class="nt">&lt;/ipv6_boot_protocol&gt;</span>
          <span class="nt">&lt;ipv6&gt;</span>
            <span class="nt">&lt;address&gt;</span>2001::1234<span class="nt">&lt;/address&gt;</span>
            <span class="nt">&lt;netmask&gt;</span>64<span class="nt">&lt;/netmask&gt;</span>
            <span class="nt">&lt;gateway&gt;</span>2001::fffa<span class="nt">&lt;/gateway&gt;</span>
          <span class="nt">&lt;/ipv6&gt;</span>
          <span class="nt">&lt;on_boot&gt;</span>true<span class="nt">&lt;/on_boot&gt;</span>
        <span class="nt">&lt;/nic_configuration&gt;</span>
        <span class="nt">&lt;nic_configuration&gt;</span>
          <span class="nt">&lt;name&gt;</span>eth1<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;boot_protocol&gt;</span>dhcp<span class="nt">&lt;/boot_protocol&gt;</span>
          <span class="nt">&lt;ipv6_boot_protocol&gt;</span>none<span class="nt">&lt;/ipv6_boot_protocol&gt;</span>
        <span class="nt">&lt;/nic_configuration&gt;</span>
        <span class="nt">&lt;nic_configuration&gt;</span>
          <span class="nt">&lt;name&gt;</span>eth2<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;boot_protocol&gt;</span>none<span class="nt">&lt;/boot_protocol&gt;</span>
          <span class="nt">&lt;ipv6_boot_protocol&gt;</span>autoconf<span class="nt">&lt;/ipv6_boot_protocol&gt;</span>
          <span class="nt">&lt;on_boot&gt;</span>true<span class="nt">&lt;/on_boot&gt;</span>
        <span class="nt">&lt;/nic_configuration&gt;</span>
      <span class="nt">&lt;/nic_configurations&gt;</span>
      <span class="nt">&lt;files&gt;</span>
        <span class="nt">&lt;file&gt;</span>
          <span class="nt">&lt;name&gt;</span>/tmp/testFile1.txt<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;content&gt;</span>temp content<span class="nt">&lt;/content&gt;</span>
          <span class="nt">&lt;type&gt;</span>PLAINTEXT<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/file&gt;</span>
      <span class="nt">&lt;/files&gt;</span>
  <span class="nt">&lt;/initialization&gt;</span>
<span class="nt">&lt;/vm&gt;</span>
</code></pre></div></div>

<p><strong>Python SDK</strong></p>

<p>Example of usage, setting hostname, root password and writing simple text file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vmstat</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">get_status</span><span class="p">().</span><span class="n">state</span>
<span class="k">if</span> <span class="n">vmstat</span> <span class="o">==</span> <span class="s">'down'</span><span class="p">:</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">osVersion</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">get_os</span><span class="p">().</span><span class="n">get_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">osVersion</span> <span class="o">==</span> <span class="s">"rhel_6x64"</span> <span class="ow">or</span> <span class="n">osVersion</span> <span class="o">==</span> <span class="s">"rhel_6"</span> <span class="ow">or</span> <span class="n">osVersion</span> <span class="o">==</span> <span class="s">"rhel_7x64"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">CLOUDINIT</span> <span class="o">==</span> <span class="s">"yes"</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"Starting VM: "</span> <span class="o">+</span> <span class="n">vm</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">" with cloud-init options"</span>
            <span class="n">scontent</span> <span class="o">=</span> <span class="s">"write_files:</span><span class="se">\n</span><span class="s">-   content: |</span><span class="se">\n</span><span class="s">        search example.com</span><span class="se">\n</span><span class="s">        nameserver 10.10.10.1</span><span class="se">\n</span><span class="s">        nameserver 10.10.10.2</span><span class="se">\n</span><span class="s">    path: /etc/resolv.conf"</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">Action</span><span class="p">(</span>
                <span class="n">vm</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">VM</span><span class="p">(</span>
                    <span class="n">initialization</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Initialization</span><span class="p">(</span>
                        <span class="n">cloud_init</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">CloudInit</span><span class="p">(</span>
                            <span class="n">host</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Host</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">"rheltest001.example.com"</span><span class="p">),</span>
                            <span class="n">users</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Users</span><span class="p">(</span>
                                <span class="n">user</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">User</span><span class="p">(</span><span class="n">user_name</span><span class="o">=</span><span class="s">"root"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"secret"</span><span class="p">)]</span>
                                <span class="p">),</span>
                            <span class="n">files</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Files</span><span class="p">(</span>
                                <span class="nb">file</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"/etc/resolv.conf"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">scontent</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s">"PLAINTEXT"</span><span class="p">)]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">vm</span><span class="p">.</span><span class="n">start</span><span class="p">(</span> <span class="n">action</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"Starting VM "</span> <span class="o">+</span> <span class="n">vm</span><span class="p">.</span><span class="n">name</span>
            <span class="n">vm</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">vmstat</span> <span class="o">!=</span> <span class="s">'down'</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vmstat</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">get_status</span><span class="p">().</span><span class="n">state</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Error on starting VM"</span>
        <span class="k">print</span> <span class="n">err</span>
</code></pre></div></div>

<p>Same as above, but setting also networking:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">action</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">Action</span><span class="p">(</span>
           <span class="n">vm</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">VM</span><span class="p">(</span>
               <span class="n">initialization</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Initialization</span><span class="p">(</span>
                   <span class="n">cloud_init</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">CloudInit</span><span class="p">(</span>
                       <span class="n">host</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Host</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">"testvm.example.com"</span><span class="p">),</span>
                       <span class="n">authorized_keys</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">AuthorizedKeys</span><span class="p">(</span>
                           <span class="n">authorized_key</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">AuthorizedKey</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">User</span><span class="p">(</span><span class="n">user_name</span><span class="o">=</span><span class="s">"root"</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s">"ssh-rsa AAAAB3NzaC1yc........."</span><span class="p">)]</span>
                           <span class="p">),</span>
                       <span class="n">regenerate_ssh_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                       <span class="n">users</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Users</span><span class="p">(</span>
                           <span class="n">user</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">User</span><span class="p">(</span><span class="n">user_name</span><span class="o">=</span><span class="s">"root"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"SecretPassword"</span><span class="p">)]</span>
                           <span class="p">),</span>
                       <span class="n">network_configuration</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">NetworkConfiguration</span><span class="p">(</span>
                           <span class="n">nics</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Nics</span><span class="p">(</span><span class="n">nic</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">NIC</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"eth0"</span><span class="p">,</span>
                                               <span class="n">boot_protocol</span><span class="o">=</span><span class="s">"STATIC"</span><span class="p">,</span>
                                               <span class="n">on_boot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                               <span class="n">network</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Network</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">IP</span><span class="p">(</span>
                                                                       <span class="n">address</span><span class="o">=</span><span class="s">"192.168.100.10"</span><span class="p">,</span>
                                                                       <span class="n">netmask</span><span class="o">=</span><span class="s">"255.255.255.0"</span><span class="p">,</span>
                                                                       <span class="n">gateway</span><span class="o">=</span><span class="s">"192.168.100.1"</span><span class="p">)))])</span>
                           <span class="p">),</span>
                       <span class="n">files</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">Files</span><span class="p">(</span>
                           <span class="nb">file</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"/etc/motd"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">"Automatic configuration"</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s">"PLAINTEXT"</span><span class="p">)]</span>
                           <span class="p">)</span>
                       <span class="p">)</span>
                   <span class="p">)</span>
               <span class="p">)</span>
           <span class="p">)</span>
</code></pre></div></div>

<h2 id="required-changes">Required Changes</h2>

<p>Further details TBD</p>

<ul>
  <li>UI
    <ul>
      <li>Modifications to store config options from user (location TBD)</li>
      <li>Method to disallow having both payload and cloud-init configuration</li>
    </ul>
  </li>
  <li>REST API
    <ul>
      <li>Allow specification of cloud-init configuration options</li>
      <li>Payload type configuration (i.e. like sysprep type, also with option to support different config disk types either now or in the future)</li>
    </ul>
  </li>
  <li>Engine/Backend/Db
    <ul>
      <li>Create config disk from passed-in configuration options</li>
    </ul>
  </li>
  <li>VDSM
    <ul>
      <li>Support custom volume label for vm payloads</li>
    </ul>
  </li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Integrating with cloud-init will make provisioning Linux VMs easier for admins, decreasing the amount of setup time needed and streamlining support for attaching existing config disks to feed data to cloud-init.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<p>Related features:</p>

<ul>
  <li><a href="/ovirt-site/previews/2740/develop/release-management/features/virt/vmpayload.html">Features/VMPayload</a></li>
  <li><a href="/ovirt-site/previews/2740/develop/release-management/features/virt/intial-run-vm-tab.html">Features/Intial Run Vm tab</a></li>
</ul>

<h2 id="documentation--external-references">Documentation / External References</h2>

<references>
1.  [5]
2.  [6]
3.  [7]
4.  [8]

</references>
<h2 id="testing">Testing</h2>

<ul>
  <li>Test case: <strong>Initialize vm parameters</strong>
    <ul>
      <li>setup:</li>
    </ul>
  </li>
</ul>

<p>Create VM in 3.3 cluster</p>

<p>Make sure the vm OS is set correctly (“Other Linux” should be a good choice to fit any linux)
:Install latest Fedora/RHEL/Ubuntu and install cloud-init package (“yum/apt-get install cloud-init”)
:When done shut down the vm.</p>

<ul>
  <li>
    <ul>
      <li>test:</li>
    </ul>
  </li>
</ul>

<p>Click ‘run-once’ in the webadmin, under ‘Inital Run’ click ‘Use Cloud-Init’</p>

<p>Fill in some initialization fields as described in the screenshot above</p>

<p>Click ‘OK’</p>

<p>Connect to the VM and observe the changes filled before were applied.</p>

<ul>
  <li>Test case: <strong>Initialize vm parameters and attach a CD</strong>
    <ul>
      <li>setup:</li>
    </ul>
  </li>
</ul>

<p>Same as first test</p>

<ul>
  <li>
    <ul>
      <li>test:</li>
    </ul>
  </li>
</ul>

<p>Click ‘run-once’ in the webadmin, under Boot select ‘attach CD’ and select any cd to attach to the vm</p>

<p>Under ‘Initial Run’ click ‘Use Cloud-Init’</p>

<p>Fill in some initialization fields as described in the screenshot above</p>

<p>Click ‘OK’</p>

<p>Connect to the VM and observe the CD indeed attached and other changes filled before were applied.</p>

<p>[1]</p>

<p>[2]</p>

<p>[3]</p>

<p>[4]</p>

<p>[5] Cloud-init documentation: <a href="https://launchpad.net/cloud-init/">https://launchpad.net/cloud-init/</a></p>

<p>[6]</p>

<p>[7]</p>

<p>[8] User-data example: <a href="https://github.com/canonical/cloud-init/blob/master/doc/examples/cloud-config.txt">https://github.com/canonical/cloud-init/blob/master/doc/examples/cloud-config.txt</a></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/2740/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/2740/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/2740/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/2740/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/virt/cloud-init-integration.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/cloud-init-integration.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
