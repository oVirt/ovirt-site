<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Live Merge | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Live Merge" />
<meta name="author" content="Adam Litke" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/storage/live-merge.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/storage/live-merge.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Live Merge" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Adam Litke" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Adam Litke"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Live Merge","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3012/images/logo.svg"},"name":"Adam Litke"},"url":"https://ovirt.github.io/ovirt-site/previews/3012/develop/release-management/features/storage/live-merge.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3012/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3012/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3012/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3012/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3012/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3012/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3012/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3012/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3012/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3012/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3012/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3012//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3012/develop/release-management/features/storage/">
              <span property="name">Storage</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/9e57b717174453404c080ead99e2186c?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/9e57b717174453404c080ead99e2186c?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Adam Litke">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Adam Litke</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/bd7754652a65e36e7c7f7672f59bf1fe?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Greg Padgett">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Greg Padgett</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3012/documentation/'>Documentation is available here.</a></div>

<h1 id="live-merge">Live Merge</h1>

<h2 id="summary">Summary</h2>

<p>Live merge makes it possible to delete virtual machine disk snapshots that are no longer needed while the virtual machine continues to run.</p>

<h2 id="owners">Owners</h2>

<ul>
  <li>Name: Adam Litke (<a href="mailto:alitke@redhat.com">alitke@redhat.com</a>)</li>
  <li>Name: Greg Padgett (<a href="mailto:gpadgett@redhat.com">gpadgett@redhat.com</a>)</li>
</ul>

<h2 id="current-status">Current status</h2>

<p>Released in oVirt 3.5.1</p>

<h2 id="detailed-description">Detailed Description</h2>

<p>The user presentation of the live merge feature is simple - the only noticeable change is that the ‘Remove’ snapshot command is no longer disabled when a virtual machine is running. Behind the scenes, however, the flow is quite complex. Live merge is an asynchronous operation, and maintaining the consistency of management meta data and actual virtual machine storage requires delicate handling of many different error scenarios. The following is a detailed description of the flow and processes that need to be in place on both the engine and on VDSM. See the flow diagram below for a graphical overview of the processes.</p>

<p>A live merge is initiated when a user clicks the ‘Remove’ command associated with a disk snapshot. If the virtual machine is down, the existing cold merge flow is followed. If the virtual machine is up, a live merge is attempted. The engine calls the VDSM merge() verb on the host on which the virtual machine is running. First, VDSM associates a new <code class="language-plaintext highlighter-rouge">blockJob</code> record with the virtual machine. This record is initially populated with placeholder values so that it can serve as a record that a job is just beginning. Next, VDSM calls the libvirt <code class="language-plaintext highlighter-rouge">virDomainBlockCommit</code> API to start the merge. This libvirt call is asynchronous and its completion is signaled by an event (ignored by VDSM) and the job being no longer reported by the <code class="language-plaintext highlighter-rouge">virDomainBlockJobInfo</code> API. Finally, VDSM returns success to engine. Some considerations regarding race conditions with reporting block job information via the virtual machine Stats mechanism will appear later in this page.</p>

<p>The next phase of live merge is a polling phase conducted by the engine. As long as the VDSM <code class="language-plaintext highlighter-rouge">getAllVmStats</code> API reports a job with a matching jobID, the job is assumed to be ongoing and engine just waits. VDSM is careful to save a record of the block job in the virtual machine recovery file so that polling will maintain consistency over VDSM restarts. Because the block job is part of the qemu process, any action that causes a virtual machine to go down will abort all block jobs for that virtual machine. Once the job is no longer reported, the engine enters the final phase of the job, which resolves what happened and cleans up.</p>

<p>On the VDSM side, the live merge operation is performed by the running qemu process and is monitored by libvirt for completion. If it completes, qemu rewrites the qcow headers in the volume chain to reflect the new situation. For example, if the original chain was A&lt;–B&lt;–C where A was the base image and C was the active layer and B was merged into A, then qemu would update the qcow header of C to change the base image from B to A. Until this header change is atomically applied, the merge is considered to have not happened at all (even though some data may have been copied from B into A). VDSM determines what synchronization is required based on how the volume chain reported by libvirt in the domain’s live XML has changed. For example, if a volume has been removed from the chain, it should be removed from the VDSM representations of that chain. It should be noted that as soon as a merge begins (and until the merge is successful), the snapshot being merged into cannot be previewed or reverted to. The engine must take care to track this limitation to prevent data corruption. When a block job ends successfully, VDSM must synchronize its internal state with qemu and the new image chain. On the virt side, we must update the virtual machine conf to reflect the new volume chain. We do this by checking the volume chain as reported by libvirt in the live domain XML. On the storage side, we must update the volume chain metadata that is maintained on the storage itself.</p>

<p>The command must be resolved after the job is reported to have ended. Engine resolves the command by retrieving the <code class="language-plaintext highlighter-rouge">VmDefinition</code> from VDSM and examining the volume chain. Engine will perform a membership test for the snapshot volume UUID against the VDSM returned list to see if the snapshot has been removed from the volume chain. If not, then the merge is marked failed and the disk snapshot will be unlocked by engine. If the snapshot has been removed from the chain then the engine submits one final delete command to VDSM to remove the no longer needed volume from storage before returning successfully.</p>

<h3 id="special-case-merge-the-active-layer-into-its-parent">Special case: Merge the active layer into its parent</h3>

<p>The logic for active layer commit is a bit more complex than the basic case of merging an internal snapshot. For active commit, libvirt manages a two phase process. In the first phase, qemu copies data from the active layer into its parent. It also mirrors disk writes to both the active layer and its parent. The completion of this phase can be observed when the libvirt block job ‘cur’ cursor value equals the ‘end’ cursor value and the block job type is active commit. The second phase is triggered automatically by VDSM which issues a special <code class="language-plaintext highlighter-rouge">virDomainBlockJobAbort</code> call. Phase 2 ends as normal when the block job is no longer reported.</p>

<h3 id="special-case-extend-internal-sparse-block-volumes-during-live-merge">Special case: Extend internal sparse block volumes during live merge</h3>

<p>If the virtual machine disk resides on block storage and the volume where data is being merged is sparse, then it may be necessary to extend this volume periodically during live merge. This operation is an extension of the normal SPM Mailbox driven flow which up to now has only extended the active layer. Candidate volumes are found by using VDSM’s cached block job information. If the remaining space is too small, then a resize request is sent to the SPM. Note that the formal libvirt API for this has not yet been defined but it should be soon.</p>

<h3 id="detecting-if-live-merge-can-be-supported">Detecting if Live Merge can be supported</h3>

<h3 id="flow-diagram">Flow Diagram</h3>

<p>This diagram is a bit out-dated. Please bear with the developers until they can update it. <img src="/ovirt-site/previews/3012/images/wiki/Live-merge-flow.png" alt="" /></p>

<h3 id="special-considerations-for-ovirt-engine">Special considerations for ovirt-engine</h3>

<ul>
  <li>When a Live Merge is performed, engine’s <code class="language-plaintext highlighter-rouge">RemoveSnapshotCommand</code> branches and calls <code class="language-plaintext highlighter-rouge">RemoveSnapshotSingleDiskLiveCommand</code>. This new command uses a new command-execution infrastructure which allows for the coordination of HSM Async Tasks by polling for the expected end state after a job is completed, rather than relying on the SPM to maintain a list of jobs. See <a href="/ovirt-site/previews/3012/develop/release-management/features/infra/commandcoordinator.html"><code class="language-plaintext highlighter-rouge">CommandCoordinator</code>’s feature page</a> for further details.</li>
  <li>Care is taken to prevent race conditions when tracking Live Merge jobs executed by VDSM. For SPM jobs, a job placeholder is inserted into the database before the job is started on VDSM. This is reversed in the case of Live Merge, where the block job placeholder is stored in the database only after the call to VDSM to start the job has returned. Accordingly, a virtual machine job may accidentally be discovered by the polling thread, but the polling thread will not accidentally remove a job that has not yet started. Only after a job is in the database is the polling thread is allowed to update or remove it. This simplifies the control flow and ensures that the thread starting the job has an opportunity to finish any tasks before handing off control to the monitoring thread.</li>
  <li>Upon command completion, engine updates the database records to reflect the current state of the images. If the merge and deletion steps were successful, the deleted image is removed from the database along with the deleted snapshot. If the merge succeeded but deletion failed, the virtual machine’s volume chain is corrected in the database, and the now-orphaned image is marked illegal and associated with the defunct snapshot. If merging failed, the volume chain remains intact but the images involved are marked illegal. The state of the database records after these failure scenarios make it possible for the command to be retried, where upon success the database will be cleaned up as if no failure had occurred..</li>
</ul>

<h3 id="special-considerations-for-vdsm">Special considerations for VDSM</h3>

<ul>
  <li>The list of active block jobs is gathered and cached by VDSM using the <code class="language-plaintext highlighter-rouge">VmStatsThread</code>. This improves efficiency by reducing the number of libvirt calls needed and by reusing an existing engine-host polling mechanism. Unfortunately it creates some potential race conditions between engine and the host. We must guarantee that the stats contain the new job as soon as we return success to engine regarding creation of the live merge job. Otherwise engine could mistakenly think the job has ended. Engine also needs to disregard any stats that it has cached prior to executing the live merge command because those stats will not contain the block job information either. We are thinking of using the virtual machine generation ID to serialize this.</li>
  <li>Once a block job has completed, we need to correct the VDSM volume chain metadata on storage. Unfortunately the rules for updating the volume chain differ depending if the storage is on a <code class="language-plaintext highlighter-rouge">BlockSD</code> or a <code class="language-plaintext highlighter-rouge">FileSD</code>. For <code class="language-plaintext highlighter-rouge">FileSD</code>, we must update the chain from the HSM host that is running the virtual machine. For <code class="language-plaintext highlighter-rouge">BlockSD</code>, the SPM must perform the update since the chain is stored in the LVM metadata. So, when handling block job completions, we will always mark the volume illegal and we will also correct the storage metadata if allowed. The <code class="language-plaintext highlighter-rouge">deletelVolumes</code> verb is an SPM operation and it will delete the volume and also correct the volume chain metadata if dealing with block storage.</li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>This feature hides the complexity of the Live Merge flow behind a simple “Delete” button in the user interface. This results in symmetric create/delete snapshot operations regardless of whether the virtual machine is running or not. This feature has been actively requested by users.</p>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>

<h3 id="libvirt">Libvirt</h3>

<ul>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1062142">live snapshot merge (commit) of the active layer</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1041569">Returning the watermark for all the images opened for writing</a></li>
  <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1102881">virDomainBlockCommit fails with live snapshots on oVirt block storage</a></li>
</ul>

<h3 id="engine">Engine</h3>

<ul>
  <li><a href="/ovirt-site/previews/3012/develop/release-management/features/infra/commandcoordinator.html">CommandCoordinator</a></li>
</ul>

<h2 id="documentation--external-references">Documentation / External references</h2>

<ul>
  <li><a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainBlockCommit">libvirt blockCommit API</a></li>
</ul>

<h2 id="testing">Testing</h2>

<h3 id="important-special-environment-setup">IMPORTANT: Special environment setup</h3>

<p>Some of the libvirt and qemu features required to enable live merge in oVirt are not yet present in official releases. Vdsm will refuse to perform a merge unless a fully featured kvm stack is installed. To try this on your system, please update your Fedora 20 system according to the following instructions:</p>

<ul>
  <li>Enable the virt-preview repository on Fedora (instructions <a href="http://fedoraproject.org/wiki/Virtualization_Preview_Repository">here</a>.</li>
  <li>Update libvirt and qemu packages from the virt-preview repo.</li>
  <li>Restart libvirtd</li>
  <li>Restart vdsmd</li>
</ul>

<h3 id="caveats-for-block-storage">Caveats for block storage</h3>

<p>We have an <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1041569">open blocker bug</a> for returning internal volume high write watermark information from libvirt. Until this is fixed, vdsm will refuse to initiate live merges for disks on block storage. For now, please test with file-based storage.</p>

<p>Due to <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1102881">this bug</a>, libvirt will fail to perform live merges due to a problem with the SELinux policy. To work around the problem, set your host to permissive mode (<code class="language-plaintext highlighter-rouge">setenforce 0</code>).</p>

<h3 id="positive-flow-create-and-remove-a-snapshot-while-a-vm-runs">Positive flow (Create and remove a snapshot while a VM runs)</h3>

<ul>
  <li>In webadmin, start a VM and create a new snapshot</li>
  <li>Navigate to the VM’s disks and for each disk, select the snapshot that was created and click the Remove button</li>
  <li>After a few seconds, the snapshots should be removed from the list</li>
</ul>

<h3 id="negative-flow-engine-restart-during-live-merge">Negative flow (engine restart during live merge)</h3>

<ul>
  <li>Start in webadmin with a running VM that has one or more snapshots</li>
  <li>Remove a snapshot as in the positive flow but immediately terminate ovirt-engine</li>
  <li>Wait for the operation to complete by using <code class="language-plaintext highlighter-rouge">vdsClient getAllVmStats | grep vmJobs</code> on the virt host and watching for the entry to disappear</li>
  <li>Restart engine</li>
  <li>The command coordinator should resume the engine-side flows which should complete successfully</li>
  <li>In webadmin, confirm that the snapshot is removed after a few seconds.</li>
  <li>Check that the volume associated with the snapshot has been removed from storage</li>
</ul>

<h3 id="negative-flow-vdsm-restart-during-live-merge">Negative flow (vdsm restart during live merge)</h3>

<ul>
  <li>Start in webadmin by selecting a running VM and creating a new snapshot and wait for it to finish.</li>
  <li>From within the VM, write about 100M of data to the disk (this ensures that a live merge will not complete too quickly for this test).</li>
  <li>Remove the snapshot you just creates (as in the positive flow) then immediately terminate vdsm</li>
  <li>Wait for the host to go unresponsive in the webadmin</li>
  <li>Restart vdsm and wait for the host to return to Up status. Engine will resume monitoring the merge progress.</li>
  <li>In webadmin, confirm that the snapshot is removed after some time passes.</li>
  <li>Check that the volume associated with the snapshot has been removed from storage</li>
</ul>

<h3 id="negative-flow-vm-crashes-during-live-merge">Negative flow (VM crashes during live merge)</h3>

<ul>
  <li>Start in webadmin with a running VM that has one or more snapshots</li>
  <li>Remove a snapshot as in the positive flow but immediately terminate the VM</li>
  <li>A live merge failure event should appear in the audit log and the snapshot should remain in the list</li>
</ul>




        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3012/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3012/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3012/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3012/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/storage/live-merge.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/storage/live-merge.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
