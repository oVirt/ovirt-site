<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Engine High Availability | oVirt</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Engine High Availability" />
<meta name="author" content="Eli Mesika" />
<meta property="og:locale" content="en" />
<meta name="description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<meta property="og:description" content="oVirt is a free open-source virtualization solution for your entire enterprise" />
<link rel="canonical" href="https://ovirt.github.io/ovirt-site/previews/3010/develop/release-management/features/sla/engine-high-availability.html" />
<meta property="og:url" content="https://ovirt.github.io/ovirt-site/previews/3010/develop/release-management/features/sla/engine-high-availability.html" />
<meta property="og:site_name" content="oVirt" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Engine High Availability" />
<meta name="twitter:site" content="@ovirt" />
<meta name="twitter:creator" content="@Eli Mesika" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Eli Mesika"},"description":"oVirt is a free open-source virtualization solution for your entire enterprise","headline":"Engine High Availability","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ovirt.github.io/ovirt-site/previews/3010/images/logo.svg"},"name":"Eli Mesika"},"url":"https://ovirt.github.io/ovirt-site/previews/3010/develop/release-management/features/sla/engine-high-availability.html"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <link rel="stylesheet" href="/ovirt-site/previews/3010/stylesheets/fonts.css" />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
  <link rel="stylesheet" href="/ovirt-site/previews/3010/stylesheets/application.css" />
  <link rel="stylesheet" href="/ovirt-site/previews/3010/stylesheets/print.css" media="print" />
  <link rel="stylesheet" href="/ovirt-site/previews/3010/stylesheets/coderay.css" media="screen" />
  <link rel="stylesheet" href="/ovirt-site/previews/3010/stylesheets/asciidoc.css" />
  <script src="/ovirt-site/previews/3010/javascripts/vendor/jquery.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3010/javascripts/vendor/bootstrap.min.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3010/javascripts/vendor/bootstrap-sortable.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3010/javascripts/vendor/moment.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3010/javascripts/vendor/fullcalendar/fullcalendar.js" type="text/javascript"></script>
  <script src="/ovirt-site/previews/3010/javascripts/lib/cal-widget.js" type="text/javascript"></script>
  <link href='/ovirt-site/previews/3010/favicon.ico' rel='shortcut icon' sizes='36x36 24x24 16x16' type='image/x-icon'/>
<link href='/ovirt-site/previews/3010/favicon.png' rel='icon' sizes='196x196' type='image/png'/>
<meta content='/ovirt-site/previews/3010/mstile-icon-128x128.png' name='msapplication-TileImage'/>
<meta content='transparent' name='msapplication-TileColor'/>
<link href='/ovirt-site/previews/3010/manifest.webmanifest' rel='manifest'/>
<meta content='/ovirt-site/previews/3010/browserconfig.xml' name='msapplication-config'/>
</head>
<body class=""><header class='masthead hidden-print' id='branding' role='banner'><section class='hgroup'></section><div id='access'><nav id="mainNav" class="navbar navbar-fixed-top affix-top">  <div class="container">    <div class="col-sm-2 navbar-header">      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu_id0980fddf">        <span class="sr-only">Toggle navigation</span>        <span>Menu</span>        <span class="fa fa-bars"></span>      </button>      <a class="navbar-brand" href="/ovirt-site/previews/3010/">        <img id="logo" alt="oVirt" src="/ovirt-site/previews/3010/images/logo.svg" />      </a>    </div>    <!-- Collect the nav links, forms, and other content for toggling -->    <div class="col-sm-10">      <div class="navbar-collapse collapse" id="menu_id0980fddf">        <ul class="nav navbar-nav" role="menubar">          <li class="hidden active">            <a href="#page-wrap"></a>          </li><li role='menuitem'>  <a href='/ovirt-site/previews/3010/download/'>Download</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3010/documentation/'>Documentation</a></li><li class='active' role='menuitem'>  <a href='/ovirt-site/previews/3010/develop/'>Developers</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3010/community/'>Community</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3010//lists.ovirt.org/archives/'>Forum</a></li><li role='menuitem'>  <a href='/ovirt-site/previews/3010//blogs.ovirt.org/'>Blog</a></li>        </ul>      </div>      <!-- /.navbar-collapse -->    </div>  </div></nav></div></header><main id="page-wrap" class="page-wrap" aria-label="Content">
      <section id="page" class="page">
        <!-- adapted from https://github.com/git-no/jekyll-breadcrumbs -->
<nav class="breadcrumbs bootstrap hidden-sm-down" aria-label="breadcrumb">

   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3010/">
              <span property="name"></span>
              <meta property="position" content="1" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3010/develop/">
              <span property="name">Developers Community</span>
              <meta property="position" content="2" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3010/develop/release-management/">
              <span property="name">Release Management</span>
              <meta property="position" content="3" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3010/develop/release-management/features/">
              <span property="name">Features (Design documents)</span>
              <meta property="position" content="4" />
           </a>
        </li>
      
        
        
        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
           <a property="item" typeof="WebPage" href="/ovirt-site/previews/3010/develop/release-management/features/sla/">
              <span property="name">Sla</span>
              <meta property="position" content="5" />
           </a>
        </li>
      
        
        
          

   </ol>

</nav>

        
          
            <header class="post-header col-md-4 pad-sides well well-lg">
              <h2 class="post-title entry-title">Authors:</h2>
              <div class="post-meta">
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/d75560fd509444e4cbc70734dffa0673?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Eli Mesika">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Eli Mesika</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/ab8ba4bb9559f7d147530801dea4b56f?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/ab8ba4bb9559f7d147530801dea4b56f?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Liran Zelkha">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Liran Zelkha</span></p>
                      
                    </section>
                  </div>
                
                  
                  
                  
                  <div class="blogger_avatar">
                    <img
                      src="https://secure.gravatar.com/avatar/253274daf18cb9847528582645aa6523?s=32&amp;d=mm&amp;r=g"
                      srcset="https://secure.gravatar.com/avatar/253274daf18cb9847528582645aa6523?s=64&amp;d=mm&amp;r=g 2x"
                      class="avatar avatar-32 photo"
                      height="32"
                      width="32"
                      loading="lazy"
                      alt="avatar of Pan Liyang">
                  </div>
                  <div class="byline">
                    <section class="entry-meta">
                      
                        <p><span class="author vcard">Pan Liyang</span></p>
                      
                    </section>
                  </div>
                
                </div>
            </header>
          
        
        <section id="content" class="content container">
          <div class='alert alert-warning'>Feature pages are design documents that developers have created while collaborating on oVirt.<br><br>Most of them are&nbsp;<strong>outdated</strong>, but provide historical design context.<br><br>They are&nbsp;<strong>not</strong>&nbsp;user documentation and should not be treated as such.<br><br><a href='/ovirt-site/previews/3010/documentation/'>Documentation is available here.</a></div>

<h1 id="engine-high-availability">Engine High Availability</h1>

<p>This page was created as a result of a <a href="https://lists.ovirt.org/pipermail/engine-devel/2013-August/005436.html">discussion</a> that started at @engine_devel.
As we are considering an active/active architecture for Engine, we’ll use this page to document required features and code changes that will be required.</p>

<h2 id="architecture">Architecture</h2>

<p><img src="/ovirt-site/previews/3010/images/wiki/Engine_ha_architecture.png" alt="" /></p>

<h2 id="issues-with-current-implementation">Issues with current implementation</h2>

<ol>
  <li>Locking. Currently Engine makes extensive use of Java synchronized capabilities to lock multiple requests hitting the same VDSM at the same time. This should be extended to be cross-machine.
    <ul>
      <li>However, if we replace HTTP transport protocol (and use push notifications), and since VDSM can support multiple concurrent requests, is the entire locking mechanism still necessary?</li>
      <li>Currently there is InMemoryLockManager used by bll commands and monitoring lock in VdsManager. We could find a way to implement InMemoryLockManager to cluster wide using infinispan.</li>
    </ul>
  </li>
  <li>Singletons. We need to find a mechanism to migrate our singletons to be cross-cluster.
    <ul>
      <li>This is a major issue, since if the Engine running the Singleton crashes, we need to migrate the Singleton. The best solution is to probably dump the Singleton approach. We can ride on the CDI <a href="http://gerrit.ovirt.org/#/c/5575">change</a> and the code-refactor it requires.</li>
      <li>Migrating the singletons approach can achieve high availability, but only one active instance running in cluster cannot achieve high scalability which should be a benefit for clustering. To solve this problem, we could:
        <ul>
          <li>Have one instance of the ‘singleton’ running on each node, but make the global variables (should always be maps) in the singleton clustered.</li>
          <li>When the singleton’s methods are invoked, we can:
            <ul>
              <li>use infinispan’s cache listener callback.</li>
              <li>Or we could use infinispan’s distributed execution framework to do the job instead.</li>
            </ul>
          </li>
          <li>As each singleton is very different, refactoring the code for each specific singleton is probably needed. I’d like to explain details in the Ideas section below.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>EJB. Again as part of CDI change we should drop EJB.</li>
  <li>State clustering. We can use Infinispan, already integrated in Engine, for state replication.
    <ul>
      <li>We will need to consider which state needs to be replicated.</li>
    </ul>
  </li>
  <li>Quartz. DB configuration for Quartz should enable High Availability.</li>
  <li>Database. DB clustering should be out of scope of this task.
    <ul>
      <li>[Eli] We may consider that as well, please see <a href="http://web.archive.org/web/20160301093828/http://www.openscg.com/postgresql-ha-automatic-failover">PostgresSQL HA</a></li>
    </ul>
  </li>
  <li>Configuration. All configuration files should be placed in shared storage/database</li>
  <li>VDSM “Sharding”. Should all engines be able to handle all VDSMs, or should we divide VDSMs between running engines (and rebalance once an engine goes down)?</li>
</ol>

<p><sub>For now I think this is a complex task that we can push for a later stage</sub></p>

<h2 id="ideas">Ideas</h2>

<ol>
  <li>Clustered singleton approach using infinispan. For example, ResourceManager:
    <ul>
      <li>make global map variable ‘_vdsAndVmsList’ and ‘_asyncRunningVms’ an infinispan cache, both the key and the value are serializable, should be no problem.</li>
      <li>making global map variable ‘_vdsManagersDict’ clustered is not a good idea, because the VdsManager instances should not be passed through network(because it contains connection to vdsm, quartz scheduler…). We could make a owner=1 dist mode cache (which is key-value serializable) to decide which VdsManager instance to run on which engine. So if engine manage multiple hosts, multiple VdsManager instances are distributed to the engine cluster. Here is a overview of the logic:</li>
    </ul>
  </li>
</ol>

<p><img src="/ovirt-site/previews/3010/images/wiki/Clustered_singleton_approach_for_ResourceManager.png" alt="" /></p>



        </section>
      </section>
    </main>

    <script src="/ovirt-site/previews/3010/javascripts/lib/headings_anchors.js" type="text/javascript"></script><footer class='text-center' id='footer'><hr class='visible-print'><ul class='footer-nav-list'><li><a href='/ovirt-site/previews/3010/privacy-policy.html' target='_blank' title='Privacy policy'>Privacy policy</a></li><li><a href='/ovirt-site/previews/3010/community/about.html' target='_blank' title='About'>About</a></li><li><a href='/ovirt-site/previews/3010/general-disclaimer.html' target='_blank' title='Disclaimers'>Disclaimers</a></li></ul>&copy; 2013&ndash;2022 oVirt<div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/develop/release-management/features/sla/engine-high-availability.html&amp;template=' target='_blank' title='Report an issue'><i class="icon fab fa-github"></i>Report an issue with this page</a></div><div class='edit-this-page'><a href='https://github.com/oVirt/ovirt-site/edit/main/source/develop/release-management/features/sla/engine-high-availability.md' target='_blank' title='Edit this page'><i class="icon fab fa-github"></i>Edit this page</a></div></footer></body>

</html>
